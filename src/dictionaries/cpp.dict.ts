/**
 * PAKK Trained ZSTD Dictionary for C++
 *
 * This is a REAL trained ZSTD dictionary (not just text patterns).
 * Trained using: zstd --train on sample C++ files.
 *
 * Size: 262144 bytes
 * Generated: 2026-01-31T18:32:43.810Z
 */

import type { DictionaryMeta } from '../core/types.js';

// Base64-encoded trained ZSTD dictionary
const DICTIONARY_BASE64 = 'N6Qw7B5GtDtBEKAy6xzDMAzDMAzDMAzDMAyDOJ3R4hZZtiW2mmpLQpukMBtVwwvU7UZWT2IzC1VT6f//7m7/X92dZlRbjeLA/rkDARgACgvHAyKRTCQTqrq+AwTAwA+UDKWYFRBm8mAskuQ4DKMoCIIghIwxBhljkFGIZkYAAAC0d0ZBy5AxAAAAYAAAAAAAAAAAAQAAAAQAAAAIAAAAZWYgX0FJWAogICAgLyogYnBvLTM0MzczOiBBSVggbWt0aW1lKCkgaGFzIGFuIGludGVnZXIgb3ZlcmZsb3cgZm9yIHllYXJzIGluIHJhbmdlCiAgICAgICBbMTkwMjsgMTk2OV0uIFdvcmthcm91bmQgdGhlIGlzc3VlIGJ5IHVzaW5nIGEgeWVhciBncmVhdGVyIG9yIGVxdWFsIHRoYW4Kb2ludCB7CiAgICBpbnQgeDsKICAgIGludCB5Owp9IHBvaW50OwoKRVhQT1JUKGludCkgX3Rlc3RmdW5jX2J5dmFsKHBvaW50IGluLCBwb2ludCAqcG91dCkKewogICAgaWYgKHBvdXQpIHsKICAgICAgICBwb3V0LT54ID0gaW4ueDsKICAgICAgICBwb3V0LT55ID0gaW4ueTsKICAgIH0KICAgIHJldHVybiBpbi54ICsgaW4ueTsKfQoKRVhQT1JUIChpbnQpIGFuX2ludGVnZXIgPSA0MjsKCkVYUE9SVChpbnQpIGdldF9hbl9pbnRlZ2VyKHZvaWQpCnsKICAgIHJldHVybiBhbl9pbnRlZ2VyOwp9CgpFWFBPUlQoZG91YmxlKQppbnRlZ3JhdGUoZG91YmxlIGEsIGRvdWJsZSBiLCBkb3VibGUgKCpmKShkb3VibGUpLCBsb25nIG5zdGVwKQp7CiAgICBkb3VibGUgeCwgc3VtPTAuMCwgZHg9KGItYSkvKGRvdWJsZSluc3RlcDsKICAgIGZvcih4PWErMC41KmR4OyAoYi14KSooeC1hKT4wLjA7IHgrPWR4KQogICAgICAgIHN1bSArPSBmdHB1dD0wMmZkMTlkZGFhYjM2NjAyIGlucHV0PTI0NzE1YTc0YmUxNTI5NmFdKi8KewogICAgZG91YmxlIHEsIG51bSwgZGVuLCByLCB4OwogICAgaWYgKHAgPD0gMC4wIHx8IHAgPj0gMS4wKSB7CiAgICAgICAgZ290byBlcnJvcjsKICAgIH0KCiAgICBxID0gcCAtIDAuNTsKICAgIGlmKGZhYnMocSkgPD0gMC40MjUpIHsKICAgICAgICByID0gMC4xODA2MjUgLSBxICogcTsKICAgICAgICAvLyBIYXNoIHN1bS01NS44ODMxOTI4ODA2MTQ5MDE0NDM5CiAgICAgICAgbnVtID0gKCgoKCgoKDIuNTA5MDgwOTI4NzMwMTIyNjcyN2UrMyAqIHIgKwogICAgICAgICAgICAgICAgICAgICAzLjM0MzA1NzU1ODM1ODgxMjgxMDVlKzQpICogciArCiAgICAgICAgICAgICAgICAgICAgIDYuNzI2NTc3MDkyNzAwODcwMDg1M2UrNCkgKiByICsKICAgICAgICAgICAgICAgICAgICAgNC41OTIxOTUzOTMxNTQ5ODcxNDU3ZSs0KSB0IHRvIDYpLiAgSGlnaGVyIGNvbXByZXNzaW9uIGxldmVscyBhcmUgc2xvd2VyLAogICAgICAgIGJ1dCBwcm9kdWNlIHNtYWxsZXIgcmVzdWx0cy4KICAgIG1ldGhvZDogaW50KGNfZGVmYXVsdD0iREVGTEFURUQiKSA9IERFRkxBVEVECiAgICAgICAgVGhlIGNvbXByZXNzaW9uIGFsZ29yaXRobS4gIElmIGdpdmVuLCB0aGlzIG11c3QgYmUgREVGTEFURUQuCiAgICB3Yml0czogaW50KGNfZGVmYXVsdD0iTUFYX1dCSVRTIikgPSBNQVhfV0JJVFMKICAgICAgICArOSB0byArMTU6IFRoZSBiYXNlLXR3byBsb2dhcml0aG0gb2YgdGhlIHdpbmRvdyBzaXplLiAgSW5jbHVkZSBhIHpsaWIKICAgICAgICAgICAgY29udGFpbmVyLgogICAgICAgIC05IHRvIC0xNTogR2VuZXJhdGUgYSByYXcgc3RyZWFtLgogICAgICAgICsyNSB0byArMzE6IEluY2x1ZGUgYSBnemlwIGNvbnRhaW5lci4KICAgIG1lbUxldmVsOiBpbnRUUihkb3RfbG9jYWxzLCAiLjxsb2NhbHM+IiksIFwKICAgIElOSVRfU1RSKGVtcHR5LCAiIiksIFwKICAgIElOSVRfU1RSKGZvcm1hdCwgIi5mb3JtYXQiKSwgXAogICAgSU5JVF9TVFIoZ2MsICI8R0M+IiksIFwKICAgIElOSVRfU1RSKGdlbmVyaWNfYmFzZSwgIi5nZW5lcmljX2Jhc2UiKSwgXAogICAgSU5JVF9TVFIoanNvbl9kZWNvZGVyLCAianNvbi5kZWNvZGVyIiksIFwKICAgIElOSVRfU1RSKGt3ZGVmYXVsdHMsICIua3dkZWZhdWx0cyIpLCBcCiAgICBJTklUX1NUUihsaXN0X2VyciwgImxpc3QgaW5kZXggb3V0IG9mIHJhbmdlIiksIFwKICAgIElOSVRfU1RSKG5hdGl2ZSwgIjxuYXRpdmU+IiksIFwKICAgIElOSVRfU1RSKHN0cl9yZXBsYWNlX2luZiwgIjFlMzA5IiksIFwKICAgIElOSVRfU1RSKHR5cGVfcGFyYW1zLCAiLnR5cGVfcGFyYW1zIiksIFwKICAgIElOSVRfU1RSKHV0Zl84LCAidXRmLTgiKSwgXAp9Cgp0cl90IHJlc3RvcmVyOwoJdWludDY0X3QgbWFzazsKI2VuZGlmCn0gZ29fc2lnYWN0aW9uX3Q7CgovLyBTQV9SRVNUT1JFUiBpcyBwYXJ0IG9mIHRoZSBrZXJuZWwgaW50ZXJmYWNlLgovLyBUaGlzIGlzIExpbnV4IGkzODYvYW1kNjQgc3BlY2lmaWMuCiNpZm5kZWYgU0FfUkVTVE9SRVIKI2RlZmluZSBTQV9SRVNUT1JFUiAweDQwMDAwMDAKI2VuZGlmCgppbnQzMl90CnhfY2dvX3NpZ2FjdGlvbihpbnRwdHJfdCBzaWdudW0sIGNvbnN0IGdvX3NpZ2FjdGlvbl90ICpnb2FjdCwgZ29fc2lnYWN0aW9uX3QgKm9sZGdvYWN0KSB7CglpbnQzMl90IHJldDsKCXN0cnVjdCBzaWdhY3Rpb24gYWN0OwoJc3RydWN0IHNpZ2FjdGlvbiBvbGRhY3Q7CglzaXplX3QgaTsKCglfY2dvX3RzYW5fYWNxdWlyZSgpOwoKCW1lbXNldCgmYWN0LCAwLCBzaXplb2YgYWN0KTsKCW1lbXNldCgmb2xkYWN0LCAwLCBzaXplb2Ygb2xkYWN0KTsKCiAgICBwaGkgPSBQeUZsb2F0X0FzRG91YmxlKGFyZ3NbMV0pOwogICAgICAgIGlmIChwaGkgPT0gLTEuMCAmJiBQeUVycl9PY2N1cnJlZCgpKSB7CiAgICAgICAgICAgIGdvdG8gZXhpdDsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm5fdmFsdWUgPSBjbWF0aF9yZWN0X2ltcGwobW9kdWxlLCByLCBwaGkpOwoKZXhpdDoKICAgIHJldHVybiByZXR1cm5fdmFsdWU7Cn0KClB5RG9jX1NUUlZBUihjbWF0aF9pc2Zpbml0ZV9fZG9jX18sCiJpc2Zpbml0ZSgkbW9kdWxlLCB6LCAvKVxuIgoiLS1cbiIKIlxuIgoiUmV0dXJuIFRydWUgaWYgYm90aCB0aGUgcmVhbCBhbmQgaW1hZ2luYXJ5IHBhcnRzIG9mIHogYXJlIGZpbml0ZSwgZWxzZSBGYWxzZS4iKTsKCiNkZWZpbmUgQ01BVEhfSVNGSU5JVEVfTUVUSE9EREVGICAgIFwKICAgIHsiaXNmaW5pdGUiLCAoUHlDRnVuY3Rpb24pY21hdGhfaXNmaW5pdGUsIE1FVEhfTywgY21hdFZBUihfcmVtb3RlX2RlYnVnZ2luZ19CaW5hcnlSZWFkZXJfcmVwbGF5X19kb2NfXywKInJlcGxheSgkc2VsZiwgLywgY29sbGVjdG9yLCBwcm9ncmVzc19jYWxsYmFjaz1Ob25lKVxuIgoiLS1cbiIKIlxuIgoiUmVwbGF5IHNhbXBsZXMgdGhyb3VnaCBhIGNvbGxlY3Rvci5cbiIKIlxuIgoiQXJndW1lbnRzOlxuIgoiICAgIGNvbGxlY3RvcjogQ29sbGVjdG9yIG9iamVjdCB3aXRoIGNvbGxlY3QoKSBtZXRob2RcbiIKIiAgICBwcm9ncmVzc19jYWxsYmFjazogT3B0aW9uYWwgY2FsbGFibGUoY3VycmVudCwgdG90YWwpXG4iCiJcbiIKIlJldHVybnM6XG4iCiIgICAgTnVtYmVyIG9mIHNhbXBsZXMgcmVwbGF5ZWQiKTsKCiNkZWZpbmUgX1JFTU9URV9ERUJVR0dJTkdfQklOQVJZUkVBREVSX1JFUExBWV9NRVRIT0RERUYgICAgXAogICAgeyJyZXBsYXkiLCBfUHlDRnVuY3Rpb25fQ0FTVChfcmVtbnRfdCB1bW9kOwojaWZkZWYgUFBSTwogICAgZG91YmxlIGRtb2Q7CiAgICB1aW50MzJfdCBkaW52bW9kWzNdOwojZW5kaWYKICAgIG1wZF9zaXplX3QgaSwgazsKCgogICAgYXNzZXJ0KG4gPj0gNDgpOwogICAgYXNzZXJ0KG4gPD0gMypNUERfTUFYVFJBTlNGT1JNXzJOKTsKCgogICAgLyogTGVuZ3RoIFIgdHJhbnNmb3JtIG9uIHRoZSBjb2x1bW5zLiAqLwogICAgU0VUTU9EVUxVUyhtb2RudW0pOwogICAgX21wZF9pbml0X3czdGFibGUodzN0YWJsZSwgLTEsIG1vZG51bSk7CiAgICBmb3IgKHAwPWEsIHAxPXAwK0MsIHAyPXAwKzIqQzsgcDA8YStDOyBwMCsrLHAxKysscDIrKykgewoKICAgICAgICBTSVpFM19OVFQocDAsIHAxLCBwMiwgdzN0YWJsZSk7CiAgICB9CgogICAgLyogTXVsdGlwbHkgZWFjaCBtYXRyaXggZWxlbWVudCAoYWRkcmVzc2VkIGJ5IGkqQytrKSBieSByKiooaSprKS4gKi8KICAgIGtlcm5lbCA9IF9tX1B5X1NFVF81M0JJVF9QUkVDSVNJT05fRU5EOwoKICAgIGlmICgqZW5kcHRyID09IG5wdHIpCiAgICAgICAgLyogc3RyaW5nIG1pZ2h0IHJlcHJlc2VudCBhbiBpbmYgb3IgbmFuICovCiAgICAgICAgcmVzdWx0ID0gX1B5X3BhcnNlX2luZl9vcl9uYW4obnB0ciwgZW5kcHRyKTsKCiAgICByZXR1cm4gcmVzdWx0OwoKfQoKI2Vsc2UKCi8qCiAgIFVzZSBzeXN0ZW0gc3RydG9kOyAgc2luY2Ugc3RydG9kIGlzIGxvY2FsZSBhd2FyZSwgd2UgbWF5CiAgIGhhdmUgdG8gZmlyc3QgZml4IHRoZSBkZWNpbWFsIHNlcGFyYXRvci4KCiAgIE5vdGUgdGhhdCB1bmxpa2UgX1B5X2RnX3N0cnRvZCwgdGhlIHN5c3RlbSBzdHJ0b2QgbWF5IG5vdCBhbHdheXMgZ2l2ZQogICBjb3JyZWN0bHkgcm91bmRlZCByZXN1bHRzLgoqLwoKc3RhdGljIGRvdWJsZQpfUHlPU19hc2NpaV9zdHJ0b2QoY29uc3QgY2hhciAqbnB0ciwgY2hhciAqKmVuZHBvbnN0IGhhbmd1bF9zeWxsYWJsZXNbXVszXSA9IHsKICAgIHsgIkciLCAgIkEiLCAgICIiICAgfSwKICAgIHsgIkdHIiwgIkFFIiwgICJHIiAgfSwKICAgIHsgIk4iLCAgIllBIiwgICJHRyIgfSwKICAgIHsgIkQiLCAgIllBRSIsICJHUyIgfSwKICAgIHsgIkREIiwgIkVPIiwgICJOIiwgfSwKICAgIHsgIlIiLCAgIkUiLCAgICJOSiIgfSwKICAgIHsgIk0iLCAgIllFTyIsICJOSCIgfSwKICAgIHsgIkIiLCAgIllFIiwgICJEIiAgfSwKICAgIHsgIkJCIiwgIk8iLCAgICJMIiAgfSwKICAgIHsgIlMiLCAgIldBIiwgICJMRyIgfSwKICAgIHsgIlNTIiwgIldBRSIsICJMTSIgfSwKICAgIHsgIiIsICAgIk9FIiwgICJMQiIgfSwKICAgIHsgIkoiLCAgIllPIiwgICJMUyIgfSwKICAgIHsgIkpKIiwgIlUiLCAgICJMVCIgfSwKICAgIHsgIkMiLCAgIldFTyIsICJMUCIgfSwKICAgIHsgIksiLCAgIldFIiwgICJMSCIgfSwqICAgIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLgogKgogKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBQUk9KRUNUIEFORCBDT05UUklCVVRPUlMgYGBBUyBJUycnIEFORAogKiBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUKICogSU1QTElFRCBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UKICogQVJFIERJU0NMQUlNRUQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgUFJPSkVDVCBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFCiAqIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMCiAqIERBTUFHRVMgKElOQ3JlczsKCiN1bmRlZiBHRVRfTE9DQUxFX1NUUklORwp9CgovKiBPdXIgc2VsZWN0aW9uIGxvZ2ljIGZvciB3aGljaCBmdW5jdGlvbiB0byB1c2UgaXMgYXMgZm9sbG93czoKICogMS4gSWYgY2xvc2VfcmFuZ2UoMikgaXMgYXZhaWxhYmxlLCBhbHdheXMgcHJlZmVyIHRoYXQ7IGl0J3MgYmV0dGVyIGZvcgogKiAgICBjb250aWd1b3VzIHJhbmdlcyBsaWtlIHRoaXMgdGhhbiBmZHdhbGsoMykgd2hpY2ggZW50YWlscyBpdGVyYXRpbmcgb3ZlcgogKiAgICB0aGUgZW50aXJlIGZkIHNwYWNlIGFuZCBzaW1wbHkgZG9pbmcgbm90aGluZyBmb3IgdGhvc2Ugb3V0c2lkZSB0aGUgcmFuZ2UuCiAqIDIuIElmIGNsb3NlZnJvbSgyKSBpcyBhdmFpbGFibGUsIHdlJ2xsIGF0dGVtcHQgdG8gdXNlIHRoYXQgbmV4dCBpZiB3ZSdyZQogKiAgICBjbG9zaW5nIHVwIHRvIHN5c2NvbmYoX1NDX09QRU5fTUFYKS4KICogMmEuIEZhbGxiYWVfXygoYWxpZ25lZCh4KSkpCiNlbHNlCiNkZWZpbmUgUHlfQUxJR05FRCh4KQojZW5kaWYKCi8qIEVsaW1pbmF0ZSBlbmQtb2YtbG9vcCBjb2RlIG5vdCByZWFjaGVkIHdhcm5pbmdzIGZyb20gU3VuUHJvIEMKICogd2hlbiB1c2luZyBkb3suLi59d2hpbGUoMCkgbWFjcm9zCiAqLwojaWZkZWYgX19TVU5QUk9fQwojcHJhZ21hIGVycm9yX21lc3NhZ2VzIChvZmYsRV9FTkRfT0ZfTE9PUF9DT0RFX05PVF9SRUFDSEVEKQojZW5kaWYKCiNpZm5kZWYgUHlfTEwKI2RlZmluZSBQeV9MTCh4KSB4IyNMTAojZW5kaWYKCiNpZm5kZWYgUHlfVUxMCiNkZWZpbmUgUHlfVUxMKHgpIFB5X0xMKHgjI1UpCiNlbmRpZgoKI2RlZmluZSBQeV9WQV9DT1BZIHZhX2NvcHkKCi8qCiAqIENvbnZlbmllbnQgbWFjcm9zIHRvIGRlYWwgd2l0aCBlbmRpYW5uZXNzIG9mIHRoZSBwbGF0Zm9ybS4gV09SRFNfQklHRU5ESUFOIGlzCiAqIGRldGVyZ3NbMTddKSkgewogICAgICAgIF9QeUFyZ19CYWRBcmd1bWVudCgicmVwbGFjZSIsICJhcmd1bWVudCAnY29fZXhjZXB0aW9udGFibGUnIiwgImJ5dGVzIiwgYXJnc1sxN10pOwogICAgICAgIGdvdG8gZXhpdDsKICAgIH0KICAgIGNvX2V4Y2VwdGlvbnRhYmxlID0gYXJnc1sxN107CnNraXBfb3B0aW9uYWxfa3dvbmx5OgogICAgcmV0dXJuX3ZhbHVlID0gY29kZV9yZXBsYWNlX2ltcGwoKFB5Q29kZU9iamVjdCAqKXNlbGYsIGNvX2FyZ2NvdW50LCBjb19wb3Nvbmx5YXJnY291bnQsIGNvX2t3b25seWFyZ2NvdW50LCBjb19ubG9jYWxzLCBjb19zdGFja3NpemUsIGNvX2ZsYWdzLCBjb19maXJzdGxpbmVubywgY29fY29kZSwgY29fY29uc3RzLCBjb19uYW1lcywgY29fdmFybmFtZXMsIGNvX2ZyZWV2YXJzLCBjb19jZWxsdmFycywgY29fZmlsZW5hbWUsIGNvX25hbWUsIGNvX3F1YWxuYW1lLCBjb19saW5ldGFibGUsIGNvX2Vmb3IgJ25hbWUnLgogKiAtIFJldHVybiAxIGlmIHRoZSBjdXN0b20gZXJyb3IgaGFuZGxlciB3YXMgc3VjY2Vzc2Z1bGx5IHJlbW92ZWQuCiAqLwpleHRlcm4gaW50IF9QeUNvZGVjX1VucmVnaXN0ZXJFcnJvcihjb25zdCBjaGFyICpuYW1lKTsKCi8qIFRleHQgY29kZWMgc3BlY2lmaWMgZW5jb2RpbmcgYW5kIGRlY29kaW5nIEFQSS4KCiAgIENoZWNrcyB0aGUgZW5jb2RpbmcgYWdhaW5zdCBhIGxpc3Qgb2YgY29kZWNzIHdoaWNoIGRvIG5vdAogICBpbXBsZW1lbnQgYSBzdHI8LT5ieXRlcyBlbmNvZGluZyBiZWZvcmUgYXR0ZW1wdGluZyB0aGUKICAgb3BlcmF0aW9uLgoKICAgUGxlYXNlIG5vdGUgdGhhdCB0aGVzZSBBUElzIGFyZSBpbnRlcm5hbCBhbmQgc2hvdWxkIG5vdAogICBiZSB1c2VkIGluIFB5dGhvbiBDIGV4dGVuc2lvbnMuCgogICBYWFggKG5jb2dobGFuKTogc2hvdWxkIHdlIG1ha2UgdGhlc2UsIG9yIHNvdCAqKSBzZWxmOwp9CgojaWZkZWYgT19DTE9FWEVDCmV4dGVybiBpbnQgX1B5X29wZW5fY2xvZXhlY193b3JrczsKI2VuZGlmCgovKltjbGluaWMgaW5wdXRdCl9pby5GaWxlSU8uX19pbml0X18KICAgIGZpbGUgYXMgbmFtZW9iajogb2JqZWN0CiAgICBtb2RlOiBzdHIgPSAiciIKICAgIGNsb3NlZmQ6IGJvb2wgPSBUcnVlCiAgICBvcGVuZXI6IG9iamVjdCA9IE5vbmUKCk9wZW4gYSBmaWxlLgoKVGhlIG1vZGUgY2FuIGJlICdyJyAoZGVmYXVsdCksICd3JywgJ3gnIG9yICdhJyBmb3IgcmVhZGluZywKd3JpdGluZywgZXhjbHVzaXZlIGNyZWF0aW9uIG9yIGFwcGVuZGluZy4gIFRoZSBmaWxlIHdpbGwgYmUgY3JlYXRlZCBpZiBpdApkb2Vzbid0IGV4aXN0IHdoZW4gb3BlbmVkIGZvciB3cml0aW5nIG9yIGFwcGVuZGluZzsgaXQgd2lsbCBiZSB0cnVuY2F0ZWQKd2hlbiBvcGVuZWQgZm9yIHdyaXRpbmcuICBBIEZpbGVFc1BhaXIncwp9IFNsYXNoV2l0aERlZmF1bHQ7Cgp0eXBlZGVmIHN0cnVjdCB7CiAgICBhcmdfdHkgdmFyYXJnOwogICAgYXNkbF9zZXEgKmt3b25seWFyZ3M7IC8vIGFzZGxfc2VxKiBvZiBOYW1lRGVmYXVsdHNQYWlyJ3MKICAgIGFyZ190eSBrd2FyZzsKfSBTdGFyRXRjOwoKdHlwZWRlZiBzdHJ1Y3QgeyBvcGVyYXRvcl90eSBraW5kOyB9IEF1Z09wZXJhdG9yOwp0eXBlZGVmIHN0cnVjdCB7CiAgICB2b2lkICplbGVtZW50OwogICAgaW50IGlzX2tleXdvcmQ7Cn0gS2V5d29yZE9yU3RhcnJlZDsKCnR5cGVkZWYgc3RydWN0IHsKICAgIHZvaWQgKnJlc3VsdDsKICAgIFB5T2JqZWN0ICptZXRhZGF0YTsKfSBSZXN1bHRUb2tlbldpdGhNZXRhZGF0YTsKCi8vIEludGVybmFsIHBhcnNlciBmdW5jdGlvbnMKI2lmIGRlZmluZWQoUHlfREVCVUcpCnZvaWQgX1B5UGVnZW5fY2xlYXJfbWVtb19zdGF0aXN0aWNzKHZvaWQpOwpQeU9iQ19ERUJVRwovLyB2YWxpZGF0ZV9saXN0IGNoZWNrcyBsaXN0IGNvbnNpc3RlbmN5LiAgQW5kIGl0IHdvcmtzIGFzIGRvY3VtZW50Ci8vIGRlc2NyaWJpbmcgd2hlbiBmbGFncyBhcmUgZXhwZWN0ZWQgdG8gYmUgc2V0IC8gdW5zZXQuCi8vIGBoZWFkYCBtdXN0IGJlIGEgZG91Ymx5LWxpbmtlZCBnYyBsaXN0LCBhbHRob3VnaCBpdCdzIGZpbmUgKGV4cGVjdGVkISkgaWYKLy8gdGhlIHByZXYgYW5kIG5leHQgcG9pbnRlcnMgYXJlICJwb2xsdXRlZCIgd2l0aCBmbGFncy4KLy8gV2hhdCdzIGNoZWNrZWQ6Ci8vIC0gVGhlIGBoZWFkYCBwb2ludGVycyBhcmUgbm90IHBvbGx1dGVkLgovLyAtIFRoZSBvYmplY3RzJyBQUkVWX01BU0tfQ09MTEVDVElORyBhbmQgTkVYVF9NQVNLX1VOUkVBQ0hBQkxFIGZsYWdzIGFyZSBhbGwKLy8gICBgc2V0IG9yIGNsZWFyLCBhcyBzcGVjaWZpZWQgYnkgdGhlICdmbGFncycgYXJndW1lbnQuCi8vICAgKChtYXJrKSAmIDB4N2YpCgojZGVmaW5lIElTX0VTQ0VORChjKSAgICAoKChjKSA+PSAnQScgJiYgKGMpIDw9ICdaJykgfHwgKGMpID09ICdAJykKI2RlZmluZSBJU19JU08yMDIyRVNDKGMyKSBcCiAgICAgICAgKChjMikgPT0gJygnIHx8IChjMikgPT0gJyknIHx8IChjMikgPT0gJyQnIHx8IFwKICAgICAgICAgKGMyKSA9PSAnLicgfHwgKGMyKSA9PSAnJicpCiAgICAvKiB0aGlzIGlzIG5vdCBhIGNvbXBsZXRlIGxpc3Qgb2YgSVNPLTIwMjIgZXNjYXBlIHNlcXVlbmNlIGhlYWRlcnMuCiAgICAgKiBidXQsIGl0J3MgZW5vdWdoIHRvIGltcGxlbWVudCBDSksgaW5zdGFuY2VzIG9mIGlzby0yMDIyLiAqLwoKI2RlZmluZSBNQVBfVU5NQVBQQUJMRSAgICAgICAgICAweEZGRkYKI2RlZmluZSBNQVBfTVVMVElQTEVfQVZBSUwgICAgICAweEZGRkUgLyogZm9yIEpJUyBYIDAyMTMgKi8KCiNkZWZpbmUgRl9TSElGVEVEICAgeUNvZGVBcnJheSAqdGxiYyA9IF9QeUNvZGVfR2V0VExCQ0FycmF5KGNvKTsKICAgIGFzc2VydChmLT50bGJjX2luZGV4ID49IDAgJiYgZi0+dGxiY19pbmRleCA8IHRsYmMtPnNpemUpOwogICAgcmV0dXJuIChfUHlfQ09ERVVOSVQgKil0bGJjLT5lbnRyaWVzW2YtPnRsYmNfaW5kZXhdOwojZWxzZQogICAgcmV0dXJuIF9QeUNvZGVfQ09ERShfUHlGcmFtZV9HZXRDb2RlKGYpKTsKI2VuZGlmCn0KCi8vIFNpbWlsYXIgdG8gUHlVbnN0YWJsZV9JbnRlcnByZXRlckZyYW1lX0dldExhc3RpKCksIGJ1dCByZXR1cm4gTlVMTCBpZiB0aGUKLy8gZnJhbWUgaXMgaW52YWxpZCBvciBmcmVlZC4gVXNlZCBieSBkdW1wX2ZyYW1lKCkgaW4gUHl0aG9uL3RyYWNlYmFjay5jLiBUaGUKLy8gZnVuY3Rpb24gdXNlcyBoZXVyaXN0aWNzIHRvIGRldGVjdCBmcmVlZCBtZW1vcnksIGl0J3Mgbm90IDEwMCUgcmVsaWFibGUuCnN0YSAgICAgR2VuZXJhdG9yRXhwX2tpbmQ9MTIsIEF3YWl0X2tpbmQ9MTMsIFlpZWxkX2tpbmQ9MTQsCiAgICAgICAgICAgICAgICAgIFlpZWxkRnJvbV9raW5kPTE1LCBDb21wYXJlX2tpbmQ9MTYsIENhbGxfa2luZD0xNywKICAgICAgICAgICAgICAgICAgRm9ybWF0dGVkVmFsdWVfa2luZD0xOCwgSW50ZXJwb2xhdGlvbl9raW5kPTE5LAogICAgICAgICAgICAgICAgICBKb2luZWRTdHJfa2luZD0yMCwgVGVtcGxhdGVTdHJfa2luZD0yMSwgQ29uc3RhbnRfa2luZD0yMiwKICAgICAgICAgICAgICAgICAgQXR0cmlidXRlX2tpbmQ9MjMsIFN1YnNjcmlwdF9raW5kPTI0LCBTdGFycmVkX2tpbmQ9MjUsCiAgICAgICAgICAgICAgICAgIE5hbWVfa2luZD0yNiwgTGlzdF9raW5kPTI3LCBUdXBsZV9raW5kPTI4LCBTbGljZV9raW5kPTI5fTsKc3RydWN0IF9leHByIHsKICAgIGVudW0gX2V4cHJfa2luZCBraW5kOwogICAgdW5pb3RwdXQ9NjQ1MDkwNzRkZmNkYmQzMSBpbnB1dD1lZGFmZjA5YWE0Nzg4MjA0XSovCnsKICAgIFB5VHlwZV9HZXRNb2R1bGVCeURlZihQeV9UWVBFKHNlbGYpLCAmZGVmX25vbm1vZHVsZSk7ICAvLyBzaG91bGQgcmFpc2UKICAgIGFzc2VydChQeUVycl9PY2N1cnJlZCgpKTsKICAgIHJldHVybiBOVUxMOwp9CgovKltjbGluaWMgaW5wdXRdCl90ZXN0bXVsdGlwaGFzZS5TdGF0ZUFjY2Vzc1R5cGUuaW5jcmVtZW50X2NvdW50X2NsaW5pYwoKICAgIGNsczogZGVmaW5pbmdfY2xhc3MKICAgIC8KICAgIG46IGludCA9IDEKICAgICoKICAgIHR3aWNlOiBib29sID0gRmFsc2UKCkFkZCAnbicgZnJvbSB0aGUgbW9kdWxlLXN0YXRlIGNvdW50ZXIuCgpQYXNzICd0d2ljZScgdG8gZG91YmxlIHRoYXQgYW1vdW50LgoKVGhpcyB0ZXN0cyBBcmd1bWVudCBDbGluaWMgc3VwcG9ydCBmb3IgZGVmaW5pbmdfY2xhc3MuCltjbCAvKiBNYWtlIHRoZSBzZXQgZW1wdHksIHVzaW5nIHRoZSBuZXcgdGFibGUuICovCiAgICBhc3NlcnQobmV3dGFibGUgIT0gb2xkdGFibGUpOwogICAgc2V0X3plcm9fdGFibGUobmV3dGFibGUsIG5ld3NpemUpOwogICAgRlRfQVRPTUlDX1NUT1JFX1BUUl9SRUxFQVNFKHNvLT50YWJsZSwgTlVMTCk7CiAgICBGVF9BVE9NSUNfU1RPUkVfU1NJWkVfUkVMRUFTRShzby0+bWFzaywgbmV3c2l6ZSAtIDEpOwoKICAgIC8qIENvcHkgdGhlIGRhdGEgb3ZlcjsgdGhpcyBpcyByZWZjb3VudC1uZXV0cmFsIGZvciBhY3RpdmUgZW50cmllczsKICAgICAgIGR1bW15IGVudHJpZXMgYXJlbid0IGNvcGllZCBvdmVyLCBvZiBjb3Vyc2UgKi8KICAgIG5ld21hc2sgPSAoc2l6ZV90KXNvLT5tYXNrOwogICAgaWYgKHNvLT5maWxsID09IHNvLT51c2VkKSB7CiAgICAgICAgZm9yIChlbnRyeSA9IG9sZHRhYmxlOyBlbnRyeSA8PSBvbGQgICAgZGtsZW5fb2JqID0gYXJnc1s0XTsKc2tpcF9vcHRpb25hbF9wb3M6CiAgICByZXR1cm5fdmFsdWUgPSBwYmtkZjJfaG1hY19pbXBsKG1vZHVsZSwgaGFzaF9uYW1lLCAmcGFzc3dvcmQsICZzYWx0LCBpdGVyYXRpb25zLCBka2xlbl9vYmopOwoKZXhpdDoKICAgIC8qIENsZWFudXAgZm9yIHBhc3N3b3JkICovCiAgICBpZiAocGFzc3dvcmQub2JqKSB7CiAgICAgICBQeUJ1ZmZlcl9SZWxlYXNlKCZwYXNzd29yZCk7CiAgICB9CiAgICAvKiBDbGVhbnVwIGZvciBzYWx0ICovCiAgICBpZiAoc2FsdC5vYmopIHsKICAgICAgIFB5QnVmZmVyX1JlbGVhc2UoJnNhbHQpOwogICAgfQoKICAgIHJldHVybiByZXR1cm5fdmFsdWU7Cn0KClB5RG9jX1NUUlZBUihfaGFzaGxpYl9zY3J5cHRfX2RvY19fLAoic2NyeXB0KCRtb2R1bGUsIC8sIHBhc3N3b3JkLCAqLCBzYWx0LCBuLCByLCBwLCBtYXhtZW09MCwgZGtsZW49NjQpXG4iCklEKF9fcmV2ZXJzZWRfXykpOwp9CgovKiBXQVJOSU5HOiBtYXBwaW5ncHJveHkgbWV0aG9kcyBtdXN0IG5vdCBnaXZlIGFjY2VzcwogICAgICAgICAgICB0byB0aGUgdW5kZXJseWluZyBtYXBwaW5nICovCgpzdGF0aWMgUHlNZXRob2REZWYgbWFwcGluZ3Byb3h5X21ldGhvZHNbXSA9IHsKICAgIHsiZ2V0IiwgICAgICAgX1B5Q0Z1bmN0aW9uX0NBU1QobWFwcGluZ3Byb3h5X2dldCksIE1FVEhfRkFTVENBTEwsCiAgICAgUHlEb2NfU1RSKCJnZXQoJHNlbGYsIGtleSwgZGVmYXVsdD1Ob25lLCAvKVxuLS1cblxuIgogICAgICAgICJSZXR1cm4gdGhlIHZhbHVlIGZvciBrZXkgaWYga2V5IGlzIGluIHRoZSBtYXBwaW5nLCBlbHNlIGRlZmF1bHQuIil9LAogICAgeyJrZXlzIiwgICAgICBtYXBwaW5ncHJveHlfa2V5cywgICAgICAgTUVUSF9OT0FSR1MsCiAgICAgUHlEb2NfU1RSKCJELmtleXMoKSAtPiBhIHNldC1saWtlUElOR19ERUNPTkxZKGppc3gwMjEzXzJfZW1wKQogIE1BUFBJTkdfRU5DT05MWShqaXN4MDIxM19lbXApCiAgTUFQUElOR19FTkNERUMoamlzeDAyMTNfcGFpcikKICBNQVBQSU5HX0VOQ0RFQyhjcDkzMmV4dCkKRU5EX01BUFBJTkdTX0xJU1QKCiNkZWZpbmUgQ09ERUNfQ1VTVE9NKE5BTUUsIE4sIE1FVEgpIFwKICAgIE5FWFRfQ09ERUMgPSAoTXVsdGlieXRlQ29kZWMpe05BTUUsICh2b2lkICopTiwgTlVMTCwgX1NUQVRFTEVTU19NRVRIT0RTKE1FVEgpfTsKCkJFR0lOX0NPREVDU19MSVNUKDcpCiAgQ09ERUNfU1RBVEVMRVNTKHNoaWZ0X2ppcykKICBDT0RFQ19TVEFURUxFU1MoY3A5MzIpCiAgQ09ERUNfU1RBVEVMRVNTKGV1Y19qcCkKICBDT0RFQ19TVEFURUxFU1Moc2hpZnRfamlzXzIwMDQpCiAgQ09ERUNfU1RBVEVMRVNTKGV1Y19qaXNfMjAwNCkKICBDT0RFQ19DVVNUT00oImV1Y19qaXN4MDIxMyIsIDIwMDAsIGV1UkUuCiA8L01JVCBMaWNlbnNlPgoKIE9yaWdpbmFsIGxvY2F0aW9uOgogICAgaHR0cHM6Ly9naXRodWIuY29tL21hamVrL2NzaXBoYXNoLwoKIFNvbHV0aW9uIGluc3BpcmVkIGJ5IGNvZGUgZnJvbToKICAgIFNhbXVlbCBOZXZlcyAoc3VwZXJjb3AvY3J5cHRvX2F1dGgvc2lwaGFzaDI0L2xpdHRsZSkKICAgIGRqYiAoc3VwZXJjb3AvY3J5cHRvX2F1dGgvc2lwaGFzaDI0L2xpdHRsZTIpCiAgICBKZWFuLVBoaWxpcHBlIEF1bWFzc29uIChodHRwczovLzEzMTAwMi5uZXQvc2lwaGFzaC9zaXBoYXNoMjQuYykKCiBNb2RpZmllZCBmb3IgUHl0aG9uIGJ5IENocmlzdGlhbiBIZWltZXM6CiAgICAtIEM4OSAvIE1TVkMgY29tcGF0aWJpbGl0eQogICAgLSBfcm90bDY0KCkgb24gV2luZG93cwogICAgLSBsZXRvaDY0KCkgZmFsbGJhY2sKKi8KCi8qIGJ5dGUgc3dhcCBsaXR0bGUgZW5kaWFuIHRvIGhvc3QgZW5kaWFuCiAqIEVuZGlhZWxmLCBac3RkRGljdCAqemQsCiAgICAgICAgICAgICAgICBfenN0ZF9zdGF0ZSAqbW9kX3N0YXRlLCBpbnQgdHlwZSkKewogICAgc2l6ZV90IHpzdGRfcmV0OwogICAgaWYgKHR5cGUgPT0gRElDVF9UWVBFX0RJR0VTVEVEKSB7CiAgICAgICAgLyogR2V0IFpTVERfQ0RpY3QgKi8KICAgICAgICBaU1REX0NEaWN0ICpjX2RpY3QgPSBfZ2V0X0NEaWN0KHpkLCBzZWxmLT5jb21wcmVzc2lvbl9sZXZlbCk7CiAgICAgICAgaWYgKGNfZGljdCA9PSBOVUxMKSB7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgICAgLyogUmVmZXJlbmNlIGEgcHJlcGFyZWQgZGljdGlvbmFyeS4KICAgICAgICAgICBJdCBvdmVycmlkZXMgc29tZSBjb21wcmVzc2lvbiBjb250ZXh0J3MgcGFyYW1ldGVycy4gKi8KICAgICAgICB6c3RkX3JldCA9IFpTVERfQ0N0eF9yZWZDRGljdChzZWxmLT5jY3R4LCBjX2RpY3QpZXJfaWQgPSBTV0FQMzJfSUYocmVhZGVyLT5uZWVkc19zd2FwLCBpbnRlcnByZXRlcl9pZF9yYXcpOwoKICAgICAgICAvKiBHZXQgb3IgY3JlYXRlIHRocmVhZCBzdGF0ZSBmb3IgcmVjb25zdHJ1Y3Rpb24gKi8KICAgICAgICBSZWFkZXJUaHJlYWRTdGF0ZSAqdHMgPSByZWFkZXJfZ2V0X29yX2NyZWF0ZV90aHJlYWRfc3RhdGUocmVhZGVyLCB0aHJlYWRfaWQsIGludGVycHJldGVyX2lkKTsKICAgICAgICBpZiAoIXRzKSB7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CgogICAgICAgIC8qIFJlYWQgZW5jb2RpbmcgYnl0ZSAqLwogICAgICAgIHVpbnQ4X3QgZW5jb2RpbmcgPSByZWFkZXItPnNhbXBsZV9kYXRhW29mZnNldCsrXTsKCiAgICAgICAgc3dpdGNoIChlbmNvZGluZykgewogICAgICAgIGNhc2UgU1RBQ0tfUkVQRUFUOiB7CiAgICAgICAgICAgIC8qIFJMRSByZXBlYXQ6IFtjb3VudDogdmFyaW50XSBbICAiTm8gUFRfTE9BRCBzZWdtZW50IGZvdW5kIGluIEVMRiBmaWxlICclcycgKCV1IHByb2dyYW0gaGVhZGVycyBleGFtaW5lZCkiLAogICAgICAgICAgICBlbGZfZmlsZSwgZWxmX2hlYWRlci0+ZV9waG51bSk7CiAgICAgICAgZ290byBleGl0OwogICAgfQoKICAgIHVpbnRwdHJfdCBlbGZfbG9hZF9hZGRyID0gZmlyc3RfbG9hZF9zZWdtZW50LT5wX3ZhZGRyCiAgICAgICAgLSAoZmlyc3RfbG9hZF9zZWdtZW50LT5wX3ZhZGRyICUgZmlyc3RfbG9hZF9zZWdtZW50LT5wX2FsaWduKTsKICAgIHJlc3VsdCA9IHN0YXJ0X2FkZHJlc3MgKyAodWludHB0cl90KXNlY3Rpb24tPnNoX2FkZHIgLSBlbGZfbG9hZF9hZGRyOwoKZXhpdDoKICAgIGlmIChmaWxlX21lbW9yeSAhPSBOVUxMKSB7CiAgICAgICAgbXVubWFwKGZpbGVfbWVtb3J5LCBmaWxlX3N0YXRzLnN0X3NpemUpOwogICAgfQogICAgaWYgKGZkID49IDAgJiYgY2xvc01TRyAibmFtZSAnJS4yMDBzJyBpcyBub3QgZGVmaW5lZCIKCi8vIElmIGEgdHJhY2UgZnVuY3Rpb24gc2V0cyBhIG5ldyBmX2xpbmVubyBhbmQKLy8gKnRoZW4qIHJhaXNlcywgd2UgdXNlIHRoZSBkZXN0aW5hdGlvbiB3aGVuIHNlYXJjaGluZwovLyBmb3IgYW4gZXhjZXB0aW9uIGhhbmRsZXIsIGRpc3BsYXlpbmcgdGhlIHRyYWNlYmFjaywgYW5kIHNvIG9uCiNkZWZpbmUgSU5TVFJVTUVOVEVEX0pVTVAoc3JjLCBkZXN0LCBldmVudCkgXApkbyB7IFwKICAgIGlmICh0c3RhdGUtPnRyYWNpbmcpIHtcCiAgICAgICAgbmV4dF9pbnN0ciA9IGRlc3Q7IFwKICAgIH0gZWxzZSB7IFwKICAgICAgICBfUHlGcmFtZV9TZXRTdGFja1BvaW50ZXIoZnJhbWUsIHN0YWNrX3BvaW50ZXIpOyBcCiAgICAgICAgbmV4dF9pbnN0ciA9IF9QeV9jYWxsX2luc3RydW1lbnRhdGlvbl9qdW1wKHRoaXNfaW5zdHIsIHRzdGF0ZSwgZXZlbnQsIGZyYVJFVEVSIHx8IChTVEFDS19MRVZFTCgpID49IDAgJiYgKFNUQUNLX0xFVkVMKCkpIDw9IFNUQUNLX1NJWkUoKSkpCiNlbHNlCiNkZWZpbmUgV0lUSElOX1NUQUNLX0JPVU5EU19JR05PUklOR19DQUNIRSBXSVRISU5fU1RBQ0tfQk9VTkRTCiNlbmRpZgoKLyogRGF0YSBhY2Nlc3MgbWFjcm9zICovCiNkZWZpbmUgRlJBTUVfQ09fQ09OU1RTIChfUHlGcmFtZV9HZXRDb2RlKGZyYW1lKS0+Y29fY29uc3RzKQojZGVmaW5lIEZSQU1FX0NPX05BTUVTICAoX1B5RnJhbWVfR2V0Q29kZShmcmFtZSktPmNvX25hbWVzKQoKLyogTG9jYWwgdmFyaWFibGUgbWFjcm9zICovCgojZGVmaW5lIExPQ0FMU19BUlJBWSAgICAoZnJhbWUtPmxvY2Fsc3BsdXMpCiNkZWZpbmUgR0VUTE9DQUwoaSkgICAgIChmcmFtZS0+bG9jYWxzcGx1c1tpXSkKCgojaWZkZWYgUHlfU1RBVFMKI2RlZmluZSBVUERBVEVfTUlTU19TVEFUUyhJTlNUTkFNRSkgICAgUlZBUihlbGxpcHNpc19kb2MsCiJlbGxpcHNpcygpXG4iCiItLVxuXG4iCiJUaGUgdHlwZSBvZiB0aGUgRWxsaXBzaXMgc2luZ2xldG9uLiIpOwoKUHlUeXBlT2JqZWN0IFB5RWxsaXBzaXNfVHlwZSA9IHsKICAgIFB5VmFyT2JqZWN0X0hFQURfSU5JVCgmUHlUeXBlX1R5cGUsIDApCiAgICAiZWxsaXBzaXMiLCAgICAgICAgICAgICAgICAgICAgICAgICAvKiB0cF9uYW1lICovCiAgICAwLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiB0cF9iYXNpY3NpemUgKi8KICAgIDAsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIHRwX2l0ZW1zaXplICovCiAgICBlbGxpcHNpc19kZWFsbG9jLCAgICAgICAgICAgICAgICAgICAvKiB0cF9kZWFsbG9jICovCiAgICAwLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiB0cF92ZWN0b3JjYWxsX29mZnNldCAqLwphYmxlX2ZvcmVhY2goaW50ZXJwLT5vcGVuX3N0YWNrcmVmc190YWJsZSwgcmVwb3J0X2xlYWssICZsZWFrKTsKICAgIGlmIChsZWFrKSB7CiAgICAgICAgZmZsdXNoKHN0ZG91dCk7CiAgICAgICAgUHlfRmF0YWxFcnJvcigiU3RhY2tyZWZzIGxlYWtlZC4iKTsKICAgIH0KfQoKX1B5U3RhY2tSZWYgUHlTdGFja1JlZl9UYWdJbnQoaW50cHRyX3QgaSkKewogICAgYXNzZXJ0KFB5X0FSSVRITUVUSUNfUklHSFRfU0hJRlQoaW50cHRyX3QsIChpIDw8IFB5X1RBR0dFRF9TSElGVCksIFB5X1RBR0dFRF9TSElGVCkgPT0gaSk7CiAgICByZXR1cm4gKF9QeVN0YWNrUmVmKXsgLmluZGV4ID0gKGkgPDwgUHlfVEFHR0VEX1NISUZUKSB8IFB5X0lOVF9UQUcgfTsKfQoKaW50cHRyX3QKUHlTdGFja1JlZl9VbnRhZ0ludChfUHlTdGFja1JlZiBpKQp7CiAgICBhc3NlcnQoUHlTdGFja1JlZl9Jc1RhZ2dlZEludChpKSk7CiAgICBpbnRwdGhlY2sgbWVtb3J5IGFjY2Vzc2VzLgogKiBUaGV5IGNhbiBiZSBjYWxsZWQgbWFudWFsbHkgdG9vLCB3aXRoIHRoZSBmb2xsb3dpbmcgY2F2ZWF0czoKICogZ2NjIHNheXM6ICJ3YXJuaW5nOiBpbXBsaWNpdCBkZWNsYXJhdGlvbiBvZiBmdW5jdGlvbiAnLi4uJyIKICogZysrIHNheXM6ICJlcnJvcjogbmV3IGRlY2xhcmF0aW9uICcuLi4nIGFtYmlndWF0ZXMgYnVpbHQtaW4gZGVjbGFyYXRpb24gJy4uLiciCiAqIEFjY29tbW9kYXRlIGJvdGguCiAqLwojaWZkZWYgWl9BRERSRVNTX1NBTklUSVpFUgojaWZuZGVmIF9fY3BsdXNwbHVzCnZvaWQgX19hc2FuX2xvYWROKHZvaWQgKiwgbG9uZyk7CnZvaWQgX19hc2FuX3N0b3JlTih2b2lkICosIGxvbmcpOwojZW5kaWYKI2Vsc2UKIyAgZGVmaW5lIF9fYXNhbl9sb2FkTihhLCBzaXplKSBkbyB7IFpfVU5VU0VEKGEpOyBaX1VOVVNFRChzaXplKTsgfSB3aGlsZSAoMCkKIyAgIFxfX19fX19fX19fX18vCgogICBJdCBhbHNvIGhlbHBzIHRoYXQgU1JFX0NPREUgaXMgYWx3YXlzIGFuIHVuc2lnbmVkIHR5cGUuCiovCgovKiBEZWZpbmluZyB0aGlzIG9uZSBlbmFibGVzIHRyYWNpbmcgb2YgdGhlIHZhbGlkYXRvciAqLwojdW5kZWYgVlZFUkJPU0UKCi8qIFRyYWNlIG1hY3JvIGZvciB0aGUgdmFsaWRhdG9yICovCiNpZiBkZWZpbmVkKFZWRVJCT1NFKQojZGVmaW5lIFZUUkFDRSh2KSBwcmludGYgdgojZWxzZQojZGVmaW5lIFZUUkFDRSh2KSBkbyB7fSB3aGlsZSgwKSAgLyogZG8gbm90aGluZyAqLwojZW5kaWYKCi8qIFJlcG9ydCBmYWlsdXJlICovCiNkZWZpbmUgRkFJTCBkbyB7IFZUUkFDRSgoIkZBSUw6ICVkXG4iLCBfX0xJTkVfXykpOyByZXR1cm4gLTE7IH0gd2hpbGUgKDApCgovKiBFeHRyYWN0IG9wY29kZSwgYXJndW1lbnQsIG9yIHNraXAgY291bnQgZnJvbSBjb2RlIGFycmF5ICovCkFDRShjaCkpCiNkZWZpbmUgU1JFX0lTX0xJTkVCUkVBSyhjaClcCiAgICAoKGNoKSA9PSAnXG4nKQojZGVmaW5lIFNSRV9JU19XT1JEKGNoKVwKICAgICgoY2gpIDw9ICd6JyAmJiAoUHlfSVNBTE5VTShjaCkgfHwgKGNoKSA9PSAnXycpKQoKc3RhdGljIHVuc2lnbmVkIGludCBzcmVfbG93ZXJfYXNjaWkodW5zaWduZWQgaW50IGNoKQp7CiAgICByZXR1cm4gKChjaCkgPCAxMjggPyBQeV9UT0xPV0VSKGNoKSA6IGNoKTsKfQoKLyogbG9jYWxlLXNwZWNpZmljIGNoYXJhY3RlciBwcmVkaWNhdGVzICovCi8qICEoYyAmIH5OKSA9PSAoYyA8IE4rMSkgZm9yIGFueSB1bnNpZ25lZCBjLCB0aGlzIGF2b2lkcwogKiB3YXJuaW5ncyB3aGVuIGMncyB0eXBlIHN1cHBvcnRzIG9ubHkgbnVtYmVycyA8IE4rMSAqLwojZGVmaW5lIFNSRV9MT0NfSVNfQUxOVU0oY2gpICghKChjaCkgJiB+MjU1KSA/IHNyZV9pc2FsbnVtKChjaCkpIDogMCB0byBhdG9taWNhbGx5IGNsYWltIGEgc2VxdWVuY2Ugb2YgYGNvdW50YCBiaXRzIGluIGEgc2luZ2xlCi8vIGZpZWxkIGF0IGBpZHhgIGluIGBiaXRtYXBgLiBSZXR1cm5zIGB0cnVlYCBvbiBzdWNjZXNzLgpib29sIF9taV9iaXRtYXBfdHJ5X2ZpbmRfY2xhaW1fZmllbGQobWlfYml0bWFwX3QgYml0bWFwLCBzaXplX3QgaWR4LCBjb25zdCBzaXplX3QgY291bnQsIG1pX2JpdG1hcF9pbmRleF90KiBiaXRtYXBfaWR4KTsKCi8vIFN0YXJ0cyBhdCBpZHgsIGFuZCB3cmFwcyBhcm91bmQgdG8gc2VhcmNoIGluIGFsbCBgYml0bWFwX2ZpZWxkc2AgZmllbGRzLgovLyBGb3Igbm93LCBgY291bnRgIGNhbiBiZSBhdCBtb3N0IE1JX0JJVE1BUF9GSUVMRF9CSVRTIGFuZCB3aWxsIG5ldmVyIGNyb3NzIGZpZWxkcy4KYm9vbCBfbWlfYml0bWFwX3RyeV9maW5kX2Zyb21fY2xhaW0obWlfYml0bWFwX3QgYml0bWFwLCBjbWVudCIpOwogICAgICAgICAgICBQeUVycl9TeW50YXhMb2NhdGlvbk9iamVjdCh0b2stPmZpbGVuYW1lLCB0b2stPmxpbmVubywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rLT5pbnAgLSB0b2stPmJ1ZiA8IDAgPyAwIDogKGludCkodG9rLT5pbnAgLSB0b2stPmJ1ZikpOwogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgY2FzZSBFX0RFREVOVDoKICAgICAgICAgICAgbXNnID0gInVuaW5kZW50IGRvZXMgbm90IG1hdGNoIGFueSBvdXRlciBpbmRlbnRhdGlvbiBsZXZlbCI7CiAgICAgICAgICAgIGVycnR5cGUgPSBQeUV4Y19JbmRlbnRhdGlvbkVycm9yOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIEVfSU5UUjoKICAgICAgICAgICAgaWYgKCFQeUVycl9PY2N1cnJlZCgpKSB7CiAgICAgICAgICAgICAgICBQeUVycl9TZXROb25lKFB5RXhjX0tleWJvYXJkSW50ZXJydWN0IF9zaGFyZWRfcGlja2xlX2RhdGEgKnNoYXJlZCA9CiAgICAgICAgICAgIChzdHJ1Y3QgX3NoYXJlZF9waWNrbGVfZGF0YSAqKV9QeUJ5dGVzX0dldFhJRGF0YVdyYXBwZWQoCiAgICAgICAgICAgICAgICAgICAgdHN0YXRlLCBieXRlcywgc2l6ZSwgX1B5UGlja2xlX0xvYWRGcm9tWElEYXRhLCB4aWRhdGEpOwogICAgUHlfREVDUkVGKGJ5dGVzKTsKICAgIGlmIChzaGFyZWQgPT0gTlVMTCkgewogICAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICAvLyBJZiBpdCBtYXR0ZXJlZCwgd2UgY291bGQgc2tpcCBnZXR0aW5nIF9fbWFpbl9fLl9fZmlsZV9fCiAgICAvLyB3aGVuICJfX21haW5fXyIgZG9lc24ndCBzaG93IHVwIGluIHRoZSBwaWNrbGUgYnl0ZXMuCiAgICBpZiAoX3NldF9waWNrbGVfeGlkX2NvbnRleHQodHN0YXRlLCAmc2hhcmVkLT5jdHgpIDwgMCkgewogICAgICAgIF94aWRhdGFfY2xlYXIoeGlkYXR7MHgwMjU5MDMwMSwKMHgyYjRkfSx7MHgwMjVhMDAwMCwweDJiNDN9LHsweDAyNWEwMzAwLDB4MmI0ZX0sezB4MDI1YTAzMDEsMHgyYjRmfSx7CjB4MDI4YzAwMDAsMHgyYjM3fSx7MHgwMjhjMDMwMCwweDJiNGF9LHsweDAyOGMwMzAxLDB4MmI0Yn0sezB4MDJlNTAwMDAsMHgyYjYwCn0sezB4MDJlNTAyZTksMHgyYjY2fSx7MHgwMmU5MDAwMCwweDJiNjR9LHsweDAyZTkwMmU1LDB4MmI2NX0sezB4MzA0YjAwMDAsCjB4MjQyYn0sezB4MzA0YjMwOWEsMHgyNDc3fSx7MHgzMDRkMDAwMCwweDI0MmR9LHsweDMwNGQzMDlhLDB4MjQ3OH0sewoweDMwNGYwMDAwLDB4MjQyZn0sezB4MzA0ZjMwOWEsMHgyNDc5fSx7MHgzMDUxMDAwMCwweDI0MzF9LHsweDMwNTEzMDlhLDB4MjQ3YQp9LHsweDMwNTMwMDAwLDB4MjQzM30sezB4MzA1MzMwOWEsMHgyNDdifSx7MHgzMGFiMDAwMCwweDI1MmJ9LHsweDMwYWIzMDlhLAoweDI1Nzd9LHtudCkgX1B5T1NfVVJhbmRvbU5vbmJsb2NrKHZvaWQgKmJ1ZmZlciwgUHlfc3NpemVfdCBzaXplKTsKCi8qIExlZ2FjeSBsb2NhbGUgc3VwcG9ydCAqLwpleHRlcm4gaW50IF9QeV9Db2VyY2VMZWdhY3lMb2NhbGUoaW50IHdhcm4pOwpleHRlcm4gaW50IF9QeV9MZWdhY3lMb2NhbGVEZXRlY3RlZChpbnQgd2Fybik7CgovLyBFeHBvcnQgZm9yICdyZWFkbGluZScgc2hhcmVkIGV4dGVuc2lvbgpQeUFQSV9GVU5DKGNoYXIqKSBfUHlfU2V0TG9jYWxlRnJvbUVudihpbnQgY2F0ZWdvcnkpOwoKLy8gRXhwb3J0IGZvciBzcGVjaWFsIG1haW4uYyBzdHJpbmcgY29tcGlsaW5nIHdpdGggc291cmNlIHRyYWNlYmFja3MKaW50IF9QeVJ1bl9TaW1wbGVTdHJpbmdGbGFnc1dpdGhOYW1lKGNvbnN0IGNoYXIgKmNvbW1hbmQsIGNvbnN0IGNoYXIqIG5hbWUsIFB5Q29tcGlsZXJGbGFncyAqZmxhZ3MpOwoKCi8qIGludGVycHJldGVyIGNvbmYoY29va2llLCBTRUVLX1NFVCk6IFJlc3RvcmUgYSBwcmV2aW91cyBwb3NpdGlvbjtcbiIKIiAgXCdjb29raWVcJyBtdXN0IGJlIGEgbnVtYmVyIHJldHVybmVkIGJ5IHRlbGwoKS5cbiIKIi0gc2VlaygwLCBTRUVLX0VORCk6IEZhc3QtZm9yd2FyZCB0byB0aGUgZW5kIG9mIHRoZSBzdHJlYW0uXG4iCiItIHNlZWsoMCwgU0VFS19DVVIpOiBMZWF2ZSB0aGUgY3VycmVudCBzdHJlYW0gcG9zaXRpb24gdW5jaGFuZ2VkLlxuIgoiXG4iCiJBbnkgb3RoZXIgYXJndW1lbnQgY29tYmluYXRpb25zIGFyZSBpbnZhbGlkLFxuIgoiYW5kIG1heSByYWlzZSBleGNlcHRpb25zLiIpOwoKI2RlZmluZSBfSU9fVEVYVElPV1JBUFBFUl9TRUVLX01FVEhPRERFRiAgICBcCiAgICB7InNlZWsiLCBfUHlDRnVuY3Rpb25fQ0FTVChfaW9fVGV4dElPV3JhcHBlcl9zZWVrKSwgTUVUSF9GQVNUQ0FMTCwgX2lvX1RleHRJT1dyYXBwZXJfc2Vla19fZG9faXRlcmF0b3JfX19zZXRzdGF0ZV9fX2ltcGwobG9uZ3JhbmdlaXRlcm9iamVjdCAqciwgUHlPYmplY3QgKnN0YXRlKQovKltjbGluaWMgZW5kIGdlbmVyYXRlZCBjb2RlOiBvdXRwdXQ9ODcwNzg3ZjA1NzRmMGRhNCBpbnB1dD04YjExNmRlMzAxOGRlODI0XSovCnsKICAgIGlmICghUHlMb25nX0NoZWNrRXhhY3Qoc3RhdGUpKSB7CiAgICAgICAgUHlFcnJfRm9ybWF0KFB5RXhjX1R5cGVFcnJvciwgInN0YXRlIG11c3QgYmUgYW4gaW50LCBub3QgJVQiLCBzdGF0ZSk7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CgogICAgUHlPYmplY3QgKnplcm8gPSBfUHlMb25nX0dldFplcm8oKTsgIC8vIGJvcnJvd2VkIHJlZmVyZW5jZQogICAgaW50IGNtcDsKCiAgICAvKiBjbGlwIHRoZSB2YWx1ZSAqLwogICAgY21wID0gUHlPYmplY3RfUmljaENvbXBhcmVCb29sKHN0YXRlLCB6ZXJvLCBQeV9MVCk7CiAgICBpZiAoY21wIDwgMCluIgoiQnkgZGVmYXVsdCwgdGhlIGZyYWN0aW9uYWwgcGFydCBpcyBvbWl0dGVkIGlmIHNlbGYubWljcm9zZWNvbmQgPT0gMC5cbiIKIlxuIgoiSWYgc2VsZi50emluZm8gaXMgbm90IE5vbmUsIHRoZSBVVEMgb2Zmc2V0IGlzIGFsc28gYXR0YWNoZWQsIGdpdmluZ1xuIgoiYSBmdWxsIGZvcm1hdCBvZiBcJ1lZWVktTU0tREQgSEg6TU06U1MubW1tbW1tK0hIOk1NXCcuXG4iCiJcbiIKIk9wdGlvbmFsIGFyZ3VtZW50IHNlcCBzcGVjaWZpZXMgdGhlIHNlcGFyYXRvciBiZXR3ZWVuIGRhdGUgYW5kXG4iCiJ0aW1lLCBkZWZhdWx0IFwnVFwnLlxuIgoiXG4iCiJUaGUgb3B0aW9uYWwgYXJndW1lbnQgdGltZXNwZWMgc3BlY2lmaWVzIHRoZSBudW1iZXIgb2YgYWRkaXRpb25hbFxuIgoidGVybXMgb2YgdGhlIHRpbWUgdG8gaW5jbHVkZS4gVmFsaWQgb3B0aW9ucyBhcmUgXCdhdXRvXCcsIFwnaG91cnNcJyxcbiIKIlwnbWludXRlc1x1ZSA9IGRhdGV0aW1lX2RhdGVfZnJvbWlzb2NhbGVuZGFyX2ltcGwoKFB5VHlwZU9iamVjdCAqKXR5cGUsIHllYXIsIHdlZWssIGRheSk7CgpleGl0OgogICAgcmV0dXJuIHJldHVybl92YWx1ZTsKfQoKUHlEb2NfU1RSVkFSKGRhdGV0aW1lX2RhdGVfc3RycHRpbWVfX2RvY19fLAoic3RycHRpbWUoJHR5cGUsIHN0cmluZywgZm9ybWF0LCAvKVxuIgoiLS1cbiIKIlxuIgoiUGFyc2Ugc3RyaW5nIGFjY29yZGluZyB0byB0aGUgZ2l2ZW4gZGF0ZSBmb3JtYXQgKGxpa2UgdGltZS5zdHJwdGltZSgpKS5cbiIKIlxuIgoiRm9yIGEgbGlzdCBvZiBzdXBwb3J0ZWQgZm9ybWF0IGNvZGVzLCBzZWUgdGhlIGRvY3VtZW50YXRpb246XG4iCiIgICAgaHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMy9saWJyYXJ5L2RhdGV0aW1lLmh0bWwjZm9ybWF0LWNvZGVzIik7CgojZGVmaW5lIERBVEVUSU1FX0RBVEVfU1RSUFRJTUVfTUU2NF90IHhueCA9IHhfb3JfbWludXNfeCA+PiA2M1U7CiAgcmV0dXJuIHhueCAtIDFVTEw7Cn0KCnN0YXRpYyBLUk1MX05PSU5MSU5FIHVpbnQ2NF90IEZTdGFyX1VJbnQ2NF9ndGVfbWFzayh1aW50NjRfdCBhLCB1aW50NjRfdCBiKQp7CiAgdWludDY0X3QgeCA9IGE7CiAgdWludDY0X3QgeSA9IGI7CiAgdWludDY0X3QgeF94b3JfeSA9IHggXiB5OwogIHVpbnQ2NF90IHhfc3ViX3kgPSB4IC0geTsKICB1aW50NjRfdCB4X3N1Yl95X3hvcl95ID0geF9zdWJfeSBeIHk7CiAgdWludDY0X3QgcSA9IHhfeG9yX3kgfCB4X3N1Yl95X3hvcl95OwogIHVpbnQ2NF90IHhfeG9yX3EgPSB4IF4gcTsKICB1aW50NjRfdCB4X3hvcl9xXyA9IHhfeG9yX3EgPj4gNjNVOwogIHJldHVybiB4X3hvcl9xXyAtIDFVTEw7Cn0KCmV4dGVybiBQcmltc19zdHJpbmcgRlN0YXJfVUludDY0X3RvX3N0cmluZyh1aW50NjRfdCB1dV9fXyk7CgplRVRFUl9TVEFURSBzaXplb2YoUHlJbnRlcnByZXRlclN0YXRlKQoKLyogTWF4aW11bSBzaXplcyBmb3IgdmFsaWRhdGlvbiB0byBwcmV2ZW50IGJ1ZmZlciBvdmVyZmxvd3MgZnJvbSBjb3JydXB0ZWQgZGF0YSAqLwojZGVmaW5lIE1BWF9TVEFDS19DSFVOS19TSVpFICgxNiAqIDEwMjQgKiAxMDI0KSAgLyogMTYgTUIgbWF4IGZvciBzdGFjayBjaHVua3MgKi8KI2RlZmluZSBNQVhfTE9OR19ESUdJVFMgNjQgIC8qIEFsbG93cyB2YWx1ZXMgdXAgdG8gfjJeMTkyMCAqLwojZGVmaW5lIE1BWF9TRVRfVEFCTEVfU0laRSAoMSA8PCAyMCkgIC8qIDEgbWlsbGlvbiBlbnRyaWVzIG1heCBmb3Igc2V0IGl0ZXJhdGlvbiAqLwoKI2lmbmRlZiBNQVgKI2RlZmluZSBNQVgoYSwgYikgKChhKSA+IChiKSA/IChhKSA6IChiKSkKI2VuZGlmCgojaWZkZWYgUHlfR0lMX0RJU0FCTEVECiNkZWZpbmUgSU5URVJQX1NUQVRFX01JTl9TSVpFIE1BIHRoZSBSU1MgaW5jcmVhc2UgY29uZGl0aW9uIG5vdCBiZWluZyBtZWV0LiAgUmVzZXQgb24gY29sbGVjdGlvbi4gKi8KICAgIFB5X3NzaXplX3QgZGVmZXJyZWRfY291bnQ7CgogICAgLyogTXV0ZXggaGVsZCBmb3IgZ2Nfc2hvdWxkX2NvbGxlY3RfbWVtX3VzYWdlKCkuICovCiAgICBQeU11dGV4IG11dGV4OwojZW5kaWYKfTsKCiNpbmNsdWRlICJweWNvcmVfZ2lsLmgiICAgICAgICAgICAvLyBzdHJ1Y3QgX2dpbF9ydW50aW1lX3N0YXRlCgovKioqKiBJbXBvcnQgKioqKioqKiovCgpzdHJ1Y3QgX2ltcG9ydF9ydW50aW1lX3N0YXRlIHsKICAgIC8qIFRoZSBidWlsdGluIG1vZHVsZXMgKGRlZmluZWQgaW4gY29uZmlnLmMpLiAqLwogICAgc3RydWN0IF9pbml0dGFiICppbml0dGFiOwogICAgLyogVGhlIG1vc3QgcmVjZW50IHZhbHVlIGFzc2lnbmVkIHRvIGEgUHlNb2R1bGVEZWYubV9iYXNlLm1faW5kZXguCiAgIGhlciB0YXNrcy5cbiIKIlxuIgoiRm9yIGVhY2ggdGFzaywgcmV0dXJuczpcbiIKIjEuIFRoZSBjYWxsIHN0YWNrIGZyYW1lcyBsZWFkaW5nIHRvIHdoZXJlIHRoZSB0YXNrIGlzIGN1cnJlbnRseSBleGVjdXRpbmdcbiIKIjIuIFRoZSBuYW1lIG9mIHRoZSB0YXNrXG4iCiIzLiBBIGxpc3Qgb2YgdGFza3MgdGhhdCB0aGlzIHRhc2sgaXMgd2FpdGluZyBmb3IsIHdpdGggdGhlaXIgb3duIGZyYW1lcy9uYW1lcy9ldGNcbiIKIlxuIgoiUmV0dXJucyBhIGxpc3Qgb2YgW2ZyYW1lcywgdGFza19uYW1lLCBzdWJ0YXNrc10gd2hlcmU6XG4iCiItIGZyYW1lczogTGlzdCBvZiAoZnVuY19uYW1lLCBmaWxlbmFtZSwgbGluZW5vKSBzaG93aW5nIHRoZSBjYWxsIHN0YWNrXG4iCiItIHRhc2tfbmFtZTogU3RyaW5nIGlkZW50aWZpZXIgZm9yIHRoZSB0YXNrXG4iCiItIHN1YnRhc2tzOiBMaXN0IG9mIHRhc2tzIGJlaW5nIGF3YWl0ZWQgYnRvcnMgYW5kIGRlbm9taW5hdG9yIGJ5IHdoaWNoZXZlciBvZiB7Yi5yZWFsLCBiLmltYWd9IGhhcwogICAgICogbGFyZ2VyIG1hZ25pdHVkZS4gIFRoZSBlYXJsaWVzdCByZWZlcmVuY2UgSSBmb3VuZCB3YXMgdG8gQ0FDTQogICAgICogQWxnb3JpdGhtIDExNiAoQ29tcGxleCBEaXZpc2lvbiwgUm9iZXJ0IEwuIFNtaXRoLCBTdGFuZm9yZAogICAgICogVW5pdmVyc2l0eSkuCiAgICAgKi8KICAgICBQeV9jb21wbGV4IHI7ICAgICAgLyogdGhlIHJlc3VsdCAqLwogICAgIGNvbnN0IGRvdWJsZSBhYnNfYnJlYWwgPSBiLnJlYWwgPCAwID8gLWIucmVhbCA6IGIucmVhbDsKICAgICBjb25zdCBkb3VibGUgYWJzX2JpbWFnID0gYi5pbWFnIDwgMCA/IC1iLmltYWcgOiBiLmltYWc7CgogICAgaWYgKGFic19icmVhbCA+PSBhYnNfYmltYWcpIHsKICAgICAgICAvKiBkaXZpZGUgdG9wcyBhbmQgYm90dG9tIGJ5IGIucmVhbCAqLwogeCA9IGkgPiAzMiAgPyB3b3JkMCgmdSkgPDwgKDY0IC0gaSkgfCB3b3JkMSgmdSkgPj4gKGkgLSAzMikKICAgICAgICAgICAgOiB3b3JkMSgmdSkgPDwgKDMyIC0gaSk7CiAgICAgICAgZHZhbCgmZDIpID0geDsKICAgICAgICB3b3JkMCgmZDIpIC09IDMxKkV4cF9tc2sxOyAvKiBhZGp1c3QgZXhwb25lbnQgKi8KICAgICAgICBpIC09IChCaWFzICsgKFAtMSkgLSAxKSArIDE7CiAgICAgICAgZGVub3JtID0gMTsKICAgIH0KICAgIGRzID0gKGR2YWwoJmQyKS0xLjUpKjAuMjg5NTI5NjU0NjAyMTY4ICsgMC4xNzYwOTEyNTkwNTU4ICsKICAgICAgICBpKjAuMzAxMDI5OTk1NjYzOTgxOwogICAgayA9IChpbnQpZHM7CiAgICBpZiAoZHMgPCAwLiAmJiBkcyAhPSBrKQogICAgICAgIGstLTsgICAgLyogd2FudCBrID0gZmxvb3IoZHMpICovCiAgICBrX2NoZWNrID0gMTsKICAgIGlmIChrID49IDAgJiYgayA8PSBUZW5fcG1heClQX0lGX0ZBTFNFIGFuZCBQT1BfSlVNUF9JRl9UUlVFCiAgICAgICAgICAgICAgICAgICAgICAgICAgIzQ3MTUpCiAgICBQeXRob24gMy4yYTE6IDMxNjAgKGFkZCBTRVRVUF9XSVRIICM2MTAxKQogICAgUHl0aG9uIDMuMmEyOiAzMTcwIChhZGQgRFVQX1RPUF9UV08sIHJlbW92ZSBEVVBfVE9QWCBhbmQgUk9UX0ZPVVIgIzkyMjUpCiAgICBQeXRob24gMy4yYTMgIDMxODAgKGFkZCBERUxFVEVfREVSRUYgIzQ2MTcpCiAgICBQeXRob24gMy4zYTEgIDMxOTAgKF9fY2xhc3NfXyBzdXBlciBjbG9zdXJlIGNoYW5nZWQpCiAgICBQeXRob24gMy4zYTEgIDMyMDAgKFBFUCAzMTU1IF9fcXVhbG5hbWVfXyBhZGRlZCAjMTM0NDgpCiAgICBQeXRob24gMy4zYTEgIDMyMTAgKGFkZGVkIHNpemUgbW9kdWxvIDIqKjMyIHRvIHRoZSBweWMgaGVhZGVyICMxMzY0NSkKICAgIFB5dGhvbiAzLjNhMiAgMzIyMCAoY2hhbmdlZCBQRVAgMzgwIGkpOwogIGRvIHsKICAgIGhlYWQgPSBtaV90Zl9ibG9jayh0ZnJlZSk7CiAgICB0ZnJlZXggPSBtaV90Zl9zZXRfYmxvY2sodGZyZWUsTlVMTCk7CiAgfSB3aGlsZSAoIW1pX2F0b21pY19jYXNfd2Vha19hY3FfcmVsKCZwYWdlLT54dGhyZWFkX2ZyZWUsICZ0ZnJlZSwgdGZyZWV4KSk7CgogIC8vIHJldHVybiBpZiB0aGUgbGlzdCBpcyBlbXB0eQogIGlmIChoZWFkID09IE5VTEwpIHJldHVybjsKCiAgLy8gZmluZCB0aGUgdGFpbCAtLSBhbHNvIHRvIGdldCBhIHByb3BlciBjb3VudCAod2l0aG91dCBkYXRhIHJhY2VzKQogIHVpbnQzMl90IG1heF9jb3VudCA9IHBhZ2UtPmNhcGFjaXR5OyAvLyBjYW5ub3QgY29sbGVjdCBtb3JlIHRoYW4gY2FwYWNpdHkKICB1aW50MzJfdCBjb3VudCA9IDE7CiAgbWlfYmxvY2tfdCogdGFpbCA9IGhlYWQ7CiAgbWlfYmxvY2tfdCogbmV4dDsKICB3aGlsZSAoKG5leHQgPSBtaV9ibG9ja19uZXhsZXNzIHJlc3VsdCBpcyBzdWJub3JtYWwuICovCiAgICBsc2IgPSBQeV9NQVgodG9wX2V4cCwgKGxvbmcpREJMX01JTl9FWFApIC0gREJMX01BTlRfRElHOwoKICAgIHggPSAwLjA7CiAgICBpZiAoZXhwID49IGxzYikgewogICAgICAgIC8qIG5vIHJvdW5kaW5nIHJlcXVpcmVkICovCiAgICAgICAgZm9yIChpID0gbmRpZ2l0cy0xOyBpID49IDA7IGktLSkKICAgICAgICAgICAgeCA9IDE2LjAqeCArIEhFWF9ESUdJVChpKTsKICAgICAgICB4ID0gbGRleHAoeCwgKGludCkoZXhwKSk7CiAgICAgICAgZ290byBmaW5pc2hlZDsKICAgIH0KICAgIC8qIHJvdW5kaW5nIHJlcXVpcmVkLiAga2V5X2RpZ2l0IGlzIHRoZSBpbmRleCBvZiB0aGUgaGV4IGRpZ2l0CiAgICAgICBjb250YWluaW5nIHRoZSBmaXJzdCBiaXQgdG8gYmUgcm91bmRlZCBhd2F5LiAqLwogICAgaGFsZl9lcHMgPSAxIDw8IChpbnQpKChsc2IgLSBleHAgLSAxKV9CSVQgKDFVIDw8IDMpCiNkZWZpbmUgX1BZX0dDX1NDSEVEVUxFRF9CSVQgKDFVIDw8IDQpCiNkZWZpbmUgX1BZX0VWQUxfUExFQVNFX1NUT1BfQklUICgxVSA8PCA1KQojZGVmaW5lIF9QWV9FVkFMX0VYUExJQ0lUX01FUkdFX0JJVCAoMVUgPDwgNikKI2RlZmluZSBfUFlfRVZBTF9KSVRfSU5WQUxJREFURV9DT0xEX0JJVCAoMVUgPDwgNykKCi8qIFJlc2VydmUgYSBmZXcgYml0cyBmb3IgZnV0dXJlIHVzZSAqLwojZGVmaW5lIF9QWV9FVkFMX0VWRU5UU19CSVRTIDgKI2RlZmluZSBfUFlfRVZBTF9FVkVOVFNfTUFTSyAoKDEgPDwgX1BZX0VWQUxfRVZFTlRTX0JJVFMpLTEpCgpzdGF0aWMgaW5saW5lIHZvaWQKX1B5X3NldF9ldmFsX2JyZWFrZXJfYml0KFB5VGhyZWFkU3RhdGUgKnRzdGF0ZSwgdWludHB0cl90IGJpdCkKewogICAgX1B5X2F0b21pY19vcl91aW50cHRyKCZ0c3RhdGUtPmV2YWxfYnJlYWtlciwgYml0KTsKfSpzdGVwLCBQeV9zc2l6ZV90ICpzbGljZWxlbikKewogICAgaWYgKFB5U2xpY2VfVW5wYWNrKGl0ZW0sIHN0YXJ0LCBzdG9wLCBzdGVwKSA8IDApIHsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CiAgICBpbnQgbGVuID0gc3FsaXRlM19ibG9iX2J5dGVzKHNlbGYtPmJsb2IpOwogICAgKnNsaWNlbGVuID0gUHlTbGljZV9BZGp1c3RJbmRpY2VzKGxlbiwgc3RhcnQsIHN0b3AsICpzdGVwKTsKICAgIHJldHVybiAwOwp9CgpzdGF0aWMgUHlPYmplY3QgKgpzdWJzY3JpcHRfc2xpY2UocHlzcWxpdGVfQmxvYiAqc2VsZiwgUHlPYmplY3QgKml0ZW0pCnsKICAgIFB5X3NzaXplX3Qgc3RhcnQsIHN0b3AsIHN0ZXAsIGxlbjsKICAgIGlmIChnZXRfc2xpY2VfaW5mbyhzZWxmLCBpdGVtLCAmc3RhcnQsICZzdG9wLCAmc3RlcCwgJmxlbikgPCAwKSB7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CgogICAgaWYgKHN0ZXAgPT0gMSArIGssIHdoZXJlIGsgPj0gbWlue3QgPj0gMSB8IDE2XnQgPiBjaH0KICAgIC8vIGFuZCB3aWxsIGJlIGZvcm1hdHRlZCBhcyAiXFwiICsgKCdVJ3wndSd8J3gnKSArIEhFWERJR0lUUywKICAgIC8vIHdoZXJlIHRoZSBudW1iZXIgb2YgaGV4ZGlnaXRzIGlzIGVpdGhlciAyLCA0LCBvciA4IChub3QgNikuCiAgICAvLyBTaW5jZSB0aGUgVW5pY29kZSByYW5nZSBpcyBiZWxvdyAxMF43LCB3ZSBjaG9vc2UgayA9IDggd2hlbmNlCiAgICAvLyBlYWNoICJibG9jayIgcmVxdWlyZXMgYXQgbW9zdCAxICsgMSArIDggY2hhcmFjdGVycy4KICAgIGlmIChzbGVuID4gUFlfU1NJWkVfVF9NQVggLyAoMSArIDEgKyA4KSkgewogICAgICAgIGVuZCA9IHN0YXJ0ICsgUFlfU1NJWkVfVF9NQVggLyAoMSArIDEgKyA4KTsKICAgICAgICBlbmQgPSBQeV9NSU4oZW5kLCBvYmpsZW4pOwogICAgICAgIHNsZW4gPSBQeV9NQVgoMCwgZW5kIC0gcyBvdXIgaG9vayBmdW5jdGlvbnMgKi8KICAgIHJsX3N0YXJ0dXBfaG9vayA9IG9uX3N0YXJ0dXBfaG9vazsKI2lmZGVmIEhBVkVfUkxfUFJFX0lOUFVUX0hPT0sKICAgIHJsX3ByZV9pbnB1dF9ob29rID0gb25fcHJlX2lucHV0X2hvb2s7CiNlbmRpZgogICAgLyogU2V0IG91ciBjb21wbGV0aW9uIGZ1bmN0aW9uICovCiAgICBybF9hdHRlbXB0ZWRfY29tcGxldGlvbl9mdW5jdGlvbiA9IGZsZXhfY29tcGxldGU7CiAgICAvKiBTZXQgUHl0aG9uIHdvcmQgYnJlYWsgY2hhcmFjdGVycyAqLwogICAgY29tcGxldGVyX3dvcmRfYnJlYWtfY2hhcmFjdGVycyA9CiAgICAgICAgc3RyZHVwKCIgXHRcbmB+IUAjJCVeJiooKS09K1t7XX1cXHw7OidcIiw8Pi8/Iik7CiAgICAgICAgLyogQWxsIG5vbmFscGhhbnVtcyBleGNlcHQgJy4nICovCiNpZmRlZiBXSVRIX0VESVRMSU5FCiAgICAvLyBsaWJlZGl0IHVzZXMgcmxfYmFzaWNfd29yZFRJT05fQlJFQUtQT0lOVCkKICAgIHsKICAgICAgICBleGNlcHRpb25Db3VudCsrOwogICAgICAgIC8vIHByZXBhcmUgY29udGV4dCB0byByZXN1bWUgZXhlY3V0aW9uCiAgICAgICAgQ09OVEVYVCAqYyA9IEV4Y2VwdGlvbkluZm8tPkNvbnRleHRSZWNvcmQ7CiNpZmRlZiBfQU1ENjRfCiAgICAgICAgYy0+UmlwID0gKihEV09SRDY0ICopYy0+UnNwOwogICAgICAgIGMtPlJzcCArPSA4OwojZWxpZiBkZWZpbmVkKF9YODZfKQogICAgICAgIGMtPkVpcCA9ICooRFdPUkQgKiljLT5Fc3A7CiAgICAgICAgYy0+RXNwICs9IDQ7CiNlbHNlCiAgICAgICAgYy0+UGMgPSBjLT5McjsKI2VuZGlmCiNpZmRlZiBfQVJNNjRfCiAgICAgICAgLy8gVE9ETzogcmVtb3ZlIHdoZW4gd2luZG93cy9hcm02NCBzdXBwb3J0cyBTRUggc3RhY2sgdW53aW5kaW5nLgogICAgICAgIHJldHVybiBFWENFUFRJT05fQ09OVElOVUVfRVhFQ1VUSU9OOwojZUVfSEFORExFUjsKICAgIH0KICAgIHJldHVybiBFWENFUFRJT05fQ09OVElOVUVfU0VBUkNIOwp9CgpzdGF0aWMgRFdPUkQKZmlsdGVyX3BhZ2VfZXhjZXB0aW9uX21ldGhvZChtbWFwX29iamVjdCAqc2VsZiwgRVhDRVBUSU9OX1BPSU5URVJTICpwdHJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIEVYQ0VQVElPTl9SRUNPUkQgKnJlY29yZCkKewogICAgKnJlY29yZCA9ICpwdHJzLT5FeGNlcHRpb25SZWNvcmQ7CiAgICBpZiAocmVjb3JkLT5FeGNlcHRpb25Db2RlID09IEVYQ0VQVElPTl9JTl9QQUdFX0VSUk9SIHx8CiAgICAgICAgcmVjb3JkLT5FeGNlcHRpb25Db2RlID09IEVYQ0VQVElPTl9BQ0NFU1NfVklPTEFUSU9OKQogICAgewoKICAgICAgICBVTE9OR19QVFIgYWRkcmVzcyA9IHJlY29yZC0+RXhjZXB0aW9uSW5mb3JtYXRpb25bMV07CiAgICAgICAgaWYgKGFkZHJlc3MgPj0gKFVMT05HX1BUUikgc2VsZnRoZSBNUyBXaW4zMiAoYW5kIFdpbjY0KSBBUEkgKG9ic29sZXRlLCB0aGlzIGNvdmVycyBhbGwgc3VwcG9ydGVkIEFQSXMpCk1TX1dJTkRPV1MgLSBDb2RlIHNwZWNpZmljIHRvIFdpbmRvd3MsIGJ1dCBhbGwgdmVyc2lvbnMuClB5X0VOQUJMRV9TSEFSRUQgLSBDb2RlIGlmIHRoZSBQeXRob24gY29yZSBpcyBidWlsdCBhcyBhIERMTC4KCkFsc28gbm90ZSB0aGF0IG5laXRoZXIgIl9NX0lYODYiIG9yICJfTVNDX1ZFUiIgc2hvdWxkIGJlIHVzZWQgZm9yCmFueSBwdXJwb3NlIG90aGVyIHRoYW4gIldpbmRvd3MgSW50ZWwgeDg2IHNwZWNpZmljIiBhbmQgIk1pY3Jvc29mdApjb21waWxlciBzcGVjaWZpYyIuICBUaGVyZWZvcmUsIHRoZXNlIHNob3VsZCBiZSB2ZXJ5IHJhcmUuCgoKTk9URTogVGhlIGZvbGxvd2luZyBzeW1ib2xzIGFyZSBkZXByZWNhdGVkOgpOVCwgVVNFX0RMX0VYUE9SVCwgVVNFX0RMX0lNUE9SVCwgRExfRWp1cmUvY2xvanVyZS9ibG9iL21hc3Rlci9zcmMvanZtL2Nsb2p1cmUvbGFuZy9QZXJzaXN0ZW50SGFzaE1hcC5qYXZhCgoKRGVidWcKPT09PT0KClRoZSBIQU1UIGRhdGF0eXBlIGlzIGFjY2Vzc2libGUgZm9yIHRlc3RpbmcgcHVycG9zZXMgdW5kZXIgdGhlCmBfdGVzdGludGVybmFsY2FwaWAgbW9kdWxlOgoKICAgID4+PiBmcm9tIF90ZXN0aW50ZXJuYWxjYXBpIGltcG9ydCBoYW10CiAgICA+Pj4gaCA9IGhhbXQoKQogICAgPj4+IGgyID0gaC5zZXQoJ2EnLCAyKQogICAgPj4+IGgzID0gaDIuc2V0KCdiJywgMykKICAgID4+PiBsaXN0KGgzKQogICAgWydhJywgJ2InXQoKV2hlbiBDUHl0aG9uIGlzIGJ1aWx0IGluIGRlYnVnIG1vZGUsIGEgJ19fZHVtcF9fKCknIG1ldGhvZCBpcyBhdmFpbGFibGUKdG8gaW50cm9zcGVjdCB0aGUgdHJlZToKCiAgICA+Pj4gcHJpbnQoaDMuX19kdW1wX18oKSkKICAgIEhBTVQobGVuPTIpOnMgKyBuYXJncyAtIHB0b19waGNvdW50OwogICAgUHlfc3NpemVfdCB0b3Rfbmt3ZHMgPSBwdG9fbmt3ZHMgKyBua3dkczsKICAgIFB5X3NzaXplX3QgdG90X25hcmdza3cgPSB0b3RfbmFyZ3MgKyB0b3Rfbmt3ZHM7CgogICAgUHlPYmplY3QgKnB0b19rd19tZXJnZWQgPSBOVUxMOyAgLy8gcHRvX2t3IHdpdGggZHVwbGljYXRlcyBtZXJnZWQgKGlmIGFueSkKICAgIFB5T2JqZWN0ICp0b3Rfa3duYW1lczsKCiAgICAvKiBBbGxvY2F0ZSBTdGFjawogICAgICogTm90ZSwgX1BZX0ZBU1RDQUxMX1NNQUxMX1NUQUNLIGlzIG9wdGltYWwgZm9yIHBvc2l0aW9uYWwgb25seQogICAgICogVGhpcyBjYXNlIG1pZ2h0IGhhdmUga2V5d29yZCBhcmd1bWVudHMKICAgICAqICBmdXJ0aGVybW9yZSwgaXQgbWlnaHQgdXNlIGV4dHJhIHN0YWNrIHNwYWNlIGZvciB0ZW1wb3Jhcnkga2V5IHN0b3JhZ2UKICAgICAqICB0aHVzLCBkb3VibGUgc3QgKgpfaW9fX0J1ZmZlcmVkX3NlZWtfaW1wbChidWZmZXJlZCAqc2VsZiwgUHlPYmplY3QgKnRhcmdldG9iaiwgaW50IHdoZW5jZSkKLypbY2xpbmljIGVuZCBnZW5lcmF0ZWQgY29kZTogb3V0cHV0PTdhZTBlOGRjNDZlZmRlZmIgaW5wdXQ9YjVhMTJiZTcwZTBhZDA3Yl0qLwp7CiAgICBQeV9vZmZfdCB0YXJnZXQsIG47CiAgICBQeU9iamVjdCAqcmVzID0gTlVMTDsKCiAgICBDSEVDS19JTklUSUFMSVpFRChzZWxmKQoKICAgIC8qIERvIHNvbWUgZXJyb3IgY2hlY2tpbmcgaW5zdGVhZCBvZiB0cnVzdGluZyBPUyAnc2VlaygpJwogICAgKiogZXJyb3IgZGV0ZWN0aW9uLCBqdXN0IGluIGNhc2UuCiAgICAqLwogICAgaWYgKCh3aGVuY2UgPCAwIHx8IHdoZW5jZSA+MikKI2lmZGVmIFNFRUtfSE9MRQogICAgICAgICYmICh3aGVuY2UgIT0gU0VFS19IT0xFKQojZW5kaWYKI2lmZGVmIFNFRUtfREFUQQogICAgYnVnSG9va3Modm9pZCk7CmludAp3aW5lcnJvcl90b19lcnJubyhpbnQgd2luZXJyb3IpCnsKICAgIC8vIFVud3JhcCBGQUNJTElUWV9XSU4zMiBIUkVTVUxUIGVycm9ycy4KICAgIGlmICgod2luZXJyb3IgJiAweEZGRkYwMDAwKSA9PSAweDgwMDcwMDAwKSB7CiAgICAgICAgd2luZXJyb3IgJj0gMHgwMDAwRkZGRjsKICAgIH0KCiAgICAvLyBXaW5zb2NrIGVycm9yIGNvZGVzICgxMDAwMC0xMTk5OSkgYXJlIGVycm5vIHZhbHVlcy4KICAgIGlmICh3aW5lcnJvciA+PSAxMDAwMCAmJiB3aW5lcnJvciA8IDEyMDAwKSB7CiAgICAgICAgc3dpdGNoICh3aW5lcnJvcikgewogICAgICAgIGNhc2UgV1NBRUlOVFI6CiAgICAgICAgY2FzZSBXU0FFQkFERjoKICAgICAgICBjYXNlIFdTQUVBQ0NFUzoKICAgICAgICBjYXNlIFdTQUVGQVVMVDoKICAgICAgICBjYXNlIFdTQUVJTlZBTDoKICAgICAgICBjYXNlIFdTQUVNRklMRToKICAgMCB8fCAhc291cmNlX2xpbmUpIHsKICAgICAgICAvKiBpZ25vcmUgZXJyb3JzIHNpbmNlIHdlIGNhbid0IHJlcG9ydCB0aGVtLCBjYW4gd2U/ICovCiAgICAgICAgZXJyID0gaWdub3JlX3NvdXJjZV9lcnJvcnMoKTsKICAgIH0KICAgIFB5X1hERUNSRUYoc291cmNlX2xpbmUpOwogICAgcmV0dXJuIGVycjsKfQoKc3RhdGljIGNvbnN0IGludCBUQl9SRUNVUlNJVkVfQ1VUT0ZGID0gMzsgLy8gQWxzbyBoYXJkY29kZWQgaW4gdHJhY2ViYWNrLnB5LgoKc3RhdGljIGludAp0Yl9wcmludF9saW5lX3JlcGVhdGVkKFB5T2JqZWN0ICpmLCBsb25nIGNudCkKewogICAgY250IC09IFRCX1JFQ1VSU0lWRV9DVVRPRkY7CiAgICBQeU9iamVjdCAqbGluZSA9IFB5VW5pY29kZV9Gcm9tRm9ybWF0KAogICAgICAgIChjbnQgPiAxKQogICAgICAgICAgPyAiICBbUHJldmlvdXMgbGluZSByZXBlYXRlZCAlbGQgbW9yZSB0aW1lc11cbiIKIGx1ZXNbaV0gPSBzeW1fdHVwbGVfZ2V0aXRlbShjdHgsIHNlcSwgb3BhcmcgLSBpIC0gMSk7CiAgICAgICAgfQogICAgfQoKICAgIG9wKF9DQUxMX1RVUExFXzEsIChjYWxsYWJsZSwgbnVsbCwgYXJnIC0tIHJlcywgYSkpIHsKICAgICAgICBpZiAoc3ltX21hdGNoZXNfdHlwZShhcmcsICZQeVR1cGxlX1R5cGUpKSB7CiAgICAgICAgICAgIC8vIGUuZy4gdHVwbGUoKDEsIDIpKSBvciB0dXBsZShmb28pIHdoZXJlIGZvbyBpcyBrbm93biB0byBiZSBhIHR1cGxlCiAgICAgICAgICAgIC8vIE5vdGU6IHdlIG11c3Qgc3RyaXAgdGhlIHJlZmVyZW5jZSBpbmZvcm1hdGlvbiBiZWNhdXNlIGl0IGdvZXMKICAgICAgICAgICAgLy8gdGhyb3VnaCB0dXBsZSgpIHdoaWNoIHN0cmlwcyB0aGUgcmVmZXJlbmNlIGluZm9ybWF0aW9uIGZyb20gaXQuCiAgICAgICAgICAgIHJlcyA9IFB5Sml0UmVmX1N0cmlwUmVmZXJlbmNlSW5mbyhhcmcpZiBNSV9IVUdFX1BBR0VfQUJBTkRPTgogIG1pX2Fzc2VydF9pbnRlcm5hbChfbWlfcGFnZV9zZWdtZW50KHBhZ2UpLT5raW5kICE9IE1JX1NFR01FTlRfSFVHRSk7CiAgI2VuZGlmCiAgbWlfYXNzZXJ0X2ludGVybmFsKHBhZ2UtPnhibG9ja19zaXplID09IHF1ZXVlLT5ibG9ja19zaXplIHx8CiAgICAgICAgICAgICAgICAgICAgICAocGFnZS0+eGJsb2NrX3NpemUgPiBNSV9NRURJVU1fT0JKX1NJWkVfTUFYKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAobWlfcGFnZV9pc19pbl9mdWxsKHBhZ2UpICYmIG1pX3BhZ2VfcXVldWVfaXNfZnVsbChxdWV1ZSkpKTsKCiAgbWlfcGFnZV9zZXRfaW5fZnVsbChwYWdlLCBtaV9wYWdlX3F1ZXVlX2lzX2Z1bGwocXVldWUpKTsKICAvLyBtaV9hdG9taWNfc3RvcmVfcHRyX3JlbGVhc2UobWlfYXRvbWljX2Nhc3Qodm9pZCosICZwYWdlLT5oZWFwKSwgaGVhcCk7CiAgcGFnZS0+bmVlcnQobSA+IDApOwoKICAgIC8qIGFkZCB2IHRvIHcgKi8KICAgIHMgPSB3WzBdICsgdjsKICAgIGNhcnJ5ID0gKHMgPCB2KSB8IChzID49IGIpOwogICAgd1swXSA9IGNhcnJ5ID8gcy1iIDogczsKCiAgICAvKiBpZiB0aGVyZSBpcyBhIGNhcnJ5LCBwcm9wYWdhdGUgaXQgKi8KICAgIGZvciAoaSA9IDE7IGNhcnJ5ICYmIGkgPCBtOyBpKyspIHsKICAgICAgICBzID0gd1tpXSArIGNhcnJ5OwogICAgICAgIGNhcnJ5ID0gKHMgPT0gYik7CiAgICAgICAgd1tpXSA9IGNhcnJ5ID8gMCA6IHM7CiAgICB9CgogICAgcmV0dXJuIGNhcnJ5Owp9CgovKiB3IDo9IHByb2R1Y3Qgb2YgdSAobGVuIG4pIGFuZCB2IChzaW5nbGUgd29yZCkuIFJldHVybiBjYXJyeS4gKi8KbXBkX3VpbnRfdApfbXBkX3Nob3J0bXVsX2MobXBkX3VpbnRfdCAqdywgY29uc3QgbXBkX3VpbnRfdCAqdSwgbXBkX3NpemVfdCBuLCBtcGRfdWludF90IHYpCnsKICAweDRiMDRkNDQ3VSwgMHhkMjBkODVmZFUsIDB4YTUwYWI1NmJVLAoweDM1YjVhOGZhVSwgMHg0MmIyOTg2Y1UsIDB4ZGJiYmM5ZDZVLCAweGFjYmNmOTQwVSwgMHgzMmQ4NmNlM1UsCjB4NDVkZjVjNzVVLCAweGRjZDYwZGNmVSwgMHhhYmQxM2Q1OVUsIDB4MjZkOTMwYWNVLCAweDUxZGUwMDNhVSwKMHhjOGQ3NTE4MFUsIDB4YmZkMDYxMTZVLCAweDIxYjRmNGI1VSwgMHg1NmIzYzQyM1UsIDB4Y2ZiYTk1OTlVLAoweGI4YmRhNTBmVSwgMHgyODAyYjg5ZVUsIDB4NWYwNTg4MDhVLCAweGM2MGNkOWIyVSwgMHhiMTBiZTkyNFUsCjB4MmY2ZjdjODdVLCAweDU4Njg0YzExVSwgMHhjMTYxMWRhYlUsIDB4YjY2NjJkM2RVLCAweDc2ZGM0MTkwVSwKMHgwMWRiNzEwNlUsIDB4OThkMjIwYmNVLCAweGVmZDUxMDJhVSwgMHg3MWIxODU4OVUsIDB4MDZiNmI1MWZVLAoweDlmYmZlNGE1VSwgMHhlOGI4ZDQzM1UsIDB4NzgwN2M5YTJVLG5vd25fdG9VdGY4OwogIGUtPm5vcm1hbC5lbmMudXRmMTZDb252ZXJ0ID0gdW5rbm93bl90b1V0ZjE2OwogIHJldHVybiAmKGUtPm5vcm1hbC5lbmMpOwp9CgovKiBJZiB0aGlzIGVudW1lcmF0aW9uIGlzIGNoYW5nZWQsIGdldEVuY29kaW5nSW5kZXggYW5kIGVuY29kaW5ncwptdXN0IGFsc28gYmUgY2hhbmdlZC4gKi8KZW51bSB7CiAgVU5LTk9XTl9FTkMgPSAtMSwKICBJU09fODg1OV8xX0VOQyA9IDAsCiAgVVNfQVNDSUlfRU5DLAogIFVURl84X0VOQywKICBVVEZfMTZfRU5DLAogIFVURl8xNkJFX0VOQywKICBVVEZfMTZMRV9FTkMsCiAgLyogbXVzdCBtYXRjaCBlbmNvZGluZ05hbWVzIHVwIHRvIGhlcmUgKi8KICBOT19FTkMKfTsKCnN0YXRpYyBjb25zdCBjaGFyIEtXX0lTT184ODU5XzFbXQogICAgPSB7QVNDSUlfSSwgQVNDSUlfUywgQVNDSUlfTywgICAgIEFTQ0lJX01JTlVTLCBBU0NJSV84LCBBU0NJSV84LAogIHhsZW4gIT0gbWF4bGVuKSB7CiAgICAgICAgbWF4bGVuID0gODE5MjsKICAgIH0KICAgIGxlbiA9IE11bHRpQnl0ZVRvV2lkZUNoYXIoQ1BfVVRGOCwgMCwgaG9tZSwgaG9tZV9sZW4sIGhvbWVfcGF0aCwgKERXT1JEKW1heGxlbik7CiAgICBpZiAoIWxlbikgewogICAgICAgIHdpbmVycm9yKEdldExhc3RFcnJvcigpLCBMImZhaWxlZCB0byBkZWNvZGUgaG9tZSBzZXR0aW5nIGluICclbHMnIiwgcHl2ZW52X2NmZyk7CiAgICAgICAgcmV0dXJuIFJDX0JBRF9WRU5WX0NGRzsKICAgIH0KICAgIGhvbWVfcGF0aFtsZW5dID0gTCdcMCc7CgogICAgcmV0dXJuIDA7Cn0KCgppbnQKbG9jYXRlX3B5dGhvbih3Y2hhcl90ICpwYXRoLCBzaXplX3QgbWF4bGVuKQp7CiAgICBpZiAoIWpvaW4ocGF0aCwgbWF4bGVuLCBFWEVOQU1FKSkgewogICAgICAgIGVycm9yKEwiZmFpbGVkIHRvIGFwcGVuZCAlbHMgdG8gJyVscyciLCBFWEVOQU1FLHVybiBwdHI7Cn0KCgpzdGF0aWMgdm9pZCoKdHJhY2VtYWxsb2NfcmVhbGxvYyhpbnQgbmVlZF9naWwsIHZvaWQgKmN0eCwgdm9pZCAqcHRyLCBzaXplX3QgbmV3X3NpemUpCnsKICAgIGludCByZWVudHJhbnQgPSBnZXRfcmVlbnRyYW50KCk7CgogICAgLy8gSWdub3JlIHJlZW50cmFudCBjYWxsLiBQeU9iamV0X1JlYWxsb2MoKSBjYWxscyBQeU1lbV9SZWFsbG9jKCkgZm9yCiAgICAvLyBhbGxvY2F0aW9ucyBsYXJnZXIgdGhhbiA1MTIgYnl0ZXM6IGRvbid0IHRyYWNlIHRoZSBzYW1lIG1lbW9yeSBibG9jawogICAgLy8gdHdpY2UuCiAgICBpZiAoIXJlZW50cmFudCkgewogICAgICAgIHNldF9yZWVudHJhbnQoMSk7CiAgICB9CgogICAgUHlNZW1BbGxvY2F0b3JFeCAqYWxsb2MgPSAoUHlNZW1BbGxvY2F0b3JFeCAqKWN0eDsKICAgIHZvaWQgKnB0cjIgPSBhbGxvYy0+cmVhbGxvYyhhbGxvYy0+Y3R4LCBwdHIsIG5ld2syLmg+CiMgIGluY2x1ZGUgPHByb2Nlc3MuaD4gICAgICAgICAgICAgICAvKiBnZXRwaWQoKSAqLwojICBpZmRlZiBQeV9ERUJVRwojICAgIGluY2x1ZGUgPGNydGRiZy5oPgojICBlbmRpZgojICBkZWZpbmUgU0VNX0hBTkRMRSBIQU5ETEUKIyAgZGVmaW5lIFNFTV9WQUxVRV9NQVggTE9OR19NQVgKIyAgZGVmaW5lIEhBVkVfTVBfU0VNQVBIT1JFCiNlbHNlCiMgIGluY2x1ZGUgPGZjbnRsLmg+ICAgICAgICAgICAgICAgICAvKiBPX0NSRUFUIGFuZCBPX0VYQ0wgKi8KIyAgaWYgZGVmaW5lZChIQVZFX1NFTV9PUEVOKSAmJiAhZGVmaW5lZChQT1NJWF9TRU1BUEhPUkVTX05PVF9FTkFCTEVEKQojICAgIGRlZmluZSBIQVZFX01QX1NFTUFQSE9SRQojICAgIGluY2x1ZGUgPHNlbWFwaG9yZS5oPgogICAgIHR5cGVkZWYgc2VtX3QgKlNFTV9IQU5ETEU7CiMgIGVuZGlmCiNlbmRpZgoKLyoKICogSXNzdWUgMzExMCAtIFNvbGFwdXQ9ZWE5MjEzY2M4N2ZkOTU4MSBpbnB1dD0wNDg1MDZmYWVmMTlkOTQ3XSovCnsKICAgIHJldHVybiAoUHlPYmplY3QgKiluZXdEZXZQb2xsT2JqZWN0KG1vZHVsZSk7Cn0KI2VuZGlmCgoKI2lmZGVmIF9fQVBQTEVfXwovKgogKiBPbiBzb21lIHN5c3RlbXMgcG9sbCgpIHNldHMgZXJybm8gb24gaW52YWxpZCBmaWxlIGRlc2NyaXB0b3JzLiBXZSB0ZXN0CiAqIGZvciB0aGlzIGF0IHJ1bnRpbWUgYmVjYXVzZSB0aGlzIGJ1ZyBtYXkgYmUgZml4ZWQgb3IgaW50cm9kdWNlZCBiZXR3ZWVuCiAqIE9TIHJlbGVhc2VzLgogKi8Kc3RhdGljIGludCBzZWxlY3RfaGF2ZV9icm9rZW5fcG9sbCh2b2lkKQp7CiAgICBpbnQgcG9sbF90ZXN0OwogICAgaW50IGZpbGVkZXNbMl07CgogICAgc3RydWN0IHBvbGxmZCBwb2xsX3N0cnVjdCA9IHsgMCwgUE9MTElOfFBPTExQUkl8UE9MTE9VVCwgMCB9OwoKICAgIC8qIENyZWFkZSAiX2Nnb19leHBvcnQuaCIKCmNvbnN0IGludCBNWUNPTlNUID0gMDsKCi8vIERvIHRoZSBhY3R1YWwgbWFuaXB1bGF0aW9uIG9mIHRoZSBsaWZlIGJvYXJkIGluIEMuICBUaGlzIGNvdWxkIGJlCi8vIGRvbmUgZWFzaWx5IGluIEdvLCB3ZSBhcmUganVzdCB1c2luZyBDIGZvciBkZW1vbnN0cmF0aW9uCi8vIHB1cnBvc2VzLgp2b2lkClN0ZXAoaW50IHgsIGludCB5LCBpbnQgKmEsIGludCAqbikKewoJc3RydWN0IEdvU3RhcnRfcmV0dXJuIHI7CgoJLy8gVXNlIEdvIHRvIHN0YXJ0IDQgZ29yb3V0aW5lcyBlYWNoIG9mIHdoaWNoIGhhbmRsZXMgMS80IG9mIHRoZQoJLy8gYm9hcmQuCglyID0gR29TdGFydCgwLCB4LCB5LCAwLCB4IC8gMiwgMCwgeSAvIDIsIGEsIG4pOwoJYXNzZXJ0KHIucjAgPT0gMCAmJiByLnIxID09IDEwMCk7CS8vIHRlc3QgbXVsdGlwbGUgcmV0dXJucwoJciA9IEdvU3RhcnQoMSwgeCwgeSwgeCAvaW1hbCBkaWdpdHMgZml0cyBhIH4xNDI4NCBiaXQgbnVtYmVyLgogKi8KI2RlZmluZSBfUFlfTE9OR19ERUZBVUxUX01BWF9TVFJfRElHSVRTIDQzMDAKLyoKICogVGhyZXNob2xkIGZvciBtYXggZGlnaXRzIGNoZWNrLiAgRm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMgaW50KCkgYW5kCiAqIGludC5fX3N0cl9fKCkgZG9uJ3QgY2hlY2tzIHZhbHVlcyB0aGF0IGFyZSBzbWFsbGVyIHRoYW4gdGhpcwogKiB0aHJlc2hvbGQuICBBY3RzIGFzIGEgZ3VhcmFudGVlZCBtaW5pbXVtIHNpemUgbGltaXQgZm9yIGJpZ251bXMgdGhhdAogKiBhcHBsaWNhdGlvbnMgY2FuIGV4cGVjdCBmcm9tIENQeXRob24uCiAqCiAqICUgcHl0aG9uIC1tIHRpbWVpdCAtcyAncyA9ICIxIio2NDA7IHYgPSBpbnQocyknICdzdHIoaW50KHMpKScKICogMjAwMDAgbG9vcHMsIGJlc3Qgb2YgNTogMTIgdXNlYyBwZXIgbG9vcAogKgogKiAiNjQwIGRpZ2l0cyBzcigpOwoKICAgIFB5X1hTRVRSRUYodGhyZWFkLmZpbGUsIGZpbGUpOwogICAgdGhyZWFkLmZkID0gZmQ7CiAgICAvKiB0aGUgZG93bmNhc3QgaXMgc2FmZTogd2UgY2hlY2sgdGhhdCAwIDwgdGltZW91dF91cyA8IFBZX1RJTUVPVVRfTUFYICovCiAgICB0aHJlYWQudGltZW91dF91cyA9IChQWV9USU1FT1VUX1QpdGltZW91dF91czsKICAgIHRocmVhZC5yZXBlYXQgPSByZXBlYXQ7CiAgICB0aHJlYWQuaW50ZXJwID0gUHlUaHJlYWRTdGF0ZV9HZXRJbnRlcnByZXRlcih0c3RhdGUpOwogICAgdGhyZWFkLmV4aXQgPSBleGl0OwogICAgdGhyZWFkLmhlYWRlciA9IGhlYWRlcjsKICAgIHRocmVhZC5oZWFkZXJfbGVuID0gaGVhZGVyX2xlbjsKCiAgICAvKiBBcm0gdGhlc2UgbG9ja3MgdG8gc2VydmUgYXMgZXZlbnRzIHdoZW4gcmVsZWFzZWQgKi8KICAgIFB5VGhyZWFkX2FjcXVpcmVfbG9jayh0aHJlYWQucnVubmluZywgMSk7cmFsIGlzIGltbWVkaWF0ZWx5CiAgICAgKiBmb2xsb3dlZCBieSBvbmUgb2Yga2V5d29yZHMgd2hpY2ggY2FuIG9jY3VyIGFmdGVyIGEgbnVtZXJpYyBsaXRlcmFsCiAgICAgKiBpbiB2YWxpZCBjb2RlOiAiYW5kIiwgImVsc2UiLCAiZm9yIiwgImlmIiwgImluIiwgImlzIiBhbmQgIm9yIi4KICAgICAqIEl0IGFsbG93cyB0byBncmFkdWFsbHkgZGVwcmVjYXRlIGV4aXN0aW5nIHZhbGlkIGNvZGUgd2l0aG91dCBhZGRpbmcKICAgICAqIHdhcm5pbmcgYmVmb3JlIGVycm9yIGluIG1vc3QgY2FzZXMgb2YgaW52YWxpZCBudW1lcmljIGxpdGVyYWwgKHdoaWNoCiAgICAgKiB3b3VsZCBiZSBjb25mdXNpbmcgYW5kIGJyZWFrIGV4aXN0aW5nIHRlc3RzKS4KICAgICAqIFJhaXNlIGEgc3ludGF4IGVycm9yIHdpdGggc2xpZ2h0bHkgYmV0dGVyIG1lc3NhZ2UgdGhhbiBwbGFpbgogICAgICogImludmFsaWQgc3ludGF4IiBpZiB0ICAgTFBTRUNVUklUWV9BVFRSSUJVVEVTIHNlY3VyaXR5X2F0dHJpYnV0ZXM7CiAgICBIQU5ETEUgX3JldHVybl92YWx1ZTsKCiAgICBpZiAoIV9QeUFyZ19QYXJzZVN0YWNrKGFyZ3MsIG5hcmdzLCAiTyZra2tra2siIEZfUE9JTlRFUiAiOkNyZWF0ZU5hbWVkUGlwZSIsCiAgICAgICAgX1B5VW5pY29kZV9XaWRlQ2hhclN0cmluZ19Db252ZXJ0ZXIsICZuYW1lLCAmb3Blbl9tb2RlLCAmcGlwZV9tb2RlLCAmbWF4X2luc3RhbmNlcywgJm91dF9idWZmZXJfc2l6ZSwgJmluX2J1ZmZlcl9zaXplLCAmZGVmYXVsdF90aW1lb3V0LCAmc2VjdXJpdHlfYXR0cmlidXRlcykpIHsKICAgICAgICBnb3RvIGV4aXQ7CiAgICB9CiAgICBfcmV0dXJuX3ZhbHVlID0gX3dpbmFwaV9DcmVhdGVOYW1lZFBpcGVfaW1wbChtb2R1bGUsIG5hbWUsIG9wZW5fbW9kZSwgcGlwZV9tb2RlLCBtYXhfaW5zdGFuY2VzLCBvdXRfYnVmZmVyX3NpemUsIGlubGlnbl9vZmZzZXQsIGJvb2wgY29tbWl0LCBib29sIGFsbG93X2xhcmdlLCBtaV9tZW1pZF90KiBtZW1pZCwgbWlfc3RhdHNfdCogdGxkX3N0YXRzKTsKCnZvaWQqICAgICAgX21pX29zX2dldF9hbGlnbmVkX2hpbnQoc2l6ZV90IHRyeV9hbGlnbm1lbnQsIHNpemVfdCBzaXplKTsKYm9vbCAgICAgICBfbWlfb3NfdXNlX2xhcmdlX3BhZ2Uoc2l6ZV90IHNpemUsIHNpemVfdCBhbGlnbm1lbnQpOwpzaXplX3QgICAgIF9taV9vc19sYXJnZV9wYWdlX3NpemUodm9pZCk7Cgp2b2lkKiAgICAgIF9taV9vc19hbGxvY19odWdlX29zX3BhZ2VzKHNpemVfdCBwYWdlcywgaW50IG51bWFfbm9kZSwgbWlfbXNlY3NfdCBtYXhfc2Vjcywgc2l6ZV90KiBwYWdlc19yZXNlcnZlZCwgc2l6ZV90KiBwc2l6ZSwgbWlfbWVtaWRfdCogbWVtaWQpOwoKLy8gYXJlbmEuYwptaV9hcmVuYV9pZF90IF9taV9hcmVuYV9pZF9ub25lKHZvaWQpOwp2b2lkZSB0ZWxscyBDL0MrKyBUU0FOIHRoYXQgd2UgYXJlIGFjcXVpcmluZyBhIGR1bW15IGxvY2suIFdlCi8vIGNhbGwgdGhpcyB3aGVuIGNhbGxpbmcgZnJvbSBHbyB0byBDLiBUaGlzIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIFRTQU4gY2Fubm90Ci8vIHNlZSB0aGUgc3luY2hyb25pemF0aW9uIGluIEdvLiBOb3RlIHRoYXQgQy9DKysgY29kZSBidWlsdCB3aXRoIFRTQU4gaXMgbm90Ci8vIHRoZSBzYW1lIGFzIHRoZSBHbyByYWNlIGRldGVjdG9yLgovLwovLyBjbWQvY2dvIGdlbmVyYXRlcyBjYWxscyB0byBfY2dvX3RzYW5fYWNxdWlyZSBhbmQgX2Nnb190c2FuX3JlbGVhc2UuIEZvcgovLyBvdGhlciBjZ28gY2FsbHMsIG1hbnVhbCBjYWxscyBhcmUgcmVxdWlyZWQuCi8vCi8vIFRoZXNlIG11c3QgbWF0Y2ggdGhlIGRlZmluaXRpb25zIGluIHllc1RzYW5Qcm9sb2cgaW4gY21kL2Nnby9vdXQuZ28uCi8vIEluIGdlbmVyYWwgd2UgRmdldHMgaXMgYW4gZmdldHMgdmFyaWF0aW9uIHRoYXQgdW5kZXJzdGFuZHMKKiogYWxsIG9mIFxyLCBcbiBhbmQgXHJcbiBjb252ZW50aW9ucy4KKiogVGhlIHN0cmVhbSBzaG91bGQgYmUgb3BlbmVkIGluIGJpbmFyeSBtb2RlLgoqKiBUaGUgZm9iaiBwYXJhbWV0ZXIgZXhpc3RzIHNvbGVseSBmb3IgbGVnYWN5IHJlYXNvbnMgYW5kIG11c3QgYmUgTlVMTC4KKiogTm90ZSB0aGF0IHdlIG5lZWQgbm8gZXJyb3IgaGFuZGxpbmc6IGZnZXRzKCkgdHJlYXRzIGVycm9yIGFuZCBlb2YKKiogaWRlbnRpY2FsbHkuCiovCgpjaGFyICoKUHlfVW5pdmVyc2FsTmV3bGluZUZnZXRzKGNoYXIgKmJ1ZiwgaW50IG4sIEZJTEUgKnN0cmVhbSwgUHlPYmplY3QgKmZvYmopIHsKICAgIHNpemVfdCBzaXplOwogICAgcmV0dXJuIF9QeV9Vbml2ZXJzYWxOZXdsaW5lRmdldHNXaXRoU2l6ZShidWYsIG4sIHN0cmVhbSwgZm9iaiwgJnNpemUpOwp9a2xlIiwKInBpY2tsZXRvb2xzIiwKInBrZ3V0aWwiLAoicGxhdGZvcm0iLAoicGxpc3RsaWIiLAoicG9wbGliIiwKInBvc2l4IiwKInBvc2l4cGF0aCIsCiJwcHJpbnQiLAoicHJvZmlsZSIsCiJwcm9maWxpbmciLAoicHN0YXRzIiwKInB0eSIsCiJwd2QiLAoicHlfY29tcGlsZSIsCiJweWNsYnIiLAoicHlkb2MiLAoicHlkb2NfZGF0YSIsCiJweWV4cGF0IiwKInF1ZXVlIiwKInF1b3ByaSIsCiJyYW5kb20iLAoicmUiLAoicmVhZGxpbmUiLAoicmVwcmxpYiIsCiJyZXNvdXJjZSIsCiJybGNvbXBsZXRlciIsCiJydW5weSIsCiJzY2hlZCIsCiJzZWNyZXRzIiwKInNlbGVjdCIsCiJzZWxlY3RvcnMiLAoic2hlbHZlIiwKInNobGV4IiwKInNodXRpbCIsCiJzaWduYWwiLAoic2l0ZSIsCiJzbXRwbGliIiwKInNvY2tldCIsCiJzb2NrZXRzZXJ2ZXIiLAoic3FsaXRlMyIsCiJzc2wiLAoic3RhdCIsCiJzdGF0aXN0aWNzIiwKTl9UID49IF9BbGlnbm9mKHZvaWQgKCopKHZvaWQpKSk7CgogICAgLy8gRW5zdXJlIGl0J3MgYSBwb3dlciBvZiB0d28KICAgIGFzc2VydCgoQUxJR05PRl9NQVhfQUxJR05fVCAmIChBTElHTk9GX01BWF9BTElHTl9UIC0gMSkpID09IDApOwoKICAgIFB5X1JFVFVSTl9OT05FOwp9CgpzdGF0aWMgUHlNZXRob2REZWYgVGVzdE1ldGhvZHNbXSA9IHsKICAgIHsibWFrZV9zaXplZF9oZWFwdHlwZXMiLCBtYWtlX3NpemVkX2hlYXB0eXBlcywgTUVUSF9WQVJBUkdTfSwKICAgIHsic3ViY2xhc3NfdmFyX2hlYXB0eXBlIiwgc3ViY2xhc3NfdmFyX2hlYXB0eXBlLCBNRVRIX1ZBUkFSR1N9LAogICAgeyJzdWJjbGFzc19oZWFwdHlwZSIsIHN1YmNsYXNzX2hlYXB0eXBlLCBNRVRIX1ZBUkFSR1N9LAogICAgTUFLRV9IRUFQVFlQRV9XSVRIX01FTUJFUl9NRVRIT0RERUYKICAgIHsidGVzdF9hbGlnbm9mX21heF9hbGlnbl90IiwgdGVzQUxFX1NJU08zMTY2Q1RSWU5BTUUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxlK2ksIChpbnQpKHNpemVvZihsb2NhbGUpLWkpKSkKICAgICAgICAgICAgcmV0dXJuIFB5X0J1aWxkVmFsdWUoInNzIiwgbG9jYWxlLCBlbmNvZGluZyk7CiAgICB9CgogICAgLyogSWYgd2UgZW5kIHVwIGhlcmUsIHRoaXMgd2luZG93cyB2ZXJzaW9uIGRpZG4ndCBrbm93IGFib3V0CiAgICAgICBJU082MzkvSVNPMzE2NiBuYW1lcyAoaXQncyBwcm9iYWJseSBXaW5kb3dzIDk1KS4gIFJldHVybiB0aGUKICAgICAgIFdpbmRvd3MgbGFuZ3VhZ2UgaWRlbnRpZmllciBpbnN0ZWFkIChhIGhleGFkZWNpbWFsIG51bWJlcikgKi8KCiAgICBsb2NhbGVbMF0gPSAnMCc7CiAgICBsb2NhbGVbMV0gPSAneCc7CiAgICBpZiAoR2V0TG9jYWxlSW5mb0EoTE9DQUxFX1VTRVJfREVGQVVMVCwgTE9DQUxFX0lERUZBVUxUTEFOR1VBR0UsCiAgICBNVUxNT0QyQygmeDIsICZ4Mywgbl9pbnYpOwogICAgICAgIGMxW2ldID0geDA7CiAgICAgICAgYzFbaSsxXSA9IHgxOwogICAgICAgIGMxW2krMl0gPSB4MjsKICAgICAgICBjMVtpKzNdID0geDM7CiAgICB9CgogICAgcmV0dXJuIDE7Cn0KLyogQXV0by1nZW5lcmF0ZWQgYnkgVG9vbHMvYnVpbGQvZ2VuZXJhdGVfdG9rZW4ucHkgKi8KCiNpbmNsdWRlICJQeXRob24uaCIKI2luY2x1ZGUgInB5Y29yZV90b2tlbi5oIgoKLyogVG9rZW4gbmFtZXMgKi8KCmNvbnN0IGNoYXIgKiBjb25zdCBfUHlQYXJzZXJfVG9rZW5OYW1lc1tdID0gewogICAgIkVORE1BUktFUiIsCiAgICAiTkFNRSIsCiAgICAiTlVNQkVSIiwKICAgICJTVFJJTkciLAogICAgIk5FV0xJTkUiLAogICAgIklOREVOVCIsCiAgICAiREVERU5UIiwKICAgICJMUEFSIiwKICAgICJSUEFSIiwKICAgICJMU1FCIiwKICAgICJSU1FCIiwKICAgICJDT0xPTiIsCiAgdWxlX3N0YXRlICpzdGF0ZSA9IGdldF90aHJlYWRfc3RhdGUoc2VsZik7CgogICAgZm9yICg7OykgewogICAgICAgIFRocmVhZEhhbmRsZSAqaGFuZGxlID0gTlVMTDsKCiAgICAgICAgLy8gRmluZCBhIHRocmVhZCB0aGF0J3Mgbm90IHlldCBmaW5pc2hlZC4KICAgICAgICBIRUFEX0xPQ0soJl9QeVJ1bnRpbWUpOwogICAgICAgIHN0cnVjdCBsbGlzdF9ub2RlICpub2RlOwogICAgICAgIGxsaXN0X2Zvcl9lYWNoX3NhZmUobm9kZSwgJnN0YXRlLT5zaHV0ZG93bl9oYW5kbGVzKSB7CiAgICAgICAgICAgIFRocmVhZEhhbmRsZSAqY3VyID0gbGxpc3RfZGF0YShub2RlLCBUaHJlYWRIYW5kbGUsIHNodXRkb3duX25vZGUpOwogICAgICAgICAgICBpZiAoY3VyLT5pZGVudCAhPSBpZGVudCkgewogICAgICAgICAgICAgICAgVGhyZWFkSGFuZGxlX2luY3JlZihjdXIpOwogICAgICAgICAgICAgICAgaGFuZGxlID0gY3VyOwogIHRvIGJyZWFrCiAgIHRoZSByZWZlcmVuY2UgY2hhaW4uIFRoZXNlIHRyaXZpYWwgb2JqZWN0cyBhcmUgaGFzaGFibGUgKHVzaW5nIHRoZQogICBkZWZhdWx0IHNjaGVtZSBvZiBpZGVudGl0eSBoYXNoaW5nKSBhbmQgd2Vha3JlZmFibGUuCgogICBFYWNoIHRocmVhZC1zdGF0ZSBob2xkcyB0d28gc2VwYXJhdGUgbG9jYWxkdW1teSBvYmplY3RzOgoKICAgLSBgdGhyZWFkaW5nX2xvY2FsX2tleWAgaXMgdXNlZCBhcyBhIGtleSB0byByZXRyaWV2ZSB0aGUgbG9jYWxzIGRpY3Rpb25hcnkKICAgICBmb3IgdGhlIHRocmVhZCBpbiBhbnkgYHRocmVhZGluZy5sb2NhbGAgb2JqZWN0LgogICAtIGB0aHJlYWRpbmdfbG9jYWxfc2VudGluZWxgIGlzIHVzZWQgdG8gc2lnbmFsIHdoZW4gYSB0aHJlYWQgaXMgYmVpbmcKICAgICBkZXN0cm95ZWQuIENvbnNlcXVlbnRseSwgdGhlIGFzc29jaWF0ZWQgdGhyZWFkLXN0YXRlIG11c3QgaG9sZDAgJiYgZXJybm8gPT0gRUlOVFIgJiYgIShhc3luY19lcnIgPSBQeUVycl9DaGVja1NpZ25hbHMoKSkpOwoKICAgIGlmIChmZCA8IDApIHsKICAgICAgICBpZiAoIWFzeW5jX2VycikKICAgICAgICAgICAgUHlFcnJfU2V0RnJvbUVycm5vV2l0aEZpbGVuYW1lT2JqZWN0KFB5RXhjX09TRXJyb3IsIHBhdGgpOwogICAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICByZXR1cm4gZmQ7Cn0KI2VuZGlmIC8qIEhBVkVfU0hNX09QRU4gKi8KCiNpZmRlZiBIQVZFX1NITV9VTkxJTksKLypbY2xpbmljIGlucHV0XQpfcG9zaXhzaG1lbS5zaG1fdW5saW5rCiAgICBwYXRoOiB1bmljb2RlCiAgICAvCgpSZW1vdmUgYSBzaGFyZWQgbWVtb3J5IG9iamVjdCAoc2ltaWxhciB0byB1bmxpbmsoKSkuCgpSZW1vdmUgYSBzaGFyZWQgbWVtb3J5IG9iamVjdCBuYW1lLCBhbmQsIG9uY2UgYWxsIHByb2Nlc3NlcyAgaGF2ZSAgdW5tYXBwZWQKdGhlX2xvYWRpNjRfcmVsYXhlZCgoX0F0b21pYyhpbnQ2NF90KSopJl9taV9zdGF0c19tYWluLmNvbW1pdHRlZC5wZWFrKSk7CiAgcGluZm8uY3VycmVudF9yc3MgICAgPSBwaW5mby5jdXJyZW50X2NvbW1pdDsKICBwaW5mby5wZWFrX3JzcyAgICAgICA9IHBpbmZvLnBlYWtfY29tbWl0OwogIHBpbmZvLnV0aW1lICAgICAgICAgID0gMDsKICBwaW5mby5zdGltZSAgICAgICAgICA9IDA7CiAgcGluZm8ucGFnZV9mYXVsdHMgICAgPSAwOwoKICBfbWlfcHJpbV9wcm9jZXNzX2luZm8oJnBpbmZvKTsKCiAgaWYgKGVsYXBzZWRfbXNlY3MhPU5VTEwpICAqZWxhcHNlZF9tc2VjcyAgPSAocGluZm8uZWxhcHNlZCA8IDAgPyAwIDogKHBpbmZvLmVsYXBzZWQgPCAobWlfbXNlY3NfdClQVFJESUZGX01BWCA/IChzaXplX3QpcGluZm8uZWxhcHNlZCA6IFBUUkRJRkZfTUFYKSk7CiAgaWYgKHVzZXJfbXNlY3MhPU5VTEwpICAgICAqdXNlcl9zZXJ0KChnZXRkYXRhLmJhc2ljID09IE5VTEwpICE9IChnZXRkYXRhLmZhbGxiYWNrID09IE5VTEwpKTsKICAgICpuZXdoZWFkID0gKGRscmVnaXRlbV90KXsKICAgICAgICAvLyBXZSBkbyBub3Qga2VlcCBhIHJlZmVyZW5jZSwgdG8gYXZvaWQga2VlcGluZyB0aGUgY2xhc3MgYWxpdmUuCiAgICAgICAgLmNscyA9IGNscywKICAgICAgICAucmVmY291bnQgPSAxLAogICAgICAgIC5nZXRkYXRhID0gZ2V0ZGF0YSwKICAgIH07CiAgICBpZiAoY2xzLT50cF9mbGFncyAmIFB5X1RQRkxBR1NfSEVBUFRZUEUpIHsKICAgICAgICAvLyBYWFggQXNzaWduIGEgY2FsbGJhY2sgdG8gY2xlYXIgdGhlIGVudHJ5IGZyb20gdGhlIHJlZ2lzdHJ5PwogICAgICAgIG5ld2hlYWQtPndlYWtyZWYgPSBQeVdlYWtyZWZfTmV3UmVmKChQeU9iamVjdCAqKWNscywgTlVMTCk7CiAgICAgICAgaWYgKG5ld2hlYWQtPndlYWtyZWYgPT0gTmR1bGUgKi8KCi8qIFRoaXMgcHJvdmlkZXMgYW4gaW50ZXJmYWNlIHRvIE5JU1QncyBTSEEyIDIyNCwgMjU2LCAzODQsICYgNTEyIEFsZ29yaXRobXMgKi8KCi8qIFNlZSBiZWxvdyBmb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIG9yaWdpbmFsIGNvZGUgdGhpcyBtb2R1bGUgd2FzCiAgIGJhc2VkIHVwb24uIEFkZGl0aW9uYWwgd29yayBwZXJmb3JtZWQgYnk6CgogICBBbmRyZXcgS3VjaGxpbmcgKGFta0BhbWsuY2EpCiAgIEdyZWcgU3RlaW4gKGdzdGVpbkBseXJhLm9yZykKICAgVHJldm9yIFBlcnJpbiAodHJldnBAdHJldnAubmV0KQogICBKb25hdGhhbiBQcm90emVua28gKGpvbmF0aGFuQHByb3R6ZW5rby5mcikKICAgQsOpbsOpZGlrdCBUcmFuICgxMDc5NjYwMCtwaWNuaXh6QHVzZXJzLm5vcmVwbHkuZ2l0aHViLmNvbSkKCiAgIENvcHlyaWdodCAoQykgMjAwNS0yMDA3ICAgR3JlZ29yeSBQLiBTbWl0aCAoZ3JlZ0BrcnlfdHBfc2V0YXR0cm8sIFB5T2JqZWN0X0dlbmVyaWNTZXRBdHRyfSwKICAgIHtQeV90cF9yZXByLCBzX3JlcHJ9LAogICAge1B5X3RwX2RvYywgKHZvaWQqKVN0cnVjdF9fX2luaXRfX19fZG9jX199LAogICAge1B5X3RwX3RyYXZlcnNlLCBzX3RyYXZlcnNlfSwKICAgIHtQeV90cF9jbGVhciwgc19jbGVhcn0sCiAgICB7UHlfdHBfbWV0aG9kcywgc19tZXRob2RzfSwKICAgIHtQeV90cF9tZW1iZXJzLCBzX21lbWJlcnN9LAogICAge1B5X3RwX2dldHNldCwgc19nZXRzZXRsaXN0fSwKICAgIHtQeV90cF9pbml0LCBTdHJ1Y3RfX19pbml0X199LAogICAge1B5X3RwX2FsbG9jLCBQeVR5cGVfR2VuZXJpY0FsbG9jfSwKICAgIHtQeV90cF9uZXcsIHNfbmV3fSwKICAgIHtQeV90cF9mcmVlLCBQeU9iamVjdF9HQ19EZWx9LAogICAgezAsIDB9LAp9OwoKc3RhdGljIFB5VHlwZV9TcGVjIFB5U3RydWN0VHlwZV9lID0gJ1B5U3RydWN0T2JqZWN0IConCiAgICBjb252ZXJ0ZXIgPSAnY2FjaGVfc3RydWN0X2NvbnZlcnRlcicKICAgIGNfZGVmYXVsdCA9ICJOVUxMIgogICAgYnJva2VuX2xpbWl0ZWRfY2FwaSA9IFRydWUKCiAgICBkZWYgcGFyc2VfYXJnKHNlbGYsIGFyZ25hbWUsIGRpc3BsYXluYW1lLCAqLCBsaW1pdGVkX2NhcGkpOgogICAgICAgIGFzc2VydCBub3QgbGltaXRlZF9jYXBpCiAgICAgICAgcmV0dXJuIHNlbGYuZm9ybWF0X2NvZGUoIiIiCiAgICAgICAgICAgIGlmICghe2NvbnZlcnRlcn0obW9kdWxlLCB7YXJnbmFtZX0sICZ7cGFyYW1uYW1lfSkpIHt7e3sKICAgICAgICAgICAgICAgIGdvdG8gZXhpdDsKICAgICAgICAgICAgfX19fQogICAgICAgICAgICAiIiIsCiAgICAgICAgICAgIGFyZ25hbWU9YXJnbmFtZSwKICAgICAgICAgICAgY29udmVydGVyPXNlbGYuY29udmVydGVyKQoKICAgIGRlZiBjbGVhbnVwKHNlbGZ0cyB0b1xuIgoiX3Rlc3RjbGluaWMuRGVwclN0YXJJbml0LmNsb25lZCgpIGlzIGRlcHJlY2F0ZWQuIFBhcmFtZXRlciBcJ2FcJyB3aWxsXG4iCiJiZWNvbWUgYSBrZXl3b3JkLW9ubHkgcGFyYW1ldGVyIGluIFB5dGhvbiAzLjE0LlxuIgoiIik7CgojZGVmaW5lIERFUFJfU1RBUl9JTklUX0NMT05FX01FVEhPRERFRiAgICBcCiAgICB7ImNsb25lZCIsIF9QeUNGdW5jdGlvbl9DQVNUKGRlcHJfc3Rhcl9pbml0X2Nsb25lKSwgTUVUSF9GQVNUQ0FMTHxNRVRIX0tFWVdPUkRTLCBkZXByX3N0YXJfaW5pdF9jbG9uZV9fZG9jX199LAoKc3RhdGljIFB5T2JqZWN0ICoKZGVwcl9zdGFyX2luaXRfY2xvbmVfaW1wbChQeU9iamVjdCAqc2VsZiwgUHlPYmplY3QgKmEpOwoKLy8gRW1pdCBjb21waWxlciB3YXJuaW5ncyB3aGVuIHdlIGdldCB0byBQeXRob24gMy4xNC4KI2lmIFBZX1ZFUlNJT05fSEVYID49IDB4MDMwZTAwQzAKIyAgZSwKInJlbW92ZXN1ZmZpeCgkc2VsZiwgc3VmZml4LCAvKVxuIgoiLS1cbiIKIlxuIgoiUmV0dXJuIGEgYnl0ZXMgb2JqZWN0IHdpdGggdGhlIGdpdmVuIHN1ZmZpeCBzdHJpbmcgcmVtb3ZlZCBpZiBwcmVzZW50LlxuIgoiXG4iCiJJZiB0aGUgYnl0ZXMgZW5kcyB3aXRoIHRoZSBzdWZmaXggc3RyaW5nIGFuZCB0aGF0IHN1ZmZpeCBpcyBub3QgZW1wdHksXG4iCiJyZXR1cm4gYnl0ZXNbOi1sZW4ocHJlZml4KV0uICBPdGhlcndpc2UsIHJldHVybiBhIGNvcHkgb2YgdGhlIG9yaWdpbmFsXG4iCiJieXRlcy4iKTsKCiNkZWZpbmUgQllURVNfUkVNT1ZFU1VGRklYX01FVEhPRERFRiAgICBcCiAgICB7InJlbW92ZXN1ZmZpeCIsIChQeUNGdW5jdGlvbilieXRlc19yZW1vdmVzdWZmaXgsIE1FVEhfTywgYnl0ZXNfcmVtb3Zlc3VmZml4X19kb2NfX30sCgpzdGF0aWMgUHlPYmplY3QgKgpieXRlc19yZW1vdmVzdWZmaXhfaW1wbDddKi8KI2lmbmRlZiBQeV9QWU1BQ1JPX0gKI2RlZmluZSBQeV9QWU1BQ1JPX0gKCi8vIGdoLTkxNzgyOiBPbiBGcmVlQlNEIDEyLCBpZiB0aGUgX1BPU0lYX0NfU09VUkNFIGFuZCBfWE9QRU5fU09VUkNFIG1hY3JvcyBhcmUKLy8gZGVmaW5lZCwgPHN5cy9jZGVmcy5oPiBkaXNhYmxlcyBDMTEgc3VwcG9ydCBhbmQgPGFzc2VydC5oPiBkb2VzIG5vdCBkZWZpbmUKLy8gdGhlIHN0YXRpY19hc3NlcnQoKSBtYWNyby4KLy8gaHR0cHM6Ly9idWdzLmZyZWVic2Qub3JnL2J1Z3ppbGxhL3Nob3dfYnVnLmNnaT9pZD0yNTUyOTAKLy8KLy8gbWFjT1MgPD0gMTAuMTAgZG9lc24ndCBkZWZpbmUgc3RhdGljX2Fzc2VydCBpbiBhc3NlcnQuaCBhdCBhbGwgZGVzcGl0ZQovLyBoYXZpbmcgQzExIGNvbXBpbGVyIHN1cHBvcnQuCi8vCi8vIHN0YXRpY19hc3NlcnQgaXMgZGVmaW5lZCBpbiBnbGliYyBmcm9tIHZlcnNpb24gMi4xNi4gQ29tICpzZXEpCnsKICAgIF9QeUp1bXBUYXJnZXRMYWJlbCBsYmwgPSB7KytzZXEtPnNfbmV4dF9mcmVlX2xhYmVsfTsKICAgIHJldHVybiBsYmw7Cn0KCmludApfUHlJbnN0cnVjdGlvblNlcXVlbmNlX1VzZUxhYmVsKGluc3RyX3NlcXVlbmNlICpzZXEsIGludCBsYmwpCnsKICAgIGludCBvbGRfc2l6ZSA9IHNlcS0+c19sYWJlbG1hcF9zaXplOwogICAgX1B5X2NfYXJyYXlfdCBhcnJheSA9IHsKICAgICAgICAuYXJyYXkgPSAodm9pZCopc2VxLT5zX2xhYmVsbWFwLAogICAgICAgIC5hbGxvY2F0ZWRfZW50cmllcyA9IHNlcS0+c19sYWJlbG1hcF9zaXplLAogICAgICAgIC5pdGVtX3NpemUgPSBzaXplb2YoaW50KSwKICAgICAgICAuaW5pdGlhbF9udW1fZW50cmllcyA9IElOSVRJQUxfSU5TVFJfU0VRVUVOQ0VfTEFCRUxTX01BUF9TSVpFLAogICAgfTsKCiAgICBSRVRVUk5fSUZfRVJST1IoX1B5X0NBcnJheV9FbnN1cmVDYXBhcm1zCiAgIGNoYXJhY3RlciBjb252ZXJzaW9uIHdoZW4gbmVjZXNzYXJ5IGFuZCBmYWxscyBiYWNrIHRvIG1lbWNweSgpIGlmIHBvc3NpYmxlLgoKICAgRmFpbCBpZiB0byBpcyB0b28gc21hbGwgKHNtYWxsZXIgdGhhbiAqaG93X21hbnkqIG9yIHNtYWxsZXIgdGhhbgogICBsZW4oZnJvbSktZnJvbV9zdGFydCksIG9yIGlmIGtpbmQoZnJvbVtmcm9tX3N0YXJ0OmZyb21fc3RhcnQraG93X21hbnldKSA+CiAgIGtpbmQodG8pLCBvciBpZiAqdG8qIGhhcyBtb3JlIHRoYW4gMSByZWZlcmVuY2UuCgogICBSZXR1cm4gdGhlIG51bWJlciBvZiB3cml0dGVuIGNoYXJhY3Rlciwgb3IgcmV0dXJuIC0xIGFuZCByYWlzZSBhbiBleGNlcHRpb24KICAgb24gZXJyb3IuCgogICBQc2V1ZG8tY29kZToKCiAgICAgICBob3dfbWFueSA9IG1pbihob3dfbWFueSwgbGVuKGZyb20pIC0gZnJvbV9zdGFydCkKICAgICAgIHRvW3RvX3N0YXJ0OnRvICAgY2ggPSBQeVVuaWNvZGVfUkVBRChraW5kLCBkYXRhLCBpKTsKICAgICAgICAgICAgaWYgKGNoICE9ICcgJyAmJiBjaCAhPSAnXHQnICYmIGNoICE9ICdcMDE0JykKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgdHJ1bmNhdGVkID0gUHlVbmljb2RlX1N1YnN0cmluZyhzb3VyY2VsaW5lLCBpLCBsZW4pOwogICAgICAgIGlmICh0cnVuY2F0ZWQgPT0gTlVMTCkKICAgICAgICAgICAgZ290byBlcnJvcjsKCiAgICAgICAgUHlGaWxlX1dyaXRlT2JqZWN0KHNvdXJjZWxpbmUsIGZfc3RkZXJyLCBQeV9QUklOVF9SQVcpOwogICAgICAgIFB5X0RFQ1JFRih0cnVuY2F0ZWQpOwogICAgICAgIFB5RmlsZV9Xcml0ZVN0cmluZygiXG4iLCBmX3N0ZGVycik7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBfUHlfRGlzcGxheVNvdXJjZUxpbmUoZl9zdGRlcnIsIGZpbGVuYW1lLCBsaW5lbm8sIDIsIE5VTGstPmhlYWQgPSBidWYtPnByZXY7CiAgICAgICAgX1B5T2JqZWN0U3RhY2tDaHVua19GcmVlKGJ1Zik7CiAgICB9CiAgICByZXR1cm4gb2JqOwp9CgpzdGF0aWMgaW5saW5lIFB5X3NzaXplX3QKX1B5T2JqZWN0U3RhY2tfU2l6ZShfUHlPYmplY3RTdGFjayAqc3RhY2spCnsKICAgIFB5X3NzaXplX3Qgc2l6ZSA9IDA7CiAgICBmb3IgKF9QeU9iamVjdFN0YWNrQ2h1bmsgKmJ1ZiA9IHN0YWNrLT5oZWFkOyBidWYgIT0gTlVMTDsgYnVmID0gYnVmLT5wcmV2KSB7CiAgICAgICAgc2l6ZSArPSBidWYtPm47CiAgICB9CiAgICByZXR1cm4gc2l6ZTsKfQoKLy8gTWVyZ2Ugc3JjIGludG8gZHN0LCBsZWF2aW5nIHNyYyBlbXB0eQpleHRlcm4gdm9pZApfUHlPYmplY3RTdGFja19NZXJnZShfUHlPYmplY3RTdGFjayAqZHN0LCBfUHlPYmplY3RTdGFjayAqc3JjKTsKCi8vIFJlbW92ZSBhbGwgaXRlbXMgZnJvbSB0aGUgc3RhY2sKZXh0ZXNzb3JfbmV3X19kb2NfXywKIlpzdGRDb21wcmVzc29yKGxldmVsPU5vbmUsIG9wdGlvbnM9Tm9uZSwgenN0ZF9kaWN0PU5vbmUpXG4iCiItLVxuIgoiXG4iCiJDcmVhdGUgYSBjb21wcmVzc29yIG9iamVjdCBmb3IgY29tcHJlc3NpbmcgZGF0YSBpbmNyZW1lbnRhbGx5LlxuIgoiXG4iCiIgIGxldmVsXG4iCiIgICAgVGhlIGNvbXByZXNzaW9uIGxldmVsIHRvIHVzZS4gRGVmYXVsdHMgdG8gQ09NUFJFU1NJT05fTEVWRUxfREVGQVVMVC5cbiIKIiAgb3B0aW9uc1xuIgoiICAgIEEgZGljdCBvYmplY3QgdGhhdCBjb250YWlucyBhZHZhbmNlZCBjb21wcmVzc2lvbiBwYXJhbWV0ZXJzLlxuIgoiICB6c3RkX2RpY3RcbiIKIiAgICBBIFpzdGREaWN0IG9iamVjdCwgYSBwcmUtdHJhaW5lZCBac3RhbmRhcmQgZGljdGlvbmFyeS5cbiIKIlxuIgoiVGhyZWFkLXNhZmUgYXQgbWV0aG9kIGxldmVsLiBGb3Igb25lLXNob3QgY29zZXJ0KHYgPT0gJl9QeV9TSU5HTEVUT04odHVwbGVfZW1wdHkpKTsKI2VuZGlmCiAgICAgICAgLyogVGhlIGVtcHR5IHR1cGxlIGlzIHN0YXRpY2FsbHkgYWxsb2NhdGVkIHNvIHdlIG5ldmVyCiAgICAgICAgICAgcmVzaXplIGl0IGluLXBsYWNlLiAqLwogICAgICAgIFB5X0RFQ1JFRih2KTsKICAgICAgICAqcHYgPSBQeVR1cGxlX05ldyhuZXdzaXplKTsKICAgICAgICByZXR1cm4gKnB2ID09IE5VTEwgPyAtMSA6IDA7CiAgICB9CgogICAgaWYgKF9QeU9iamVjdF9HQ19JU19UUkFDS0VEKHYpKSB7CiAgICAgICAgX1B5T2JqZWN0X0dDX1VOVFJBQ0sodik7CiAgICB9CiNpZmRlZiBQeV9UUkFDRV9SRUZTCiAgICBfUHlfRm9yZ2V0UmVmZXJlbmNlKChQeU9iamVjdCAqKSB2KTsKI2VuZGlmCiAgICAvKiBERUNSRUYgaXRlbXMgZGVsZXRlZCBieSBzaHJpbmthZ2UgKi8KICAgIGZvciAoaSA9IG5ld3NpemU7IGkgPCBvbGRzaXoKdGVzdF9zZXRhbGxvY2F0b3JzKFB5TWVtQWxsb2NhdG9yRG9tYWluIGRvbWFpbikKewogICAgUHlPYmplY3QgKnJlcyA9IE5VTEw7CiAgICBjb25zdCBjaGFyICplcnJvcl9tc2c7CiAgICBhbGxvY19ob29rX3QgaG9vazsKCiAgICBtZW1zZXQoJmhvb2ssIDAsIHNpemVvZihob29rKSk7CgogICAgUHlNZW1BbGxvY2F0b3JFeCBhbGxvYzsKICAgIGFsbG9jLmN0eCA9ICZob29rOwogICAgYWxsb2MubWFsbG9jID0gJmhvb2tfbWFsbG9jOwogICAgYWxsb2MuY2FsbG9jID0gJmhvb2tfY2FsbG9jOwogICAgYWxsb2MucmVhbGxvYyA9ICZob29rX3JlYWxsb2M7CiAgICBhbGxvYy5mcmVlID0gJmhvb2tfZnJlZTsKICAgIFB5TWVtX0dldEFsbG9jYXRvcihkb21haW4sICZob29rLmFsbG9jKTsKICAgIFB5TWVtX1NldEFsbG9jYXRvcihkb21haW4sICZhbGxvYyk7CgogICAgLyogbWFsbG9jLCByZWFsbG9jLCBmcmVlICovCnVkZSA8dGltZS5oPgoKCnN0YXRpYyB2b2lkCmVycl9leGl0KGNvbnN0IGNoYXIgKm1zZykKewogICAgZnByaW50ZihzdGRlcnIsICIlc1xuIiwgbXNnKTsKICAgIGV4aXQoMSk7Cn0KCnN0YXRpYyBtcGRfdCAqCm5ld19tcGQodm9pZCkKewogICAgbXBkX3QgKnggPSBtcGRfcW5ldygpOwogICAgaWYgKHggPT0gTlVMTCkgewogICAgICAgIGVycl9leGl0KCJvdXQgb2YgbWVtb3J5Iik7CiAgICB9CgogICAgcmV0dXJuIHg7Cn0KCi8qIE5vbnNlbnNlIHZlcnNpb24gb2YgZXNjYXBlLXRpbWUgYWxnb3JpdGhtIGZvciBjYWxjdWxhdGluZyBhIG1hbmRlbGJyb3QKICogc2V0LiBKdXN0IGZvciBiZW5jaG1hcmtpbmcuICovCnN0YXRpYyB2b2lkCmNvbG9yX3BvaW50KG1wZF90ICp4MCwgbXBkX3QgKnkwLCBsb25nIG1heGl0ZXIsIG1wZF9jb250ZXh0X3QgKmN0eCkKewogICAgbXBkX3QgKngsICp5LCAqc3FfeCwgKnNxX3k7CiAgCn0KCgppbnQKX1B5VGltZV9PYmplY3RUb1RpbWV2YWwoUHlPYmplY3QgKm9iaiwgdGltZV90ICpzZWMsIGxvbmcgKnVzZWMsCiAgICAgICAgICAgICAgICAgICAgICAgIF9QeVRpbWVfcm91bmRfdCByb3VuZCkKewogICAgcmV0dXJuIHB5dGltZV9vYmplY3RfdG9fZGVub21pbmF0b3Iob2JqLCBzZWMsIHVzZWMsIFNFQ19UT19VUywgcm91bmQpOwp9CgoKUHlUaW1lX3QKX1B5VGltZV9Gcm9tU2Vjb25kcyhpbnQgc2Vjb25kcykKewogICAgLyogZW5zdXJlIHRoYXQgaW50ZWdlciBvdmVyZmxvdyBjYW5ub3QgaGFwcGVuLCBpbnQgdHlwZSBzaG91bGQgaGF2ZSAzMgogICAgICAgYml0cywgd2hlcmVhcyBQeVRpbWVfdCB0eXBlIGhhcyBhdCBsZWFzdCA2NCBiaXRzIChTRUNfVE9fTlMgdGFrZXMgMzAKICAgICAgIGJpdHMpLiAqLwogICAgc3RhdGljX2Fzc2VydChJTlRfTUFYIDw9IFB5VGltZV9NQVggLyBTRUNfVE9fTlMsICJQOSwgMHg3YSwgMHg1YiwgMHg1YywgMHg1ZCwgMHg1ZSwgMHg1ZiwKICAgIDB4NjAsIDB4NjEsIDB4NjIsIDB4NjMsIDB4NjQsIDB4NjUsIDB4NjYsIDB4NjcsCiAgICAweDY4LCAweDY5LCAweDZhLCAweDZiLCAweDZjLCAweDZkLCAweDZlLCAweDZmLAogICAgMHg3MCwgMHg3MSwgMHg3MiwgMHg3MywgMHg3NCwgMHg3NSwgMHg3NiwgMHg3NywKICAgIDB4NzgsIDB4NzksIDB4N2EsIDB4N2IsIDB4N2MsIDB4N2QsIDB4N2UsIDB4N2YsCiAgICAweDgwLCAweDgxLCAweDgyLCAweDgzLCAweDg0LCAweDg1LCAweDg2LCAweDg3LAogICAgMHg4OCwgMHg4OSwgMHg4YSwgMHg4YiwgMHg4YywgMHg4ZCwgMHg4ZSwgMHg4ZiwKICAgIDB4OTAsIDB4OTEsIDB4OTIsIDB4OTMsIDB4OTQsIDB4OTUsIDB4OTYsIDB4OTcsCiAgICAweDk4LCAweDk5LCAweDlhLCAweDliLCAweDljLCAweDlkLCAweDllLCAweDlmLAogICAgMHhhMCwgMHhhZCBpbiBvYm1hbGxvYy5jKSwgaWYgV0lUSF9QWU1BTExPQyBpcwplbmFibGVkLiAgSW4gYWRkaXRpb24sIGEgc3BlY2lhbCBkZWJ1Z2dpbmcgYWxsb2NhdG9yIGlzIHVzZWQgaWYgUHlfREVCVUcKbWFjcm8gaXMgYWxzbyBkZWZpbmVkLgoKSW4gY2FzZSBhIHNwZWNpZmljIGZvcm0gb2YgbWVtb3J5IG1hbmFnZW1lbnQgaXMgbmVlZGVkIChmb3IgZXhhbXBsZSwgaWYgeW91Cm11c3QgdXNlIHRoZSBwbGF0Zm9ybSBtYWxsb2MgaGVhcChzKSwgb3Igc2hhcmVkIG1lbW9yeSwgb3IgQysrIGxvY2FsIHN0b3JhZ2Ugb3IKb3BlcmF0b3IgbmV3KSwgeW91IG11c3QgZmlyc3QgYWxsb2NhdGUgdGhlIG9iamVjdCB3aXRoIHlvdXIgY3VzdG9tIGFsbG9jYXRvciwKdGhlbiBwYXNzIGl0cyBwb2ludGVyIHRvIFB5T2JqZWN0X3tJbml0LCBJbml0VmFyfSBmb3IgZmlsbGluZyBpbiBpdHMgUHl0aG9uLQpzcGVjaWZpYyBmaWVsZHM6ICByZWZlLS0tLQojaWZkZWYgX01TQ19WRVIKI3ByYWdtYSB3YXJuaW5nKGRpc2FibGU6NjI1MCkgICAvLyBzdXBwcmVzcyB3YXJuaW5nIGNhbGxpbmcgVmlydHVhbEZyZWUgd2l0aG91dCBNRU1fUkVMRUFTRSAoZm9yIGRlY29tbWl0KQojZW5kaWYKCmludCBfbWlfcHJpbV9jb21taXQodm9pZCogYWRkciwgc2l6ZV90IHNpemUsIGJvb2wqIGlzX3plcm8pIHsKICAqaXNfemVybyA9IGZhbHNlOwogIC8qCiAgLy8gemVybydpbmcgb25seSBoYXBwZW5zIG9uIGFuIGluaXRpYWwgY29tbWl0Li4uIGJ1dCBjaGVja2luZyB1cGZyb250IHNlZW1zIGV4cGVuc2l2ZS4uCiAgX01FTU9SWV9CQVNJQ19JTkZPUk1BVElPTiBtZW1pbmZvOyBfbWlfbWVtemVyb192YXIobWVtaW5mbyk7CiAgaWYgKFZpcnR1YWxRdWVyeShhZGRyLCAmbWVtaW5mbywgc2l6ZSkgPiAwKSB7CiAgICBpZiAoKG1lbWluZm8uU3RhdGUgJiBNRU1fQ09NTUlUKSA9PSBURVNUX0lOVEVSTkFMX0NfQVBJCiAgIC8vIGdoLTEzNTkwNjogQ2hlY2sgZm9yIGNvbXBpbGVyIHdhcm5pbmdzIGluIHRoZSBpbnRlcm5hbCBDIEFQSQojICBpbmNsdWRlICJpbnRlcm5hbC9weWNvcmVfYmFja29mZi5oIgojICBpbmNsdWRlICJpbnRlcm5hbC9weWNvcmVfZnJhbWUuaCIKI2VuZGlmCgojaWZuZGVmIE1PRFVMRV9OQU1FCiMgIGVycm9yICJNT0RVTEVfTkFNRSBtYWNybyBtdXN0IGJlIGRlZmluZWQiCiNlbmRpZgoKI2RlZmluZSBfU1RSKE5BTUUpICNOQU1FCiNkZWZpbmUgU1RSKE5BTUUpIF9TVFIoTkFNRSkKClB5RG9jX1NUUlZBUihfdGVzdGNwcGV4dF9hZGRfZG9jLAoiYWRkKHgsIHkpXG4iCiJcbiIKIlJldHVybiB0aGUgc3VtIG9mIHR3byBpbnRlZ2VyczogeCArIHkuIik7CgpzdGF0aWMgUHlPYmplY3QgKgpfdGVzdGNwcGV4dF9hZGQoUHlPYmplY3QgKlB5X1VOVVNFRChtb2R1bGUpLCBQeXVsZSwgcGF0dGVybiwgZmxhZ3MsIGNvZGUsIGdyb3VwcywgZ3JvdXBpbmRleCwgaW5kZXhncm91cCk7CgpleGl0OgogICAgcmV0dXJuIHJldHVybl92YWx1ZTsKfQoKUHlEb2NfU1RSVkFSKF9zcmVfdGVtcGxhdGVfX2RvY19fLAoidGVtcGxhdGUoJG1vZHVsZSwgcGF0dGVybiwgdGVtcGxhdGUsIC8pXG4iCiItLVxuIgoiXG4iCiJcbiIKIlxuIgoiICB0ZW1wbGF0ZVxuIgoiICAgIEEgbGlzdCBjb250YWluaW5nIGludGVybGVhdmVkIGxpdGVyYWwgc3RyaW5ncyAoc3RyIG9yIGJ5dGVzKSBhbmQgZ3JvdXBcbiIKIiAgICBpbmRpY2VzIChpbnQpLCBhcyByZXR1cm5lZCBieSByZS5fcGFyc2VyLnBhcnNlX3RlbXBsYXRlKCk6XG4iCiIgICAgICAgIFtsaXRlcmFsMSwgZ3JvdXAxLCAuLi4sIGxpdGVyYWxOLCBncm91cE5dIik7CgojZGVmaW5lIF9TUkVfVEVNUExBVEVfTUVUSE9EREVGICAgIFwKICAgIHsidGVtcGxhdGUiLCBfemVvZihmbG9hdCkgPT0gNCkgewogICAgICAgICAgICBjb25zdCBmbG9hdCB5ID0gMTY3MTE5MzguMDsKICAgICAgICAgICAgaWYgKG1lbWNtcCgmeSwgIlx4NGJceDdmXHgwMVx4MDIiLCA0KSA9PSAwKQogICAgICAgICAgICAgICAgcmV0dXJuIElFRUVfNzU0X0ZMT0FUX0JFOwogICAgICAgICAgICBpZiAobWVtY21wKCZ5LCAiXHgwMlx4MDFceDdmXHg0YiIsIDQpID09IDApCiAgICAgICAgICAgICAgICByZXR1cm4gSUVFRV83NTRfRkxPQVRfTEU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBVTktOT1dOX0ZPUk1BVDsKCiAgICBjYXNlICdkJzoKICAgICAgICBpZiAoc2l6ZW9mKGRvdWJsZSkgPT0gOCkgewogICAgICAgICAgICBjb25zdCBkb3VibGUgeCA9IDkwMDYxMDQwNzE4MzI1ODEuMDsKICAgICAgICAgICAgaWYgKG1lbWNtcCgmeCwgIlx4NDNceDNmXHhmZlx4MDFceDAyXHgwM1x4MDRceDA1IiwgOCkgPT0gICYmIG9wdGlvbiA8IF9taV9vcHRpb25fbGFzdCk7CiAgaWYgKG9wdGlvbiA8IDAgfHwgb3B0aW9uID49IF9taV9vcHRpb25fbGFzdCkgcmV0dXJuIDA7CiAgbWlfb3B0aW9uX2Rlc2NfdCogZGVzYyA9ICZvcHRpb25zW29wdGlvbl07CiAgbWlfYXNzZXJ0KGRlc2MtPm9wdGlvbiA9PSBvcHRpb24pOyAgLy8gaW5kZXggc2hvdWxkIG1hdGNoIHRoZSBvcHRpb24KICBpZiBtaV91bmxpa2VseShkZXNjLT5pbml0ID09IFVOSU5JVCkgewogICAgbWlfb3B0aW9uX2luaXQoZGVzYyk7CiAgfQogIHJldHVybiBkZXNjLT52YWx1ZTsKfQoKbWlfZGVjbF9ub2Rpc2NhcmQgbG9uZyBtaV9vcHRpb25fZ2V0X2NsYW1wKG1pX29wdGlvbl90IG9wdGlvbiwgbG9uZyBtaW4sIGxvbmcgbWF4KSB7CiAgbG9uZyB4ID0gbWlfb3B0aW9uX2dldChvcHRpb24pOwogIHJldHVybiAoeCA8IG1pbiA/IG1pbiA6ICh4ID4gbWF4ID8gbWF4IDogeCkpOwp9X3QgZGVidWdnZXJfc2NyaXB0X3BhdGhfc2l6ZTsKICAgIH0gZGVidWdnZXJfc3VwcG9ydDsKfSBfUHlfRGVidWdPZmZzZXRzOwoKCiNkZWZpbmUgX1B5X0RlYnVnT2Zmc2V0c19JTklUKGRlYnVnX2Nvb2tpZSkgeyBcCiAgICAuY29va2llID0gZGVidWdfY29va2llLCBcCiAgICAudmVyc2lvbiA9IFBZX1ZFUlNJT05fSEVYLCBcCiAgICAuZnJlZV90aHJlYWRlZCA9IF9QeV9EZWJ1Z19GcmVlX1RocmVhZGVkLCBcCiAgICAucnVudGltZV9zdGF0ZSA9IHsgXAogICAgICAgIC5zaXplID0gc2l6ZW9mKF9QeVJ1bnRpbWVTdGF0ZSksIFwKICAgICAgICAuZmluYWxpemluZyA9IG9mZnNldG9mKF9QeVJ1bnRpbWVTdGF0ZSwgX2ZpbmFsaXppbmcpLCBcCiAgICAgICAgLmludGVycHJldGVyc19oZWFkID0gb2Zmc2V0b2YoX1B5UnVudGltZVN0YXRlLCBpbnRlcnByZXRlcnMuaGVhZCksIFwKICAgIH0sIFwKIGx1bW4gIT0gTE9DQVRJT05fTk9UX0FWQUlMQUJMRSkgewogICAgICAgICAgICBlbmRfY29sdW1uX2RlbHRhID0gZW50cnktPmVuZF9jb2x1bW4gLSBlbnRyeS0+Y29sdW1uOwogICAgICAgIH0KICAgICAgICBwb3MgKz0gZW5jb2RlX3ZhcmludF9pMzIoYnVmICsgcG9zLCBlbmRfY29sdW1uX2RlbHRhKTsKCiAgICAgICAgYnVmW3BvcysrXSA9IGVudHJ5LT5vcGNvZGU7CgogICAgICAgIGlmIChmd3JpdGVfY2hlY2tlZF9hbGxvd190aHJlYWRzKGJ1ZiwgcG9zLCB3cml0ZXItPmZwKSA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KICAgIH0KCiAgICAvKiBGb290ZXI6IHN0cmluZ19jb3VudCg0KSArIGZyYW1lX2NvdW50KDQpICsgZmlsZV9zaXplKDgpICsgY2hlY2tzdW0oMTYpICovCiAgICBmaWxlX29mZnNldF90IGZvb3Rlcl9vZmZzZXQgPSBGVEVMTDY0KHdyaXRlci0+ZnApOwogICAgaWYgKGZvbygpOyBjb25zaWRlciB1c2luZyAiCiAgICAgICAgICAgICJQeU1hcHBpbmdfSGFzS2V5V2l0aEVycm9yKCksICIKICAgICAgICAgICAgIlB5TWFwcGluZ19HZXRPcHRpb25hbEl0ZW0oKSBvciBQeU9iamVjdF9HZXRJdGVtKCkiKTsKICAgICAgICByZXR1cm4gMDsKICAgIH0KICAgIFB5X1hERUNSRUYodmFsdWUpOwogICAgcmV0dXJuIHJjOwp9CgovKiBUaGlzIGZ1bmN0aW9uIGlzIHF1aXRlIHNpbWlsYXIgdG8gUHlTZXF1ZW5jZV9GYXN0KCksIGJ1dCBzcGVjaWFsaXplZCB0byBiZQogICBhIGhlbHBlciBmb3IgUHlNYXBwaW5nX0tleXMoKSwgUHlNYXBwaW5nX0l0ZW1zKCkgYW5kIFB5TWFwcGluZ19WYWx1ZXMoKS4KICovCnN0YXRpYyBQeU9iamVjdCAqCm1ldGhvZF9vdXRwdXRfYXNfbGlzdChQeU9iamVjdCAqbywgUHlPYmplY3QgKm1ldGgpCnsKICAgIFB5T2JqZWN0ICppdCwgKnJlc3VsdCwgKm1ldGhfb3V0cHV0OwoKIGVwZWF0KG13LT5zcV9yZXBlYXQsIHcsIHYpOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBiaW5vcF90eXBlX2Vycm9yKHYsIHcsICIqIik7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0Owp9CgpCSU5BUllfRlVOQyhQeU51bWJlcl9NYXRyaXhNdWx0aXBseSwgbmJfbWF0cml4X211bHRpcGx5LCAiQCIpCkJJTkFSWV9GVU5DKFB5TnVtYmVyX0Zsb29yRGl2aWRlLCBuYl9mbG9vcl9kaXZpZGUsICIvLyIpCkJJTkFSWV9GVU5DKFB5TnVtYmVyX1RydWVEaXZpZGUsIG5iX3RydWVfZGl2aWRlLCAiLyIpCkJJTkFSWV9GVU5DKFB5TnVtYmVyX1JlbWFpbmRlciwgbmJfcmVtYWluZGVyLCAiJSIpCgpQeU9iamVjdCAqClB5TnVtYmVyX1Bvd2VyKFB5T2JqZWN0ICp2LCBQeU9iamVjdCAqdywgUHlPYmplY3QgKnopCnsKICAgIHJldHVybiB0ZXJuYXJ5X29wKHYsIHcsIHosIE5CX1NMT1QobmJfcG93ZXIpLCAiKiogb3IgcG93KCkiKWVybmFscyAqLwogICAgYXNzZXJ0KGxheW91dC0+Yml0c19wZXJfZGlnaXQgPD0gMzIpOwogICAgYXNzZXJ0KGxheW91dC0+ZGlnaXRzX29yZGVyID09IC0xKTsKICAgIGFzc2VydChsYXlvdXQtPmRpZ2l0X2VuZGlhbm5lc3MgPT0gKFBZX0xJVFRMRV9FTkRJQU4gPyAtMSA6IDEpKTsKICAgIGFzc2VydChsYXlvdXQtPmRpZ2l0X3NpemUgPT0gMiB8fCBsYXlvdXQtPmRpZ2l0X3NpemUgPT0gNCk7CgogICAgUHlfc3NpemVfdCBzaXplID0gMSArIChQeV9BQlMobikgLSAxKSAvIG1hcnNoYWxfcmF0aW87CgogICAgYXNzZXJ0KHNpemUgPj0gMSk7CgogICAgaW50IHNob3J0c19pbl90b3BfZGlnaXQgPSAxICsgKFB5X0FCUyhuKSAtIDEpICUgbWFyc2hhbF9yYXRpbzsKICAgIHZvaWQgKmRpZ2l0czsKICAgIFB5TG9uZ1dyaXRlciAqd3JpdGVyID0gUHlMb25nV3JpdGVyX0NyZWF0ZShuIDwgMCwgc2l6ZSwgJmRpZ2l0cyk7Ck5BUElfVklSVFVBTFFVRVJZU0laRV9NRVRIT0RERUYKICAgIF9XSU5BUElfV0FJVE5BTUVEUElQRV9NRVRIT0RERUYKICAgIF9XSU5BUElfV0FJVEZPUk1VTFRJUExFT0JKRUNUU19NRVRIT0RERUYKICAgIF9XSU5BUElfQkFUQ0hFRFdBSVRGT1JNVUxUSVBMRU9CSkVDVFNfTUVUSE9EREVGCiAgICBfV0lOQVBJX1dBSVRGT1JTSU5HTEVPQkpFQ1RfTUVUSE9EREVGCiAgICBfV0lOQVBJX1dSSVRFRklMRV9NRVRIT0RERUYKICAgIF9XSU5BUElfR0VUQUNQX01FVEhPRERFRgogICAgX1dJTkFQSV9HRVRPRU1DUF9NRVRIT0RERUYKICAgIF9XSU5BUElfR0VURklMRVRZUEVfTUVUSE9EREVGCiAgICBfV0lOQVBJX19NSU1FVFlQRVNfUkVBRF9XSU5ET1dTX1JFR0lTVFJZX01FVEhPRERFRgogICAgX1dJTkFQSV9ORUVEQ1VSUkVOVERJUkVDVE9SWUZPUkVYRVBBVEhfTUVUSE9EREVGCiAgICBfV0lOQVBJX0NPUFlGSUxFMl9NRVRIZXIpIC0KICAgICAgICBzaXplb2YocmRiLT5Nb3VudFBvaW50UmVwYXJzZUJ1ZmZlci5QYXRoQnVmZmVyKSArCiAgICAgICAgLyogVHdvICsxJ3MgZm9yIE5VTCB0ZXJtaW5hdG9ycy4gKi8KICAgICAgICAocHJlZml4X2xlbiArIHByaW50X2xlbiArIDEgKyBwcmludF9sZW4gKyAxKSAqIHNpemVvZihXQ0hBUik7CiAgICByZGIgPSAoX1B5X1BSRVBBUlNFX0RBVEFfQlVGRkVSKVB5TWVtX1Jhd0NhbGxvYygxLCByZGJfc2l6ZSk7CiAgICBpZiAocmRiID09IE5VTEwpCiAgICAgICAgZ290byBjbGVhbnVwOwoKICAgIHJkYi0+UmVwYXJzZVRhZyA9IElPX1JFUEFSU0VfVEFHX01PVU5UX1BPSU5UOwogICAgcmRiLT5SZXBhcnNlRGF0YUxlbmd0aCA9IHJkYl9zaXplIC0gX1B5X1JFUEFSU0VfREFUQV9CVUZGRVJfSEVBREVSX1NJWkU7CiAgICByZGItPk1vdW50UG9pbnRSZXBhcnNlQnVmZmVyLlN1YnN0aXR1dGVOYW1lT2Zmc2V9OwoKClB5RG9jX1NUUlZBUihtb2R1bGVfZG9jLAoiU19JRk1UXzogZmlsZSB0eXBlIGJpdHNcblwKU19JRkRJUjogZGlyZWN0b3J5XG5cClNfSUZDSFI6IGNoYXJhY3RlciBkZXZpY2VcblwKU19JRkJMSzogYmxvY2sgZGV2aWNlXG5cClNfSUZSRUc6IHJlZ3VsYXIgZmlsZVxuXApTX0lGSUZPOiBmaWZvIChuYW1lZCBwaXBlKVxuXApTX0lGTE5LOiBzeW1ib2xpYyBsaW5rXG5cClNfSUZTT0NLOiBzb2NrZXQgZmlsZVxuXApTX0lGRE9PUjogZG9vclxuXApTX0lGUE9SVDogZXZlbnQgcG9ydFxuXApTX0lGV0hUOiB3aGl0ZW91dFxuXApcbiIKCiJTX0lTVUlEOiBzZXQgVUlEIGJpdFxuXApTX0lTR0lEOiBzZXQgR0lEIGJpdFxuXApTX0VORk1UOiBmaWxlIGxvY2tpbmcgZW5mb3JjZW1lbnRcblwKU19JU1ZUWDogc3RpY2t5IGJpdFxuXApTX0lSRUFEOiBVbml4IFY3IHN5bm9ueW0gZm9yIFNfSVJVU1JcblwKU19JV1JJVEU6IFVkTG9uZ19Db252ZXJ0ZXIoYXJnc1s2XSwgJmZsYWdzKSkgewogICAgICAgIGdvdG8gZXhpdDsKICAgIH0KICAgIHJldHVybl92YWx1ZSA9IF9vdmVybGFwcGVkX092ZXJsYXBwZWRfVHJhbnNtaXRGaWxlX2ltcGwoKE92ZXJsYXBwZWRPYmplY3QgKilzZWxmLCBTb2NrZXQsIEZpbGUsIG9mZnNldCwgb2Zmc2V0X2hpZ2gsIGNvdW50X3RvX3dyaXRlLCBjb3VudF9wZXJfc2VuZCwgZmxhZ3MpOwoKZXhpdDoKICAgIHJldHVybiByZXR1cm5fdmFsdWU7Cn0KClB5RG9jX1NUUlZBUihfb3ZlcmxhcHBlZF9PdmVybGFwcGVkX0Nvbm5lY3ROYW1lZFBpcGVfX2RvY19fLAoiQ29ubmVjdE5hbWVkUGlwZSgkc2VsZiwgaGFuZGxlLCAvKVxuIgoiLS1cbiIKIlxuIgoiU3RhcnQgb3ZlcmxhcHBlZCB3YWl0IGZvciBhIGNsaWVudCB0byBjb25uZWN0LiIpOwoKI2RlZmluZSBfT1ZFUkxBUFBFRF9PVkVSTEFQUEVEX0NPTk5FQ1ROQU1FRFBJUEVQVCkgPyBSRUQgOiBCTEFDSzsKICAgIGZwcmludGYob3V0LCAiICAgICAgICA8dHI+PHRkIHBvcnQ9XCJpJWRcIiBib3JkZXI9XCIxXCIgY29sb3I9XCIlc1wiID4lcyBvcDA9JSIgUFJJdTY0ICI8L3RkPjwvdHI+XG4iLCBpLCBjb2xvciwgb3BuYW1lLCBpbnN0LT5vcGVyYW5kMCk7CiNlbmRpZgp9CgpzdGF0aWMgYm9vbAppc19zdG9wKF9QeVVPcEluc3RydWN0aW9uIGNvbnN0ICppbnN0KQp7CiAgICB1aW50MTZfdCBiYXNlX29wY29kZSA9IF9QeVVvcF9VbmNhY2hlZFtpbnN0LT5vcGNvZGVdOwogICAgcmV0dXJuIChiYXNlX29wY29kZSA9PSBfRVhJVF9UUkFDRSB8fCBiYXNlX29wY29kZSA9PSBfREVPUFQgfHwgYmFzZV9vcGNvZGUgPT0gX0pVTVBfVE9fVE9QKTsKfQoKCi8qIFdyaXRlcyB0aGUgbm9kZSBhbmQgb3V0Z29pbmcgZWRnZXMgZm9yIGEgc2luZ2xlIHRyYWNlbGV0IGluIGdyYXBodml6IGZvcm1hdC4KICogRWFuZyByZWN1cnNpb25MZXZlbDsKfSBQcm9maWxlclN1YkVudHJ5OwoKLyogcmVwcmVzZW50cyBhIGZ1bmN0aW9uIG9yIHVzZXIgZGVmaW5lZCBibG9jayAqLwp0eXBlZGVmIHN0cnVjdCBfUHJvZmlsZXJFbnRyeSB7CiAgICByb3RhdGluZ19ub2RlX3QgaGVhZGVyOwogICAgUHlPYmplY3QgKnVzZXJPYmo7IC8qIFB5Q29kZU9iamVjdCwgb3IgYSBkZXNjcmlwdGl2ZSBzdHIgZm9yIGJ1aWx0aW5zICovCiAgICBQeVRpbWVfdCB0dDsgLyogdG90YWwgdGltZSBpbiB0aGlzIGVudHJ5ICovCiAgICBQeVRpbWVfdCBpdDsgLyogaW5saW5lIHRpbWUgaW4gdGhpcyBlbnRyeSAobm90IGluIHN1YmNhbGxzKSAqLwogICAgbG9uZyBjYWxsY291bnQ7IC8qIGhvdyBtYW55IHRpbWVzIHRoaXMgd2FzIGNhbGxlZCAqLwogICAgbG9uZyByZWN1cnNpdmVjYWxsY291bnQ7IC8qIGhvdyBtYW55IHRpbWVzIGNhbGxlZCByZWN1cnNpdmVseSAqLwppbnQKbWF0Y2hjaGVjayhyZWdtYXRjaF90KiBtYXRjaCwgaW50IG5tYXRjaCwgaW50IG5zdWIsIGNoYXIqIGFucywgY2hhciogcmUsIGNoYXIqIHMsIGludCBsZW4sIGludCBmbGFncywgdW5zaWduZWQgbG9uZyB0ZXN0KQp7CgljaGFyKglwOwoJaW50CWk7CglpbnQJbTsKCWludAluOwoKCWlmIChzdHJlcShhbnMsICJPSyIpKQoJCXJldHVybiB0ZXN0ICYgKFRFU1RfQkFTRUxJTkV8VEVTVF9QQVNTfFRFU1RfVkVSSUZZKTsKCWZvciAoaSA9IDAsIHAgPSBhbnM7IGkgPCBubWF0Y2ggJiYgKnA7IGkrKykKCXsKCQlpZiAoKnAgPT0gJ3snKQoJCXsKI2lmZGVmIFJFR19ESVNDSVBMSU5FCgkJCWNoYXIqCXg7CgoJCQlpZiAoISh4ID0gc2ZzdHJ1c2Uoc3RhdGUuZGlzYy5zcCkpKQoJCQkJYmFkKCJvdXQgb2Ygc3BhY2UgW2Rpc2NpcGxpbmUgc3RyaW5nXVxuIiwgTmlMLCBOaUwsIDAsIDApOwoJCQlpZiAoc3RyY21wKHAsIHgpKQppdGggb25seSBpdHMgZmlyc3QgY2hhcmFjdGVyIGNhcGl0YWxpemVkIChBU0NJSSlcblwKYW5kIHRoZSByZXN0IGxvd2VyLWNhc2VkLiIpOwoKdm9pZApfUHlfYnl0ZXNfY2FwaXRhbGl6ZShjaGFyICpyZXN1bHQsIGNvbnN0IGNoYXIgKnMsIFB5X3NzaXplX3QgbGVuKQp7CiAgICBpZiAobGVuID4gMCkgewogICAgICAgICpyZXN1bHQgPSBQeV9UT1VQUEVSKCpzKTsKICAgICAgICBfUHlfYnl0ZXNfbG93ZXIocmVzdWx0ICsgMSwgcyArIDEsIGxlbiAtIDEpOwogICAgfQp9CgoKUHlEb2NfU1RSVkFSX3NoYXJlZChfUHlfc3dhcGNhc2VfX2RvY19fLAoiQi5zd2FwY2FzZSgpIC0+IGNvcHkgb2YgQlxuXApcblwKUmV0dXJuIGEgY29weSBvZiBCIHdpdGggdXBwZXJjYXNlIEFTQ0lJIGNoYXJhY3RlcnMgY29udmVydGVkXG5cCnRvIGxvd2VyY2FzZSBBU0NJSSBhbmQgdmljZSB2ZXJzYS4iKTsKCnZvaWQKX1B5X2J5dGVzX3N3YXBlbm1haW4sIHNpemVvZihNX3Rlc3RfZnJvemVubWFpbil9LAogICAgICAgIHswLCAwLCAwfSAgIC8vIHNlbnRpbmVsCiAgICB9OwoKICAgIGNoYXIqIGFyZ3ZbXSA9IHsKICAgICAgICAiLi9hcmd2MCIsCiAgICAgICAgIi1FIiwKICAgICAgICAiYXJnMSIsCiAgICAgICAgImFyZzIiLAogICAgfTsKICAgIFB5SW1wb3J0X0Zyb3plbk1vZHVsZXMgPSBmcm96ZW5fbW9kdWxlczsKICAgIHJldHVybiBQeV9Gcm96ZW5NYWluKFB5X0FSUkFZX0xFTkdUSChhcmd2KSwgYXJndik7Cn0KI2VuZGlmICAvLyAhTVNfV0lORE9XUwoKc3RhdGljIGludCB0ZXN0X3JlcGVhdGVkX2luaXRfYW5kX2luaXR0YWIodm9pZCkKewogICAgLy8gYnBvLTQ0NDQxOiBQeV9SdW5NYWluKCkgbXVzdCByZXNldCBQeUltcG9ydF9Jbml0dGFiIGF0IGV4aXQuCiAgICAvLyBJdCBtdXN0IGJlIHBvc3NpYmxlIHRvIGNhbGwgUHlJbXBvcnRfQXBwZW5kSW5pdHRoYXQgY3N1bSA+PSAxLjAsIHdlIGhhdmU6CiAgICBsbyoqMiA8PSAyKiotNTQgPCAyKiotNTMgPT0gMS8yKnVscCgxLjApIDw9IHVscChjc3VtKS8yClNpbmNlIGxvKioyIGlzIGxlc3MgdGhhbiAxLzIgdWxwKGNzdW0pLCB3ZSBoYXZlIGNzdW0rbG8qbG8gPT0gY3N1bS4KClRvIG1pbmltaXplIGxvc3Mgb2YgaW5mb3JtYXRpb24gZHVyaW5nIHRoZSBhY2N1bXVsYXRpb24gb2YgZnJhY3Rpb25hbAp2YWx1ZXMsIGVhY2ggdGVybSBoYXMgYSBzZXBhcmF0ZSBhY2N1bXVsYXRvci4gIFRoaXMgYWxzbyBicmVha3MgdXAKc2VxdWVudGlhbCBkZXBlbmRlbmNpZXMgaW4gdGhlIGlubmVyIGxvb3Agc28gdGhlIENQVSBjYW4gbWF4aW1pemUKZmxvYXRpbmctcG9pbnQgdGhyb3VnaHB1dC4gWzRdICBPbiBhbiBBcHBsZSBNMSBNYXgsIGh5cG90KCp2ZWMpCnRha2VzIG9ubHkgMy4zMyDCtXNlYyB3aGVuIGxlbih2ZWMpID09IDEwMDAuCgogICAxNDM5NzIwNDA3LjMxMTcyMTY3MzY2MzIyMzA3Mjc5NDkxMjM5Mzk3MTU0ODU3ODY3NzIsCiAgICAyNDg4NzQ1NTcuODYyMDU0MTU2NTExNDYwMzg2NDEzMjI5NDIzMjE2MzIxMjUxMjc4MDEsCiAgICAzMTQyNjQxNS41ODU0MDAxOTQzODA2MTQyMzE2MjgzMTgyMDUzNjI4NzQ2ODQ5ODc2NDAsCiAgICAyODc2MzcwLjYyODkzNTM3MjQ0MTIyNTQwOTA1MTYyMDg0OTYxMzU5OTExNDUzNzg3NjgsCiAgICAxODYwNTYuMjY1Mzk1MjIzNDk1MDQwMjk0OTg5NzE2MDQ1Njk5MjgyMjA3ODQyMzYzMjgsCiAgICA4MDcxLjY3MjAwMjM2NTgxNjIxMDYzODAwMjkwMjI3MjI1MDYxMzgyMTg1MTYzMjUwMjQsCiAgICAyMTAuODI0Mjc3NzUxNTc5MzQ1ODcyNTA5NzMzOTIwNzEzMzYyNzExNjY5Njk1ODAyOTEsCiAgICAyLjUwNjYyODI3NDYzMTAwMDI3MDE2NDkwODE3NzEzMzgzNzMzODYyNjQzMTA3OTM0MDgKfTsKCi8qIGRlbm9udF90IGQ7CgogICAgYSA9IChhID49IG0pID8gYSAtIG0gOiBhOwogICAgYiA9IChiID49IG0pID8gYiAtIG0gOiBiOwoKICAgIGQgPSBhIC0gYjsKICAgIGQgPSAoYSA8IGIpID8gZCArIG0gOiBkOwoKICAgIHJldHVybiBkOwp9CgovKgogKiBSZWR1Y2UgZG91YmxlIHdvcmQgbW9kdWxvIG0uCiAqIFJlc3RyaWN0aW9uczogbSAhPSAwCiAqIEFDTDIgcHJvb2Y6IHVtb2Rhcml0aC5saXNwOiBzZWN0aW9uIGR3LXJlZHVjZQogKi8Kc3RhdGljIGlubGluZSBtcGRfdWludF90CmR3X3JlZHVjZShtcGRfdWludF90IGhpLCBtcGRfdWludF90IGxvLCBtcGRfdWludF90IG0pCnsKICAgIG1wZF91aW50X3QgcjEsIHIyLCB3OwoKICAgIF9tcGRfZGl2X3dvcmQoJncsICZyMSwgaGksIG0pOwogICAgX21wZF9kaXZfd29yZHMoJncsICZyMiwgcjEsIGxvLCBtKTsKCiAgICByZXR1cm4gcjI7Cn0KCi8qCiAqIFN1YnRyYWN0IGRvdWJQeUNmZ0J1aWxkZXJfRnJlZShnKTsKICAgIFB5SW5zdHJ1Y3Rpb25TZXF1ZW5jZV9GaW5pKCZvcHRpbWl6ZWRfaW5zdHJzKTsKICAgIHJldHVybiBjbzsKfQoKLyogUmV0YWluZWQgZm9yIEFQSSBjb21wYXRpYmlsaXR5LgogKiBPcHRpbWl6YXRpb24gaXMgbm93IGRvbmUgaW4gX1B5Q2ZnX09wdGltaXplQ29kZVVuaXQgKi8KClB5T2JqZWN0ICoKUHlDb2RlX09wdGltaXplKFB5T2JqZWN0ICpjb2RlLCBQeU9iamVjdCogUHlfVU5VU0VEKGNvbnN0cyksCiAgICAgICAgICAgICAgICBQeU9iamVjdCAqUHlfVU5VU0VEKG5hbWVzKSwgUHlPYmplY3QgKlB5X1VOVVNFRChsbm90YWJfb2JqKSkKewogICAgcmV0dXJuIFB5X05ld1JlZihjb2RlKTsKfQovKgogKiBAYXV0aG9yIELDqW7DqWRpa3QgVHJhbgogKgogKiBJbXBsZW1lbnQgdGhlIEhNQUMgYWxnb3JpdGhtIGFzIGRlc2NyaWJlZCBieSBSRkMgMjEwNCB1c2luZyBIQUNMKi5PTkU7CgogICAgcHdydCA9IG11bHRpYnl0ZWNvZGVjX2VuY29kZShzZWxmLT5jb2RlYywgJnNlbGYtPnN0YXRlLAogICAgICAgICAgICAgICAgICAgIHNlbGYtPnBlbmRpbmcsIE5VTEwsIHNlbGYtPmVycm9ycywKICAgICAgICAgICAgICAgICAgICBNQkVOQ19GTFVTSCB8IE1CRU5DX1JFU0VUKTsKICAgIC8qIHNvbWUgcGVuZGluZyBidWZmZXIgY2FuIGJlIHRydW5jYXRlZCB3aGVuIFVuaWNvZGVFbmNvZGVFcnJvciBpcwogICAgICogcmFpc2VkIG9uICdzdHJpY3QnIG1vZGUuIGJ1dCwgJ3Jlc2V0JyBtZXRob2QgaXMgZGVzaWduZWQgdG8KICAgICAqIHJlc2V0IHRoZSBwZW5kaW5nIGJ1ZmZlciBvciBzdGF0ZXMgc28gZmFpbGVkIHN0cmluZyBzZXF1ZW5jZQogICAgICogb3VnaHQgdG8gYmUgbWlzc2VkICovCiAgICBQeV9DTEVBUihzZWxmLT5wZW5kaW5nKTsKICAgIGlmIChwd3J0ID09IDY0X3QgcmVtb3ZlX2dsb2JhbHNfaW5jb3JyZWN0X2tleXM7CiAgICB1aW50NjRfdCBlcnJvcl9pbl9vcGNvZGVbUFlTVEFUU19NQVhfVU9QX0lEICsgMV07CiAgICAvLyBKSVQgbWVtb3J5IHN0YXRzCiAgICB1aW50NjRfdCBqaXRfdG90YWxfbWVtb3J5X3NpemU7CiAgICB1aW50NjRfdCBqaXRfY29kZV9zaXplOwogICAgdWludDY0X3Qgaml0X3RyYW1wb2xpbmVfc2l6ZTsKICAgIHVpbnQ2NF90IGppdF9kYXRhX3NpemU7CiAgICB1aW50NjRfdCBqaXRfcGFkZGluZ19zaXplOwogICAgdWludDY0X3Qgaml0X2ZyZWVkX21lbW9yeV9zaXplOwogICAgdWludDY0X3QgdHJhY2VfdG90YWxfbWVtb3J5X2hpc3RbX1B5X1VPUF9ISVNUX1NJWkVdOwp9IE9wdGltaXphdGlvblN0YXRzOwoKdHlwZWRlZiBzdHJ1Y3QgX3JhcmVfZXZlbnRfc3RhdHMgewogICAgLyogU2V0dGluZyBhbiBvYmplY3QncyBjbGFzcywgb2JqLl9fY2xhc3NfX2tlMmJfYmxha2UyX3BhcmFtcyAqcCA9IGtleS5mc3Q7CiAgdWludDhfdCBrazEgPSBwLT5rZXlfbGVuZ3RoOwogIHVpbnQ4X3Qgbm4gPSBwLT5kaWdlc3RfbGVuZ3RoOwogIGJvb2wgbGFzdF9ub2RlID0gYmxvY2tfc3RhdGUudGhkOwogIEhhY2xfSGFzaF9CbGFrZTJiX2luZGV4CiAgaTEgPSB7IC5rZXlfbGVuZ3RoID0ga2sxLCAuZGlnZXN0X2xlbmd0aCA9IG5uLCAubGFzdF9ub2RlID0gbGFzdF9ub2RlIH07CiAgTGliX0ludFZlY3Rvcl9JbnRyaW5zaWNzX3ZlYzI1NiAqaCA9IGJsb2NrX3N0YXRlLmYzLnNuZDsKICB1aW50MzJfdCBrazIwID0gKHVpbnQzMl90KWkxLmtleV9sZW5ndGg7CiAgdWludDhfdCAqa18xID0ga2V5LnNuZDsKICBpZiAoIShrazIwID09IDBVKSkKICB7CiAgICB1aW50OF90ICpzdWJfYiA9IGJ1ZiArIGtrMjA7CiAgICBtZW1zZXQoc3ViX2IsIDBVLCAoMTI4VSAtIGtrMjApICogc2lyc29yIiwgImFyZ3VtZW50IDEiLCAoY2xpbmljX3N0YXRlKCktPkNvbm5lY3Rpb25UeXBlKS0+dHBfbmFtZSwgUHlUdXBsZV9HRVRfSVRFTShhcmdzLCAwKSk7CiAgICAgICAgZ290byBleGl0OwogICAgfQogICAgY29ubmVjdGlvbiA9IChweXNxbGl0ZV9Db25uZWN0aW9uICopUHlUdXBsZV9HRVRfSVRFTShhcmdzLCAwKTsKICAgIHJldHVybl92YWx1ZSA9IHB5c3FsaXRlX2N1cnNvcl9pbml0X2ltcGwoKHB5c3FsaXRlX0N1cnNvciAqKXNlbGYsIGNvbm5lY3Rpb24pOwoKZXhpdDoKICAgIHJldHVybiByZXR1cm5fdmFsdWU7Cn0KClB5RG9jX1NUUlZBUihweXNxbGl0ZV9jdXJzb3JfZXhlY3V0ZV9fZG9jX18sCiJleGVjdXRlKCRzZWxmLCBzcWwsIHBhcmFtZXRlcnM9KCksIC8pXG4iCiItLVxuIgoiXG4iCiJFeGVjdXRlcyBhbiBTUUwgc3RhdGVtZW50LiIpOwoKI2RlZmluZSBQWVNRTElURV9DVVJTT1JfRVhFQ1VURV9NRVRjdGVkICE9IE5VTEwpOwogICAgUHlPU19zbnByaW50Zihtc2didWYsIGJ1ZnNpemUsCiAgICAgICAgICAgICAgICAgICJtdXN0IGJlICUuNTBzLCBub3QgJS41MHMgb2YgbGVuZ3RoICV6ZCIsCiAgICAgICAgICAgICAgICAgIGV4cGVjdGVkLCB3aGF0LCBzaXplKTsKICAgIHJldHVybiBtc2didWY7Cn0KCiNkZWZpbmUgQ09OVl9VTklDT0RFICIodW5pY29kZSBjb252ZXJzaW9uIGVycm9yKSIKCi8qIENvbnZlcnQgYSBub24tdHVwbGUgYXJndW1lbnQuICBSZXR1cm4gTlVMTCBpZiBjb252ZXJzaW9uIHdlbnQgT0ssCiAgIG9yIGEgc3RyaW5nIHdpdGggYSBtZXNzYWdlIGRlc2NyaWJpbmcgdGhlIGZhaWx1cmUuICBUaGUgbWVzc2FnZSBpcwogICBmb3JtYXR0ZWQgYXMgIm11c3QgYmUgPGRlc2lyZWQgdHlwZT4sIG5vdCA8YWN0dWFsIHR5cGU+Ii4KICAgV2hlbiBmYWlsaW5nLCBhbiBleGNlcHRpb24gbWF5IG9yIG1heSBub3RlX3QgYXJnc19sZW5ndGgpCi8qW2NsaW5pYyBlbmQgZ2VuZXJhdGVkIGNvZGU6IG91dHB1dD03MWU2NzZmMTg3MGI1YTdlIGlucHV0PTE4ZWFkZjRjNmVhYWI2MTNdKi8KewogICAgcmV0dXJuIHBhY2tfYXJndW1lbnRzXzJwb3NfdmFycG9zKGEsIGIsIGFyZ3MsIGFyZ3NfbGVuZ3RoKTsKfQoKCi8qW2NsaW5pYyBpbnB1dF0KQGRpc2FibGUgZmFzdGNhbGwKQGNsYXNzbWV0aG9kCl90ZXN0Y2xpbmljLlRlc3RDbGFzcy5wb3Nvbmx5X3JlcV9vcHRfdmFycG9zX2FycmF5X25vX2Zhc3RjYWxsCgogICAgYTogb2JqZWN0CiAgICBiOiBvYmplY3QgPSBGYWxzZQogICAgLwogICAgKmFyZ3M6IGFycmF5CgpbY2xpbmljIHN0YXJ0IGdlbmVyYXRlZCBjb2RlXSovCgpzdGF0aWMgUHlPYmplY3QgKgpfdGVzdGNsaW5pY19UZXN0Q2xhc3NfcG9zb25seV9yZXFfb3B0X3ZhcnBvc19hcnJheV9ub19mYXN0Y2FsbF9pbXBsKFB5VHl0IGlzIGxhdGVyIG92ZXJ3cml0dGVuIGJ5IHRoZSBtc2FuCgkgICBsaWJyYXJ5LiAgQXZvaWQgdGhpcyBwcm9ibGVtIGJ5IGZvcmNpbmcgYSBjYWxsIHRvIG1hbGxvYwoJICAgaGVyZSwgYmVmb3JlIHdlIGV2ZXIgY2FsbCBtYWxsb2MuCgoJICAgVGhpcyBpcyBvbmx5IHJlcXVpcmVkIGZvciB0aGUgbWVtb3J5IHNhbml0aXplciwgc28gaXQncwoJICAgdW5mb3J0dW5hdGUgdGhhdCB3ZSBhbHdheXMgcnVuIGl0LiAgSXQgc2hvdWxkIGJlIHBvc3NpYmxlCgkgICB0byByZW1vdmUgdGhpcyB3aGVuIHdlIG5vIGxvbmdlciBjYXJlIGFib3V0IHZlcnNpb25zIG9mCgkgICBjbGFuZyBiZWZvcmUgMy44LiAgVGhlIHRlc3QgZm9yIHRoaXMgaXMKCSAgIG1pc2MvY2dvL3Rlc3RzYW5pdGl6ZXJzLgoKCSAgIEdDQyB3b3JrcyBoYXJkIHRvIGVsaW1pbmF0ZSBhIHNlZW1pbmdseSB1bm5lY2Vzc2FyeSBjYWxsIHRvCgkgICBtYWxsb2lkKSBteV9xc29ydCh2b2lkICpiYXNlLCBzaXplX3QgbnVtLCBzaXplX3Qgd2lkdGgsIGludCgqY29tcGFyZSkoY29uc3Qgdm9pZCosIGNvbnN0IHZvaWQqKSkKewogICAgcXNvcnQoYmFzZSwgbnVtLCB3aWR0aCwgY29tcGFyZSk7Cn0KCkVYUE9SVChpbnQgKikgX3Rlc3RmdW5jX2FpOChpbnQgYVs4XSkKewogICAgcmV0dXJuIGE7Cn0KCkVYUE9SVCh2b2lkKSBfdGVzdGZ1bmNfdihpbnQgYSwgaW50IGIsIGludCAqcHJlc3VsdCkKewogICAgKnByZXN1bHQgPSBhICsgYjsKfQoKRVhQT1JUKGludCkgX3Rlc3RmdW5jX2lfYmhpbGZkKHNpZ25lZCBjaGFyIGIsIHNob3J0IGgsIGludCBpLCBsb25nIGwsIGZsb2F0IGYsIGRvdWJsZSBkKQp7Ci8qICAgICAgcHJpbnRmKCJfdGVzdGZ1bmNfaV9iaGlsZmQgZ290ICVkICVkICVkICVsZCAlZiAlZlxuIiwKICAgICAgICAgICAgICAgYiwgaCwgaSwgbCwgZiwgZCk7CiovCiAgbnB1dD04NjRhNmY1OWI3NjEyM2IyXSovCgovKgogKiBUaGVyZSBpcyBubyBjbG9zZWQtZm9ybSBzb2x1dGlvbiB0byB0aGUgaW52ZXJzZSBDREYgZm9yIHRoZSBub3JtYWwKICogZGlzdHJpYnV0aW9uLCBzbyB3ZSB1c2UgYSByYXRpb25hbCBhcHByb3hpbWF0aW9uIGluc3RlYWQ6CiAqIFdpY2h1cmEsIE0uSi4gKDE5ODgpLiAiQWxnb3JpdGhtIEFTMjQxOiBUaGUgUGVyY2VudGFnZSBQb2ludHMgb2YgdGhlCiAqIE5vcm1hbCBEaXN0cmlidXRpb24iLiAgQXBwbGllZCBTdGF0aXN0aWNzLiBCbGFja3dlbGwgUHVibGlzaGluZy4gMzcKICogKDMpOiA0NzfigJM0ODQuIGRvaToxMC4yMzA3LzIzNDczMzAuIEpTVE9SIDIzNDczMzAuCiAqLwoKLypbY2xpbmljIGlucHV0XQpfc3RhdGlzdGljcy5fbm9ybWFsX2Rpc3RfaW52X2NkZiAtPiBkb3VibGUKICAgcDogZG91YmxlCiAgIG11OiBkb3VibGUKICAgc2lnbWE6IGRvdSAgICApLAogICAgLnNsb3RzID0gWmxpYkRlY29tcHJlc3Nvcl90eXBlX3Nsb3RzLAp9OwoKUHlEb2NfU1RSVkFSKHpsaWJfbW9kdWxlX2RvY3VtZW50YXRpb24sCiJUaGUgZnVuY3Rpb25zIGluIHRoaXMgbW9kdWxlIGFsbG93IGNvbXByZXNzaW9uIGFuZCBkZWNvbXByZXNzaW9uIHVzaW5nIHRoZVxuIgoiemxpYiBsaWJyYXJ5LCB3aGljaCBpcyBiYXNlZCBvbiBHTlUgemlwLlxuIgoiXG4iCiJhZGxlcjMyKHN0cmluZ1ssIHN0YXJ0XSkgLS0gQ29tcHV0ZSBhbiBBZGxlci0zMiBjaGVja3N1bS5cbiIKImFkbGVyMzJfY29tYmluZShhZGxlcjEsIGFkbGVyMiwgbGVuMiwgLykgLS0gQ29tYmluZSB0d28gQWRsZXItMzIgY2hlY2tzdW1zLlxuIgoiY29tcHJlc3MoZGF0YVssIGxldmVsXSkgLS0gQ29tcHJlc3MgZGF0YSwgd2l0aCBjb21wcmVzc2lvbiBsZXZlbCAwLTkgb3IgLTEuXG4iCiJjb21wcmVzc29iaihbbGV2ZWxbLCAuLl9fCiMgIHByYWdtYSBjbGFuZyBkaWFnbm9zdGljIHBvcAojIGVuZGlmCiNlbmRpZiAvKiBBRl9CVEggKi8KCi8qIFdpbmRvd3MgJ3N1cHBvcnRzJyBDTVNHX0xFTiwgYnV0IGRvZXMgbm90IGZvbGxvdyB0aGUgUE9TSVggc3RhbmRhcmQKICogaW50ZXJmYWNlIGF0IGFsbCwgc28gdGhlcmUgaXMgbm8gcG9pbnQgaW5jbHVkaW5nIHRoZSBjb2RlIHRoYXQKICogYXR0ZW1wdHMgdG8gdXNlIGl0LgogKi8KIyBpZmRlZiBQeVNvY2tldF9CVUlMRElOR19TT0NLRVQKIyAgdW5kZWYgQ01TR19MRU4KIyBlbmRpZgojIGluY2x1ZGUgPHdzMnRjcGlwLmg+Ci8qIFZDNiBpcyBzaGlwcGVkIHdpdGggb2xkIHBsYXRmb3JtIGhlYWRlcnMsIGFuZCBkb2VzIG5vdCBoYXZlIE1TVGNwSVAuaAogKiBTZXBhcmF0ZSBTREtzIGhhdmUgYWxsIHRoZSBmdW5jdGlvbnMgd2Ugd2FudCwgYnV0IG9sZGVyIG9uZXMgZG9uJ3QgaGF2ZQogKiBhbnkgdmVycyghX1B5X2NvbnZlcnRfb3B0aW9uYWxfdG9fc3NpemVfdChhcmdzWzBdLCAmbnVtX2J5dGVzKSkgewogICAgICAgIGdvdG8gZXhpdDsKICAgIH0Kc2tpcF9vcHRpb25hbDoKICAgIFB5X0JFR0lOX0NSSVRJQ0FMX1NFQ1RJT04oc2VsZik7CiAgICByZXR1cm5fdmFsdWUgPSBtbWFwX21tYXBfcmVhZF9pbXBsKChtbWFwX29iamVjdCAqKXNlbGYsIG51bV9ieXRlcyk7CiAgICBQeV9FTkRfQ1JJVElDQUxfU0VDVElPTigpOwoKZXhpdDoKICAgIHJldHVybiByZXR1cm5fdmFsdWU7Cn0KClB5RG9jX1NUUlZBUihtbWFwX21tYXBfZmluZF9fZG9jX18sCiJmaW5kKCRzZWxmLCB2aWV3LCBzdGFydD1Ob25lLCBlbmQ9Tm9uZSwgLylcbiIKIi0tXG4iCiJcbiIpOwoKI2RlZmluZSBNTUFQX01NQVBfRklORF9NRVRIT0RERUYgICAgXAogICAgeyJmaW5kIiwgX1B5Q0Z1bmN0aW9uX0NBU1QobW1hcF9tbWFwX2ZpbmQpLCBNZiAoZmFzdGFyZ3NbM10pIHsKICAgICAgICBjb250ZXh0ID0gZmFzdGFyZ3NbM107CiAgICAgICAgaWYgKCEtLW5vcHRhcmdzKSB7CiAgICAgICAgICAgIGdvdG8gc2tpcF9vcHRpb25hbF9rd29ubHk7CiAgICAgICAgfQogICAgfQogICAgZWFnZXJfc3RhcnQgPSBQeU9iamVjdF9Jc1RydWUoZmFzdGFyZ3NbNF0pOwogICAgaWYgKGVhZ2VyX3N0YXJ0IDwgMCkgewogICAgICAgIGdvdG8gZXhpdDsKICAgIH0Kc2tpcF9vcHRpb25hbF9rd29ubHk6CiAgICByZXR1cm5fdmFsdWUgPSBfYXN5bmNpb19UYXNrX19faW5pdF9fX2ltcGwoKFRhc2tPYmogKilzZWxmLCBjb3JvLCBsb29wLCBuYW1lLCBjb250ZXh0LCBlYWdlcl9zdGFydCk7CgpleGl0OgogICAgcmV0dXJuIHJldHVybl92YWx1ZTsKfQoKI2lmICFkZWZpbmVkKF9hc3luY2lvX1Rhc2tfX2xvZ19kZXN0cm95X3BlbmRpbmdfRE9DU1RSKQojICBkZWZpbmUgX2FzeWV4IGludG8gYXJndiBhcnJheSAgICovCmNvbnN0IHdjaGFyX3QgKl9QeU9TX29wdGFyZyA9IE5VTEw7ICAgLyogb3B0aW9uYWwgYXJndW1lbnQgICAgICAgKi8KCnN0YXRpYyBjb25zdCB3Y2hhcl90ICpvcHRfcHRyID0gTCIiOwoKLyogUHl0aG9uIGNvbW1hbmQgbGluZSBzaG9ydCBhbmQgbG9uZyBvcHRpb25zICovCgojZGVmaW5lIFNIT1JUX09QVFMgTCJiQmM6ZEVoaUltOk9QcVJzU3R1dlZXOnhYOj8iCgpzdGF0aWMgY29uc3QgX1B5T1NfTG9uZ09wdGlvbiBsb25nb3B0c1tdID0gewogICAgLyogbmFtZSwgaGFzX2FyZywgdmFsICh1c2VkIGluIHN3aXRjaCBpbiBpbml0Y29uZmlnLmMpICovCiAgICB7TCJjaGVjay1oYXNoLWJhc2VkLXB5Y3MiLCAxLCAwfSwKICAgIHtMImhlbHAtYWxsIiwgMCwgMX0sCiAgICB7TCJoZWxwLWVudiIsIDAsIDJ9LAogICAge0wiaGVscC14b3B0aW9ucyIsIDAsIDN9LAogIHVybiBpbW1lZGlhdGVseSBpZiB0aGUgc291bmQgZHJpdmVyIGlzIGJ1c3lcbiIgLy8gV2l0aG91dCBhbnkgZXJyb3JzCiJTTkRfQVBQTElDQVRJT04gLSBzb3VuZCBpcyBhbiBhcHBsaWNhdGlvbi1zcGVjaWZpYyBhbGlhcyBpbiB0aGUgcmVnaXN0cnkuXG4iCiJTTkRfU0VOVFJZIC0gVHJpZ2dlcnMgYSBTb3VuZFNlbnRyeSBldmVudCB3aGVuIHRoZSBzb3VuZCBpcyBwbGF5ZWQuXG4iCiJTTkRfU1lOQyAtIFBsYXkgdGhlIHNvdW5kIHN5bmNocm9ub3VzbHksIGRlZmF1bHQgYmVoYXZpb3IuXG4iCiJTTkRfU1lTVEVNIC0gQXNzaWduIHNvdW5kIHRvIHRoZSBhdWRpbyBzZXNzaW9uIGZvciBzeXN0ZW0gbm90aWZpY2F0aW9uIHNvdW5kcy5cbiIKIlxuIgoiQmVlcChmcmVxdWVuY3ksIGR1cmF0aW9uKSAtIE1ha2UgYSBiZWVwIHRocm91Z2ggdGhlIFBDIHNwZWFrZXIuXG4iCiJNZXNzYWdlQmVlcCh0eXBlKSAtIENhbGwgV2luZHRoZW4gTVBEX1VJTlRfTUFYIGVsc2UgMCAqLwogICAgbjFfbmVnID0gKGxvICYgKDFVTEw8PDYzKSkgPyBNUERfVUlOVF9NQVggOiAwOwogICAgLyogbl9hZGogPSBpZiBsbyA+PSAyKio2MyB0aGVuIGxvK01QRF9SQURJWCBlbHNlIGxvICovCiAgICBuX2FkaiA9IGxvICsgKG4xX25lZyAmIE1QRF9SQURJWCk7CgogICAgLyogKGgsIGwpID0gaWYgbG8gPj0gMioqNjMgdGhlbiBtJyooaGkrMSkgZWxzZSBtJypoaSAqLwogICAgX21wZF9tdWxfd29yZHMoJmgsICZsLCBtcHJpbWVfcmR4LCBoaS1uMV9uZWcpOwogICAgbCA9IGwgKyBuX2FkajsKICAgIGlmIChsIDwgbl9hZGopIGgrKzsKICAgIHQgPSBoICsgaGk7CiAgICAvKiBBdCB0aGlzIHBvaW50IHQgPT0gcWVzdCwgd2l0aCBxID09IHFlc3Qgb3IgcSA9PSBxZXN0KzE6CiAgICAgKiAgIDEpIDAgPD0gMioqNjQqaGkgKyBsbyAtIHFlc3QqTVBEX1JBRElYIDwgMipNUERfayBpcyB1bmFibGUgdG8KICogdGVsbC4KICoKICogSWYgYHllc19vbmx5YCBpcyB0cnVlLCB0aGVuIHJldHVybiBNQVlCRSBhcyBzb29uIGFzIHdlIGRldGVybWluZQogKiB0aGUgYW5zd2VyIGlzIG5vdCBZRVMuCiAqCiAqIEZvciBiYWNrZ3JvdW5kIGFuZCBkZXRhaWxzIG9uIHRoZSBhbGdvcml0aG0sIHNlZSBVQVggIzE1OgogKiAgIGh0dHBzOi8vd3d3LnVuaWNvZGUub3JnL3JlcG9ydHMvdHIxNS8jRGV0ZWN0aW5nX05vcm1hbGl6YXRpb25fRm9ybXMKICovCnN0YXRpYyBRdWlja2NoZWNrUmVzdWx0CmlzX25vcm1hbGl6ZWRfcXVpY2tjaGVjayhQeU9iamVjdCAqc2VsZiwgUHlPYmplY3QgKmlucHV0LCBib29sIG5mYywgYm9vbCBrLAogICAgICAgICAgICAgICAgICAgICAgICAgYm9vbCB5ZXNfb25seSkKewogICAgLyogVUNEIDMuMi4wIGlzIHJlcXVlc3RlZCwgcXVpY2tjaGVja3MgbXVzdCBiZSBkaXNhYmxlZC4gKi0+c2FfZmFtaWx5ID0gKGFpKS0+YWlfZmFtaWx5ID0gKGdhaV9hZmQpLT5hX2FmO1wKICAgICgoc3RydWN0IHNvY2tpbmV0ICopKGFpKS0+YWlfYWRkciktPnNpX3BvcnQgPSBwb3J0O1wKICAgIHAgPSAoY2hhciAqKSgoYWkpLT5haV9hZGRyKTtcCiAgICBtZW1jcHkocCArIChnYWlfYWZkKS0+YV9vZmYsIChhZGRyKSwgKGdhaV9hZmQpLT5hX2FkZHJsZW4pO1wKfQojZW5kaWYKCiNkZWZpbmUgRVJSKGVycikgeyBlcnJvciA9IChlcnIpOyBnb3RvIGJhZDsgfQoKY29uc3QgY2hhciAqCmdhaV9zdHJlcnJvcihpbnQgZWNvZGUpCnsKICAgIGlmIChlY29kZSA8IDAgfHwgZWNvZGUgPiBFQUlfTUFYKQogICAgICAgIGVjb2RlID0gRUFJX01BWDsKICAgIHJldHVybiBhaV9lcnJsaXN0W2Vjb2RlXTsKfQoKdm9pZApmcmVlYWRkcmluZm8oc3RydWN0IGFkZHJpbmZvICphaSkKewogICAgc3RydWN0IGFkZHJpbmZvICpuZXh0OwoKIGdldF9vc2ZoYW5kbGUoZmQpOwogICAgX1B5X0VORF9TVVBQUkVTU19JUEgKICAgIHJldHVybiAoaGZpbGUgIT0gSU5WQUxJRF9IQU5ETEVfVkFMVUUKICAgICAgICAgICAgJiYgR2V0RmlsZVR5cGUoaGZpbGUpICE9IEZJTEVfVFlQRV9VTktOT1dOKTsKI2Vsc2UKICAgIHN0cnVjdCBzdGF0IHN0OwogICAgcmV0dXJuIChmc3RhdChmZCwgJnN0KSA9PSAwKTsKI2VuZGlmCn0KI2lmbmRlZiBQeV9JTlRFUk5BTF9PUENPREVfVVRJTFNfSAojZGVmaW5lIFB5X0lOVEVSTkFMX09QQ09ERV9VVElMU19ICiNpZmRlZiBfX2NwbHVzcGx1cwpleHRlcm4gIkMiIHsKI2VuZGlmCgojaWZuZGVmIFB5X0JVSUxEX0NPUkUKIyAgZXJyb3IgInRoaXMgaGVhZGVyIHJlcXVpcmVzIFB5X0JVSUxEX0NPUkUgZGVmaW5lIgojZW5kaWYKCiNkZWZpbmUgTUFYX1JFQUxfT1BDT0RFIDI1NAoKI2RlZmluZSBJU19XSVRISU5fT1BDT0RFX1JBTkdFKG9wY3VybiBzdHI7Cn0KCiNpZmRlZiBIQVZFX05PTl9VTklDT0RFX1dDSEFSX1RfUkVQUkVTRU5UQVRJT04KCi8qIENoZWNrIHdoZXRoZXIgY3VycmVudCBsb2NhbGUgdXNlcyBVbmljb2RlIGFzIGludGVybmFsIHdjaGFyX3QgZm9ybS4gKi8KaW50Cl9QeV9Mb2NhbGVVc2VzTm9uVW5pY29kZVdjaGFyKHZvaWQpCnsKICAgIC8qIE9yYWNsZSBTb2xhcmlzIHVzZXMgbm9uLVVuaWNvZGUgaW50ZXJuYWwgd2NoYXJfdCBmb3JtIGZvcgogICAgICAgbm9uLVVuaWNvZGUgbG9jYWxlcyBhbmQgaGVuY2UgbmVlZHMgY29udmVyc2lvbiB0byBVVEYgZmlyc3QuICovCiAgICBjaGFyKiBjb2Rlc2V0ID0gbmxfbGFuZ2luZm8oQ09ERVNFVCk7CiAgICBpZiAoIWNvZGVzZXQpIHsKICAgICAgICByZXR1cm4gMDsKICAgIH0KICAgIC8qIDY0NiByZWZlcnMgdG8gSVNPL0lFQyA2NDYgc3RhbmRhcmQgdGhhdCBjb3JyZXNwb25kcyB0byBBU0NJSSBlbnN1cHBseSBwbGF0Zm9ybS1pbmRlcGVuZGVudCBpbnRlcmZhY2VzIHRvIGJhc2ljCkMgbGFuZ3VhZ2UgJiBsaWJyYXJ5IG9wZXJhdGlvbnMgd2hvc2Ugc3BlbGxpbmdzIHZhcnkgYWNyb3NzIHBsYXRmb3Jtcy4KClBsZWFzZSB0cnkgdG8gbWFrZSBkb2N1bWVudGF0aW9uIGhlcmUgYXMgY2xlYXIgYXMgcG9zc2libGU6ICBieSBkZWZpbml0aW9uLAp0aGUgc3R1ZmYgaGVyZSBpcyB0cnlpbmcgdG8gaWxsdW1pbmF0ZSBDJ3MgZGFya2VzdCBjb3JuZXJzLgoKQ29uZmlnICNkZWZpbmVzIHJlZmVyZW5jZWQgaGVyZToKClNJR05FRF9SSUdIVF9TSElGVF9aRVJPX0ZJTExTCk1lYW5pbmc6ICBUbyBiZSBkZWZpbmVkIGlmZiBpPj5qIGRvZXMgbm90IGV4dGVuZCB0aGUgc2lnbiBiaXQgd2hlbiBpIGlzIGEKICAgICAgICAgIHNpZ25lZCBpbnRlZ3JhbCB0eXBlIGFuZCBpIDwgMC4KVXNlZCBpbjogIFB5X0FSSVRITUVUSUNfUklHSF9EQk1fU0VUREVGQVVMVF9NRVRIT0RERUYKICAgIF9EQk1fREJNX0NMRUFSX01FVEhPRERFRgogICAgeyJfX2VudGVyX18iLCBkYm1fX2VudGVyX18sIE1FVEhfTk9BUkdTLCBOVUxMfSwKICAgIHsiX19leGl0X18iLCAgZGJtX19leGl0X18sIE1FVEhfVkFSQVJHUywgTlVMTH0sCiAgICB7TlVMTCwgIE5VTEx9ICAgICAgICAgICAvKiBzZW50aW5lbCAqLwp9OwoKc3RhdGljIFB5VHlwZV9TbG90IGRibXR5cGVfc3BlY19zbG90c1tdID0gewogICAge1B5X3RwX2RlYWxsb2MsIGRibV9kZWFsbG9jfSwKICAgIHtQeV90cF90cmF2ZXJzZSwgX1B5T2JqZWN0X1Zpc2l0VHlwZX0sCiAgICB7UHlfdHBfbWV0aG9kcywgZGJtX21ldGhvZHN9LAogICAge1B5X3NxX2NvbnRhaW5zLCBkYm1fY29udGFpbnN9LAogICAge1B5X21wX2xlbmd0aCwgZGJtX2xlbmd0aH0sCiAgICB7UHlfbXBfc3Vic2NyaXB0LCBkYm1fc3Vic2NyaXB0fSwKIGFpci4gIEluIGdlbmVyYWwsIGlmIHRoZSBiaXQgY2FuIGJlIGFjcXVpcmVkCiAqIGluc3RhbnRseSwgaXQgaXMsIGVsc2UgdGhlIHBhaXIgaXMgdXNlZCB0byBibG9jayB0aGUgdGhyZWFkIHVudGlsIHRoZQogKiBiaXQgaXMgY2xlYXJlZC4gICAgIDkgTWF5IDE5OTQgdGltQGtzci5jb20KICovCgp0eXBlZGVmIHN0cnVjdCB7CiAgICBjaGFyICAgICAgICAgICAgIGxvY2tlZDsgLyogMD11bmxvY2tlZCwgMT1sb2NrZWQgKi8KICAgIC8qIGEgPGNvbmQsIG11dGV4PiBwYWlyIHRvIGhhbmRsZSBhbiBhY3F1aXJlIG9mIGEgbG9ja2VkIGxvY2sgKi8KICAgIHB0aHJlYWRfY29uZF90ICAgbG9ja19yZWxlYXNlZDsKICAgIHB0aHJlYWRfbXV0ZXhfdCAgbXV0Owp9IHB0aHJlYWRfbG9jazsKCiNkZWZpbmUgQ0hFQ0tfU1RBVFVTKG5hbWUpICBpZiAoc3RhdHVzICE9IDApIHsgcGVycm9yKG5hbWUpOyBlcnJvciA9IDE7IH0KI2R2b2lkKVB5VGltZV9QZXJmQ291bnRlclJhdygmc3RvcCk7CiAgICBzdGF0cy5kdXJhdGlvbiA9IFB5VGltZV9Bc1NlY29uZHNEb3VibGUoc3RvcCAtIHN0YXJ0KTsKICAgIGFkZF9zdGF0cyhnY3N0YXRlLCBnZW5lcmF0aW9uLCAmc3RhdHMpOwogICAgaWYgKFB5RFRyYWNlX0dDX0RPTkVfRU5BQkxFRCgpKSB7CiAgICAgICAgUHlEVHJhY2VfR0NfRE9ORShzdGF0cy51bmNvbGxlY3RhYmxlICsgc3RhdHMuY29sbGVjdGVkKTsKICAgIH0KICAgIGlmIChyZWFzb24gIT0gX1B5X0dDX1JFQVNPTl9TSFVURE9XTikgewogICAgICAgIGludm9rZV9nY19jYWxsYmFjayhnY3N0YXRlLCAic3RvcCIsIGdlbmVyYXRpb24sICZzdGF0cyk7CiAgICB9CiAgICBfUHlFcnJfU2V0UmFpc2VkRXhjZXB0aW9uKHRzdGF0ZSwgZXhjKTsKICAgIEdDX1NUQVRfQUREKGdlbmVyYXRpb24sIG9iamVjdHNfY29sbGVjdGVkLCBzdGF4dCA9IEdDX05FWFQobm9kZSk7CgogICAgX1B5R0NIZWFkX1NFVF9ORVhUKHByZXYsIG5leHQpOwogICAgX1B5R0NIZWFkX1NFVF9QUkVWKG5leHQsIHByZXYpOwoKICAgIG5vZGUtPl9nY19uZXh0ID0gMDsgLyogb2JqZWN0IGlzIG5vdCBjdXJyZW50bHkgdHJhY2tlZCAqLwp9CgovKiBNb3ZlIGBub2RlYCBmcm9tIHRoZSBnYyBsaXN0IGl0J3MgY3VycmVudGx5IGluICh3aGljaCBpcyBub3QgZXhwbGljaXRseQogKiBuYW1lZCBoZXJlKSB0byB0aGUgZW5kIG9mIGBsaXN0YC4gIFRoaXMgaXMgc2VtYW50aWNhbGx5IHRoZSBzYW1lIGFzCiAqIGdjX2xpc3RfcmVtb3ZlKG5vZGUpIGZvbGxvd2VkIGJ5IGdjX2xpc3RfYXBwZW5kKG5vZGUsIGxpc3QpLgogKi8Kc3RhdGljIHZvaWQKZ2NfbGlzdF9tb3ZlKFB5R0NfSGVhZCAqbm9kZSwgUHlHQ19IZWFkICpsaXN0KQp7CiAgICAvKiBVbmxpbmsgZnJvbSBjdXJyZW50IGxpc3QuICogICAweDg3OTUzMWUwLCAgMHhjNWVjZjM3ZCwgIDB4YmRiODg2ZGMsICAweGM5YTYyZjhhLAogICAgICAgMHg0NGMyMGVmMywgIDB4MzM5MGFmN2YsICAweGQ5ZmM2OTBiLCAgMHhjZmFjYWZkMiwKICAgICAgIDB4ZTQ2YmVhODAsICAweGIwMGE1NjMxLCAgMHg5NzRjNTQxYSwgIDB4MzU5ZTk5NjMsCiAgICAgICAweDVjOTcxMDYxLCAgMHhjY2MwN2M3OSwgIDB4MjA5OGQ5ZDYsICAweDkxZGJkMzIwIH07CiAgcXJvdW5kKHksIDIsIDcsIDgsIDEzKTsKICBtaV9hc3NlcnRfaW50ZXJuYWwoYXJyYXlfZXF1YWxzKHksIHlfb3V0LCAxNikpOwoKICBtaV9yYW5kb21fY3R4X3QgciA9IHsKICAgIHsgMHg2MTcwNzg2NSwgMHgzMzIwNjQ2ZSwgMHg3OTYyMmQzMiwgMHg2YjIwNjU3NCwKICAgICAgMHgwMzAyMDEwMCwgMHgwNzA2MDUwNCwgMHgwYjBhMDkwOCwgMHgwZjBlMGQwYywKICAgICAgMHgxMzEyMTExMCwgMHgxNzE2MTUxNCxhcmVuYSk7CnR5cGVfcGFyYW1fdHkgX1B5QVNUX1R5cGVWYXJUdXBsZShpZGVudGlmaWVyIG5hbWUsIGV4cHJfdHkgZGVmYXVsdF92YWx1ZSwgaW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lbm8sIGludCBjb2xfb2Zmc2V0LCBpbnQgZW5kX2xpbmVubywgaW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRfY29sX29mZnNldCwgUHlBcmVuYSAqYXJlbmEpOwoKClB5T2JqZWN0KiBQeUFTVF9tb2Qyb2JqKG1vZF90eSB0KTsKaW50IFB5QXN0X0NoZWNrTW9kZShQeU9iamVjdCAqYXN0LCBpbnQgbW9kZSk7Cm1vZF90eSBQeUFTVF9vYmoybW9kKFB5T2JqZWN0KiBhc3QsIFB5QXJlbmEqIGFyZW5hLCBpbnQgbW9kZSk7CmludCBQeUFTVF9DaGVjayhQeU9iamVjdCogb2JqKTsKCmV4dGVybiBpbnQgX1B5QVNUX1ZhbGlkYXRlKG1vZF90eSk7CgovKiBfUHlBU1RfRXhwckFzVW5pY29kPTEsIE9yPTIgfSBib29sb3BfdHk7Cgp0eXBlZGVmIGVudW0gX29wZXJhdG9yIHsgQWRkPTEsIFN1Yj0yLCBNdWx0PTMsIE1hdE11bHQ9NCwgRGl2PTUsIE1vZD02LCBQb3c9NywKICAgICAgICAgICAgICAgICAgICAgICAgIExTaGlmdD04LCBSU2hpZnQ9OSwgQml0T3I9MTAsIEJpdFhvcj0xMSwgQml0QW5kPTEyLAogICAgICAgICAgICAgICAgICAgICAgICAgRmxvb3JEaXY9MTMgfSBvcGVyYXRvcl90eTsKCnR5cGVkZWYgZW51bSBfdW5hcnlvcCB7IEludmVydD0xLCBOb3Q9MiwgVUFkZD0zLCBVU3ViPTQgfSB1bmFyeW9wX3R5OwoKdHlwZWRlZiBlbnVtIF9jbXBvcCB7IEVxPTEsIE5vdEVxPTIsIEx0PTMsIEx0RT00LCBHdD01LCBHdEU9NiwgSXM9NywgSXNOb3Q9OCwKICAgICAgICAgICAgICAgICAgICAgIEluPTksIE5vdEluPTEwIH0gY21wb3BfdHk7Cgp0eXBlZGVmIHN0cnVjdCBfY29tcHJlaGVuc2lvbiAqY29tcHIgX1B5X2F0b21pY19zdG9yZV9zc2l6ZV9yZWxheGVkKCZkZXN0W2ldLmhhc2gsIHNyY1tpXS5oYXNoKTsKICAgIH0KfQojZW5kaWYKCi8qIHNldF9zd2FwX2JvZGllcygpIHN3aXRjaGVzIHRoZSBjb250ZW50cyBvZiBhbnkgdHdvIHNldHMgYnkgbW92aW5nIHRoZWlyCiAgIGludGVybmFsIGRhdGEgcG9pbnRlcnMgYW5kLCBpZiBuZWVkZWQsIGNvcHlpbmcgdGhlIGludGVybmFsIHNtYWxsdGFibGVzLgogICBTZW1hbnRpY2FsbHkgZXF1aXZhbGVudCB0bzoKCiAgICAgdD1zZXQoYSk7IGEuY2xlYXIoKTsgYS51cGRhdGUoYik7IGIuY2xlYXIoKTsgYi51cGRhdGUodCk7IGRlbCB0CgogICBUaGUgZnVuY3Rpb24gYWx3YXlzIHN1Y2NlZWRzIGFuZCBpdCBsZWF2ZXMgYm90aCBvYmplY3RzIGluIGEgc3RhYmxlIHN0YXRlLgogICBVc2VmdWwgZm9yIG9wZXJhdGlvbnMgdGhhdCB1cGRhdGUgaW4tcGxhY2UgKGJ5IGFsbG93aW5nIGFvbnMgY29sbGFwc2UgdG8gb25seSBhIGhhbmRmdWwgb2YgZGlzdGluY3QgaGFzaCB2YWx1ZXMuICovCgpzdGF0aWMgUHlfdWhhc2hfdApfc2h1ZmZsZV9iaXRzKFB5X3VoYXNoX3QgaCkKewogICAgcmV0dXJuICgoaCBeIDg5ODY5NzQ3VUwpIF4gKGggPDwgMTYpKSAqIDM2NDQ3OTgxNjdVTDsKfQoKLyogTW9zdCBvZiB0aGUgY29uc3RhbnRzIGluIHRoaXMgaGFzaCBhbGdvcml0aG0gYXJlIHJhbmRvbWx5IGNob3NlbgogICBsYXJnZSBwcmltZXMgd2l0aCAiaW50ZXJlc3RpbmcgYml0IHBhdHRlcm5zIiBhbmQgdGhhdCBwYXNzZWQgdGVzdHMKICAgZm9yIGdvb2QgY29sbGlzaW9uIHN0YXRpc3RpY3Mgb24gYSB2YXJpZXR5IG9mIHByb2JsZW1hdGljIGRhdGFzZXRzCiAgIGluY2x1ZGluZyBwb3dlcnNldHMgYW5kIGdyYXBoIHN0cnVjdHVyZXMgKHN1Y2ggYXMgRGF2aWQgRXBwc3RlaW4ncwogICBncmFwaCByZWNpcGVzIGluIExmIC8qIGRlZmluZWQoUFlfT1BFTlNTTF9IQVNfU0hBS0UpICovCgpQeURvY19TVFJWQVIoX2hhc2hsaWJfSEFTSF9uZXdfX2RvY19fLAoibmV3KCRtb2R1bGUsIC8sIG5hbWUsIGRhdGE9YlwnXCcsICosIHVzZWRmb3JzZWN1cml0eT1UcnVlLCBzdHJpbmc9Tm9uZSlcbiIKIi0tXG4iCiJcbiIKIlJldHVybiBhIG5ldyBoYXNoIG9iamVjdCB1c2luZyB0aGUgbmFtZWQgYWxnb3JpdGhtLlxuIgoiXG4iCiJBbiBvcHRpb25hbCBzdHJpbmcgYXJndW1lbnQgbWF5IGJlIHByb3ZpZGVkIGFuZCB3aWxsIGJlXG4iCiJhdXRvbWF0aWNhbGx5IGhhc2hlZC5cbiIKIlxuIgoiVGhlIE1ENSBhbmQgU0hBMSBhbGdvcml0aG1zIGFyZSBhbHdheXMgc3VwcG9ydGVkLiIpOwoKI2RlZmluZSBfSEFTSExJQl9IQVNIX05FV19NRVRIT0RERUYgICAgXAogICAgeyJuZXciLCBfUHlDRnVuY3Rpb25fQ0FTVChfaGFzaGxpYl9IQVNIX25ldyksIE1FUk5fTk9USU1QTEVNRU5URUQ7CiAgICB9CgogICAgd2EgPSAod3JhcHBlcm9iamVjdCAqKWE7CiAgICB3YiA9ICh3cmFwcGVyb2JqZWN0ICopYjsKICAgIGVxID0gKHdhLT5kZXNjciA9PSB3Yi0+ZGVzY3IgJiYgd2EtPnNlbGYgPT0gd2ItPnNlbGYpOwogICAgaWYgKGVxID09IChvcCA9PSBQeV9FUSkpIHsKICAgICAgICBQeV9SRVRVUk5fVFJVRTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIFB5X1JFVFVSTl9GQUxTRTsKICAgIH0KfQoKc3RhdGljIFB5X2hhc2hfdAp3cmFwcGVyX2hhc2goUHlPYmplY3QgKnNlbGYpCnsKICAgIHdyYXBwZXJvYmplY3QgKndwID0gKHdyYXBwZXJvYmplY3QgKilzZWxmOwogICAgUHlfaGFzaF90IHgsIHk7CiAgICB4ID0gUHlPYmplY3RfR2VuZXJpY0hhc2god3AtPnNlbGYpOwogICAgeSA9IFB5X0hhc2hQb2ludGVyKHdwLT5kZXNjcik7CiAgICB4ID0geCBeIHk7CiAgMTYsIDMyLCA2NCwgMTI4LCAyNTYsIDUxMiwgMTAyNCwgIDIwNDgsIDQwOTYsIDgxOTIsIDE2Mzg0LAogICAgMzI3NjgsIDY1NTM2LCAxMzEwNzIsIDI2MjE0NCwgNTI0Mjg4LCAxMDQ4NTc2LCAyMDk3MTUyLCA0MTk0MzA0LCA4Mzg4NjA4LAogICAgMTY3NzcyMTYsIDMzNTU0NDMyLCA2NzEwODg2NCwgMTM0MjE3NzI4LCAyNjg0MzU0NTYsIDUzNjg3MDkxMiwgMTA3Mzc0MTgyNCwKICAgIDIxNDc0ODM2NDhVTEwsIDQyOTQ5NjcyOTZVTEwsIDg1ODk5MzQ1OTJVTEwsIDE3MTc5ODY5MTg0VUxMLCAzNDM1OTczODM2OFVMTCwKICAgIDY4NzE5NDc2NzM2VUxMLCAxMzc0Mzg5NTM0NzJVTEwsIDI3NDg3NzkwNjk0NFVMTCwgNTQ5NzU1ODEzODg4VUxMLAogICAgMTA5OTUxMTYyNzc3NlVMTCwgMjE5OTAyMzI1NTU1MlVMTCwgNDM5ODA0NjUxMTEwNCwgODc5NjA5MzAyMjIwOFVMTCwKICAgIDE3NTkyMTg2MDQ0NDE2VUxMLCAzNTFvYydlZCBtZW1vcnkgZm9yIGJpZ2dlciB0YWJsZXMuCiAgICAgKiBUaGUgdGFibGUgcG9pbnRlciBpcyBuZXZlciBOVUxMIHdoaWNoIHNhdmVzIHVzIGZyb20gcmVwZWF0ZWQKICAgICAqIHJ1bnRpbWUgbnVsbC10ZXN0cy4KICAgICAqLwogICAgc2V0ZW50cnkgKnRhYmxlOwogICAgUHlfaGFzaF90IGhhc2g7ICAgICAgICAgICAgIC8qIE9ubHkgdXNlZCBieSBmcm96ZW5zZXQgb2JqZWN0cyAqLwogICAgUHlfc3NpemVfdCBmaW5nZXI7ICAgICAgICAgIC8qIFNlYXJjaCBmaW5nZXIgZm9yIHBvcCgpICovCgogICAgc2V0ZW50cnkgc21hbGx0YWJsZVtQeVNldF9NSU5TSVpFXTsKICAgIFB5T2JqZWN0ICp3ZWFrcmVmbGlzdDsgICAgICAvKiBMaXN0IG9mIHdlYWsgcmVmZXJlbmNlcyAqLwp9IFB5U2V0T2JqZWN0OwoKI2RlZmluZSBfUHlTZXRfQ0FTVChzbykgXAogICAgKGFzc2VydChQeUFueVNldF9DaGVjayhzbykpLCBfUHkocmV0ICE9IE5VTEwpIHsKICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKZXJyb3I6CiAgICBfT3V0cHV0QnVmZmVyX09uRXJyb3IoJmJ1ZmZlcik7CiAgICByZXR1cm4gTlVMTDsKfQoKI2lmbmRlZiBOREVCVUcKc3RhdGljIGlubGluZSBpbnQKbXRfY29udGludWVfc2hvdWxkX2JyZWFrKFpTVERfaW5CdWZmZXIgKmluLCBaU1REX291dEJ1ZmZlciAqb3V0KQp7CiAgICByZXR1cm4gaW4tPnNpemUgPT0gaW4tPnBvcyAmJiBvdXQtPnNpemUgIT0gb3V0LT5wb3M7Cn0KI2VuZGlmCgpzdGF0aWMgUHlPYmplY3QgKgpjb21wcmVzc19tdF9jb250aW51ZV9sb2NrX2hlbGQoWnN0ZENvbXByZXNzb3IgKnNlbGYsIFB5X2J1ZmZlciAqZGF0YSkKewogICAgYXNzZXJ0KFB5TXV0ZXhfSXNMb2NrZWQoJnNlbGYtPmxvY2spKTsKICAgIFpTVERfaW5CdWZmZXIgaW47CiAgICBaU1REX291dEJ1ZmZlciBvdXQ7CiAgICBfQmxvY2tzT3V0cHVhbWVzX3NhdmVkIiwgcy0+ZnJhbWVzX3NhdmVkLAogICAgICAgICJieXRlc193cml0dGVuIiwgcy0+Ynl0ZXNfd3JpdHRlbiwKICAgICAgICAiZnJhbWVfY29tcHJlc3Npb25fcGN0IiwgY29tcHJlc3Npb25fcmF0aW8KICAgICk7Cn0KClB5T2JqZWN0ICoKYmluYXJ5X3JlYWRlcl9nZXRfc3RhdHMoQmluYXJ5UmVhZGVyICpyZWFkZXIpCnsKICAgIEJpbmFyeVJlYWRlclN0YXRzICpzID0gJnJlYWRlci0+c3RhdHM7CgogICAgdWludDY0X3QgdG90YWxfcmVjb3JkcyA9IHMtPnJlcGVhdF9yZWNvcmRzICsgcy0+ZnVsbF9yZWNvcmRzICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLT5zdWZmaXhfcmVjb3JkcyArIHMtPnBvcF9wdXNoX3JlY29yZHM7CgogICAgcmV0dXJuIFB5X0J1aWxkVmFsdWUoCiAgICAgICAgIntzOkssIHM6SywgczpLLCBzOkssIHM6SywgczpLLCBzOkssIHM6S30iLAogICAgICAgICJyZXBlYWxvbmcgcGF0aF9wb3MgPSAwOwogICAgICAgIHNzY2FuZihsaW5lLCAiJWx4LSUqeCAlKnMgJSpzICUqcyAlKnMgJWxuIiwgJnN0YXJ0LCAmcGF0aF9wb3MpOwoKICAgICAgICBpZiAoIXBhdGhfcG9zKSB7CiAgICAgICAgICAgIC8vIExpbmUgZGlkbid0IG1hdGNoIG91ciBmb3JtYXQgc3RyaW5nLiAgVGhpcyBzaG91bGRuJ3QgYmUKICAgICAgICAgICAgLy8gcG9zc2libGUsIGJ1dCBsZXQncyBiZSBkZWZlbnNpdmUgYW5kIHNraXAgdGhlIGxpbmUuCiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgY2hhciAqcGF0aCA9IGxpbmUgKyBwYXRoX3BvczsKICAgICAgICBpZiAocGF0aFswXSA9PSAnWycgJiYgcGF0aFtzdHJsZW4ocGF0aCktMV0gPT0gJ10nKSB7CiAgICAgICAgICAgIC8vIFNraXAgW2hlYXBdLCBbc3RhY2tdLCBbYW5vbjpjcHl0aG9uOnB5bWFsbG9jXSwgZXRjLgogIHN5cy9zdGF0Lmg+CgojaWYgZGVmaW5lZChfX05ldEJTRF9fKQojaW5jbHVkZSA8c3lzL3BhcmFtLmg+CiNpZiAoTmV0QlNEIDwgMTk5NzEyKQojaW5jbHVkZSA8bmxpc3QuaD4KI2luY2x1ZGUgPGxpbmsuaD4KI2RlZmluZSBkbGVycm9yKCkgImVycm9yIGluIGR5bmFtaWMgbGlua2luZyIKI2VuZGlmCiNlbmRpZiAvKiBOZXRCU0QgKi8KCiNpZmRlZiBIQVZFX0RMRkNOX0gKI2luY2x1ZGUgPGRsZmNuLmg+CiNlbmRpZgoKI2lmIChkZWZpbmVkKF9fT3BlbkJTRF9fKSB8fCBkZWZpbmVkKF9fTmV0QlNEX18pKSAmJiAhZGVmaW5lZChfX0VMRl9fKQojZGVmaW5lIExFQURfVU5ERVJTQ09SRSAiXyIKI2Vsc2UKI2RlZmluZSBMRUFEX1VOREVSU0NPUkUgIiIKI2VuZGlmCgovKiBUaGUgLnNvIGV4dGVuc2lvbiBtb2R1bGUgQUJJIHRhZywgc3VwcGxpZWQgYnkgdGhlIE1ha2VmaWxlIHZpYQogICBNYWtlZmlsZS5wcmUuaW4gYW5pZ25hdG9ycyBsaWtlICdQeVR5cGVfR2VuZXJpY05ldycsIHdpdGggaW1wbGljaXQgY29udmVyc2lvbiB0bwogICAgICAgYSBwb2ludGVyLCBhcmUgdmFsaWQgQzk5IGFkZHJlc3MgY29uc3RhbnRzLgoKICAgICAgIEhvd2V2ZXIsIHRoZSB1bmFyeSAnJicgb3BlcmF0b3IgYXBwbGllZCB0byBhIG5vbi1zdGF0aWMgdmFyaWFibGUKICAgICAgIGxpa2UgJ1B5QmFzZU9iamVjdF9UeXBlJyBpcyBub3QgcmVxdWlyZWQgdG8gcHJvZHVjZSBhbiBhZGRyZXNzCiAgICAgICBjb25zdGFudC4gIENvbXBpbGVycyBtYXkgc3VwcG9ydCB0aGlzIChnY2MgZG9lcyksIE1TVkMgZG9lcyBub3QuCgogICAgICAgQm90aCBjb21waWxlcnMgYXJlIHN0cmljdGx5IHN0YW5kYXJkIGNvbmZvcm1pbmcgaW4gdGhpcyBwYXJ0aWN1bGFyCiAgICAgICBiZWhhdmlvci4KICAgICovCiAgICBOdWxsX1R5cGUudHBfYmFzZSA9ICZQeUJhcwogICBieSBzbGljZS5pbmRpY2VzIGFuZCByYW5nZW9iamVjdCBzbGljaW5nLiAgQXNzdW1lcyB0aGF0IGBsZW5gIGlzIGEKICAgbm9ubmVnYXRpdmUgaW5zdGFuY2Ugb2YgUHlMb25nLiAqLwoKaW50Cl9QeVNsaWNlX0dldExvbmdJbmRpY2VzKFB5U2xpY2VPYmplY3QgKnNlbGYsIFB5T2JqZWN0ICpsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgIFB5T2JqZWN0ICoqc3RhcnRfcHRyLCBQeU9iamVjdCAqKnN0b3BfcHRyLAogICAgICAgICAgICAgICAgICAgICAgICBQeU9iamVjdCAqKnN0ZXBfcHRyKQp7CiAgICBQeU9iamVjdCAqc3RhcnQ9TlVMTCwgKnN0b3A9TlVMTCwgKnN0ZXA9TlVMTDsKICAgIFB5T2JqZWN0ICp1cHBlcj1OVUxMLCAqbG93ZXI9TlVMTDsKICAgIGludCBzdGVwX2lzX25lZ2F0aXZlLCBjbXBfcmVzdWx0OwoKICAgIC8qIENvbnZlcnQgc3RlcCB0byBhbiBpbnRlZ2VyOyByYWlzZSBmb3IgemVyb19FeGNJbmZvQXNPYmplY3QoX1B5WElfZXhjaW5mbyAqaW5mbyk7CgoKdHlwZWRlZiBlbnVtIGVycm9yX2NvZGUgewogICAgX1B5WElfRVJSX05PX0VSUk9SID0gMCwKICAgIF9QeVhJX0VSUl9VTkNBVUdIVF9FWENFUFRJT04gPSAtMSwKICAgIF9QeVhJX0VSUl9PVEhFUiA9IC0yLAogICAgX1B5WElfRVJSX05PX01FTU9SWSA9IC0zLAogICAgX1B5WElfRVJSX0FMUkVBRFlfUlVOTklORyA9IC00LAogICAgX1B5WElfRVJSX01BSU5fTlNfRkFJTFVSRSA9IC01LAogICAgX1B5WElfRVJSX0FQUExZX05TX0ZBSUxVUkUgPSAtNiwKICAgIF9QeVhJX0VSUl9QUkVTRVJWRV9GQUlMVVJFID0gLTcsCiAgICBfUHlYSV9FUlJfRVhDX1BST1BBR0FUSU9OX0ZBSUxVUkUgPSAtOCwKICAgIF9QeVhJX0VSUl9OT1RfU0hBUkVBQkxFID0gLTksCn0gX1B5WElfZXJyY29kZTsKCnR5cGVkZWYgc3RydWN0IHhpX2ZhaWx1cmUgX1B5WElfZmFpbGVydChpIDwgRlVOQ19NQVhfV0FUQ0hFUlMpOwogICAgICAgIGlmIChiaXRzICYgMSkgewogICAgICAgICAgICBQeUZ1bmN0aW9uX1dhdGNoQ2FsbGJhY2sgY2IgPSBpbnRlcnAtPmZ1bmNfd2F0Y2hlcnNbaV07CiAgICAgICAgICAgIC8vIGNhbGxiYWNrIG11c3QgYmUgbm9uLW51bGwgaWYgdGhlIHdhdGNoZXIgYml0IGlzIHNldAogICAgICAgICAgICBhc3NlcnQoY2IgIT0gTlVMTCk7CiAgICAgICAgICAgIGlmIChjYihldmVudCwgZnVuYywgbmV3X3ZhbHVlKSA8IDApIHsKICAgICAgICAgICAgICAgIFB5RXJyX0Zvcm1hdFVucmFpc2FibGUoCiAgICAgICAgICAgICAgICAgICAgIkV4Y2VwdGlvbiBpZ25vcmVkIGluICVzIHdhdGNoZXIgY2FsbGJhY2sgZm9yIGZ1bmN0aW9uICVVIGF0ICVwIiwKICAgICAgICAgICAgICAgICAgICBmdW5jX2V2ZW50X25hbWUoZXZlbnQpLCBmdW5jLT5mdW5jX3F1YWxuYW1lLCBmdW5jKTsKICoKX3NyZV9TUkVfTWF0Y2hfX19kZWVwY29weV9fX2ltcGwoTWF0Y2hPYmplY3QgKnNlbGYsIFB5T2JqZWN0ICptZW1vKQovKltjbGluaWMgZW5kIGdlbmVyYXRlZCBjb2RlOiBvdXRwdXQ9MmI2NTc1NzhlYjAzZjRhMyBpbnB1dD03NzlkMTJhMzFjMmMzMjVlXSovCnsKICAgIHJldHVybiBQeV9OZXdSZWYoc2VsZik7Cn0KClB5RG9jX1NUUlZBUihtYXRjaF9kb2MsCiJUaGUgcmVzdWx0IG9mIHJlLm1hdGNoKCkgYW5kIHJlLnNlYXJjaCgpLlxuXApNYXRjaCBvYmplY3RzIGFsd2F5cyBoYXZlIGEgYm9vbGVhbiB2YWx1ZSBvZiBUcnVlLiIpOwoKUHlEb2NfU1RSVkFSKG1hdGNoX2dyb3VwX2RvYywKImdyb3VwKFtncm91cDEsIC4uLl0pIC0+IHN0ciBvciB0dXBsZS5cblwKICAgIFJldHVybiBzdWJncm91cChzKSBvZiB0aGUgbWF0Y2ggYnkgaW5kaWNlcyBvciBuYW1lcy5cblwKICAgIEZvciAwIHJldHVmb3IgcGF0Y2ggcmVsZWFzZXMgKi8KCi8qIFZlcnNpb24gcGFyc2VkIG91dCBpbnRvIG51bWVyaWMgdmFsdWVzICovCi8qLS1zdGFydCBjb25zdGFudHMtLSovCiNkZWZpbmUgUFlfTUFKT1JfVkVSU0lPTiAgICAgICAgMwojZGVmaW5lIFBZX01JTk9SX1ZFUlNJT04gICAgICAgIDE1CiNkZWZpbmUgUFlfTUlDUk9fVkVSU0lPTiAgICAgICAgMAojZGVmaW5lIFBZX1JFTEVBU0VfTEVWRUwgICAgICAgIFBZX1JFTEVBU0VfTEVWRUxfQUxQSEEKI2RlZmluZSBQWV9SRUxFQVNFX1NFUklBTCAgICAgICA1CgovKiBWZXJzaW9uIGFzIGEgc3RyaW5nICovCiNkZWZpbmUgUFlfVkVSU0lPTiAgICAgICAgICAgICAgIjMuMTUuMGE1KyIKLyotLWVuZCBjb25zdGFudHMtLSovCgoKI2RlZmluZSBfUHlfUEFDS19GVUxMX1ZFUlNJT04oWCwgWSwgWiwgTEVWRUwsIFNFUklBTCkgKCBcCiAgICAoKChYKSAmIDB4ZmYpIDw8IDI0KSB8ICAgICAvKioKIERpZ2VzdCBmdW5jdGlvbi4gVGhpcyBmdW5jdGlvbiBleHBlY3RzIHRoZSBgb3V0cHV0YCBhcnJheSB0byBob2xkCmF0IGxlYXN0IGBkaWdlc3RfbGVuZ3RoYCBieXRlcywgd2hlcmUgYGRpZ2VzdF9sZW5ndGhgIHdhcyBkZXRlcm1pbmVkIGJ5IHlvdXIKY2hvaWNlIG9mIGBtYWxsb2NgIGZ1bmN0aW9uLiBDb25jcmV0ZWx5LCBpZiB5b3UgdXNlZCBgbWFsbG9jYCBvcgpgbWFsbG9jX3dpdGhfa2V5YCwgdGhlbiB0aGUgZXhwZWN0ZWQgbGVuZ3RoIGlzIDMyIGZvciBTLCBvciA2NCBmb3IgQiAoZGVmYXVsdApkaWdlc3QgbGVuZ3RoKS4gSWYgeW91IHVzZWQgYG1hbGxvY193aXRoX3BhcmFtc19hbmRfa2V5YCwgdGhlbiB0aGUgZXhwZWN0ZWQKbGVuZ3RoIGlzIHdoYXRldmVyIHlvdSBjaG9zZSBmb3IgdGhlIGBkaWdlc3RfbGVuZ3RoYCBmaWVsZCBvZiB5b3VyIHBhcmFtZXRlcnMuCkZvciBjb252ZW5pZW5jZSxkZWYgTElCTVBERUNfTlVNQkVSVEhFT1JZX0hfCiNkZWZpbmUgTElCTVBERUNfTlVNQkVSVEhFT1JZX0hfCgoKI2luY2x1ZGUgIm1wZGVjaW1hbC5oIgojaW5jbHVkZSAiY29uc3RhbnRzLmgiCgoKLyogSW50ZXJuYWwgaGVhZGVyIGZpbGU6IGFsbCBzeW1ib2xzIGhhdmUgbG9jYWwgc2NvcGUgaW4gdGhlIERTTyAqLwpNUERfUFJBR01BKE1QRF9ISURFX1NZTUJPTFNfU1RBUlQpCgoKLyogdHJhbnNmb3JtIHBhcmFtZXRlcnMgKi8Kc3RydWN0IGZudF9wYXJhbXMgewogICAgaW50IG1vZG51bTsKICAgIG1wZF91aW50X3QgbW9kdWx1czsKICAgIG1wZF91aW50X3Qga2VybmVsOwogICAgbXBkX3VpbnRfdCB3dGFibGVbXTsKfTsKCgptcGRfdWludF90IF9tcGRfZ2V0a2VybmVsKG1wZF91aW50X3QgbiwgaW50IHNpZ24sIGludCBtb2RudW0pOwpzdHJ1Y3QgZm50X3BhcmFtcyAqX21wZF9pbml0X2ZudF9wYXJhbXMobXBkX1JFRihrd2FyZ3MpOwogICAgUHlfWERFQ1JFRihjcmVhdGUpOwogICAgcmV0dXJuIC0xOwp9CgovLyBXZSBhY2NvbW1vZGF0ZSBiYWNrcG9ydHMgaGVyZS4KI2lmbmRlZiBfUHlfRU1QVFlfU1RSCiMgZGVmaW5lIF9QeV9FTVBUWV9TVFIgJl9QeV9TVFIoZW1wdHkpCiNlbmRpZgoKc3RhdGljIGNvbnN0IGNoYXIgKgpfZm9ybWF0X1RyYWNlYmFja0V4Y2VwdGlvbihQeU9iamVjdCAqdGJleGMpCnsKICAgIFB5T2JqZWN0ICpsaW5lcyA9IFB5T2JqZWN0X0NhbGxNZXRob2QodGJleGMsICJmb3JtYXQiLCBOVUxMKTsKICAgIGlmIChsaW5lcyA9PSBOVUxMKSB7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CiAgICBhc3NlcnQoX1B5X0VNUFRZX1NUUiAhPSBOVUxMKTsKICAgIFB5T2JqZWN0ICpmb3JtYXR0ZWRfb2JqID0gUHlVbmljb2RlX0pvaW4oX1B5X0VNUFRZX1NUUiwgbGluZXMpOwogICAgUHlfREVDUkVGKGxpbmUgICAgIDxlbmNvZGluZz5fZGVjb2RlKGNoYXJfYnVmZmVyX29ialssZXJyb3JzPSdzdHJpY3QnXSkgLT4KICAgICAgICAoVW5pY29kZSBvYmplY3QsIGJ5dGVzIGNvbnN1bWVkKQoKICAgVGhlc2UgPGVuY29kaW5nPnMgYXJlIGF2YWlsYWJsZTogdXRmXzgsIHVuaWNvZGVfZXNjYXBlLAogICByYXdfdW5pY29kZV9lc2NhcGUsIGxhdGluXzEsIGFzY2lpICg3LWJpdCksIG1iY3MgKG9uIHdpbjMyKS4KCgpXcml0dGVuIGJ5IE1hcmMtQW5kcmUgTGVtYnVyZyAobWFsQGxlbWJ1cmcuY29tKS4KCkNvcHlyaWdodCAoYykgQ29ycG9yYXRpb24gZm9yIE5hdGlvbmFsIFJlc2VhcmNoIEluaXRpYXRpdmVzLgoKICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgojaW5jbHVkZSAiUHl0aG9uLmgiCiNpbmNsdWRlICJweWNvcmVfY29kZWNzLmgiIGZvciByZWFkaW5nIHRleHQpLiBGb3IgYmluYXJ5IHJhbmRvbVxuIgoiYWNjZXNzLCB0aGUgbW9kZSBcJ3crYlwnIG9wZW5zIGFuZCB0cnVuY2F0ZXMgdGhlIGZpbGUgdG8gMCBieXRlcywgd2hpbGVcbiIKIlwncitiXCcgb3BlbnMgdGhlIGZpbGUgd2l0aG91dCB0cnVuY2F0aW9uLiBUaGUgXCd4XCcgbW9kZSBpbXBsaWVzIFwnd1wnIGFuZFxuIgoicmFpc2VzIGFuIGBGaWxlRXhpc3RzRXJyb3JgIGlmIHRoZSBmaWxlIGFscmVhZHkgZXhpc3RzLlxuIgoiXG4iCiJQeXRob24gZGlzdGluZ3Vpc2hlcyBiZXR3ZWVuIGZpbGVzIG9wZW5lZCBpbiBiaW5hcnkgYW5kIHRleHQgbW9kZXMsXG4iCiJldmVuIHdoZW4gdGhlIHVuZGVybHlpbmcgb3BlcmF0aW5nIHN5c3RlbSBkb2VzblwndC4gRmlsZXMgb3BlbmVkIGluXG4iCiJiaW5hcnkgbW9kZSAoYXBwZW5kaW5nIFwnYlwnIHRvIHRoZSBtb2RlIGFyZ3VtZW50KSByZXR1cm4gY29udCBiZSBrZXB0IHVuaXF1ZS4KICAgUHlDRl8gY29uc3RhbnRzIGNhbiB1c2UgYml0cyBmcm9tIDB4MDEwMCB0byAweDEwMDAwLgogICBDT19GVVRVUkVfIGNvbnN0YW50cyB1c2UgYml0cyBzdGFydGluZyBhdCAweDIwMDAwLiAqLwojZGVmaW5lIFB5Q0ZfU09VUkNFX0lTX1VURjggIDB4MDEwMAojZGVmaW5lIFB5Q0ZfRE9OVF9JTVBMWV9ERURFTlQgMHgwMjAwCiNkZWZpbmUgUHlDRl9PTkxZX0FTVCAweDA0MDAKI2RlZmluZSBQeUNGX0lHTk9SRV9DT09LSUUgMHgwODAwCiNkZWZpbmUgUHlDRl9UWVBFX0NPTU1FTlRTIDB4MTAwMAojZGVmaW5lIFB5Q0ZfQUxMT1dfVE9QX0xFVkVMX0FXQUlUIDB4MjAwMAojZGVmaW5lIFB5Q0ZfQUxMT1dfSU5DT01QTEVURV9JTlBVVCAweDQwMDAKI2RlZmluZSBQeUNGX09QVElNSVpFRF9BU1QgKDB4ODAwMCB8IFB5Q0ZfT05MWV9BU1QpCiNkZWZpbmUgUHlDRl9DT01QSUxFX01BU0sgKFB5ZW5hbWU6IF90ZXN0c2luZ2xlcGhhc2UuICBUbyBsb2FkIHRoZQpvdGhlcnMgeW91IG11c3QgZG8gc28gbWFudWFsbHkuICBGb3IgZXhhbXBsZToKCmBgYHB5dGhvbgpuYW1lID0gJ190ZXN0c2luZ2xlcGhhc2VfYmFzZV93cmFwcGVyJwpmaWxlbmFtZSA9IF90ZXN0c2luZ2xlcGhhc2UuX19maWxlX18KbG9hZGVyID0gaW1wb3J0bGliLm1hY2hpbmVyeS5FeHRlbnNpb25GaWxlTG9hZGVyKG5hbWUsIGZpbGVuYW1lKQpzcGVjID0gaW1wb3J0bGliLnV0aWwuc3BlY19mcm9tX2ZpbGVfbG9jYXRpb24obmFtZSwgZmlsZW5hbWUsIGxvYWRlcj1sb2FkZXIpCm1vZCA9IGltcG9ydGxpYi5fYm9vdHN0cmFwLl9sb2FkKHNwZWMpCmxvYWRlci5leGVjX21vZHVsZShtb2R1bGUpCnN5cy5tb2R1bGVzW21vZG5hbWVdID0gbW9kdWxlCmBgYAoKKFRoZSBsYXN0IHR3byBsaW5lcyBhcmUganVzdCBmb3IgY29tcGxldGVuZXNzLikKCkhlcmUgZWN0ICpiYXNlX3RwID0gJlB5UmV2ZXJzZWRfVHlwZTsKICAgIFB5T2JqZWN0ICpzZXE7CgogICAgaWYgKCh0eXBlID09IGJhc2VfdHAgfHwgdHlwZS0+dHBfaW5pdCA9PSBiYXNlX3RwLT50cF9pbml0KSAmJgogICAgICAgICFfUHlBcmdfTm9LZXl3b3JkcygicmV2ZXJzZWQiLCBrd2FyZ3MpKSB7CiAgICAgICAgZ290byBleGl0OwogICAgfQogICAgaWYgKCFfUHlBcmdfQ2hlY2tQb3NpdGlvbmFsKCJyZXZlcnNlZCIsIFB5VHVwbGVfR0VUX1NJWkUoYXJncyksIDEsIDEpKSB7CiAgICAgICAgZ290byBleGl0OwogICAgfQogICAgc2VxID0gUHlUdXBsZV9HRVRfSVRFTShhcmdzLCAwKTsKICAgIHJldHVybl92YWx1ZSA9IHJldmVyc2VkX25ld19pbXBsKHR5cGUsIHNlcSk7CgpleGl0OgogICAgcmV0dXJuIHJldHVybl92YWx1ZTsKfQovKltjbGluaWMgZW5kIGdlbmVyYXRlZCBjb2RlOiBvdXRwdXQ9MTU1Y2M5NDgzZDVmOWVhYWx1ZV9zdGFydCA6IHZhbHVlX3N0YXJ0ICsgd2lkdGhdCnN0YXRpYyB2b2lkCnNldF9iaXRzKHVpbnQzMl90ICpsb2MsIHVpbnQ4X3QgbG9jX3N0YXJ0LCB1aW50NjRfdCB2YWx1ZSwgdWludDhfdCB2YWx1ZV9zdGFydCwKICAgICAgICAgdWludDhfdCB3aWR0aCkKewogICAgYXNzZXJ0KGxvY19zdGFydCArIHdpZHRoIDw9IDMyKTsKICAgIHVpbnQzMl90IHRlbXBfdmFsOwogICAgLy8gVXNlIG1lbWNweSB0byBzYWZlbHkgcmVhZCB0aGUgdmFsdWUsIGF2b2lkaW5nIHBvdGVudGlhbCBhbGlnbm1lbnQKICAgIC8vIGlzc3VlcyBhbmQgc3RyaWN0IGFsaWFzaW5nIHZpb2xhdGlvbnMuCiAgICBtZW1jcHkoJnRlbXBfdmFsLCBsb2MsIHNpemVvZih0ZW1wX3ZhbCkpOwogICAgLy8gQ2xlYXIgdGhlIGJpdHMgd2UncmUgYWJvdXQgdG8gcGF0Y2g6CiAgICB0ZW1wX3ZhbCAmPSB+KCgoMVVMTCA8PCB3aWR0aCkgLSAxKSA8PCBsb2NfYXRlX3NfX19zCnsKICBIYWNsX1N0cmVhbWluZ19UeXBlc19vcHRpb25hbCB0YWc7CiAgSGFjbF9TdHJlYW1pbmdfSE1BQ19EZWZpbml0aW9uc190d29fc3RhdGUgdjsKfQpvcHRpb25fX191aW50MzJfdF9fX19IYWNsX0FnaWxlX0hhc2hfc3RhdGVfc19fX19fSGFjbF9BZ2lsZV9IYXNoX3N0YXRlX3NfXzsKCktSTUxfTUFZQkVfVU5VU0VEIHN0YXRpYyBIYWNsX1N0cmVhbWluZ19ITUFDX2FnaWxlX3N0YXRlCiptYWxsb2NfaW50ZXJuYWwoSGFjbF9TdHJlYW1pbmdfSE1BQ19EZWZpbml0aW9uc19pbmRleCBpLCB1aW50OF90ICprZXkpCnsKICBLUk1MX0NIRUNLX1NJWkUoc2l6ZW9mICh1aW50OF90KSwKICAgIGJsb2NrX2xlbihhbGdfb2ZfaW1wbChkZnN0X19IYWNsX0FnaWxlX0hhc2hfaW1wbF91aW50MzJfdChpKSkpKTsKICB1aW50OF90CiAgKmJ1ZiA9CiAgICAodWludDhfdCAqKUtSTUxfSE9TVF9DQUxMT0MoYmxvY3BhZ2VfcHRyX3VuYWxpZ24oc2VnbWVudCwgcGFnZSwgcCkgOiAobWlfYmxvY2tfdCopcCk7CiAgbWlfc3RhdF9mcmVlKHBhZ2UsIGJsb2NrKTsgICAgLy8gc3RhdF9mcmVlIG1heSBhY2Nlc3MgdGhlIHBhZGRpbmcKICBtaV90cmFja19mcmVlX3NpemUoYmxvY2ssIG1pX3BhZ2VfdXNhYmxlX3NpemVfb2YocGFnZSxibG9jaykpOwogIF9taV9mcmVlX2Jsb2NrKHBhZ2UsIGlzX2xvY2FsLCBibG9jayk7Cn0KCi8vIEdldCB0aGUgc2VnbWVudCBkYXRhIGJlbG9uZ2luZyB0byBhIHBvaW50ZXIKLy8gVGhpcyBpcyBqdXN0IGEgc2luZ2xlIGBhbmRgIGluIGFzc2VtYmx5IGJ1dCBkb2VzIGZ1cnRoZXIgY2hlY2tzIGluIGRlYnVnIG1vZGUKLy8gKGFuZCBzZWN1cmUgbW9kZSkgaWYgdGhpcyB3YXMgYSB2YWxpZCBwb2ludGVyLgpzdGF0aWMgaW5saW5lIG1pX3NlZ21lbnRfdCogbWlfY2hlY2tlZF9wdHJfc2VnbWVudChjb25kaWYKI2RlZmluZSBCaWdpbnRfUFJFQUxMT0NfU0laRSBcCiAgICAoKFBSSVZBVEVfTUVNK3NpemVvZihkb3VibGUpLTEpL3NpemVvZihkb3VibGUpKQoKc3RydWN0IF9kdG9hX3N0YXRlIHsKICAgIC8vIHA1cyBpcyBhbiBhcnJheSBvZiBwb3dlcnMgb2YgNSBvZiB0aGUgZm9ybToKICAgIC8vIDUqKigyKiooaSsyKSkgZm9yIDAgPD0gaSA8IEJpZ2ludF9Qb3c1c2l6ZQogICAgc3RydWN0IEJpZ2ludCAqcDVzW0JpZ2ludF9Qb3c1c2l6ZV07CiAgICAvLyBYWFggVGhpcyBzaG91bGQgYmUgZnJlZWQgZHVyaW5nIHJ1bnRpbWUgZmluaS4KICAgIHN0cnVjdCBCaWdpbnQgKmZyZWVsaXN0W0JpZ2ludF9LbWF4KzFdOwogICAgZG91YmxlIHByZWFsbG9jYXRlZFtCaWdpbnRfUFJFQUxMT0NfU0laRV07CiAgICBkb3VibGUgKnByZWFsbG9jYXRlZF9uZXh0Owp9OwoKI2VuZGlmICAvLyAhUHlfVVNJTkdfTUVNT1JZX0RFQlVHR0VSCgphaW5zIHRoZSBzdXBwb3J0IGNvZGUgZm9yIENQeXRob24ncyB1b3BzIG9wdGltaXplci4KICogSXQgYWxzbyBwZXJmb3JtcyBzb21lIHNpbXBsZSBvcHRpbWl6YXRpb25zLgogKiBJdCBwZXJmb3JtcyBhIHRyYWRpdGlvbmFsIGRhdGEtZmxvdyBhbmFseXNpc1sxXSBvdmVyIHRoZSB0cmFjZSBvZiB1b3BzLgogKiBVc2luZyB0aGUgaW5mb3JtYXRpb24gZ2FpbmVkLCBpdCBjaG9vc2VzIHRvIGVtaXQsIG9yIHNraXAgY2VydGFpbiBpbnN0cnVjdGlvbnMKICogaWYgcG9zc2libGUuCiAqCiAqIFsxXSBGb3IgaW5mb3JtYXRpb24gb24gZGF0YS1mbG93IGFuYWx5c2lzLCBwbGVhc2Ugc2VlCiAqIGh0dHBzOi8vY2xhbmcubGx2bS5vcmcvZG9jcy9EYXRhRmxvd0FuYWx5c2lzSW50cm8uaHRtbAogKgogKiAqLwojaW5jbHVkZSAiUHl0aG9uLmgiCiNpbmNsdWRlICJvcGNvZGUuaCIKI2luY2x1ZGUgInB5Y29yZV9kaWN0LmgiCiNiID0gei5pbWFnLCBjID0gdy5yZWFsLCBkID0gdy5pbWFnOwogICAgZG91YmxlIGFjID0gYSpjLCBiZCA9IGIqZCwgYWQgPSBhKmQsIGJjID0gYipjOwogICAgUHlfY29tcGxleCByID0ge2FjIC0gYmQsIGFkICsgYmN9OwoKICAgIC8qIFJlY292ZXIgaW5maW5pdGllcyB0aGF0IGNvbXB1dGVkIGFzIG5hbituYW5qLiAgU2VlIGUuZy4gdGhlIEMxMSwKICAgICAgIEFubmV4IEcuNS4xLCByb3V0aW5lIF9DbXVsdGQoKS4gKi8KICAgIGlmIChpc25hbihyLnJlYWwpICYmIGlzbmFuKHIuaW1hZykpIHsKICAgICAgICBpbnQgcmVjYWxjID0gMDsKCiAgICAgICAgaWYgKGlzaW5mKGEpIHx8IGlzaW5mKGIpKSB7ICAvKiB6IGlzIGluZmluaXRlICovCiAgICAgICAgICAgIC8qICJCb3giIHRoZSBpbmZpbml0eSBhbmQgY2hhbmdlIG5hbnMgaW4gdGhlIG90aGVyIGZhY3RvciB0byAwICovCiAgICAgICAgICAgIGEgPSBjb3B5c2lnbiggPSAyXjEwNiAqIDFlLTI1NiAqLwp9OwovKiBUaGUgZmFjdG9yIG9mIDJeNTMgaW4gdGlueXRlbnNbNF0gaGVscHMgdXMgYXZvaWQgc2V0dGluZyB0aGUgdW5kZXJmbG93ICovCi8qIGZsYWcgdW5uZWNlc3NhcmlseS4gIEl0IGxlYWRzIHRvIGEgc29uZyBhbmQgZGFuY2UgYXQgdGhlIGVuZCBvZiBzdHJ0b2QuICovCiNkZWZpbmUgU2NhbGVfQml0IDB4MTAKI2RlZmluZSBuX2JpZ3RlbnMgNQoKI2RlZmluZSBVTGJpdHMgMzIKI2RlZmluZSBrc2hpZnQgNQojZGVmaW5lIGttYXNrIDMxCgoKc3RhdGljIGludApkc2hpZnQoQmlnaW50ICpiLCBpbnQgcDIpCnsKICAgIGludCBydiA9IGhpMGJpdHMoYi0+eFtiLT53ZHMtMV0pIC0gNDsKICAgIGlmIChwMiA+IDApCiAgICAgICAgcnYgLT0gcDI7CiAgICByZXR1cm4gcnYgJiBrbWFzazsKfQoKLyogc3BlY2lhbCBjYXNlIG9mIEJpZ2ludCBkaXZpc2lvbi4gIFRoZSBxdW90aWVudCB2ZSBhbGwgdW51c2VkIGNvbnN0cyBmcm9tIGNvZGUgb2JqZWN0cykKICAgIFB5dGhvbiAzLjEyYTQgMzUxMyAoQWRkIENBTExfSU5UUklOU0lDXzEgaW5zdHJ1Y3Rpb24sIHJlbW92ZWQgU1RPUElURVJBVElPTl9FUlJPUiwgUFJJTlRfRVhQUiwgSU1QT1JUX1NUQVIpCiAgICBQeXRob24gMy4xMmE0IDM1MTQgKFJlbW92ZSBBU1lOQ19HRU5fV1JBUCwgTElTVF9UT19UVVBMRSwgYW5kIFVOQVJZX1BPU0lUSVZFKQogICAgUHl0aG9uIDMuMTJhNSAzNTE1IChFbWJlZCBqdW1wIG1hc2sgaW4gQ09NUEFSRV9PUCBvcGFyZykKICAgIFB5dGhvbiAzLjEyYTUgMzUxNiAoQWRkIENPTVBBUkVfQU5EX0JSQU5DSCBpbnN0cnVjdGlvbikKICAgIFB5dGhvbiAzLjEyYTUgMzUxNyAoQ2hhbmdlIFlJRUxEX1ZBTFVFIG9wYXJnIHRvIGV4Y2VwdGlvbiBibG9jayBkZXB0aCkKICAgIFB5dGhvbiAzLjEyYTYgMzUxOCAoQWRkIFJFVFVSTl9DT050ID49IDQpIHJldHVybiBmYWxzZTsgIC8vIGdpdmUgdXAgYWZ0ZXIgNCB0cmllcwogICAgICB5aWVsZF9jb3VudCsrOwogICAgICBtaV9hdG9taWNfeWllbGQoKTsgLy8gZGVsYXkgdW50aWwgb3V0c3RhbmRpbmcgTUlfREVMQVlFRF9GUkVFSU5HIGFyZSBkb25lLgogICAgICAvLyB0ZnJlZSA9IG1pX3RmX3NldF9kZWxheWVkKHRmcmVlLCBNSV9OT19ERUxBWUVEX0ZSRUUpOyAvLyB3aWxsIGNhdXNlIENBUyB0byBidXN5IGZhaWwKICAgIH0KICAgIGVsc2UgaWYgKGRlbGF5ID09IG9sZF9kZWxheSkgewogICAgICBicmVhazsgLy8gYXZvaWQgYXRvbWljIG9wZXJhdGlvbiBpZiBhbHJlYWR5IGVxdWFsCiAgICB9CiAgICBlbHNlIGlmICghb3ZlcnJpZGVfbmV2ZXIgJiYgb2xkX2RlbGF5ID09IE1JX05FVkVSX0RFTEFZRURfRlJFRSkgewogICAgICBicmVhazsgLy8gbGVhdmUgbmV2ZXItZGVsYXllZCBmbGFnIHNldHJuIFB5Q29tcGxleF9UeXBlLnRwX2FzX251bWJlci0+bmJfcG93ZXIodiwgdywgeik7CiAgICAgICAgfQogICAgICAgIC8qIGl3IGlzIGFuIGV4YWN0IGludGVnZXIsIGFsYmVpdCBwZXJoYXBzIGEgdmVyeSBsYXJnZQogICAgICAgICAqIG9uZS4gIFJlcGxhY2UgaXYgYnkgaXRzIGFic29sdXRlIHZhbHVlIGFuZCByZW1lbWJlcgogICAgICAgICAqIHRvIG5lZ2F0ZSB0aGUgcG93IHJlc3VsdCBpZiBpdyBpcyBvZGQuCiAgICAgICAgICovCiAgICAgICAgaXYgPSAtaXY7CiAgICAgICAgbmVnYXRlX3Jlc3VsdCA9IERPVUJMRV9JU19PRERfSU5URUdFUihpdyk7CiAgICB9CgogICAgaWYgKGl2ID09IDEuMCkgeyAvKiAxKip3IGlzIDEsIGV2ZW4gMSoqaW5mIGFuZCAxKipuYW4gKi8KICAgICAgICAvKiAoLTEpICoqIGxhcmdlX2ludGVnZXIgYWxzbyBlbmRzIHVwIGhlcmUuICBIZXJlJ3MgYW4KICAgICAgICAgKiBleHRyX1B5X0FERF9QRU5ESU5HX0ZVTEwgLTEKCi8vIEV4cG9ydCBmb3IgJ190ZXN0aW50ZXJuYWxjYXBpJyBzaGFyZWQgZXh0ZW5zaW9uClB5QVBJX0ZVTkMoX1B5X2FkZF9wZW5kaW5nX2NhbGxfcmVzdWx0KSBfUHlFdmFsX0FkZFBlbmRpbmdDYWxsKAogICAgUHlJbnRlcnByZXRlclN0YXRlICppbnRlcnAsCiAgICBfUHlfcGVuZGluZ19jYWxsX2Z1bmMgZnVuYywKICAgIHZvaWQgKmFyZywKICAgIGludCBmbGFncyk7CgojaWZkZWYgSEFWRV9GT1JLCmV4dGVybiBQeVN0YXR1cyBfUHlFdmFsX1JlSW5pdFRocmVhZHMoUHlUaHJlYWRTdGF0ZSAqdHN0YXRlKTsKI2VuZGlmCgovLyBVc2VkIGJ5IHN5cy5jYWxsX3RyYWNpbmcoKQpleHRlcm4gUHlPYmplY3QqIF9QeUV2YWxfQ2FsbFRyYWNpbmcoUHlPYmplY3QgKmZ1bmMsIFB5T2JqZWN0ICphcmdzKTsKCi8vIFVzZWQgYnkgc3lzLmdldF9hc3luY2dlbl9ob29rcygpCmV4IGJ5IHJ0MF9nbyBpbiB0aGUgcnVudGltZSBwYWNrYWdlLgp2b2lkIF9jZ29fc2V0X3N0YWNrbG8oRyAqZywgdWludHB0ciAqcGJvdW5kcykKewoJdWludHB0ciBib3VuZHNbMl07CgoJLy8gcGJvdW5kcyBjYW4gYmUgcGFzc2VkIGluIGJ5IHRoZSBjYWxsZXI7IHNlZSBnY2NfbGludXhfYW1kNjQuYy4KCWlmIChwYm91bmRzID09IE5VTEwpIHsKCQlwYm91bmRzID0gJmJvdW5kc1swXTsKCX0KCgl4X2Nnb19nZXRzdGFja2JvdW5kKHBib3VuZHMpOwoKCWctPnN0YWNrbG8gPSAqcGJvdW5kczsKCgkvLyBTYW5pdHkgY2hlY2sgdGhlIHJlc3VsdHMgbm93LCByYXRoZXIgdGhhbiBnZXR0aW5nIGEKCS8vIG1vcmVzdGFjayBvbiBnMCBjcmFzaC4KCWlmIChnLT5zdGFja2xvID49IGctPnN0YWNraGkpIHsKCQlmcHJpbnRmKHN0ZGVyciwgInJ1bnRpbWUvY2dvOiBiYWQgc3RhY2sgYm91bmRzOiBsbz0lcCBoaT0lcFxuIiwgKHZvZmZlclsyNTZdOyAvKiBOQU1FX01BWExFTiBpbiB1bmljb2RlbmFtZV9kYi5oICovCiAgICBQeV9zc2l6ZV90IGltYXggPSBzdGFydCwgcmVzc2l6ZSA9IDAsIHJlcGxzaXplOwogICAgZm9yICg7IGltYXggPCBlbmQ7ICsraW1heCkgewogICAgICAgIFB5X1VDUzQgYyA9IFB5VW5pY29kZV9SRUFEX0NIQVIob2JqLCBpbWF4KTsKICAgICAgICBpZiAodWNuaGFzaF9jYXBpLT5nZXRuYW1lKGMsIGJ1ZmZlciwgc2l6ZW9mKGJ1ZmZlciksIDEpKSB7CiAgICAgICAgICAgIC8vIElmICdjJyBpcyByZWNvZ25pemVkIGJ5IGdldG5hbWUoKSwgdGhlIGNvcnJlc3BvbmRpbmcgcmVwbGFjZW1lbnQKICAgICAgICAgICAgLy8gaXMgJ1xcJyArICdOJyArICd7JyArIE5BTUUgKyAnfScsIGkuZS4gMSArIDEgKyAxICsgbGVuKE5BTUUpICsgMQogICAgICAgICAgICAvLyBjaGFyYWN0ZXJzLiBGYWlsdXJlcyBvZiBnZXRuYW1lKCkgYXJlIGlnZGxlcihjaGFyICp0ZXh0KQp7CiAgICBjb21wbGV0ZWRfaW5wdXRfc3RyaW5nID0gdGV4dDsKICAgIHJsX2NhbGxiYWNrX2hhbmRsZXJfcmVtb3ZlKCk7Cn0KCnN0YXRpYyBjaGFyICoKcmVhZGxpbmVfdW50aWxfZW50ZXJfb3Jfc2lnbmFsKGNvbnN0IGNoYXIgKnByb21wdCwgaW50ICpzaWduYWwpCnsKICAgIC8vIERlZmluZWQgaW4gUGFyc2VyL215cmVhZGxpbmUuYwogICAgZXh0ZXJuIFB5VGhyZWFkU3RhdGUgKl9QeU9TX1JlYWRsaW5lVFN0YXRlOwoKICAgIGNoYXIgKiBub3RfZG9uZV9yZWFkaW5nID0gIiI7CiAgICBmZF9zZXQgc2VsZWN0c2V0OwoKICAgICpzaWduYWwgPSAwOwojaWZkZWYgSEFWRV9STF9DQVRDSF9TSUdOQUwKICAgIHJsX2NhdGNoX3NpZ25hbHMgPSAwOwojZW5kaWYKCiAgICBybF9jYWxsYmFja19oYW5kbGVyX2luc3RhbGwgKHByb21wdCwgcmxoYW5kbGVyKTsKICAgIEZEX1pFUk8oJnNlbGVjX2luZm8gPSBmcmFtZV9pbmZvLAogICAgICAgIC5mcmFtZV9hZGRycyA9IGFkZHJzLAogICAgICAgIC5udW1fYWRkcnMgPSAwLAogICAgICAgIC5tYXhfYWRkcnMgPSBGUkFNRV9DQUNIRV9NQVhfRlJBTUVTLAogICAgfTsKICAgIGFzc2VydChjdHgubWF4X2FkZHJzID09IEZSQU1FX0NBQ0hFX01BWF9GUkFNRVMpOwoKICAgIGlmICh1bndpbmRlci0+Y2FjaGVfZnJhbWVzKSB7CiAgICAgICAgLy8gVXNlIGNhY2hlIHRvIGF2b2lkIHJlLXJlYWRpbmcgdW5jaGFuZ2VkIHBhcmVudCBmcmFtZXMKICAgICAgICBjdHgubGFzdF9wcm9maWxlZF9mcmFtZSA9IEdFVF9NRU1CRVIodWludHB0cl90LCB0cywKICAgICAgICAgICAgdW53aW5kZXItPmRlYnVnX29mZnNldHMudGhyZWFkX3N0YXRlLmxhc3RfcHJvZmlsZWRfZnJhbWUpOwogICAgICAgIGlmIChjb2xsZWN0X2ZyYW1lc193aXRoX2NhY2hlKHVud2luZGVyLCAmY3R4LCB0aWQpICAgICJtbWFwIG9iamVjdCBkb2Vzbid0IHN1cHBvcnQgaXRlbSBkZWxldGlvbiIpOwogICAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIGlmICghIChQeUJ5dGVzX0NoZWNrKHYpICYmIFB5Qnl0ZXNfU2l6ZSh2KT09MSkgKSB7CiAgICAgICAgUHlFcnJfU2V0U3RyaW5nKFB5RXhjX0luZGV4RXJyb3IsCiAgICAgICAgICAgICAgICAgICAgICAgICJtbWFwIGFzc2lnbm1lbnQgbXVzdCBiZSBsZW5ndGgtMSBieXRlcygpIik7CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQogICAgaWYgKCFpc193cml0YWJsZShzZWxmKSkKICAgICAgICByZXR1cm4gLTE7CiAgICBidWYgPSBQeUJ5dGVzX0FzU3RyaW5nKHYpOwoKICAgIGlmIChzYWZlX2J5dGVfY29weShzZWxmLT5kYXRhICsgaSwgYnVmKSA8IDApIHsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CiAgICByZXR1cm4gMDsKfQoKc3RhdGljIGludAptbWFwX2Fzc19pdGVtKFB5T2JaRU9GX0RPVUJMRSA4CiNkZWZpbmUgU0laRU9GX0ZMT0FUIDQKCi8qIFZDIDcuMSBoYXMgdGhlbSBhbmQgVkMgNi4wIGRvZXMgbm90LiAgVkMgNi4wIGhhcyBhIHZlcnNpb24gbnVtYmVyIG9mIDEyMDAuCiAgIE1pY3Jvc29mdCBlTWJlZGRlZCBWaXN1YWwgQysrIDQuMCBoYXMgYSB2ZXJzaW9uIG51bWJlciBvZiAxMjAxIGFuZCBkb2Vzbid0CiAgIGRlZmluZSB0aGVzZS4KICAgSWYgc29tZSBjb21waWxlciBkb2VzIG5vdCBwcm92aWRlIHRoZW0sIG1vZGlmeSB0aGUgI2lmIGFwcHJvcHJpYXRlbHkuICovCiNpZiBkZWZpbmVkKF9NU0NfVkVSKQojaWYgX01TQ19WRVIgPiAxMzAwCiNkZWZpbmUgSEFWRV9VSU5UUFRSX1QgMQojZGVmaW5lIEhBVkVfSU5UUFRSX1QgMQojZWxzZQovKiBWQzYsIFZTIDIwMDIgYW5kIGVWQzQgZG9uJ3Qgc3VwcG9ydCB0aGUgQzk5IExMIHN1ZmZpeCBmb3IgNjQtYml0IGludGVnZXIgbGl0ZXJhbiBkbzoKCiAgIGJpdG1hcCAmICgxIDw8IEkpCgoKQW5kIGhlcmUncyBhIGZvcm11bGEgdG8gY2FsY3VsYXRlIGEgcG9zaXRpb24gaW4gb3VyIHBvaW50ZXIgYXJyYXkKd2hpY2ggd291bGQgY29ycmVzcG9uZCB0byBhbiBJLXRoIGVsZW1lbnQ6CgogICBwb3Bjb3VudChiaXRtYXAgJiAoKDEgPDwgSSkgLSAxKSkKCgpMZXQncyBicmVhayBpdCBkb3duOgoKICogYHBvcGNvdW50YCBpcyBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIG51bWJlciBvZiBiaXRzIHNldCB0byAxOwoKICogYCgoMSA8PCBJKSAtIDEpYCBpcyBhIG1hc2sgdG8gZmlsdGVyIHRoZSBiaXRtYXNrIHRvIGNvbnRhaW4gYml0cwogICBzZXQgdG8gdGhlICpyaWdodCogb2Ygb3VyIGJpdC4KCgpTbyBmb3Igb3VyIDE3LCAxMSwgYW5kIDQgaW5kZXhlczoKCiAqIGJpdG1hcCAmICgoMSA8PCAxNykgLSAxKSA9PSAwYjEwMDAwMDAxMDAwMCA9PiAyIGJpdHNHQ0FMTFNfTUFJTiAzMgovKiBGb3IgdGhlIG1haW4gdGhyZWFkLCB3ZSB3YW50IHRvIG1ha2Ugc3VyZSBhbGwgcGVuZGluZyBjYWxscyBhcmUKICAgcnVuIGF0IG9uY2UsIGZvciB0aGUgc2FrZSBvZiBwcm9tcHQgc2lnbmFsIGhhbmRsaW5nLiAgVGhpcyBpcwogICB1bmxpa2VseSB0byBjYXVzZSBhbnkgcHJvYmxlbXMgc2luY2UgdGhlcmUgc2hvdWxkIGJlIHZlcnkgZmV3CiAgIHBlbmRpbmcgY2FsbHMgZm9yIHRoZSBtYWluIHRocmVhZC4gKi8KI2RlZmluZSBNQVhQRU5ESU5HQ0FMTFNMT09QX01BSU4gMAoKCiNpZmRlZiBQWV9IQVZFX1BFUkZfVFJBTVBPTElORQojIGRlZmluZSBfUHlFdmFsX1JVTlRJTUVfUEVSRl9JTklUIFwKICAgIHsgXAogICAgICAgIC5zdGF0dXMgPSBQRVJGX1NUQVRVU19OT19JTklULCBcCiAgICAgICAgLmV4dHJhX2NvZGVfaW5kZXggPSAtMSwgXAogICAgICAgIC5wZXJzaXN0X2FmdGVyX2ZvcmtwdXQ9MmU3ZmM2Mjk3MjQ4N2VhYSBpbnB1dD0xZTc2ZGYyNTUwNjNhZmQ2XSovCnsKICAgIF9QeUlPX1N0YXRlICpzdGF0ZSA9IGdldF9pb19zdGF0ZV9ieV9jbHMoY2xzKTsKICAgIHJldHVybiBidWZmZXJlZGlvYmFzZV91bnN1cHBvcnRlZChzdGF0ZSwgInJlYWQxIik7Cn0KCi8qW2NsaW5pYyBpbnB1dF0KX2lvLl9CdWZmZXJlZElPQmFzZS53cml0ZQoKICAgIGNsczogZGVmaW5pbmdfY2xhc3MKICAgIGI6IG9iamVjdCh1bnVzZWQ9VHJ1ZSkKICAgIC8KCldyaXRlIGJ1ZmZlciBiIHRvIHRoZSBJTyBzdHJlYW0uCgpSZXR1cm4gdGhlIG51bWJlciBvZiBieXRlcyB3cml0dGVuLCB3aGljaCBpcyBhbHdheXMKdGhlIGxlbmd0aCBvZiBiIGluIGJ5dGVzLgoKUmFpc2UgQmxvY2tpbmdJT0Vycm9yIGlmIHRoZSBidWZmZXIgaXMgZnVsbCBhbmQgdGhlCnVuZGVybHlpbmcgcmF3IHN0cmVhbSBjYW5ub3QgYWNjZXB0IG1vcmUgZGFxdWlyZSgpIGFuZCBfdGhyZWFkLlJMb2NrLmFjcXVpcmUoKSByYWlzZSBhbgogICAgICAgIC8vIE92ZXJmbG93RXJyb3IgaWYgbWljcm9zZWNvbmRzIGlzIGdyZWF0ZXIgdGhhbiBQWV9USU1FT1VUX01BWC4KICAgICAgICB0aW1lb3V0ID0gX1B5VGltZV9Gcm9tTWljcm9zZWNvbmRzQ2xhbXAobWljcm9zZWNvbmRzKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIHRpbWVvdXQgPSAtMTsKICAgIH0KCiAgICBfUHlMb2NrRmxhZ3MgZmxhZ3MgPSBfUHlfTE9DS19ET05UX0RFVEFDSDsKICAgIGlmIChpbnRyX2ZsYWcpIHsKICAgICAgICBmbGFncyB8PSBfUFlfRkFJTF9JRl9JTlRFUlJVUFRFRDsKICAgIH0KCiAgICByZXR1cm4gX1B5TXV0ZXhfTG9ja1RpbWVkKChQeU11dGV4ICopbG9jaywgdGltZW91dCwgZmxhZ3MpOwp9Cgp2b2lkClB5VGhyZWFkX3JlbGVhc2VfbG9jayhQeVRocmVhZF90eXBlX2xvY2sgbG9jaykKewogcFN0YWNrKHZvaWQpCnsKI2lmZGVmIENBTl9DX0JBQ0tUUkFDRQogICAgLy8gZ2gtMTM3MTg1OiBDYWxsIGJhY2t0cmFjZSgpIG9uY2UgdG8gZm9yY2UgbGliZ2NjIHRvIGJlIGxvYWRlZCBlYXJseS4KICAgIHZvaWQgKmNhbGxzdGFja1sxXTsKICAgICh2b2lkKWJhY2t0cmFjZShjYWxsc3RhY2ssIDEpOwojZW5kaWYKfQoKCnZvaWQKX1B5X0R1bXBUcmFjZWJhY2tfSW5pdCh2b2lkKQp7CiNpZmRlZiBNU19XSU5ET1dTCiAgICBpZiAocEdldFRocmVhZERlc2NyaXB0aW9uICE9IE5VTEwpIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgSE1PRFVMRSBrZXJuZWxiYXNlID0gR2V0TW9kdWxlSGFuZGxlVyhMImtlcm5lbGJhc2UuZGxsIik7CiAgICBpZiAoa2VybmVsYmFzZSAhPSBOVUxMKSB7CiAgICAgICAgcEdldFRocmVhZERlc2NyaXB0aW9uID0gKFBGX0dFVF9USFJFQURfREVTQ1JJUFRJT04pR2V0UHJvY0FkZHJlc3MocyBhIG1pbmltdW0gMzIgYnl0ZXMgb2Ygc3RhY2sgZnJhbWUsCi8vIGFuZCBjdXJyZW50bHkgYWx3YXlzIHVzZSB0aGF0IG11Y2gsIFBJQyBvbiBwcGM2NCB3b3VsZCBuZWVkIHRvIHVzZSA0OCkuCgojZGVmaW5lIEZJWEVEX0ZSQU1FIDMyCgovLyBhaXgvcHBjNjQgdXNlcyBYQ09GRiB3aGljaCB1c2VzIGZ1bmN0aW9uIGRlc2NyaXB0b3JzLgovLyBBSVggY2Fubm90IHBlcmZvcm0gdGhlIFRPQyByZWxvY2F0aW9uIGluIGEgdGV4dCBzZWN0aW9uLgovLyBUaGVyZWZvcmUsIHRoZXNlIGRlc2NyaXB0b3JzIG11c3QgbGl2ZSBpbiBhIGRhdGEgc2VjdGlvbi4KI2lmZGVmIEdPT1NfYWl4CiNpZmRlZiBHT0FSQ0hfcHBjNjQKI2RlZmluZSBHT19QUEM2NFhfSEFTX0ZVTkNERVNDCiNkZWZpbmUgREVGSU5FX1BQQzY0WF9GVU5DREVTQyhmdW5jbmFtZSwgbG9jYWxmdW5jbmFtZSkJXAoJREFUQQlmdW5jbmFtZSswKFNCKS84LCAkbG9jZmluZCB0aGUgaGlnaGVzdCBiaXQKICAgIHVpbnQ4X3QgYiA9ICh1aW50OF90KW1pX2Jzcih3c2l6ZSk7ICAvLyBub3RlOiB3c2l6ZSAhPSAwCiAgICAvLyBhbmQgdXNlIHRoZSB0b3AgMyBiaXRzIHRvIGRldGVybWluZSB0aGUgYmluICh+MTIuNSUgd29yc3QgaW50ZXJuYWwgZnJhZ21lbnRhdGlvbikuCiAgICAvLyAtIGFkanVzdCB3aXRoIDMgYmVjYXVzZSB3ZSB1c2UgZG8gbm90IHJvdW5kIHRoZSBmaXJzdCA4IHNpemVzCiAgICAvLyAgIHdoaWNoIGVhY2ggZ2V0IGFuIGV4YWN0IGJpbgogICAgYmluID0gKChiIDw8IDIpICsgKHVpbnQ4X3QpKCh3c2l6ZSA+PiAoYiAtIDIpKSAmIDB4MDMpKSAtIDM7CiAgICBtaV9hc3NlcnRfaW50ZXJuYWwoYmluIDwgTUlfQklOX0hVR0UpOwogIH0KICBtaV9hc3NlcnRfaW50ZXJuYWwoYmluID4gMCAmJiBiaW4gPD0gTUlfQklOX0hVR0UpOwogIHJldHVybiBiaW47Cn0KCgoKLyoKICogIGlzIGxlZnQtc2hpZnRlZCBieSByLiBUaGUgY2FzZSByID09IDAgaXMgdHJpdmlhbC4gRm9yIHIgPiAwLCBpdAogKiAgaXMgaW1wb3J0YW50IHRvIGtlZXAgaW4gbWluZCB0aGF0IHdlIGFsd2F5cyByZWFkIG0gc291cmNlIHdvcmRzLAogKiAgYnV0IHdyaXRlIG0rMSBkZXN0aW5hdGlvbiB3b3JkcyBpZiByICsgbXNkaWdpdHMgPiByZGlnaXRzLCBtIHdvcmRzCiAqICBvdGhlcndpc2UuCiAqLwp2b2lkCl9tcGRfYmFzZXNoaWZ0bChtcGRfdWludF90ICpkZXN0LCBtcGRfdWludF90ICpzcmMsIG1wZF9zaXplX3QgbiwgbXBkX3NpemVfdCBtLAogICAgICAgICAgICAgICAgbXBkX3NpemVfdCBzaGlmdCkKewojaWYgZGVmaW5lZChfX0dOVUNfXykgJiYgIWRlZmluZWQoX19JTlRFTF9DT01QSUxFUikgJiYgIWRlZmluZWQoX19jbGFuZ19fKQogICAgLyogc3B1cmlvdXMgdW5pbml0aWFsaXplZCB3YXJuaW5ncyAqLywgMHg3YTZhNWFhOFUsCjB4ZTQwZWNmMGJVLCAweDkzMDlmZjlkVSwgMHgwYTAwYWUyN1UsIDB4N2QwNzllYjFVLCAweGYwMGY5MzQ0VSwKMHg4NzA4YTNkMlUsIDB4MWUwMWYyNjhVLCAweDY5MDZjMmZlVSwgMHhmNzYyNTc1ZFUsIDB4ODA2NTY3Y2JVLAoweDE5NmMzNjcxVSwgMHg2ZTZiMDZlN1UsIDB4ZmVkNDFiNzZVLCAweDg5ZDMyYmUwVSwgMHgxMGRhN2E1YVUsCjB4NjdkZDRhY2NVLCAweGY5YjlkZjZmVSwgMHg4ZWJlZWZmOVUsIDB4MTdiN2JlNDNVLCAweDYwYjA4ZWQ1VSwKMHhkNmQ2YTNlOFUsIDB4YTFkMTkzN2VVLCAweDM4ZDhjMmM0VSwgMHg0ZmRmZjI1MlUsIDB4ZDFiYjY3ZjFVLAoweGE2YmM1NzY3VSwgMHgzZmI1MDZkZFUsIDB4NDhiMjM2NGJVLCAweGQ4MGQyYmRhVSwgMHhhZjBhMWI0Y1UsCjB4MzYwMzRhZjZVLCAweDQxMDQ3YTYwVSwgMHhkZjYwZWZjM1UsIDB4YTg2N2RmNTVVLCAweDMxNmU4ZWVmVS0xLC0xLC0xLAp9OwoKI2RlZmluZSBCQVNFNjRfUEFEICc9JwoKLyogTWF4IGJpbmFyeSBjaHVuayBzaXplOyBsaW1pdGVkIG9ubHkgYnkgYXZhaWxhYmxlIG1lbW9yeSAqLwojZGVmaW5lIEJBU0U2NF9NQVhCSU4gKChQWV9TU0laRV9UX01BWCAtIDMpIC8gMikKCi8qCiAqIEZhc3QgYmFzZTY0IGVuY29kaW5nL2RlY29kaW5nIGhlbHBlcnMuCiAqCiAqIFByb2Nlc3MgY29tcGxldGUgZ3JvdXBzIHdpdGhvdXQgbG9vcC1jYXJyaWVkIGRlcGVuZGVuY2llcy4KICovCgovKiBBbGlnbiB0byA2NCBieXRlcyBmb3IgTDEgY2FjaGUgbGluZSBmcmllbmRsaW5lc3MgKi8Kc3RhdGljIGNvbnN0IHVuc2lnbmVkIGNoYXIgdGFibGVfYjJhX2Jhc2U2NFtdIFB5X0FMSUdORUQoNjQpID0KIkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky8iOwoKLyogRW5jb2RlIDMgYnl0ZSAgICAoQVNfTk9STUFMX0VOQ09ESU5HKGVuYyktPmNoYXJNYXRjaGVzKGVuYywgcCwgYykpCnN0YXRpYyBpbnQgUFRSQ0FMTApzYl9jaGFyTWF0Y2hlcyhjb25zdCBFTkNPRElORyAqZW5jLCBjb25zdCBjaGFyICpwLCBpbnQgYykgewogIFVOVVNFRF9QKGVuYyk7CiAgcmV0dXJuICpwID09IGM7Cn0KI2Vsc2UKLyogYyBpcyBhbiBBU0NJSSBjaGFyYWN0ZXIgKi8KIyAgZGVmaW5lIENIQVJfTUFUQ0hFUyhlbmMsIHAsIGMpICgqKHApID09IChjKSkKI2VuZGlmCgojZGVmaW5lIFBSRUZJWChpZGVudCkgbm9ybWFsXyMjaWRlbnQKI2RlZmluZSBYTUxfVE9LX0lNUExfQwojaW5jbHVkZSAieG1sdG9rX2ltcGwuYyIKI3VuZGVmIFhNTF9UT0tfSU1QTF9DCgojdW5kZWYgTUlOQlBDCiN1bmRlZiBCWVRFX1RZUEUKI3VuZGVmIEJZVEVfVE9fQVNDSUkKI3VuZGVmIENIQVJfTUFUQ0hFUwojdW5kZWYgSVNfTkFNRV9DSEFSCiN1bl90ICp0cmFjZSA9IF9QeV9oYXNodGFibGVfZ2V0KHRyYWNlcywgVE9fUFRSKHB0cikpOwogICAgaWYgKCF0cmFjZSkgewogICAgICAgIHJldHVybiBOVUxMOwogICAgfQogICAgcmV0dXJuIHRyYWNlLT50cmFjZWJhY2s7Cn0KCgojZGVmaW5lIFBVVFMoZmQsIHN0cikgKHZvaWQpX1B5X3dyaXRlX25vcmFpc2UoZmQsIHN0ciwgKGludClzdHJsZW4oc3RyKSkKCnN0YXRpYyB2b2lkCl9QeU1lbV9EdW1wRnJhbWUoaW50IGZkLCBmcmFtZV90ICogZnJhbWUpCnsKICAgIFBVVFMoZmQsICIgIEZpbGUgXCIiKTsKICAgIF9QeV9EdW1wQVNDSUkoZmQsIGZyYW1lLT5maWxlbmFtZSk7CiAgICBQVVRTKGZkLCAiXCIsIGxpbmUgIik7CiAgICBfUHlfRHVtcERlY2ltYWwoZmQsIGZyYW1lLT5saW5lbm8pOwogICAgUFVUUyhmZCwgIlxuIik7Cn0KCi8qIER1bXAgdGhlIHRyYWNlYmFjayB3aGVyZSBhIG1lbW9yeSBibG9jayB3YXMgYWxsYWFkMTUxZF0qLwoKI2luY2x1ZGUgImNsaW5pYy9yZXNvdXJjZS5jLmgiCgpQeURvY19TVFJWQVIoc3RydWN0X3J1c2FnZV9fZG9jX18sCiJzdHJ1Y3RfcnVzYWdlOiBSZXN1bHQgZnJvbSBnZXRydXNhZ2UuXG5cbiIKIlRoaXMgb2JqZWN0IG1heSBiZSBhY2Nlc3NlZCBlaXRoZXIgYXMgYSB0dXBsZSBvZlxuIgoiICAgICh1dGltZSxzdGltZSxtYXhyc3MsaXhyc3MsaWRyc3MsaXNyc3MsbWluZmx0LG1hamZsdCxcbiIKIiAgICBuc3dhcCxpbmJsb2NrLG91YmxvY2ssbXNnc25kLG1zZ3Jjdixuc2lnbmFscyxudmNzdyxuaXZjc3cpXG4iCiJvciB2aWEgdGhlIGF0dHJpYnV0ZXMgcnVfdXRpbWUsIHJ1X3N0aW1lLCBydV9tYXhyc3MsIGFuZCBzbyBvbi4iKTsKCnN0YXRpYyBQeVN0cnVjdFNlcXVlbmNlX0ZpZWxkIHN0cnVjdF9ydXNhZ2VfZmllbGRzW10gPSB7CiAgICB7InJ1X3V0aW1lIiwgICAgICAgICJ1c2VyIHRpbWUgdXNldHB1dD1lMDJkMTIxYTIwMjQ2YzZjIGlucHV0PWRlYWZhN2YwNGE2MGViZTBdKi8KewogICAgaW50IG5mZHMsIGk7CiAgICBQeU9iamVjdCAqZWxpc3QgPSBOVUxMLCAqZXR1cGxlID0gTlVMTDsKICAgIHN0cnVjdCBlcG9sbF9ldmVudCAqZXZzID0gTlVMTDsKICAgIFB5VGltZV90IHRpbWVvdXQgPSAtMSwgbXMgPSAtMSwgZGVhZGxpbmUgPSAwOwoKICAgIGlmIChzZWxmLT5lcGZkIDwgMCkKICAgICAgICByZXR1cm4gcHllcG9sbF9lcnJfY2xvc2VkKCk7CgogICAgaWYgKHRpbWVvdXRfb2JqICE9IFB5X05vbmUpIHsKICAgICAgICAvKiBlcG9sbF93YWl0KCkgaGFzIGEgcmVzb2x1dGlvbiBvZiAxIG1pbGxpc2Vjb25kLCByb3VuZCB0b3dhcmRzCiAgICAgICAgICAgaW5maW5pdHkgdG8gd2FpdCBhdCBsZWFzdCB0aW1lb3V0IHNlY29uZHMuICovCiAgICAgICAgaWYgKF9QeVRpbWVfRnJvbVNlY29uZHNPYmplY3QoJnRpbWVvQklUUyA1MTIgICAgIC8qIDE2Kihsb2cyKE1QRF9NQVhfRU1BWCAvIDMpLTMpICovCgovKiBjb252ZXJzaW9uIHNwZWNpZmllcnMgKi8KI2RlZmluZSBQUklfbXBkX3VpbnRfdCBQUkl1NjQKI2RlZmluZSBQUklfbXBkX3NzaXplX3QgUFJJaTY0Ci8qIEVORCBDT05GSUdfNjQgKi8KCgovKiBCRUdJTiBDT05GSUdfMzIgKi8KI2VsaWYgZGVmaW5lZChDT05GSUdfMzIpCi8qIHR5cGVzIGZvciBtb2R1bGFyIGFuZCBiYXNlIGFyaXRobWV0aWMgKi8KI2RlZmluZSBNUERfVUlOVF9NQVggVUlOVDMyX01BWAojZGVmaW5lIE1QRF9CSVRTX1BFUl9VSU5UIDMyCnR5cGVkZWYgdWludDMyX3QgbXBkX3VpbnRfdDsgIC8qIHVuc2lnbmVkIG1vZCB0eXBlICovCgojaWZuZGVmIExFR0FDWV9DT01QSUxFUgojZGVmaW5lIE1QRF9VVUlOVF9NQVggVUlOVDY0X01BWAp0eXBlZGVmIHVpbnQ2NF90IG1wZF91dWludF90OyAvKiBkb3VibGUgd2lkdCAqc3RlcDsKICAgIFB5T2JqZWN0ICpzdWJqZWN0OwogICAgUHlPYmplY3QgKnRvcDsKICAgIFB5T2JqZWN0ICp0eXBlOwogICAgUHlPYmplY3QgKnR5cGV2YXJzOwogICAgUHlPYmplY3QgKnZhbDA7CiAgICBQeU9iamVjdCAqdmFsMTsKICAgIGludCB2YWx1ZXNfb3Jfbm9uZTsKCiAgICBzd2l0Y2ggKG9wY29kZSkgewoKLy8gQkVHSU4gQllURUNPREVTIC8vCgogICAgICAgIC8vIE92ZXJyaWRlIGFuIG9wCiAgICAgICAgb3ZlcnJpZGUgb3AoX0NIRUNLX1BFUklPRElDX0lGX05PVF9ZSUVMRF9GUk9NLCAoLS0pKSB7CiAgICAgICAgICAgIFRlc3RfRXZhbEZyYW1lX1Jlc3VtZXMrKzsKICAgICAgICAgICAgaWYgKChvcGFyZyAmIFJFU1VNRV9PUEFSR19MT0NBVElPTl9NQVNLKSA8IFJFU1VNRV9BRlRFUl9ZSUVMRF9GUk9NKSB7CiAgICAgICAgICAgICAgICBpbnQgZXJyID0gY2hlY2tfcGVyaW9kaWNzKHRzdGFNb2RlKG1vZGUgfCBTRU1fTk9HUEZBVUxURVJST1JCT1gpOwojZW5kaWYKCiNpZmRlZiBIQVZFX1NZU19SRVNPVVJDRV9ICiAgICBzdHJ1Y3QgcmxpbWl0IHJsOwoKICAgIC8qIERpc2FibGUgY3JlYXRpb24gb2YgY29yZSBkdW1wICovCiAgICBpZiAoZ2V0cmxpbWl0KFJMSU1JVF9DT1JFLCAmcmwpID09IDApIHsKICAgICAgICBybC5ybGltX2N1ciA9IDA7CiAgICAgICAgc2V0cmxpbWl0KFJMSU1JVF9DT1JFLCAmcmwpOwogICAgfQojZW5kaWYKCiNpZmRlZiBfTVNDX1ZFUgogICAgLyogVmlzdWFsIFN0dWRpbzogY29uZmlndXJlIGFib3J0KCkgdG8gbm90IGRpc3BsYXkgYW4gZXJyb3IgbWVzc2FnZSBub3IKICAgICAgIG9wZW4gYSBwb3B1cCBhc2tpbmcgdG8gcmVwb3J0IHRoZSBmYXVsdC4gKi8KICAgIF9zZXRfYWJvcnRfYmVoYXZpb3IoMCwgX1dSSVRFX0FCT1JUX01TRyB8IF9DQUxMX1JFUE9SVEZBVUxUKTsKI2UgIF9QeUxleGVyX3R5cGVfY29tbWVudF90b2tlbl9zZXR1cCh0b2ssIHRva2VuLCB0b2tlbl90eXBlLCBjb2xfb2Zmc2V0LCBlbmRfY29sX29mZnNldCwgcF9zdGFydCwgcF9lbmQpKQoKLyogU3BhY2VzIGluIHRoaXMgY29uc3RhbnQgYXJlIHRyZWF0ZWQgYXMgInplcm8gb3IgbW9yZSBzcGFjZXMgb3IgdGFicyIgd2hlbgogICB0b2tlbml6aW5nLiAqLwpzdGF0aWMgY29uc3QgY2hhciogdHlwZV9jb21tZW50X3ByZWZpeCA9ICIjIHR5cGU6ICI7CgpzdGF0aWMgaW5saW5lIGludApjb250YWluc19udWxsX2J5dGVzKGNvbnN0IGNoYXIqIHN0ciwgc2l6ZV90IHNpemUpCnsKICAgIHJldHVybiBtZW1jaHIoc3RyLCAwLCBzaXplKSAhPSBOVUxMOwp9CgovKiBHZXQgbmV4dCBjaGFyLCB1cGRhdGluZyBzdGF0ZTsgZXJyb3IgY29kZSBnb2VzIGludG8gdG9rLT5kb25lICovCnN0YXRpYyBpbnQKdG9rX25leHRjKHN0cnVTS1RPUCkgfHwgZGVmaW5lZChNU19XSU5ET1dTX1NZU1RFTSkpCgpQeURvY19TVFJWQVIoX3dpbmFwaV9HZXRTaG9ydFBhdGhOYW1lX19kb2NfXywKIkdldFNob3J0UGF0aE5hbWUoJG1vZHVsZSwgLywgcGF0aClcbiIKIi0tXG4iCiJcbiIKIlJldHVybiB0aGUgc2hvcnQgdmVyc2lvbiBvZiB0aGUgcHJvdmlkZWQgcGF0aC5cbiIKIlxuIgoiSWYgdGhlIHBhdGggaXMgYWxyZWFkeSBpbiBpdHMgc2hvcnQgZm9ybSwgcmV0dXJucyB0aGUgc2FtZSB2YWx1ZS5cbiIKIlxuIgoiVGhlIHBhdGggbXVzdCBhbHJlYWR5IGJlIGEgXCdzdHJcJy4gSWYgdGhlIHR5cGUgaXMgbm90IGtub3duLCB1c2VcbiIKIm9zLmZzZGVjb2RlIGJlZm9yZSBjYWxsaW5nIHRoaXMgZnVuY3Rpb24uIik7CgojZGVmaW5lIF9XSU5BUElfR0VUU0hPUlRQQVRITkFNRV9NRVRIT0RERUYgICAgXAogICAgeyJHZXRTaG9ydFBhdGhOYW1lIiwgX1BkOiAlZCIsIGVycik7Cgl9CglwdGhyZWFkX3NldHNwZWNpZmljKGssICh2b2lkKiltYWdpYzEpOwoJLy8gSWYgdGhyZWFkIGxvY2FsIHNsb3RzIGFyZSBsYWlkIG91dCBhcyB3ZSBleHBlY3QsIG91ciBtYWdpYyB3b3JkIHdpbGwKCS8vIGJlIGxvY2F0ZWQgYXQgc29tZSBsb3cgb2Zmc2V0IGZyb20gdGxzYmFzZS4gSG93ZXZlciwganVzdCBpbiBjYXNlIHNvbWV0aGluZyB3ZW50CgkvLyB3cm9uZywgdGhlIHNlYXJjaCBpcyBsaW1pdGVkIHRvIHNlbnNpYmxlIG9mZnNldHMuIFBUSFJFQURfS0VZU19NQVggd2FzIHRoZQoJLy8gb3JpZ2luYWwgbGltaXQsIGJ1dCBpc3N1ZSAxOTQ3MiBtYWRlIGEgaGlnaGVyIGxpbWl0IG5lY2Vzc2FyeS4KCWZvciAoaT0wOyBpPDM4NDsgaSsrKSB7CgkJaWYgKCoodGxzYmFzZStpKSA9PSAodm9pZCopbWFnaWMxKSB7CgkJCSp0bHNnID0gKHZvaWQqKShpKnNpemVvZih2b2lkICopKTsKCQkJcHQgZm9yIHhfY2dvX3NldF90cmFjZWJhY2tfZnVuY3Rpb25zLiBTZWUgcnVudGltZS5TZXRDZ29UcmFjZWJhY2suCiAqLwpzdHJ1Y3QgY2dvU2V0VHJhY2ViYWNrRnVuY3Rpb25zQXJnIHsKCXZvaWQgKCpUcmFjZWJhY2spKHN0cnVjdCBjZ29UcmFjZWJhY2tBcmcqKTsKCXZvaWQgKCpDb250ZXh0KShzdHJ1Y3QgY2dvQ29udGV4dEFyZyopOwoJdm9pZCAoKlN5bWJvbGl6ZXIpKHN0cnVjdCBjZ29TeW1ib2xpemVyQXJnKik7Cn07CgovKgogKiBUU0FOIHN1cHBvcnQuICBUaGlzIGlzIG9ubHkgdXNlZnVsIHdoZW4gYnVpbGRpbmcgd2l0aAogKiAgIENHT19DRkxBR1M9Ii1mc2FuaXRpemU9dGhyZWFkIiBDR09fTERGTEFHUz0iLWZzYW5pdGl6ZT10aHJlYWQiIGdvIGluc3RhbGwKICovCiN1bmRlZiBDR09fVFNBTgojaWYgZGVmaW5lZChfX2hhc19mZWF0dXJlKQojIGlmIF9faGFzX2ZlYXR1cmUodGhyZWFkX3Nhbml0aXplcikKIyBpcyBhIGJpdGZpZWxkIG9mIHRoZSBmb2xsb3dpbmcgZmxhZ3M6CiAgICogMSAtIGxpdHRsZSBlbmRpYW4KICAgKiAyIC0gbmF0aXZlIGVuZGlhbgogICAqIDQgLSB1bnNpZ25lZCBkZXN0aW5hdGlvbiAoZS5nLiBkb24ndCByZWplY3QgY29weWluZyAyNTUgaW50byBvbmUgYnl0ZSkKICAgKiA4IC0gcmFpc2UgYW4gZXhjZXB0aW9uIGZvciBuZWdhdGl2ZSBpbnB1dHMKICAgKiAxNiAtIGNhbGwgX19pbmRleF9fIG9uIG5vbi1pbnQgdHlwZXMKICAgSWYgZmxhZ3MgaXMgLTEgKGFsbCBiaXRzIHNldCksIG5hdGl2ZSBlbmRpYW4gaXMgdXNlZCwgdmFsdWUgdHJ1bmNhdGlvbgogICBiZWhhdmVzIG1vc3QgbGlrZSBDIChhbGxvd3MgbmVnYXRpdmUgaW5wdXRzIGFuZCBhbGxvdyBNU0Igc2V0KSwgYW5kIG5vbi1pbnQKICAgb2JqZWN0cyB3aWxsIHJhaXNlIGEgVHlwZUVycm9yLgogICBCaWcgZW5kaWFuIG1vZGUgd2lsbCB3cml0bSIsCiJlcnJubyIsCiJmYXVsdGhhbmRsZXIiLAoiZmNudGwiLAoiZmlsZWNtcCIsCiJmaWxlaW5wdXQiLAoiZm5tYXRjaCIsCiJmcmFjdGlvbnMiLAoiZnRwbGliIiwKImZ1bmN0b29scyIsCiJnYyIsCiJnZW5lcmljcGF0aCIsCiJnZXRvcHQiLAoiZ2V0cGFzcyIsCiJnZXR0ZXh0IiwKImdsb2IiLAoiZ3JhcGhsaWIiLAoiZ3JwIiwKImd6aXAiLAoiaGFzaGxpYiIsCiJoZWFwcSIsCiJobWFjIiwKImh0bWwiLAoiaHR0cCIsCiJpZGxlbGliIiwKImltYXBsaWIiLAoiaW1wb3J0bGliIiwKImluc3BlY3QiLAoiaW8iLAoiaXBhZGRyZXNzIiwKIml0ZXJ0b29scyIsCiJqc29uIiwKImtleXdvcmQiLAoibGluZWNhY2hlIiwKImxvY2FsZSIsCiJsb2dnaW5nIiwKImx6bWEiLAoibWFpbGJveCIsCiJtYXJzaGFsIiwKIm1hdGgiLAoibWltZXR5cGVzIiwKIm1tYXAiLAoibW9kdWxlZmluZGVyIiwKIm1zdmNydCIsCiJtdWx0aXByb2NlX18sCiJqb2luKCRzZWxmLCBpdGVyYWJsZSwgLylcbiIKIi0tXG4iCiJcbiIKIkNvbmNhdGVuYXRlIGFueSBudW1iZXIgb2Ygc3RyaW5ncy5cbiIKIlxuIgoiVGhlIHN0cmluZyB3aG9zZSBtZXRob2QgaXMgY2FsbGVkIGlzIGluc2VydGVkIGluIGJldHdlZW4gZWFjaCBnaXZlbiBzdHJpbmcuXG4iCiJUaGUgcmVzdWx0IGlzIHJldHVybmVkIGFzIGEgbmV3IHN0cmluZy5cbiIKIlxuIgoiRXhhbXBsZTogXCcuXCcuam9pbihbXCdhYlwnLCBcJ3BxXCcsIFwncnNcJ10pIC0+IFwnYWIucHEucnNcJyIpOwoKI2RlZmluZSBVTklDT0RFX0pPSU5fTUVUSE9EREVGICAgIFwKICAgIHsiam9pbiIsIChQeUNGdW5jdGlvbil1bmljb2RlX2pvaW4sIE1FVEhfTywgdW5pY29kZV9qb2luX19kb2NfX30sCgpQeURvY19TVFJWQVIodW5pY29kZV9sanVzdF9fZG9jX18sCiJsanVzdCgkc2VsZiwgd2lkdGgsIGZpbGxjaGFyPVwnIFwnLCAvKVxub3QgZW5kIGluIFxuLCBmYWtlIG9uZSAqLwogICAgICAgICp0b2stPmlucCsrID0gJ1xuJzsKICAgICAgICAqdG9rLT5pbnAgPSAnXDAnOwogICAgICAgIHRvay0+aW1wbGljaXRfbmV3bGluZSA9IDE7CiAgICB9CgogICAgaWYgKHRvay0+dG9rX21vZGVfc3RhY2tfaW5kZXggJiYgIV9QeUxleGVyX3VwZGF0ZV9mdHN0cmluZ19leHByKHRvaywgMCkpIHsKICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICBBRFZBTkNFX0xJTkVOTygpOwogICAgLyogVGhlIGRlZmF1bHQgZW5jb2RpbmcgaXMgVVRGLTgsIHNvIG1ha2Ugc3VyZSB3ZSBkb24ndCBoYXZlIGFueQogICAgICAgbm9uLVVURi04IHNlcXVlbmNlcyBpbiBpdC4gKi8KICAgIGlmICghdG9rLT5lbmNvZGluZyAmJiAhX1B5VG9rZW5pemVyX2Vuc3VyZV91dGY4KHRvay0+Y3VyLCB0b2ssIHRvay0+bGluZW5vKSkgewogICAgICAgIF9QeVRva2VuaXplcl9lcnJvcl9yZXQgdjM7CiAgICAgICAgc1s0VSArIDVVICogaV0gPSB2NDspOwogICAgICB1aW50NjRfdCBjID0gSGFjbF9IYXNoX1NIQTNfa2VjY2FrX3JuZGNbaTFdOwogICAgICBzWzBVXSA9IHNbMFVdIF4gYzsKICAgIH0KICB9CiAgdWludDMyX3QgcmVtT3V0ID0gNjRVICUgcmF0ZUluQnl0ZXMxOwogIHVpbnQ4X3QgaGJ1ZlsyNTZVXSA9IHsgMFUgfTsKICB1aW50NjRfdCB3c1szMlVdID0geyAwVSB9OwogIG1lbWNweSh3cywgcywgMjVVICogc2l6ZW9mICh1aW50NjRfdCkpOwogIGZvciAodWludDMyX3QgaSA9IDBVOyBpIDwgMzJVOyBpKyspCiAgewogICAgc3RvcmU2NF9sZShoYnVmICsgaSAqIDhVLCB3c1tpXSk7CiAgfQogIG1lbWNweShyYiArIDY0VSAtIHJlbU91dCwgaGJ1ZiwgcmVtT3V0ICogc2l6ZW9mICh1aW50OF90KSk7Cn0KCi8qKgpBbGxvY2F0ZSBzdGF0ZSBidWZmZXIgb2YgMjAwLWJ5dGVzCiovCnVpbnQ2NF90ICpIYWNvYywKIl9nZXRfbWFpbl90aHJlYWRfaWRlbnQoJG1vZHVsZSwgLylcblwKLS1cblwKXG5cCkludGVybmFsIG9ubHkuIFJldHVybiBhIG5vbi16ZXJvIGludGVnZXIgdGhhdCB1bmlxdWVseSBpZGVudGlmaWVzIHRoZSBtYWluIHRocmVhZFxuXApvZiB0aGUgbWFpbiBpbnRlcnByZXRlci4iKTsKCiNpZiBkZWZpbmVkKF9fT3BlbkJTRF9fKQogICAgLyogcHRocmVhZF8qX25wIGZ1bmN0aW9ucywgZXNwZWNpYWxseSBwdGhyZWFkX3tnZXQsc2V0fV9uYW1lX25wKCkuCiAgICAgICBwdGhyZWFkX25wLmggZXhpc3RzIG9uIGJvdGggT3BlbkJTRCBhbmQgRnJlZUJTRCBidXQgdGhlIGxhdHRlciBkZWNsYXJlcwogICAgICAgcHRocmVhZF9nZXRuYW1lX25wKCkgYW5kIHB0aHJlYWRfc2V0bmFtZV9ucCgpIGluIHB0aHJlYWQuaCBhcyBsb25nIGFzCiAgICAgICBfX0JTRF9WSVNJQkxFIHJlbWFpbnMgc2V0LgogICAgICovCiMgICBpbm1ib2xpemVyX2Z1bmN0aW9uKCk7CglpZiAocGZuID09IG5pbCkgewoJCXJldHVybjsKCX0KCgkoKnBmbikoYXJnKTsKfQoKdm9pZCBfY2dvX2JlZ2ludGhyZWFkKHVuc2lnbmVkIGxvbmcgKF9fc3RkY2FsbCAqZnVuYykodm9pZCopLCB2b2lkKiBhcmcpIHsKCWludCB0cmllczsKCUhBTkRMRSB0aGFuZGxlOwoKCWZvciAodHJpZXMgPSAwOyB0cmllcyA8IDIwOyB0cmllcysrKSB7CgkJdGhhbmRsZSA9IENyZWF0ZVRocmVhZChOVUxMLCAwLCBmdW5jLCBhcmcsIDAsIE5VTEwpOwoJCWlmICh0aGFuZGxlID09IDAgJiYgR2V0TGFzdEVycm9yKCkgPT0gRVJST1JfQUNDRVNTX0RFTklFRCkgewoJCQkvLyAiSW5zdWZmaWNpZW50IHJlc291cmNlcyIsIHRyeSBhZ2FpbiBpbiBhIGJpdC4KCQkJLy8KCQkJLy8gTm90ZSB0aGF0IHRoZSBmaXJzdCBTbGVlcCgwKSBpcyBhIHlpZWxkLgoJCQlTbGVlcCh0cmllcyk7IC8vIG1pbGxDUkVGKF9QeU1vbml0b3JpbmdfUmVnaXN0ZXJDYWxsYmFjayh0b29sLCBldmVudDIsIChQeU9iamVjdCAqKWNhbGxiYWNrKSk7CiAgICB9CiAgICBQeV9ERUNSRUYoY2FsbGJhY2spOwogICAgcmV0dXJuIDA7Cn0KCiNpZm5kZWYgTkRFQlVHCi8qIEVuc3VyZSB0aGF0IHRzdGF0ZSBpcyB2YWxpZDogc2FuaXR5IGNoZWNrIGZvciBQeUV2YWxfQWNxdWlyZVRocmVhZCgpIGFuZAogICBQeUV2YWxfUmVzdG9yZVRocmVhZCgpLiBEZXRlY3QgaWYgdHN0YXRlIG1lbW9yeSB3YXMgZnJlZWQuIEl0IGNhbiBoYXBwZW4KICAgd2hlbiBhIHRocmVhZCBjb250aW51ZXMgdG8gcnVuIGFmdGVyIFB5dGhvbiBmaW5hbGl6YXRpb24sIGVzcGVjaWFsbHkKICAgZGFlbW9uIHRocmVhZHMuICovCnN0YXRpYyBpbnQKaXNfdHN0YXRlX3ZhbGlkKFB5VGhyZWFkU3RhdGUgKnRzdGF0ZSkKewogICAgYXNzZXJ0KCFfUHlNZW1fSXNQdHJGcmVlZCh0cyAgICB1c2VkOyAgLy8gY3VycmVudGx5IHVzZWQgY2hhcnMgYHVzZWQgPD0gY291bnRgCiAgc2l6ZV90ICAgICAgICAgY291bnQ7IC8vIHRvdGFsIGNoYXJzIGF2YWlsYWJsZSBmb3Igb3V0cHV0Cn0gYnVmZmVyZWRfdDsKCnN0YXRpYyB2b2lkIG1pX2J1ZmZlcmVkX2ZsdXNoKGJ1ZmZlcmVkX3QqIGJ1ZikgewogIGJ1Zi0+YnVmW2J1Zi0+dXNlZF0gPSAwOwogIF9taV9mcHV0cyhidWYtPm91dCwgYnVmLT5hcmcsIE5VTEwsIGJ1Zi0+YnVmKTsKICBidWYtPnVzZWQgPSAwOwp9CgpzdGF0aWMgdm9pZCBtaV9jZGVjbCBtaV9idWZmZXJlZF9vdXQoY29uc3QgY2hhciogbXNnLCB2b2lkKiBhcmcpIHsKICBidWZmZXJlZF90KiBidWYgPSAoYnVmZmVyZWRfdCopYXJnOwogIGlmIChtc2c9PU5VTEwgfHwgYnVmPT1OVUxMKSByZXR1cm47CiAgZm9yIChjb25zdCBjaGFyKiBzcmMgPSBtc2c7ICpzcmMgIT0gMDsgc3JjKyspICAuZ2xvYmFsID0gJmdsb2JhbC0+ZGF0YV9sb29rdXAsCiAgICAgICAgLmxvY2FsID0gJmxvY2FsLT5kYXRhX2xvb2t1cCwKICAgIH07CiAgICByZXR1cm4gMDsKfQoKc3RhdGljIF9QeVhJRGF0YV9nZXRkYXRhX3QKbG9va3VwX2dldGRhdGEoZGxjb250ZXh0X3QgKmN0eCwgUHlPYmplY3QgKm9iaikKewogICAvKiBDcm9zcy1pbnRlcnByZXRlciBvYmplY3RzIGFyZSBsb29rZWQgdXAgYnkgZXhhY3QgbWF0Y2ggb24gdGhlIGNsYXNzLgogICAgICBXZSBjYW4gcmVhc3Nlc3MgdGhpcyBwb2xpY3kgd2hlbiB3ZSBtb3ZlIGZyb20gYSBnbG9iYWwgcmVnaXN0cnkgdG8gYQogICAgICB0cF8qIHNsb3QuICovCiAgICByZXR1cm4gX2xvb2t1cF9nZXRkYXRhX2Zyb21fcmVnaXN0cnkoY3R4LCBvYmopOwp9CgoKLyogZXhwb3J0ZWQgQVBJICovCgpQeU9iamVjdCAqCl9QeVhJRGF0YV9HZXROb3RTaGFyZWFibGVFcnJvclR5cGUoUHlUaHVybnMgdGhlIGN1cnJlbnQgQUJDIGNhY2hlIHRva2VuLlxuIgoiXG4iCiJUaGUgdG9rZW4gaXMgYW4gb3BhcXVlIG9iamVjdCAoc3VwcG9ydGluZyBlcXVhbGl0eSB0ZXN0aW5nKSBpZGVudGlmeWluZyB0aGVcbiIKImN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgQUJDIGNhY2hlIGZvciB2aXJ0dWFsIHN1YmNsYXNzZXMuIFRoZSB0b2tlbiBjaGFuZ2VzXG4iCiJ3aXRoIGV2ZXJ5IGNhbGwgdG8gcmVnaXN0ZXIoKSBvbiBhbnkgQUJDLiIpOwoKI2RlZmluZSBfQUJDX0dFVF9DQUNIRV9UT0tFTl9NRVRIT0RERUYgICAgXAogICAgeyJnZXRfY2FjaGVfdG9rZW4iLCAoUHlDRnVuY3Rpb24pX2FiY19nZXRfY2FjaGVfdG9rZW4sIE1FVEhfTk9BUkdTLCBfYWJjX2dldF9jYWNoZV90b2tlbl9fZG9jX199LAoKc3RhdGljIFB5T2JqZWN0ICoKX2FiY19nZXRfY2FjaGVfdG9rZW5faW1wbChQeU9iamVjdCAqbW9kdWxlKTsKCnNmIGFyZ3MgYW5kIG11c3QgbWF0Y2ggZXhhY3RseTtcblwKdGhlc2UgY2FuIGJlIHByZWNlZGVkIGJ5IGEgZGVjaW1hbCByZXBlYXQgY291bnQ6XG5cCiAgeDogcGFkIGJ5dGUgKG5vIGRhdGEpOyBjOmNoYXI7IGI6c2lnbmVkIGJ5dGU7IEI6dW5zaWduZWQgYnl0ZTtcblwKICA/Ol9Cb29sOyBoOnNob3J0OyBIOnVuc2lnbmVkIHNob3J0OyBpOmludDsgSTp1bnNpZ25lZCBpbnQ7XG5cCiAgbDpsb25nOyBMOnVuc2lnbmVkIGxvbmc7IGY6ZmxvYXQ7IGQ6ZG91YmxlOyBlOmhhbGYtZmxvYXQuXG5cCiAgRjpmbG9hdCBjb21wbGV4OyBEOmRvdWJsZSBjb21wbGV4LlxuXApTcGVjaWFsIGNhc2VzIChwcmVjZWRpbmcgZGVjaW1hbCBjb3VudCBpbmRpY2F0ZXMgbGVuZ3RoKTpcblwKICBzOnN0cmluZyAoYXJyYXkgb2YgY2hhcik7IHA6IHBhc2NhbCBzdHJpbmcgKHdpdGggY291bnQgYnl0ZSkuXG5cClNwZWNpYWwgY2FzZXMgKG9ubHkgdG8gaGVhcCBvYmplY3RzIGluIGl0cyBsb2NhbCBzdGFjayB2YXJpYWJsZXMuCiNkZWZpbmUgTk9fTE9DQUxfUE9JTlRFUlMJRlVOQ0RBVEEgJEZVTkNEQVRBX0xvY2Fsc1BvaW50ZXJNYXBzLCBub19wb2ludGVyc19zdGFja21hcChTQikKCi8vIEFyZ3NTaXplVW5rbm93biBpcyBzZXQgaW4gRnVuYy5hcmdzaXplIHRvIG1hcmsgYWxsIGZ1bmN0aW9ucwovLyB3aG9zZSBhcmd1bWVudCBzaXplIGlzIHVua25vd24gKEMgdmFyYXJnIGZ1bmN0aW9ucywgYW5kCi8vIGFzc2VtYmx5IGNvZGUgd2l0aG91dCBhbiBleHBsaWNpdCBzcGVjaWZpY2F0aW9uKS4KLy8gVGhpcyB2YWx1ZSBpcyBnZW5lcmF0ZWQgYnkgdGhlIGNvbXBpbGVyLCBhc3NlbWJsZXIsIG9yIGxpbmtlci4KI2RlZmluZSBBcmdzU2l6ZVVua25vd24gMHg4MDAwMDAwMAovKiBzdHJ1Y3QgbW9kdWxlIC0tIHBhY2sgdmFsdWVzIGludG8gYW5kIChvdXQgb2YpIGJ5dGVob2RfR0VUX1NFTEYobWV0aG9kKTsKICAgIFB5T2JqZWN0ICpmdW5jID0gUHlNZXRob2RfR0VUX0ZVTkNUSU9OKG1ldGhvZCk7CiAgICBQeV9zc2l6ZV90IG5hcmdzID0gUHlWZWN0b3JjYWxsX05BUkdTKG5hcmdzZik7CiAgICBhc3NlcnQobmFyZ3MgPT0gMCB8fCBhcmdzW25hcmdzLTFdKTsKCiAgICBQeU9iamVjdCAqcmVzdWx0OwogICAgaWYgKG5hcmdzZiAmIFBZX1ZFQ1RPUkNBTExfQVJHVU1FTlRTX09GRlNFVCkgewogICAgICAgIC8qIFBZX1ZFQ1RPUkNBTExfQVJHVU1FTlRTX09GRlNFVCBpcyBzZXQsIHNvIHdlIGFyZSBhbGxvd2VkIHRvIG11dGF0ZSB0aGUgdmVjdG9yICovCiAgICAgICAgUHlPYmplY3QgKipuZXdhcmdzID0gKFB5T2JqZWN0KiopYXJncyAtIDE7CiAgICAgICAgbmFyZ3MgKz0gMTsKICAgICAgICBQeU9iamVjdCAqdG1wID0gbmV3YXJnc1swXTsKICAgICAgICBuZXdhcmdzWzBdID0gc2VsZjsKICB3aXRoIHBhdXNlX3RocmVhZHMoKS4KClJldHVybnMgVHJ1ZSBpZiB0aHJlYWRzIHdlcmUgc3VjY2Vzc2Z1bGx5IHJlc3VtZWQsIEZhbHNlIGlmIHRoZXkgd2VyZSBub3QgcGF1c2VkLgpbY2xpbmljIHN0YXJ0IGdlbmVyYXRlZCBjb2RlXSovCgpzdGF0aWMgUHlPYmplY3QgKgpfcmVtb3RlX2RlYnVnZ2luZ19SZW1vdGVVbndpbmRlcl9yZXN1bWVfdGhyZWFkc19pbXBsKFJlbW90ZVVud2luZGVyT2JqZWN0ICpzZWxmKQovKltjbGluaWMgZW5kIGdlbmVyYXRlZCBjb2RlOiBvdXRwdXQ9OGQ2NzgxZWEzNzA5NTUzNiBpbnB1dD0xNmJhYWFhYjAwN2Y0MjU5XSovCnsKI2lmZGVmIFB5X1JFTU9URV9ERUJVR19TVVBQT1JUU19CTE9DS0lORwogICAgaWYgKCFzZWxmLT50aHJlYWRzX3N0b3BwZWQpIHsKICAgICAgICBQeV9SRVRVUk5fRkFMU0U7CiAgICB9CgogICAgX1B5X1JlbW90ZURlYnVnX1Jlc3VtZUFsbFRocmVhZHMoc2VsZiAgIHsibG9jYXRpb24iLCAiTG9jYXRpb25JbmZvIHN0cnVjdHNlcSBvciBOb25lIGZvciBzeW50aGV0aWMgZnJhbWVzIn0sCiAgICB7ImZ1bmNuYW1lIiwgIkZ1bmN0aW9uIG5hbWUifSwKICAgIHsib3Bjb2RlIiwgIk9wY29kZSBiZWluZyBleGVjdXRlZCAoTm9uZSBpZiBub3QgZ2F0aGVyZWQpIn0sCiAgICB7TlVMTH0KfTsKClB5U3RydWN0U2VxdWVuY2VfRGVzYyBGcmFtZUluZm9fZGVzYyA9IHsKICAgICJfcmVtb3RlX2RlYnVnZ2luZy5GcmFtZUluZm8iLAogICAgIkluZm9ybWF0aW9uIGFib3V0IGEgZnJhbWUiLAogICAgRnJhbWVJbmZvX2ZpZWxkcywKICAgIDQKfTsKCi8vIENvcm9JbmZvIHN0cnVjdHNlcSB0eXBlCnN0YXRpYyBQeVN0cnVjdFNlcXVlbmNlX0ZpZWxkIENvcm9JbmZvX2ZpZWxkc1tdID0gewogICAgeyJjYWxsX3N0YWNrIiwgIkNvcm91dGluZSBjYWxsIHN0YWNrIn0sCiAgICB7InRhc2tfbmFtZSJ0bHkuCkRFQ0xTUEVDX05PSU5MSU5FIF9faW5saW5lClVMT05HIF9fc3RkY2FsbApNY0dlbkV2ZW50V3JpdGUoCiAgICBfSW5fIFBNQ0dFTl9UUkFDRV9DT05URVhUIENvbnRleHQsCiAgICBfSW5fIFBDRVZFTlRfREVTQ1JJUFRPUiBEZXNjcmlwdG9yLAogICAgX0luX29wdF8gTFBDR1VJRCBBY3Rpdml0eUlkLAogICAgX0luX3JhbmdlXygxLCAxMjgpIFVMT05HIEV2ZW50RGF0YUNvdW50LAogICAgX1ByZV9jYXBfKEV2ZW50RGF0YUNvdW50KSBFVkVOVF9EQVRBX0RFU0NSSVBUT1IqIEV2ZW50RGF0YQogICAgKQp7CiAgICBjb25zdCBVU0hPUlQgVU5BTElHTkVEKiBUcmFpdHM7CgogICAgLy8gU29tZSBjdXN0b21pemVkIE1DR0VOX0VWRU5UV1JJVEVUUkFOU0ZFUiBtYWNyb3MgbWlnaHQgaWdub3JlIEFjdGl2aXR5SWQuCiAgICBVTlJFRkVSRU5DRURfUEFSQU1FVEVSKEFjdGl2aXR5SWQpOwoKICAgIFRyYWl0cyA9IChjb25VQ1M0IGhpZ2gsIFB5X1VDUzQgbG93KSAgewogICAgYXNzZXJ0KFB5X1VOSUNPREVfSVNfSElHSF9TVVJST0dBVEUoaGlnaCkpOwogICAgYXNzZXJ0KFB5X1VOSUNPREVfSVNfTE9XX1NVUlJPR0FURShsb3cpKTsKICAgIHJldHVybiAweDEwMDAwICsgKCgoaGlnaCAmIDB4MDNGRikgPDwgMTApIHwgKGxvdyAmIDB4MDNGRikpOwp9CgovLyBIaWdoIHN1cnJvZ2F0ZSA9IHRvcCAxMCBiaXRzIGFkZGVkIHRvIDB4RDgwMC4KLy8gVGhlIGNoYXJhY3RlciBtdXN0IGJlIGluIHRoZSByYW5nZSBbVSsxMDAwMDsgVSsxMGZmZmZdLgpzdGF0aWMgaW5saW5lIFB5X1VDUzQgUHlfVU5JQ09ERV9ISUdIX1NVUlJPR0FURShQeV9VQ1M0IGNoKSB7CiAgICBhc3NlcnQoMHgxMDAwMCA8PSBjaCAmJiBjaCA8PSAweDEwZmZmZik7CiAgICByZXR1cm4gKDB4RDgwMCAtICgweDEwMDAwID4+IDEwKSArIChjaCA+PiAxMCkpOwp9CgovLyBMb3cgc3Vpb24gc2hvdWxkCi8vIHJldHVybiAwIG9uIHN1Y2Nlc3MgYW5kIC0xIG9uIGZhaWx1cmUuCnR5cGVkZWYgaW50IF9QeV9vbmNlX2ZuX3Qodm9pZCAqYXJnKTsKCi8vIChwcml2YXRlKSBzbG93IHBhdGggZm9yIG9uZSB0aW1lIGluaXRpYWxpemF0aW9uClB5QVBJX0ZVTkMoaW50KQpfUHlPbmNlRmxhZ19DYWxsT25jZVNsb3coX1B5T25jZUZsYWcgKmZsYWcsIF9QeV9vbmNlX2ZuX3QgKmZuLCB2b2lkICphcmcpOwoKLy8gQ2FsbHMgYGZuYCBvbmNlIHVzaW5nIGBmbGFnYC4gVGhlIGBhcmdgIGlzIHBhc3NlZCB0byB0aGUgY2FsbCB0byBgZm5gLgovLwovLyBSZXR1cm5zIDAgb24gc3VjY2VzcyBhbmQgLTEgb24gZmFpbHVyZS4KLy8KLy8gSWYgYGZuYCByZXR1cm5zIDAgKHN1Y2Nlc3MpLCB0aGVuIHN1YnNlcXVlbnQgY2FsbHMgaW1tZWRpYXRlbHkgcmV0dXJuIDAuCi8vIElmIGBmbmAgcmV0dXJucyAtMSAoZmFpbHVyZSksIHRjYWxscy5cbiIKIlxuIgoiVGhpcyBpcyB1c2VkLCBmb3IgZXhhbXBsZSwgd2hlbiB0aGUgaW50ZXJwcmV0ZXIgbG9hZHMgZXh0ZW5zaW9uXG4iCiJtb2R1bGVzLiBBbW9uZyBvdGhlciB0aGluZ3MsIHRoaXMgd2lsbCBlbmFibGUgYSBsYXp5IHJlc29sdmluZyBvZlxuIgoic3ltYm9scyB3aGVuIGltcG9ydGluZyBhIG1vZHVsZSwgaWYgY2FsbGVkIGFzIHN5cy5zZXRkbG9wZW5mbGFncygwKS5cbiIKIlRvIHNoYXJlIHN5bWJvbHMgYWNyb3NzIGV4dGVuc2lvbiBtb2R1bGVzLCBjYWxsIGFzXG4iCiJzeXMuc2V0ZGxvcGVuZmxhZ3Mob3MuUlRMRF9HTE9CQUwpLiAgU3ltYm9saWMgbmFtZXMgZm9yIHRoZSBmbGFnXG4iCiJtb2R1bGVzIGNhbiBiZSBmb3VuZCBpbiB0aGUgb3MgbW9kdWxlIChSVExEX3h4eCBjb25zdGFudHMsIGUuZy5cbiIKIm9zLlJUTERfTEFaWSkuIik7CgojZGVmaW5lIFNZU19TRVRETE9QRU5GTEFHU19NRVRfVU5DT0xMRUNUQUJMRSAtIFByaW50IHVucmVhY2hhYmxlIGJ1dCB1bmNvbGxlY3RhYmxlIG9iamVjdHNcbiIKIiAgICAgICAgZm91bmQuXG4iCiIgICAgICBERUJVR19TQVZFQUxMIC0gU2F2ZSBvYmplY3RzIHRvIGdjLmdhcmJhZ2UgcmF0aGVyIHRoYW4gZnJlZWluZyB0aGVtLlxuIgoiICAgICAgREVCVUdfTEVBSyAtIERlYnVnIGxlYWtpbmcgcHJvZ3JhbXMgKGV2ZXJ5dGhpbmcgYnV0IFNUQVRTKS5cbiIKIlxuIgoiRGVidWdnaW5nIGluZm9ybWF0aW9uIGlzIHdyaXR0ZW4gdG8gc3lzLnN0ZGVyci4iKTsKCiNkZWZpbmUgR0NfU0VUX0RFQlVHX01FVEhPRERFRiAgICBcCiAgICB7InNldF9kZWJ1ZyIsIChQeUNGdW5jdGlvbilnY19zZXRfZGVidWcsIE1FVEhfTywgZ2Nfc2V0X2RlYnVnX19kb2NfX30sCgpzdGF0aWMgUHlPYmplY3QgKgpnY19zZXRfZGVidWdfaW1wbChQeU9iamVjdCAqbW9kdWxlLCBpbnQgZmxhZ3MpOwpjdCAqKmRzdCA9IHR1cGxlLT5vYl9pdGVtOwogICAgZm9yIChQeV9zc2l6ZV90IGkgPSAwOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgUHlPYmplY3QgKml0ZW0gPSBzcmNbaV07CiAgICAgICAgZHN0W2ldID0gaXRlbTsKICAgIH0KICAgIF9QeU9iamVjdF9HQ19UUkFDSyh0dXBsZSk7CiAgICByZXR1cm4gKFB5T2JqZWN0ICopdHVwbGU7Cn0KCnN0YXRpYyBQeU9iamVjdCAqCnR1cGxlX3NsaWNlKFB5VHVwbGVPYmplY3QgKmEsIFB5X3NzaXplX3QgaWxvdywKICAgICAgICAgICBQeV9zc2l6ZV90IGloaWdoKQp7CiAgICBpZiAoaWxvdyA8IDApCiAgICAgICAgaWxvdyA9IDA7CiAgICBpZiAoaWhpZ2ggPiBQeV9TSVpFKGEpKQogICAgICAgIGloaWdoID0gUHlfU0laRShhKTsKICAgIGlmIChpaGlnaCA8IGlsb3cpCiAgICAgICAgaWhpZ2ggPSBpbG93OwogICAgaWYgKGlsb3cgPT0gMCAmJiBpaGlnaCA9PSBQeV9TSVpFKGEpICZlb2Yoc3RhdF9wYXRoKSwgIi9wcm9jLyVkL3N0YXQiLCAoaW50KXBpZCk7CgogICAgaW50IGZkID0gb3BlbihzdGF0X3BhdGgsIE9fUkRPTkxZKTsKICAgIGlmIChmZCA9PSAtMSkgewogICAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICBzc2l6ZV90IG4gPSByZWFkKGZkLCBidWZmZXIsIHNpemVvZihidWZmZXIpIC0gMSk7CiAgICBjbG9zZShmZCk7CgogICAgaWYgKG4gPD0gMCkgewogICAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIGJ1ZmZlcltuXSA9ICdcMCc7CgogICAgLyogRmluZCBjbG9zaW5nIHBhcmVuIG9mIGNvbW0gZmllbGQgLSBzdGF0IGZvcm1hdDogcGlkIChjb21tKSBzdGF0ZSBwcGlkIC4uLiAqLwogICAgY2hhciAqcCA9IHN0cnJjaHIoYnVmZmVyLCAnKScpOwogICAgaWYgKCFwKSB7CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQoKICAgIC8qIFNraXAgIikgIiB3aXRoIGJvdW5kcyBjaGVja2luZyAqLmR3TG93RGF0ZVRpbWU7CiAgICBsYXJnZS51LkhpZ2hQYXJ0ID0gc3lzdGVtX3RpbWUuZHdIaWdoRGF0ZVRpbWU7CgogICAgUHlUaW1lX3QgbnMgPSAobGFyZ2UuUXVhZFBhcnQgLSBTRUNTX0JFVFdFRU5fRVBPQ0hTICogSFVORFJFRF9OU19QRVJfU0VDKSAqIDEwMDsKICAgICp0cCA9IG5zOwogICAgaWYgKGluZm8pIHsKICAgICAgICAvLyBHZXRTeXN0ZW1UaW1lUHJlY2lzZUFzRmlsZVRpbWUoKSBpcyBpbXBsZW1lbnRlZCB1c2luZwogICAgICAgIC8vIFF1ZXJ5UGVyZm9ybWFuY2VDb3VudGVyKCkgaW50ZXJuYWxseS4KICAgICAgICBpbmZvLT5pbXBsZW1lbnRhdGlvbiA9ICJHZXRTeXN0ZW1UaW1lUHJlY2lzZUFzRmlsZVRpbWUoKSI7CiAgICAgICAgaW5mby0+bW9ub3RvbmljID0gMDsKICAgICAgICBpbmZvLT5yZXNvbHV0aW9uID0gX1B5VGltZUZyYWN0aW9uX1Jlc29sdXRpb24oJl9QeVJ1bnRpbWUudGltZS5iYXNlLT50bV95ZGF5ID0gX1B5VGltZV9jYWxjX3lkYXkoJnN0X3Jlc3VsdCk7CgogICAgLyogRFNUIGZsYWc6IC0xICh1bmtub3duKSBmb3IgbG9jYWwgdGltZSBvbiBoaXN0b3JpY2FsIGRhdGVzLCAwIGZvciBVVEMgKi8KICAgIHRtLT50bV9pc2RzdCA9IGlzX2xvY2FsID8gLTEgOiAwOwoKICAgIHJldHVybiAwOwp9CiNlbmRpZgoKCi8qIFJvdW5kIHRvIG5lYXJlc3Qgd2l0aCB0aWVzIGdvaW5nIHRvIG5lYXJlc3QgZXZlbiBpbnRlZ2VyCiAgIChfUHlUaW1lX1JPVU5EX0hBTEZfRVZFTikgKi8Kc3RhdGljIGRvdWJsZQpweXRpbWVfcm91bmRfaGFsZl9ldmVuKGRvdWJsZSB4KQp7CiAgICBkb3VibGUgcm91bmRlZCA9IHJvdW5kKHgpOwogICAgaWYgKGZhYnMoeC1yb3VuZGVkKSA9PSAwLjUpIHsKICAgICAgICAvKiBoYWxmd2F5IGNhc2U6IHJvdW5kIHRvIGV2ZW4gKi8KICAgICAgICByb3VuZGVkID0gMi4wICogcm91bmQoeCAvICAweGQ4LCAweGQ5LCAweGRhLCAweGRiLCAweGRjLCAweGRkLCAweGRlLCAweGRmLAogICAgMHhlMCwgMHhlMSwgMHhlMiwgMHhlMywgMHhlNCwgMHhlNSwgMHhlNiwgMHhlNywKICAgIDB4ZTgsIDB4ZTksIDB4ZWEsIDB4ZWIsIDB4ZWMsIDB4ZWQsIDB4ZWUsIDB4ZWYsCiAgICAweGYwLCAweGYxLCAweGYyLCAweGYzLCAweGY0LCAweGY1LCAweGY2LCAweGY3LAogICAgMHhmOCwgMHhmOSwgMHhmYSwgMHhmYiwgMHhmYywgMHhmZCwgMHhmZSwgMHhmZiwKfTsKCmNvbnN0IHVuc2lnbmVkIGNoYXIgX1B5X2N0eXBlX3RvdXBwZXJbMjU2XSA9IHsKICAgIDB4MDAsIDB4MDEsIDB4MDIsIDB4MDMsIDB4MDQsIDB4MDUsIDB4MDYsIDB4MDcsCiAgICAweDA4LCAweDA5LCAweDBhLCAweDBiLCAweDBjLCAweDBkLCAweDBlLCAweDBmLAogICAgMHgxMCwgMHgxMSwgMHgxMiwgMHgxMywgMHgxNCwgMHgxNSwgMHgxNiwgMHgxNywKICBlb2JqKSwgKG4pKSApCgovLyBBbGlhcyB0byBQeU9iamVjdF9OZXdWYXIoKS4gSW4gUHl0aG9uIDMuOCwgUHlPYmplY3RfTkVXX1ZBUigpIGNhbGxlZAovLyBkaXJlY3RseSBQeU9iamVjdF9NQUxMT0MoKSB3aXRoIF9QeU9iamVjdF9WQVJfU0laRSgpLgojZGVmaW5lIFB5T2JqZWN0X05FV19WQVIodHlwZSwgdHlwZW9iaiwgbikgUHlPYmplY3RfTmV3VmFyKHR5cGUsICh0eXBlb2JqKSwgKG4pKQoKCi8qCiAqIEdhcmJhZ2UgQ29sbGVjdGlvbiBTdXBwb3J0CiAqID09PT09PT09PT09PT09PT09PT09PT09PT09CiAqLwoKLyogQyBlcXVpdmFsZW50IG9mIGdjLmNvbGxlY3QoKS4gKi8KUHlBUElfRlVOQyhQeV9zc2l6ZV90KSBQeUdDX0NvbGxlY3Qodm9pZCk7Ci8qIEMgQVBJIGZvciBjb250cm9sbGluZyB0aGUgc3RhdGUgb2YgdGhlIGdhcmJhZ2UgY29sbGVjdG9yICovClB5QVBJX0ZVTkMoaW50KSBQeUdDX0VuYWJsZSh2b2lhbmRvbS4KLy8gVG8gYmUgY29udGludWVkLi4KI3ByYWdtYSBjb21tZW50IChsaWIsImFkdmFwaTMyLmxpYiIpCiNkZWZpbmUgUnRsR2VuUmFuZG9tICBTeXN0ZW1GdW5jdGlvbjAzNgptaV9kZWNsX2V4dGVybmMgQk9PTEVBTiBOVEFQSSBSdGxHZW5SYW5kb20oUFZPSUQgUmFuZG9tQnVmZmVyLCBVTE9ORyBSYW5kb21CdWZmZXJMZW5ndGgpOwoKYm9vbCBfbWlfcHJpbV9yYW5kb21fYnVmKHZvaWQqIGJ1Ziwgc2l6ZV90IGJ1Zl9sZW4pIHsKICByZXR1cm4gKFJ0bEdlblJhbmRvbShidWYsIChVTE9ORylidWZfbGVuKSAhPSAwKTsKfQoKI2Vsc2UKCiNpZm5kZWYgQkNSWVBUX1VTRV9TWVNURU1fUFJFRkVSUkVEX1JORwojZGVmaW5lIEJDUllQVF9VU0VfU1lTVEVNX1BSRUZFUlJFRF9STkcgMHgwMDAwMDAwMgojZW5kaWYKCnR5cGVkZWYgTE9ORyAoTlRBUEkgKlBCQ3J5cHRHZW5SYW5kb20pKEhBTkRMRSwgUFVDSEFSLCBVTE9kIGJ5IGRvaW5nCiAgICAgc3ZuIGNvIHN2bjovL3N2bi52YWxncmluZC5vcmcvdmFsZ3JpbmQvdHJ1bmsvaW5jbHVkZQoKICBJZiBmb3Igc29tZSByZWFzb24geW91IGNhbid0IHVzZSAidmFsZ3JpbmQuaCIgb3Igd2FudCB0byBmYWtlIHZhbGdyaW5kLAogIHRoZXJlIGFyZSB0d28gd2F5cyB0byBtYWtlIHRoaXMgZnVuY3Rpb24gcmV0dXJuIG5vbi16ZXJvOgogICAgLSBVc2UgZW52aXJvbm1lbnQgdmFyaWFibGU6IGV4cG9ydCBSVU5OSU5HX09OX1ZBTEdSSU5EPTEKICAgIC0gTWFrZSB5b3VyIHRvb2wgaW50ZXJjZXB0IHRoZSBmdW5jdGlvbiBSdW5uaW5nT25WYWxncmluZCgpIGFuZAogICAgICBjaGFuZ2UgaXRzIHJldHVybiB2YWx1ZS4KICovCmludCBSdW5uaW5nT25WYWxncmluZCh2b2lkKTsKCiNpZmRlZiBfX2NwbHVzcGx1cwp9CiNlbmRpZgoKI2lmIERZTkFNSUNfQU5OT1RBVElPTlNfRU5BQkxFRCAhPSAwICYmIGR0Zm9ybVxuXApDIGNvbXBpbGVyIHVzZWQgdG8gYnVpbGQgUHl0aG9uIHN1cHBvcnRzICdsb25nIGxvbmcnLCBvciwgb24gV2luZG93cyxcblwKJ19faW50NjQnLlxuXApcblwKTWV0aG9kczpcblwKXG5cCmFwcGVuZCgpIC0tIGFwcGVuZCBhIG5ldyBpdGVtIHRvIHRoZSBlbmQgb2YgdGhlIGFycmF5XG5cCmJ1ZmZlcl9pbmZvKCkgLS0gcmV0dXJuIGluZm9ybWF0aW9uIGdpdmluZyB0aGUgY3VycmVudCBtZW1vcnkgaW5mb1xuXApieXRlc3dhcCgpIC0tIGJ5dGVzd2FwIGFsbCB0aGUgaXRlbXMgb2YgdGhlIGFycmF5XG5cCmNvdW50KCkgLS0gcmV0dXJuIG51bWJlciBvZiBvY2N1cnJlbmNlcyBvZiBhbiBvYmplY3RcblwKZXh0ZW5kKCkgLS0gZXh0ZW5kIGFycmF5IGJ5IGFwcGVuZGluZyBtdWx0aXBsZSBlbGVtZW50cyBmcm9tIGFuIGl0ZXJhYmxlXG5cCmZyb21maWxlKCkgLS0gcmVhZCBpdGVtcyBmcm9tIGEgZmlsZSBvYiBvZiB0eXBlcy4KICoKICogRG9uJ3QgZm9yZ2V0IHRvIHVwZGF0ZSB0eXBlY29kZV90b19tZm9ybWF0X2NvZGUoKSBpZiB5b3UgYWRkIGEgbmV3CiAqIHR5cGVjb2RlLgogKi8Kc3RhdGljIGNvbnN0IHN0cnVjdCBhcnJheWRlc2NyIGRlc2NyaXB0b3JzW10gPSB7CiAgICB7J2InLCAxLCBiX2dldGl0ZW0sIGJfc2V0aXRlbSwgYl9jb21wYXJlaXRlbXMsICJiIiwgMSwgMX0sCiAgICB7J0InLCAxLCBCQl9nZXRpdGVtLCBCQl9zZXRpdGVtLCBCQl9jb21wYXJlaXRlbXMsICJCIiwgMSwgMH0sCiAgICB7J3UnLCBzaXplb2Yod2NoYXJfdCksIHVfZ2V0aXRlbSwgdV9zZXRpdGVtLCB1X2NvbXBhcmVpdGVtcywgInUiLCAwLCAwfSwKICAgIHsndycsIHNpemVvZihQeV9VQ1M0KSwgd19nZXRpdGVtLCB3X3NldGl0ZW0sIHdfY29tcGFyZWl0ZW1zLCAidyIsIDAsIDAsfSwKICAgIHsnaCcsIHNpemVvZihzaG9ydCksIGhfZ2V0aSBvZiBhcHBlbmRzKCkgaW4gdGhlIHByZXNlbmNlIG9mIGEgcG9vcmx5LXBlcmZvcm1pbmcKICAgICAqIHN5c3RlbSByZWFsbG9jKCkuCiAgICAgKiBUaGUgZ3Jvd3RoIHBhdHRlcm4gaXM6ICAwLCA0LCA4LCAxNiwgMjUsIDM0LCA0NiwgNTYsIDY3LCA3OSwgLi4uCiAgICAgKiBOb3RlLCB0aGUgcGF0dGVybiBzdGFydHMgb3V0IHRoZSBzYW1lIGFzIGZvciBsaXN0cyBidXQgdGhlbgogICAgICogZ3Jvd3MgYXQgYSBzbWFsbGVyIHJhdGUgc28gdGhhdCBsYXJnZXIgYXJyYXlzIG9ubHkgb3ZlcmFsbG9jYXRlCiAgICAgKiBieSBhYm91dCAxLzE2dGggLS0gdGhpcyBpcyBkb25lIGJlY2F1c2UgYXJyYXlzIGFyZSBwcmVzdW1lZCB0byBiZSBtb3JlCiAgICAgKiBtZW1vcnkgY3JpdGljYWwuCiAgICAgKi8KCiAgICBfbmV3X3NpemUgPSAobmV3c2l6ZSA+PiA0KSArIChQeV9TSVpFKHNlbGYpIDwgOCA/IDMgOiA3KSArIG5ld3NlID0gYnVpbHRpbl9jb21waWxlX2ltcGwobW9kdWxlLCBzb3VyY2UsIGZpbGVuYW1lLCBtb2RlLCBmbGFncywgZG9udF9pbmhlcml0LCBvcHRpbWl6ZSwgbW9kbmFtZSwgZmVhdHVyZV92ZXJzaW9uKTsKCmV4aXQ6CiAgICAvKiBDbGVhbnVwIGZvciBmaWxlbmFtZSAqLwogICAgUHlfWERFQ1JFRihmaWxlbmFtZSk7CgogICAgcmV0dXJuIHJldHVybl92YWx1ZTsKfQoKUHlEb2NfU1RSVkFSKGJ1aWx0aW5fZGl2bW9kX19kb2NfXywKImRpdm1vZCgkbW9kdWxlLCB4LCB5LCAvKVxuIgoiLS1cbiIKIlxuIgoiUmV0dXJuIHRoZSB0dXBsZSAoeC8veSwgeCV5KS4gIEludmFyaWFudDogZGl2KnkgKyBtb2QgPT0geC4iKTsKCiNkZWZpbmUgQlVJTFRJTl9ESVZNT0RfTUVUSE9EREVGICAgIFwKICAgIHsiZGl2bW9kIiwgX1B5Q0Z1bmN0aW9uX0NBU1QoYnVpbHRpbl9kaXZtb2QpLCBNRVRIX0ZBU1RDQUxMLCBidWlsY29kZV9FcXVhbFRvQVNDSUlTdHJpbmcoKQoKI2RlZmluZSBVTkRFRklORURfRlVUVVJFX0ZFQVRVUkUgImZ1dHVyZSBmZWF0dXJlICUuMTAwcyBpcyBub3QgZGVmaW5lZCIKCnN0YXRpYyBpbnQKZnV0dXJlX2NoZWNrX2ZlYXR1cmVzKF9QeUZ1dHVyZUZlYXR1cmVzICpmZiwgc3RtdF90eSBzLCBQeU9iamVjdCAqZmlsZW5hbWUpCnsKICAgIFB5X3NzaXplX3QgaTsKCiAgICBhc3NlcnQocy0+a2luZCA9PSBJbXBvcnRGcm9tX2tpbmQpOwoKICAgIGFzZGxfYWxpYXNfc2VxICpuYW1lcyA9IHMtPnYuSW1wb3J0RnJvbS5uYW1lczsKICAgIGZvciAoaSA9IDA7IGkgPCBhc2RsX3NlcV9MRU4obmFtZXMpOyBpKyspIHsKICAgICAgICBhbGlhc190eSBuYW1lID0gKGFsaWFzX3R5KWFzZGxfc2VxX0dFVChuYW1lcywgaSk7CiAgICAgICAgY29uc3QgY2hhciAqZmVhdHVyZSA9IFB5VW5pY29kZV9Bc1VURjgobmFtZS0+bmFtaXZlZCwgUHlPYmplY3QgKmNscykKewogICAgUHlPYmplY3QgKmNoZWNrZXI7CgogICAgLyogV2Uga25vdyB3aGF0IHR5cGUncyBfX3N1YmNsYXNzY2hlY2tfXyBkb2VzLiAqLwogICAgaWYgKFB5VHlwZV9DaGVja0V4YWN0KGNscykpIHsKICAgICAgICAvKiBRdWljayB0ZXN0IGZvciBhbiBleGFjdCBtYXRjaCAqLwogICAgICAgIGlmIChkZXJpdmVkID09IGNscykKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgcmV0dXJuIHJlY3Vyc2l2ZV9pc3N1YmNsYXNzKGRlcml2ZWQsIGNscyk7CiAgICB9CgogICAgaWYgKF9QeVVuaW9uX0NoZWNrKGNscykpIHsKICAgICAgICBjbHMgPSBfUHlfdW5pb25fYXJncyhjbHMpOwogICAgfQoKICAgIGlmIChQeVR1cGxlX0NoZWNrKGNscykpIHsKCiAgICAgICAgaWYgKF9QeV9FbnRlclJlY3Vyc2l2ZUNhbGxUc3RhdGUodHN0YXRlLCAiIGluIF9fc3ViY2xhc3NjaGVja19fIikpIHsKciwgbSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBOVUxMOwogICAgfQoKICAgIHYgPSBQeVNlcXVlbmNlX0xpc3QoaXQpOwogICAgUHlfREVDUkVGKGl0KTsKCiAgICByZXR1cm4gdjsKfQoKLyogSXRlcmF0ZSBvdmVyIHNlcS4gIFJlc3VsdCBkZXBlbmRzIG9uIHRoZSBvcGVyYXRpb246CiAgIFBZX0lURVJTRUFSQ0hfQ09VTlQ6ICAtMSBpZiBlcnJvciwgZWxzZSAjIG9mIHRpbWVzIG9iaiBhcHBlYXJzIGluIHNlcS4KICAgUFlfSVRFUlNFQVJDSF9JTkRFWDogIDAtYmFzZWQgaW5kZXggb2YgZmlyc3Qgb2NjdXJyZW5jZSBvZiBvYmogaW4gc2VxOwogICAgc2V0IFZhbHVlRXJyb3IgYW5kIHJldHVybiAtMSBpZiBub25lIGZvdW5kOyBhbHNvIHJldHVybiAtMSBvbiBlcnJvci4KICAgUFlfSVRFUlNFQVJDSF9DT05UQUlOUzogIHJldHVybiAxIGlmIG9iaiBpbiBzZXEsIGVsc2UgMDsgLTEgb24gZXJyb3IuCiovClB5X3NzNikKX3JfZGlnaXRzKDMyKQojdW5kZWYgX3JfZGlnaXRzCgpzdGF0aWMgdm9pZAp3X1B5TG9uZyhjb25zdCBQeUxvbmdPYmplY3QgKm9iLCBjaGFyIGZsYWcsIFdGSUxFICpwKQp7CiAgICBXX1RZUEUoVFlQRV9MT05HLCBwKTsKICAgIGlmIChfUHlMb25nX0lzWmVybyhvYikpIHsKICAgICAgICB3X2xvbmcoKGxvbmcpMCwgcCk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIFB5TG9uZ0V4cG9ydCBsb25nX2V4cG9ydDsKCiAgICBpZiAoUHlMb25nX0V4cG9ydCgoUHlPYmplY3QgKilvYiwgJmxvbmdfZXhwb3J0KSA8IDApIHsKICAgICAgICBwLT5kZXB0aC0tOwogICAgICAgIHAtPmVycm9yID0gV0ZFUlJfVU5NQVJTSEFMTEFCTEU7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCFsb25nX2V4cG9ydC5kaWdpdHMpIHsKICAgICAgICBpbnQ4X3Qgc2lnbiA9IGxvbmdfZXhwb3J0LnZhbHVlIDwgMCA/IC0xIDogMTsKdXQ9MjA4MjlmMDBiZWJjZTU1YiBpbnB1dD1jZDM1Nzg5NmQ2NTAxZjY4XSovCnsKI2RlZmluZSBDQ0hfRVhUIDEyOAojZGVmaW5lIENCX1RZUEUgNTEwCiAgICBzdHJ1Y3QgewogICAgICAgIHdjaGFyX3QgZXh0W0NDSF9FWFRdOwogICAgICAgIHdjaGFyX3QgdHlwZVtDQl9UWVBFIC8gc2l6ZW9mKHdjaGFyX3QpICsgMV07CiAgICB9IGVudHJpZXNbNjRdOwogICAgaW50IGVudHJ5ID0gMDsKICAgIEhLRVkgaGtjciA9IE5VTEw7CiAgICBMUkVTVUxUIGVycjsKCiAgICBQeV9CRUdJTl9BTExPV19USFJFQURTCiAgICBlcnIgPSBSZWdPcGVuS2V5RXhXKEhLRVlfQ0xBU1NFU19ST09ULCBOVUxMLCAwLCBLRVlfUkVBRCwgJmhrY3IpOwogICAgZm9yIChEV09SRCBpID0gMDsgZXJyID09IEVSUk9SX1NVQ0NFU1MgfHwgZXJyID09IEVSUk9SX01PUkVfREFUQTsgKytpKSB7CiAgICAgICAgTFBXU1RSIGV4dCA9IGVudHJpZXNbZW50U1BFQ0lBTCwgSU5ESVJFQ1QgT1IKICogQ09OU0VRVUVOVElBTCBEQU1BR0VTIE9SIEFOWSBEQU1BR0VTIFdIQVRTT0VWRVIgUkVTVUxUSU5HIEZST00gTE9TUwogKiBPRiBVU0UsIERBVEEgT1IgUFJPRklUUywgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsCiAqIE5FR0xJR0VOQ0UgT1IgT1RIRVIgVE9SVElPVVMgQUNUSU9OLCBBUklTSU5HIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OCiAqIFdJVEggVEhFIFVTRSBPUiBQRVJGT1JNQU5DRSBPRiBUSElTIFNPRlRXQVJFLgogKgogKi8KCi8qIExpY2Vuc2VkIHRvIFBTRiB1bmRlciBhIENvbnRyaWJ1dG9yIEFncmVlbWVudC4gKi8KLyogU2VlIGh0dHBzOi8vd3d3LnB5dGhvbi5vcmcvMi40L2xpY2Vuc2UgZm9yIGxpY2Vuc2luZyBkZXRhaWxzLiAqLwoKI2luY2x1ZGUgIlB5dGhvbi5oIgojaW5jbHVkZSAicHljb3JlX21vZHVsZW9iamVjdC5oIiAgLy8gX1B5TW9kdm9pZCB6b25lX3VucmVnaXN0ZXIobWFsbG9jX3pvbmVfdCogem9uZSkgewogIE1JX1VOVVNFRCh6b25lKTsKfQoKLy8gdXNlIGludGVycG9zaW5nIHNvIGBEWUxEX0lOU0VSVF9MSUJSQVJJRVNgIHdvcmtzIHdpdGhvdXQgYERZTERfRk9SQ0VfRkxBVF9OQU1FU1BBQ0U9MWAKLy8gU2VlOiA8aHR0cHM6Ly9ib29rcy5nb29nbGUuY29tL2Jvb2tzP2lkPUs4dlVrcE9YaE40QyZwZz1QQTczPgpzdHJ1Y3QgbWlfaW50ZXJwb3NlX3MgewogIGNvbnN0IHZvaWQqIHJlcGxhY2VtZW50OwogIGNvbnN0IHZvaWQqIHRhcmdldDsKfTsKI2RlZmluZSBNSV9JTlRFUlBPU0VfRlVOKG9sZGZ1bixuZXdmdW4pIHsgKGNvbnN0IHZvaWQqKSZuZXdmdW4sIChjb25zdCB2b2lkKikmb2xkZnVuIH0KI2RlZmluZSBNSV9JTlRFUlBPU0VfTUkoZnVuKSAgICAgICAgICAgIE1JX0lOVEVSUE9TRV9GVU4oZnVuLG1pXyMjZnVuKQojZGVtZSksICIlLjIwc18lLjIwMHMiLCBwcmVmaXgsIHNob3J0bmFtZSk7CgogICAgewogICAgICAgIEhJTlNUQU5DRSBoRExMID0gTlVMTDsKI2lmZGVmIE1TX1dJTkRPV1NfREVTS1RPUAogICAgICAgIHVuc2lnbmVkIGludCBvbGRfbW9kZTsKCiAgICAgICAgLyogRG9uJ3QgZGlzcGxheSBhIG1lc3NhZ2UgYm94IHdoZW4gUHl0aG9uIGNhbid0IGxvYWQgYSBETEwgKi8KICAgICAgICBvbGRfbW9kZSA9IFNldEVycm9yTW9kZShTRU1fRkFJTENSSVRJQ0FMRVJST1JTKTsKI2VuZGlmCgogICAgICAgIC8qIGJwby0zNjA4NTogV2UgdXNlIExvYWRMaWJyYXJ5RXggd2l0aCByZXN0cmljdGVkIHNlYXJjaCBwYXRocwogICAgICAgICAgIHRvIGF2b2lkIERMTCBwcmVsb2FkaW5nIGF0dGFja3MgYW5kIGVuYWJsZSB1c2Ugb2YgdGhlCiAgICAgICAgICAgQWRkRGxsRGlyZWN0b3J5IGZ1bmN0aW9uLiBXZSBhZGQgU0VBUkNIX0RMTF9MT0EgaW5zdC0+Zm9ybWF0ID0gVU9QX0ZPUk1BVF9UQVJHRVQ7CiAgICBpbnN0LT50YXJnZXQgPSB0YXJnZXQ7CiAgICBpbnN0LT5vcGFyZyA9IG9wYXJnOwogICAgaW5zdC0+b3BlcmFuZDAgPSBvcGVyYW5kOwojaWZkZWYgUHlfU1RBVFMKICAgIGluc3QtPmV4ZWN1dGlvbl9jb3VudCA9IDA7CiNlbmRpZgogICAgdHJhY2UtPm5leHQrKzsKfQoKCiNpZmRlZiBQeV9ERUJVRwojZGVmaW5lIEFERF9UT19UUkFDRShPUENPREUsIE9QQVJHLCBPUEVSQU5ELCBUQVJHRVQpIFwKICAgIGFkZF90b190cmFjZSh0cmFjZSwgKE9QQ09ERSksIChPUEFSRyksIChPUEVSQU5EKSwgKFRBUkdFVCkpOyBcCiAgICBpZiAobGx0cmFjZSA+PSAyKSB7IFwKICAgICAgICBwcmludGYoIiU0ZCBBRERfVE9fVFJBQ0U6ICIsIHVvcF9idWZmZXJfbGVuZ3RoKHRyYWNlKSk7IFwKICAgICAgICBfUHlVT3BQcmludCh1b3BfYnVmZmVyX2xhc3QodHJhY2Eub3BhcmcgPSBpbnN0ci0+b3AuYXJnOwogICAgZXhlY3V0b3ItPnZtX2RhdGEuY29kZSA9IGNvZGU7CiAgICBleGVjdXRvci0+dm1fZGF0YS5pbmRleCA9IChpbnQpKGluc3RyIC0gX1B5Q29kZV9DT0RFKGNvZGUpKTsKICAgIGNvZGUtPmNvX2V4ZWN1dG9ycy0+ZXhlY3V0b3JzW2luZGV4XSA9IGV4ZWN1dG9yOwogICAgYXNzZXJ0KGluZGV4IDwgTUFYX0VYRUNVVE9SU19TSVpFKTsKICAgIGluc3RyLT5vcC5jb2RlID0gRU5URVJfRVhFQ1VUT1I7CiAgICBpbnN0ci0+b3AuYXJnID0gaW5kZXg7Cn0KCnN0YXRpYyBfUHlFeGVjdXRvck9iamVjdCAqCm1ha2VfZXhlY3V0b3JfZnJvbV91b3BzKF9QeVRocmVhZFN0YXRlSW1wbCAqdHN0YXRlLCBfUHlVT3BJbnN0cnVjdGlvbiAqYnVmZmVyLCBpbnQgbGVuZ3RoLCBjb25zdCBfUHlCbG9vbUZpbHRlciAqZGVwZW5kZW5jaWVzKTsKCnN0YXRpYyBpbnQKdW9wX29wdGltaXplKF9QeWFzZSAnfSc6CgkJCW4tLTsKCQkJY29udGludWU7CgkJY2FzZSAnUic6CgkJCWlmIChuID09IDEgJiYgIW1lbWNtcChzLCAiRV9EVVBfTUFYIiwgOSkpCgkJCXsKCQkJCXMtLTsKCQkJCWZvciAodCA9IG90OyBvcyA8IHM7ICp0KysgPSAqb3MrKyk7CgkJCQlyID0gKCh0IC0gb3QpID49IDUgJiYgdFstMV0gPT0gJ3snICYmIHRbLTJdID09ICcuJyAmJiB0Wy0zXSA9PSAnLicgJiYgdFstNF0gPT0gJy4nKSA/IHRbLTVdIDogMDsKCQkJCW9zID0gb3Q7CgkJCQltID0gUkVfRFVQX01BWDsKCQkJCWlmICgqKHMgKz0gMTApID09ICcrJyB8fCAqcyA9PSAnLScpCgkJCQkJbSArPSBzdHJ0b2wocywgJnMsIDEwKTsKCQkJCWlmIChyKQoJCQkJewoJCQkJCXQgLT0gNTsKCQkJCQl3aGlsZSAobS0tID4gMCkKCQkJCQkJKnQrKyA9IHI7CgkJCQkJd2hpbGUgKCpzICYmICpzKysgIT0gJ30nKTsKCQkJCX0KCQkJCWVsc2UKCQkJCQl0ICs9IG9yLCAidW5yZWNvZ25pemVkIGtpbmQiKTsKICAgICAgICByZXR1cm4gTlVMTDsKICAgIH0KCiAgICBpZiAoIXVubGluaykgewogICAgICAgIG5hbWVfY29weSA9IFB5TWVtX01hbGxvYyhzdHJsZW4obmFtZSkgKyAxKTsKICAgICAgICBpZiAobmFtZV9jb3B5ID09IE5VTEwpIHsKICAgICAgICAgICAgcmV0dXJuIFB5RXJyX05vTWVtb3J5KCk7CiAgICAgICAgfQogICAgICAgIHN0cmNweShuYW1lX2NvcHksIG5hbWUpOwogICAgfQoKICAgIFNFTV9DTEVBUl9FUlJPUigpOwogICAgaGFuZGxlID0gU0VNX0NSRUFURShuYW1lLCB2YWx1ZSwgbWF4dmFsdWUpOwogICAgLyogT24gV2luZG93cyB3ZSBzaG91bGQgZmFpbCBpZiBHZXRMYXN0RXJyb3IoKT09RVJST1JfQUxSRUFEWV9FWElTVFMgKi8KICAgIGlmIChoYW5kbGUgPT0gU0VNX0ZBSUxFRCB8fCBTRU1fR0VUX0xBU1RfRVJST1IoKSAhPSAwKQogbmQsIG9yIG5vIHRlc3QgbmFtZSBwcm92aWRlZCwgc28gZGlzcGxheSB1c2FnZSAqLwogICAgcHJpbnRmKCJQeXRob24gIiBQWV9WRVJTSU9OICIgX3Rlc3RlbWJlZCBleGVjdXRhYmxlIGZvciBlbWJlZGRlZCBpbnRlcnByZXRlciB0ZXN0c1xuIgogICAgICAgICAgICJOb3JtYWxseSBleGVjdXRlZCB2aWEgJ0VtYmVkZGluZ1Rlc3RzJyBpbiBMaWIvdGVzdC90ZXN0X2VtYmVkLnB5XG5cbiIKICAgICAgICAgICAiVXNhZ2U6ICVzIFRFU1ROQU1FXG5cbkFsbCBhdmFpbGFibGUgdGVzdHM6XG4iLCBhcmd2WzBdKTsKICAgIGZvciAoc3RydWN0IFRlc3RDYXNlICp0YyA9IFRlc3RDYXNlczsgdGMgJiYgdGMtPm5hbWU7IHRjKyspIHsKICAgICAgICBwcmludGYoIiAgJXNcbiIsIHRjLT5uYW1lKTsKICAgIH0KCiAgICAvKiBOb24temVybyBleGl0IGNvZGUgd2lsbCBjYXVzZSB0ZXN0X2VtYmVkLnB5IHRlc3RzIHRvIGZhaWwuCiAgbmRvbSBpbnB1dHMgd2l0aCBuPTUuIFs3XQoKUmVmZXJlbmNlczoKCjEuIFZlbHRrYW1wLURla2tlciBzcGxpdHRpbmc6IGh0dHA6Ly9jc2NsdWIudXdhdGVybG9vLmNhL35wYmFyZnVzcy9kZWtrZXIxOTcxLnBkZgoyLiBDb21wZW5zYXRlZCBzdW1tYXRpb246ICBodHRwOi8vd3d3LnRpMy50dS1oYXJidXJnLmRlL3BhcGVyL3J1bXAvUnUwOGIucGRmCjMuIFNxdWFyZSByb290IGRpZmZlcmVudGlhbCBjb3JyZWN0aW9uOiAgaHR0cHM6Ly9hcnhpdi5vcmcvcGRmLzE5MDQuMDk0ODEucGRmCjQuIERhdGEgZGVwZW5kZW5jeSBncmFwaDogIGh0dHBzOi8vYnVncy5weXRob24ub3JnL2ZpbGU0OTQzOS9oeXBvdC5wbmcKNS4gaHR0cHM6Ly93d3cud29sZnJhbWFscGhhLmNvbS9pbnB1dC8/aT1NYWNsYXVyaW4rc2VyaWVzK3NxcnQlMjhoKioyKyUyQit4JTI5K2F0K3glM0QwCjYuIEFuYWx5c2lzIG9mIGludGVybmFsIGFjY3VyYWN5YWx1ZSgiKGRkKSIsIHgsIHkpOwp9CgoKLyogQSBkZWNlbnQgbG9nYXJpdGhtIGlzIGVhc3kgdG8gY29tcHV0ZSBldmVuIGZvciBodWdlIGludHMsIGJ1dCBsaWJtIGNhbid0CiAgIGRvIHRoYXQgYnkgaXRzZWxmIC0tIGxvZ2hlbHBlciBjYW4uICBmdW5jIGlzIGxvZyBvciBsb2cxMCwgYW5kIG5hbWUgaXMKICAgImxvZyIgb3IgImxvZzEwIi4gIE5vdGUgdGhhdCBvdmVyZmxvdyBvZiB0aGUgcmVzdWx0IGlzbid0IHBvc3NpYmxlOiBhbiBpbnQKICAgY2FuIGNvbnRhaW4gbm8gbW9yZSB0aGFuIElOVF9NQVggKiBTSElGVCBiaXRzLCBzbyBoYXMgdmFsdWUgY2VydGFpbmx5IGxlc3MKICAgdGhhbiAyKiooMioqNjQgKiAyKioxNikgPT0gMioqMioqODAsIGFuZCBsb2cyIG9mIHRoYXQgaXMgMioqODAsIHdoaWNoIGlzCiAgIHNtYWxsIGVub3VnaCB0byBmaXQgaW4gYW4gSUVFRSBzaW5nbGUuICBsb2cgYW5kIGxvZzEwIGFyZSBwcmV0ZWQKICogICAgIGFzIGFuIDgwIGJpdCBsb25nIGRvdWJsZSBieSBmbGR0LgogKiAgIC0gSW50ZWwgY29tcGlsZXJzIHByaW9yIHRvIHZlcnNpb24gMTEgZG8gbm90IHNlZW0gdG8gaGFuZGxlIHRoZQogKiAgICAgX19HTlVDX18gaW5saW5lIGFzc2VtYmx5IGNvcnJlY3RseS4KICogICAtIHJhbmRvbSB0ZXN0cyBhcmUgcHJvdmlkZWQgaW4gdGVzdHMvZXh0ZW5kZWQvcHByb19tdWxtb2QuYwogKi8KCiNpZiBkZWZpbmVkKFBQUk8pCiNpZiBkZWZpbmVkKEFTTSkKCi8qIFJldHVybiAoYSAqIGIpICUgZG1vZCAqLwpzdGF0aWMgaW5saW5lIG1wZF91aW50X3QKcHByb19tdWxtb2QobXBkX3VpbnRfdCBhLCBtcGRfdWludF90IGIsIGRvdWJsZSAqZG1vZCwgdWludDMyX3QgKmRpbnZtb2QpCnsKICAgIG1wZF91aW50X3QgcmV0dmFsOwoKICAgIF9fYXNtX18gKAogICAgICAgICAgICAiZmlsZGwgICUyXG5cdCIKICAgQUNMKiBITUFDIEFQSSAqLwogICAgcHlfaG1hY19oYWNsX2FwaSBhcGk7CgogICAgLyoKICAgICAqIENhY2hlZCBmaWVsZCBzdG9yaW5nIHRoZSAnaGFzaGxpYl9uYW1lJyBmaWVsZCBhcyBhIFB5dGhvbiBzdHJpbmcuCiAgICAgKgogICAgICogVGhpcyBmaWVsZCBpcyBOVUxMIGJ5IGRlZmF1bHQgaW4gdGhlIGl0ZW1zIG9mICJweV9obWFjX3N0YXRpY19oaW5mbyIKICAgICAqIGJ1dCB3aWxsIGJlIHBvcHVsYXRlZCB3aGVuIGNyZWF0aW5nIHRoZSBtb2R1bGUncyBzdGF0ZSAiaGluZm9fdGFibGUiLgogICAgICovCiAgICBQeU9iamVjdCAqZGlzcGxheV9uYW1lOwogICAgY29uc3QgY2hhciAqaGFzaGxpYl9uYW1lOyAgIC8qIGhhc2hsaWIgcHJlZmVycmVkIG5hbWUgKGRlZmF1bHQ6IG5hbWUpICovCgogICAgUHlfc3NpemVfdCByZWZjbnQ7Cn0gcHlfaG1hY19oaW5mbzsKCi8vIC0tLSBITUFDIG1vZHVsZSBzdGF0ZSAtLS0tdWYtPndyaXRlci5taW5fbGVuZ3RoICs9IHNpemU7CiAgICByZXR1cm4gMDsKfQoKc3RhdGljIGludApkZWNvZGVyX2ZlZWRfYnVmZmVyKE11bHRpYnl0ZVN0YXRlZnVsRGVjb2RlckNvbnRleHQgKmN0eCwKICAgICAgICAgICAgICAgICAgICBNdWx0aWJ5dGVEZWNvZGVCdWZmZXIgKmJ1ZikKewogICAgd2hpbGUgKGJ1Zi0+aW5idWYgPCBidWYtPmluYnVmX2VuZCkgewogICAgICAgIFB5X3NzaXplX3QgaW5sZWZ0OwogICAgICAgIFB5X3NzaXplX3QgcjsKCiAgICAgICAgaW5sZWZ0ID0gKFB5X3NzaXplX3QpKGJ1Zi0+aW5idWZfZW5kIC0gYnVmLT5pbmJ1Zik7CgogICAgICAgIHIgPSBjdHgtPmNvZGVjLT5kZWNvZGUoJmN0eC0+c3RhdGUsIGN0eC0+Y29kZWMsCiAgICAgICAgICAgICZidWYtPmluYnVmLCBpbmxlZnQsICZidWYtPndyaXRlcik7CiAgICAgICAgaWYgKHIgPT0gMCB8fCByID09IE1CRVJSX1RPT0ZFVykKICAgdGF0ZSh0aHJlYWQsIEFSTV9VTklGSUVEX1RIUkVBRF9TVEFURSwgKHRocmVhZF9zdGF0ZV90KSZ0aHJlYWRfc3RhdGUsIHN0YXRlX2NvdW50KTsKCWlmIChyZXQpIHsKCQlmcHJpbnRmKHN0ZGVyciwgInJ1bnRpbWUvY2dvOiB0aHJlYWRfc2V0X3N0YXRlIGZhaWxlZDogJWRcbiIsIHJldCk7CgkJYWJvcnQoKTsKCX0KCglyZXR1cm4gS0VSTl9TVUNDRVNTOwp9Cgp2b2lkCmRhcndpbl9hcm1faW5pdF90aHJlYWRfZXhjZXB0aW9uX3BvcnQoKQp7CgkvLyBDYWxsZWQgYnkgZWFjaCBuZXcgT1MgdGhyZWFkIHRvIGJpbmQgaXRzIEVYQ19CQURfQUNDRVNTIGV4Y2VwdGlvbgoJLy8gdG8gbWFjaF9leGNlcHRpb25faGFuZGxlcl9wb3J0X3NldC4KCWludCByZXQ7CgltYWNoX3BvcnRfdCBwb3J0ID0gTUFDSF9QT1JUX05VTEw7CgoJcmV0ID0gbWFjaF9wb3J0X2FsbG9jYXRlKG1hY2hfdGFza19zZWxmKCksIE1BQ0hfUE9SVF9SSUdIcFsyVV07CiAgdWludDY0X3QgdG1wMyA9IHRtcFszVV07CiAgdWludDY0X3QgdG1wNCA9IHRtcFs0VV07CiAgdWludDY0X3QgdG1wNSA9IHRtcFs1VV07CiAgdWludDY0X3QgdG1wNiA9IHRtcFs2VV07CiAgdWludDY0X3QgdG1wNyA9IHRtcFs3VV07CiAgdWludDY0X3QgaXYwXyA9IGl2MCBeIHRtcDA7CiAgdWludDY0X3QgaXYxXyA9IGl2MSBeIHRtcDE7CiAgdWludDY0X3QgaXYyXyA9IGl2MiBeIHRtcDI7CiAgdWludDY0X3QgaXYzXyA9IGl2MyBeIHRtcDM7CiAgdWludDY0X3QgaXY0XyA9IGl2NCBeIHRtcDQ7CiAgdWludDY0X3QgaXY1XyA9IGl2NSBeIHRtcDU7CiAgdWludDY0X3QgaXY2XyA9IGl2NiBeIHRtcDY7CiAgdWludDY0X3QgaXY3XyA9IGl2NyBeIHRtcDc7CiAgcjBbMFVdID0gTGliX0ludFZlY3Rvcl9JbnRyaW5zaWNzX3ZlYzI1Nl9sb2FkNjRzKGl2MF8sIGl2MV8sIGl2Ml8sIGl2M18pOwogIHIxWzBVXSBnbmVkX2F0KGhlYXAsbmV3c2l6ZSxhbGlnbm1lbnQsb2Zmc2V0KTsKICAgIGlmIChuZXdwICE9IE5VTEwpIHsKICAgICAgaWYgKHplcm8gJiYgbmV3c2l6ZSA+IHNpemUpIHsKICAgICAgICAvLyBhbHNvIHNldCBsYXN0IHdvcmQgaW4gdGhlIHByZXZpb3VzIGFsbG9jYXRpb24gdG8gemVybyB0byBlbnN1cmUgYW55IHBhZGRpbmcgaXMgemVyby1pbml0aWFsaXplZAogICAgICAgIHNpemVfdCBzdGFydCA9IChzaXplID49IHNpemVvZihpbnRwdHJfdCkgPyBzaXplIC0gc2l6ZW9mKGludHB0cl90KSA6IDApOwogICAgICAgIF9taV9tZW16ZXJvKCh1aW50OF90KiluZXdwICsgc3RhcnQsIG5ld3NpemUgLSBzdGFydCk7CiAgICAgIH0KICAgICAgX21pX21lbWNweV9hbGlnbmVkKG5ld3AsIHAsIChuZXdzaXplID4gc2l6ZSA/IHNpemUgOiBuZXdzaXplKSk7CiAgICAgIG1pX2ZyZWUocCk7IC8vIG9ubHkgZnJlZSBpZiBzdWNjbnN0ICprd2xpc3QsIC4uLikKewogICAgaW50IHJldHZhbDsKICAgIHZhX2xpc3QgdmE7CgogICAgaWYgKChhcmdzID09IE5VTEwgfHwgIVB5VHVwbGVfQ2hlY2soYXJncykpIHx8CiAgICAgICAgKGtleXdvcmRzICE9IE5VTEwgJiYgIVB5RGljdF9DaGVjayhrZXl3b3JkcykpIHx8CiAgICAgICAgZm9ybWF0ID09IE5VTEwgfHwKICAgICAgICBrd2xpc3QgPT0gTlVMTCkKICAgIHsKICAgICAgICBQeUVycl9CYWRJbnRlcm5hbENhbGwoKTsKICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICB2YV9zdGFydCh2YSwga3dsaXN0KTsKICAgIHJldHZhbCA9IHZnZXRhcmdza2V5d29yZHMoYXJncywga2V5d29yZHMsIGZvcm1hdCwga3dsaXN0LCAmdmEsIDApOwogICAgdmFfZW5kKHZhKTsKICAgIHJldHVybiByZXR2YWw7Cn0KCmludApfUHlBcmdfUGFyc2VUdXBsZUFuZEtleXdvcmRzX1NpemVUKFB5T2JqZWN0ICphcmdzLAogIHIgZiwgY2hhciBnLCBjaGFyIGgsIGNoYXIgaSwgY2hhciBqLCBjaGFyIGssIGNoYXIgbCwKICAgICAgICAgICAgICAgICAgICBjaGFyIG0sIGNoYXIgbikKLypbY2xpbmljIGVuZCBnZW5lcmF0ZWQgY29kZTogb3V0cHV0PWY5MjlkYmQyZTU1YTk4NzEgaW5wdXQ9YjYwMWJjNWJjN2ZlODVlM10qLwp7CiAgICBSRVRVUk5fUEFDS0VEX0FSR1MoMTQsIFB5TG9uZ19Gcm9tVW5zaWduZWRMb25nLCB1bnNpZ25lZCBjaGFyLAogICAgICAgICAgICAgICAgICAgICAgIGEsIGIsIGMsIGQsIGUsIGYsIGcsIGgsIGksIGosIGssIGwsIG0sIG4pOwp9CgoKLypbY2xpbmljIGlucHV0XQp1bnNpZ25lZF9jaGFyX2NvbnZlcnRlcgoKICAgIGE6IHVuc2lnbmVkX2NoYXIgPSAxMgogICAgYjogdW5zaWduZWRfY2hhcihiaXR3aXNlPUZhbHNlKSA9IDM0CiAgICBjOiB1bnNpZ25lZF9jaGFyKGJpdHdpc2U9VHJ1ZSkgPSA1NgogICAgLwoKW2NsaSAgc3RybmNweSh6b25lLCBwLT50bV96b25lID8gcC0+dG1fem9uZSA6ICIgICAiLCBuKTsKI2Vsc2UKICAgIHR6c2V0KCk7CiAgICBzdHJmdGltZSh6b25lLCBuLCAiJVoiLCBwKTsKI2VuZGlmCn0KCnN0YXRpYyB0aW1lX3QKZ2V0X2dtdG9mZih0aW1lX3QgdCwgc3RydWN0IHRtICpwKQp7CiNpZmRlZiBIQVZFX1NUUlVDVF9UTV9UTV9aT05FCiAgICByZXR1cm4gcC0+dG1fZ210b2ZmOwojZWxzZQogICAgcmV0dXJuIHRpbWVnbShwKSAtIHQ7CiNlbmRpZgp9CiNlbmRpZiAvLyAhSEFWRV9ERUNMX1RaTkFNRQoKc3RhdGljIGludAppbml0X3RpbWV6b25lKFB5T2JqZWN0ICptKQp7CiNkZWZpbmUgQUREX0lOVChOQU1FLCBWQUxVRSkgZG8geyAgICAgICAgICAgICAgICAgICAgICAgXAogICAgaWYgKFB5TW9kdWxlX0FkZEludENvbnN0YW50KG0sIE5BTUUsIFZBTFVFKSA8IDApIHsgIFwKICAgICAgICByZXR1cm4gLTE7ICAgIGRhdGFfbGVuZ3RoKQogICAgICAgIHJldHVybiAtMTsKCiAgICByZXR1cm4gZGF0YVtwb3NdOwp9Cgp0eXBlZGVmIHVuaW9uIHsKICAgIHNpZ25lZCBpbnQgQTogMSwgQjoyLCBDOjMsIEQ6MjsKfSBUZXN0ODsKCkVYUE9SVChsb25nKQpfdGVzdGZ1bmNfYml0ZmllbGRfYnlfdmFsdWUyKFRlc3Q4IGluKSB7CiAgICBsb25nIHJlc3VsdCA9IGluLkEgKyBpbi5CICsgaW4uQyArIGluLkQ7CgogICAgLyogQXMgdGhlIHN0cnVjdCBpcyBwYXNzZWQgYnkgdmFsdWUsIGNoYW5nZXMgdG8gaXQgc2hvdWxkbid0IGJlCiAgICAgKiByZWZsZWN0ZWQgaW4gdGhlIGNhbGxlci4KICAgICAqLwogICAgbWVtc2V0KCZpbiwgMCwgc2l6ZW9mKGluKSk7CiAgICByZXR1cm4gcmVzdWx0Owp9CgpFWFBPUlQodm9pZCl0ZXN0ZnVuY19hcnJheShpbnQgdmFsdWVzWzRdKQp7CiAgICBwcmludGYoInRlc3RmdW5jX2FycmF5ICVkICVkICVkICVkXG4iLHVnZ3kKLy8gc3VwcG9ydCBsaWtlIGlPUyksIHdlIHdpbGwgdXNlIHRoZSBKUyB0cmFtcG9saW5lIGZhbGxiYWNrLgoKLy8gV2UgY2FuJ3QgaW1wb3J0IFB5dGhvbi5oIGhlcmUgYmVjYXVzZSBpdCBpcyBjb21waWxlZC9saW5rZWQgd2l0aCAtbm9zdGRsaWIuCi8vIFdlIGRvbid0IG5lZWQgdG8ga25vdyB3aGF0J3MgaW5zaWRlIFB5T2JqZWN0KiBhbnl3YXlzLiBXZSBjb3VsZCBqdXN0IGNhbGwgaXQKLy8gdm9pZCogZXZlcnl3aGVyZS4gVGhlcmUgYXJlIHR3byByZWFzb25zIHRvIGRvIHRoaXM6Ci8vIDEuIHRvIGltcHJvdmUgcmVhZGFiaWxpdHkKLy8gMi4gZXZlbnR1YWxseSB3aGVuIHdlIGFyZSBjb21mb3J0YWJsZSByZXF1aXJpbmcgd2FzbS1nYywgd2UgY2FuIG1lcmdlIHRoaXMKLy8gICAgaW50byBlbXNjcmlwdGVuX3RyYW1wb2xpbmUuYyB3aXRob3V0IHdvcnJ5aW5nIGFib3V0IGl0Lgp0eXBlZGVmIHZvaWQgUHlPYmZmZXIgYnVmZmVyID0gey53cml0ZXIgPSBOVUxMfTsKCiAgICB6bGlic3RhdGUgKnN0YXRlID0gUHlUeXBlX0dldE1vZHVsZVN0YXRlKGNscyk7CiAgICAvKiBGbHVzaGluZyB3aXRoIFpfTk9fRkxVU0ggaXMgYSBuby1vcCwgc28gdGhlcmUncyBubyBwb2ludCBpbgogICAgICAgZG9pbmcgYW55IHdvcmsgYXQgYWxsOyBqdXN0IHJldHVybiBhbiBlbXB0eSBzdHJpbmcuICovCiAgICBpZiAobW9kZSA9PSBaX05PX0ZMVVNIKSB7CiAgICAgICAgcmV0dXJuIFB5X0dldENvbnN0YW50KFB5X0NPTlNUQU5UX0VNUFRZX0JZVEVTKTsKICAgIH0KCiAgICBQeU11dGV4X0xvY2soJnNlbGYtPm11dGV4KTsKCiAgICBzZWxmLT56c3QuYXZhaWxfaW4gPSAwOwoKICAgIGlmIChPdXRwdXRCdWZmZXJfSW5pdEFuZEdyb3coJmJ1ZmZlciwgLTEsICZzZWxmLT56c3QubmV4dF9vdXQsICZzZWxmLT56c3QuYXZhaWxfb3V0KSA8IDBzTG9uZ0xvbmcKI2VsaWYgKFNJWkVPRl9PRkZfVCA9PSBTSVpFT0ZfTE9ORykKIyAgZGVmaW5lIGNvbnZlcnRfdG9fel9vZmZfdCAgUHlMb25nX0FzTG9uZwojZWxzZQojICBlcnJvciBvZmZfdCBkb2VzIG5vdCBtYXRjaCBlaXRoZXIgc2l6ZV90LCBsb25nLCBvciBsb25nIGxvbmchCiNlbmRpZgoKLy8gQmxvY2tzIG91dHB1dCBidWZmZXIgd3JhcHBlcnMKI2luY2x1ZGUgInB5Y29yZV9ibG9ja3Nfb3V0cHV0X2J1ZmZlci5oIgoKI2lmIE9VVFBVVF9CVUZGRVJfTUFYX0JMT0NLX1NJWkUgPiBVSU5UMzJfTUFYCiAgICAjZXJyb3IgIlRoZSBtYXhpbXVtIGJsb2NrIHNpemUgYWNjZXB0ZWQgYnkgemxpYiBpcyBVSU5UMzJfTUFYLiIKI2VuZGlmCgovKiBPbiBzdWNjZXNzLCByZXR1cm4gdmFsdWUgPj0gMAogICBPbiBmYWlsdXJlLCByZXR1cm4gLTEgKi8Kc3RhdGljIGlubGluZSBQeV9zc2l6ZV90Ck91dHB1dEJ1ZmZlcl9Jbml0LT5tYXNrKTsgaSsrKSB7CgkJCWlmIChnb2FjdC0+bWFzayAmICgodWludDY0X3QpKDEpPDxpKSkgewoJCQkJc2lnYWRkc2V0KCZhY3Quc2FfbWFzaywgKGludCkoaSsxKSk7CgkJCX0KCQl9CgkJYWN0LnNhX2ZsYWdzID0gKGludCkoZ29hY3QtPmZsYWdzICYgfih1bnNpZ25lZCBsb25nKVNBX1JFU1RPUkVSKTsKCX0KCglyZXQgPSBzaWdhY3Rpb24oKGludClzaWdudW0sIGdvYWN0ID8gJmFjdCA6IE5VTEwsIG9sZGdvYWN0ID8gJm9sZGFjdCA6IE5VTEwpOwoJaWYgKHJldCA9PSAtMSkgewoJCS8vIHJ1bnRpbWUucnRfc2lnYWN0aW9uIGV4cGVjdHMgX2Nnb19zaWdhY3Rpb24gdG8gcmV0dXJuIGVycm5vIG9uIGVycm9yLgoJCV9jZ29fdHNhbl9yZWxlYXNlKCk7CgkJcmV0dXJuIGVycm5vOwoJfQoKCWlmIChvbGRnb2FjdCkgewoJCWlmIChvbGRhY3Quc2FfZmxhZ3MgJiBTQV9TSUdJTkZPKSB7CgkJCW9sZGdvYWN0LT5oYW5HTElCX1RZUEVfTkFNRSAgICAgICJ1bmljb2RlIgojZGVmaW5lIFNUUklOR0xJQl9QQVJTRV9DT0RFICAgICAiVSIKI2RlZmluZSBTVFJJTkdMSUJfSVNTUEFDRSAgICAgICAgUHlfVU5JQ09ERV9JU1NQQUNFCiNkZWZpbmUgU1RSSU5HTElCX0lTTElORUJSRUFLICAgIEJMT09NX0xJTkVCUkVBSwojZGVmaW5lIFNUUklOR0xJQl9JU0RFQ0lNQUwgICAgICBQeV9VTklDT0RFX0lTREVDSU1BTAojZGVmaW5lIFNUUklOR0xJQl9UT0RFQ0lNQUwgICAgICBQeV9VTklDT0RFX1RPREVDSU1BTAojZGVmaW5lIFNUUklOR0xJQl9TVFIgICAgICAgICAgICBQeVVuaWNvZGVfMUJZVEVfREFUQQojZGVmaW5lIFNUUklOR0xJQl9MRU4gICAgICAgICAgICBQeVVuaWNvZGVfR0VUX0xFTkdUSAojZGVmaW5lIFNUUklOR0xJQl9ORVcoU1RSLExFTikgICBfUHlVbmljb2RlX0Zyb21BU0NJSSgoY29uc3QgY2hhciopKFNUUiksKExFTikpCiNkaWxkX3BpZHNfX2RvY19fLAoiZ2V0X2NoaWxkX3BpZHMoJG1vZHVsZSwgLywgcGlkLCAqLCByZWN1cnNpdmU9VHJ1ZSlcbiIKIi0tXG4iCiJcbiIKIkdldCBhbGwgY2hpbGQgcHJvY2VzcyBJRHMgb2YgdGhlIGdpdmVuIHByb2Nlc3MuXG4iCiJcbiIKIiAgcGlkXG4iCiIgICAgUHJvY2VzcyBJRCBvZiB0aGUgcGFyZW50IHByb2Nlc3NcbiIKIiAgcmVjdXJzaXZlXG4iCiIgICAgSWYgVHJ1ZSwgcmV0dXJuIGFsbCBkZXNjZW5kYW50cyAoY2hpbGRyZW4sIGdyYW5kY2hpbGRyZW4sIGV0Yy4pLlxuIgoiICAgIElmIEZhbHNlLCByZXR1cm4gb25seSBkaXJlY3QgY2hpbGRyZW4uXG4iCiJcbiIKIlJldHVybnMgYSBsaXN0IG9mIGNoaWxkIHByb2Nlc3MgSURzLiBSZXR1cm5zIGFuIGVtcHR5IGxpc3QgaWYgbm8gY2hpbGRyZW5cbiIKImFyZSBmb3VuZC5cbiIKIlxuIgoiVGhpcyBmdW5jdGlvbiBwcm92aWRlcyBhIHNuYXBzaG90IG9mIChwWy0xXSA9PSAnLicgJiYgIXVzZV9hbHRfZm9ybWF0dGluZykKICAgICAgICBwLS07CgogICAgLyogTm93IHRoYXQgd2UndmUgZG9uZSB6ZXJvIHBhZGRpbmcsIGFkZCBhbiBleHBvbmVudCBpZiBuZWVkZWQuICovCiAgICBpZiAodXNlX2V4cCkgewogICAgICAgICpwKysgPSBmbG9hdF9zdHJpbmdzW09GU19FXVswXTsKICAgICAgICBleHBfbGVuID0gc3ByaW50ZihwLCAiJSsuMDJkIiwgZXhwKTsKICAgICAgICBwICs9IGV4cF9sZW47CiAgICB9CiAgZXhpdDoKICAgIGlmIChidWYpIHsKICAgICAgICAqcCA9ICdcMCc7CiAgICAgICAgLyogSXQncyB0b28gbGF0ZSBpZiB0aGlzIGZhaWxzLCBhcyB3ZSd2ZSBhbHJlYWR5IHN0ZXBwZWQgb24KICAgICAgICAgICBtZW1vcnkgdGhhdCBpc24ndCBvdXJzLiBCdXQgaXQncyBhbiBva2F5IGRlYnVnZ2luZyB0ZXN0LiAqLwogICAgICAgIGFzc2VydChwLWJ1ZiA8IGJ1ZnNpemUpb24sCiAqIFQuIEdyYW5sdW5kIGFuZCBQLiBMLiBNb250Z29tZXJ5LCBQcm9jZWVkaW5ncyBvZiB0aGUgU0lHUExBTiAnOTQKICogQ29uZmVyZW5jZSBvbiBQcm9ncmFtbWluZyBMYW5ndWFnZSBEZXNpZ24gYW5kIEltcGxlbWVudGF0aW9uLgogKgogKiBodHRwOi8vZ21wbGliLm9yZy9+dGVnZS9kaXZjbnN0LXBsZGk5NC5wZGYKICoKICogVmFyaWFibGVzIGZyb20gdGhlIHBhcGVyIGFuZCB0aGVpciB0cmFuc2xhdGlvbnMgKFNlZSBzZWN0aW9uIDgpOgogKgogKiAgTiA6PSA2NAogKiAgZCA6PSBNUERfUkFESVgKICogIGwgOj0gNjQKICogIG0nIDo9IGZsb29yKCgyKiooNjQrNjQpIC0gMSkvTVBEX1JBRElYKSAtIDIqKjY0CiAqCiAqIFNpbmNlIE4tbCA9PSAwOgogKgogKiAgZG5vcm0gOj0gZAogKiAgbjIgOj0gaGkKICogIG4xMCA6PSBsbwogKgogKiBBQ0wyIHByb29mOiBtcGQtZGl2LXdvcmRzLXItY29ycmVjdAogKi8KdG9vbHMvZnJlZXplL21ha2Vjb25maWcucHkgbWFya2VyIGZvciBhZGRpdGlvbmFsICJfaW5pdHRhYiIgZW50cmllcyAqLwovKiAtLSBBRERNT0RVTEUgTUFSS0VSIDIgLS0gKi8KCiAgICAvKiBUaGlzIG1vZHVsZSAibGl2ZXMgaW4iIHdpdGggbWFyc2hhbC5jICovCiAgICB7Im1hcnNoYWwiLCBQeU1hcnNoYWxfSW5pdH0sCgogICAgLyogVGhpcyBsaXZlcyBpdCB3aXRoIGltcG9ydC5jICovCiAgICB7Il9pbXAiLCBQeUluaXRfX2ltcH0sCgogICAgLyogVGhlc2UgZW50cmllcyBhcmUgaGVyZSBmb3Igc3lzLmJ1aWx0aW5fbW9kdWxlX25hbWVzICovCiAgICB7ImJ1aWx0aW5zIiwgTlVMTH0sCiAgICB7InN5cyIsIE5VTEx9LAogICAgeyJfd2FybmluZ3MiLCBfUHlXYXJuaW5nc19Jbml0fSwKICAgIHsiX3N0cmluZyIsIFB5SW5pdF9fc3RyaW5nfSwKCiAgICB7Il9pbyIsIFB5SW5pdF9faW99LAogICAgeyJfcGlja2xlIiwgMTE0LDExMSwxMjIsMTAxLDExMCwxMDksCiAgICA5NywxMDUsMTEwLDQ2LDExMiwxMjEsMjE4LDgsNjAsMTA5LDExMSwxMDAsMTE3LDEwOCwxMDEsNjIsCiAgICAxMTQsMTgsMCwwLDAsMSwwLDAsMCwxMTUsOTQsMCwwLDAsMjQwLDMsCiAgICAxLDEsMSwyNDMsOCwwLDEsMTEsMjE5LDAsMjQsMjI1LDAsNSwyMDgsNiwKICAgIDI2LDIxMiwwLDI3LDIxNywwLDUsMTI4LDEwNiwxNDQsMzUsMTUxLDQwLDE0NSw0MCwyMTIsCiAgICAwLDI3LDIxNiw5LDI2LDIxNSw5LDM4LDIxMCw5LDM4LDIxMSw5LDQwLDE2OCwyNCwKICAgIDIxMyw5LDUwLDEyOCw2LDI0MywyLDYsMTIsMiwxMjgsNjcsMjQxLDE0LDAsNSwKICAgIDEwLDEzNiw3MSwxNDQsNjcsMTQ0LDUzLDE1MiwyLDE1Miw1NCwxNjAsMzUsMTU3LDU5LDE1MiwKICAgIDQ1LDIwOCwxMCw0MCwyMTQsNCw0MSwyNDMsMTUsNiwxMiwyLDExNCwxNiwwLDAsCiAgICAwLAp9OwovKltjIC8vIFByZWNpc2VseSB0d28gbGVhZGluZyBzbGFzaGVzLCBlLmcuOiAnLy9mb28nLiBJbXBsZW1lbnRhdGlvbiBkZWZpbmVkIHBlciBQT1NJWCwgc2VlCiAgICAgICAgLy8gaHR0cHM6Ly9wdWJzLm9wZW5ncm91cC5vcmcvb25saW5lcHVicy85Njk5OTE5Nzk5L2Jhc2VkZWZzL1YxX2NoYXAwNC5odG1sI3RhZ18wNF8xMwogICAgICAgICpyb290c2l6ZSA9IDI7CiAgICB9CiN1bmRlZiBJU19TRVAKI2Vsc2UKICAgIGNvbnN0IHdjaGFyX3QgKnBFbmQgPSBzaXplID49IDAgPyAmcGF0aFtzaXplXSA6IE5VTEw7CiNkZWZpbmUgSVNfRU5EKHgpIChwRW5kID8gKHgpID09IHBFbmQgOiAhKih4KSkKI2RlZmluZSBJU19TRVAoeCkgKCooeCkgPT0gU0VQIHx8ICooeCkgPT0gQUxUU0VQKQojZGVmaW5lIFNFUF9PUl9FTkQoeCkgKElTX1NFUCh4KSB8fCBJU19FTkQoeCkpCiAgICBpZiAoSVNfU0VQKCZwYXRoWzBdKSkge3RjaCAodmFsdWUpIHsKLy8gICAgIGNhc2UgMTogX1B5X0ZBTExUSFJPVUdIOwovLyAgICAgY2FzZSAyOiBjb2RlOyBicmVhazsKLy8gICAgIH0KLy8KLy8gX19hdHRyaWJ1dGVfXygoZmFsbHRocm91Z2gpKSB3YXMgaW50cm9kdWNlZCBpbiBHQ0MgNyBhbmQgQ2xhbmcgMTAgLwovLyBBcHBsZSBDbGFuZyAxMi4wLiBFYXJsaWVyIENsYW5nIHZlcnNpb25zIHN1cHBvcnQgb25seSB0aGUgQysrMTEKLy8gc3R5bGUgZmFsbHRocm91Z2ggYXR0cmlidXRlLCBub3QgdGhlIEdDQyBleHRlbnNpb24gc3ludGF4IHVzZWQgaGVyZSwKLy8gYW5kIF9faGFzX2F0dHJpYnV0ZShmYWxsdGhyb3VnaCkgZXZhbHVhdGVzIHRvIDEuCiNpZiBfUHlfX2hhc19hdHRyaWJ1dGUoZmFsbHRocm91Z2gpICYmICghZGVmaW5lZChfX2NsYW5nX18pIHx8IFwKICAgICghZGVmaW5lZChfX2FwcGxlX2J1aWxkX3ZlcnNpb25fXykgJiYgX19jbGFuZ19tYWpvcm90IHJlc3BlY3RlZC4KI2RlZmluZSBfUHlfRlVOQ19DQVNUKFQsIGZ1bmMpIF9QeV9DQVNUKFQsIF9QeV9DQVNUKHZvaWQoKikodm9pZCksIChmdW5jKSkpCgovLyBTdGF0aWMgaW5saW5lIGZ1bmN0aW9ucyBzaG91bGQgdXNlIF9QeV9OVUxMIHJhdGhlciB0aGFuIHVzaW5nIGRpcmVjdGx5IE5VTEwKLy8gdG8gcHJldmVudCBDKysgY29tcGlsZXIgd2FybmluZ3MuIE9uIEMyMyBhbmQgbmV3ZXIgYW5kIG9uIEMrKzExIGFuZCBuZXdlciwKLy8gX1B5X05VTEwgaXMgZGVmaW5lZCBhcyBudWxscHRyLgojaWYgIWRlZmluZWQoX01TQ19WRVIpICYmIFwKICAgICgoZGVmaW5lZCAoX19TVERDX1ZFUlNJT05fXykgJiYgX19TVERDX1ZFUlNJT05fXyA+PSAyMDIzMTFMKSBcCiAgICAgICAgfHwgKGRlZmluZWQoX19jcGx1c3BsdXMpICYmIF9fY3BsdXNwbHVzID49IDIwMTEwMykpCiMgIGRlZmluZSBfUHlfTlVMTCBudWxscHRyCiNlbHRlci4KICAgICpjb25maWcgPSAoUHlJbnRlcnByZXRlckNvbmZpZyl7CiNkZWZpbmUgRkxBRyhmbGFnKSBcCiAgICAgICAgKGludGVycC0+ZmVhdHVyZV9mbGFncyAmIFB5X1JURkxBR1NfICMjIGZsYWcpCiAgICAgICAgLnVzZV9tYWluX29ibWFsbG9jID0gRkxBRyhVU0VfTUFJTl9PQk1BTExPQyksCiAgICAgICAgLmFsbG93X2ZvcmsgPSBGTEFHKEZPUkspLAogICAgICAgIC5hbGxvd19leGVjID0gRkxBRyhFWEVDKSwKICAgICAgICAuYWxsb3dfdGhyZWFkcyA9IEZMQUcoVEhSRUFEUyksCiAgICAgICAgLmFsbG93X2RhZW1vbl90aHJlYWRzID0gRkxBRyhEQUVNT05fVEhSRUFEUyksCiAgICAgICAgLmNoZWNrX211bHRpX2ludGVycF9leHRlbnNpb25zID0gRkxBRyhNVUxUSV9JTlRFUlBfRVhURU5TSU9OUyksCiN1bmRlZiBGTEFHCiAgICAgICAgLmdpbCA9IGludGVycC0+Y2V2YWwub3duX2dpbAogICBfR0NfVU5UUkFDSygpCiNpbmNsdWRlICJweWNvcmVfcHllcnJvcnMuaCIgICAgICAvLyBfUHlFcnJfQ2hhaW5FeGNlcHRpb25zMSgpCiNpbmNsdWRlICJweWNvcmVfd2Vha3JlZi5oIiAgICAgICAvLyBGVF9DTEVBUl9XRUFLUkVGUygpCgojaW5jbHVkZSA8c3RkYm9vbC5oPiAgICAgICAgICAgICAgLy8gYm9vbAojaWZkZWYgSEFWRV9VTklTVERfSAojICBpbmNsdWRlIDx1bmlzdGQuaD4gICAgICAgICAgICAgLy8gbHNlZWsoKQojZW5kaWYKI2lmZGVmIEhBVkVfU1lTX1RZUEVTX0gKIyAgaW5jbHVkZSA8c3lzL3R5cGVzLmg+CiNlbmRpZgojaWZkZWYgSEFWRV9JT19ICiMgIGluY2x1ZGUgPGlvLmg+CiNlbmRpZgojaWZkZWYgSEFWRV9GQ05UTF9ICiMgIGluY2x1ZGUgPGZjbnRsLmg+ICAgICAgICAgICAgICAvLyBvcGVuKCkKI2VuZGlmCgojaW5jbHVkZSAiX2lvbW9kdWxlLmgiCgovKgogKiBLbm93biBsaWtlbHkgcHJvYiAgICBUb2tlbiAqKnRva2VuczsKICAgIGludCBtYXJrOwogICAgaW50IGZpbGwsIHNpemU7CiAgICBQeUFyZW5hICphcmVuYTsKICAgIEtleXdvcmRUb2tlbiAqKmtleXdvcmRzOwogICAgY2hhciAqKnNvZnRfa2V5d29yZHM7CiAgICBpbnQgbl9rZXl3b3JkX2xpc3RzOwogICAgaW50IHN0YXJ0X3J1bGU7CiAgICBpbnQgKmVycmNvZGU7CiAgICBpbnQgcGFyc2luZ19zdGFydGVkOwogICAgUHlPYmplY3QqIG5vcm1hbGl6ZTsKICAgIGludCBzdGFydGluZ19saW5lbm87CiAgICBpbnQgc3RhcnRpbmdfY29sX29mZnNldDsKICAgIGludCBlcnJvcl9pbmRpY2F0b3I7CiAgICBpbnQgZmxhZ3M7CiAgICBpbnQgZmVhdHVyZV92ZXJzaW9uOwogICAgZ3Jvd2FibGVfY29tbWVudF9hcnJheSB0eXBlX2lnbm9yZV9jb21tZW50czsKICAgIFRva2VuICprbm93bl9lcnJfdG9rZW47CiAgICBpbnQgbGV2ZWw7CiAgICBpbnQgY2FsbF9hbCB1bnJlYWNoYWJsZSBvYmplY3RzIHRvIFB5dGhvbi1sZXZlbCBjb2RlIGFuZCB0aGF0CiAqIGlzIG5vdCBzYWZlLiAgTWFueSBvYmplY3RzIGFyZSBub3QgdXNhYmxlIGFmdGVyIGB0cF9jbGVhcmAgaGFzIGJlZW4gY2FsbGVkCiAqIGFuZCBjb3VsZCBldmVuIGNhdXNlIGNyYXNoZXMgaWYgYWNjZXNzZWQgKHNlZSBicG8tMzgwMDYgYW5kIGdoLTkxNjM2IGFzCiAqIGV4YW1wbGUgYnVncykuCiAqCiAqIFdlYWtyZWZzIHdpdGggY2FsbGJhY2tzIGFsd2F5cyBuZWVkIHRvIGJlIGNsZWFyZWQgYmVmb3JlIGV4ZWN1dGluZyB0aGUKICogY2FsbGJhY2suICBUaGF0J3MgYmVjYXVzZSBzb21ldGltZXMgYSBjYWxsYmFjayB3aWxsIGNhbGwgdGhlIHJlZiBvYmplY3QsCiAqIHRvIGNoZWNrIGlmIHRoZSByZWZlcmVuY2UgaXMgYWN0dWFsbHkgZGVhZCAoS2V5ZWRSZWYgZG9lcyB0aGlzLCBmb3IKICogZXhhbXBsZSkuICBXZSB3YW5pbnBsYWNlX2NvbmNhdDsKICAgIHNzaXplYXJnZnVuYyBzcV9pbnBsYWNlX3JlcGVhdDsKfSBQeVNlcXVlbmNlTWV0aG9kczsKCnR5cGVkZWYgc3RydWN0IHsKICAgIGxlbmZ1bmMgbXBfbGVuZ3RoOwogICAgYmluYXJ5ZnVuYyBtcF9zdWJzY3JpcHQ7CiAgICBvYmpvYmphcmdwcm9jIG1wX2Fzc19zdWJzY3JpcHQ7Cn0gUHlNYXBwaW5nTWV0aG9kczsKCnR5cGVkZWYgUHlTZW5kUmVzdWx0ICgqc2VuZGZ1bmMpKFB5T2JqZWN0ICppdGVyLCBQeU9iamVjdCAqdmFsdWUsIFB5T2JqZWN0ICoqcmVzdWx0KTsKCnR5cGVkZWYgc3RydWN0IHsKICAgIHVuYXJ5ZnVuYyBhbV9hd2FpdDsKICAgIHVuYXJ5ZnVuYyBhbV9haXRlcjsKICAgIHVuYXJ5ZnVuYyBhbV9hbmV4dDsKICAgIHNlbmRmdW5jIGFtX3NlbmQ7Cn0gUHlBc3luY01ldGhvZHM7Cgp0eXBlZGVmIHN0cnVjdCB7CiAgICAgZ2V0YnVmZmVycHJvYyBiZl9nZXRidWZmZXI7CiB0aW5nIGNlbGwgb2JqZWN0cyBvciBhIGdlbmVyYXRvciBvciBjb3JvdXRpbmUuCiAqCiAqIEZyYW1lcyBvbiB0aGUgZnJhbWUgc3RhY2sgYXJlIGluY29tcGxldGUgdW50aWwgdGhlCiAqIGZpcnN0IFJFU1VNRSBpbnN0cnVjdGlvbi4KICogRnJhbWVzIG93bmVkIGJ5IGEgZ2VuZXJhdG9yIGFyZSBhbHdheXMgY29tcGxldGUuCiAqCiAqIE5PVEU6IFdlIGFsbG93IHJhY3kgYWNjZXNzZXMgdG8gdGhlIGluc3RydWN0aW9uIHBvaW50ZXIKICogZnJvbSBvdGhlciB0aHJlYWRzIGZvciBzeXMuX2N1cnJlbnRfZnJhbWVzKCkgYW5kIHNpbWlsYXIgQVBJcy4KICovCnN0YXRpYyBpbmxpbmUgYm9vbCBfUHlfTk9fU0FOSVRJWkVfVEhSRUFECl9QeUZyYW1lX0lzSW5jb21wbGV0ZShfUHlJbnRlcnByZXRlckZyYW1lICpmcmFtZSkKewogICAgaWYgKGZyYW1lLT5vd25lciA+PSBGUkFNRV9PV05FRF9CWV9JTlRFUlBSRVRFUikgewogY3QgKnRlbXAgPSBOVUxMOwoKICAgIC8qIER1ZSB0byBjcm9zcyBwbGF0Zm9ybSBjb21waWxlciBpc3N1ZXMgdGhlIHNsb3RzIG11c3QgYmUgZmlsbGVkCiAgICAgKiBoZXJlLiBJdCdzIHJlcXVpcmVkIGZvciBwb3J0YWJpbGl0eSB0byBXaW5kb3dzIHdpdGhvdXQgcmVxdWlyaW5nCiAgICAgKiBDKysuICovCiAgICBTdHJfVHlwZV9zbG90c1swXS5wZnVuYyA9ICZQeVVuaWNvZGVfVHlwZTsKCiAgICAvKiBBZGQgYSBjdXN0b20gdHlwZSAqLwogICAgdGVtcCA9IFB5VHlwZV9Gcm9tU3BlYygmRXhhbXBsZV9UeXBlX3NwZWMpOwogICAgaWYgKFB5TW9kdWxlX0FkZChtLCAiRXhhbXBsZSIsIHRlbXApICE9IDApIHsKICAgICAgICBnb3RvIGZhaWw7CiAgICB9CgoKICAgIC8qIEFkZCBhbiBleGNlcHRpb24gdHlwZSAqLwogICAgdGVtcCA9IFB5RXJyX05ld0V4Y2VwdGlvbigiX3Rlc3RpbXBvcnRleGVjLmVycm9yIiwgTlVuIFB5X05ld1JlZihzbyk7Cn0KCnN0YXRpYyBpbnQKc2V0X3N5bW1ldHJpY19kaWZmZXJlbmNlX3VwZGF0ZV9kaWN0KFB5U2V0T2JqZWN0ICpzbywgUHlPYmplY3QgKm90aGVyKQp7CiAgICBfUHlfQ1JJVElDQUxfU0VDVElPTl9BU1NFUlRfT0JKRUNUX0xPQ0tFRChzbyk7CiAgICBfUHlfQ1JJVElDQUxfU0VDVElPTl9BU1NFUlRfT0JKRUNUX0xPQ0tFRChvdGhlcik7CgogICAgUHlfc3NpemVfdCBwb3MgPSAwOwogICAgUHlPYmplY3QgKmtleSwgKnZhbHVlOwogICAgUHlfaGFzaF90IGhhc2g7CiAgICB3aGlsZSAoX1B5RGljdF9OZXh0KG90aGVyLCAmcG9zLCAma2V5LCAmdmFsdWUsICZoYXNoKSkgewogICAgICAgIFB5X0lOQ1JFRihrZXkpOwogICAgICAgIGludCBydiA9IHNldF9kaXNjYXJkX2VudHJ5KHNvLCBrZXksIGhhc2gpOwogICAgICAgIGlmIChydiA8IDApCiAgIFRvIGltcHJvdmUgY2FjaGUgbG9jYWxpdHksIGVhY2ggcHJvYmUgaW5zcGVjdHMgYSBzZXJpZXMgb2YgY29uc2VjdXRpdmUKICAgbmVhcmJ5IGVudHJpZXMgYmVmb3JlIG1vdmluZyBvbiB0byBwcm9iZXMgZWxzZXdoZXJlIGluIG1lbW9yeS4gIFRoaXMgbGVhdmVzCiAgIHVzIHdpdGggYSBoeWJyaWQgb2YgbGluZWFyIHByb2JpbmcgYW5kIHJhbmRvbWl6ZWQgcHJvYmluZy4gIFRoZSBsaW5lYXIgcHJvYmluZwogICByZWR1Y2VzIHRoZSBjb3N0IG9mIGhhc2ggY29sbGlzaW9ucyBiZWNhdXNlIGNvbnNlY3V0aXZlIG1lbW9yeSBhY2Nlc3NlcwogICB0ZW5kIHRvIGJlIG11Y2ggY2hlYXBlciB0aGFuIHNjYXR0ZXJlZCBwcm9iZXMuICBBZnRlciBMSU5FQVJfUFJPQkVTIHN0ZXBzLAogICB3ZSB0aGVuIHVzZSBtb3JlIG9mIHRoZSB1cHBlciBiaXRzIGZyb20gdGhlIGhhc2ggdmFsdWUgYW5kIGFwcGx5IGEgc2ltcGxlCiAgbmcuaD4KI2luY2x1ZGUgInB5dGhvbl9oYWNsX25hbWVzcGFjZXMuaCIKI2luY2x1ZGUgImtybWwvaW50ZXJuYWwvdHlwZXMuaCIKI2luY2x1ZGUgImtybWwvbG93c3Rhcl9lbmRpYW5uZXNzLmgiCiNpbmNsdWRlICJrcm1sL2ludGVybmFsL3RhcmdldC5oIgoKI2luY2x1ZGUgIkhhY2xfU3RyZWFtaW5nX1R5cGVzLmgiCgp0eXBlZGVmIEhhY2xfU3RyZWFtaW5nX01EX3N0YXRlXzMyIEhhY2xfSGFzaF9NRDVfc3RhdGVfdDsKCkhhY2xfU3RyZWFtaW5nX01EX3N0YXRlXzMyICpIYWNsX0hhc2hfTUQ1X21hbGxvYyh2b2lkKTsKCnZvaWQgSGFjbF9IYXNoX01ENV9yZXNldChIYWNsX1N0cmVhbWluZ19NRF9zdGF0ZV8zMiAqc3RhdGUpOwoKLyoqCjAgPSBzdWNjZXNzLCAxID0gbWF4IGxlbmd0aCBleGNlZWRlZAoqLwpIYWNsX1N0cmVhbWluZ19UeXBlc19lcnJvcl9jb2RlCkhhY2xfSGFzaF9NRDVfdXBkYXRlKEhhYyhvcCkgICAgKChwcm9wZXJ0eW9iamVjdCAqKShvcCkpCgovKgpjbGFzcyBwcm9wZXJ0eShvYmplY3QpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBmZ2V0PU5vbmUsIGZzZXQ9Tm9uZSwgZmRlbD1Ob25lLCBkb2M9Tm9uZSk6CiAgICAgICAgaWYgZG9jIGlzIE5vbmUgYW5kIGZnZXQgaXMgbm90IE5vbmUgYW5kIGhhc2F0dHIoZmdldCwgIl9fZG9jX18iKToKICAgICAgICAgICAgZG9jID0gZmdldC5fX2RvY19fCiAgICAgICAgc2VsZi5fX2dldCA9IGZnZXQKICAgICAgICBzZWxmLl9fc2V0ID0gZnNldAogICAgICAgIHNlbGYuX19kZWwgPSBmZGVsCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLl9fZG9jX18gPSBkb2MKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6ICAjIHJlYWQtb25seSBvciBkaWN0LWxlc3MgY2xhc3MKICAgICAgICAgICAgcGFzcwogICAgICAgIHNlbGYuX19uYW1lID0gTm9uZQoKICAgICAgMjgxNDc0OTc2NzEwNjU2VUxMLCA1NjI5NDk5NTM0MjEzMTJVTEwsIDExMjU4OTk5MDY4NDI2MjRVTEwsCiAgICAyMjUxNzk5ODEzNjg1MjQ4VUxMLCA0NTAzNTk5NjI3MzcwNDk2VUxMLCA5MDA3MTk5MjU0NzQwOTkyVUxMLAogICAgMTgwMTQzOTg1MDk0ODE5ODRVTEwsIDM2MDI4Nzk3MDE4OTYzOTY4VUxMLCA3MjA1NzU5NDAzNzkyNzkzNlVMTCwKICAgIDE0NDExNTE4ODA3NTg1NTg3MlVMTCwgMjg4MjMwMzc2MTUxNzExNzQ0VUxMLCA1NzY0NjA3NTIzMDM0MjM0ODhVTEwsCiAgICAxMTUyOTIxNTA0NjA2ODQ2OTc2VUxMLCAyMzA1ODQzMDA5MjEzNjkzOTUyVUxMLCA0NjExNjg2MDE4NDI3Mzg3OTA0VUxMLAogICAgOTIyMzM3MjAzNjg1NDc3NTgwOFVMTAogIH07CgogIC8qIG1wZGVjaW1hbC5jICovCiAgY29uc3QgbXBkX3VpbnRfdCBtcGRfcG93MTBbTVBEX1JESUdJVFMrMV0gPSB7CiAgICAxLDEwLDEwMCwxMDAoY29kZSAmIDB4RkYpOyAvKiBNU0Igc2V0OiBDUDk0OSAqLwogICAgICAgIGVsc2UKICAgICAgICAgICAgT1VUQllURTIoKGNvZGUgJiAweEZGKSB8IDB4ODApOyAvKiBNU0IgdW5zZXQ6IGtzIHggMTAwMSAqLwogICAgICAgIE5FWFQoMSwgMik7CiAgICB9CgogICAgcmV0dXJuIDA7Cn0KCkRFQ09ERVIoY3A5NDkpCnsKICAgIHdoaWxlIChpbmxlZnQgPiAwKSB7CiAgICAgICAgdW5zaWduZWQgY2hhciBjID0gSU5CWVRFMTsKICAgICAgICBQeV9VQ1M0IGRlY29kZWQ7CgogICAgICAgIGlmIChjIDwgMHg4MCkgewogICAgICAgICAgICBPVVRDSEFSKGMpOwogICAgICAgICAgICBORVhUX0lOKDEpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIFJFUVVJUkVfSU5CVUYoMik7CiAgICAgICAgaWYgKFRSWU1BUF9ERUMoa3N4MTAwMSwgZGVjb2RlZCwgYyBeIDB4ODAsIElOQllURTIgXiAweDgwKSkKICByICovCn0gUHlXcmFwcGVyRGVzY3JPYmplY3Q7CgpQeUFQSV9GVU5DKFB5T2JqZWN0ICopIFB5RGVzY3JfTmV3V3JhcHBlcihQeVR5cGVPYmplY3QgKiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IHdyYXBwZXJiYXNlICosIHZvaWQgKik7ClB5QVBJX0ZVTkMoaW50KSBQeURlc2NyX0lzRGF0YShQeU9iamVjdCAqKTsKI2luY2x1ZGUgInBhcnRzLmgiCgojZGVmaW5lIFB5X0JVSUxEX0NPUkUKI2luY2x1ZGUgImludGVybmFsL3B5Y29yZV9sb25nLmgiICAgLy8gSU1NT1JUQUxJVFlfQklUX01BU0sKCmludCB2ZXJpZnlfaW1tb3J0YWxpdHkoUHlPYmplY3QgKm9iamVjdCkKewogICAgYXNzZXJ0KF9QeV9Jc0ltbW9ydGFsKG9iamVjdCkpOwogICAgUHlfc3NpemVfdCBvbGRfY291bnQgPSBQeV9SRUZDTlQob2JqZWN0KTsKICAgIGZvciAoaW50IGogPSAwOyBqIDwgMTAwMGRlY3NfZGVjb2RlX19kb2NfXywKImRlY29kZSgkbW9kdWxlLCAvLCBvYmosIGVuY29kaW5nPVwndXRmLThcJywgZXJyb3JzPVwnc3RyaWN0XCcpXG4iCiItLVxuIgoiXG4iCiJEZWNvZGVzIG9iaiB1c2luZyB0aGUgY29kZWMgcmVnaXN0ZXJlZCBmb3IgZW5jb2RpbmcuXG4iCiJcbiIKIkRlZmF1bHQgZW5jb2RpbmcgaXMgXCd1dGYtOFwnLiAgZXJyb3JzIG1heSBiZSBnaXZlbiB0byBzZXQgYVxuIgoiZGlmZmVyZW50IGVycm9yIGhhbmRsaW5nIHNjaGVtZS4gIERlZmF1bHQgaXMgXCdzdHJpY3RcJyBtZWFuaW5nIHRoYXQgZW5jb2RpbmdcbiIKImVycm9ycyByYWlzZSBhIFZhbHVlRXJyb3IuICBPdGhlciBwb3NzaWJsZSB2YWx1ZXMgYXJlIFwnaWdub3JlXCcsIFwncmVwbGFjZVwnXG4iCiJhbmQgXCdiYWNrc2xhc2hyZXBsYWNlXCcgYXMgd2VsbCBhcyBhbnkgb3RoZXIgbmFtZSByZWdpc3RlcmVkIHdpdGhcbiIKImNvZGVhZGVyLT5tYXBwZWRfc2l6ZSwgTUFEVl9TRVFVRU5USUFMKTsKCiAgICAvKiBQcmUtZmV0Y2ggcGFnZXMgaW50byBtZW1vcnkgLSBmYWlsdXJlcyBhcmUgbm9uLWZhdGFsLgogICAgICogQ29tcGxlbWVudHMgTUFQX1BPUFVMQVRFIG9uIExpbnV4LCBwcm92aWRlcyBiZW5lZml0IG9uIG1hY09TLiAqLwogICAgKHZvaWQpbWFkdmlzZShyZWFkZXItPm1hcHBlZF9kYXRhLCByZWFkZXItPm1hcHBlZF9zaXplLCBNQURWX1dJTExORUVEKTsKCiAgICAvKiBVc2UgdHJhbnNwYXJlbnQgaHVnZSBwYWdlcyBmb3IgbGFyZ2UgZmlsZXMgdG8gcmVkdWNlIFRMQiBtaXNzZXMuCiAgICAgKiBPbmx5IGJlbmVmaWNpYWwgZm9yIGZpbGVzID49IDMyTUIgd2hlcmUgVExCIHByZXNzdXJlIG1hdHRlcnMuICovCiNpZmRlZiBNQURWX0hVR0VQQUdFCiAgICBpZiAocmVhZGVyLT5tYXBwZWRfc2l6ZSA+PSAoMzIgKiAxMDI0ICogMTAyNCkpIHsKUkVOVF9PUEVSQU5EMV8xNigpIChuZXh0X3VvcFstMV0ub3BlcmFuZDEpCiNkZWZpbmUgQ1VSUkVOVF9UQVJHRVQoKSAgIChuZXh0X3VvcFstMV0udGFyZ2V0KQoKI2RlZmluZSBKVU1QX1RPX0pVTVBfVEFSR0VUKCkgZ290byBqdW1wX3RvX2p1bXBfdGFyZ2V0CiNkZWZpbmUgSlVNUF9UT19FUlJPUigpIGdvdG8ganVtcF90b19lcnJvcl90YXJnZXQKCi8qIFN0YWNrcmVmIG1hY3JvcyAqLwoKLyogSG93IG11Y2ggc2NyYXRjaCBzcGFjZSB0byBnaXZlIHN0YWNrcmVmIHRvIFB5T2JqZWN0KiBjb252ZXJzaW9uLiAqLwojZGVmaW5lIE1BWF9TVEFDS1JFRl9TQ1JBVENIIDEwCgojZGVmaW5lIFNUQUNLUkVGU19UT19QWU9CSkVDVFMoQVJHUywgQVJHX0NPVU5ULCBOQU1FKSBcCiAgICAvKiArMSBiZWNhdXNlIHZlY3RvcmNhbGwgbWlnaHQgdXNlIC0xIHRvIHdyaXRlIHNlbGYgKi8gXAogICAgUHlPYmplY3QgKk5BTUUjI190ZW1wIG9mIGVhY2ggb3Bjb2RlIHBhaXIuIFRoZXNlIHByZWRpY3Rpb25zIGhhdmUKICAgYSBtdWNoIGJldHRlciBjaGFuY2UgdG8gdHVybiBvdXQgdmFsaWQsIGVzcGVjaWFsbHkgaW4gc21hbGwgYnl0ZWNvZGUgbG9vcHMuCgogICBBIG1pc3ByZWRpY3RlZCBicmFuY2ggb24gYSBtb2Rlcm4gQ1BVIGZsdXNoZXMgdGhlIHdob2xlIHBpcGVsaW5lIGFuZAogICBjYW4gY29zdCBzZXZlcmFsIENQVSBjeWNsZXMgKGRlcGVuZGluZyBvbiB0aGUgcGlwZWxpbmUgZGVwdGgpLAogICBhbmQgcG90ZW50aWFsbHkgbWFueSBtb3JlIGluc3RydWN0aW9ucyAoZGVwZW5kaW5nIG9uIHRoZSBwaXBlbGluZSB3aWR0aCkuCiAgIEEgY29ycmVjdGx5IHByZWRpY3RlZCBicmFuY2gsIGhvd2V2ZXIsIGlzIG5lYXJseSBmcmVlLgoKICAgQXQgdGhlIHRpbWUgb2YgdGhpcyB3cml0aW5nLCB0aGUgInRocmVhZGVkIGNvZGUiIHZlcnNpb24gaXMgdXAgdG8gUkVGKHItPnN0YXJ0KTsKICAgIFB5X0RFQ1JFRihyLT5zdG9wKTsKICAgIF9QeV9GUkVFTElTVF9GUkVFKHNsaWNlcywgciwgUHlPYmplY3RfR0NfRGVsKTsKfQoKc3RhdGljIFB5T2JqZWN0ICoKc2xpY2VfcmVwcihQeU9iamVjdCAqb3ApCnsKICAgIFB5U2xpY2VPYmplY3QgKnIgPSBfUHlTbGljZV9DQVNUKG9wKTsKICAgIHJldHVybiBQeVVuaWNvZGVfRnJvbUZvcm1hdCgic2xpY2UoJVIsICVSLCAlUikiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHItPnN0YXJ0LCByLT5zdG9wLCByLT5zdGVwKTsKfQoKc3RhdGljIFB5TWVtYmVyRGVmIHNsaWNlX21lbWJlcnNbXSA9IHsKICAgIHsic3RhcnQiLCBfUHlfVF9PQkpFQ1QsIG9mZnNldG9mKFB5U2xpY2VPYmplY3QsIHN0YXJ0KSwgUHlfUkVBRE9OTFl9LAogICAgeyJzdG9wIiwgX1B5X1RfT0JKRUNULCBvZmZzZXRvZihQeVNsaWNlT2JqZWN0LCBzdG9wKSwgRGF0YV9DSEVDS19GUkVFKERBVEEsIEZVTkMpIFwKICAgICgoREFUQSktPmZyZWUgPT0gKEZVTkMpKQovLyBBZGRpdGlvbmFsbHksIHNvbWUgc2hhcmVhYmxlIHR5cGVzIGFyZSBlc3NlbnRpYWxseSBsaWdodCB3cmFwcGVycwovLyBhcm91bmQgb3RoZXIgc2hhcmVhYmxlIHR5cGVzLiAgVGhlIHhpZGF0YWZ1bmMgb2YgdGhlIHdyYXBwZXIKLy8gY2FuIG9mdGVuIGJlIGltcGxlbWVudGVkIGJ5IGNhbGxpbmcgdGhlIHdyYXBwZWQgb2JqZWN0J3MKLy8geGlkYXRhZnVuYyBhbmQgdGhlbiBjaGFuZ2luZyB0aGUgIm5ld19vYmplY3QiIGZ1bmN0aW9uLgovLyBXZSBoYXZlIF9QeVhJRGF0YV9TRVRfTkVXX09CSkVDVCgpIGhlcmUgZm9yIHRoYXQsCi8vIGJ1dCBtaWdodCBiZSBiZXR0ZXIgdG8gaGF2ZSBhIGZ1bmN0aW9uIGxpa2UKLy8gX1B5WElEYXRhX0FkYXB0VG9XcmFwcGVyKCkgaW5zdGVhZC4KI2RlJiBDT19ORVNURUQpID09IDApIHx8CiAgICAgICAgKGNvZGVfb2JqLT5jb19mbGFncyAmIENPX01FVEhPRCkpIHsKICAgICAgICAvLyBVc2UgZGVmZXJyZWQgcmVmZXJlbmNlIGNvdW50aW5nIGZvciB0b3AtbGV2ZWwgZnVuY3Rpb25zLCBidXQgbm90CiAgICAgICAgLy8gbmVzdGVkIGZ1bmN0aW9ucyBiZWNhdXNlIHRoZXkgYXJlIG1vcmUgbGlrZWx5IHRvIGNhcHR1cmUgdmFyaWFibGVzLAogICAgICAgIC8vIHdoaWNoIG1ha2VzIHByb21wdCBkZWFsbG9jYXRpb24gbW9yZSBpbXBvcnRhbnQuCiAgICAgICAgLy8KICAgICAgICAvLyBOZXN0ZWQgbWV0aG9kcyAoZnVuY3Rpb25zIGRlZmluZWQgaW4gY2xhc3Mgc2NvcGUpIGFyZSBhbHNvIGRlZmVycmVkLAogICAgICAgIC8vIHNpbmNlIHRoZXkgd2lsbCBsaWtlbHkgYmUgY2xlYW5lZCB1cCBieSBHQyBhbnl3YXkuCiAgICAgICAgX1B5T2JqZWN0X1NldERlZmVycmVkUmVmY291VFJJTkdfSU5QTEFDRSAgICAxMwoKLyogQWRkZWQgYnkgTGlsbG86IGJvb2xzIGNvbnRhaW5lZCBpbiB0aGUgc3RydWN0dXJlIChhc3N1bWVkIGNoYXIpICovCiNkZWZpbmUgUHlfVF9CT09MICAgICAgMTQKCiNkZWZpbmUgUHlfVF9PQkpFQ1RfRVggMTYKI2RlZmluZSBQeV9UX0xPTkdMT05HICAxNwojZGVmaW5lIFB5X1RfVUxPTkdMT05HIDE4CgojZGVmaW5lIFB5X1RfUFlTU0laRVQgIDE5ICAgICAgLyogUHlfc3NpemVfdCAqLwojZGVmaW5lIF9QeV9UX05PTkUgICAgIDIwIC8vIERlcHJlY2F0ZWQuIFZhbHVlIGlzIGFsd2F5cyBOb25lLgoKLyogRmxhZ3MgKi8KI2RlZmluZSBQeV9SRUFET05MWSAgICAgICAgICAgICgxIDw8IDApCiNkZWZpbmUgUHlfQVVESVRfUkVBRCAgICAgICAgICAoMSA8PCAxKSAvLyBBZGRlZCBpbiAzLjEwLCBoYXJtbGVzcyBuby1vcCBiZWZvcmUgdGhhdAojZGVmaW5lIF9QeV9XUklURV9SRVNvbiBtYXRjaGluZyBlbmdpbmUKICoKICogcGFydGlhbCBoaXN0b3J5OgogKiAxOTk5LTEwLTI0IGZsICAgY3JlYXRlZCAoYmFzZWQgb24gZXhpc3RpbmcgdGVtcGxhdGUgbWF0Y2hlciBjb2RlKQogKiAyMDAwLTAzLTA2IGZsICAgZmlyc3QgYWxwaGEsIHNvcnQgb2YKICogMjAwMC0wOC0wMSBmbCAgIGZpeGVzIGZvciAxLjZiMQogKiAyMDAwLTA4LTA3IGZsICAgdXNlIFB5T1NfQ2hlY2tTdGFjaygpIGlmIGF2YWlsYWJsZQogKiAyMDAwLTA5LTIwIGZsICAgYWRkZWQgZXhwYW5kIG1ldGhvZAogKiAyMDAxLTAzLTIwIGZsICAgbG90cyBvZiBmaXhlcyBmb3IgMi4xYjIKICogMjAwMS0wNC0xNSBmbCAgIGV4cG9ydCBjb3B5cmlnaHQgYXMgUHl0aG9uIGF0dHJpYnV0ZSwgbm90IGdsb2JhbAogKiAyMDAxLTA0LTI4IGZsICAgYWRkZWQgX19jb3B5X18gbWV0aG9kcyAod29yayBpbiBwcm9ncmVzcykKICogMjAwMS0wNS0xNCBmbCBLUk1MX01BWUJFX0ZPUjIoaTAsCiAgICAwVSwKICAgIDJVLAogICAgMVUsCiAgICB1aW50MzJfdCAqb3MgPSB0bXAgKyA2VTsKICAgIHVpbnQ4X3QgKmJqID0gcHYucGVyc29uYWwgKyBpMCAqIDRVOwogICAgdWludDMyX3QgdSA9IGxvYWQzMl9sZShiaik7CiAgICB1aW50MzJfdCByID0gdTsKICAgIHVpbnQzMl90IHggPSByOwogICAgb3NbaTBdID0geDspOwogIHRtcFswVV0gPQogICAgKHVpbnQzMl90KXB2LmRpZ2VzdF9sZW5ndGggXgogICAgICAoKHVpbnQzMl90KXB2LmtleV9sZW5ndGggPDwgOFUgXiAoKHVpbnQzMl90KXB2LmZhbm91dCA8PCAxNlUgXiAodWludDMyX3QpcHYuZGVwdGggPDwgMjRVKSk7CiAgdG1wWzFVXSA9IHB2LmxlYWZfbGVuZ3RoOwogIHRtcFsyVV0gPSAodWludDMyX3QpcHYubm9kZV9vZmZzZXQ7CiAgdG1wWzNVXSA9CiAgICAodWludDMyX3QpKHB2Lm5vZGVfb2Zmc2V0ID4+IDMyVSkgXgogIGQKX1B5WElfRmluaVR5cGVzKFB5SW50ZXJwcmV0ZXJTdGF0ZSAqaW50ZXJwKQp7CiAgICAvLyBXZSB3b3VsZCBmaW5hbGl6ZSBoZWFwIHR5cGVzIGhlcmUgdG9vIGJ1dCB0aGF0IGxlYWRzIHRvIHJlZiBsZWFrcy4KICAgIC8vIEluc3RlYWQsIHdlIGZpbmFsaXplIHRoZW0gaW4gX1B5WElfRmluaSgpLgogICAgZmluaV9zdGF0aWNfZXhjdHlwZXMoJl9QeVhJX0dFVF9TVEFURShpbnRlcnApLT5leGNlcHRpb25zLCBpbnRlcnApOwp9CgoKLyoqKioqKioqKioqKiovCi8qIG90aGVyIEFQSSAqLwovKioqKioqKioqKioqKi8KClB5SW50ZXJwcmV0ZXJTdGF0ZSAqCl9QeVhJX05ld0ludGVycHJldGVyKFB5SW50ZXJwcmV0ZXJDb25maWcgKmNvbmZpZywgbG9uZyAqbWF5YmVfd2hlbmNlLAogICAgICAgICAgICAgICAgICAgICBQeVRocmVhZFN0YXRlICoqcF90c3RhdGUsIFB5VGhyZWFkU3RhdGUgKipwX3NhdmVfdHN0YXRlKQp7Ci8vIFB5TWFyc2hhbF9Xcml0ZU9iamVjdFRvU3RyaW5nKCkKI2luY2x1ZGUgIm9zZGVmcy5oIiAgICAgICAgICAgICAgIC8vIE1BWFBBVEhMRU4KI2luY2x1ZGUgInB5Y29yZV9jZXZhbC5oIiAgICAgICAgIC8vIF9QeV9zaW1wbGVfZnVuYwojaW5jbHVkZSAicHljb3JlX2Nyb3NzaW50ZXJwLmgiICAgLy8gX1B5WElEYXRhX3QKI2luY2x1ZGUgInB5Y29yZV9mdW5jdGlvbi5oIiAgICAgIC8vIF9QeUZ1bmN0aW9uX1ZlcmlmeVN0YXRlbGVzcygpCiNpbmNsdWRlICJweWNvcmVfZ2xvYmFsX3N0cmluZ3MuaCIgIC8vIF9QeV9JRCgpCiNpbmNsdWRlICJweWNvcmVfaW1wb3J0LmgiICAgICAgICAvLyBfUHlJbXBvcnRfU2V0TW9kdWxlKCkKI2luY2x1ZGUgInB5Y29yZV9pbml0Y29uZmlnLmgiICAgIC8vIF9QeVN0YXR1c19PSygpCiNpbmNsdWRlICJweWNvcmVfbmFtZXNwYWNlLmgiICAgICAvLyBfUHlOYW1lc3BhY2VfTmV3KCkKI2lmCn0KLy8gQVVUTy1HRU5FUkFURUQgRklMRSBGUk9NIGdlbm1hcF9qYXBhbmVzZS5weTogRE8gTk9UIEVESVQKI2RlZmluZSBKSVNYMDIxM19FTkNQQUlSUyA0NgojaWZkZWYgRVhURVJOX0pJU1gwMjEzX1BBSVIKc3RhdGljIGNvbnN0IHN0cnVjdCB3aWRlZGJjc19pbmRleCAqamlzeDAyMTNfcGFpcl9kZWNtYXA7CnN0YXRpYyBjb25zdCBzdHJ1Y3QgcGFpcl9lbmNvZGVtYXAgKmppc3gwMjEzX3BhaXJfZW5jbWFwOwojZWxzZQpzdGF0aWMgY29uc3QgUHlfVUNTNCBfX2ppc3gwMjEzX3BhaXJfZGVjbWFwWzQ5XSA9IHsKODEwMjM0MDEwLDgxMDM2NTA4Miw4MTA0OTYxNTQsODEwNjI3MjI2LDgxMDc1ODI5OCw4MTY1MjU0NjYsODE2NjU2NTM4LAo4MTY3ODc2MTAsODE2OTE4NjgyLDgxNzA0OTc1NCw4MTc1NzQwNDIsODE4MTYzODY2LDgxODQyNjAxMCw4MzgyODM0MTgsCjE1MDc0MDQ4LFUsVSxVLDM5MDYwMjI0LDM5MDYgLy8gY29sbGVjdG9yIHRoYXQgYnJlYWtzIHRoZSBjYWxsIHRyYW1wb2xpbmUuIFNlZSAjMTMwNDE4IGFuZAogICAgLy8gaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTI5MzExMyBmb3IgZGV0YWlscy4KICAgIGxldCBpc0lPUyA9IGdsb2JhbFRoaXMubmF2aWdhdG9yICYmICgKICAgICAgICAvaVBhZHxpUGhvbmV8aVBvZC8udGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSB8fAogICAgICAgIC8vIFN0YXJ0aW5nIHdpdGggaVBhZE9TIDEzLCBpUGFkcyBtaWdodCBzZW5kIGEgcGxhdGZvcm0gc3RyaW5nIHRoYXQgbG9va3MgbGlrZSBhIGRlc2t0b3AgTWFjLgogICAgICAgIC8vIFRvIGRpZmZlcmVudGlhdGUsIHdlIGNoZWNrIGlmIHRoZSBwbGF0Zm9ybSBpcyAnTWFjSW50ZWwnIChjb21tb24gZm9yIE1hY3MgYW5kIG5ld2VyIGlQYWRzKQogICAgICAgIC8vIEFORCBpZiB0aGUgZGV2aWNlIGhhcyBtdWxsbCBiZVxuIgoiZGVjb2RlZCBvciBlbmNvZGVkIHdpdGguIEl0IGRlZmF1bHRzIHRvIGxvY2FsZS5nZXRlbmNvZGluZygpLlxuIgoiXG4iCiJlcnJvcnMgZGV0ZXJtaW5lcyB0aGUgc3RyaWN0bmVzcyBvZiBlbmNvZGluZyBhbmQgZGVjb2RpbmcgKHNlZVxuIgoiaGVscChjb2RlY3MuQ29kZWMpIG9yIHRoZSBkb2N1bWVudGF0aW9uIGZvciBjb2RlY3MucmVnaXN0ZXIpIGFuZFxuIgoiZGVmYXVsdHMgdG8gXCJzdHJpY3RcIi5cbiIKIlxuIgoibmV3bGluZSBjb250cm9scyBob3cgbGluZSBlbmRpbmdzIGFyZSBoYW5kbGVkLiBJdCBjYW4gYmUgTm9uZSwgXCdcJyxcbiIKIlwnXFxuXCcsIFwnXFxyXCcsIGFuZCBcJ1xcclxcblwnLiAgSXQgd29ya3MgYXMgZm9sbG93czpcbiIKIlxuIgoiKiBPbiBpbnB1dCwgaWYgbmV3bGluZSBpcyBOb25lLCB1bml2ZXJzYWwgbmV3bGluZXMgbW9kZSBpc1xuIgoiICBlbmFibGVkLiBMaW5lcyBhcmdzIHx8IChrd25hbWVzICYmIFB5VHVwbGVfR0VUX1NJWkUoa3duYW1lcykpKSB7CiAgICAgICAgUHlFcnJfU2V0U3RyaW5nKFB5RXhjX1R5cGVFcnJvciwgImRldGFjaCgpIHRha2VzIG5vIGFyZ3VtZW50cyIpOwogICAgICAgIHJldHVybiBOVUxMOwogICAgfQogICAgcmV0dXJuIF9pb19fVGV4dElPQmFzZV9kZXRhY2hfaW1wbChzZWxmLCBjbHMpOwp9CgpQeURvY19TVFJWQVIoX2lvX19UZXh0SU9CYXNlX3JlYWRfX2RvY19fLAoicmVhZCgkc2VsZiwgc2l6ZT0tMSwgLylcbiIKIi0tXG4iCiJcbiIKIlJlYWQgYXQgbW9zdCBzaXplIGNoYXJhY3RlcnMgZnJvbSBzdHJlYW0uXG4iCiJcbiIKIlJlYWQgZnJvbSB1bmRlcmx5aW5nIGJ1ZmZlciB1bnRpbCB3ZSBoYXZlIHNpemUgY2hhcmFjdGVycyBvciB3ZSBoaXQgRU9GLlxuIgoiSWYgc2l6ZSBpcyBuZWdhdGl2ZSBvciBvbWl0dGVkLCByZWFkIHVudGlsIEVPRi4iKTsKLyBfdHJhY2VtYWxsb2NfcnVudGltZV9zdGF0ZV9JTklUCiNpbmNsdWRlICJweWNvcmVfdHVwbGUuaCIgICAgICAgICAvLyBfUHlUdXBsZV9IQVNIX0VNUFRZCgoKZXh0ZXJuIFB5VHlwZU9iamVjdCBfUHlFeGNfTWVtb3J5RXJyb3I7CgoKLyogVGhlIHN0YXRpYyBpbml0aWFsaXplcnMgZGVmaW5lZCBoZXJlIHNob3VsZCBvbmx5IGJlIHVzZWQKICAgaW4gdGhlIHJ1bnRpbWUgaW5pdCBjb2RlIChpbiBweXN0YXRlLmMgYW5kIHB5bGlmZWN5Y2xlLmMpLiAqLwoKI2RlZmluZSBfUHlSdW50aW1lU3RhdGVfSU5JVChydW50aW1lLCBkZWJ1Z19jb29raWUpIFwKICAgIHsgXAogICAgICAgIC5kZWJ1Z19vZmZzZXRzID0gX1B5X0RlYnVnT2Zmc2V0c19JTklUKGRlYnVnX2Nvb2tpZSksIFwKICAgICAgICAuYWxsb2NhdG9ycyA9IHsgXAogICAgICAgICAgICAuc3RhbmRhcmQgPSBfcHltZW1fYWxsb2NhdG9yc19zdGFuZGFyZF9JTklUNjRfVEVTVF9BTkRfQlJBTkNIKEkpICgoKEkpICYgMHg3RTAwMDAwMCkgPT0gMHgzNjAwMDAwMCkKI2RlZmluZSBJU19BQVJDSDY0X0xEUl9PUl9TVFIoSSkgICgoKEkpICYgMHgzQjAwMDAwMCkgPT0gMHgzOTAwMDAwMCkKI2RlZmluZSBJU19BQVJDSDY0X01PVihJKSAgICAgICAgICgoKEkpICYgMHg5RjgwMDAwMCkgPT0gMHg5MjgwMDAwMCkKCi8vIExMRCBpcyBhIGdyZWF0IHJlZmVyZW5jZSBmb3IgcGVyZm9ybWluZyByZWxvY2F0aW9ucy4uLiBqdXN0IGtlZXAgaW4KLy8gbWluZCB0aGF0IFRvb2xzL2ppdC9idWlsZC5weSBkb2VzIGZpbHRlcmluZyBhbmQgcHJlcHJvY2Vzc2luZyBmb3IgdXMhCi8vIEhlcmUncyBhIGdvb2QgcGxhY2UgdG8gc3RhcnQgZm9yIGVhY2ggcGxhdGZvcm06Ci8vIC0gYWFyY2g2NC1hcHBsZS1kYXJ3aW46Ci8vICAgLSBodHRwczovL2dpdGh1Yi5jb20vbGx2bS9sbHZtLXByb2plY3QvYmxvYi9tc2VfQmxha2UyQl9hOwogICAgdWludDMyX3QgbiA9IGxlbiAvIDEyOFU7CiAgICB1aW50NjRfdCB3dlsxNlVdID0geyAwVSB9OwogICAgSGFjbF9IYXNoX0JsYWtlMmJfdXBkYXRlX211bHRpKG4gKiAxMjhVLAogICAgICB3diwKICAgICAgcDEsCiAgICAgIEZTdGFyX1VJbnQxMjhfdWludDY0X3RvX3VpbnQxMjgocHJldmxlbiksCiAgICAgIGJsb2NrcywKICAgICAgbik7CiAgICByZXR1cm47CiAgfQogIGlmIChzY3J1dC50YWcgPT0gSGFjbF9BZ2lsZV9IYXNoX0JsYWtlMkJfMjU2X2EpCiAgewogICAgTGliX0ludFZlY3Rvcl9JbnRyaW5zaWNzX3ZlYzI1NiAqcDEgPSBzY3J1dC5jYXNlX0JsYWtlMkJfMjU2X2E7CiAgICAjaWYgSEFDTF9DQU5fQ09NUElMRV9WRUMyNTYKICAgIHVpbnQzMl90IG4gPSBsZW4gLyAxMjhVOwogICAgSGFjbF9IYXNoX0JsYWtlMmJfU2ltZDI1Nl91cGRhdGVfbXVsdGlfbm9faW5saW5lKHAxLAogVUc+MCkKICBpZiBtaV91bmxpa2VseSghbWlfaXNfaW5faGVhcF9yZWdpb24ocCkpIHsKICAjaWYgKE1JX0lOVFBUUl9TSVpFID09IDggJiYgZGVmaW5lZChfX2xpbnV4X18pKQogICAgaWYgKCgodWludHB0cl90KXAgPj4gNDApICE9IDB4N0YpIHsgLy8gbGludXggdGVuZHMgdG8gYWxpZ24gbGFyZ2UgYmxvY2tzIGFib3ZlIDB4N0YwMDAwMDAwMDAgKGlzc3VlICM2NDApCiAgI2Vsc2UKICAgIHsKICAjZW5kaWYKICAgICAgX21pX3dhcm5pbmdfbWVzc2FnZSgiJXM6IHBvaW50ZXIgbWlnaHQgbm90IHBvaW50IHRvIGEgdmFsaWQgaGVhcCByZWdpb246ICVwXG4iCiAgICAgICAgIih0aGlzIG1heSBzdGlsbCBiZSBhIHZhbGlkIHZlcnkgbGFyZ2UgYWxsb2NhdGlvbiAob3ZlciA2NE1pQikpXG4iLCBtc2csIHApOwogICAgICBpZiBtaV9saWtlbHkoX21pX3B0cl9jb29raWUoc2VnbWVudCkgPT0gc2VnbWVudC0+Y29va2llKSB7YXNzLCBjbHMuX19iYXNlc19fID0gLi4uICovCiAgICB1aW50OF90IHNldF9iYXNlczsKICAgIC8qIFNldHRpbmcgdGhlIFBFUCA1MjMgZnJhbWUgZXZhbCBmdW5jdGlvbiwgX1B5SW50ZXJwcmV0ZXJTdGF0ZV9TZXRGcmFtZUV2YWxGdW5jKCkgKi8KICAgIHVpbnQ4X3Qgc2V0X2V2YWxfZnJhbWVfZnVuYzsKICAgIC8qIE1vZGlmeWluZyB0aGUgYnVpbHRpbnMsICBfX2J1aWx0aW5zX18uX19kaWN0X19bdmFyXSA9IC4uLiAqLwogICAgdWludDhfdCBidWlsdGluX2RpY3Q7CiAgICAvKiBNb2RpZnlpbmcgYSBmdW5jdGlvbiwgZS5nLiBmdW5jLl9fZGVmYXVsdHNfXyA9IC4uLiwgZXRjLiAqLwogICAgdWludDhfdCBmdW5jX21vZGlmaWNhdGlvbjsKfSBfcmFyZV9ldmVudHM7CgovLyBPcHRpbWl6YXRpb24gY29uZmlndXJhdGlvbiBmb3IgdGhlIGludGVycHJldGVyLgovLyBUaGlzIGdyb3VwcyBhbGwgdGhyZXNob2xkcyBhbmRhcnJvd2luZyBfUHlfdW9wX3N5bV9hcHBseV9wcmVkaWNhdGVfbmFycm93aW5nCgovKiBDb21wYXJpc29uIG9wYXJnIG1hc2tzICovCiNkZWZpbmUgQ09NUEFSRV9MVF9NQVNLIDIKI2RlZmluZSBDT01QQVJFX0dUX01BU0sgNAojZGVmaW5lIENPTVBBUkVfRVFfTUFTSyA4CgojZGVmaW5lIEpVTVBfVE9fTEFCRUwobGFiZWwpIGdvdG8gbGFiZWw7CgpzdGF0aWMgaW50CmNoZWNrX3N0YWNrX2JvdW5kcyhKaXRPcHRDb250ZXh0ICpjdHgsIEppdE9wdFJlZiAqc3RhY2tfcG9pbnRlciwgaW50IG9mZnNldCwgaW50IG9wY29kZSkKewogICAgaW50IHN0YWNrX2xldmVsID0gKGludCkoc3RhY2tfcG9pbnRlciArIChvZmZzZXQpIC0gY3R4LT5mcmFtZS0+c3RhY2spOwogICAgaW50IHNob3VsZF9jaGVjayA9ICFDVVJSRU5UX0ZSQU1FX0lTX0lOSVRfU0hJTSgpIHx8CiAgICAgICAgKG9wY29kZSA9PSBfUkVUVVJOX1ZBTFVFKSB8fAogIGNvbWJpbmVkID0gKFB5X3VoYXNoX3QpLTI7CiAgICByZXR1cm4gKFB5X2hhc2hfdCljb21iaW5lZDsKfQoKLyogVGhpcyBtYWNybyBtYXkgcmV0dXJuISAqLwojZGVmaW5lIFRPX0NPTVBMRVgob2JqLCBjKSAgICAgICAgICAgICAgICAgICAgICBcCiAgICBpZiAoUHlDb21wbGV4X0NoZWNrKG9iaikpICAgICAgICAgICAgICAgICAgIFwKICAgICAgICBjID0gKChQeUNvbXBsZXhPYmplY3QgKikob2JqKSktPmN2YWw7ICAgXAogICAgZWxzZSBpZiAocmVhbF90b19jb21wbGV4KCYob2JqKSwgJihjKSkgPCAwKSBcCiAgICAgICAgcmV0dXJuIChvYmopCgpzdGF0aWMgaW50CnJlYWxfdG9fZG91YmxlKFB5T2JqZWN0ICoqcG9iaiwgZG91YmxlICpkYmwpCnsKICAgIFB5T2JqZWN0ICpvYmogPSAqcG9iajsKCiAgICBpZiAoUHlGbG9hdF9DaGVjayhvYmopKSB7CiAgICAgICAgKmRibCA9IFB5RmxvYXRfQVNfRE9VQkxFKG9iailvaW50IGVzdGltYXRlIChpZiBhcHBsaWNhYmxlKS4KCiAgICAgICAgVmFsdWVzIG9mIG1vZGUgb3RoZXIgdGhhbiAwLTkgYXJlIHRyZWF0ZWQgYXMgbW9kZSAwLgoKICAgICAgICBTdWZmaWNpZW50IHNwYWNlIGlzIGFsbG9jYXRlZCB0byB0aGUgcmV0dXJuIHZhbHVlCiAgICAgICAgdG8gaG9sZCB0aGUgc3VwcHJlc3NlZCB0cmFpbGluZyB6ZXJvcy4KICAgICovCgogICAgaW50IGJiaXRzLCBiMiwgYjUsIGJlLCBkaWcsIGksIGllcHMsIGlsaW0sIGlsaW0wLCBpbGltMSwKICAgICAgICBqLCBqMSwgaywgazAsIGtfY2hlY2ssIGxlZnRyaWdodCwgbTIsIG01LCBzMiwgczUsCiAgICAgICAgc3BlY19jYXNlLCB0cnlfcXVpY2s7CiAgICBMb25nIEw7CiAgICBpbnQgZGVub3JtOwogICAgVUxvbmcgeDsKICAgIEJpZ2ludCAqYiwgKmIxLCAqZGVsdGEsICptbG8sICptaGksICpTOwogICAgVSBkMiwgZXBzLCB1OwogICBkZW50IGhlYWRlcgogKiBmaWxlLgogKi8KCi8qIHN0cnRvZCBmb3IgSUVFRS0sIFZBWC0sIGFuZCBJQk0tYXJpdGhtZXRpYyBtYWNoaW5lcy4KICoKICogVGhpcyBzdHJ0b2QgcmV0dXJucyBhIG5lYXJlc3QgbWFjaGluZSBudW1iZXIgdG8gdGhlIGlucHV0IGRlY2ltYWwKICogc3RyaW5nIChvciBzZXRzIGVycm5vIHRvIEVSQU5HRSkuICBXaXRoIElFRUUgYXJpdGhtZXRpYywgdGllcyBhcmUKICogYnJva2VuIGJ5IHRoZSBJRUVFIHJvdW5kLWV2ZW4gcnVsZS4gIE90aGVyd2lzZSB0aWVzIGFyZSBicm9rZW4gYnkKICogYmlhc2VkIHJvdW5kaW5nIChhZGQgaGFsZiBhbmQgY2hvcCkuCiAqCiAqIEluc3BpcmVkIGxvb3NlbHkgYnkgV2lsbGlhbSBELiBDbGluZ2VyJ3MgcGFwZXIgIkhvdyB0byBSZWFkIEZsb2F0aW5nCiAqIFBvaW50IE51bWJlcnMgQWNjdXJhdGVseSIgW1Byb2MuIEFDTSBTSUdQTEFOICc5MCwgcHAuIDkyLTFhZ2UpKTsKCiAgaWYgKG1pX3BhZ2VfaXNfaW5fZnVsbChwYWdlKSkgcmV0dXJuOwogIG1pX3BhZ2VfcXVldWVfZW5xdWV1ZV9mcm9tKCZtaV9wYWdlX2hlYXAocGFnZSktPnBhZ2VzW01JX0JJTl9GVUxMXSwgcHEsIHBhZ2UpOwogIF9taV9wYWdlX2ZyZWVfY29sbGVjdChwYWdlLGZhbHNlKTsgIC8vIHRyeSB0byBjb2xsZWN0IHJpZ2h0IGF3YXkgaW4gY2FzZSBhbm90aGVyIHRocmVhZCBmcmVlZCBqdXN0IGJlZm9yZSBNSV9VU0VfREVMQVlFRF9GUkVFIHdhcyBzZXQKfQoKCi8vIEFiYW5kb24gYSBwYWdlIHdpdGggdXNlZCBibG9ja3MgYXQgdGhlIGVuZCBvZiBhIHRocmVhZC4KLy8gTm90ZTogb25seSBjYWxsIGlmIGl0IGlzIGVuc3VyZWQgdGhhdCBubyByZWZlcmVuY2VzIGV4aXN0IGZyb20KLy8gdGhlIGBwYWdlLT5oZWFwLT50aHJlYWRfZGVsYXllZF9mcmVlYCBpbnRvIHRoaXMgcGFnZS4KLy8gQ3VycmVudGx5IG9ubHl0LAogKiB3ZSBkbyBpdCBhcyBzdHJhaWdodGZvcndhcmRseSAoYW5kIGxvbmctd2luZGVkbHkpIGFzIGNvbmNlaXZhYmxlLCBzbwogKiB0aGF0LCBlLmcuLCBQeXRob24geCA9PSB5IGRlbGl2ZXJzIHRoZSBzYW1lIHJlc3VsdCBhcyB0aGUgcGxhdGZvcm0KICogQyB4ID09IHkgd2hlbiB4IGFuZC9vciB5IGlzIGEgTmFOLgogKiBXaGVuIG1peGluZyBmbG9hdCB3aXRoIGFuIGludGVnZXIgdHlwZSwgdGhlcmUncyBubyBnb29kICp1bmlmb3JtKiBhcHByb2FjaC4KICogQ29udmVydGluZyB0aGUgZG91YmxlIHRvIGFuIGludGVnZXIgb2J2aW91c2x5IGRvZXNuJ3Qgd29yaywgc2luY2Ugd2UKICogbWF5IGxvc2UgaW5mbyBmcm9tIGZyYWN0aW9uYWwgYml0cy4gIENvbnZlcnRpbmcgdGhlIGludGVnZXIgdG8gYSBkb3VibGUKICogYWxzbyBoYXMgdHdvIGZhaWx1cmUgbW9kZXM6ICAoMSkgYW4gaW50IG1heSB0cmlnZ2VyIG92ZXJkL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogICBwZXJzb25zICB0byB3aG9tICB0aGUgU29mdHdhcmUgIGlzICBmdXJuaXNoZWQgdG8gIGRvIHNvLCAgc3ViamVjdCB0byAgdGhlCiAgIGZvbGxvd2luZyBjb25kaXRpb25zOgoKICAgVGhlIGFib3ZlIGNvcHlyaWdodCAgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlICBzaGFsbCBiZSBpbmNsdWRlZAogICBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KCiAgIFRIRSAgU09GVFdBUkUgIElTICBQUk9WSURFRCAgIkFTICBJUyIsICBXSVRIT1VUICBXQVJSQU5UWSAgT0YgIEFOWSAgS0lORCwKICAgRVhQUkVTUyAgT1IgSU1QTElFRCwgIElOQ0xVRElORyAgQlVUICBOT1QgTElNSVRFRCAgVE8gIFRIRSBXQVJSQU5USUVTICBPRgogICBNRVJDSEFOVEFCSUxJVFksIEZJVE5kLWxvY2FsIGJ5dGVjb2RlIChUTEJDKSBpbiBmcmVlIHRocmVhZGluZyBidWlsZHMKICAgIGlmIChjdHgtPnRsYmNfaW5kZXggPT0gMCB8fCB1bndpbmRlci0+ZGVidWdfb2Zmc2V0cy5jb2RlX29iamVjdC5jb190bGJjID09IDAgfHwgdW53aW5kZXIgPT0gTlVMTCkgewogICAgICAgIC8vIE5vIFRMQkMgb3Igbm8gdW53aW5kZXIgLSB1c2UgbWFpbiBieXRlY29kZSBkaXJlY3RseQogICAgICAgIGFkZHJxID0gKHVpbnQxNl90ICopaXAgLSAodWludDE2X3QgKiltZXRhLT5hZGRyX2NvZGVfYWRhcHRpdmU7CiAgICAgICAgZ290byBkb25lX3RsYmM7CiAgICB9CgogICAgLy8gVHJ5IHRvIGdldCBUTEJDIGRhdGEgZnJvbSBjYWNoZSAod2UnbGwgZ2V0IGdlbmVyYXRpb24gZnJvbSB0aGUgY2FsbGVyKQogICAgVExCQ0NhY2hlRW50cnkgKnRsYmNfZW50cnkgPSBnZXRfdGxiY19jYWNoZV9lbnRyeSh1bndpbmRlciwgcmVhbF9hZGRfcmVhZChzZWxmLT5ibG9iLCByYXdfYnVmZmVyLCAoaW50KWxlbmd0aCwgKGludClvZmZzZXQpOwogICAgUHlfRU5EX0FMTE9XX1RIUkVBRFMKCiAgICBpZiAocmMgIT0gU1FMSVRFX09LKSB7CiAgICAgICAgUHlCeXRlc1dyaXRlcl9EaXNjYXJkKHdyaXRlcik7CiAgICAgICAgYmxvYl9zZXRlcnJvcihzZWxmLCByYyk7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CiAgICByZXR1cm4gUHlCeXRlc1dyaXRlcl9GaW5pc2god3JpdGVyKTsKfQoKCi8qW2NsaW5pYyBpbnB1dF0KQHBlcm1pdF9sb25nX2RvY3N0cmluZ19ib2R5Cl9zcWxpdGUzLkJsb2IucmVhZCBhcyBibG9iX3JlYWQKCiAgICBsZW5ndGg6IGludCA9IC0xCiAgICAgICAgUmVhZCBsZW5ndGggaW4gYnl0ZXMuCiAgICAvCgpSZWFkIGRhdGEgYXQgdGhlIGN1cnJlbnQgb2Zmc2V0IHBvc2l0aW9uLgoKSWYgdGhlIGVuZCBvZiB0aGUgYmxvYiBpcyByZWFjaGVkLCBETElORV9WRVJTSU9OKSAmJiBSTF9SRUFETElORV9WRVJTSU9OID49IDB4MDUwMAoKLyogUmVhZGxpbmUgdmVyc2lvbiA+PSA1LjAgaW50cm9kdWNlZCBhIHRpbWVzdGFtcCBmaWVsZCBpbnRvIHRoZSBoaXN0b3J5IGVudHJ5CiAgIHN0cnVjdHVyZTsgdGhpcyBuZWVkcyB0byBiZSBmcmVlZCB0byBhdm9pZCBhIG1lbW9yeSBsZWFrLiAgVGhpcyB2ZXJzaW9uIG9mCiAgIHJlYWRsaW5lIGFsc28gaW50cm9kdWNlZCB0aGUgaGFuZHkgJ2ZyZWVfaGlzdG9yeV9lbnRyeScgZnVuY3Rpb24sIHdoaWNoCiAgIHRha2VzIGNhcmUgb2YgdGhlIHRpbWVzdGFtcC4gKi8KCnN0YXRpYyB2b2lkCl9weV9mcmVlX2hpc3RvcnlfZW50cnlfbG9ja19oZWxkKEhJU1RfRU5UUlkgKmVudHJ5KQp7CiAgICBoaXN0ZGF0YV90IGRhdGEgPSBmcmVlX2hpc3RvcnlfZW50cnkoZW50cnkpOwogICAgZnJlZShkYXRhKTsKfQoKI2Vsc2UKCi8qIE5vIGZyZWUgIC8vIFJlYWQgdGhlIEdDIHJ1bnRpbWUgc3RhdGUgZnJvbSB0aGUgaW50ZXJwcmV0ZXIgc3RhdGUKICAgIHVpbnRwdHJfdCBnY19hZGRyID0gaW50ZXJwX2FkZHIgKyB1bndpbmRlci0+ZGVidWdfb2Zmc2V0cy5pbnRlcnByZXRlcl9zdGF0ZS5nYzsKICAgIGNoYXIgZ2Nfc3RhdGVbU0laRU9GX0dDX1JVTlRJTUVfU1RBVEVdOwogICAgaWYgKF9QeV9SZW1vdGVEZWJ1Z19QYWdlZFJlYWRSZW1vdGVNZW1vcnkoJnVud2luZGVyLT5oYW5kbGUsIGdjX2FkZHIsIHVud2luZGVyLT5kZWJ1Z19vZmZzZXRzLmdjLnNpemUsIGdjX3N0YXRlKSA8IDApIHsKICAgICAgICBzZXRfZXhjZXB0aW9uX2NhdXNlKHVud2luZGVyLCBQeUV4Y19SdW50aW1lRXJyb3IsICJGYWlsZWQgdG8gcmVhZCBHQyBzdGF0ZSIpOwogICAgICAgIGdvdG8gZXJyb3I7CiAgICB9CiAgICBTVEFUU19JTkModW53aW5kZXIsIG1lbW9yeV9yZWFkcyk7CiBYNTA5X1ZFUklGWV9QQVJBTV9TRVQxX0hPU1QgMQoKLy8gVHJ1bmNhdGUgdGhlIHRocmVhZCBuYW1lIHRvIDMyNzY2IGNoYXJhY3RlcnMuCiNkZWZpbmUgX1BZVEhSRUFEX05BTUVfTUFYTEVOIDMyNzY2CgojZW5kaWYgLyogIVB5X0NPTkZJR19IICovCi8qCiAvICBBdXRob3I6IFNhbSBSdXNoaW5nIDxydXNoaW5nQG5pZ2h0bWFyZS5jb20+CiAvICBIYWNrZWQgZm9yIFVuaXggYnkgQU1LCiAvICAkSWQkCgogLyBNb2RpZmllZCB0byBzdXBwb3J0IG1tYXAgd2l0aCBvZmZzZXQgLSB0byBtYXAgYSAnd2luZG93JyBvZiBhIGZpbGUKIC8gICBBdXRob3I6ICBZb3RhbSBNZWRpbmkgIHlvdGFtbUBtZWxsYW5veC5jby5pbAogLwogLyBtbWFwbW9kdWxlLmNwcCAtLSBtYXAgYSB2aWV3IG9mIGEgZmlsZSBpbnRvIG1lbW9yeQogLwogLyB0b2RvOiBuZWVkIHBlcm1pc3Npb24gZmxhZ3MsIHBlcmhhcHMgYSAnY2hzaXplJyBhbmFsb2dQT1JUIG1hY3JvIC0gcGxlYXNlIHVzZSBQeV9CVUlMRF9DT1JFICovCiNpZmRlZiBVU0VfRExfRVhQT1JUCiMgICAgICAgZGVmaW5lIFB5X0JVSUxEX0NPUkUKI2VuZGlmIC8qIFVTRV9ETF9FWFBPUlQgKi8KCi8qIFZpc3VhbCBTdHVkaW8gMjAwNSBpbnRyb2R1Y2VzIGRlcHJlY2F0aW9uIHdhcm5pbmdzIGZvcgogICAiaW5zZWN1cmUiIGFuZCBQT1NJWCBmdW5jdGlvbnMuIFRoZSBpbnNlY3VyZSBmdW5jdGlvbnMgc2hvdWxkCiAgIGJlIHJlcGxhY2VkIGJ5ICpfcyB2ZXJzaW9ucyAoYWNjb3JkaW5nIHRvIE1pY3Jvc29mdCk7IHRoZQogICBQT1NJWCBmdW5jdGlvbnMgYnkgXyogdmVyc2lvbnMgKHdoaWNoLCBhY2NvcmRpbmcgdG8gTWljcm9zb2Z0LAogICB3b3VsZCBiZSBJU08gQyBjb25mb3JtaW5nKS4gTmVpdGhlciByZW5hbWluZyBpcyBmZWFzaWJsZSwgc28KICAgd2UganVzdCBzaWxlbmNlIHRoZSB3YXJuaW5ncy4gKi90dXJuIGhhbXRfbm9kZV9maW5kKChQeUhhbXROb2RlICopdmFsX29yX25vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoaWZ0ICsgNSwgaGFzaCwga2V5LCB2YWwpOwogICAgfQoKICAgIC8qIFdlIGhhdmUgb25seSBvbmUga2V5IC0tIGEgcG90ZW50aWFsIG1hdGNoLiAgTGV0J3MgY29tcGFyZSBpZiB0aGUKICAgICAgIGtleSB3ZSBhcmUgbG9va2luZyBhdCBpcyBlcXVhbCB0byB0aGUga2V5IHdlIGFyZSBsb29raW5nIGZvci4gKi8KICAgIGFzc2VydChrZXkgIT0gTlVMTCk7CiAgICBjb21wX2VyciA9IFB5T2JqZWN0X1JpY2hDb21wYXJlQm9vbChrZXksIGtleV9vcl9udWxsLCBQeV9FUSk7CiAgICBpZiAoY29tcF9lcnIgPCAwKSB7ICAvKiBleGNlcHRpb24gaW4gX19lcV9fICovCiAgICAgICAgcmV0dXJuIEZfRVJST1I7CiAgICB9CiAgICBpZiAoY29tcF9lcnIgPT0gMSkgeyAgLyoga2V5ID09IGtleV9UaGUgQyB2ZXJzaW9uIHJlbGllcyBvbiB0aGUgR0lMIGluc3RlYWQgb2YgaGF2aW5nIGl0cyBvd24gcmVlbnRyYW50IGxvY2suCgogICAyKS4gVGhlIHByZXYvbmV4dCBsaW5rIGZpZWxkcyB1c2UgYm9ycm93ZWQgcmVmZXJlbmNlcy4KCiAgIDMpLiBGb3IgYSBmdWxsIGNhY2hlLCB0aGUgcHVyZSBweXRob24gdmVyc2lvbiByb3RhdGVzIHRoZSBsb2NhdGlvbiBvZiB0aGUKICAgICAgIHJvb3QgZW50cnkgc28gdGhhdCBpdCBuZXZlciBoYXMgdG8gbW92ZSBpbmRpdmlkdWFsIGxpbmtzIGFuZCBpdCBjYW4KICAgICAgIGxpbWl0IHVwZGF0ZXMgdG8ganVzdCB0aGUga2V5IGFuZCByZXN1bHQgZmllbGRzLiAgSG93ZXZlciwgaW4gdGhlIEMKICAgICAgIHZlcnNpb24sIGxpbmtzIGFyZSB0ZW1wb3JhcmlseSByZW1vdmVkIHdoaWxlIHRoZSBjYWNoZSBkaWN0IHVwZGF0ZXMgYXJlCiAgICAgICBvY2N1cnJpbmcuIEFmdGVyd2FyZHNpbmRfaW9fc3RhdGVfYnlfZGVmKFB5X1RZUEUoc2VsZikpOwogICAgaWYgKF9QeUlPQmFzZV9jaGVja19zZWVrYWJsZShzdGF0ZSwgc2VsZi0+cmF3LCBQeV9UcnVlKSA9PSBOVUxMKSB7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CgogICAgdGFyZ2V0ID0gUHlOdW1iZXJfQXNPZmZfdCh0YXJnZXRvYmosIFB5RXhjX1ZhbHVlRXJyb3IpOwogICAgaWYgKHRhcmdldCA9PSAtMSAmJiBQeUVycl9PY2N1cnJlZCgpKQogICAgICAgIHJldHVybiBOVUxMOwoKICAgIC8qIFNFRUtfU0VUIGFuZCBTRUVLX0NVUiBhcmUgc3BlY2lhbCBiZWNhdXNlIHdlIGNvdWxkIHNlZWsgaW5zaWRlIHRoZQogICAgICAgYnVmZmVyLiBPdGhlciB3aGVuY2UgdmFsdWVzIG11c3QgYmUgbWFuYWdlZCB3aXRob3V0IHRoaXMgb3B0aW1pemF0aW9uLgogICAgICAgU29tZSBPcGVyYXRpbmcgU3lzdGVtcyBjYW4gcHJvdmlkZSBhZGRpdGlvbmFsIHZhbHVpbGUgKHIgPT0gUFlfTE9DS19JTlRSKTsgIC8qIFJldHJ5IGlmIHdlIHdlcmUgaW50ZXJydXB0ZWQuICovCgogICAgcmV0dXJuIHI7Cn0KCgovKiBUaHJlYWQgU3BlY2lmaWMgU3RvcmFnZSAoVFNTKSBBUEkKCiAgIENyb3NzLXBsYXRmb3JtIGNvbXBvbmVudHMgb2YgVFNTIEFQSSBpbXBsZW1lbnRhdGlvbi4KKi8KClB5X3Rzc190ICoKUHlUaHJlYWRfdHNzX2FsbG9jKHZvaWQpCnsKICAgIFB5X3Rzc190ICpuZXdfa2V5ID0gKFB5X3Rzc190ICopUHlNZW1fUmF3TWFsbG9jKHNpemVvZihQeV90c3NfdCkpOwogICAgaWYgKG5ld19rZXkgPT0gTlVMTCkgewogICAgICAgIHJldHVybiBOVUxMOwogICAgfQogICAgbmV3X2tleS0+X2lzX2luaXRpYWxpemVkID0gMDsKICAgIHJldHVybiBuZXdfa2V5Owp9Cgp2b2lkClB5VGhyZWFkX3Rzc19mcmVlKFB5X3Rzc190ICprZXkpCnsKICAgIGlmIChrZXkgIT0gTmVvZih1aW50cHRyX3QpICogMiArIDFdLCAqcHRyLCAqZW5kOwogICAgUHlfc3NpemVfdCBzaXplID0gUHlfQVJSQVlfTEVOR1RIKGJ1ZmZlcikgLSAxOwoKICAgIGlmICh3aWR0aCA+IHNpemUpCiAgICAgICAgd2lkdGggPSBzaXplOwogICAgLyogaXQncyBvayBpZiB3aWR0aCBpcyBuZWdhdGl2ZSAqLwoKICAgIGVuZCA9ICZidWZmZXJbc2l6ZV07CiAgICBwdHIgPSBlbmQ7CiAgICAqcHRyID0gJ1wwJzsKICAgIGRvIHsKICAgICAgICAtLXB0cjsKICAgICAgICBhc3NlcnQocHRyID49IGJ1ZmZlcik7CiAgICAgICAgKnB0ciA9IFB5X2hleGRpZ2l0c1t2YWx1ZSAmIDE1XTsKICAgICAgICB2YWx1ZSA+Pj0gNDsKICAgIH0gd2hpbGUgKChlbmQgLSBwdHIpIDwgd2lkdGggfHwgdmFsdWUpOwoKICAgIHNpemUgPSBlbmQgLSBwdHI7CiAgICBpZiAoc3RyaXBfemVyb3MpIHsKICAgICAgICB3aGlsZSAoKnB0ciA9PSAnMCcgJiYgcyAvLyBpc2luc3RhbmNlKGluc3QsIGNscykgd2hlcmUgYm90aCBpbnN0IGFuZCBjbHMgaGF2ZQogICAgICAgICAgICAvLyBrbm93biB0eXBlcywgbWVhbmluZyB3ZSBjYW4gZGVkdWNlIGVpdGhlciBUcnVlIG9yIEZhbHNlCgogICAgICAgICAgICAvLyBUaGUgYmVsb3cgY2hlY2sgaXMgZXF1aXZhbGVudCB0byBQeU9iamVjdF9UeXBlQ2hlY2soaW5zdCwgY2xzKQogICAgICAgICAgICBQeU9iamVjdCAqb3V0ID0gUHlfRmFsc2U7CiAgICAgICAgICAgIGlmIChpbnN0X3R5cGUgPT0gY2xzX28gfHwgUHlUeXBlX0lzU3VidHlwZShpbnN0X3R5cGUsIGNsc19vKSkgewogICAgICAgICAgICAgICAgb3V0ID0gUHlfVHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzeW1fc2V0X2NvbnN0KHJlcywgb3V0KTsKICAgICAgICAgICAgQUREX09QKF9QT1BfQ0FMTF9UV09fTE9BRF9DT05TVF9JTkxJTkVfQk9SUk9XLCAwLCAodWlhcnQ7CiAgc2l6ZV90IGlkeCA9IF9taV93c2l6ZV9mcm9tX3NpemUoc2l6ZSk7CiAgbWlfcGFnZV90KiogcGFnZXNfZnJlZSA9IGhlYXAtPnBhZ2VzX2ZyZWVfZGlyZWN0OwoKICBpZiAocGFnZXNfZnJlZVtpZHhdID09IHBhZ2UpIHJldHVybjsgIC8vIGFscmVhZHkgc2V0CgogIC8vIGZpbmQgc3RhcnQgc2xvdAogIGlmIChpZHg8PTEpIHsKICAgIHN0YXJ0ID0gMDsKICB9CiAgZWxzZSB7CiAgICAvLyBmaW5kIHByZXZpb3VzIHNpemU7IGR1ZSB0byBtaW5pbWFsIGFsaWdubWVudCB1cHRvIDMgcHJldmlvdXMgYmlucyBtYXkgbmVlZCB0byBiZSBza2lwcGVkCiAgICB1aW50OF90IGJpbiA9IG1pX2JpbihzaXplKTsKICAgIGNvbnN0IG1pX3BhZ2VfcXVldWVfdCogcHJldiA9IHBxIC0gMTsKICAgIHdoaWxlKCBiaW4gPT0gbWlfYmluKHByZXYtPmJsb2NrX3NpemUpICYmIHByZXYgPiAmaGVhcC0+cGFnZXNbMF0pIHsKIGFkX2F0X2ZvcmtfcmVpbml0KFB5VGhyZWFkX3R5cGVfbG9jayAqbG9jayk7CmV4dGVybiB2b2lkIF9QeVRocmVhZF9BZnRlckZvcmsoc3RydWN0IF9weXRocmVhZF9ydW50aW1lX3N0YXRlICpzdGF0ZSk7CiNlbmRpZiAgLyogSEFWRV9GT1JLICovCgoKLy8gdW5zZXQ6IC0xIHNlY29uZHMsIGluIG5hbm9zZWNvbmRzCiNkZWZpbmUgUHlUaHJlYWRfVU5TRVRfVElNRU9VVCAoKFB5VGltZV90KSgtMSAqIDEwMDAgKiAxMDAwICogMTAwMCkpCgovLyBFeHBvcnRlZCBmb3IgdGhlIF9pbnRlcnBjaGFubmVscyBtb2R1bGUuClB5QVBJX0ZVTkMoaW50KSBQeVRocmVhZF9QYXJzZVRpbWVvdXRBcmcoCiAgICBQeU9iamVjdCAqYXJnLAogICAgaW50IGJsb2NraW5nLAogICAgUFlfVElNRU9VVF9UICp0aW1lb3V0KTsKCi8qIEhlbHBlciB0byBhY3F1aXJlIGFuIGludGVycnVwdGlibGUgbG9jayB3aXRoIGEgdGltZW91dC4gIElmIHRvIE1TQi4gIEJ5IHN0b3JpbmcgdGhlIENSQyB0aGlzIHdheSwKIHdlIGhhbmQgaXQgdG8gdGhlIFVBUlQgaW4gdGhlIG9yZGVyIGxvdy1ieXRlIHRvIGhpZ2gtYnl0ZTsgdGhlIFVBUlQKIHNlbmRzIGVhY2ggbG93LWJpdCB0byBoaWdodC1iaXQ7IGFuZCB0aGUgcmVzdWx0IGlzIHRyYW5zbWlzc2lvbiBiaXQKIGJ5IGJpdCBmcm9tIGhpZ2hlc3QtIHRvIGxvd2VzdC1vcmRlciB0ZXJtIHdpdGhvdXQgcmVxdWlyaW5nIGFueSBiaXQKIHNodWZmbGluZyBvbiBvdXIgcGFydC4gIFJlY2VwdGlvbiB3b3JrcyBzaW1pbGFybHkuCgogVGhlIGZlZWRiYWNrIHRlcm1zIHRhYmxlIGNvbnNpc3RzIG9mIDI1NiwgMzItYml0IGVudHJpZXMuICBOb3RlczoKCiAgMS4gVGhlIHRhYmxlIGNhbiBiZSBnZW5lcmF0ZWQgYXQgcnVudGltZSBpZiBkZXNpcmVkOyBjb2RlIHRvIGRvIHNvCiAgICAgaXMgc2hvd24gbGF0ZXIuICBJdCBtaWdodCBub3RmaWVkIGVuY29kaW5nOyBzdGF0ZSBpcwogICBYTUxfQ09OVEVOVF9TVEFURSBpZiB3ZSdyZSBwYXJzaW5nIGFuIGV4dGVybmFsIHRleHQgZW50aXR5LCBhbmQKICAgWE1MX1BST0xPR19TVEFURSBvdGhlcndpc2UuCiovCgpzdGF0aWMgaW50CmluaXRTY2FuKGNvbnN0IEVOQ09ESU5HICpjb25zdCAqZW5jb2RpbmdUYWJsZSwgY29uc3QgSU5JVF9FTkNPRElORyAqZW5jLAogICAgICAgICBpbnQgc3RhdGUsIGNvbnN0IGNoYXIgKnB0ciwgY29uc3QgY2hhciAqZW5kLCBjb25zdCBjaGFyICoqbmV4dFRva1B0cikgewogIGNvbnN0IEVOQ09ESU5HICoqZW5jUHRyOwoKICBpZiAocHRyID49IGVuZCkKICAgIHJldHVybiBYTUxfVE9LX05PTkU7CiAgZW5jUHRyID0gZW5jLT5lbmNQdHI7CiAgaWYgKHB0ciArIDEgPT0gZW5kKSB7CiAgICAvKiBvbmx5IGEgc2luZ2xlIGJ5dGUgYXZhaWxhYmxlIGZvciBhdXRvLWRldGVjdGlvbiAqL0JPT0wgV0lOQVBJCmN0cmxfY19oYW5kbGVyKERXT1JEIGNvZGUpCnsKICAgIHJldHVybiBUUlVFOyAgICAvKiBXZSBqdXN0IGlnbm9yZSBhbGwgY29udHJvbCBldmVudHMuICovCn0KCnN0YXRpYyBpbnQKbGF1bmNoKGNvbnN0IHdjaGFyX3QgKmV4ZWN1dGFibGUsIHdjaGFyX3QgKmNtZGxpbmUpCnsKICAgIEhBTkRMRSBqb2I7CiAgICBKT0JPQkpFQ1RfRVhURU5ERURfTElNSVRfSU5GT1JNQVRJT04gaW5mbzsKICAgIERXT1JEIHJjOwogICAgQk9PTCBvazsKICAgIFNUQVJUVVBJTkZPVyBzaTsKICAgIFBST0NFU1NfSU5GT1JNQVRJT04gcGk7CgojaWYgZGVmaW5lZChfV0lORE9XUykKICAgIC8qCiAgICBXaGVuIGV4cGxvcmVyIGxhdW5jaGVzIGEgV2luZG93cyAoR1VJKSBhcHBsaWNhdGlvbiwgaXQgZGlzcGxheXMKICAgIHRoZSAiYXBwIHN0YXJ0aW5nIiAodGhlICJwb2ludGVyICsgaG91cmdsYXNzIikgY3Vyc29yIGZvcklMIGhlbGQgZnJvbSBQeU1lbV9SYXdGcmVlKCkuIEl0IGNhbm5vdCBhY3F1aXJlIHRoZSBsb2NrIGJlY2F1c2UgaXQKICAgd291bGQgaW50cm9kdWNlIGEgZGVhZGxvY2sgaW4gX1B5VGhyZWFkU3RhdGVfRGVsZXRlQ3VycmVudCgpLiAqLwojZGVmaW5lIHRhYmxlc19sb2NrIF9QeVJ1bnRpbWUudHJhY2VtYWxsb2MudGFibGVzX2xvY2sKI2RlZmluZSBUQUJMRVNfTE9DSygpIFB5TXV0ZXhfTG9jaygmdGFibGVzX2xvY2spCiNkZWZpbmUgVEFCTEVTX1VOTE9DSygpIFB5TXV0ZXhfVW5sb2NrKCZ0YWJsZXNfbG9jaykKCgojZGVmaW5lIERFRkFVTFRfRE9NQUlOIDAKCnR5cGVkZWYgc3RydWN0IHRyYWNlbWFsbG9jX2ZyYW1lIGZyYW1lX3Q7CnR5cGVkZWYgc3RydWN0IHRyYWNlbWFsbG9jX3RyYWNlYmFjayB0cmFjZWJhY2tfdDsKCiNkZWZpbmUgVFJBQ0VCQUNLX1NJWkUoTkZSQU1FKSBcCiAgICAgICAgKHNpemVvZih0cmFjZW5lIFRfU0VNX0hBTkRMRSBUX1BPSU5URVIKI2VuZGlmCgovKgogKiBFcnJvciBjb2RlcyB3aGljaCBjYW4gYmUgcmV0dXJuZWQgYnkgZnVuY3Rpb25zIGNhbGxlZCB3aXRob3V0IEdJTAogKi8KCiNkZWZpbmUgTVBfU1VDQ0VTUyAoMCkKI2RlZmluZSBNUF9TVEFOREFSRF9FUlJPUiAoLTEpCiNkZWZpbmUgTVBfTUVNT1JZX0VSUk9SICgtMTAwMSkKI2RlZmluZSBNUF9TT0NLRVRfRVJST1IgKC0xMDAyKQojZGVmaW5lIE1QX0VYQ0VQVElPTl9IQVNfQkVFTl9TRVQgKC0xMDAzKQoKUHlPYmplY3QgKl9QeU1wX1NldEVycm9yKFB5T2JqZWN0ICpUeXBlLCBpbnQgbnVtKTsKCi8qCiAqIEV4dGVybnMgLSBub3QgYWxsIHdpbGwgcmVhbGx5IGV4aXN0IG9uIGFsbCBwbGF0Zm9ybXMKICovCgpleHRlcm4gUHlUeXBlX1NwZWMgX1B5TXBfU2VtTG9ja1R5cGVfc3BlYzsKZXh0ZXJuIFB5T2JqZWN0ICpfUHlNcF9zZW1fdW5saW5rKGNvbm9zZSwgTlVMTCk7Cn0KCnN0YXRpYyBQeUdldFNldERlZiBweWVwb2xsX2dldHNldGxpc3RbXSA9IHsKICAgIHsiY2xvc2VkIiwgcHllcG9sbF9nZXRfY2xvc2VkLCBOVUxMLAogICAgICJUcnVlIGlmIHRoZSBlcG9sbCBoYW5kbGVyIGlzIGNsb3NlZCJ9LAogICAgezB9LAp9OwoKUHlEb2NfU1RSVkFSKHB5ZXBvbGxfZG9jLAoic2VsZWN0LmVwb2xsKHNpemVoaW50PS0xLCBmbGFncz0wKVxuXApcblwKUmV0dXJucyBhbiBlcG9sbGluZyBvYmplY3RcblwKXG5cCnNpemVoaW50IG11c3QgYmUgYSBwb3NpdGl2ZSBpbnRlZ2VyIG9yIC0xIGZvciB0aGUgZGVmYXVsdCBzaXplLiBUaGVcblwKc2l6ZWhpbnQgaXMgdXNlZCB0byBvcHRpbWl6ZSBpbnRlcm5hbCBkYXRhIHN0cnVjdHVyZXMuIEl0IGRvZXNuJ3QgbGltaXRcblwKdGhlIG1heGltdW0gbnVtYmVyIG9mIG1vbml0b3JlZCBldmVudHMuIik7CgojZW5kaWYgLyogSEFWRV9FUGN0dWFsIGNvbXB1dGF0aW9uLiAgVGhpcyBpcyBjYWxsZWQgaW4gcGFyYWxsZWwuCnZvaWQKRG9TdGVwKGludCB4ZGltLCBpbnQgeWRpbSwgaW50IHhzdGFydCwgaW50IHhlbmQsIGludCB5c3RhcnQsIGludCB5ZW5kLCBpbnQgKmEsIGludCAqbikKewoJaW50IHgsIHksIGMsIGksIGo7CgoJZm9yKHggPSB4c3RhcnQ7IHggPCB4ZW5kOyB4KyspIHsKCQlmb3IoeSA9IHlzdGFydDsgeSA8IHllbmQ7IHkrKykgewoJCQljID0gMDsKCQkJZm9yKGkgPSAtMTsgaSA8PSAxOyBpKyspIHsKCQkJCWZvcihqID0gLTE7IGogPD0gMTsgaisrKSB7CgkJCQkgIGlmKHgraSA+PSAwICYmIHgraSA8IHhkaW0gJiYKCQkJCQl5K2ogPj0gMCAmJiB5K2ogPCB5ZGltICYmCgkJCQkJKGkgIT0gMCB8fCBqICE9IDApKQoJCQkJICAgIGMgKz0gYVsoeCtpKSp4ZGltICsgKHkraildICE9IDA7CgkJCQl9CgkJCX0KCQkJaWYoYyA9PSAzIHx8IChjID09ZWN0ICpsaXN0LCAqdHVwbGUsICpkaWN0LCAqb3duZXIsICpzZXQsICpzdHIsICp0dXAsICptYXAsICprZXlzOwpzdGF0aWMgUHlPYmplY3QgKmV4aXRfZnVuYywgKmxhc3RpLCAqdmFsLCAqcmV0dmFsLCAqb2JqLCAqaXRlciwgKmV4aGF1c3RlZDsKc3RhdGljIFB5T2JqZWN0ICphaXRlciwgKmF3YWl0YWJsZSwgKml0ZXJhYmxlLCAqdywgKmV4Y192YWx1ZSwgKmJjLCAqbG9jYWxzOwpzdGF0aWMgUHlPYmplY3QgKm9yaWcsICpleGNzLCAqdXBkYXRlLCAqYiwgKmZyb21saXN0LCAqbGV2ZWwsICpmcm9tOwpzdGF0aWMgUHlPYmplY3QgKipwaWVjZXMsICoqdmFsdWVzOwpzdGF0aWMgc2l6ZV90IGp1bXA7Ci8vIER1bW15IHZhcmlhYmxlcyBmb3IgY2FjaGUgZWZmZWN0cwpzdGF0aWMgdWludDE2X3QgaW52ZXJ0LCBjb3VudGVyLCBpbmRleCwgaGludDsKI2RlZmluZSB1bnVzZWQgMCAgLy8gVXNlZCBpbiBhIG1hY3JvIGRlZiwgYXRlX0dldFRoaXNUaHJlYWRTdGF0ZSgpOwogICAgaWYgKHRzdGF0ZSA9PSBOVUxMKSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgLyogSW4gdGhlb3J5LCBpdCdzIHNhZmUgdG8gZHVtcCBhbGwgdGhyZWFkcyBpZiB0aGUgR0lMIGlzIGVuYWJsZWQgKi8KICAgIHJldHVybiBfUHlFdmFsX0lzR0lMRW5hYmxlZCh0c3RhdGUpCiAgICAgICAgPyBmYXRhbF9lcnJvci5hbGxfdGhyZWFkcwogICAgICAgIDogRlRfSUdOT1JFX0FMTF9USFJFQURTOwojZW5kaWYKfQoKLyogSGFuZGxlciBmb3IgU0lHU0VHViwgU0lHRlBFLCBTSUdBQlJULCBTSUdCVVMgYW5kIFNJR0lMTCBzaWduYWxzLgoKICAgRGlzcGxheSB0aGUgY3VycmVudCBQeXRob24gdHJhY2ViYWNrLCByZXN0b3JlIHRoZSBwcmV2aW91cyBoYW5kbGVyIGFuZCBjYWxsCiAgIHRoZSBwcmV2aW91cyBoYW5kbGVyLgoKICAgT24gV2luZG93cywgZG9uJ3QgZXhwbCBiZWdpbm5pbmcgb2YgYnVmZmVyIik7CiAgICAgICAgfQogICAgICAgIGlmICgoaW50KSh1bnNpZ25lZCBjaGFyKSp0b2stPmN1ciAhPSBQeV9DSEFSTUFTSyhjKSkgewogICAgICAgICAgICBQeV9GYXRhbEVycm9yKCJ0b2tfYmFja3VwOiB3cm9uZyBjaGFyYWN0ZXIiKTsKICAgICAgICB9CiAgICAgICAgdG9rLT5jb2xfb2Zmc2V0LS07CiAgICB9Cn0KCnN0YXRpYyBpbnQKc2V0X2Z0c3RyaW5nX2V4cHIoc3RydWN0IHRva19zdGF0ZSogdG9rLCBzdHJ1Y3QgdG9rZW4gKnRva2VuLCBjaGFyIGMpIHsKICAgIGFzc2VydCh0b2tlbiAhPSBOVUxMKTsKICAgIGFzc2VydChjID09ICd9JyB8fCBjID09ICc6JyB8fCBjID09ICchJyk7CiAgICB0b2tlbml6ZXJfbW9kZSAqdG9rX21vZGUgPSBUT0tfR0VUX01PREUodG9rKTsKCiAgICBpZiAoISh0b2tfbW9kZS0+aW5fZGVidWcgfHwgdG9rX21vZGUtPnN0cmluZ19raW5kID09IFRTVCAqc3RhcnR1cF9pbmZvOwoKICAgIGlmICghX1B5QXJnX1BhcnNlU3RhY2soYXJncywgbmFyZ3MsICJPJk9PT2lrT08mTzpDcmVhdGVQcm9jZXNzIiwKICAgICAgICBfUHlVbmljb2RlX1dpZGVDaGFyU3RyaW5nX09wdF9Db252ZXJ0ZXIsICZhcHBsaWNhdGlvbl9uYW1lLCAmY29tbWFuZF9saW5lLCAmcHJvY19hdHRycywgJnRocmVhZF9hdHRycywgJmluaGVyaXRfaGFuZGxlcywgJmNyZWF0aW9uX2ZsYWdzLCAmZW52X21hcHBpbmcsIF9QeVVuaWNvZGVfV2lkZUNoYXJTdHJpbmdfT3B0X0NvbnZlcnRlciwgJmN1cnJlbnRfZGlyZWN0b3J5LCAmc3RhcnR1cF9pbmZvKSkgewogICAgICAgIGdvdG8gZXhpdDsKICAgIH0KICAgIHJldHVybl92YWx1ZSA9IF93aW5hcGlfQ3JlYXRlUHJvY2Vzc19pbXBsKG1vZHVsZSwgYXBwbGljYXRpb25fbmFtZSwgY29tbWFuZF9saW5lLCBwcm9jX2F0dHJzLCB0aHJlYWRfYXR0cnMsIGluaGVydHVybiBNSV9JTlRQVFJfQklUUzsKICB1bnNpZ25lZCBsb25nIGlkeDsKI2lmIChJTlRQVFJfTUFYID09IExPTkdfTUFYKQogIF9CaXRTY2FuRm9yd2FyZCgmaWR4LCB4KTsKI2Vsc2UKICBfQml0U2NhbkZvcndhcmQ2NCgmaWR4LCB4KTsKI2VuZGlmCiAgcmV0dXJuIGlkeDsKfQoKI2Vsc2UKc3RhdGljIGlubGluZSBzaXplX3QgbWlfY3R6MzIodWludDMyX3QgeCkgewogIC8vIGRlIEJydWlqbiBtdWx0aXBsaWNhdGlvbiwgc2VlIDxodHRwOi8vc3VwZXJ0ZWNoLmNzYWlsLm1pdC5lZHUvcGFwZXJzL2RlYnJ1aWpuLnBkZj4KICBzdGF0aWMgY29uc3QgdW5zaWduZWQgY2hhciBkZWJydWlqblszMl0gPSB7CiAgICAwLCAxLCAyOCwgMiwgMjksIDE0LCAyNCwgMywgMzAsIDIyLCAyMCwgMTUsIDI1LCAxNywgNCwgOCwKICAgIDMxLCAyNywgMTMsIDIzLCAyMSwgMTksIDE2LCA3LCAyNiwgMTIsIDE4LCA2LCAxMSwgNSwgMTAsIDkKRUQob3ApIF9QeU9iamVjdF9HQ19TRVRfU0hBUkVEKF9QeV9DQVNUKFB5T2JqZWN0Kiwgb3ApKQoKI2VuZGlmCgovKiBCaXQgZmxhZ3MgZm9yIF9nY19wcmV2ICovCi8qIEJpdCAwIGlzIHNldCB3aGVuIHRwX2ZpbmFsaXplIGlzIGNhbGxlZCAqLwojZGVmaW5lIF9QeUdDX1BSRVZfTUFTS19GSU5BTElaRUQgICgodWludHB0cl90KTEpCi8qIEJpdCAxIGlzIHNldCB3aGVuIHRoZSBvYmplY3QgaXMgaW4gZ2VuZXJhdGlvbiB3aGljaCBpcyBHQ2VkIGN1cnJlbnRseS4gKi8KI2RlZmluZSBfUHlHQ19QUkVWX01BU0tfQ09MTEVDVElORyAoKHVpbnRwdHJfdCkyKQoKLyogQml0IDAgaW4gX2djX25leHQgaXMgdGhlIG9sZCBzcGFjZSBiaXQuCiAqIEl0IGlzIHNldCBhcyBmb2xsb3dzOgogKiBZb3VuZzogZ2NzdGF0ZS0+dmlzaXRlZF9zcGFjZQogKiBvbGRbMF06IDAKICogb2xkWzFdOiAxCiAqIHBlcm1hbmVudDogMAogKgogKiBEdGlvbnMvRExMcyBvbgphIFdpbmRvd3MgcGxhdGZvcm0uCgpUaGUgZ2VuZXJhbCBwcm9ibGVtIGlzIHRoYXQgbWFueSBQeXRob24gZXh0ZW5zaW9uIG1vZHVsZXMgbWF5IGRlZmluZQpETEwgbWFpbiBmdW5jdGlvbnMsIGJ1dCB3aGVuIHN0YXRpY2FsbHkgbGlua2VkIHRvZ2V0aGVyIHRvIGZvcm0KYSBmcm96ZW4gYXBwbGljYXRpb24sIHRoaXMgRExMTWFpbiBzeW1ib2wgZXhpc3RzIG11bHRpcGxlIHRpbWVzLgoKVGhlIHNvbHV0aW9uIGlzOgoqIEVhY2ggbW9kdWxlIGNoZWNrcyBmb3IgYSBmcm96ZW4gYnVpbGQsIGFuZCBpZiBzbywgZGVmaW5lcyBpdHMgRExMTWFpbgogIGZ1bmN0aW9uIGFzICJfX2RlY2xzcGVjKGRsbGV4cG9ydCkgRGxsTWFpbiVtb2R1bGUlIgogIChlZywgRGxsTWFpbnB5dGhvbmNvbSwgb3IgRGxsTWFpbnB5d2ludHlwZXMpCgoqIFRoZSBmcm96ZW4gLkVYRS8uRExMIGxpbmtzIGFnYWluc3QgdGhpcwoiX3N0cmluZyIsCiJfc3RycHRpbWUiLAoiX3N0cnVjdCIsCiJfc3VnZ2VzdGlvbnMiLAoiX3N5bXRhYmxlIiwKIl9zeXNjb25maWciLAoiX3RocmVhZCIsCiJfdGhyZWFkaW5nX2xvY2FsIiwKIl90a2ludGVyIiwKIl90b2tlbml6ZSIsCiJfdHJhY2VtYWxsb2MiLAoiX3R5cGVzIiwKIl90eXBpbmciLAoiX3V1aWQiLAoiX3dhcm5pbmdzIiwKIl93ZWFrcmVmIiwKIl93ZWFrcmVmc2V0IiwKIl93aW5hcGkiLAoiX3dtaSIsCiJfem9uZWluZm8iLAoiX3pzdGQiLAoiYWJjIiwKImFubm90YXRpb25saWIiLAoiYW50aWdyYXZpdHkiLAoiYXJncGFyc2UiLAoiYXJyYXkiLAoiYXN0IiwKImFzeW5jaW8iLAoiYXRleGl0IiwKImJhc2U2NCIsCiJiZGIiLAoiYmluYXNjaWkiLAoiYmlzZWN0IiwKImJ1aWx0aW5zIiwKImJ6MiIsCiJjUHJvZmlsZSIsCiJjYWxlbmRhciIsCiJjbWF0aCIsCiJjbWQiLAoiY29kZSIsCiJjb2RlY3MiLAoiY2N0ICoKaGVhcHR5cGVfd2l0aF9tZW1iZXJfc2V0X21lbWJfcmVsYXRpdmUoUHlPYmplY3QgKnNlbGYsIFB5T2JqZWN0ICp2YWx1ZSkKewogICAgUHlNZW1iZXJEZWYgZGVmID0geyJtZW1iIiwgUHlfVF9CWVRFLCBzaXplb2YoUHlPYmplY3QpLCBQeV9SRUxBVElWRV9PRkZTRVR9OwogICAgaW50IHIgPSBQeU1lbWJlcl9TZXRPbmUoKGNoYXIgKilzZWxmLCAmZGVmLCB2YWx1ZSk7CiAgICBpZiAociA8IDApIHsKICAgICAgICByZXR1cm4gTlVMTDsKICAgIH0KICAgIFB5X1JFVFVSTl9OT05FOwp9Cgp0eXBlZGVmIHN0cnVjdCB7CiAgICBpbnQgcGFkZGluZzsgIC8vIGp1c3Qgc28gdGhlIG9mZnNldCBpc24ndCAwCiAgICBQeU9iamVjdCAqZGljdDsKfSBIZWFwQ1R5cGVXaXRoRGljdFN0cnVjdDsKCnN0YXRpYyB2b2lkCmhlYXBjdHlwZXdpdGhyZWxhdGl2ZWRpY3RfZGVhbGxvYyhQeU9iamVjdCogc2VsZikKewogYWJsZXM6CmMtYmFzaWMtb2Zmc2V0OiA0CmluZGVudC10YWJzLW1vZGU6IG5pbApFbmQ6CiovCiNpZm5kZWYgX1BZVEhPTl9IQUNMX05BTUVTUEFDRVNfSAojZGVmaW5lIF9QWVRIT05fSEFDTF9OQU1FU1BBQ0VTX0gKCi8qCiAqIFVzZSBnbG9iYWxseSB1bmlxdWUgbmFtZXMgdG8gYXZvaWQgbGlua2FnZSBjb25mbGljdHMgd2l0aCBidWlsZHMgbGlua2luZwogKiBvciBkeW5hbWljYWxseSBsb2FkaW5nIG90aGVyIGNvZGUgcG90ZW50aWFsbHkgdXNpbmcgSEFDTCogbGlicmFyaWVzLgogKgogKiBBc3N1bWluZyB0aGF0IHRoZSBjdXJyZW50IHdvcmtpbmcgZGlyZWN0b3J5IGlzIE1vZHVsZXMvX2hhY2wsCiAqIHVzZSB0aGUgZm9sbG93aW5nIGNvbW1hbmQgdG8gZ2VuZXJhdGUgYSBsaXN0IG9mIGNhbmRpZGF0ZXM6CgogICAgbm0gLWogKi5vIHwgZ3JlcCAtaSBoYWNsIHwgZ3JlcCAtUCAnXlthLXpBLVpfXVthLXpBLVowLTlfX2FsZyBhMSA9IGJsb2NrX3N0YXRlMS5mc3Q7CiAgICB1aW50NjRfdCAqczIgPSBibG9ja19zdGF0ZTEuc25kOwogICAgSGFjbF9IYXNoX1NIQTNfdXBkYXRlX211bHRpX3NoYTMoYTEsIHMyLCBkYXRhMSwgZGF0YTFfbGVuIC8gYmxvY2tfbGVuKGExKSk7CiAgICB1aW50OF90ICpkc3QgPSBidWY7CiAgICBtZW1jcHkoZHN0LCBkYXRhMiwgZGF0YTJfbGVuICogc2l6ZW9mICh1aW50OF90KSk7CiAgICAqc3RhdGUgPQogICAgICAoCiAgICAgICAgKEhhY2xfSGFzaF9TSEEzX3N0YXRlX3QpewogICAgICAgICAgLmJsb2NrX3N0YXRlID0gYmxvY2tfc3RhdGUxLAogICAgICAgICAgLmJ1ZiA9IGJ1ZiwKICAgICAgICAgIC50b3RhbF9sZW4gPSB0b3RhbF9sZW4xICsgKHVpbnQ2NF90KShjaHVua19sZW4gLSBkaWZmKQogICAgICAgIH0KICAgICAgKTsKICB9CiAgcmV0dXJuIEhhY2xfU3RyZWFtaW5nX1R5cGVzX1N1Y2Nlc3M7Cn0KCmFtb25nc3Qgb3RoZXIgdGhyZWFkcyB0aGF0IGV4aXN0IHNpbXVsdGFuZW91c2x5LlxuXApUaGlzIG1heSBiZSB1c2VkIHRvIGlkZW50aWZ5IHBlci10aHJlYWQgcmVzb3VyY2VzLlxuXApFdmVuIHRob3VnaCBvbiBzb21lIHBsYXRmb3JtcyB0aHJlYWRzIGlkZW50aXRpZXMgbWF5IGFwcGVhciB0byBiZVxuXAphbGxvY2F0ZWQgY29uc2VjdXRpdmUgbnVtYmVycyBzdGFydGluZyBhdCAxLCB0aGlzIGJlaGF2aW9yIHNob3VsZCBub3RcblwKYmUgcmVsaWVkIHVwb24sIGFuZCB0aGUgbnVtYmVyIHNob3VsZCBiZSBzZWVuIHB1cmVseSBhcyBhIG1hZ2ljIGNvb2tpZS5cblwKQSB0aHJlYWQncyBpZGVudGl0eSBtYXkgYmUgcmV1c2VkIGZvciBhbm90aGVyIHRocmVhZCBhZnRlciBpdCBleGl0cy4iKTsKCiNpZmRlZiBQWV9IQVZFX1RIUkVBRF9OQVRJVkVfSUQKc3RhdGljIFB5T2JqZWN0ICoKdGhyZWFkX2dldF9uYXRpdmVfaWQocHRyX3QKX2Nnb193YWl0X3J1bnRpbWVfaW5pdF9kb25lKHZvaWQpIHsKCXZvaWQgKCpwZm4pKHN0cnVjdCBjZ29Db250ZXh0QXJnKik7CgoJIF9jZ29fbWF5YmVfcnVuX3ByZWluaXQoKTsKCXdoaWxlICghX2Nnb19pc19ydW50aW1lX2luaXRpYWxpemVkKCkpIHsKCQkJV2FpdEZvclNpbmdsZU9iamVjdChydW50aW1lX2luaXRfd2FpdCwgSU5GSU5JVEUpOwoJfQoJcGZuID0gX2Nnb19nZXRfY29udGV4dF9mdW5jdGlvbigpOwoJaWYgKHBmbiAhPSBuaWwpIHsKCQlzdHJ1Y3QgY2dvQ29udGV4dEFyZyBhcmc7CgoJCWFyZy5Db250ZXh0ID0gMDsKCQkoKnBmbikoJmFyZyk7CgkJcmV0dXJuIGFyZy5Db250ZXh0OwoJfQoJcmV0dXJuIDA7Cn0KCi8vIFNob3VsZCBub3QgYmUgdXNlZCBzaW5jZSB4X2Nnb19wdGhyZWFkX2tleV9jcmVhdGVkIHdpbGwgYWx3YXlzIGJlIHplcm8uCnZvaWQgeF9jZ29fYmluZG0odm9pZCogZHVtbXkpZyBvbiBsb2NrIGFjcXVpc2l0aW9uLiAgSWYgTE9DS19OQiBpcyB1c2VkIGFuZAp0aGUgbG9jayBjYW5ub3QgYmUgYWNxdWlyZWQsIGFuIE9TRXJyb3Igd2lsbCBiZSByYWlzZWQgYW5kIHRoZSBleGNlcHRpb24Kd2lsbCBoYXZlIGFuIGVycm5vIGF0dHJpYnV0ZSBzZXQgdG8gRUFDQ0VTIG9yIEVBR0FJTiAoZGVwZW5kaW5nIG9uIHRoZQpvcGVyYXRpbmcgc3lzdGVtIC0tIGZvciBwb3J0YWJpbGl0eSwgY2hlY2sgZm9yIGVpdGhlciB2YWx1ZSkuCgpsZW4gaXMgdGhlIG51bWJlciBvZiBieXRlcyB0byBsb2NrLCB3aXRoIHRoZSBkZWZhdWx0IG1lYW5pbmcgdG8gbG9jayB0bwpFT0YuICBzdGFydCBpcyB0aGUgYnl0ZSBvZmZzZXQsIHJlbGF0aXZlIHRvIHdoZW5jZSwgdG8gdGhhdCB0aGUgbG9jawpzdGFydHMuICB3aGVuY2UgaXMgYXMgd2l0aCBmaWxlb2JqLnNlZWsoKSwgc3BlY2lmaWNhbGx5OgoKICAgIDAgLSByZWxhIGJ1ZlszMl07IGJ1ZlswXSA9IDA7CiAgaW50ICBsZW4gPSAzMjsKICBjb25zdCBjaGFyKiBzdWZmaXggPSAodW5pdCA8PSAwID8gIiAiIDogIkIiKTsKICBjb25zdCBpbnQ2NF90IGJhc2UgPSAodW5pdCA9PSAwID8gMTAwMCA6IDEwMjQpOwogIGlmICh1bml0PjApIG4gKj0gdW5pdDsKCiAgY29uc3QgaW50NjRfdCBwb3MgPSAobiA8IDAgPyAtbiA6IG4pOwogIGlmIChwb3MgPCBiYXNlKSB7CiAgICBpZiAobiE9MSB8fCBzdWZmaXhbMF0gIT0gJ0InKSB7ICAvLyBza2lwIHByaW50aW5nIDEgQiBmb3IgdGhlIHVuaXQgY29sdW1uCiAgICAgIHNucHJpbnRmKGJ1ZiwgbGVuLCAiJWQgICAlLTNzIiwgKGludCluLCAobj09MCA/ICIiIDogc3VmZml4KSk7CiAgICB9CiAgfQogIGVsc2UgewogICAgaW50NjRfdCBkaXZpZGVyID0gYmFzZTsKICAgIGNvbnN0IGNoYXIqIG1hZ25pdHVkZSA9ICJLIjsKICAgIGlmIChwb3MgPj0gZGl2IGFuIGlzc3VlIGluIFdlYkFzc2VtYmx5LiBXQVNNJ3MgaW5kaXJlY3RfY2FsbCBoYXMgc3RyaWN0CiAqIGZ1bmN0aW9uIHNpZ25hdHVyZSBjaGVja3MuIEFyZ3VtZW50IGNvdW50LCB0eXBlcywgYW5kIHJldHVybiB0eXBlIG11c3QgbWF0Y2guCiAqCiAqIFRoaXJkIHBhcnR5IGNvZGUgdW5pbnRlbnRpb25hbGx5IHJlbHkgb24gcHJvYmxlbWF0aWMgZnBjYXN0cy4gVGhlIGNhbGwKICogdHJhbXBvbGluZSBtaXRpZ2F0ZXMgY29tbW9uIG9jY3VycmVuY2VzIG9mIGJhZCBmcGNhc3RzIG9uIEVtc2NyaXB0ZW4uCiAqLwoKI2lmIGRlZmluZWQoX19FTVNDUklQVEVOX18pICYmIGRlZmluZWQoUFlfQ0FMTF9UUkFNUE9MSU5FKQoKdm9pZApfUHlfRW1zY3JpcHRlblRyYW1wb2xpbmVfSW5pdChfUHlSdW50aW1lU3RhdGUgKnJ1bnRpbWUpOwoKUHlPYmplY3QqCl9QeUVNX1RyYW1wb2xpbmVDYWxsKFB5Q0Z1bmN0aW9uV2l0aEtleXdvcCAmIGZpbmFsX21hc2spICE9IDApIHsgZ290byByb2xsYmFjazsgfQogIH0gd2hpbGUgKCFtaV9hdG9taWNfY2FzX3N0cm9uZ19hY3FfcmVsKGZpZWxkLCAmbWFwLCBuZXdtYXApKTsKCiAgLy8gY2xhaW1lZCEKICAqYml0bWFwX2lkeCA9IG1pX2JpdG1hcF9pbmRleF9jcmVhdGUoaWR4LCBpbml0aWFsX2lkeCk7CiAgcmV0dXJuIHRydWU7Cgpyb2xsYmFjazoKICAvLyByb2xsIGJhY2sgaW50ZXJtZWRpYXRlIGZpZWxkcwogIC8vICh3ZSBqdXN0IGZhaWxlZCB0byBjbGFpbSBgZmllbGRgIHNvIGRlY3JlbWVudCBmaXJzdCkKICB3aGlsZSAoLS1maWVsZCA+IGluaXRpYWxfZmllbGQpIHsKICAgIG5ld21hcCA9IDA7CiAgICBtYXAgPSBNSV9CSVRNQVBfRklFTERfRlVMTDsKICAgIG1pX2Fzc2VydF9pbnRlcm5hbChtaV9hdG9taWNfbG9hZF9yZWxheGVkKGZpZWxkKSA9PSBtYXApOwogICAgbWlfYXRvbWljX3N0b3JlX3JlbGVhdGF0ZV9zdHJ1Y3RpbnN0KHNlbGYpOwoKICAgIGZtdCA9IFB5Qnl0ZXNfQVNfU1RSSU5HKHNlbGYtPnNfZm9ybWF0KTsKICAgIGlmIChzdHJsZW4oZm10KSAhPSAoc2l6ZV90KVB5Qnl0ZXNfR0VUX1NJWkUoc2VsZi0+c19mb3JtYXQpKSB7CiAgICAgICAgUHlFcnJfU2V0U3RyaW5nKHN0YXRlLT5TdHJ1Y3RFcnJvciwKICAgICAgICAgICAgICAgICAgICAgICAgImVtYmVkZGVkIG51bGwgY2hhcmFjdGVyIik7CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQoKICAgIGYgPSB3aGljaHRhYmxlKCZmbXQpOwoKICAgIHMgPSBmbXQ7CiAgICBzaXplID0gMDsKICAgIGxlbiA9IDA7CiAgICBuY29kZXMgPSAwOwogICAgd2hpbGUgKChjID0gKnMrKykgIT0gJ1wwJykgewogICAgICAgIGlmIChQeV9JU1NQQUNFKGMpKQogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICBpZiAoJzAnIDw9IGMgJiYgYyA8PSAnOScpIHsKdGlwbGllciB1c2VkIGluIHN0cmluZyBhbmQgdmFyaW91cyBvdGhlciBoYXNoZXMuICovCiNkZWZpbmUgUHlIQVNIX01VTFRJUExJRVIgMTAwMDAwM1VMICAvKiAweGY0MjQzICovCgovKiBQYXJhbWV0ZXJzIHVzZWQgZm9yIHRoZSBudW1lcmljIGhhc2ggaW1wbGVtZW50YXRpb24uICBTZWUgbm90ZXMgZm9yCiAgIF9QeV9IYXNoRG91YmxlIGluIFB5dGhvbi9weWhhc2guYy4gIE51bWVyaWMgaGFzaGVzIGFyZSBiYXNlZCBvbgogICByZWR1Y3Rpb24gbW9kdWxvIHRoZSBwcmltZSAyKipQeUhBU0hfQklUUyAtIDEuICovCgojaWYgU0laRU9GX1ZPSURfUCA+PSA4CiMgIGRlZmluZSBQeUhBU0hfQklUUyA2MQojZWxzZQojICBkZWZpbmUgUHlIQVNIX0JJVFMgMzEKI2VuZGlmCgojZGVmaW5lIFB5SEFTSF9NT0RVTFVTICgoKHNpemVfdCkxIDw8IFB5SEFTSF9CSVRTKSAtIDEpCiNkZWZpbmUgUHlIQVNIX0lORiAzMTQxNTkKI2RleXRlc19oZXhfX2RvY19fLAoiaGV4KCRzZWxmLCAvLCBzZXA9PHVucmVwcmVzZW50YWJsZT4sIGJ5dGVzX3Blcl9zZXA9MSlcbiIKIi0tXG4iCiJcbiIKIkNyZWF0ZSBhIHN0cmluZyBvZiBoZXhhZGVjaW1hbCBudW1iZXJzIGZyb20gYSBieXRlcyBvYmplY3QuXG4iCiJcbiIKIiAgc2VwXG4iCiIgICAgQW4gb3B0aW9uYWwgc2luZ2xlIGNoYXJhY3RlciBvciBieXRlIHRvIHNlcGFyYXRlIGhleCBieXRlcy5cbiIKIiAgYnl0ZXNfcGVyX3NlcFxuIgoiICAgIEhvdyBtYW55IGJ5dGVzIGJldHdlZW4gc2VwYXJhdG9ycy4gIFBvc2l0aXZlIHZhbHVlcyBjb3VudCBmcm9tIHRoZVxuIgoiICAgIHJpZ2h0LCBuZWdhdGl2ZSB2YWx1ZXMgY291bnQgZnJvbSB0aGUgbGVmdC5cbiIKIlxuIgoiRXhhbXBsZTpcbiIKIj4+PiB2YWx1ZSA9IGJcJ1xceGI5XFx4MDFcXHhlZlwnXG4iCiI+Pj4gdmFsdWUuaGV4KClcbiIKIlwnYjkwMWVmXCdcb25hbCgicnN0cmlwIiwgbmFyZ3MsIDAsIDEpKSB7CiAgICAgICAgZ290byBleGl0OwogICAgfQogICAgaWYgKG5hcmdzIDwgMSkgewogICAgICAgIGdvdG8gc2tpcF9vcHRpb25hbDsKICAgIH0KICAgIGJ5dGVzID0gYXJnc1swXTsKc2tpcF9vcHRpb25hbDoKICAgIHJldHVybl92YWx1ZSA9IGJ5dGVzX3JzdHJpcF9pbXBsKChQeUJ5dGVzT2JqZWN0ICopc2VsZiwgYnl0ZXMpOwoKZXhpdDoKICAgIHJldHVybiByZXR1cm5fdmFsdWU7Cn0KClB5RG9jX1NUUlZBUihieXRlc19jb3VudF9fZG9jX18sCiJjb3VudCgkc2VsZiwgc3ViWywgc3RhcnRbLCBlbmRdXSwgLylcbiIKIi0tXG4iCiJcbiIKIlJldHVybiB0aGUgbnVtYmVyIG9mIG5vbi1vdmVybGFwcGluZyBvY2N1cnJlbmNlcyBvZiBzdWJzZWN0aW9uIFwnc3ViXCcgaW4gYnl0ZXMgQltzdGFydDplbmRdLlxuIgoiXG4iCiIgIHN0YXJ0XG4iCiIgICAgT3B0aW9uYWwgc3RhbHNlLCBvbmx5IGluaXRpYWxpemUgZm9yIHRoZSBtYWluIHRocmVhZC4KICAgIG9ubHlfYWN0aXZlX3RocmVhZDogSWYgVHJ1ZSwgb25seSBzYW1wbGUgdGhlIHRocmVhZCBob2xkaW5nIHRoZSBHSUwuCiAgICBtb2RlOiBQcm9maWxpbmcgbW9kZTogMD1XQUxMICh3YWxsLXRpbWUpLCAxPUNQVSAoY3B1LXRpbWUpLCAyPUdJTCAoZ2lsLXRpbWUpLgogICAgICAgICAgICAgICAgICAgICAgIENhbm5vdCBiZSB1c2VkIHRvZ2V0aGVyIHdpdGggYWxsX3RocmVhZHM9VHJ1ZS4KICAgIGRlYnVnOiBJZiBUcnVlLCBjaGFpbiBleGNlcHRpb25zIHRvIGV4cGxhaW4gdGhlIHNlcXVlbmNlIG9mIGV2ZW50cyB0aGF0CiAgICAgICAgICAgbGVhZCB0byB0aGUgZXhjZXB0aW9uLgogICAgc2tpcF9ub25fbWF0Y2hpbmdfdGhyZWFkczogSWYgVHJ1ZSwgc2tpcCB0aHJlYWRzIHRoYXQgZG9uJ3QgbWF0Y2ggdGhlIHNlbGVjdGVkIG1vZGUuCiAgaGVkIGZpcnN0KS5cbiIKIkhvd2V2ZXIsIGZvciBpbnRlcmFjdGl2ZSByYXcgc3RyZWFtcyAoYXMgd2VsbCBhcyBzb2NrZXRzIGFuZCBwaXBlcyksXG4iCiJhdCBtb3N0IG9uZSByYXcgcmVhZCB3aWxsIGJlIGlzc3VlZCwgYW5kIGEgc2hvcnQgcmVzdWx0IGRvZXMgbm90XG4iCiJpbXBseSB0aGF0IEVPRiBpcyBpbW1pbmVudC5cbiIKIlxuIgoiUmV0dXJuIGFuIGVtcHR5IGJ5dGVzIG9iamVjdCBvbiBFT0YuXG4iCiJcbiIKIlJldHVybiBOb25lIGlmIHRoZSB1bmRlcmx5aW5nIHJhdyBzdHJlYW0gd2FzIG9wZW4gaW4gbm9uLWJsb2NraW5nXG4iCiJtb2RlIGFuZCBubyBkYXRhIGlzIGF2YWlsYWJsZSBhdCB0aGUgbW9tZW50LiIpOwoKI2RlZmluZSBfSU9fX0JVRkZFUkVESU9CQVNFX1JFQURfTUVUSE9EREVGICAgIFwKICAgIHsicmVhZCIsIF9QeUNGdW5jdGlvbl9DQVNUKF9pb19fQnVmZmVyZWRJT0Jhc2VfcmVhZCksIE1FdHVyZSkKICAgICAgICAgKiAoc2luY2UgQVNDSUkgaXMgZGVjb2RlZCBmcm9tIFVURi04LCB0aGUgdXRmOCBzdHJpbmcgYXJlIHRoZSBkYXRhKQoKICAgICAgIC0gY29tcGFjdDoKCiAgICAgICAgICogc3RydWN0dXJlID0gUHlDb21wYWN0VW5pY29kZU9iamVjdAogICAgICAgICAqIHRlc3Q6IFB5VW5pY29kZV9JU19DT01QQUNUKG9wKSAmJiAhUHlVbmljb2RlX0lTX0FTQ0lJKG9wKQogICAgICAgICAqIGtpbmQgPSBQeVVuaWNvZGVfMUJZVEVfS0lORCwgUHlVbmljb2RlXzJCWVRFX0tJTkQgb3IKICAgICAgICAgICBQeVVuaWNvZGVfNEJZVEVfS0lORAogICAgICAgICAqIGNvbXBhY3QgPSAxCiAgICAgICAgICogYXNjaWkgPSAwCiAgICAgICAgICogdXRmOCBpcyBub3Qgc2hhcmVkIHdpdGggZGF0YQogICAgICAgICAqIHV0ZjhfbGVuZ3RoID0gMCBpZiB1dGY4IGlzIE5VTEwKICAgICAgICAgKiAoZGF0YSBzdGFydHMganVzdXRleCAqbSk7CgovLyBBIHJlYWRlcnMtd3JpdGVyIChSVykgbG9jay4gVGhlIGxvY2sgc3VwcG9ydHMgbXVsdGlwbGUgY29uY3VycmVudCByZWFkZXJzIG9yCi8vIGEgc2luZ2xlIHdyaXRlci4gVGhlIGxvY2sgaXMgd3JpdGUtcHJlZmVycmluZzogaWYgYSB3cml0ZXIgaXMgd2FpdGluZyB3aGlsZQovLyB0aGUgbG9jayBpcyByZWFkLWxvY2tlZCB0aGVuLCBuZXcgcmVhZGVycyB3aWxsIGJlIGJsb2NrZWQuIFRoaXMgYXZvaWRzCi8vIHN0YXJ2YXRpb24gb2Ygd3JpdGVycy4KLy8KLy8gSW4gQysrLCB0aGUgZXF1aXZhbGVudCBzeW5jaHJvbml6YXRpb24gcHJpbWl0aXZlIGlzIHN0ZDo6c2hhcmVkX211dGV4Ci8vIHdpdGggc2hhcmVkICgicmVhZCIpIGFuZCBleGNsdXNpdmUgKCJ3cml0ZSIpIGxvY2tpbmcuCi8vCi8vIFRoZSB0d28gbGVhc3Qgc2lnbmlmaWNhbnQgYml0cyBhcmUgdXNlZCB0byBpbmRpY2F0ZSBpZiAgYWlfZmxhZ3M7ICAgICAgIC8qIEFJX1BBU1NJVkUsIEFJX0NBTk9OTkFNRSAqLwogICAgaW50ICAgICAgICAgYWlfZmFtaWx5OyAgICAgIC8qIFBGX3h4eCAqLwogICAgaW50ICAgICAgICAgYWlfc29ja3R5cGU7ICAgIC8qIFNPQ0tfeHh4ICovCiAgICBpbnQgICAgICAgICBhaV9wcm90b2NvbDsgICAgLyogMCBvciBJUFBST1RPX3h4eCBmb3IgSVB2NCBhbmQgSVB2NiAqLwogICAgc2l6ZV90ICAgICAgYWlfYWRkcmxlbjsgICAgIC8qIGxlbmd0aCBvZiBhaV9hZGRyICovCiAgICBjaGFyICAgICAgICAqYWlfY2Fub25uYW1lOyAgLyogY2Fub25pY2FsIG5hbWUgZm9yIGhvc3RuYW1lICovCiAgICBzdHJ1Y3Qgc29ja2FkZHIgKmFpX2FkZHI7ICAgICAgICAgICAvKiBiaW5hcnkgYWRkcmVzcyAqLwogICAgc3RydWN0IGFkZHJpbmZvICphaV9uZXh0OyAgICAgICAgICAgLyogbmV4dCBzdHJ1Y3R1cmUgaW4gbGlua2VkIGxpc3QgZmFzdCBtb2RlOyBhbHRlcmVkIGRhdGEgd2lsbCBub3QgYXV0b21hdGljYWxseVxuIgoiYmUgd3JpdHRlbiB0byB0aGUgZGlzayBhZnRlciBldmVyeSBjaGFuZ2UuICBUaGlzIHJlc3VsdHMgaW4gZmFzdGVyXG4iCiJ3cml0ZXMgdG8gdGhlIGRhdGFiYXNlLCBidXQgbWF5IHJlc3VsdCBpbiBhbiBpbmNvbnNpc3RlbnQgZGF0YWJhc2VcbiIKImlmIHRoZSBwcm9ncmFtIGNyYXNoZXMgd2hpbGUgdGhlIGRhdGFiYXNlIGlzIHN0aWxsIG9wZW4uICBVc2UgdGhlXG4iCiJzeW5jKCkgbWV0aG9kIHRvIGZvcmNlIGFueSB1bndyaXR0ZW4gZGF0YSB0byBiZSB3cml0dGVuIHRvIHRoZSBkaXNrLlxuIgoiVGhlIFwnc1wnIGZsYWcgY2F1c2VzIGFsbCBkYXRhYmFzZSBvcGVyYXRpb25zIHRvIGJlIHN5bmNocm9uaXplZCB0b1xuIgoiZGlzay4gIFRoZSBcJ3VcJyBmbGFnIGRpc2FibGVzIGxvY2tpbmcgb2YgdGhlIGRhdGFiYXNlIGZpbHRoYC4gV2hlbiBpbiBkb3VidCwgY2FsbGVycwpjYW4gcGFzcyBhbiBhcnJheSBvZiBzaXplIEhBQ0xfQkxBS0UyQl8zMl9PVVRfQllURVMsIHRoZW4gdXNlIHRoZSByZXR1cm4gdmFsdWUKdG8gc2VlIGhvdyBtYW55IGJ5dGVzIHdlcmUgYWN0dWFsbHkgd3JpdHRlbi4KKi8KdWludDhfdCBIYWNsX0hhc2hfQmxha2UyYl9kaWdlc3QoSGFjbF9IYXNoX0JsYWtlMmJfc3RhdGVfdCAqcywgdWludDhfdCAqZHN0KTsKCkhhY2xfSGFzaF9CbGFrZTJiX2luZGV4IEhhY2xfSGFzaF9CbGFrZTJiX2luZm8oSGFjbF9IYXNoX0JsYWtlMmJfc3RhdGVfdCAqcyk7CgovKioKICBGcmVlIHN0YXRlIGZ1bmN0aW9uIHdoZW4gdGhlcmUgaXMgbm8ga2V5CiovCnZvaWQgSGFjbF9IYXNoX0JsYWtlMmJfZnJlZShIYWNsX0hhc2hfQmxha2UyYl9zdGF0ZV90ICpzdGF0ZSk7CgovKioKICBDb3B5aW5nLiBUaGlzIHByZXNlcnZlcyBhbGwgcGFyYSUqcyIsKGludCkod2luZG93X2xhc3QgLSBoYXlzdGFjayArIDEgLSBsZW5fbmVlZGxlKSwgIiIpOyBcCiAgICBMT0dfU1RSSU5HKG5lZWRsZSwgbGVuX25lZWRsZSk7IExPRygiXG4iKTsgICAgICAgICAgICAgICAgICAgICBcCn0gd2hpbGUoMCkKI2Vsc2UKIyBkZWZpbmUgTE9HKC4uLikKIyBkZWZpbmUgTE9HX1NUUklORyhzLCBuKQojIGRlZmluZSBMT0dfTElORVVQKCkKI2VuZGlmCgpQeV9MT0NBTF9JTkxJTkUoUHlfc3NpemVfdCkKU1RSSU5HTElCKF9sZXhfc2VhcmNoKShjb25zdCBTVFJJTkdMSUJfQ0hBUiAqbmVlZGxlLCBQeV9zc2l6ZV90IGxlbl9uZWVkbGUsCiAgICAgICAgICAgICAgICAgICAgICAgUHlfc3NpemVfdCAqcmV0dXJuX3BlcmlvZCwgaW50IGludmVydF9hbHBoYWJldCkKewogICAgLyogRG8gYSBsZXhpY29ncmFwaGljIHNlYXJjaC4gRXNzZW50aWFsbHkgdGhpczoKICAgICAgICAgICA+Pj4gbWF4KGFycmF5CiAgIGluIEMtc3R5bGUgKGxhc3QgZGltZW5zaW9uIHZhcmllcyB0aGUgZmFzdGVzdCkuICBJZiBmb3J0CiAgIGlzICdBJywgdGhlbiBpdCBkb2VzIG5vdCBtYXR0ZXIgYW5kIHRoZSBjb3B5IHdpbGwgYmUgbWFkZQogICBpbiB3aGF0ZXZlciB3YXkgaXMgbW9yZSBlZmZpY2llbnQuICovClB5QVBJX0ZVTkMoaW50KSBQeU9iamVjdF9Db3B5RGF0YShQeU9iamVjdCAqZGVzdCwgUHlPYmplY3QgKnNyYyk7CgovKiBDb3B5IHRoZSBkYXRhIGZyb20gdGhlIHNyYyBidWZmZXIgdG8gdGhlIGJ1ZmZlciBvZiBkZXN0aW5hdGlvbi4gKi8KUHlBUElfRlVOQyhpbnQpIFB5QnVmZmVyX0lzQ29udGlndW91cyhjb25zdCBQeV9idWZmZXIgKnZpZXcsIGNoYXIgZm9ydCk7CgovKkZpbGwgdGhlIHN0cmlkZXMgYXJyYXkgd2l0aCBieXRlLXN0cmlkZXMgb2YgYSBjb250aWd1b3VzCiAgKEZvcnRyYW4tc3R5bGUgaWYgZm9ydCBpcyAnRiAgLy8gZ2V0dGltZW9mZGF5KCkKI2VuZGlmCiNpZmRlZiBNU19XSU5ET1dTCiMgIGluY2x1ZGUgPHdpbnNvY2syLmg+ICAgICAgICAgICAvLyBzdHJ1Y3QgdGltZXZhbAojZW5kaWYKCiNpZiBkZWZpbmVkKF9fQVBQTEVfXykKIyAgaW5jbHVkZSA8bWFjaC9tYWNoX3RpbWUuaD4gICAgIC8vIG1hY2hfYWJzb2x1dGVfdGltZSgpLCBtYWNoX3RpbWViYXNlX2luZm8oKQoKI2lmIGRlZmluZWQoX19BUFBMRV9fKSAmJiBkZWZpbmVkKF9faGFzX2J1aWx0aW4pCiMgIGlmIF9faGFzX2J1aWx0aW4oX19idWlsdGluX2F2YWlsYWJsZSkKIyAgICBkZWZpbmUgSEFWRV9DTE9DS19HRVRUSU1FX1JVTlRJTUUgX19idWlsdGluX2F2YWlsYWJsZShtYWNPUyAxMC4xMiwgaU9TIDEwLjAsIHR2T1MgMTAuMCwgd2F0Y2hPUyAzLjAsICopCiMgIGVuZGlmCiNlbmRpZgojZW5kaWYKCi8qIFRvIG1pbGxpc2Vjb25kICgxMF4tMykgKi8KICAgMHgxOCwgMHgxOSwgMHgxYSwgMHgxYiwgMHgxYywgMHgxZCwgMHgxZSwgMHgxZiwKICAgIDB4MjAsIDB4MjEsIDB4MjIsIDB4MjMsIDB4MjQsIDB4MjUsIDB4MjYsIDB4MjcsCiAgICAweDI4LCAweDI5LCAweDJhLCAweDJiLCAweDJjLCAweDJkLCAweDJlLCAweDJmLAogICAgMHgzMCwgMHgzMSwgMHgzMiwgMHgzMywgMHgzNCwgMHgzNSwgMHgzNiwgMHgzNywKICAgIDB4MzgsIDB4MzksIDB4M2EsIDB4M2IsIDB4M2MsIDB4M2QsIDB4M2UsIDB4M2YsCiAgICAweDQwLCAweDQxLCAweDQyLCAweDQzLCAweDQ0LCAweDQ1LCAweDQ2LCAweDQ3LAogICAgMHg0OCwgMHg0OSwgMHg0YSwgMHg0YiwgMHg0YywgMHg0ZCwgMHg0ZSwgMHg0ZiwKICAgIDB4NTAsIDB4NTEsIDB4NTIsIDB4NTMsIDB4NTQsIDB4NTUsIDB4NTYsIDB4NTcsCiAgICAweDU4LCAweDU5LCAweDVhLCAweDViLCAweDVjLCAweDVkLCAweDVlLCAweDVmLAogdWRlIDxQeXRob24uaD4KI2luY2x1ZGUgInB5Y29yZV9ieXRlc29iamVjdC5oIiAgIC8vIF9QeUJ5dGVzX0RlY29kZUVzY2FwZSgpCiNpbmNsdWRlICJweWNvcmVfdW5pY29kZW9iamVjdC5oIiAvLyBfUHlVbmljb2RlX0RlY29kZVVuaWNvZGVFc2NhcGVJbnRlcm5hbCgpCgojaW5jbHVkZSAibGV4ZXIvc3RhdGUuaCIKI2luY2x1ZGUgInBlZ2VuLmgiCiNpbmNsdWRlICJzdHJpbmdfcGFyc2VyLmgiCgojaW5jbHVkZSA8c3RkYm9vbC5oPgoKLy8vLyBTVFJJTkcgSEFORExJTkcgRlVOQ1RJT05TIC8vLy8KCnN0YXRpYyBpbnQKd2Fybl9pbnZhbGlkX2VzY2FwZV9zZXF1ZW5jZShQYXJzZXIgKnAsIGNvbnN0IGNoYXIqIGJ1ZmZlciwgY29uc3QgY2hhciAqZmlyc3RfaW52YWxpZF9lc2NhcGUsIFRva2VuICp0KQp7CiAgICBpZiAocC0+Y2FsbF9pbnZhbGlkX3J1bGVzKSB7CiAgICAgICAgLy8gRG8gbm90IHJlcG9ydCB3YXJubGxvYzIgZm9yIGFsaWduZWQgYWxsb2NhdGlvbiwgYnV0IGl0IGlzIG9ubHkgc3VwcG9ydGVkIG9uIFdpbmRvd3MgMTAgYW5kIFdpbmRvd3MgU2VydmVyIDIwMTYuCi8vIFNvLCB3ZSBuZWVkIHRvIGxvb2sgaXQgdXAgZHluYW1pY2FsbHkgdG8gcnVuIG9uIG9sZGVyIHN5c3RlbXMuICh1c2UgX19zdGRjYWxsIGZvciAzMi1iaXQgY29tcGF0aWJpbGl0eSkKLy8gTnRBbGxvY2F0ZVZpcnR1YWxBbGxvY0V4IGlzIHVzZWQgZm9yIGh1Z2UgT1MgcGFnZSBhbGxvY2F0aW9uICgxR2lCKQovLyBXZSBkZWZpbmUgYSBtaW5pbWFsIE1FTV9FWFRFTkRFRF9QQVJBTUVURVIgb3Vyc2VsdmVzIGluIG9yZGVyIHRvIGJlIGFibGUgdG8gY29tcGlsZSB3aXRoIG9sZGVyIFNESydzLgp0eXBlZGVmIGVudW0gTUlfTUVNX0VYVEVOREVEX1BBUkFNRVRFUl9UWVBFX0UgewogIE1pTWVtRXh0ZW5kZWRQYXJhbWV0ZXJJbnZhbGlkVHlwZSA9IDAsCiAgaGVuIGl0IHdvdWxkIGJlIGRpZmZpY3VsdCB0byBhbm5vdGF0ZSBlYWNoCiAgICAgb2YgdGhlIG11dGV4J3MgY3JpdGljYWwgc2VjdGlvbnMgaW5kaXZpZHVhbGx5IHVzaW5nIHRoZSBhbm5vdGF0aW9ucyBhYm92ZS4KICAgICBUaGlzIGFubm90YXRpb24gbWFrZXMgc2Vuc2Ugb25seSBmb3IgaHlicmlkIHJhY2UgZGV0ZWN0b3JzLiBGb3IgcHVyZQogICAgIGhhcHBlbnMtYmVmb3JlIGRldGVjdG9ycyB0aGlzIGlzIGEgbm8tb3AuIEZvciBtb3JlIGRldGFpbHMgc2VlCiAgICAgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9kYXRhLXJhY2UtdGVzdC93aWtpL1B1cmVIYXBwZW5zQmVmb3JlVnNIeWJyaWQgLiAqLwojZGVmaW5lIF9QeV9BTk5PVEFURV9QVVJFX0hBUFBFTlNfQkVGT1JFX01VVEVYKG11KSBcCiAgICBBbm5vdGF0ZU11dGV4SXNVc2VkQXNDb25kVmFyKF9fRklMRV9fLCBfX0xJTkVfXywgbXUpCgogIC8qIC0tLS0tdGUsIF9fZGljdF9fKTsKICAgIEFERF9JTlRFUk5FRChzdGF0ZSwgaXRlcik7CgogICAgQ1JFQVRFX1RZUEUobSwgc3RhdGUtPkFycmF5VHlwZSwgJmFycmF5X3NwZWMpOwogICAgQ1JFQVRFX1RZUEUobSwgc3RhdGUtPkFycmF5SXRlclR5cGUsICZhcnJheWl0ZXJfc3BlYyk7CiAgICBQeV9TRVRfVFlQRShzdGF0ZS0+QXJyYXlJdGVyVHlwZSwgJlB5VHlwZV9UeXBlKTsKCiAgICBpZiAoUHlNb2R1bGVfQWRkT2JqZWN0UmVmKG0sICJBcnJheVR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoUHlPYmplY3QgKilzdGF0ZS0+QXJyYXlUeXBlKSA8IDApIHsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgUHlPYmplY3QgKm11dGFibGVzZXF1ZW5jZSA9IFB5SW1wb3J0X0ltcG9ydE1vZHVsZUF0dHJTdHJpbmcoCiAgICAgICAgICAgICJjb2xsZWN0aW9ucy5hYmMiLCAiTXV0YWJsZVNlcXVlbmNlIik7CiAgIGl0ZW1zaXplID0gc2VsZi0+b2JfZGVzY3ItPml0ZW1zaXplOwogICAgLyogZm9yICdhWzI6MV0gPSAuLi4nLCB0aGUgaW5zZXJ0aW9uIHBvaW50IGlzICdzdGFydCcsIG5vdCAnc3RvcCcgKi8KICAgIGlmICgoc3RlcCA+IDAgJiYgc3RvcCA8IHN0YXJ0KSB8fAogICAgICAgIChzdGVwIDwgMCAmJiBzdG9wID4gc3RhcnQpKQogICAgICAgIHN0b3AgPSBzdGFydDsKCiAgICAvKiBJc3N1ZSAjNDUwOTogSWYgdGhlIGFycmF5IGhhcyBleHBvcnRlZCBidWZmZXJzIGFuZCB0aGUgc2xpY2UKICAgICAgIGFzc2lnbm1lbnQgd291bGQgY2hhbmdlIHRoZSBzaXplIG9mIHRoZSBhcnJheSwgZmFpbCBlYXJseSB0byBtYWtlCiAgICAgICBzdXJlIHdlIGRvbid0IG1vZGlmeSBpdC4gKi8KICAgIGlmICgobmVlZGVkID09IDAgfHwgc2xpY2VsZW5ndGggIT0gbmVlZGVkKSAmJiBzZWxmLT5vYl9leHBvcnRzID4gMCktLS0tCkNvcHlyaWdodCAoYykgMjAxOC0yMDIxLCBNaWNyb3NvZnQgUmVzZWFyY2gsIERhYW4gTGVpamVuClRoaXMgaXMgZnJlZSBzb2Z0d2FyZTsgeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeSBpdCB1bmRlciB0aGUKdGVybXMgb2YgdGhlIE1JVCBsaWNlbnNlLiBBIGNvcHkgb2YgdGhlIGxpY2Vuc2UgY2FuIGJlIGZvdW5kIGluIHRoZSBmaWxlCiJMSUNFTlNFIiBhdCB0aGUgcm9vdCBvZiB0aGlzIGRpc3RyaWJ1dGlvbi4KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwojaW5jbHVkZSAibWltYWxsb2MuaCIKI2luY2x1ZGUgIm1pbWFsbG9jL2ludGVybmFsLmgiCiNpbmNsdWRlICJtaW1hbGxvYy9hdG9taWMuaCIKI2luY2x1ZGUgIm1pbWFsbG9jL3ByaW0uaCIgIC8vIG1pX3ByaW1fb3V0X3N0ZGVycgoKI2koYnVpbHRpbl9wcmludF9fZG9jX18sCiJwcmludCgkbW9kdWxlLCAvLCAqb2JqZWN0cywgc2VwPVwnIFwnLCBlbmQ9XCdcXG5cJywgZmlsZT1Ob25lLCBmbHVzaD1GYWxzZSlcbiIKIi0tXG4iCiJcbiIKIlByaW50cyB0aGUgdmFsdWVzIHRvIGEgc3RyZWFtLCBvciB0byBzeXMuc3Rkb3V0IGJ5IGRlZmF1bHQuXG4iCiJcbiIKIiAgc2VwXG4iCiIgICAgc3RyaW5nIGluc2VydGVkIGJldHdlZW4gdmFsdWVzLCBkZWZhdWx0IGEgc3BhY2UuXG4iCiIgIGVuZFxuIgoiICAgIHN0cmluZyBhcHBlbmRlZCBhZnRlciB0aGUgbGFzdCB2YWx1ZSwgZGVmYXVsdCBhIG5ld2xpbmUuXG4iCiIgIGZpbGVcbiIKIiAgICBhIGZpbGUtbGlrZSBvYmplY3QgKHN0cmVhbSk7IGRlZmF1bHRzIHRvIHRoZSBjdXJyZW50IHN5cy5zdGRvdXQuXG4iCiIgIGZsdXNoXG4iCiIgICAgd2hldGhlciB0byBmb3JjaWJseSBmbHVzaCB0aGUgc3RyZWFtLiIpOwoKICAgIFRocmVhZEVudHJ5ICplbnRyeSA9IHdyaXRlcl9nZXRfb3JfY3JlYXRlX3RocmVhZF9lbnRyeSgKICAgICAgICB3cml0ZXIsIHRocmVhZF9pZCwgaW50ZXJwcmV0ZXJfaWQsICZpc19uZXdfdGhyZWFkKTsKICAgIGlmICghZW50cnkpIHsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgLyogQ2FsY3VsYXRlIHRpbWVzdGFtcCBkZWx0YSAqLwogICAgdWludDY0X3QgZGVsdGEgPSB0aW1lc3RhbXBfdXMgLSBlbnRyeS0+cHJldl90aW1lc3RhbXA7CiAgICBlbnRyeS0+cHJldl90aW1lc3RhbXAgPSB0aW1lc3RhbXBfdXM7CgogICAgLyogUHJvY2VzcyBmcmFtZXMgYW5kIGJ1aWxkIGN1cnJlbnQgc3RhY2sgKi8KICAgIHVpbnQzMl90IGN1cnJfc3RhY2tbTUFYX1NUQUNLX0RFUFRIXTsKICAgIHNpemVfdCBjdXJyX2RlcHRoOwogICAgaWYgKGJ1aWxkX2ZyYW1lX3N0YWNrKHdyaXRlciwgZnJhbWVfbGlzdCwgY3Vycm9yIGEgdmFyaW50MzIgKi8KLyogRnJhbWUgYnVmZmVyOiBkZXB0aCB2YXJpbnQgKG1heCAyIGJ5dGVzIGZvciAyNTYpICsgMjU2IGZyYW1lcyAqIDUgYnl0ZXMvdmFyaW50ICsgbWFyZ2luICovCiNkZWZpbmUgTUFYX0ZSQU1FX0JVRkZFUl9TSVpFICgoTUFYX1NUQUNLX0RFUFRIICogTUFYX1ZBUklOVF9TSVpFX1UzMikgKyBNQVhfVkFSSU5UX1NJWkVfVTMyICsgMTYpCgovKiBGaWxlIHN0cnVjdHVyZSBzaXplcyAqLwojZGVmaW5lIEZJTEVfRk9PVEVSX1NJWkUgMzIKCi8qIEhlbHBlciBtYWNybzogY29udmVydCBQeUxvbmcgdG8gaW50MzIsIHVzaW5nIGRlZmF1bHRfdmFsIGlmIGNvbnZlcnNpb24gZmFpbHMgKi8KI2RlZmluZSBQWUxPTkdfVE9fSU5UMzJfT1JfREVGQVVMVChvYmosIHZhciwgZGVmYXVsdF92YWwpIFwKICAgIGRvIHsgXAogICAgICAgICh2YXIpID0gKGludDMyX3QpUHlMb25nX0FzTG9uZyhvYmopOyBcCmVuY2VfQ29uY2F0KFB5T2JqZWN0ICpzLCBQeU9iamVjdCAqbykKewogICAgaWYgKHMgPT0gTlVMTCB8fCBvID09IE5VTEwpIHsKICAgICAgICByZXR1cm4gbnVsbF9lcnJvcigpOwogICAgfQoKICAgIFB5U2VxdWVuY2VNZXRob2RzICptID0gUHlfVFlQRShzKS0+dHBfYXNfc2VxdWVuY2U7CiAgICBpZiAobSAmJiBtLT5zcV9jb25jYXQpIHsKICAgICAgICBQeU9iamVjdCAqcmVzID0gbS0+c3FfY29uY2F0KHMsIG8pOwogICAgICAgIGFzc2VydChfUHlfQ2hlY2tTbG90UmVzdWx0KHMsICIrIiwgcmVzICE9IE5VTEwpKTsKICAgICAgICByZXR1cm4gcmVzOwogICAgfQoKICAgIC8qIEluc3RhbmNlcyBvZiB1c2VyIGNsYXNzZXMgZGVmaW5pbmcgYW4gX19hZGRfXygpIG1ldGhvZCBvbmx5CiAgICAgICBoYXZlIGFuIG5iX2FkZCBzbG90LCBub3QgYW4gc3FfY29uY2F0IHNsb3QuICAgICAgU28gd2UgZmFsbCBiYWNrCiAKICogcmVhZCBpdCBpbiBvbmUgZ3VscCBhbmQgZGVsZWdhdGUgdG8gLi4uRnJvbVN0cmluZygpIGluc3RlYWQuICBNdWNoIHF1aWNrZXIKICogdGhhbiByZWFkaW5nIGEgYnl0ZSBhdCBhIHRpbWUgZnJvbSBmaWxlOyBzcGVlZHMgLnB5YyBpbXBvcnRzLgogKiBDQVVUSU9OOiAgc2luY2UgdGhpcyBtYXkgcmVhZCB0aGUgZW50aXJlIHJlbWFpbmRlciBvZiB0aGUgZmlsZSwgZG9uJ3QKICogY2FsbCBpdCB1bmxlc3MgeW91IGtub3cgeW91J3JlIGRvbmUgd2l0aCB0aGUgZmlsZS4KICovClB5T2JqZWN0ICoKUHlNYXJzaGFsX1JlYWRMYXN0T2JqZWN0RnJvbUZpbGUoRklMRSAqZnApCnsKLyogUkVBU09OQUJMRV9GSUxFX0xJTUlUIGlzIGJ5IGRlZm4gc29tZXRoaW5nIGJpZyBlbm91Z2ggZm9yIFRraW50ZXIucHljLiAqLwojZGVmaW5lIFJFQVNPTkFCTEVfRklMRV9MSU1JVCAoMUwgPDwgMTgpCiAgICBvZmZfdCBmaWxlc2l6ZTtiYWVkZWQyXSovCi8qIERpc2FibGUgZGVwcmVjYXRpb24gd2FybmluZ3MgYWJvdXQgR2V0VmVyc2lvbkV4IGFzIHRoZSByZXN1bHQgaXMKICAgYmVpbmcgcGFzc2VkIHN0cmFpZ2h0IHRocm91Z2ggdG8gdGhlIGNhbGxlciwgd2hvIGlzIHJlc3BvbnNpYmxlIGZvcgogICB1c2luZyBpdCBjb3JyZWN0bHkuICovCiNwcmFnbWEgd2FybmluZyhwdXNoKQojcHJhZ21hIHdhcm5pbmcoZGlzYWJsZTo0OTk2KQoKewogICAgcmV0dXJuIEdldFZlcnNpb24oKTsKfQoKI3ByYWdtYSB3YXJuaW5nKHBvcCkKCi8qW2NsaW5pYyBpbnB1dF0KX3dpbmFwaS5NYXBWaWV3T2ZGaWxlIC0+IExQVk9JRAoKICAgIGZpbGVfbWFwOiBIQU5ETEUKICAgIGRlc2lyZWRfYWNjZXNzOiBEV09SRAogICAgZmlsZV9vZmZzZXRfaGlnaDogRFdPUkQKICAgIGZpbGVfb2Zmc2V0X2xvdzogRFdPUkQKICAgIG51bWJlcl9ieXRlczogc2l6ZV90CiAgICAvCltjbGlzRXJyKEVSUk9SX0lOVkFMSURfUEFSQU1FVEVSKTsKCiAgICBpZiAoUHlTeXNfQXVkaXQoIl93aW5hcGkuQ3JlYXRlSnVuY3Rpb24iLCAidXUiLCBzcmNfcGF0aCwgZHN0X3BhdGgpIDwgMCkgewogICAgICAgIHJldHVybiBOVUxMOwogICAgfQoKICAgIC8qIEFkanVzdCBwcml2aWxlZ2VzIHRvIGFsbG93IHJld3JpdGluZyBkaXJlY3RvcnkgZW50cnkgYXMgYQogICAgICAganVuY3Rpb24gcG9pbnQuICovCiAgICBpZiAoIU9wZW5Qcm9jZXNzVG9rZW4oR2V0Q3VycmVudFByb2Nlc3MoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICBUT0tFTl9BREpVU1RfUFJJVklMRUdFUyB8IFRPS0VOX1FVRVJZLCAmdG9rZW4pKSB7CiAgICAgICAgZ290byBjbGVhbnVwOwogICAgfQoKICAgIGlmICghTG9va3VwUHJpdmlsZWdlVmFsdWUoTlVMTCwgU0VfUkVTVE9SRV9OQU1FLCAmdHAuYmFzZS5Qcml2aWxlZ2VzWzBdLkx1aWQpKSB7CnRpYWxfdmFsdWUsCiAgICAgICAgb3B0X2NvbmZpZy0+anVtcF9iYWNrd2FyZF9pbml0aWFsX2JhY2tvZmYpOwp9CgovKiBJbml0aWFsIGV4aXQgdGVtcGVyYXR1cmUuCiAqIE11c3QgYmUgbGFyZ2VyIHRoYW4gQURBUFRJVkVfQ09PTERPV05fVkFMVUUsCiAqIG90aGVyd2lzZSB3aGVuIGEgc2lkZSBleGl0IHdhcm1zIHVwIHdlIG1heSBjb25zdHJ1Y3QKICogYSBuZXcgdHJhY2UgYmVmb3JlIHRoZSBUaWVyIDEgY29kZSBoYXMgcHJvcGVybHkgcmUtc3BlY2lhbGl6ZWQuICovCiNkZWZpbmUgU0lERV9FWElUX0lOSVRJQUxfVkFMVUUgNDAwMAojZGVmaW5lIFNJREVfRVhJVF9JTklUSUFMX0JBQ0tPRkYgNgoKc3RhdGljIGlubGluZSBfUHlfQmFja29mZkNvdW50ZXIKaW5pdGlhbF90ZW1wZXJhdHVyZV9iYWNrb2ZmX2NvdW50ZXIoX1B5T3B0aW1pemF0aW9uQ29uZmlnICpvcHRfY29uZmlnKQp7CiAgICByZXR1cm4gbWFrZV9iYW5wdXQgbWVzc2FnZS4KQHBhcmFtIGtleSBQb2ludGVyIHRvIGBrZXlfbGVuYCBieXRlcyBvZiBtZW1vcnkgd2hlcmUgdGhlIGtleSBpcyByZWFkIGZyb20uCkBwYXJhbSBrZXlfbGVuIExlbmd0aCBvZiB0aGUga2V5LiBDYW4gYmUgMC4KKi8Kdm9pZApIYWNsX0hhc2hfQmxha2UyYl9TaW1kMjU2X2hhc2hfd2l0aF9rZXkoCiAgdWludDhfdCAqb3V0cHV0LAogIHVpbnQzMl90IG91dHB1dF9sZW4sCiAgdWludDhfdCAqaW5wdXQsCiAgdWludDMyX3QgaW5wdXRfbGVuLAogIHVpbnQ4X3QgKmtleSwKICB1aW50MzJfdCBrZXlfbGVuCik7CgovKioKV3JpdGUgdGhlIEJMQUtFMmIgZGlnZXN0IG9mIG1lc3NhZ2UgYGlucHV0YCB1c2luZyBrZXkgYGtleWAgYW5kCnBhcmFtZXRlcnMgYHBhcmFtc2AgaW50byBgb3V0cHV0YC4gVGhlIGBrZXlgIGFycmF5IG11c3QgYmUgb2YgbGVuZ3RoCmBwYXJhbXMua2V5X2xlbmd0aGAuIFRoZSBgb3RoYXQgc2V0cyAxIGJpdCBpbiBNIGJpdHMgY2FuIGJlIHRyaXZpYWxseQogKiBkZXJpdmVkIGZyb20gYSBsb2cyKE0pIGJpdCBoYXNoIGZ1bmN0aW9uLgogKiBTbyB3ZSBleHRyYWN0IDggKGxvZzIoMjU2KSkgYml0cyBhdCBhIHRpbWUgZnJvbQogKiB0aGUgNjRiaXQgaGFzaC4gKi8Kdm9pZApfUHlfQmxvb21GaWx0ZXJfQWRkKF9QeUJsb29tRmlsdGVyICpibG9vbSwgdm9pZCAqcHRyKQp7CiAgICB1aW50NjRfdCBoYXNoID0gYWRkcmVzc190b19oYXNoKHB0cik7CiAgICBhc3NlcnQoSyA8PSA4KTsKICAgIGZvciAoaW50IGkgPSAwOyBpIDwgSzsgaSsrKSB7CiAgICAgICAgdWludDhfdCBiaXRzID0gaGFzaCAmIDI1NTsKICAgICAgICBibG9vbS0+Yml0c1tiaXRzID4+IDVdIHw9ICgxIDw8IChiaXRzJjMxKSk7CiAgICAgICAgaGFzaCA+Pj0gODsKICAgIH0KfQoKc3RhdGljIGJvb2wKYmxvb21fZmlsdGVyX21heV9jb250YXRlOwoKc3RhdGljIGlubGluZSBfbHNwcm9mX3N0YXRlKgpfbHNwcm9mX2dldF9zdGF0ZShQeU9iamVjdCAqbW9kdWxlKQp7CiAgICB2b2lkICpzdGF0ZSA9IFB5TW9kdWxlX0dldFN0YXRlKG1vZHVsZSk7CiAgICBhc3NlcnQoc3RhdGUgIT0gTlVMTCk7CiAgICByZXR1cm4gKF9sc3Byb2Zfc3RhdGUgKilzdGF0ZTsKfQoKLyoqKiBFeHRlcm5hbCBUaW1lcnMgKioqLwoKc3RhdGljIFB5VGltZV90IENhbGxFeHRlcm5hbFRpbWVyKFByb2ZpbGVyT2JqZWN0ICpwT2JqKQp7CiAgICBQeU9iamVjdCAqbyA9IE5VTEw7CgogICAgLy8gRXh0ZXJuYWwgdGltZXIgY2FuIGRvIGFyYml0cmFyeSB0aGluZ3Mgc28gd2UgbmVlZCBhIGZsYWcgdG8gcHJldmVudAogICAgLy8gaG9ycmlibGUgdGhpbmdzIHRvIGhhcHBlbgogICAgcE9iai0+ZmxhZ3MgfD0gUE9GX0VYVF9USU1FUjsKICAgIG8gPSBfUHlPYmplY3RfQ2FsbE5vQXJncyhwT2JqczsKCgl0cyA9ICooVGhyZWFkU3RhcnQqKXY7CglmcmVlKHYpOwoKCWNyb3NzY2FsbDEodHMuZm4sIHNldGdfZ2NjLCAodm9pZCopdHMuZyk7CglyZXR1cm4gbmlsOwp9Ci8qCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfXyAgX18gICAgICAgICAgICBfCiAgICAgICAgICAgICAgICAgICAgICAgICBfX19cIFwvIC9fIF9fICAgX18gX3wgfF8KICAgICAgICAgICAgICAgICAgICAgICAgLyBfIFxcICAvfCAnXyBcIC8gX2AgfCBfX3wKICAgICAgICAgICAgICAgICAgICAgICB8ICBfXy8vICBcfCB8XykgfCAoX3wgfCB8XwogICAgICAgICAgICAgICAgICAgICAgICBcX19fL18vXF9cIC5fXy8gXF9fLF98XF9ffAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8X3wgWE1MIHBhcnNlcgoKICAgQ29weXJpZ2h0IChjKSAxOTk3LTIwMDAgVGhhaSBPcGVuIFNvdXJjZSBTb2Z0d2FyZSBDZW50ZXIgTHRkCiAgIENpbG1hdGNoKHN0ciwgbGVuLCAiZW5kc3dpdGgiLCBzdWJvYmosIHN0YXJ0LCBlbmQsICsxKTsKfQoKUHlEb2NfU1RSVkFSX3NoYXJlZChfUHlfaXNhc2NpaV9fZG9jX18sCiJCLmlzYXNjaWkoKSAtPiBib29sXG5cClxuXApSZXR1cm4gVHJ1ZSBpZiBCIGlzIGVtcHR5IG9yIGFsbCBjaGFyYWN0ZXJzIGluIEIgYXJlIEFTQ0lJLFxuXApGYWxzZSBvdGhlcndpc2UuIik7CgpQeU9iamVjdCoKX1B5X2J5dGVzX2lzYXNjaWkoY29uc3QgY2hhciAqY3B0ciwgUHlfc3NpemVfdCBsZW4pCnsKICAgIGNvbnN0IGNoYXIgKnAgPSBjcHRyOwogICAgY29uc3QgY2hhciAqZW5kID0gcCArIGxlbjsKICAgIFB5X3NzaXplX3QgbWF4X2NoYXIgPSBzdHJpbmdsaWJfZmluZF9tYXhfY2hhcihjcHRyLCBlbmQpOwogICAgaWYgKG1heF9jaGFyID4gMTI3KSB7CiAgICAgICAgUHlfUkVUVVJOX0ZBTFNFOwogICAgfQogICAgUHlfUkVUVVJOX1RSVUUgUHlfVmVyYm9zZUZsYWcgPSAxOwogICAgUHlfUXVpZXRGbGFnID0gMTsKICAgIFB5X0Zyb3plbkZsYWcgPSAwOwogICAgUHlfVW5idWZmZXJlZFN0ZGlvRmxhZyA9IDE7CiAgICBQeV9Ob1NpdGVGbGFnID0gMTsKICAgIFB5X0RvbnRXcml0ZUJ5dGVjb2RlRmxhZyA9IDE7CiAgICBQeV9Ob1VzZXJTaXRlRGlyZWN0b3J5ID0gMTsKI2lmZGVmIE1TX1dJTkRPV1MKICAgIFB5X0xlZ2FjeVdpbmRvd3NTdGRpb0ZsYWcgPSAxOwojZW5kaWYKfQoKCnN0YXRpYyBpbnQgY2hlY2tfcHJlaW5pdF9pc29sYXRlZF9jb25maWcoaW50IHByZWluaXQpCnsKICAgIFB5U3RhdHVzIHN0YXR1czsKICAgIFB5UHJlQ29uZmlnICpydF9wcmVjb25maWc7CgogICAgLyogZW52aXJvbm1lbnQgdmFyaWFibGVzIG11c3QgYmUgaWdub3JlZCAqLwogICAgc2V0X2FsbF9lbnZfdmFycygpOwoKICAgIC8qIGdsb2JhbCBjb25maWd1cmF0aW9uIHZhcmljYXRvciA9IFBZTUVNX0FMTE9DQVRPUl9NSU1BTExPQzsKI2VuZGlmCgogICAgcHV0ZW52KCJQWVRIT05VVEY4PTAiKTsKICAgIFB5X1VURjhNb2RlID0gMDsKICAgIHByZWNvbmZpZy51dGY4X21vZGUgPSAxOwoKICAgIFB5U3RhdHVzIHN0YXR1cyA9IFB5X1ByZUluaXRpYWxpemUoJnByZWNvbmZpZyk7CiAgICBpZiAoUHlTdGF0dXNfRXhjZXB0aW9uKHN0YXR1cykpIHsKICAgICAgICBQeV9FeGl0U3RhdHVzRXhjZXB0aW9uKHN0YXR1cyk7CiAgICB9CgogICAgUHlDb25maWcgY29uZmlnOwogICAgX1B5Q29uZmlnX0luaXRDb21wYXRDb25maWcoJmNvbmZpZyk7CgogICAgY29uZmlnLmluc3RhbGxfc2lnbmFsX2hhbmRsZXJzID0gMDsKCiAgICAvKiBGSVhNRTogdGVzdCB1c2VfZW52aXJvbm1lbnQgKi8KCiAgICBwdXRlbnYoIlBZVEhPTkhBU0hTRUVEPTQyIik7CiAgICBjb25maWcudXNlX2hhc2hfc2VlZCA9IDE7YW5kIHByZWNpc2lvbiBtYXkgYmUgZ3JlYXRlciB0aGFuIHRob3NlIG9mCiAgIGBkb3VibGVgIChzZWUgZm9yIGV4YW1wbGUgQzk5IMKnNS4yLjQuMi4yLCBwYXJhZ3JhcGggOCkuIFRoaXMgY2FuIGhhcHBlbiBmb3IKICAgZXhhbXBsZSBvbiBtYWNoaW5lcyB1c2luZyB0aGUgbm93IGxhcmdlbHkgaGlzdG9yaWNhbCB4ODcgRlBVcy4gSW4gdGhpcyBjYXNlLAogICBgZnN1bWAgY2FuIHByb2R1Y2UgaW5jb3JyZWN0IHJlc3VsdHMuIElmIGBGTFRfRVZBTF9NRVRIT0RgIGlzIGAwYCBvciBgMWAsIG9yCiAgIGBGTFRfRVZBTF9NRVRIT0RgIGlzIGAyYCBhbmQgYGxvbmcgZG91YmxlYCBpcyBpZGVudGljYWwgdG8gYGRvdWJsZWAsIHRoZW4gd2UKICAgc2hvdWxkIGJlIHNhZmUgZnJvbSB0aGlzIHNvdXJjZSBvZiBlcnJvcnMuIFNlY29uZCwgYW4gYWdncmVzc2l2ZWx5CiAgIG9wdGltaXppbmcgY29tcGlsZXIgY2FuIHJlLWFzc29jNiAqIDE2OwogICAgYXNzZXJ0KG1lbV9zaXplICUgc3lzY29uZihfU0NfUEFHRVNJWkUpID09IDApOwogICAgY2hhciAqbWVtb3J5ID0KICAgICAgICBtbWFwKE5VTEwsICAvLyBhZGRyZXNzCiAgICAgICAgICAgICBtZW1fc2l6ZSwgUFJPVF9SRUFEIHwgUFJPVF9XUklURSwgTUFQX1BSSVZBVEUgfCBNQVBfQU5PTllNT1VTLAogICAgICAgICAgICAgLTEsICAvLyBmZCAobm90IHVzZWQgaGVyZSkKICAgICAgICAgICAgIDApOyAgLy8gb2Zmc2V0IChub3QgdXNlZCBoZXJlKQogICAgaWYgKG1lbW9yeSA9PSBNQVBfRkFJTEVEKSB7CiAgICAgICAgUHlFcnJfU2V0RnJvbUVycm5vKFB5RXhjX09TRXJyb3IpOwogICAgICAgIFB5RXJyX0Zvcm1hdFVucmFpc2FibGUoIkZhaWxlZCB0byBjcmVhdGUgbmV3IG1tYXAgZm9yIHBlcmYgdHJhbXBvbGluZSIpOwogICAgICAgIHBlcmZfc3RhdHVzID0gUEVSRl9TVEFUVVNfRkFJTEVEOwogdGhlIGFzc2VtYmx5IHN0YWdlLgogICAgICAgICAqLwogICAgICAgIHN0bXRfdHkgc3QgPSAoc3RtdF90eSlhc2RsX3NlcV9HRVQoc3RtdHMsIDApOwogICAgICAgIHJldHVybiBTUkNfTE9DQVRJT05fRlJPTV9BU1Qoc3QpOwogICAgfQogICAgcmV0dXJuIChjb25zdCBfUHlfU291cmNlTG9jYXRpb24pezEsIDEsIDAsIDB9Owp9CgpzdGF0aWMgaW50CmNvbXBpbGVyX2NvZGVnZW4oY29tcGlsZXIgKmMsIG1vZF90eSBtb2QpCnsKICAgIFJFVFVSTl9JRl9FUlJPUihfUHlDb2RlZ2VuX0VudGVyQW5vbnltb3VzU2NvcGUoYywgbW9kKSk7CiAgICBhc3NlcnQoYy0+dS0+dV9zY29wZV90eXBlID09IENPTVBJTEVfU0NPUEVfTU9EVUxFKTsKICAgIHN3aXRjaCAobW9kLT5raW5kKSB7CiAgICBjYXNlIE1vZHVsZV9raW5kOiB7CiAgICAgICAgYXNkbF9zdG10X3NlcSAqc3RtdHMgPSBtb2QtPnYuTW9kdWxlLmJvZHk7CiAgICwgKmNhcHN1bGU7CgogICAgICAgIGNhcHN1bGUgPSBQeUxpc3RfR0VUX0lURU0oYy0+Y19zdGFjaywgc3RhY2tfc2l6ZSAtIDEpOwogICAgICAgIHBhcmVudCA9IChzdHJ1Y3QgY29tcGlsZXJfdW5pdCAqKVB5Q2Fwc3VsZV9HZXRQb2ludGVyKGNhcHN1bGUsIENBUFNVTEVfTkFNRSk7CiAgICAgICAgYXNzZXJ0KHBhcmVudCk7CiAgICAgICAgaWYgKHBhcmVudC0+dV9zY29wZV90eXBlID09IENPTVBJTEVfU0NPUEVfQU5OT1RBVElPTlMpIHsKICAgICAgICAgICAgLyogVGhlIHBhcmVudCBpcyBhbiBhbm5vdGF0aW9uIHNjb3BlLCBzbyB3ZSBuZWVkIHRvCiAgICAgICAgICAgICAgIGxvb2sgYXQgdGhlIGdyYW5kcGFyZW50LiAqLwogICAgICAgICAgICBpZiAoc3RhY2tfc2l6ZSA9PSAyKSB7CiAgICAgICAgICAgICAgICAvLyBJZiB3ZSdyZSBpbW1lZGlhdGVseSB3aXRoaW4gdGhlIG1vZHVsZSwgd2UgY2FuIHNraXAKICAgIExBSU0sCiAgIERBTUFHRVMgT1IgIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiAgSU4gQU4gIEFDVElPTiBPRiBDT05UUkFDVCwgIFRPUlQgT1IKICAgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogICBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoqLwoKZW51bSB7CiAgQlRfTk9OWE1MLCAgIC8qIGUuZy4gbm9uY2hhcmFjdGVyLUZGRkYgKi8KICBCVF9NQUxGT1JNLCAgLyogaWxsZWdhbCwgd2l0aCByZWdhcmQgdG8gZW5jb2RpbmcgKi8KICBCVF9MVCwgICAgICAgLyogbGVzcyB0aGFuID0gIjwiICovCiAgQlRfQU1QLCAgICAgIC8qIGFtcGVyc2FuZCA9ICImIiAqLwogIEJUX1JTUUIsICAgICAvKiByaWdodCBzcXVhcmUgYnJhY2tldCA9ICJbIiAqLwogIEJUX0xFQUQyLCAgICAvKiBsZWFkIGJ5dGUgb2YgYSAyLWtleSl7IC5mc3QgPSAmcDAsIC5zbmQgPSBrIH0pKTsKfQoKLyoqCiBTcGVjaWFsaXplZC1wdXJwb3NlIHJlLWluaXRpYWxpemF0aW9uIGZ1bmN0aW9uIHdpdGggbm8gcGFyYW1ldGVycwphbmQgbm8ga2V5LiBUaGlzIGlzIHdoYXQgeW91IHdhbnQgaWYgeW91IGludGVuZCB0byB1c2UgQmxha2UyIGFzIGEgaGFzaApmdW5jdGlvbi4gVGhlIGtleSBsZW5ndGggYW5kIGRpZ2VzdCBsZW5ndGggbXVzdCBoYXZlIGJlZW4gc2V0IHRvIHRoZWlyCnJlc3BlY3RpdmUgZGVmYXVsdCB2YWx1ZXMgdmlhIHlvdXIgY2hvaWNlIG9mIG1hbGxvYyBmdW5jdGlvbiAoYWx3YXlzIHRydWUgaWYgeW91CnVzZWQgYG1hbGxvY2ApLiBBbGwgb3RoZXIgcGFyYW1ldGVycyBhcmUgcmVzZXQgdG8gdGhlaXIgZGVmYXVsdCB2YWx1ZXMuIFRoZQpiZWhhdmlvciBpcyB1bnNwZWNpZmllZCBpZiB5b3UgdmlvbGF0ZSB0aGlzIHByZWNvbmRpdGlvbi4KKi8KdmUgPD0gUFRSRElGRl9NQVgpOwogIG1pX2Fzc2VydF9pbnRlcm5hbChhbGlnbm1lbnQgIT0gMCAmJiBfbWlfaXNfcG93ZXJfb2ZfdHdvKGFsaWdubWVudCkpOwoKICBjb25zdCB1aW50cHRyX3QgYWxpZ25fbWFzayA9IGFsaWdubWVudCAtIDE7ICAvLyBmb3IgYW55IHgsIGAoeCAmIGFsaWduX21hc2spID09ICh4ICUgYWxpZ25tZW50KWAKICBjb25zdCBzaXplX3QgcGFkc2l6ZSA9IHNpemUgKyBNSV9QQURESU5HX1NJWkU7CgogIC8vIHVzZSByZWd1bGFyIGFsbG9jYXRpb24gaWYgaXQgaXMgZ3VhcmFudGVlZCB0byBmaXQgdGhlIGFsaWdubWVudCBjb25zdHJhaW50cwogIGlmIChvZmZzZXQ9PTAgJiYgYWxpZ25tZW50PD1wYWRzaXplICYmIHBhZHNpemU8PU1JX01BWF9BTElHTl9HVUFSQU5URUUgJiYgKHBhZHNpemUmYWxpZ25fbWFzayk9PTApIHsKICAgIHZvaWQqIHAgPSBfbWlfaGVhcF9tYWxsb2NfemVybyhoZWFwLCBzaXJ0ICopOwogICAgICAgIFB5X3NzaXplX3QgYnl0ZXMgPSBQeUxvbmdfQXNOYXRpdmVCeXRlcyhhcmcsIHAsIHNpemVvZih1bnNpZ25lZCBzaG9ydCksCiAgICAgICAgICAgICAgICBQeV9BU05BVElWRUJZVEVTX05BVElWRV9FTkRJQU4gfAogICAgICAgICAgICAgICAgUHlfQVNOQVRJVkVCWVRFU19BTExPV19JTkRFWCB8CiAgICAgICAgICAgICAgICBQeV9BU05BVElWRUJZVEVTX1VOU0lHTkVEX0JVRkZFUik7CiAgICAgICAgaWYgKGJ5dGVzIDwgMCkgewogICAgICAgICAgICBSRVRVUk5fRVJSX09DQ1VSUkVEOwogICAgICAgIH0KICAgICAgICBpZiAoKHNpemVfdClieXRlcyA+IHNpemVvZih1bnNpZ25lZCBzaG9ydCkpIHsKICAgICAgICAgICAgaWYgKFB5RXJyX1dhcm5FeChQeUV4Y19EZXByZWNhdGlvbldhcm5pbmcsCiAgICAgICAgICAgICAgICAiaW50ZWdlciB2YWx1ZSBvdXQgb2YgcmFuZ2UiLCAxKSA8IDApCiAgIGRpbmcgb24gd2hldGhlciBNRVRIX0tFWVdPUkRTIGlzIHByZXNlbnQgb3Igbm90LgogKgogKiBBQyBkZXRlcm1pbmVzIHdoZXRoZXIgYSBtZXRob2QgaXMgYSBfX25ld19fLWxpa2UgbWV0aG9kIHNvbGVseSBic2FlZAogKiBvbiB0aGUgbWV0aG9kIG5hbWUsIGFuZCBub3Qgb24gaXRzIHVzYWdlIG9yIGl0cyBjX2Jhc2VuYW1lLCBhbmQgdGhvc2UKICogbWV0aG9kcyBtdXN0IGFsd2F5cyBiZSB1c2VkIHdpdGggTUVUSF9WQVJBUkdTfE1FVEhfS0VZV09SRFN8TUVUSF9DTEFTUy4KICoKICogSW4gcGFydGljdWxhciwgdXNpbmcgWzFdIGZvcmNlcyB1cyB0byBhZGQgTUVUSF9LRVlXT1JEUyBldmVuIHRob3VnaAogKiB0aGUgdGVzdCBzaG91bGRuJ3QgYmUgZXhwZWN0aW5nIGtleXdvcmQgYXJndW1lbnRzLiBVc2luZyBbMl0gaXMgYWxzbwogKiBub3QgcG9zc2libGUgc2luY2Ugd2Ugd2FudCB0byB0ZXN0IG5vbi1mYXN0Y2FsbGVzc190aW1lX25zX2RvYywKInByb2Nlc3NfdGltZSgpIC0+IGludFxuXApcblwKUHJvY2VzcyB0aW1lIGZvciBwcm9maWxpbmcgYXMgbmFub3NlY29uZHM6XG5cCnN1bSBvZiB0aGUga2VybmVsIGFuZCB1c2VyLXNwYWNlIENQVSB0aW1lLiIpOwoKCiNpZiBkZWZpbmVkKE1TX1dJTkRPV1MpCiNkZWZpbmUgSEFWRV9USFJFQURfVElNRQpzdGF0aWMgaW50Cl9QeVRpbWVfR2V0VGhyZWFkVGltZVdpdGhJbmZvKFB5VGltZV90ICp0cCwgX1B5X2Nsb2NrX2luZm9fdCAqaW5mbykKewogICAgSEFORExFIHRocmVhZDsKICAgIEZJTEVUSU1FIGNyZWF0aW9uX3RpbWUsIGV4aXRfdGltZSwga2VybmVsX3RpbWUsIHVzZXJfdGltZTsKICAgIFVMQVJHRV9JTlRFR0VSIGxhcmdlOwogICAgUHlUaW1lX3Qga3RpbWUsIHV0aW1lOwogICAgQk9PTCBvazsKCiAgICB0aHJlYWQgPSAgR2V0Q3VycmVudFRocmVhZCgpOwogICAgb2sgPSBHZXRUaHRfU2V0QXR0cihzZWxmLCAmX1B5X0lEKF9fYWJzdHJhY3RtZXRob2RzX18pLCBhYnN0cmFjdHMpIDwgMCkgewogICAgICAgIGdvdG8gZXJyb3I7CiAgICB9CgogICAgcmV0ID0gMDsKZXJyb3I6CiAgICBQeV9ERUNSRUYoYWJzdHJhY3RzKTsKICAgIFB5X1hERUNSRUYobnMpOwogICAgUHlfWERFQ1JFRihpdGVtcyk7CiAgICBQeV9YREVDUkVGKGJhc2VzKTsKICAgIHJldHVybiByZXQ7Cn0KCiNkZWZpbmUgQ09MTEVDVElPTl9GTEFHUyAoUHlfVFBGTEFHU19TRVFVRU5DRSB8IFB5X1RQRkxBR1NfTUFQUElORykKCi8qW2NsaW5pYyBpbnB1dF0KQHBlcm1pdF9sb25nX3N1bW1hcnkKX2FiYy5fYWJjX2luaXQKCiAgICBzZWxmOiBvYmplY3QKICAgIC8KCkludGVybmFsIEFCQyBoZWxwZXIgZm9yIGNsYXNzIHNldC11cC4gU2hvdWxkIGJlIG5ldmVyIHVzZWQgb3V0c2lkZSBhYmMgbW9kdWxlLgpbfQoKLyoKICogQml0IHNjYW4gZm9yd2FyZC4gQXNzdW1wdGlvbnM6IGEgIT0gMC4KICovCnN0YXRpYyBpbmxpbmUgaW50IF9fY2RlY2wKbXBkX2JzZihtcGRfc2l6ZV90IGEpCnsKICAgIHVuc2lnbmVkIGxvbmcgcmV0dmFsOwoKI2lmZGVmIENPTkZJR182NAogICAgX0JpdFNjYW5Gb3J3YXJkNjQoJnJldHZhbCwgYSk7CiNlbHNlCiAgICBfQml0U2NhbkZvcndhcmQoJnJldHZhbCwgYSk7CiNlbmRpZgoKICAgIHJldHVybiAoaW50KXJldHZhbDsKfQovKiBFTkQgTUFTTSAoX01TQ19WRVIpICovCiNlbHNlCiAgI2Vycm9yICJtaXNzaW5nIHByZXByb2Nlc3NvciBkZWZpbml0aW9ucyIKI2VuZGlmIC8qIEJTUi9CU0YgKi8KCgojZW5kaWYgLyogTElCTVBERUNfQklUU19IXyAqLwovLyBjbGluaWMvZmxvYXQuYy5oIHVzZXMgaW50ZXJuYWwgcHljb3JlX21vZHN1cHBvcnQuaCBBUEkKI2RlZmluZSBQWVRFU1RDQVBJX05FRURfSU5UZGF0YSBhcyBieXRlcy4KCklmICptYXhfbGVuZ3RoKiBpcyBub25uZWdhdGl2ZSwgcmV0dXJucyBhdCBtb3N0ICptYXhfbGVuZ3RoKiBieXRlcyBvZgpkZWNvbXByZXNzZWQgZGF0YS4gSWYgdGhpcyBsaW1pdCBpcyByZWFjaGVkIGFuZCBmdXJ0aGVyIG91dHB1dCBjYW4gYmUKcHJvZHVjZWQsICpzZWxmLm5lZWRzX2lucHV0KiB3aWxsIGJlIHNldCB0byBgYEZhbHNlYGAuIEluIHRoaXMgY2FzZSwgdGhlIG5leHQKY2FsbCB0byAqZGVjb21wcmVzcygpKiBtYXkgcHJvdmlkZSAqZGF0YSogYXMgYicnIHRvIG9idGFpbiBtb3JlIG9mIHRoZSBvdXRwdXQuCgpJZiBhbGwgb2YgdGhlIGlucHV0IGRhdGEgd2FzIGRlY29tcHJlc3NlZCBhbmQgcmV0dXJuZWQgKGVpdGhlciBiZWNhdXNlIHRoaXMKd2FzIGxlc3MgdGhhbiAqbWF4X2xlbmd0aCogYnl0ZXMsIG9yIGJlY2F1c2UgKm1heF9sZW5ndGgqIHdhcyBuZWdhdGl2ZSksCipzZWxmVF9GSUxURVIgdG8gZGV0ZWN0IGEgZGVjZW50IFNESy4KICovCiMgaWZkZWYgU0lPX0dFVF9NVUxUSUNBU1RfRklMVEVSCiMgIGluY2x1ZGUgPG1zdGNwaXAuaD4gLyogZm9yIFNJT19SQ1ZBTEwgKi8KIyAgZGVmaW5lIEhBVkVfQUREUklORk8KIyAgZGVmaW5lIEhBVkVfU09DS0FERFJfU1RPUkFHRQojICBkZWZpbmUgSEFWRV9HRVRBRERSSU5GTwojICBkZWZpbmUgSEFWRV9HRVROQU1FSU5GTwojICBkZWZpbmUgRU5BQkxFX0lQVjYKIyBlbHNlCnR5cGVkZWYgaW50IHNvY2tsZW5fdDsKIyBlbmRpZiAvKiBJUFBST1RPX0lQVjYgKi8KCi8qIFJlbW92ZSBpZmRlZiBvbmNlIFB5X1dJTlZFUiA+PSAweDA2MDQKICogc29ja2V0Lmggb25seSBkZWZpbmVzIEFGX0hZUEVSViBpZiBfV0lOMzJfV0lOTlQgaXMgYXQgdGhhdCBsZXZlbCBvciBoaWdoZXIKICogc28gZm9yIG5vdyBpdCdzIGp1c3QgbWFudWFsbHkgZGVmaW5lZC4KICovdCB0byBiZQovLyBkZWFsbG9jYXRlZCBwcm9tcHRseSB3aGVuIHRoZSBvYmplY3QncyByZWZjb3VudCByZWFjaGVzIHplcm8uCi8vCi8vIEVhY2ggZW50cnkgaW1wbGljaXRseSByZXByZXNlbnRzIGEgdW5pcXVlIGlkIGJhc2VkIG9uIGl0cyBvZmZzZXQgaW4gdGhlCi8vIHRhYmxlLiBOb24tYWxsb2NhdGVkIGVudHJpZXMgZm9ybSBhIGZyZWUtbGlzdCB2aWEgdGhlICduZXh0JyBwb2ludGVyLgovLyBBbGxvY2F0ZWQgZW50cmllcyBzdG9yZSB0aGUgY29ycmVzcG9uZGluZyBQeU9iamVjdC4KCiNkZWZpbmUgX1B5X0lOVkFMSURfVU5JUVVFX0lEIDAKCi8vIEFzc2lnbnMgdGhlIG5leHQgaWQgZnJvbSB0aGUgcG9vbCBvZiBpZHMuCmV4dGVybiBQeV9zc2l6ZV90IF9QeU9iamVjdF9Bc3NpZ25VbmlxdWVJZChQeU9iamVjdCAqb2JqKTsKCi8vIFJlbGVhc2VzIHRoZSBhbGxvY2F0ZWQgaWQgYmFjayB0byB0aGUgcG9vbC4KZXh0bGxlZEVycm9yIHRvIGJlIHRocm93biBpbnRvIHRoZVxuIgoid3JhcHBlZCBjb3JvdXRpbmUgb24gdGhlIG5leHQgY3ljbGUgdGhyb3VnaCB0aGUgZXZlbnQgbG9vcC5cbiIKIlRoZSBjb3JvdXRpbmUgdGhlbiBoYXMgYSBjaGFuY2UgdG8gY2xlYW4gdXAgb3IgZXZlbiBkZW55XG4iCiJ0aGUgcmVxdWVzdCB1c2luZyB0cnkvZXhjZXB0L2ZpbmFsbHkuXG4iCiJcbiIKIlVubGlrZSBGdXR1cmUuY2FuY2VsLCB0aGlzIGRvZXMgbm90IGd1YXJhbnRlZSB0aGF0IHRoZVxuIgoidGFzayB3aWxsIGJlIGNhbmNlbGxlZDogdGhlIGV4Y2VwdGlvbiBtaWdodCBiZSBjYXVnaHQgYW5kXG4iCiJhY3RlZCB1cG9uLCBkZWxheWluZyBjYW5jZWxsYXRpb24gb2YgdGhlIHRhc2sgb3IgcHJldmVudGluZ1xuIgoiY2FuY2VsbGF0aW9uIGNvbXBsZXRlbHkuICBUaGUgdGFzayBtYXkgYWxzbyByZXR1cm4gYSB2YWx1ZSBvclxuIgoicmFpc2UgYSBkdCAqcHlyZXN1bHQ7CiAgICBpbnQgaTsKCiAgICAvKiBOb3RlOiAgVGhpcyB0ZXN0IGxldHMgUHlPYmplY3RzIGxlYWsgaWYgYW4gZXJyb3IgaXMgcmFpc2VkLiAgU2luY2UKICAgICAgIGFuIGVycm9yIHNob3VsZCBuZXZlciBiZSByYWlzZWQsIGxlYWtzIGFyZSBpbXBvc3NpYmxlIDx3aW5rPi4gKi8KCiAgICAvKiBUZXN0IG5hdGl2ZSAtPiBQeUxvbmcgLT4gbmF0aXZlIHJvdW5kdHJpcCBpZGVudGl0eS4KICAgICAqIEdlbmVyYXRlIGFsbCBwb3dlcnMgb2YgMiwgYW5kIHRlc3QgdGhlbSBhbmQgdGhlaXIgbmVnYXRpb25zLAogICAgICogcGx1cyB0aGUgbnVtYmVycyArLTEgb2ZmIGZyb20gdGhlbS4KICAgICAqLwogICAgYmFzZSA9IDE7CiAgICBmb3IgKGkgPSAwOwogICAgICAgICBpIDwgTkJJVFMgKyAxOyAgLyogb24gbGFzdCwgYmFzZSBvdmVyZmxvd3MgdG8gMCAqLwogICAgICAgICArK2ksIGJhc2UgPDw9IDEpCiAgcnNpdmUgc3RydWN0dXJlKVxuIgoiXG4iCiJSYWlzZXM6XG4iCiIgICAgUnVudGltZUVycm9yOiBJZiBBc3luY2lvRGVidWcgc2VjdGlvbiBpcyBub3QgYXZhaWxhYmxlIGluIHRoZSB0YXJnZXQgcHJvY2Vzc1xuIgoiICAgIE1lbW9yeUVycm9yOiBJZiBtZW1vcnkgYWxsb2NhdGlvbiBmYWlsc1xuIgoiICAgIE9TRXJyb3I6IElmIHJlYWRpbmcgZnJvbSB0aGUgcmVtb3RlIHByb2Nlc3MgZmFpbHNcbiIKIlxuIgoiRXhhbXBsZSBvdXRwdXQgKHNpbWlsYXIgc3RydWN0dXJlIHRvIGdldF9hbGxfYXdhaXRlZF9ieSBidXQgb25seSBmb3IgcnVubmluZyB0YXNrcyk6XG4iCiJbXG4iCiIgICAgKDE0MDIzNCwgW1xuIgoiICAgICAgICAoNDM0NTU4NTcxMiwgXCdtYWluX3Rhc2tcJyxcbiIKIiAgICAgICAgIFsoXCJydW5fc2VydmVyXCIsIFwic2VydmVyLnB5XCIsIDEyNyksIChcIm1haW5cIiwgXCJhcHAucHlcIiwgMjMpXSxcbiIKaSwgbG8pOwoKICAgIF9tcGRfbXVsX3dvcmRzKCZoaSwgJmxvLCB1WzFdLCB2WzFdKTsKICAgIGxvID0gd1syXSArIGxvOwogICAgaWYgKGxvIDwgd1syXSkgaGkrKzsKICAgIGxvID0gd1szXSArIGxvOwogICAgaWYgKGxvIDwgd1szXSkgaGkrKzsKICAgIF9tcGRfZGl2X3dvcmRzX3IoJndbM10sICZ3WzJdLCBoaSwgbG8pOwp9CgoKLyoKICogVGVzdCBpZiBhbGwgd29yZHMgZnJvbSBkYXRhW2xlbi0xXSB0byBkYXRhWzBdIGFyZSB6ZXJvLiBJZiBsZW4gaXMgMCwgbm90aGluZwogKiBpcyB0ZXN0ZWQgYW5kIHRoZSBjb2VmZmljaWVudCBpcyByZWdhcmRlZCBhcyAiYWxsIHplcm8iLgogKi8Kc3RhdGljIGlubGluZSBpbnQKX21wZF9pc2FsbHplcm8oY29uc3QgbXBkX3VpbnRfdCAqZGF0YSwgbXBkX3NzaXplX3QgbGVuKQp7CiAgICB3aGlsZSAoLS1sZW4gPj0gMCkgewogICAgICAgIGlmIChkYXRhW2xlbl0gIT0gMCkgcmV0YVtpbmRleF0gPj4gODsKCiAgICAvKiBYWFg6IGNvdWxkIGFsbG9jYXRlIHRoZSBQeVN0cmluZyB1cCBmcm9udCBpbnN0ZWFkCiAgICAgICAoc3RybGVuKHByZWZpeCkgKyA1ICogY291bnQgKyAxIGJ5dGVzKSAqLwoKICAgIC8qIEJhc2VkIG9uIGhvdyBpbmRleCBpcyBjYWxjdWxhdGVkIGFib3ZlIGFuZCBkZWNvbXBfZGF0YSBpcyBnZW5lcmF0ZWQKICAgICAgIGZyb20gVG9vbHMvdW5pY29kZS9tYWtldW5pY29kZWRhdGEucHksIGl0IHNob3VsZCBub3QgYmUgcG9zc2libGUKICAgICAgIHRvIG92ZXJmbG93IGRlY29tcF9wcmVmaXguICovCiAgICBwcmVmaXhfaW5kZXggPSBkZWNvbXBfZGF0YVtpbmRleF0gJiAyNTU7CiAgICBhc3NlcnQocHJlZml4X2luZGV4IDwgUHlfQVJSQVlfTEVOR1RIKGRlY29tcF9wcmVmaXgpKTsKCiAgICAvKiBjb3B5IHByZWZpeCAqLwogICAgaSA9IHN0cmxlbihkZWNvbXBfcHJlZml4W3ByZWZpKm9wKTsKCgpleHRlcm4gdm9pZCBfUHlGbG9hdF9EZWJ1Z01hbGxvY1N0YXRzKEZJTEUqIG91dCk7CgoKLyogRm9ybWF0IHRoZSBvYmplY3QgYmFzZWQgb24gdGhlIGZvcm1hdF9zcGVjLCBhcyBkZWZpbmVkIGluIFBFUCAzMTAxCiAgIChBZHZhbmNlZCBTdHJpbmcgRm9ybWF0dGluZykuICovCmV4dGVybiBpbnQgX1B5RmxvYXRfRm9ybWF0QWR2YW5jZWRXcml0ZXIoCiAgICBfUHlVbmljb2RlV3JpdGVyICp3cml0ZXIsCiAgICBQeU9iamVjdCAqb2JqLAogICAgUHlPYmplY3QgKmZvcm1hdF9zcGVjLAogICAgUHlfc3NpemVfdCBzdGFydCwKICAgIFB5X3NzaXplX3QgZW5kKTsKCmV4dGVybiBQeU9iamVjdCogX1B5X3N0cmluZ190b19udW1iZXJfd2l0aF91bmRlcnNjb3JlcygKICAgIGNvbnN0IGNoYXIgKnN0ciwgUHlfc3NpemVfdCBsZW4sIGNvbnN0IGNoYXIgKndoYXQsIFB5T2JqZWN0ICpvYmosIHZvaWQgKmFyZywKICAgIGZzdGF0KCkgY2FuIHJlcXVpcmUgaW5wdXQvb3V0cHV0IG9wZXJhdGlvbnMsCiAgIHdoZXJlYXMgZHVwKCkgZG9lc24ndC4gVGhlcmUgaXMgYSBsb3cgcmlzayBvZiBFTUZJTEUvRU5GSUxFIGF0IFB5dGhvbgogICBzdGFydHVwLiBQcm9ibGVtOiBkdXAoKSBkb2Vzbid0IGNoZWNrIGlmIHRoZSBmaWxlIGRlc2NyaXB0b3IgaXMgdmFsaWQgb24KICAgc29tZSBwbGF0Zm9ybXMuCgogICBmY250bChmZCwgRl9HRVRGRCkgaXMgZXZlbiBmYXN0ZXIsIGJlY2F1c2UgaXQgb25seSBjaGVja3MgdGhlIHByb2Nlc3MgdGFibGUuCiAgIEl0IGlzIHByZWZlcnJlZCBvdmVyIGR1cCgpIHdoZW4gYXZhaWxhYmxlLCBzaW5jZSBpdCBjYW5ub3QgZmFpbCB3aXRoIHRoZQogICAidG9vIG1hbnkgb3BlbiBmaWxlcyIgZXJyb3IgKEVNRklMRSkuCgogICBicG8tMzAyMjU6IE9uIG1hY09TIFRpZ2VyLCB3aGVuIHN0ZG91dCBpcyByZWRpcmVjdGVkZSBQWV9MSVRUTEVfRU5ESUFOIDEKI2VuZGlmCgojaWZkZWYgX19BTkRST0lEX18KICAgLyogVGhlIEFuZHJvaWQgbGFuZ2luZm8uaCBoZWFkZXIgaXMgbm90IHVzZWQuICovCiMgIHVuZGVmIEhBVkVfTEFOR0lORk9fSAojICB1bmRlZiBDT0RFU0VUCiNlbmRpZgoKLyogTWF4aW11bSB2YWx1ZSBvZiB0aGUgV2luZG93cyBEV09SRCB0eXBlICovCiNkZWZpbmUgUFlfRFdPUkRfTUFYIDQyOTQ5NjcyOTVVCgovKiBUaGlzIG1hY3JvIHVzZWQgdG8gdGVsbCB3aGV0aGVyIFB5dGhvbiB3YXMgYnVpbHQgd2l0aCBtdWx0aXRocmVhZGluZwogKiBlbmFibGVkLiAgTm93IG11bHRpdGhyZWFkaW5nIGlzIGFsd2F5cyBlbmFibGVkLCBidXQga2VlcCB0aGUgbWFjcm8KICogZm9yIGNvbXBhdGliaWxpdHkuCiAqLwojaWZuZGVmIFdJVEhfVEhSRUFECiMgIGRlZmluZSBXSVRIX1RIUkVBRAojZW5kaWYKCi8qIFNvbWUgV2ViQXNzZW1ibHkgdWRlICJsaWJjZ29fdW5peC5oIgoKc3RhdGljIHZvaWQgKnRocmVhZGVudHJ5KHZvaWQqKTsKCnZvaWQgKCp4X2Nnb19pbml0dGxzKSh2b2lkICoqdGxzZywgdm9pZCAqKnRsc2Jhc2UpOwpzdGF0aWMgdm9pZCAoKnNldGdfZ2NjKSh2b2lkKik7Cgp2b2lkCnhfY2dvX2luaXQoRyAqZywgdm9pZCAoKnNldGcpKHZvaWQqKSwgdm9pZCAqKnRsc2Jhc2UpCnsKCXNldGdfZ2NjID0gc2V0ZzsKCV9jZ29fc2V0X3N0YWNrbG8oZywgTlVMTCk7Cn0KCnZvaWQKX2Nnb19zeXNfdGhyZWFkX3N0YXJ0KFRocmVhZFN0YXJ0ICp0cykKewoJcHRocmVhZF9hdHRyX3QgYXR0cjsKCXNpZ3NldF90IGlnbiwgb3NldDsKCXB0aHJlYWRfdCBwOwoJc2l6ZV90IHNpemU7CglpbnQgZXJyOwoKCXNpZ2ZpbGxzZXQoJmlnbik7CglwdGhyZWFkX3NpZ21hc2soU0lHX1NFVE1BU0ssICZpZ24sICZvc2V0KTsKCglwdGhyZWFkX2F0dHJfaW5pdCgmYXR0cik7IDB4MDAxMAojZGVmaW5lIE1FVEhfU1RBVElDICAgMHgwMDIwCgovKiBNRVRIX0NPRVhJU1QgYWxsb3dzIGEgbWV0aG9kIHRvIGJlIGVudGVyZWQgZXZlbiB0aG91Z2ggYSBzbG90IGhhcwogICBhbHJlYWR5IGZpbGxlZCB0aGUgZW50cnkuICBXaGVuIGRlZmluZWQsIHRoZSBmbGFnIGFsbG93cyBhIHNlcGFyYXRlCiAgIG1ldGhvZCwgIl9fY29udGFpbnNfXyIgZm9yIGV4YW1wbGUsIHRvIGNvZXhpc3Qgd2l0aCBhIGRlZmluZWQKICAgc2xvdCBsaWtlIHNxX2NvbnRhaW5zLiAqLwoKI2RlZmluZSBNRVRIX0NPRVhJU1QgICAweDAwNDAKCiNpZiAhZGVmaW5lZChQeV9MSU1JVEVEX0FQSSkgfHwgUHlfTElNSVRFRF9BUEkrMCA+PSAweDAzMGEwMDAwCiMgIGRlZmluZSBNRVRIX0ZBU1RDQUxMICAweDAwODAKI2VuZGlmCgovKiBUaGlzIGJpdCBpcyBwcmVzZXJ2ZWQgZm9yIFN0YWNrbGVzcyBQeXRob24gKi8KI2lmZGVmIFNUQUNLCiAqIC0gRmlsZXMgbGFyZ2VyIHRoZW4gMioqMzItMQogKiAtIEZpbGVzIHdpdGggdW5pY29kZSBmaWxlbmFtZXMKICogLSBQYXNzaW5nIG51bWJlcnMgZ3JlYXRlciB0aGFuIDIqKjMyLTEgd2hlbiBhbiBpbnRlZ2VyIGlzIGV4cGVjdGVkCiAqIC0gTWFraW5nIGl0IHdvcmsgb24gV2luZG93cyBhbmQgb3RoZXIgb2RkYmFsbCBwbGF0Zm9ybXMKICoKICogVG8gRG86CiAqCiAqIC0gYXV0b2NvbmZpZnkgaGVhZGVyIGZpbGUgaW5jbHVzaW9uCiAqLwoKI2lmZGVmIE1TX1dJTkRPV1MKICAgLy8gY2FuIHNpbXVsYXRlIHRydW5jYXRlIHdpdGggV2luMzIgQVBJIGZ1bmN0aW9uczsgc2VlIGZpbGVfdHJ1bmNhdGUKIyAgZGVmaW5lIEhBVkVfRlRSVU5DQVRFCiMgIGlmbmRlZiBXSU4zMl9MRUFOX0FORF9NRUFOCiMgICAgZGVmaW5lIFdJTjMyX0xFQU5fQU5EX01FQU4KIyAgZW5kaWYKIyAgaW5jbHVkZSA8d2luZG93cy5oPgojZW5kZS0+Y2FsbGJhY2tzKTsKCiAgICAvKiBQcmV2ZW50IGEgc3VidGxlIGJ1ZyB0aGF0IGFmZmVjdHMgc3ViLWludGVycHJldGVycyB0aGF0IHVzZSBiYXNpYwogICAgICogc2luZ2xlLXBoYXNlIGluaXQgZXh0ZW5zaW9ucyAobV9zaXplID09IC0xKS4gIFRob3NlIGV4dGVuc2lvbnMgY2F1c2Ugb2JqZWN0cwogICAgICogdG8gYmUgc2hhcmVkIGJldHdlZW4gaW50ZXJwcmV0ZXJzLCB2aWEgdGhlIFB5RGljdF9VcGRhdGUobWRpY3QsIG1fY29weSkgY2FsbAogICAgICogaW4gaW1wb3J0X2ZpbmRfZXh0ZW5zaW9uKCkuCiAgICAgKgogICAgICogSWYgdGhleSBhcmUgR0Mgb2JqZWN0cywgdGhlaXIgR0MgaGVhZCBuZXh0IG9yIHByZXYgbGlua3MgY291bGQgcmVmZXIgdG8KICAgICAqIHRoZSBpbnRlcnByZXRlciBfZ2NfcnVudGltZV9zdGF0ZSBQeUdDX0hlYWQgbm9kZXMuICBUaG9zZSBub2RlcyBnbyBhd2F5CiAgICAgKiB3aGVuc2FmZSB3YXkgaXM6CiAqCiAqICAgICAgUHlfU0VUUkVGKGRzdCwgc3JjKTsKICoKICogVGhhdCBhcnJhbmdlcyB0byBzZXQgYGRzdGAgdG8gYHNyY2AgX2JlZm9yZV8gZGVjcmVmJ2luZywgc28gdGhhdCBhbnkgY29kZQogKiB0cmlnZ2VyZWQgYXMgYSBzaWRlLWVmZmVjdCBvZiBgZHN0YCBnZXR0aW5nIHRvcm4gZG93biBubyBsb25nZXIgYmVsaWV2ZXMKICogYGRzdGAgcG9pbnRzIHRvIGEgdmFsaWQgb2JqZWN0LgogKgogKiBUZW1wb3JhcnkgdmFyaWFibGVzIGFyZSB1c2VkIHRvIG9ubHkgZXZhbHVhdGUgbWFjcm8gYXJndW1lbnRzIG9uY2UgYW5kIHNvCiAqIGF2b2lkIHRoZSBkdXBsaWNhdGlvbiBvZiBzaWRlIGVmZmVjdHMuIF9QeV9UWVBFT0YoKSBvciBtZW1jcHkoKSBpcyB1c2VkIHRvCiAqIGF2b2lkIGEgbWlzY29tcGlsYXRpb24gY2F1c2VkIGJ5IHR5cGUgcHVubmluZy4gU2VlIFB5X0NMRUFSKCkgY29tbWVudCBmKG8sICZQeUlkX2ZvbywgImFyZ3MiLCAuLi4pOwoKICAgUHlJZF9mb28gaXMgYSBzdGF0aWMgdmFyaWFibGUsIGVpdGhlciBvbiBibG9jayBsZXZlbCBvciBmaWxlIGxldmVsLiBPbiBmaXJzdAogICB1c2FnZSwgdGhlIHN0cmluZyAiZm9vIiBpcyBpbnRlcm5lZCwgYW5kIHRoZSBzdHJ1Y3R1cmVzIGFyZSBsaW5rZWQuIE9uIGludGVycHJldGVyCiAgIHNodXRkb3duLCBhbGwgc3RyaW5ncyBhcmUgcmVsZWFzZWQuCgogICBBbHRlcm5hdGl2ZWx5LCBfUHlfc3RhdGljX3N0cmluZyBhbGxvd3MgY2hvb3NpbmcgdGhlIHZhcmlhYmxlIG5hbWUuCiAgIF9QeVVuaWNvZGVfRnJvbUlkIHJldHVybnMgYSBib3Jyb3dlZCByZWZlcmVuY2UgdG8gdGhlIGludGVybmVkIHN0cmluZy4KICAgX1B5T2JqZWN0X3tHZXQsU2V0LEhhc31BdHRySWQgYXJlIF9fZ2V0YXR0cl9fIHZlcnNpb25zIHVzaW5nIF9QeV9JZGVudGlmaWVyKi4KKi8KdHlwKCk7CglmcHJpbnRmKHN0ZGVyciwgInRpbWU6ICVmXG5cbiIsCgkgICAgICAgICAgIChkb3VibGUpKGVuZF9jbG9jay1zdGFydF9jbG9jaykvKGRvdWJsZSlDTE9DS1NfUEVSX1NFQyk7CgoJcnN0cmluZyA9IG1wZF90b19zY2kocmVzdWx0LCAxKTsKCW1wZF9zbnByaW50X2ZsYWdzKHN0YXR1c19zdHIsIE1QRF9NQVhfRkxBR19TVFJJTkcsIGN0eC5zdGF0dXMpOwoJcHJpbnRmKCIlcyAgJXNcbiIsIHJzdHJpbmcsIHN0YXR1c19zdHIpOwoKCW1wZF9kZWwoYSk7CgltcGRfZGVsKGIpOwoJbXBkX2RlbChyZXN1bHQpOwoJbXBkX2ZyZWUocnN0cmluZyk7CgoJcmV0dXJuIDA7Cn0KCgojaW5jbHVkZSAicGFydHMuaCIKI2luY2x1ZGUgPHN0ZGRlZi5oPiAgICAgICAgICAgICAgIC8vIG9mZnNldG9mKCkKCgpzdGF0aWMgc3RydWN0IFB5TW9kdWxlRGVmICpfdGVzdGNhcGltb2R1bGUgPSBOVUxMOyAgLy8gc2V0IGF0IGluaXRyIHNpZ2lvU2VlblxuIik7Cgl9CgoJLy8gV2FpdCB1bnRpbCB0aGUgc2lnbmFsIGhhcyBiZWVuIGRlbGl2ZXJlZC4KCWkgPSAwOwoJd2hpbGUgKCFzaWdpb1NlZW4pIHsKCQl0cy50dl9zZWMgPSAwOwoJCXRzLnR2X25zZWMgPSAxMDAwMDAwOwoJCW5hbm9zbGVlcCgmdHMsIE5VTEwpOwoJCWkrKzsKCQlpZiAoaSA+IDUwMDApIHsKCQkJZnByaW50ZihzdGRlcnIsICJsb29waW5nIHRvbyBsb25nIHdhaXRpbmcgZm9yIHNpZ25hbFxuIik7CgkJCWV4aXQoRVhJVF9GQUlMVVJFKTsKCQl9Cgl9CgoJc2lnaW9TZWVuID0gMDsKCgkvLyBUZWxsIHRoZSBHbyBjb2RlIHRvIGNhdGNoIFNJR0lPLgoKCWlmICh2ZXJib3NlKSB7CgkJZnByaW50ZihzdGRlcnIsICJjYWxsaW5nIGRsc3ltXG4iKTsKCX0KCgljYXRjaFNJR0lPID0gKHZvaWQoKikodm9pZCkpZGxzeW0oaGFuZGxlLCAiQ2F0Y2hTSUdJTyIpOwoJaWYgKGNhdGNoU0lHSU8gPT1FVFlQRSwKICAgIFN0YXRlQWNjZXNzVHlwZV9UeXBlX3Nsb3RzCn07CgovKiBGdW5jdGlvbiBvZiB0d28gaW50ZWdlcnMgcmV0dXJuaW5nIGludGVnZXIgKi8KClB5RG9jX1NUUlZBUih0ZXN0ZXhwb3J0X2Zvb19kb2MsCiJmb28oaSxqKVxuXApcblwKUmV0dXJuIHRoZSBzdW0gb2YgaSBhbmQgai4iKTsKCnN0YXRpYyBQeU9iamVjdCAqCnRlc3RleHBvcnRfZm9vKFB5T2JqZWN0ICpzZWxmLCBQeU9iamVjdCAqYXJncykKewogICAgbG9uZyBpLCBqOwogICAgbG9uZyByZXM7CiAgICBpZiAoIVB5QXJnX1BhcnNlVHVwbGUoYXJncywgImxsOmZvbyIsICZpLCAmaikpCiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICByZXMgPSBpICsgajsKICAgIHJldHVybiBQeUxvbmdfRnJvbUxvbmcocmVzKTsKfQoKLyogVGVzdCB0aGF0IFB5U3RhdGUgcmVnaXN0cmF0aW9uIGZhaWxzICAqLwoKUHlEb2NfU1RSVkFSKGNhbGxfc3RhdGVfcmVnaXplIiwgYnl0ZWFycmF5X3Jlc2l6ZSwgTUVUSF9WQVJBUkdTfSwKICAgIHtOVUxMfSwKfTsKCmludApfUHlUZXN0TGltaXRlZENBUElfSW5pdF9CeXRlQXJyYXkoUHlPYmplY3QgKm0pCnsKICAgIGlmIChQeU1vZHVsZV9BZGRGdW5jdGlvbnMobSwgdGVzdF9tZXRob2RzKSA8IDApIHsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgcmV0dXJuIDA7Cn0KCi8qIHNldCBvYmplY3QgaW1wbGVtZW50YXRpb24KCiAgIFdyaXR0ZW4gYW5kIG1haW50YWluZWQgYnkgUmF5bW9uZCBELiBIZXR0aW5nZXIgPHB5dGhvbkByY24uY29tPgogICBEZXJpdmVkIGZyb20gT2JqZWN0cy9kaWN0b2JqZWN0LmMuCgogICBUaGUgYmFzaWMgbG9va3VwIGZ1bmN0aW9uIHVzZWQgYnkgYWxsIG9wZXJhdGlvbnMuCiAgIFRoaXMgaXMgYmFzZWQgb24gQWxnb3JpdGhtIEQgZnJvbSBLbnV0aCBWb2wuIDMsIFNlYy4gNi40LgoKICAgVGhlIGluaXRpZV90IGluZGV4ID0gRlRfQVRPTUlDX0xPQURfU1NJWkVfUkVMQVhFRChyby0+aW5kZXgpOwoKICAgIGlmIChpbmRleCA9PSAtMSkKICAgICAgICByZXR1cm4gUHlMb25nX0Zyb21Mb25nKDApOwogICAgYXNzZXJ0KHJvLT5zZXEgIT0gTlVMTCk7CiAgICBzZXFzaXplID0gUHlTZXF1ZW5jZV9TaXplKHJvLT5zZXEpOwogICAgaWYgKHNlcXNpemUgPT0gLTEpCiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICBwb3NpdGlvbiA9IGluZGV4ICsgMTsKICAgIHJldHVybiBQeUxvbmdfRnJvbVNzaXplX3QoKHNlcXNpemUgPCBwb3NpdGlvbikgID8gIDAgIDogIHBvc2l0aW9uKTsKfQoKUHlEb2NfU1RSVkFSKGxlbmd0aF9oaW50X2RvYywgIlByaXZhdGUgbWV0aG9kIHJldHVybmluZyBhbiBlc3RpbWF0ZSBvZiBsZW4obGlzdChpdCkpLiIpOwoKc3RhdGljIFB5T2JqZWN0ICoKcmV2ZXJzZWRfcmVkdWNlKFB5T2JqZWN0ICpvcCwgUHlPX2RvY2AgaXMgZWl0aGVyIE5VTEwgb3IKICAgICAgIGEgbm9uLU5vbmUgb2JqZWN0IHdpdGggaW5jcmVtZW50ZWQgcmVmIGNvdW50ZXIgKi8KCiAgICBpZiAoUHlfSVNfVFlQRShzZWxmLCAmUHlQcm9wZXJ0eV9UeXBlKSkgewogICAgICAgIFB5X1hTRVRSRUYoc2VsZi0+cHJvcF9kb2MsIHByb3BfZG9jKTsKICAgIH0gZWxzZSB7CiAgICAgICAgLyogSWYgdGhpcyBpcyBhIHByb3BlcnR5IHN1YmNsYXNzLCBwdXQgX19kb2NfXyBpbiB0aGUgZGljdAogICAgICAgICAgIG9yIGRlc2lnbmF0ZWQgc2xvdCBvZiB0aGUgc3ViY2xhc3MgaW5zdGFuY2UgaW5zdGVhZCwgb3RoZXJ3aXNlCiAgICAgICAgICAgaXQgZ2V0cyBzaGFkb3dlZCBieSBfX2RvY19fIGluIHRoZSBjbGFzcydzIGRpY3QuICovCgogICAgICAgIGlmIChwcm9wX2RvYyA9PSBOVUxMKSB7CiAgICAgICAgICAgIHByb3BfZG9jID0gUHlfTmV3UmVmKFB5X05vbmUpOwogT1VORF9IQUxGX0VWRU4iLCAgIC8qIDAuNSBpcyByb3VuZGVkIHRvIGV2ZW4gICAgICAgICAgKi8KICAgICJST1VORF8wNVVQIiwgICAgICAgIC8qIHJvdW5kIHplcm8gb3IgZml2ZSBhd2F5IGZyb20gMCAgKi8KICAgICJST1VORF9UUlVOQyIsICAgICAgIC8qIHRydW5jYXRlLCBidXQgc2V0IGluZmluaXR5ICAgICAgKi8KfTsKCmNvbnN0IGNoYXIgKiBjb25zdCBtcGRfY2xhbXBfc3RyaW5nW01QRF9DTEFNUF9HVUFSRF0gPSB7CiAgICAiQ0xBTVBfREVGQVVMVCIsCiAgICAiQ0xBTVBfSUVFRV83NTQiCn07Ci8qCiAqIF9jb2RlY3NfanAuYzogQ29kZWNzIGNvbGxlY3Rpb24gZm9yIEphcGFuZXNlIGVuY29kaW5ncwogKgogKiBXcml0dGVuIGJ5IEh5ZS1TaGlrIENoYW5nIDxwZXJreUBGcmVlQlNELm9yZz4KICovCgojZGVmaW5lIFVTSU5HX0JJTkFSWV9QQUlSX1NFQVJDSAojZGVmaW5lIEVNUEJBU0UgMHgyMDAwMAoKI2luIDB4YzAsIDB4YzEsIDB4YzIsIDB4YzMsIDB4YzQsIDB4YzUsIDB4YzYsCiAgICAweGM3LCAweGM4LCAweGM5LCAweGNhLCAweGNiLCAweGNjLCAweGNkLCAweGNlLAogICAgMHhjZiwgMHhkMCwgMHhkMSwgMHhkMiwgMHhkMwp9OwpzdGF0aWMgY29uc3QgdW5zaWduZWQgY2hhciB1MmNna19qb25nc2VvbmdbMjhdID0gewogICAgMHhkNCwgMHhhMSwgMHhhMiwgMHhhMywgMHhhNCwgMHhhNSwgMHhhNiwgMHhhNywKICAgIDB4YTksIDB4YWEsIDB4YWIsIDB4YWMsIDB4YWQsIDB4YWUsIDB4YWYsIDB4YjAsCiAgICAweGIxLCAweGIyLCAweGI0LCAweGI1LCAweGI2LCAweGI3LCAweGI4LCAweGJhLAogICAgMHhiYiwgMHhiYywgMHhiZCwgMHhiZQp9OwoKRU5DT0RFUihldWNfa3IpCnsKICAgIHdoaWxlICgqaW5wb3MgPCBpbmxlbikgewogICAgICAgIFB5X1VDUzQgYyA9IElOQ0hBUjE7CiAgICAgICAgREJDSEFSIGNvZGU7CgogZmx1c2gKCiAgICBtb2RlOiBpbnQoY19kZWZhdWx0PSJaU1REX2VfZW5kIikgPSBac3RkQ29tcHJlc3Nvci5GTFVTSF9GUkFNRQogICAgICAgIENhbiBiZSB0aGVzZSAyIHZhbHVlcyBac3RkQ29tcHJlc3Nvci5GTFVTSF9GUkFNRSwKICAgICAgICBac3RkQ29tcHJlc3Nvci5GTFVTSF9CTE9DSwoKRmluaXNoIHRoZSBjb21wcmVzc2lvbiBwcm9jZXNzLgoKRmx1c2ggYW55IHJlbWFpbmluZyBkYXRhIGxlZnQgaW4gaW50ZXJuYWwgYnVmZmVycy4gU2luY2UgWnN0YW5kYXJkIGRhdGEKY29uc2lzdHMgb2Ygb25lIG9yIG1vcmUgaW5kZXBlbmRlbnQgZnJhbWVzLCB0aGUgY29tcHJlc3NvciBvYmplY3QgY2FuIHN0aWxsCmJlIHVzZWQgYWZ0ZXIgdGhpcyBtZXRob2QgaXMgY2FsbGVkLgpbY2xpbmljIHN0YXJ0IGdlbmVyYXRlZCBjb2RlXSovCgpzdGF0aWMgUHlPYmplY3QgKgpfenN0ZF9ac3RkQ29tcHJlc3Nvcl9mbHVzaF9pbXBscmUgZXhwZWN0ZWQgdG8gdGFrZSBvbmUgYXJndW1lbnQsIHRoZSBlbmNvZGluZyBuYW1lIGluXG4iCiJhbGwgbG93ZXIgY2FzZSBsZXR0ZXJzLCBhbmQgZWl0aGVyIHJldHVybiBOb25lLCBvciBhIHR1cGxlIG9mIGZ1bmN0aW9uc1xuIgoiKGVuY29kZXIsIGRlY29kZXIsIHN0cmVhbV9yZWFkZXIsIHN0cmVhbV93cml0ZXIpIChvciBhIENvZGVjSW5mbyBvYmplY3QpLiIpOwoKI2RlZmluZSBfQ09ERUNTX1JFR0lTVEVSX01FVEhPRERFRiAgICBcCiAgICB7InJlZ2lzdGVyIiwgKFB5Q0Z1bmN0aW9uKV9jb2RlY3NfcmVnaXN0ZXIsIE1FVEhfTywgX2NvZGVjc19yZWdpc3Rlcl9fZG9jX199LAoKUHlEb2NfU1RSVkFSKF9jb2RlY3NfdW5yZWdpc3Rlcl9fZG9jX18sCiJ1bnJlZ2lzdGVyKCRtb2R1bGUsIHNlYXJjaF9mdW5jdGlvbiwgLylcbiIKIi0tXG4iCiJcbiIKIlVucmVnaXN0ZXIgYSBjb2RlYyBzZWFyY2ggZnUKICAgIERXT1JEIGV4aXRDb2RlOwogICAgaWYgKEdldEV4aXRDb2RlUHJvY2VzcyhoUHJvY2VzcywgJmV4aXRDb2RlKSkgewogICAgICAgIHJldHVybiBleGl0Q29kZSA9PSBTVElMTF9BQ1RJVkU7CiAgICB9CiAgICByZXR1cm4gMDsKfQoKc3RhdGljIHZvaWQqIGFuYWx5emVfcGUoY29uc3Qgd2NoYXJfdCogbW9kX3BhdGgsIEJZVEUqIHJlbW90ZV9iYXNlLCBjb25zdCBjaGFyKiBzZWNuYW1lKSB7CiAgICBIQU5ETEUgaEZpbGUgPSBDcmVhdGVGaWxlVyhtb2RfcGF0aCwgR0VORVJJQ19SRUFELCBGSUxFX1NIQVJFX1JFQUQsIE5VTEwsIE9QRU5fRVhJU1RJTkcsIEZJTEVfQVRUUklCVVRFX05PUk1BTCwgTlVMTCk7CiAgICBpZiAoaEZpbGUgPT0gSU5WQUxJRF9IQU5ETEVfVkFMVUUpIHsKICAgICAgICBQeUVycl9TZXRGcm9tV2luZG93c0VycigwKTsKICAgICAgICBEV09SRCBlcnJvciA9IEdldExhc3RFcnJvcigpOwogICAgcCA9IChkbF9mdW5jcHRyKSBkbHN5bShoYW5kbGUsIGZ1bmNuYW1lKTsKICAgIHJldHVybiBwOwp9Ci8qIHByZXBhcmVfcHJvdG9jb2wuaCAtIHRoZSBwcm90b2NvbCBmb3IgcHJlcGFyaW5nIHZhbHVlcyBmb3IgU1FMaXRlCiAqCiAqIENvcHlyaWdodCAoQykgMjAwNS0yMDEwIEdlcmhhcmQgSMOkcmluZyA8Z2hAZ2hhZXJpbmcuZGU+CiAqCiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHB5c3FsaXRlLgogKgogKiBUaGlzIHNvZnR3YXJlIGlzIHByb3ZpZGVkICdhcy1pcycsIHdpdGhvdXQgYW55IGV4cHJlc3Mgb3IgaW1wbGllZAogKiB3YXJyYW50eS4gIEluIG5vIGV2ZW50IHdpbGwgdGhlIGF1dGhvcnMgYmUgaGVsZCBsaWFibGUgZm9yIGFueSBkYW1hZ2VzCiAqIGFyaXNpbmcgZnJvbSB0aGUgdXNlIG9mIHRoaXMgc29mdHdhcmUuCiAqCiAqIFBlcm1pc3Npb24gaXMgZ3JhbnRlZCB0byBhbnlvbmUgdG8gdSAgIFB5U3RhdHMgKnMgPSBfUHlTdGF0c19HRVQoKTsgXAogICAgICAgIE9QQ09ERV9FWEVfSU5DKG9wKTsgXAogICAgICAgIGlmIChzKSBzLT5vcGNvZGVfc3RhdHNbbGFzdG9wY29kZV0ucGFpcl9jb3VudFtvcF0rKzsgXAogICAgICAgIGxhc3RvcGNvZGUgPSBvcDsgXAogICAgfSB3aGlsZSAoMCkKI2Vsc2UKI2RlZmluZSBJTlNUUlVDVElPTl9TVEFUUyhvcCkgKCh2b2lkKTApCiNlbmRpZgoKI2lmZGVmIFB5X1NUQVRTCiMgICBkZWZpbmUgVEFJTF9DQUxMX1BBUkFNUyBfUHlJbnRlcnByZXRlckZyYW1lICpmcmFtZSwgX1B5U3RhY2tSZWYgKnN0YWNrX3BvaW50ZXIsIFB5VGhyZWFkU3RhdGUgKnRzdGF0ZSwgX1B5X0NPREVVTklUICpuZXh0X2luc3RyLCBjb25zdCB2b2lkICppbnN0cnVjdGlvbl9mdW5jcHRyX3RhYmxlLCBpbnQgb3BhcmcsIGludCBsYXN0b3Bjb2RlCiMgICBkZWZpbmUgVEFJTF9DQUxMX0FSR1MgZnJhbSAgICAgI3VuZGVmIFRFU1RfRklFTEQKICAgICAgICAjdW5kZWYgU0VUX0FORF9BUFBFTkQKICAgICAgICAjdW5kZWYgQVBQRU5ECgovKgpXcml0dGVuIGJ5IEppbSBIdWd1bmluIGFuZCBDaHJpcyBDaGFzZS4KClRoaXMgaW5jbHVkZXMgYm90aCB0aGUgc2luZ3VsYXIgZWxsaXBzaXMgb2JqZWN0IGFuZCBzbGljZSBvYmplY3RzLgoKR3VpZG8sIGZlZWwgZnJlZSB0byBkbyB3aGF0ZXZlciB5b3Ugd2FudCBpbiB0aGUgd2F5IG9mIGNvcHlyaWdodHMKZm9yIHRoaXMgZmlsZS4KKi8KCi8qClB5X0VsbGlwc2lzIGVuY29kZXMgdGhlICcuLi4nIHJ1YmJlciBpbmRleCB0b2tlbi4gSXQgaXMgc2ltaWxhciB0bwp0aGUgUHlfTm9uZVN0cnVjdCBpbiB0aGF0IHRoZXJlIGlzIG5vIHdheSB0byBjcmVhdGUgb3RoZXIgb2JqZWN0cyBvZgp0aGlzIHR5cGUgYW5kIHRoZXJlIGlzIGV4YWN0bHkgb25lIGluIGV4aXN0ZW5jZS4KKi8KCiNpbkxZICgwKQojZGVmaW5lIF9QeVhJREFUQV9GVUxMX0ZBTExCQUNLICgxKQoKLy8gVGVjaG5pY2FsbHksIHdlIGRvbid0IG5lZWQgdHdvIGRpZmZlcmVudCBmdW5jdGlvbiB0eXBlczsKLy8gd2UgY291bGQgZ28gd2l0aCBqdXN0IHRoZSBmYWxsYmFjayBvbmUuICBIb3dldmVyLCBvbmx5IGNvbnRhaW5lcgovLyB0eXBlcyBsaWtlIHR1cGxlIG5lZWQgaXQsIHNvIGFsd2F5cyBoYXZpbmcgdGhlIGV4dHJhIGFyZyB3b3VsZCBiZQovLyBhIGJpdCB1bmZvcnR1bmF0ZS4gIEl0J3MgYWxzbyBuaWNlIHRvIGJlIGFibGUgdG8gY2xlYXJseSBkaXN0aW5ndWlzaAovLyBiZXR3ZWVuIHR5cGVzIHRoYXQgbWlnaHQgY2FsbCBfUHlPYmplY3RfR2V0WElEYXRhKCkgYW5kIHRob3NlIHRoYXQgd29uJ3QuCi8vCnR5cGVkZWYgaW50ICgqeGlkYXRhZnVuYykoUHlUaHJlYWRTdGF0ZSAqLCBQeU9iamVjdCAqLCBfUHlYSURhdGFfdCAqKTsKdHlwZSAgIG9wLT52ZWN0b3JjYWxsID0gX1B5RnVuY3Rpb25fVmVjdG9yY2FsbDsKICAgIG9wLT5mdW5jX3ZlcnNpb24gPSBGVU5DX1ZFUlNJT05fVU5TRVQ7CiAgICAvLyBOT1RFOiBmdW5jdGlvbnMgY3JlYXRlZCB2aWEgRnJhbWVDb25zdHJ1Y3RvciBkbyBub3QgdXNlIGRlZmVycmVkCiAgICAvLyByZWZlcmVuY2UgY291bnRpbmcgYmVjYXVzZSB0aGV5IGFyZSB0eXBpY2FsbHkgbm90IHBhcnQgb2YgY3ljbGVzCiAgICAvLyBub3IgYWNjZXNzZWQgYnkgbXVsdGlwbGUgdGhyZWFkcy4KICAgIF9QeU9iamVjdF9HQ19UUkFDSyhvcCk7CiAgICBoYW5kbGVfZnVuY19ldmVudChQeUZ1bmN0aW9uX0VWRU5UX0NSRUFURSwgb3AsIE5VTEwpOwogICAgcmV0dXJuIG9wOwp9CgpQeU9iamVjdCAqClB5RnVuY3Rpb25fTmV3V2l0aFF1YWxOYW1lKFB5T2JqZWN0ICpjb2RlLCBQeU9iamVjdCAqZ2xvYmFscywgUHlPYmplY3QgKnF1YWxuYW1lKWN0dXJlcyBkZWZpbmVzIHRoZSBuYW1lLCB0eXBlIGFuZCBvZmZzZXQKICAgb2Ygc2VsZWN0ZWQgbWVtYmVycyBvZiBhIEMgc3RydWN0dXJlLiAgVGhlc2UgY2FuIGJlIHJlYWQgYnkKICAgUHlNZW1iZXJfR2V0T25lKCkgYW5kIHNldCBieSBQeU1lbWJlcl9TZXRPbmUoKSAoZXhjZXB0IGlmIHRoZWlyIFJFQURPTkxZCiAgIGZsYWcgaXMgc2V0KS4gIFRoZSBhcnJheSBtdXN0IGJlIHRlcm1pbmF0ZWQgd2l0aCBhbiBlbnRyeSB3aG9zZSBuYW1lCiAgIHBvaW50ZXIgaXMgTlVMTC4gKi8Kc3RydWN0IFB5TWVtYmVyRGVmIHsKICAgIGNvbnN0IGNoYXIgKm5hbWU7CiAgICBpbnQgdHlwZTsKICAgIFB5X3NzaXplX3Qgb2Zmc2V0OwogICAgaW50IGZsYWdzOwogICAgY29uc3QgY2hhciAqZG9jOwp9OwoKLy8gVGhlc2UgY29uc3RhbnRzIHVzZWQgdG8gYmUgaW4gc3RydWN0bWVtYmVyLmgsIG5vdCBwcmVmaXhlZCBieSBQeV8uCi8vY3RseSBpbnN0ZWFkLiAqLwogICAgaWYgKFB5VW5pY29kZV9DaGVjayhzdHJpbmcpKSB7CiAgICAgICAgKnBfbGVuZ3RoID0gUHlVbmljb2RlX0dFVF9MRU5HVEgoc3RyaW5nKTsKICAgICAgICAqcF9jaGFyc2l6ZSA9IFB5VW5pY29kZV9LSU5EKHN0cmluZyk7CiAgICAgICAgKnBfaXNieXRlcyA9IDA7CiAgICAgICAgcmV0dXJuIFB5VW5pY29kZV9EQVRBKHN0cmluZyk7CiAgICB9CgogICAgLyogZ2V0IHBvaW50ZXIgdG8gYnl0ZSBzdHJpbmcgYnVmZmVyICovCiAgICBpZiAoUHlPYmplY3RfR2V0QnVmZmVyKHN0cmluZywgdmlldywgUHlCVUZfU0lNUExFKSAhPSAwKSB7CiAgICAgICAgUHlFcnJfRm9ybWF0KFB5RXhjX1R5cGVFcnJvciwgImV4cGVjdGVkIHN0cmluZyBvciBieXRlcy1saWtlICIKICAgICAgICAgICAgICAgICAgICAgIm9iamVjdCwgZ290ICclLjIwMHMnIiwgUHlfVFlQRShzdHJpbmcpLT50cF9uYW1lKU1MX01BWUJFX1VOVVNFRF9WQVIobGVuKTsKICBmb3IgKHVpbnQzMl90IGkgPSAwVTsgaSA8IG5iOyBpKyspCiAgewogICAgdWludDY0X3QgdG90bGVuID0gcHJldiArICh1aW50NjRfdCkoKGkgKyAxVSkgKiA2NFUpOwogICAgdWludDhfdCAqYiA9IGJsb2NrcyArIGkgKiA2NFU7CiAgICB1cGRhdGVfYmxvY2sod3YsIGhhc2gsIGZhbHNlLCBmYWxzZSwgdG90bGVuLCBiKTsKICB9Cn0KCnZvaWQKSGFjbF9IYXNoX0JsYWtlMnNfdXBkYXRlX2xhc3QoCiAgdWludDMyX3QgbGVuLAogIHVpbnQzMl90ICp3diwKICB1aW50MzJfdCAqaGFzaCwKICBib29sIGxhc3Rfbm9kZSwKICB1aW50NjRfdCBwcmV2LAogIHVpbnQzMl90IHJlbSwKICB1aW50OF90ICpkCikKewogIHVpbnQ4X3QgYls2NFVdID0geyAwVSB9OwogIHVpbnQ4X3QgKmxhc3QgPSBkICsgbGVuIC0gcmVtOwogIG1lbWNweShiLCBsYXN0LCByZW0gKiBzaXplb2YgKHVpbnplID0gZml4ZWRzaXplICsgc2l6ZW9mKF9QeVhJX25hbWVzcGFjZV9pdGVtKSAqIG1heGl0ZW1zOwoKICAgIF9QeVhJX25hbWVzcGFjZSAqbnMgPSBQeU1lbV9SYXdDYWxsb2Moc2l6ZSwgMSk7CiAgICBpZiAobnMgPT0gTlVMTCkgewogICAgICAgIFB5RXJyX05vTWVtb3J5KCk7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CiAgICBucy0+bWF4aXRlbXMgPSBtYXhpdGVtczsKICAgIGFzc2VydChfc2hhcmVkbnNfY2hlY2tfY29uc2lzdGVuY3kobnMpKTsKICAgIHJldHVybiBuczsKfQoKc3RhdGljIHZvaWQKX3NoYXJlZG5zX2ZyZWUoX1B5WElfbmFtZXNwYWNlICpucykKewogICAgLy8gSWYgd2Ugd2VyZW4ndCBhbHdheXMgZHluYW1pY2FsbHkgYWxsb2NhdGluZyB0aGUgY3Jvc3MtaW50ZXJwcmV0ZXIKICAgIC8vIGRhdGEgaW4gZWFjaCBpdGVtIHRoZW4gd2Ugd291bGQgbmVlZCB0byB1c2UgYSBwZW5kaW5nIGNhbGwKIHNJT193cml0ZV9pbXBsKChieXRlc2lvICopc2VsZiwgYik7CiAgICBQeV9FTkRfQ1JJVElDQUxfU0VDVElPTigpOwoKICAgIHJldHVybiByZXR1cm5fdmFsdWU7Cn0KClB5RG9jX1NUUlZBUihfaW9fQnl0ZXNJT193cml0ZWxpbmVzX19kb2NfXywKIndyaXRlbGluZXMoJHNlbGYsIGxpbmVzLCAvKVxuIgoiLS1cbiIKIlxuIgoiV3JpdGUgbGluZXMgdG8gdGhlIGZpbGUuXG4iCiJcbiIKIk5vdGUgdGhhdCBuZXdsaW5lcyBhcmUgbm90IGFkZGVkLiAgbGluZXMgY2FuIGJlIGFueSBpdGVyYWJsZSBvYmplY3RcbiIKInByb2R1Y2luZyBieXRlcy1saWtlIG9iamVjdHMuIFRoaXMgaXMgZXF1aXZhbGVudCB0byBjYWxsaW5nIHdyaXRlKCkgZm9yXG4iCiJlYWNoIGVsZW1lbnQuIik7CgojZGVmaW5lIF9JT19CWVRFU0lPX1dSSVRFTElORVNfTUVUSE9EREVGICAgIFwKICAgIHsid3JpdGVsaW5lcyIsIChQeUNGdW5jdGlvbilfaW9fQmFsX0VuYWJsZUdJTFBlcm1hbmVudGx5KCksIGFuZCBfUHlFdmFsX0Rpc2FibGVHSUwoKQoKICAgICAgIEl0IGlzIGFsd2F5cyByZWFkIGFuZCB3cml0dGVuIGF0b21pY2FsbHksIGJ1dCBhIHRocmVhZCBjYW4gYXNzdW1lIGl0cwogICAgICAgdmFsdWUgd2lsbCBiZSBzdGFibGUgYXMgbG9uZyBhcyB0aGF0IHRocmVhZCBpcyBhdHRhY2hlZCBvciBrbm93cyB0aGF0IG5vCiAgICAgICBvdGhlciB0aHJlYWRzIGFyZSBhdHRhY2hlZCAoZS5nLiwgZHVyaW5nIGEgc3RvcC10aGUtd29ybGQuKS4gKi8KICAgIGludCBlbmFibGVkOwojZW5kaWYKICAgIC8qIG1pY3Jvc2Vjb25kcyAodGhlIFB5dGhvbiBBUEkgdXNlcyBzZWNvbmRzLCB0aG91Z2gpICovCiAgICB1bnNpZ25lZCBsb25nIGludGVydmFsOwogICAgLyogTGFzdCBQeVRocmVhZFN0YXRlIGhvbGRpbmcgLyBoYXZpbmcgaGVsZCB0aGUgR0lMLiBUaGlzIGhlbHBzIHVzCiAgIF9HQyB8IFB5X1RQRkxBR1NfQkFTRVRZUEUgfCBQeV9UUEZMQUdTX0hBVkVfVkVDVE9SQ0FMTCwKICAgIC50cF90cmF2ZXJzZSA9IGdhX3RyYXZlcnNlLAogICAgLnRwX3JpY2hjb21wYXJlID0gZ2FfcmljaGNvbXBhcmUsCiAgICAudHBfd2Vha2xpc3RvZmZzZXQgPSBvZmZzZXRvZihnYW9iamVjdCwgd2Vha3JlZmxpc3QpLAogICAgLnRwX21ldGhvZHMgPSBnYV9tZXRob2RzLAogICAgLnRwX21lbWJlcnMgPSBnYV9tZW1iZXJzLAogICAgLnRwX2FsbG9jID0gUHlUeXBlX0dlbmVyaWNBbGxvYywKICAgIC50cF9uZXcgPSBnYV9uZXcsCiAgICAudHBfZnJlZSA9IFB5T2JqZWN0X0dDX0RlbCwKICAgIC50cF9nZXRzZXQgPSBnYV9wcm9wZXJ0aWVzLAogICAgLnRwX2l0ZXIgPSBnYV9pdGVyLAogICAgLnRwX3ZlY3RvcmNhbGxfb2Zmc2V0ID0gb2Zmc2V0b2YoZ2FvYmplY3QsIHZlY3RvcmNhbGwpLAp9OwoKUHlPYmplY3QgKgpQeWUgRlVUVVJFX0RJVklTSU9OICJkaXZpc2lvbiIKI2RlZmluZSBGVVRVUkVfQUJTT0xVVEVfSU1QT1JUICJhYnNvbHV0ZV9pbXBvcnQiCiNkZWZpbmUgRlVUVVJFX1dJVEhfU1RBVEVNRU5UICJ3aXRoX3N0YXRlbWVudCIKI2RlZmluZSBGVVRVUkVfUFJJTlRfRlVOQ1RJT04gInByaW50X2Z1bmN0aW9uIgojZGVmaW5lIEZVVFVSRV9VTklDT0RFX0xJVEVSQUxTICJ1bmljb2RlX2xpdGVyYWxzIgojZGVmaW5lIEZVVFVSRV9CQVJSWV9BU19CREZMICJiYXJyeV9hc19GTFVGTCIKI2RlZmluZSBGVVRVUkVfR0VORVJBVE9SX1NUT1AgImdlbmVyYXRvcl9zdG9wIgojZGVmaW5lIEZVVFVSRV9BTk5PVEFUSU9OUyAiYW5ub3RhdGlvbnMiCgojZGVmaW5lIFBZX0lOVkFMSURfU1RBQ0tfRUZGRUNUIElOVF9NQVgKUHlBUElfRlVOQyhpbnQpIFB5Q29tcGlsZV9PcGNvZGVTdGFja0VmZmVjdChpbnQgb3Bjb2RlLCBpbnQgb3BhcmcpOwpQeWxzdGFydCAtIGxzdGVwOwogICAgbmV3X3N0YXJ0ID0gKGxvbmcpKG5ld19zdG9wICsgdWxlbiAqIGxzdGVwKTsKICAgIHJldHVybiBmYXN0X3JhbmdlX2l0ZXIobmV3X3N0YXJ0LCBuZXdfc3RvcCwgLWxzdGVwLCAobG9uZyl1bGVuKTsKCmxvbmdfcmFuZ2U6CiAgICBpdCA9IFB5T2JqZWN0X05ldyhsb25ncmFuZ2VpdGVyb2JqZWN0LCAmUHlMb25nUmFuZ2VJdGVyX1R5cGUpOwogICAgaWYgKGl0ID09IE5VTEwpCiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICBpdC0+c3RhcnQgPSBpdC0+c3RlcCA9IE5VTEw7CgogICAgLyogc3RhcnQgKyAobGVuIC0gMSkgKiBzdGVwICovCiAgICBpdC0+bGVuID0gUHlfTmV3UmVmKHJhbmdlLT5sZW5ndGgpOwoKICAgIGRpZmYgPSBQeU51bWJlcl9TdWJ0cmFjdChpdC0+bGVuLCBfUHlMb25nX0dldE9uZSgpKTsKICAgIGlmICghZGlmZikKICAgICAgICBnb3RvIGNyZWF0ZV9mYWlsdXJlOwoKIFJWQVIocmFuZ2VfZG9jLAoicmFuZ2Uoc3RvcCkgLT4gcmFuZ2Ugb2JqZWN0XG5cCnJhbmdlKHN0YXJ0LCBzdG9wWywgc3RlcF0pIC0+IHJhbmdlIG9iamVjdFxuXApcblwKUmV0dXJuIGFuIG9iamVjdCB0aGF0IHByb2R1Y2VzIGEgc2VxdWVuY2Ugb2YgaW50ZWdlcnMgZnJvbSBzdGFydCAoaW5jbHVzaXZlKVxuXAp0byBzdG9wIChleGNsdXNpdmUpIGJ5IHN0ZXAuICByYW5nZShpLCBqKSBwcm9kdWNlcyBpLCBpKzEsIGkrMiwgLi4uLCBqLTEuXG5cCnN0YXJ0IGRlZmF1bHRzIHRvIDAsIGFuZCBzdG9wIGlzIG9taXR0ZWQhICByYW5nZSg0KSBwcm9kdWNlcyAwLCAxLCAyLCAzLlxuXApUaGVzZSBhcmUgZXhhY3RseSB0aGUgdmFsaWQgaW5kaWNlcyBmb3IgYSBsaXN0IG9mIDQgZWxlbWVudHMuXG5cCldoZW4gc3RlcCBpcyBnaXZlbiwgaXQgc3BlY2lmaWVzIHRoZSBpbmNyZW1lbnQgKG9yIGRlY3JlbWVudCkuIik7CgpzMl90ICpwID0gKHVpbnQzMl90ICopZ2V0X3N5bWJvbF9zbG90KG9yZGluYWwsICZzdGF0ZS0+dHJhbXBvbGluZXMsIFRSQU1QT0xJTkVfU0laRSk7CgogICAgLyogR2VuZXJhdGUgdGhlIHRyYW1wb2xpbmUKICAgICAgIDA6IDU4MDAwMDQ4ICAgICAgbGRyICAgICB4OCwgOAogICAgICAgNDogZDYxZjAxMDAgICAgICBiciAgICAgIHg4CiAgICAgICA4OiAwMDAwMDAwMCAgICAgIC8vIFRoZSBuZXh0IHR3byB3b3JkcyBjb250YWluIHRoZSA2NC1iaXQgYWRkcmVzcyB0byBqdW1wIHRvLgogICAgICAgYzogMDAwMDAwMDAKICAgICovCiAgICBwWzBdID0gMHg1ODAwMDA0ODsKICAgIHBbMV0gPSAweEQ2MUYwMTAwOwogICAgcFsyXSA9IHZhbHVlICYgMHhmZmZmZmZmZjsKICAgIHBbM10gPSB2YWx1ZSA+PiAzMjsKCiAgICBwYXRjaF9hYXJjaDY0XzI2cihsb2NhdGlvbiwgKHVpbnRwdHJfdClwKTsKfQoKLy8gR2VuZXJhdGUgYW5kIEtSTUxfSE9TVF9FUFJJTlRGKCJLYVJhTWVMIGFib3J0IGF0ICVzOiVkXG4lc1xuIiwKICAgIF9fRklMRV9fLAogICAgX19MSU5FX18sCiAgICAidW5yZWFjaGFibGUgKHBhdHRlcm4gbWF0Y2hlcyBhcmUgZXhoYXVzdGl2ZSBpbiBGKikiKTsKICBLUk1MX0hPU1RfRVhJVCgyNTVVKTsKfQoKLy8gTmVlZCBsaW1pdGVkIEMgQVBJIHZlcnNpb24gMy4xMyBmb3IgUHlfR2V0Q29uc3RhbnQoKQojaW5jbHVkZSAicHljb25maWcuaCIgICAvLyBQeV9HSUxfRElTQUJMRUQKI2lmICFkZWZpbmVkKFB5X0dJTF9ESVNBQkxFRCkgJiYgIWRlZmluZWQoUHlfTElNSVRFRF9BUEkpCiMgIGRlZmluZSBQeV9MSU1JVEVEX0FQSSAweDAzMGQwMDAwCiNlbmRpZgoKI2luY2x1ZGUgInBhcnRzLmgiCiNpbmNsdWRlICJ1dGlsLmgiCgoKLyogVGVzdCBQeV9HZXRDb25zdGFudCgpICovCnN0YXRpYyBQeU9iamVjdCAqCmdldF9jb25zdGFudChQeU9iaWQqIHAsIHNpemVfdCBuZXdzaXplLCBib29sIHplcm8pIG1pX2F0dHJfbm9leGNlcHQgewogIC8vIGlmIHAgPT0gTlVMTCB0aGVuIGJlaGF2ZSBhcyBtYWxsb2MuCiAgLy8gZWxzZSBpZiBzaXplID09IDAgdGhlbiByZWFsbG9jYXRlIHRvIGEgemVyby1zaXplZCBibG9jayAoYW5kIGRvbid0IHJldHVybiBOVUxMLCBqdXN0IGFzIG1pX21hbGxvYygwKSkuCiAgLy8gKHRoaXMgbWVhbnMgdGhhdCByZXR1cm5pbmcgTlVMTCBhbHdheXMgaW5kaWNhdGVzIGFuIGVycm9yLCBhbmQgYHBgIHdpbGwgbm90IGhhdmUgYmVlbiBmcmVlZCBpbiB0aGF0IGNhc2UuKQogIGNvbnN0IHNpemVfdCBzaXplID0gX21pX3VzYWJsZV9zaXplKHAsIm1pX3JlYWxsb2MiKTsgLy8gYWxzbyB3b3JrcyBpZiBwID09IE5VTEwgKHdpdGggc2l6ZSAwKQogIGlmIG1pX3VubGlrZWx5KG5ld3NpemUgPD0gc2l6ZSAmJiBuZXdzaXplID49IChzaXplIC8gMikgICpmaWx0ZXJzOyAgLyogTGlzdCAqLwogICAgUHlPYmplY3QgKm9uY2VfcmVnaXN0cnk7ICAvKiBEaWN0ICovCiAgICBQeU9iamVjdCAqZGVmYXVsdF9hY3Rpb247IC8qIFN0cmluZyAqLwogICAgX1B5UmVjdXJzaXZlTXV0ZXggbG9jazsKICAgIGxvbmcgZmlsdGVyc192ZXJzaW9uOwogICAgUHlPYmplY3QgKmNvbnRleHQ7Cn07CgpzdHJ1Y3QgX1B5X21lbV9pbnRlcnBfZnJlZV9xdWV1ZSB7CiAgICBpbnQgaGFzX3dvcms7ICAgLy8gdHJ1ZSBpZiB0aGUgcXVldWUgaXMgbm90IGVtcHR5CiAgICBQeU11dGV4IG11dGV4OyAgLy8gcHJvdGVjdHMgdGhlIHF1ZXVlCiAgICBzdHJ1Y3QgbGxpc3Rfbm9kZSBoZWFkOyAgLy8gcXVldWUgb2YgX21lbV93b3JrX2NodW5rIGl0ZW1zCn07CgoKLyoqKioqKiBVbmljb2RlIHN0YXRlICoqKioqKioqKi8KCnR5cGVkZWYgZW51bSB7CiAgICBfUHlfRVJST1JfVU5LTk9XTj0wLAogICBoYXZlbid0IGJlZW4gdXNlZCAqLwojZGVmaW5lIEJVSUxUSU5TX1dBVENIRVJfSUQgMAojZGVmaW5lIEdMT0JBTFNfV0FUQ0hFUl9JRCAgMQojZGVmaW5lIFRZUEVfV0FUQ0hFUl9JRCAgMAoKc3RhdGljIGludApnbG9iYWxzX3dhdGNoZXJfY2FsbGJhY2soUHlEaWN0X1dhdGNoRXZlbnQgZXZlbnQsIFB5T2JqZWN0KiBkaWN0LAogICAgICAgICAgICAgICAgICAgICAgICAgUHlPYmplY3QqIGtleSwgUHlPYmplY3QqIG5ld192YWx1ZSkKewogICAgUkFSRV9FVkVOVF9TVEFUX0lOQyh3YXRjaGVkX2dsb2JhbHNfbW9kaWZpY2F0aW9uKTsKICAgIGFzc2VydChnZXRfbXV0YXRpb25zKGRpY3QpIDwgX1B5X01BWF9BTExPV0VEX0dMT0JBTFNfTU9ESUZJQ0FUSU9OUyk7CiAgICBfUHlfRXhlY3V0b3JzX0ludmFsaWRhdGVEZXBlbmRlbmN5KF9QeUludGVycHJldGVyU3RhdGVfR0VUKCksIGRpY3QsIDEpOwogICAgaW5jcmVtZW50X21lID0gIlByb2ZpbGVyIiwKICAgICAgICAua3d0dXBsZSA9IEtXVFVQTEUsCiAgICB9OwogICAgI3VuZGVmIEtXVFVQTEUKICAgIFB5T2JqZWN0ICphcmdzYnVmWzRdOwogICAgUHlPYmplY3QgKiBjb25zdCAqZmFzdGFyZ3M7CiAgICBQeV9zc2l6ZV90IG5hcmdzID0gUHlUdXBsZV9HRVRfU0laRShhcmdzKTsKICAgIFB5X3NzaXplX3Qgbm9wdGFyZ3MgPSBuYXJncyArIChrd2FyZ3MgPyBQeURpY3RfR0VUX1NJWkUoa3dhcmdzKSA6IDApIC0gMDsKICAgIFB5T2JqZWN0ICp0aW1lciA9IE5VTEw7CiAgICBkb3VibGUgdGltZXVuaXQgPSAwLjA7CiAgICBpbnQgc3ViY2FsbHMgPSAxOwogICAgaW50IGJ1aWx0aW5zID0gMTsKCiAgICBmYXN0YXJncyA9IF9QeUFyZ19VbnBhY2tLZXl3b3JkcyhfUHlUdXBsZV9DQVNUKGFyZ3MpLT5vYl9pdGVtLCBuYXJncywga3dhcmdzLCBOVUxMLCAmX3BnaXZlbgogKiAgICAgICAgIHRoZSBjb3JyZWN0bHkgcm91bmRlZCByZXN1bHQuICBGb3IgayByZXF1ZXN0ZWQgZGlnaXRzIGFuZAogKiAgICAgICAgICJ1bmlmb3JtbHkiIGRpc3RyaWJ1dGVkIGlucHV0LCB0aGUgcHJvYmFiaWxpdHkgaXMKICogICAgICAgICBzb21ldGhpbmcgbGlrZSAxMF4oay0xNSkgdGhhdCB3ZSBtdXN0IHJlc29ydCB0byB0aGUgTG9uZwogKiAgICAgICAgIGNhbGN1bGF0aW9uLgogKi8KCi8qIEFkZGl0aW9uYWwgbm90ZXMgKE1FVEQpOiAoMSkgcmV0dXJucyBOVUxMIG9uIGZhaWx1cmUuICAoMikgdG8gYXZvaWQgbWVtb3J5CiAgIGxlYWthZ2UsIGEgc3VjY2Vzc2Z1bCBjYWxsIHRvIF9QeV9kZ19kdG9hIHNob3VsZCBhbHdheXMgYmUgbWF0Y2hlZCBieSBhCiAgIGNhbGwgdG8gX1B5X2RnX2ZyZWVkdG9hLiAqLwoKY2hhciAqCl9QeV9kZ19kdG9hKGRvdWJsZSBkZCwgaW50IG1vZGUsIGludCBuZGlnaXRibG9jaywgYmxvY2tzW25leHRdKTsgICAvLyBhbmQgc2V0IG5leHQ7IG5vdGU6IHdlIG1heSBoYXZlIGBjdXJyZW50ID09IG5leHRgCiAgICBjdXJyZW50ID0gbmV4dDsKICB9CiAgLy8gcHJlcGVuZCB0byB0aGUgZnJlZSBsaXN0ICh1c3VhbGx5IE5VTEwpCiAgbWlfYmxvY2tfc2V0X25leHQocGFnZSwgYmxvY2tzW2N1cnJlbnRdLCBwYWdlLT5mcmVlKTsgIC8vIGVuZCBvZiB0aGUgbGlzdAogIHBhZ2UtPmZyZWUgPSBmcmVlX3N0YXJ0Owp9CgpzdGF0aWMgbWlfZGVjbF9ub2lubGluZSB2b2lkIG1pX3BhZ2VfZnJlZV9saXN0X2V4dGVuZCggbWlfcGFnZV90KiBjb25zdCBwYWdlLCBjb25zdCBzaXplX3QgYnNpemUsIGNvbnN0IHNpemVfdCBleHRlbmQsIG1pX3N0YXRzX3QqIGNvbnN0IHN0YXRzKQp7CiAgTUlfVU5VU0VEKHN0YXRzKTsKICAjaWYgKE1JX1NFQ1VSRSA8PSAyKQogIG1pX2Fzc2VydF9pbnRlcm5hbChwYWdlLW1hdHMgYnkgcGVlcmluZyBhdCB0aGUgYml0cyBvZiBzb21lCiAgICAgICBjYXJlZnVsbHkgY2hvc2VuIHZhbHVlcy4gIElmIGl0IGxvb2tzIGxpa2Ugd2UgYXJlIG9uIGFuCiAgICAgICBJRUVFIHBsYXRmb3JtLCB0aGUgZmxvYXQgcGFja2luZy91bnBhY2tpbmcgcm91dGluZXMgY2FuCiAgICAgICBqdXN0IGNvcHkgYml0cywgaWYgbm90IHRoZXkgcmVzb3J0IHRvIGFyaXRobWV0aWMgJiBzaGlmdHMKICAgICAgIGFuZCBtYXNrcy4gIFRoZSBzaGlmdHMgJiBtYXNrcyBhcHByb2FjaCB3b3JrcyBvbiBhbGwgZmluaXRlCiAgICAgICB2YWx1ZXMsIGJ1dCB3aGF0IGhhcHBlbnMgdG8gaW5maW5pdGllcywgTmFOcyBhbmQgc2lnbmVkCiAgICAgICB6ZXJvZXMgb24gcGFja2luZyBpcyBhbiBhY2NpZGVudCwgYW5kIGF0dGVtcHRpbmcgdG8gdW5wYWNrCiAgICAgICBhIE5hTiBvciBhbiBpbmZpbml0eSB3aWxsIHJhaXNlIGFuIGVtaW5hdG9yID09IE5VTEwpCiAgICAgICAgICAgIGdvdG8gZXJyb3I7CiAgICB9CgogICAgcmVzdWx0X3BhaXIgPSBQeVR1cGxlX1BhY2soMiwgbnVtZXJhdG9yLCBkZW5vbWluYXRvcik7CgplcnJvcjoKICAgIFB5X1hERUNSRUYocHlfZXhwb25lbnQpOwogICAgUHlfWERFQ1JFRihkZW5vbWluYXRvcik7CiAgICBQeV9YREVDUkVGKG51bWVyYXRvcik7CiAgICByZXR1cm4gcmVzdWx0X3BhaXI7Cn0KCnN0YXRpYyBQeU9iamVjdCAqCmZsb2F0X3N1YnR5cGVfbmV3KFB5VHlwZU9iamVjdCAqdHlwZSwgUHlPYmplY3QgKngpOwoKLypbY2xpbmljIGlucHV0XQpAY2xhc3NtZXRob2QKZmxvYXQuX19uZXdfXyBhcyBmbG9hdF9uZXcKICAgIHg6IG9iamVjdChjX2RlZmF1bHQ9Ik5VTEwiKSA9IDAKICAgIC8KCkNvbnZlcnQgYSBzdHJpbmcgb3IgbnVtYmVyIHRvIGEgZmxvYXRpbmctcG9pbnQgbnVtYmVyLCBpZiBwb3NzaWJsZS4KW2MpIDIwMDIgICAgICBGcmVkIEwuIERyYWtlLCBKci4gPGZkcmFrZUB1c2Vycy5zb3VyY2Vmb3JnZS5uZXQ+CiAgIENvcHlyaWdodCAoYykgMjAwMi0yMDA2IEthcmwgV2FjbGF3ZWsgPGthcmxAd2FjbGF3ZWsubmV0PgogICBDb3B5cmlnaHQgKGMpIDIwMTctMjAyMSBTZWJhc3RpYW4gUGlwcGluZyA8c2ViYXN0aWFuQHBpcHBpbmcub3JnPgogICBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2U6CgogICBQZXJtaXNzaW9uIGlzICBoZXJlYnkgZ3JhbnRlZCwgIGZyZWUgb2YgY2hhcmdlLCAgdG8gYW55ICBwZXJzb24gb2J0YWluaW5nCiAgIGEgIGNvcHkgIG9mICB0aGlzICBzb2Z0d2FyZSAgIGFuZCAgYXNzb2NpYXRlZCAgZG9jdW1lbnRhdGlvbiAgZmlsZXMgICh0aGUKICAgIlNvZnR3YXJlIiksICB0byAgZGVhbCBpbiAgdGhlICBTb2Z0d2FyZSAgd2l0aG91dCByZXN0cmljdGlvbiwgIGluY2x1ZGluZwogICB3aXplX3QoYWxsb3dfbmVnYXRpdmU9RmFsc2UpID0gMAogICAgaGk6IFB5X3NzaXplX3QoY19kZWZhdWx0PSctMScsIGFjY2VwdD17aW50LCBOb25lVHlwZX0pID0gTm9uZQogICAgKgogICAga2V5OiBvYmplY3QgPSBOb25lCgpSZXR1cm4gdGhlIGluZGV4IHdoZXJlIHRvIGluc2VydCBpdGVtIHggaW4gbGlzdCBhLCBhc3N1bWluZyBhIGlzIHNvcnRlZC4KClRoZSByZXR1cm4gdmFsdWUgaSBpcyBzdWNoIHRoYXQgYWxsIGUgaW4gYVs6aV0gaGF2ZSBlIDw9IHgsIGFuZCBhbGwgZSBpbgphW2k6XSBoYXZlIGUgPiB4LiAgU28gaWYgeCBhbHJlYWR5IGFwcGVhcnMgaW4gdGhlIGxpc3QsIGEuaW5zZXJ0KGksIHgpIHdpbGwKaW5zZXJ0IGp1c3QgYWZ0ZXIgdGhlIHJpZ2h0bW9zdCB4IGFscmVhZHkgdGhlcmUuCgpPcHRpb25hbCBhcmdzIGxvIChkZWZhdWx0IDApIGFuZCBoaSAoZGVmYXVsdCBsZW4oYSkpIGJvdW5kIHRoZQpzbGljZW8gYWxsCiAgIGxvd2VyIGNhc2UuIFRoaXMgbWFrZXMgZW5jb2RpbmdzIGxvb2tlZCB1cCB0aHJvdWdoIHRoaXMgbWVjaGFuaXNtCiAgIGVmZmVjdGl2ZWx5IGNhc2UtaW5zZW5zaXRpdmUuIFNwYWNlcyBhcmUgcmVwbGFjZWQgd2l0aCBoeXBoZW5zIGZvcgogICBuYW1lcyBsaWtlICJVUyBBU0NJSSIgYW5kICJJU08gODg1OS0xIi4KCiAgIElmIG5vIGNvZGVjIGlzIGZvdW5kLCBhIExvb2t1cEVycm9yIGlzIHNldCBhbmQgTlVMTCByZXR1cm5lZC4KCiAgIEFzIHNpZGUgZWZmZWN0LCB0aGlzIHRyaWVzIHRvIGxvYWQgdGhlIGVuY29kaW5ncyBwYWNrYWdlLCBpZiBub3QKICAgeWV0IGRvbmUuIFRoaXMgaXMgcGFydCBvZiB0aGUgbGF6eSBsb2FkIHN0cmF0ZWd5IGZvciB0aGUgZW5jb2RpbmdzCiAgIHBhY2thZ2UuCgoqLwoKUHlPYmplY3QgKl9QeUNvZGVjX0xvb2t1cChjb25zdCBjaGFyICplbmNvZGluZykKewpzcGx1cykKfQojZW5kaWYKCiNkZWZpbmUgSGFjbF9IYXNoX1NIQTFfSF9ERUZJTkVECiNlbmRpZiAvKiBIYWNsX0hhc2hfU0hBMV9IICovCi8vIFRoaXMgaXMgdGhlIGltcGxlbWVudGF0aW9uIG9mIFB5dGhvbiBhdG9taWMgb3BlcmF0aW9ucyBmb3IgTVNWQyBpZiB0aGUKLy8gY29tcGlsZXIgZG9lcyBub3Qgc3VwcG9ydCBDMTEgb3IgQysrMTEgYXRvbWljcy4KLy8KLy8gTVNWQyBpbnRyaW5zaWNzIGFyZSBkZWZpbmVkIG9uIGNoYXIsIHNob3J0LCBsb25nLCBfX2ludDY0LCBhbmQgcG9pbnRlcgovLyB0eXBlcy4gTm90ZSB0aGF0IGxvbmcgYW5kIGludCBhcmUgYm90aCAzMi1iaXRzIGV2ZW4gb24gNjQtYml0IFdpbmRvd3MsCi8vIHNvIG9wZXJhdGlvbnMgb24gaW50IGFyZSBjYXN0IHRvIGxvbmcuCi8vCi8vIFRoZSB2b2xhdGlsZSBrZXl3b3JkIGhhcyBhZGRpdGlvbmFsIG1lbW9yeSBvcmRlcmluZyBzZW1hbnRpY3Mgb25jb3JlX3B5YXRvbWljX2Z0X3dyYXBwZXJzLmgiCiNpbmNsdWRlICJweWNvcmVfcHlsaWZlY3ljbGUuaCIgICAvLyBfUHlfU2V0TG9jYWxlRnJvbUVudigpCgojaW5jbHVkZSA8ZXJybm8uaD4gICAgICAgICAgICAgICAgLy8gZXJybm8KI2luY2x1ZGUgPHNpZ25hbC5oPiAgICAgICAgICAgICAgIC8vIFNJR1dJTkNICiNpbmNsdWRlIDxzdGRsaWIuaD4gICAgICAgICAgICAgICAvLyBmcmVlKCkKI2luY2x1ZGUgPHN0cmluZy5oPiAgICAgICAgICAgICAgIC8vIHN0cmR1cCgpCiNpZmRlZiBIQVZFX1NZU19TRUxFQ1RfSAojICBpbmNsdWRlIDxzeXMvc2VsZWN0Lmg+ICAgICAgICAgLy8gc2VsZWN0KCkKI2VuZGlmCgojaWYgZGVmaW5lZChIQVZFX1NFVExPQ0FMRSkKLyogR05VIHJlYWRsaW5lKCkgbWlzdGFrZW5seSBzZXRzIHRoZSBMQ19DVFlQRSBsb2NhbGUuCiAqIFRoaXMgaXMgZXZpbC4gIE9ubHkgdGhlIHVzZXIgb3IgdGggICAgImNhbid0IGdldCBzaXplIHdpdGggdHJhY2tmZD1GYWxzZSIpOwogICAgICAgIHJldHVybiBOVUxMOwogICAgfQp9CgovKiBUaGlzIGFzc3VtZXMgdGhhdCB5b3Ugd2FudCB0aGUgZW50aXJlIGZpbGUgbWFwcGVkLAogLyBhbmQgd2hlbiByZWNyZWF0aW5nIHRoZSBtYXAgd2lsbCBtYWtlIHRoZSBuZXcgZmlsZQogLyBoYXZlIHRoZSBuZXcgc2l6ZQogLwogLyBJcyB0aGlzIHJlYWxseSBuZWNlc3Nhcnk/ICBUaGlzIGNvdWxkIGVhc2lseSBiZSBkb25lCiAvIGZyb20gcHl0aG9uIGJ5IGp1c3QgY2xvc2luZyBhbmQgcmUtb3BlbmluZyB3aXRoIHRoZQogLyBuZXcgc2l6ZT8KICovCgojaWYgZGVmaW5lZChNU19XSU5ET1dTKSB8fCBkZWZpbmVkKEhBVkVfTVJFTUFQKQovKltjbGluaWMgaW5wdXRdCkBjcml0aWNhbF9zZWN0aW9uCm1tYXAubW1hcC5yZXNpemUKCiAgICBuZXdzaXplIGFzIG5ld19zaXplOiBQeV9zZSBQeV9ERUJVRyAxCiNlbmRpZgoKLyogRGVmaW5lIHRvIDEgd2hlbiBjb21waWxpbmcgZm9yIGV4cGVyaW1lbnRhbCBmcmVlLXRocmVhZGVkIGJ1aWxkcyAqLwojaWZkZWYgUHlfR0lMX0RJU0FCTEVECi8qIFdlIHVuZGVmaW5lIGlmIGl0IHdhcyBzZXQgdG8gemVybyBiZWNhdXNlIGFsbCBsYXRlciBjaGVja3MgYXJlICNpZmRlZi4KICogTm90ZSB0aGF0IG5vbi1XaW5kb3dzIGJ1aWxkcyBkbyBub3QgZG8gdGhpcywgYW5kIHNvIGV2ZXJ5IGVmZm9ydCBzaG91bGQKICogYmUgbWFkZSB0byBhdm9pZCBkZWZpbmluZyB0aGUgdmFyaWFibGUgYXQgYWxsIHdoZW4gbm90IGRlc2lyZWQuIEhvd2V2ZXIsCiAqIHN5c2NvbmZpZy5nZXRfY29uZmlnX3ZhciBhbHdheXMgcmV0dXJucyBhIDEgb3IgYSAwLCBhbmQgc28gaXQgc2VlbXMgbGlrZWx5CiAqIHRoYXQgYSBidWlsZCBiYWNrZW5kIHdpbGwgZGVmaW5lIGl0IHdpb2RlcyBkbyBub3Qgc3RvcmUga2V5IG9iamVjdHMgb3IgdmFsdWUgb2JqZWN0cy4gIFRoZXkgYXJlIHVzZWQKb25seSBhcyBhbiBpbmRpcmVjdGlvbiBsZXZlbCAtIHRoZWlyIHBvaW50ZXJzIHBvaW50IHRvIG90aGVyIG5vZGVzIGluCnRoZSB0cmVlLgoKCkJpdG1hcCBOb2RlCi0tLS0tLS0tLS0tCgpBbGxvY2F0aW5nIGEgbmV3IDMyLXBvaW50ZXJzIGFycmF5IGZvciBldmVyeSBub2RlIG9mIG91ciB0cmVlIHdvdWxkIGJlCnZlcnkgZXhwZW5zaXZlLiAgVW5sZXNzIHdlIHN0b3JlIG1pbGxpb25zIG9mIGtleXMsIG1vc3Qgb2YgdHJlZSBub2RlcyB3b3VsZApiZSB2ZXJ5IHNwYXJzZS4KCldoZW4gd2UgaGF2ZSBsZXNzIHRoYW4gMTYgZWxlbWVudHMgaW4gYSBub2RlLCB3ZSBkb24ndCB3YW50IHRvIHVzZSB0aGUKQXJyYXkgbm9kZSwgdGhhdCB3b3VsZCBtZWFuIHRoYXQgd2Ugd2FzdGUgYSBsb3Qgb2YgbWVtb3J5LiAgSW5zLT5kaWN0LCBkaWN0KTsKICAgIHBhcnRpYWxfc2V0dmVjdG9yY2FsbChwdG8pOwogICAgUHlfUkVUVVJOX05PTkU7Cn0KCnN0YXRpYyBQeU1ldGhvZERlZiBwYXJ0aWFsX21ldGhvZHNbXSA9IHsKICAgIHsiX19yZWR1Y2VfXyIsIHBhcnRpYWxfcmVkdWNlLCBNRVRIX05PQVJHU30sCiAgICB7Il9fc2V0c3RhdGVfXyIsIHBhcnRpYWxfc2V0c3RhdGUsIE1FVEhfT30sCiAgICB7Il9fY2xhc3NfZ2V0aXRlbV9fIiwgICAgUHlfR2VuZXJpY0FsaWFzLAogICAgTUVUSF9PfE1FVEhfQ0xBU1MsICAgICAgIFB5RG9jX1NUUigiU2VlIFBFUCA1ODUiKX0sCiAgICB7TlVMTCwgICAgICAgICAgICAgIE5VTEx9ICAgICAgICAgICAvKiBzZW50aW5lbCAqLwp9OwoKc3RhdGljIFB5VHlwZV9TbG90IHBhcnRpYWxfdHlwZV9zbG90c1tdID0gewogICAge1B5X3RwX2RlYWxsb2MsIHBhcnRpYWxfZGVhbGxvY30sCiAgICB7UHlfdHBfcmVwciwgZWxmLCAicmVhZGxpbmUgb2YgY2xvc2VkIGZpbGUiKQoKICAgIC8qIEZpcnN0LCB0cnkgdG8gZmluZCBhIGxpbmUgaW4gdGhlIGJ1ZmZlci4gVGhpcyBjYW4gcnVuIHVubG9ja2VkIGJlY2F1c2UKICAgICAgIHRoZSBjYWxscyB0byB0aGUgQyBBUEkgYXJlIHNpbXBsZSBlbm91Z2ggdGhhdCB0aGV5IGNhbid0IHRyaWdnZXIKICAgICAgIGFueSB0aHJlYWQgc3dpdGNoLiAqLwogICAgbiA9IFB5X1NBRkVfRE9XTkNBU1QoUkVBREFIRUFEKHNlbGYpLCBQeV9vZmZfdCwgUHlfc3NpemVfdCk7CiAgICBpZiAobGltaXQgPj0gMCAmJiBuID4gbGltaXQpCiAgICAgICAgbiA9IGxpbWl0OwogICAgc3RhcnQgPSBzZWxmLT5idWZmZXIgKyBzZWxmLT5wb3M7CiAgICBzID0gbWVtY2hyKHN0YXJ0LCAnXG4nLCBuKTsKICAgIGlmIChzICE9IE5VTEwpIHsKICAgICAgICByZXMgPSBQeUJ5dGVzX0Zyb21TdHJpbmdBbmRTaXplKHN0YXJ0LCBzICAgeyJ2ZXJzaW9uIiwgIm5hbWUgYW5kIHZlcnNpb24gb2YgdGhlIHRocmVhZCBsaWJyYXJ5In0sCiAgICB7MH0KfTsKCnN0YXRpYyBQeVN0cnVjdFNlcXVlbmNlX0Rlc2MgdGhyZWFkaW5mb19kZXNjID0gewogICAgInN5cy50aHJlYWRfaW5mbyIsICAgICAgICAgICAvKiBuYW1lICovCiAgICB0aHJlYWRpbmZvX19kb2NfXywgICAgICAgICAgIC8qIGRvYyAqLwogICAgdGhyZWFkaW5mb19maWVsZHMsICAgICAgICAgICAvKiBmaWVsZHMgKi8KICAgIDMKfTsKCnN0YXRpYyBQeVR5cGVPYmplY3QgVGhyZWFkSW5mb1R5cGU7CgpQeU9iamVjdCoKUHlUaHJlYWRfR2V0SW5mbyh2b2lkKQp7CiAgICBQeU9iamVjdCAqdGhyZWFkaW5mbywgKnZhbHVlOwogICAgaW50IHBvcyA9IDA7CiNpZiAoZGVmaW5lZChfUE9TSVhfVEhSRUFEUykgJiYgZGVmaW5lZChIQVZFX0NPTkZTVFIpIFwKICAgICAmJiBkZWZpbmVkKF9DU19HTlVfTElCaGFyICpoZWFkZXIgPSBFWENFUFRJT05fVEJfSEVBREVSOwogICAgcmV0dXJuIF9QeVRyYWNlQmFja19QcmludCh2LCBoZWFkZXIsIGYpOwp9CgovKiBGb3JtYXQgYW4gaW50ZWdlciBpbiByYW5nZSBbMDsgMHhmZmZmZmZmZl0gdG8gZGVjaW1hbCBhbmQgd3JpdGUgaXQKICAgaW50byB0aGUgZmlsZSBmZC4KCiAgIFRoaXMgZnVuY3Rpb24gaXMgc2lnbmFsIHNhZmUuICovCgp2b2lkCl9QeV9EdW1wRGVjaW1hbChpbnQgZmQsIHNpemVfdCB2YWx1ZSkKewogICAgLyogbWF4aW11bSBudW1iZXIgb2YgY2hhcmFjdGVycyByZXF1aXJlZCBmb3Igb3V0cHV0IG9mICVsbGQgb3IgJXAuCiAgICAgICBXZSBuZWVkIGF0IG1vc3QgY2VpbChsb2cxMCgyNTYpKlNJWkVPRl9MT05HX0xPTkcpIGRpZ2l0cywKICAgICAgIHBsdXMgMSBmb3IgdGhlIG51bGwgYnl0ZS4gIDUzLzIyIGlzIGFuIHVwcGVyIGJvdW5kIGZvciBsb2cxMCgyNTYpLiAqX25ld19kZXNjcl9vYmplY3QoY3R4LCB0eXBlX3ZlcnNpb24pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGZfb3JfbnVsbCA9IHN5bV9uZXdfbm90X251bGwoY3R4KTsKICAgICAgICB9CiAgICB9CgogICAgb3AoX0NSRUFURV9JTklUX0ZSQU1FLCAoaW5pdCwgc2VsZiwgYXJnc1tvcGFyZ10gLS0gaW5pdF9mcmFtZSkpIHsKICAgICAgICBjdHgtPmZyYW1lLT5zdGFja19wb2ludGVyID0gc3RhY2tfcG9pbnRlciAtIG9wYXJnIC0gMjsKICAgICAgICBfUHlfVU9wc0Fic3RyYWN0RnJhbWUgKnNoaW0gPSBmcmFtZV9uZXcoY3R4LCAoUHlDb2RlT2JqZWN0ICopJl9QeV9Jbml0Q2xlYW51cCwgMCwgTlVMTCwgMCk7CiAgICAgICAgaWYgKHNoaW0gPT0gTlVMTCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgLyogUHVzaCBzZWxmIG9udG8gc3RhY2sgb2Ygc2hpbSAqLwogICAgICAgIHNoaW0tZWFucyB3aGVuIHRoZQovLyBjdXJyZW50IGZyZWUgcGFnZSBxdWV1ZSBpcyB1cGRhdGVkIGZvciBhIHNtYWxsIGJpbiwgd2UgbmVlZCB0byB1cGRhdGUgYQovLyByYW5nZSBvZiBlbnRyaWVzIGluIGBfbWlfcGFnZV9zbWFsbF9mcmVlYC4Kc3RhdGljIGlubGluZSB2b2lkIG1pX2hlYXBfcXVldWVfZmlyc3RfdXBkYXRlKG1pX2hlYXBfdCogaGVhcCwgY29uc3QgbWlfcGFnZV9xdWV1ZV90KiBwcSkgewogIG1pX2Fzc2VydF9pbnRlcm5hbChtaV9oZWFwX2NvbnRhaW5zX3F1ZXVlKGhlYXAscHEpKTsKICBzaXplX3Qgc2l6ZSA9IHBxLT5ibG9ja19zaXplOwogIGlmIChzaXplID4gTUlfU01BTExfU0laRV9NQVgpIHJldHVybjsKCiAgbWlfcGFnZV90KiBwYWdlID0gcHEtPmZpcnN0OwogIGlmIChwcS0+Zmlyc3QgPT0gTlVMTCkgcGFnZSA9IChtaV9wYWdlX3QqKSZfbWlfcGFnZV9lbXB0eTsKCiAgLy8gZmluZCBpbmRleCBpbiB0aG0sCi8vIGJ1dCBhbnkgY3J5cHRvIGNvZGUgdGhhdCBkZXBlbmRzIG9uIHRoZSBzcGVlZCBvZgovLyBkaXZpc2lvbiBpcyBlcXVhbGx5IGR1bWIuCgovL2dvOmJ1aWxkIGlnbm9yZQoKI2luY2x1ZGUgPHN0ZGlvLmg+CiNpbmNsdWRlIDxzdGRpbnQuaD4KCiNkZWZpbmUgbmVsZW0oeCkgKHNpemVvZih4KS9zaXplb2YoKHgpWzBdKSkKCnR5cGVkZWYgdWludDMyX3QgdTMyOwoKc3RhdGljIHUzMiBkaXYodTMyIHgsIHUzMiB5LCB1MzIgKnJwKSB7CglpbnQgbiA9IDA7Cgl3aGlsZSgoeT4+KDMyLTEpKSAhPSAxICYmIHkgPCB4KSB7CgkJeTw8PTE7CgkJbisrOwoJfQoJdTMyIHEgPSAwOwoJZm9yKDs7IG4tLSwgeT4+PTEsIHE8PD0xKSB7CgkJaWYoeD49eSkgewoJCQl4IC09IHk7CgkJCXEgfD0gMTsKCQl9CgkJaWYobiA9PSAwKQoJCQlicmVhazsKCX0KCWlmKHJwKQoJCSpycCA9IHg7CglyZXR1cm4gcTsKfQoKdTMyIHRlc3RzdCBsZW4gPSBkYXRhLT5sZW47CgogICAgICAgIFB5X0JFR0lOX0FMTE9XX1RIUkVBRFMKICAgICAgICAvKiBBdm9pZCB0cnVuY2F0aW9uIG9mIGxlbmd0aCBmb3IgdmVyeSBsYXJnZSBidWZmZXJzLiBjcmMzMigpIHRha2VzCiAgICAgICAgICAgbGVuZ3RoIGFzIGFuIHVuc2lnbmVkIGludCwgd2hpY2ggbWF5IGJlIG5hcnJvd2VyIHRoYW4gUHlfc3NpemVfdC4KICAgICAgICAgICBXZSBmdXJ0aGVyIGxpbWl0IHNpemUgZHVlIHRvIGJ1Z3MgaW4gQXBwbGUncyBtYWNPUyB6bGliLgogICAgICAgICAgIFNlZSBodHRwczovL2dpdGh1Yi5jb20vcHl0aG9uL2NweXRob24vaXNzdWVzLzEwNTk2NwogICAgICAgICAqLwojZGVmaW5lIFpMSUJfQ1JDX0NIVU5LX1NJWkUgMHg0MDAwMDAwMAojaWYgWkxJQl9DUkNfQ0hVTktfU0laRSA+IElOVF9NQVgKIyBlcnJvciAidW5zdXBwb3J0ZWQgbGVzcyB0aGFuIDMyLWJpdCBwbGF0Zm9ybT8iICAgICB2b2lkICp1c2VyRGF0YSkgewogIEVOQ09ESU5HICplbmMgPSBYbWxJbml0VW5rbm93bkVuY29kaW5nKG1lbSwgdGFibGUsIGNvbnZlcnQsIHVzZXJEYXRhKTsKICBpZiAoZW5jKQogICAgKChzdHJ1Y3Qgbm9ybWFsX2VuY29kaW5nICopZW5jKS0+dHlwZVtBU0NJSV9DT0xPTl0gPSBCVF9DT0xPTjsKICByZXR1cm4gZW5jOwp9CgojZW5kaWYgLyogWE1MX05TICovCi8qIHRoaXMgaXMgc29ydCBvZiBhIGhhY2suICB0aGVyZSdzIGF0IGxlYXN0IG9uZSBwbGFjZSAoZm9ybWF0dGluZwogICBmbG9hdHMpIHdoZXJlIHNvbWUgc3RyaW5nbGliIGNvZGUgdGFrZXMgYSBkaWZmZXJlbnQgcGF0aCBpZiBpdCdzCiAgIGNvbXBpbGVkIGFzIHVuaWNvZGUuICovCiNkZWZpbmUgU1RSSU5HTElCX0lTX1VOSUNPREUgICAgIDEKCiNkZWZpbmUgRkFTVFNFQVJDSCAgICAgICAgICAgICAgIHVjczJsaWJfZmFzdHNlYXJjaAojZGVmSGFzaF9CbGFrZTJzX3N0YXRlX3Q7CgovKioKIEdlbmVyYWwtcHVycG9zZSBhbGxvY2F0aW9uIGZ1bmN0aW9uIHRoYXQgZ2l2ZXMgY29udHJvbCBvdmVyIGFsbApCbGFrZTIgcGFyYW1ldGVycywgaW5jbHVkaW5nIHRoZSBrZXkuIEZ1cnRoZXIgcmVzZXR0aW5ncyBvZiB0aGUgc3RhdGUgU0hBTEwgYmUKZG9uZSB3aXRoIGByZXNldF93aXRoX3BhcmFtc19hbmRfa2V5YCwgYW5kIFNIQUxMIGZlYXR1cmUgdGhlIGV4YWN0IHNhbWUgdmFsdWVzCmZvciB0aGUgYGtleV9sZW5ndGhgIGFuZCBgZGlnZXN0X2xlbmd0aGAgZmllbGRzIGFzIHBhc3NlZCBoZXJlLiBJbiBvdGhlciB3b3JkcywKb25jZSB5b3UgY29tbWl0IHRvIGEgZGlnZXN0IGFuZCBrZXkgbGVuZ3RoLCB0aGUgb25seSB3YXkgdG8gY2hhbmdlIHRoZXNlCnBhcmFtZXRlcnMgaXMgdG8gYWxsb2NhdGUgYSBuZXcgb2JqZWN0LgoKVGhlIGNhbGxlciBtdXN0IHNhdGlzZnkgRnJhbWUgKnB5ZnJhbWUsIGZyYW1lX3QgKmZyYW1lKQp7CiAgICBhc3NlcnQoUHlTdGFja1JlZl9Db2RlQ2hlY2socHlmcmFtZS0+Zl9leGVjdXRhYmxlKSk7CiAgICBmcmFtZS0+ZmlsZW5hbWUgPSAmX1B5X1NUUihhbm9uX3Vua25vd24pOwoKICAgIGludCBsaW5lbm8gPSBQeVVuc3RhYmxlX0ludGVycHJldGVyRnJhbWVfR2V0TGluZShweWZyYW1lKTsKICAgIGlmIChsaW5lbm8gPCAwKSB7CiAgICAgICAgbGluZW5vID0gMDsKICAgIH0KICAgIGZyYW1lLT5saW5lbm8gPSAodW5zaWduZWQgaW50KWxpbmVubzsKCiAgICBQeU9iamVjdCAqZmlsZW5hbWUgPSBfUHlGcmFtZV9HZXRDb2RlKHB5ZnJhbWUpLT5jb19maWxlbmFtZTsKICAgIGlmIChmaWxlbmFtZSA9PSBOVUxMKSB7CiNpZmRlZiBUUkFDRV9ERUJVRwogICAgICAgIHRyYWNlbWFsbG9jX2Vycm9yKCJmYWlsZWQgdG8gZ2V0IHRoZSBmaWxlbmFtZSBvZiB0aGUgY29kZXMgZGVjbGFyZSBpdCBkaWZmZXJlbnQuCiAgIFdvcnNlLCBvbiBzb21lIExpbnV4ZXMsIGdldHBhZ2VzaXplKCkgcmV0dXJucyBhIHNpemVfdC4uLiAqLwoKI2RlZmluZSBkb3VibGV0aW1lKFRWKSAoKGRvdWJsZSkoVFYpLnR2X3NlYyArIChUVikudHZfdXNlYyAqIDAuMDAwMDAxKQoKLypbY2xpbmljIGlucHV0XQptb2R1bGUgcmVzb3VyY2UKW2NsaW5pYyBzdGFydCBnZW5lcmF0ZWQgY29kZV0qLwovKltjbGluaWMgZW5kIGdlbmVyYXRlZCBjb2RlOiBvdXRwdXQ9ZGEzOWEzZWU1ZTZiNGIwZCBpbnB1dD1lODlkMzhlZDUyNjA5ZDdjXSovCgovKltweXRob24gaW5wdXRdCmNsYXNzIHBpZF90X2NvbnZlcnRlcihDQ29udmVydGVyKToKICAgIHR5cGUgPSAncGlkX3QnCiAgICBmb3JtYXRfdW5pdCA9ICciIF9QeV9QQVJTRV9QSUQgIicKCiAgICBkZWYgcGFyc2VfYXJnKHNlbGYsIGFyZ25hbWUsIGRpc3BsYXluYW1lLCAqLCBsbHQgPSBQeU9iamVjdF9DYWxsKHJlZ2lzdGVyX2F0X2ZvcmssIGFyZ3MsIGt3YXJncyk7CgpmaW5hbGx5OgogICAgaWYgKFB5RXJyX09jY3VycmVkKCkpIHsKICAgICAgICAvLyBUaGVyZSBhcmUgYSBmZXcgcmVhc29ucyByZWdpc3RyYXRpb24gY2FuIGZhaWwsIGVzcGVjaWFsbHkgaWYgc29tZW9uZQogICAgICAgIC8vIHRvdWNoZWQgcG9zaXgucmVnaXN0ZXJfYXRfZm9yay4gQnV0IGV2ZXJ5dGhpbmcgZWxzZSBzdGlsbCB3b3JrcyBzbwogICAgICAgIC8vIGluc3RlYWQgb2YgcmFpc2luZyB3ZSBpc3N1ZSBhIHdhcm5pbmcgYW5kIG1vdmUgYWxvbmcuCiAgICAgICAgUHlPYmplY3QgKmV4YyA9IFB5RXJyX0dldFJhaXNlZEV4Y2VwdGlvbigpOwogICAgICAgIFB5T2JqZWN0ICpleGN0eXBlID0gKFB5T2JqZWN0KilQeV9UWVBFKGV4Yyk7CiAgICAgICAgUHlFcnJfV2FybkZvcm1hdChQeUV4Y19SdW50aW1lV2FybmluZywgMSwKdG5vdGVzLnR4dCwKICAgZGVzY3JpYmluZyBleHBsb3JhdGlvbnMgaW50byBkaWN0aW9uYXJ5IGRlc2lnbiBhbmQgb3B0aW1pemF0aW9uLgogICBJdCBjb3ZlcnMgdHlwaWNhbCBkaWN0aW9uYXJ5IHVzZSBwYXR0ZXJucywgdGhlIHBhcmFtZXRlcnMgZm9yCiAgIHR1bmluZyBkaWN0aW9uYXJpZXMsIGFuZCBzZXZlcmFsIGlkZWFzIGZvciBwb3NzaWJsZSBvcHRpbWl6YXRpb25zLgoqLwoKUHlBUElfREFUQShQeVR5cGVPYmplY3QpIFB5RGljdF9UeXBlOwoKI2RlZmluZSBQeURpY3RfQ2hlY2sob3ApIFwKICAgICAgICAgICAgICAgICBQeVR5cGVfRmFzdFN1YmNsYXNzKFB5X1RZUEUob3ApLCBQeV9UUEZMQUdTX0RJQ1RfU1VCQ0xBU1MpCiNkZWZpbmUgUHlEaWN0X0NoZWNrRXhhY3Qob3ApIFB5X0lTX1RZUEUoKG9wKSwgJlB5RGljdF9UeXBlKQoKUHlBUElfRlVOQyhQeU9iamVjdCAqKSBQeURpY3RfTmV3KHZvaWQpOwpQeUFQZSBpcyBzcGVjaWZpYyBmb3IgZnJhbWUgb2JqZWN0cyAqLwoKLyogQ29udmVyc2lvbnMgYmV0d2VlbiAiZmFzdCBsb2NhbHMiIGFuZCBsb2NhbHMgaW4gZGljdGlvbmFyeSAqLwoKUHlBUElfRlVOQyh2b2lkKSBQeUZyYW1lX0xvY2Fsc1RvRmFzdChQeUZyYW1lT2JqZWN0ICosIGludCk7CgovKiAtLSBDYXZlYXQgZW1wdG9yIC0tCiAqIFRoZSBjb25jZXB0IG9mIGVudHJ5IGZyYW1lcyBpcyBhbiBpbXBsZW1lbnRhdGlvbiBkZXRhaWwgb2YgdGhlIENQeXRob24KICogaW50ZXJwcmV0ZXIuIFRoaXMgQVBJIGlzIGNvbnNpZGVyZWQgdW5zdGFibGUgYW5kIGlzIHByb3ZpZGVkIGZvciB0aGUKICogY29udmVuaWVuY2Ugb2YgZGVidWdnZXJzLCBwcm9maWxlcnMgYW5kIHN0YXRlLWluc3BlY3RpbmcgdG9vbHMuIE5vdGljZSB0aGF0CiAqIHRoaXMgQVBJIGNhbiBiZSBjaGFuZ2VkIGluIGZ1dHVyZSBtaW5vciB2ZXJzaW9ucyBpZiB0IGNhbmNlbF9kdW1wX3RyYWNlYmFja19sYXRlcigpOwogICAgUHlfUkVUVVJOX05PTkU7Cn0KCgojaWZkZWYgRkFVTFRIQU5ETEVSX1VTRVIKc3RhdGljIGludApmYXVsdGhhbmRsZXJfcmVnaXN0ZXIoaW50IHNpZ251bSwgaW50IGNoYWluLCBfUHlfc2lnaGFuZGxlcl90ICpwcmV2aW91c19wKQp7CiNpZmRlZiBIQVZFX1NJR0FDVElPTgogICAgc3RydWN0IHNpZ2FjdGlvbiBhY3Rpb247CiAgICBhY3Rpb24uc2FfaGFuZGxlciA9IGZhdWx0aGFuZGxlcl91c2VyOwogICAgc2lnZW1wdHlzZXQoJmFjdGlvbi5zYV9tYXNrKTsKICAgIC8qIGlmIHRoZSBzaWduYWwgaXMgcmVjZWl2ZWQgd2hpbGUgdGhlIGtlcm5lbCBpcyBleGVjdXRpbmcgYSBzeXN0ZW0KICAgICAgIGNhbGwsIHRyeSB0byByZXN0YXJ0IHRoZSBzeXN0ZW0gY2FsbCBpbnN0ZWFkIG9mIGludGVycnVwdGluZyBpdCBhbmQKICAgICAgIHJldHVybiBFSU5UUi4gKi8KeSBiZSB3YWl0ZWQgb24gb3RoZXIgdGhyZWFkcywgd2hpY2ggY291bGQgY2F1c2VcbiIKImlzc3VlcyBmb3Igb2JqZWN0cyBsaWtlIG11dGV4ZXMgdGhhdCBiZWNvbWUgYXNzb2NpYXRlZCB3aXRoIHRoZSB0aHJlYWRcbiIKInRoYXQgd2FzIHdhaXRpbmcgZm9yIHRoZW0uIE9iamVjdHMgbWF5IGFsc28gYmUgbGVmdCBzaWduYWxsZWQsIGV2ZW4gaWZcbiIKInRoZSB3YWl0IGZhaWxzLlxuIgoiXG4iCiJJdCBpcyByZWNvbW1lbmRlZCB0byB1c2UgV2FpdEZvck11bHRpcGxlT2JqZWN0cyB3aGVuZXZlciBwb3NzaWJsZSwgYW5kXG4iCiJvbmx5IHN3aXRjaCB0byBCYXRjaGVkV2FpdEZvck11bHRpcGxlT2JqZWN0cyBmb3Igc2NlbmFyaW9zIHdoZXJlIHlvdVxuIgoiY29udHJvbCBhbGwgdGhlIGhhbmRsZXMgaW52b2x2ZWQsIHN1Y2ggYXMgeW91ciBvd24gdGhyZWFkIHBvb2wgb3JcbiIKImZpbGVzLCBhbmQgYWxsIHdhaXQgb2JqIEhBTkRMRSBoYW5kbGUsIERXT1JEIHNpemUsCiAgICAgICAgICAgICAgICAgICAgICBpbnQgdXNlX292ZXJsYXBwZWQpOwoKc3RhdGljIFB5T2JqZWN0ICoKX3dpbmFwaV9SZWFkRmlsZShQeU9iamVjdCAqbW9kdWxlLCBQeU9iamVjdCAqY29uc3QgKmFyZ3MsIFB5X3NzaXplX3QgbmFyZ3MsIFB5T2JqZWN0ICprd25hbWVzKQp7CiAgICBQeU9iamVjdCAqcmV0dXJuX3ZhbHVlID0gTlVMTDsKICAgICNpZiBkZWZpbmVkKFB5X0JVSUxEX0NPUkUpICYmICFkZWZpbmVkKFB5X0JVSUxEX0NPUkVfTU9EVUxFKQoKICAgICNkZWZpbmUgTlVNX0tFWVdPUkRTIDMKICAgIHN0YXRpYyBzdHJ1Y3QgewogICAgICAgIFB5R0NfSGVhZCBfdGhpc19pc19ub3RfdXNlZDsKICAgICAgICBQeU9iamVjdF9WQVJfSEVBRAogICAgICAgIFB5X2hhc2hfdCBvYl9oYXNoOwogICAgICAgIFB5T2JqZWN0ICpvYl9pdGVtW05VTV9LRVlXT1JEU107CiAgKSAmJiBzaXplID4gMCAmJiAoU0laRV9NQVggLyBzaXplKSA8IGNvdW50KTsKfQojZW5kaWYKCi8vIFNhZmUgbXVsdGlwbHkgYGNvdW50KnNpemVgIGludG8gYHRvdGFsYDsgcmV0dXJuIGB0cnVlYCBvbiBvdmVyZmxvdy4Kc3RhdGljIGlubGluZSBib29sIG1pX2NvdW50X3NpemVfb3ZlcmZsb3coc2l6ZV90IGNvdW50LCBzaXplX3Qgc2l6ZSwgc2l6ZV90KiB0b3RhbCkgewogIGlmIChjb3VudD09MSkgeyAgLy8gcXVpY2sgY2hlY2sgZm9yIHRoZSBjYXNlIHdoZXJlIGNvdW50IGlzIG9uZSAoY29tbW9uIGZvciBDKysgYWxsb2NhdG9ycykKICAgICp0b3RhbCA9IHNpemU7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGVsc2UgaWYgbWlfdW5saWtlbHkobWlfbXVsX292ZXJmbG93KGNvdW50LCBzaXplLCB0b3RhbCkpIHsKICAgICNpZiBNSV9ERUJVRyA+IDAKICAgIF9taV9lcnJvcl9tZXNzYWdlKEVPVkVSRkxPVywgImFsbG9jZXRlciBjcmVhdGVzIGEgbGFyZ2UgbnVtYmVyIG9mIHR1cGxlcywgbWFueSBvZiB3aGljaCB3aWxsCiAgIG5vdCBzdXJ2aXZlIHVudGlsIGdhcmJhZ2UgY29sbGVjdGlvbi4gSXQgaXMgdGhlcmVmb3JlIG5vdCB3b3J0aHdoaWxlCiAgIHRvIHVudHJhY2sgZWxpZ2libGUgdHVwbGVzIGF0IGNyZWF0aW9uIHRpbWUuCgogICBJbnN0ZWFkLCBhbGwgdHVwbGVzIGV4Y2VwdCB0aGUgZW1wdHkgdHVwbGUgYXJlIHRyYWNrZWQgd2hlbiBjcmVhdGVkLgogICBEdXJpbmcgZ2FyYmFnZSBjb2xsZWN0aW9uIGl0IGlzIGRldGVybWluZWQgd2hldGhlciBhbnkgc3Vydml2aW5nIHR1cGxlcwogICBjYW4gYmUgdW50cmFja2VkLiBBIHR1cGxlIGNhbiBiZSB1bnRyYWNrZWQgaWYgYWxsIG9mIGl0cyBjb250ZW50cyBhcmUKICAgYWxyZWFkeSBub3QgdHJhY2tlZC4gVHVwbGVzIGFyZSBleGFtaW5lZCBmb3IgdW50cmFja2luZyBpbiBhbGwgZ2FybmRsZXIoaW50IHNpZ25vLCBzaWdpbmZvX3QqIGluZm8sIHZvaWQqIGN0eHQpIHsKfQoKLy8gU2V0IHVwIHRoZSBTSUdJTyBzaWduYWwgaGFuZGxlciBpbiBhIGhpZ2ggcHJpb3JpdHkgY29uc3RydWN0b3IsIHNvCi8vIHRoYXQgaXQgaXMgaW5zdGFsbGVkIGJlZm9yZSB0aGUgR28gY29kZSBzdGFydHMuCgpzdGF0aWMgdm9pZCBpbml0KHZvaWQpIF9fYXR0cmlidXRlX18gKChjb25zdHJ1Y3RvciAoMjAwKSkpOwoKc3RhdGljIHZvaWQgaW5pdCgpIHsKCXN0cnVjdCBzaWdhY3Rpb24gc2E7CgoJbWVtc2V0KCZzYSwgMCwgc2l6ZW9mIHNhKTsKCXNhLnNhX3NpZ2FjdGlvbiA9IGlvSGFuZGxlcjsKCWlmIChzaWdlbXB0eXNldCgmc2Euc2FfbWFzaykgPCAwKSB7CgkJZGllKCJzaWdlbXB0eXNldCIpOwoJfQoJc2Euc2FfZmxhZ3MgPSBTQV9TSUdJTkZPIHwgU0FfT05TVEFDSzsKCWlmIChzaWdhY3Rpb24oU0lHSU8sICZzYSwgTlVMc3NgIGFuZCBgZXhwZWN0ZWRgIHBvaW50ZXJzIChpLmUuLCBzaXplb2YoKmFkZHJlc3MpKS4gSXQgbXVzdCBiZQovLyAxLCAyLCA0LCBvciA4LgovLwovLyBUaGUgYHRpbWVvdXRfbnNgIGFyZ3VtZW50IHNwZWNpZmllcyB0aGUgbWF4aW11bSBhbW91bnQgb2YgdGltZSB0byB3YWl0LCB3aXRoCi8vIC0xIGluZGljYXRpbmcgYW4gaW5maW5pdGUgd2FpdC4KLy8KLy8gYHBhcmtfYXJnYCwgd2hpY2ggY2FuIGJlIE5VTEwsIGlzIHBhc3NlZCB0byB0aGUgdW5wYXJrIG9wZXJhdGlvbi4KLy8KLy8gSWYgYGRldGFjaGAgaXMgdHJ1ZSwgdGhlbiB0aGUgdGhyZWFkIHdpbGwgZGV0YWNoL3JlbGVhc2UgdGhlIEdJTCB3aGlsZQovLyB3YWl0aW5nLgovLwovLyBFeGFtcGxlIHVzYWdlOgovLwovLyAgaWYgKF9QeV9hdG9taWNfY29tcGFyZV9leGNoYW5nZV91aW50OChhZGRyZXNzLCAmZXhwZWN0ZWQsIG5ld192YWx1ZSkpIHsKLy8gICAgbnNsYXRpb24gdGFibGUgdXNhYmxlIGZvciBzdHIudHJhbnNsYXRlKCkuXG4iCiJcbiIKIklmIHRoZXJlIGlzIG9ubHkgb25lIGFyZ3VtZW50LCBpdCBtdXN0IGJlIGEgZGljdGlvbmFyeSBtYXBwaW5nIFVuaWNvZGVcbiIKIm9yZGluYWxzIChpbnRlZ2Vycykgb3IgY2hhcmFjdGVycyB0byBVbmljb2RlIG9yZGluYWxzLCBzdHJpbmdzIG9yIE5vbmUuXG4iCiJDaGFyYWN0ZXIga2V5cyB3aWxsIGJlIHRoZW4gY29udmVydGVkIHRvIG9yZGluYWxzLlxuIgoiSWYgdGhlcmUgYXJlIHR3byBhcmd1bWVudHMsIHRoZXkgbXVzdCBiZSBzdHJpbmdzIG9mIGVxdWFsIGxlbmd0aCwgYW5kXG4iCiJpbiB0aGUgcmVzdWx0aW5nIGRpY3Rpb25hcnksIGVhY2ggY2hhcmFjdGVyIGluIHggd2lsbCBiZSBtYXBwZWQgdG8gdGhlXG4iCiJjaGFyYWN0ZXIgYXQgdGhlIHNhbWUgcG9zaXRpb24gaW4geS4gSWYgdGhlcmUgaXMgYSB0aGlyZCBhcmd1Y29kZV9EZWNvZGVMb2NhbGUobGMtPkFUVFIsIE5VTEwpCiNlbHNlICAvKiBNU19XSU5ET1dTICovCi8qIFVzZSBfV18qIGZpZWxkcyBvZiBXaW5kb3dzIHN0cnVjdCBsY29udiAqLwojZGVmaW5lIEdFVF9MT0NBTEVfU1RSSU5HKEFUVFIpIFB5VW5pY29kZV9Gcm9tV2lkZUNoYXIobGMtPl9XXyAjIyBBVFRSLCAtMSkKI2VuZGlmIC8qIE1TX1dJTkRPV1MgKi8KCiAgICBpbnQgcmVzID0gLTE7CgojZGVmaW5lIFJFU1VMVF9TVFJJTkcoQVRUUikgXAogICAgZG8geyBcCiAgICAgICAgUHlPYmplY3QgKm9iajsgXAogICAgICAgIG9iaiA9IEdFVF9MT0NBTEVfU1RSSU5HKEFUVFIpOyBcCiAgICAgICAgaWYgKG9iaiA9PSBOVUxMKSB7IFwKICAgICAgICAgICAgZ290byBkb25lOyBcCiAgICAgICAgfSBcCiAgICAgICAgaWYgKFB5RGljdF9TZXRJdGVtU3RyaW5nKGRpY3QsIFB5X1NUUklOR0lGWShBVFRSKSwgb2JqKSA8IDApIHsgOF90ICpjaHVuaywgdWludDMyX3QgY2h1bmtfbGVuKQp7CiAgSGFjbF9IYXNoX1NIQTNfc3RhdGVfdCBzID0gKnN0YXRlOwogIEhhY2xfSGFzaF9TSEEzX2hhc2hfYnVmIGJsb2NrX3N0YXRlID0gcy5ibG9ja19zdGF0ZTsKICB1aW50NjRfdCB0b3RhbF9sZW4gPSBzLnRvdGFsX2xlbjsKICBTcGVjX0hhc2hfRGVmaW5pdGlvbnNfaGFzaF9hbGcgaSA9IGJsb2NrX3N0YXRlLmZzdDsKICBpZiAoKHVpbnQ2NF90KWNodW5rX2xlbiA+IDB4RkZGRkZGRkZGRkZGRkZGRlVMTCAtIHRvdGFsX2xlbikKICB7CiAgICByZXR1cm4gSGFjbF9TdHJlYW1pbmdfVHlwZXNfTWF4aW11bUxlbmd0aEV4Y2VlZGVkOwogIH0KICB1aW50MzJfdCBzejsKICBpZiAodG90YWxfbGVuICUgKHVpbnQ2NF90KWJsb2NrX2xlbihpKSA9PSAwVUxMICYmIHRvdGFsX2xlbiA+IDBVTEwpCiAgewogICAgc3ogPSBibG9ja19sZW4oaSk7CiAgfQogIGVsc2UKICB7cmVhZF9fZ2V0X25hbWVfaW1wbChQeU9iamVjdCAqbW9kdWxlKQovKltjbGluaWMgZW5kIGdlbmVyYXRlZCBjb2RlOiBvdXRwdXQ9MjAwMjZlN2VlM2RhM2RkNyBpbnB1dD0zNWNlYzY3NjgzM2QwNGM4XSovCnsKI2lmbmRlZiBNU19XSU5ET1dTCiAgICAvLyBMaW51eCBhbmQgbWFjT1MgYXJlIGxpbWl0ZWQgdG8gcmVzcGVjdGl2ZWx5IDE2IGFuZCA2NCBieXRlcwogICAgY2hhciBuYW1lWzEwMF07CiAgICBwdGhyZWFkX3QgdGhyZWFkID0gcHRocmVhZF9zZWxmKCk7CiNpZmRlZiBIQVZFX1BUSFJFQURfR0VUTkFNRV9OUAogICAgaW50IHJjID0gcHRocmVhZF9nZXRuYW1lX25wKHRocmVhZCwgbmFtZSwgUHlfQVJSQVlfTEVOR1RIKG5hbWUpKTsKI2Vsc2UgLyogZGVmaW5lZChIQVZFX1BUSFJFQURfR0VUX05BTUVfTlApICovCiAgICBpbnQgcmMgPSAwOyAvKiBwdGhyZWFkX2dldF9uYW1lX25wKCkgcmV0dXJucyB2b2lkICovc3VyZXMgdGhhdAovLyB0aGUgdGhyZWFkIGlzIGVpdGhlciBqb2luZWQgb3IgZGV0YWNoZWQgYWZ0ZXIgdGhlIGhhbmRsZSBpcyBkZXN0cm95ZWQuCi8vCi8vIEpvaW5pbmcgdGhlIGhhbmRsZSBpcyBpZGVtcG90ZW50OyB0aGUgdW5kZXJseWluZyBPUyB0aHJlYWQsIGlmIGFueSwgaXMKLy8gam9pbmVkIG9yIGRldGFjaGVkIG9ubHkgb25jZS4gQ29uY3VycmVudCBqb2luIG9wZXJhdGlvbnMgYXJlIHNlcmlhbGl6ZWQKLy8gdW50aWwgaXQgaXMgdGhlaXIgdHVybiB0byBleGVjdXRlIG9yIGFuIGVhcmxpZXIgb3BlcmF0aW9uIGNvbXBsZXRlcwovLyBzdWNjZXNzZnVsbHkuIE9uY2UgYSBqb2luIGhhcyBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5IGFsbCBmdXR1cmUgam9pbnMKLy8gY29tcGxldGUgaW1tZWRpYXRlbHkuCi8vCi8vIFRoaXMgbXVzdCBiZSBzZXBhcmF0ZWx5IHJlZmVyZW5jZSBjb3VudGVkIGJlY2F1c2UgaXQgbWF5IGlmIChpbnRlcnAtPnN5c190cmFjaW5nX3RocmVhZHMpIHsKICAgICAgICBlcnIgPSBtYXliZV9zZXRfb3Bjb2RlX3RyYWNlKHRzdGF0ZSk7CiAgICB9CmRvbmU6CiAgICBfUHlFdmFsX1N0YXJ0VGhlV29ybGQoaW50ZXJwKTsKICAgIFB5X1hERUNSRUYob2xkX3RyYWNlb2JqKTsgIC8vIG5lZWRzIHRvIGJlIGRlY3JlZidkIG91dHNpZGUgc3RvcC10aGUtd29ybGQKICAgIHJldHVybiBlcnI7Cn0KCmludApfUHlFdmFsX1NldFRyYWNlQWxsVGhyZWFkcyhQeUludGVycHJldGVyU3RhdGUgKmludGVycCwgUHlfdHJhY2VmdW5jIGZ1bmMsIFB5T2JqZWN0ICphcmcpCnsKICAgIFB5VGhyZWFkU3RhdGUgKmN1cnJlbnRfdHN0YXRlID0gX1B5VGhyZWFkU3RhdGVfR0VUKCk7CiAgICBhc3NlcnQoaXNfdHN0YXRlX3ZhbGlkKGN1cnJlbnRfdHN0YXRlKSk7CiAgICBhc3NlcnQoY3VycmVudF90c3RhdGUtPmludGVycCA9PSBpbnRlIik7Cn0KCiNpZiBNSV9TVEFUPjEKc3RhdGljIHZvaWQgbWlfc3RhdHNfcHJpbnRfYmlucyhjb25zdCBtaV9zdGF0X2NvdW50X3QqIGJpbnMsIHNpemVfdCBtYXgsIGNvbnN0IGNoYXIqIGZtdCwgbWlfb3V0cHV0X2Z1biogb3V0LCB2b2lkKiBhcmcpIHsKICBib29sIGZvdW5kID0gZmFsc2U7CiAgY2hhciBidWZbNjRdOwogIGZvciAoc2l6ZV90IGkgPSAwOyBpIDw9IG1heDsgaSsrKSB7CiAgICBpZiAoYmluc1tpXS5hbGxvY2F0ZWQgPiAwKSB7CiAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgaW50NjRfdCB1bml0ID0gX21pX2Jpbl9zaXplKCh1aW50OF90KWkpOwogICAgICBzbnByaW50ZihidWYsIDY0LCAiJXMgJTNsdSIsIGZtdCwgKGxvbmcpaSk7CiAgICAgIG1pX3N0YXRfcHJpbnQoJmJpbnNbaV0sIGJ1ZiwgdW5pdCwgb3V0LCBhcmcpOwogICAgfQogIH0KICBpZiAoZm91bmQpIHsKICAgIF9taV9mcHJpbnRmKG91dCwgIFB5X0ZhdGFsRXJyb3IoImNvdWxkIG5vdCByZWdpc3RlciB0dXBsZSBmb3IgY3Jvc3MtaW50ZXJwcmV0ZXIgc2hhcmluZyIpOwogICAgfQoKICAgIC8vIEZvciBub3csIHdlIGRvIG5vdCByZWdpc3RlciBQeUNvZGVfVHlwZSBvciBQeUZ1bmN0aW9uX1R5cGUuCiN1bmRlZiBSRUdJU1RFUgojdW5kZWYgUkVHSVNURVJfRkFMTEJBQ0sKfQovKgogKiBDb3B5cmlnaHQgKGMpIDIwMDgtMjAyMCBTdGVmYW4gS3JhaC4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICoKICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0CiAqIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucwogKiBhcmUgbWV0OgogKgogKiAxLiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGh0aGUgbGVuZ3RoIG9mIGl0cyBwYXJhbWV0ZXIsIGJ1dCBQeV9zc2l6ZV90IGNhbiBiZQogKiA2NCBiaXRzIHNvIHdlIGxvb3AgaW4gPDRnaWcgY2h1bmtzIHdoZW4gbmVlZGVkLiAqLwoKc3RhdGljIHZvaWQKdXBkYXRlXzI1NihIYWNsX0hhc2hfU0hBMl9zdGF0ZV90XzI1NiAqc3RhdGUsIHVpbnQ4X3QgKmJ1ZiwgUHlfc3NpemVfdCBsZW4pCnsKICAgIC8qCiAgICAgKiBOb3RlOiB3ZSBleHBsaWNpdGx5IGlnbm9yZSB0aGUgZXJyb3IgY29kZSBvbiB0aGUgYmFzaXMgdGhhdCBpdCB3b3VsZAogICAgICogdGFrZSBtb3JlIHRoYW4gMSBiaWxsaW9uIHllYXJzIHRvIG92ZXJmbG93IHRoZSBtYXhpbXVtIGFkbWlzc2libGUgbGVuZ3RoCiAgICAgKiBmb3IgU0hBLTItMjU2ICgyXjYxIC0gMSkuCiAgICAgKi8KI2lmIFBZX1NTSVpFX1RfTUFYID4gVUlOVDMyX01BWAogICAgd2hpbGUgKGxlbiA+IFVJTlQzMl9NQVgpIHsKIGVnZXIgdHlwZSB0aGF0IGlzIHdpZGUgZW5vdWdoIHRvIGhvbGQgYSBwb2ludGVyLlxuXApTcGVjaWFsIGNhc2UgKG5vdCBpbiBuYXRpdmUgbW9kZSB1bmxlc3MgJ2xvbmcgbG9uZycgaW4gcGxhdGZvcm0gQyk6XG5cCiAgcTpsb25nIGxvbmc7IFE6dW5zaWduZWQgbG9uZyBsb25nXG5cCldoaXRlc3BhY2UgYmV0d2VlbiBmb3JtYXRzIGlzIGlnbm9yZWQuXG5cClxuXApUaGUgdmFyaWFibGUgc3RydWN0LmVycm9yIGlzIGFuIGV4Y2VwdGlvbiByYWlzZWQgb24gZXJyb3JzLlxuIik7CgoKc3RhdGljIGludApfc3RydWN0bW9kdWxlX3RyYXZlcnNlKFB5T2JqZWN0ICptb2R1bGUsIHZpc2l0cHJvYyB2aXNpdCwgdm9pZCAqYXJnKQp7CiAgICBfc3RydWN0bW9kdWxlc3RhdGUgKnN0YXRlID0gZ2V0X3N0cnVjdF9zdGF0ZShtb2R1bGUpOwogICAgaWYgKHN0YXRlKSB7CiAgICAgICAgUHlfVklTSVQoc3RhdGUtPmNhY2hlKTsKIGUpICAgICAgICAgLyogdHJ1ZSBmb3IgbGl0dGxlLWVuZGlhbiwgZmFsc2UgZm9yIGJpZy1lbmRpYW4gKi8KewogICAgZG91YmxlIHg7CgogICAgeCA9IFB5RmxvYXRfVW5wYWNrOChwLCBsZSk7CiAgICBpZiAoeCA9PSAtMS4wICYmIFB5RXJyX09jY3VycmVkKCkpCiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICByZXR1cm4gUHlGbG9hdF9Gcm9tRG91YmxlKHgpOwp9CgovKiBIZWxwZXIgdG8gZm9ybWF0IHRoZSByYW5nZSBlcnJvciBleGNlcHRpb25zICovCnN0YXRpYyBpbnQKX3JhbmdlX2Vycm9yKF9zdHJ1Y3Rtb2R1bGVzdGF0ZSAqc3RhdGUsIGNvbnN0IGZvcm1hdGRlZiAqZiwgaW50IGlzX3Vuc2lnbmVkKQp7CiAgICAvKiB1bGFyZ2VzdCBpcyB0aGUgbGFyZ2VzdCB1bnNpZ25lZCB2YWx1ZSB3aXRoIGYtPnNpemUgYnl0ZXMuCiAgICAgKiBOb3RlIHRoYXQgdGhlIHNpbXBsZXI6CiAgICAgKiAgICAgKChzaXplX3QpMSA8PHJuIFB5X0J1aWxkVmFsdWUoCiAgICAgICAgICAgICJOKE9OKSIsIF9QeUV2YWxfR2V0QnVpbHRpbigmX1B5X0lEKGdldGF0dHIpKSwgZnVuY3NlbGYsIGZ1bmNuYW1lKTsKfQoKc3RhdGljIFB5TWV0aG9kRGVmIG1ldGhvZF9tZXRob2RzW10gPSB7CiAgICBNRVRIT0RfX19SRURVQ0VfX19NRVRIT0RERUYKICAgIHtOVUxMLCBOVUxMfQp9OwoKLyogRGVzY3JpcHRvcnMgZm9yIFB5TWV0aG9kIGF0dHJpYnV0ZXMgKi8KCi8qIGltX2Z1bmMgYW5kIGltX3NlbGYgYXJlIHN0b3JlZCBpbiB0aGUgUHlNZXRob2Qgb2JqZWN0ICovCgojZGVmaW5lIE1PX09GRih4KSBvZmZzZXRvZihQeU1ldGhvZE9iamVjdCwgeCkKCnN0YXRpYyBQeU1lbWJlckRlZiBtZXRob2RfbWVtYmVybGlzdFtdID0gewogICAgeyJfX2Z1bmNfXyIsIF9QeV9UX09CSkVDVCwgTU9fT0ZGKGltX2Z1bmMpLCBQeV9SRUFET05MWSwKICAgICAidGhlIGZ1bmVzX19fYnl0ZXNfX19pbXBsKChQeUJ5dGVzT2JqZWN0ICopc2VsZik7Cn0KClB5RG9jX1NUUlZBUihieXRlc19zcGxpdF9fZG9jX18sCiJzcGxpdCgkc2VsZiwgLywgc2VwPU5vbmUsIG1heHNwbGl0PS0xKVxuIgoiLS1cbiIKIlxuIgoiUmV0dXJuIGEgbGlzdCBvZiB0aGUgc2VjdGlvbnMgaW4gdGhlIGJ5dGVzLCB1c2luZyBzZXAgYXMgdGhlIGRlbGltaXRlci5cbiIKIlxuIgoiICBzZXBcbiIKIiAgICBUaGUgZGVsaW1pdGVyIGFjY29yZGluZyB3aGljaCB0byBzcGxpdCB0aGUgYnl0ZXMuXG4iCiIgICAgTm9uZSAodGhlIGRlZmF1bHQgdmFsdWUpIG1lYW5zIHNwbGl0IG9uIEFTQ0lJIHdoaXRlc3BhY2UgY2hhcmFjdGVyc1xuIgoiICAgIChzcGFjZSwgdGFiLCByZXR1cm4sIG5ld2xpbmUsIGZvcm1mZWVkLCB2ZXJ0aWNhbCB0YWIpLlxuIgoiICBtYXhzcGxpdFxuIgoiICAgIE1heGltdW0gbnVtYmVyIG9mIHNwbGl0cyB0b25pbmcgc3RhdGlzdGljcyBhYm91dCBjYWNoZSBwZXJmb3JtYW5jZSwKbWVtb3J5IHJlYWRzLCBhbmQgb3RoZXIgcHJvZmlsaW5nIG1ldHJpY3MuIE9ubHkgYXZhaWxhYmxlIGlmIHRoZQpSZW1vdGVVbndpbmRlciB3YXMgY3JlYXRlZCB3aXRoIHN0YXRzPVRydWUuCgpSZXR1cm5zOgogICAgZGljdDogQSBkaWN0aW9uYXJ5IGNvbnRhaW5pbmc6CiAgICAgICAgLSB0b3RhbF9zYW1wbGVzOiBUb3RhbCBudW1iZXIgb2YgZ2V0X3N0YWNrX3RyYWNlIGNhbGxzCiAgICAgICAgLSBmcmFtZV9jYWNoZV9oaXRzOiBGdWxsIGNhY2hlIGhpdHMgKGVudGlyZSBzdGFjayB1bmNoYW5nZWQpCiAgICAgICAgLSBmcmFtZV9jYWNoZV9taXNzZXM6IENhY2hlIG1pc3NlcyByZXF1aXJpbmcgZnVsbCB3YWxrCiAgICAgICAgLSBmcmFtZV9jYWNoZV9wYXJ0aWFsX2hpdHM6IFBhcnRpYWwgaGl0cyAoc3RvcHBlZCBhdCBjYWNoZWQgZnJhbWUpCiAgIGhhciAqKmFyZ3YpCnsKCW1wZF9jb250ZXh0X3QgY3R4OwoJbXBkX3QgKmEsICpiOwoJbXBkX3QgKnJlc3VsdDsKCWNoYXIgKnJzdHJpbmc7CgljaGFyIHN0YXR1c19zdHJbTVBEX01BWF9GTEFHX1NUUklOR107CgljbG9ja190IHN0YXJ0X2Nsb2NrLCBlbmRfY2xvY2s7CgoJaWYgKGFyZ2MgIT0gMykgewoJCWZwcmludGYoc3RkZXJyLCAiY29tcGFyZTogdXNhZ2U6IC4vY29tcGFyZSB4IHlcbiIpOwoJCWV4aXQoMSk7Cgl9CgoJbXBkX2luaXQoJmN0eCwgMzgpOwoJY3R4LnRyYXBzID0gMDsKCglyZXN1bHQgPSBtcGRfbmV3KCZjdHgpOwoJYSA9IG1wZF9uZXcoJmN0eCk7CgliID0gbXBkX25ldygmY3R4KTsKCW1wZF9zZXRfc3RyaW5nKGEsIGFyZ3ZbMV0sICZjdHgpOwoJbXBkX3NldF9zdHJpbmcoYiwgYXJndlsyXSwgJmN0eCk7CgoJc3RhcnRfY2xvY2sgPSBjbG9jaygpOwoJbXBkX2NvbXBhcmUocmVzdWx0LCBhLCBiLCAmY2NvZGVfQXNVVEY4QW5kU2l6ZSgpLCB0aGlzIGFsc28gY2FjaGVzIHRoZSBVVEYtOCByZXByZXNlbnRhdGlvbgogICBpbiB0aGUgdW5pY29kZW9iamVjdC4KCiAgIF9QeVVuaWNvZGVfQXNTdHJpbmcgaXMgYSAjZGVmaW5lIGZvciBQeVVuaWNvZGVfQXNVVEY4IHRvCiAgIHN1cHBvcnQgdGhlIHByZXZpb3VzIGludGVybmFsIGZ1bmN0aW9uIHdpdGggdGhlIHNhbWUgYmVoYXZpb3VyLgoKICAgVXNlIG9mIHRoaXMgQVBJIGlzIERFUFJFQ0FURUQgc2luY2Ugbm8gc2l6ZSBpbmZvcm1hdGlvbiBjYW4gYmUKICAgZXh0cmFjdGVkIGZyb20gdGhlIHJldHVybmVkIGRhdGEuCiovCgpQeUFQSV9GVU5DKGNvbnN0IGNoYXIgKikgUHlVbmljb2RlX0FzVVRGOChQeU9iamVjdCAqdW5pY29kZSk7CgovLyBEZXByZWNhdGVkIGFsaWFzIGtlcHQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKUHlfREVQUkVDQVRFRCgzLjE0KSBzdGF0ewoJCWZwcmludGYoc3RkZXJyLCAic2lncHJvY21hc2s6ICVzXG4iLCBzdHJlcnJvcihpKSk7CgkJZXhpdChFWElUX0ZBSUxVUkUpOwoJfQoKCS8vIERvbid0IHRyeSB0aGlzIGF0IGhvbWUuCglsb25nam1wKGptcCwgc2lnbm8pOwoKCS8vIFdlIHNob3VsZCBuZXZlciBnZXQgaGVyZS4KCWFib3J0KCk7Cn0KCmludCBtYWluKGludCBhcmdjLCBjaGFyKiogYXJndikgewoJaW50IHZlcmJvc2U7CglzdHJ1Y3Qgc2lnYWN0aW9uIHNhOwoJdm9pZCogaGFuZGxlOwoJdm9pZCAoKmZuKSh2b2lkKTsKCXNpZ3NldF90IG1hc2s7CglpbnQgaTsKCXN0cnVjdCB0aW1lc3BlYyB0czsKCgl2ZXJib3NlID0gYXJnYyA+IDI7CglzZXR2YnVmKHN0ZG91dCwgTlVMTCwgX0lPTkJGLCAwKTsKCgkvLyBDYWxsIHNldHNpZCBzbyB0aGF0IHdlIGNhbiB1c2Uga2lsbCgwLCBTSUdJTykgYmVsb3cuCgkvLyBEb24ndCBjaGVjayB0aGUgcmV0dXJuIHZhdWUgPSBzeXNfX2lzX2ltbW9ydGFsX2ltcGwobW9kdWxlLCBvcCk7CiAgICBpZiAoKF9yZXR1cm5fdmFsdWUgPT0gLTEpICYmIFB5RXJyX09jY3VycmVkKCkpIHsKICAgICAgICBnb3RvIGV4aXQ7CiAgICB9CiAgICByZXR1cm5fdmFsdWUgPSBQeUJvb2xfRnJvbUxvbmcoKGxvbmcpX3JldHVybl92YWx1ZSk7CgpleGl0OgogICAgcmV0dXJuIHJldHVybl92YWx1ZTsKfQoKUHlEb2NfU1RSVkFSKHN5c19zZXR0cmFjZV9fZG9jX18sCiJzZXR0cmFjZSgkbW9kdWxlLCBmdW5jdGlvbiwgLylcbiIKIi0tXG4iCiJcbiIKIlNldCB0aGUgZ2xvYmFsIGRlYnVnIHRyYWNpbmcgZnVuY3Rpb24uXG4iCiJcbiIKIkl0IHdpbGwgYmUgY2FsbGVkIG9uIGVhY2ggZnVuY3Rpb24gY2FsbC4gIFNlZSB0aGUgZGVidWdnZXIgY2hhcHRlclxuIgoiaW4gdGhlIGxpYnJhcnkgbWFudWFsLiIpOwoKI2RlZmluZSBTWVNfU0VUVFJBQ0VfTUVUSHRLZXlFcnJvcihQeU9iamVjdCAqKTsKCgovLyBMaWtlIFB5RXJyX0Zvcm1hdCgpLCBidXQgc2F2ZXMgY3VycmVudCBleGNlcHRpb24gYXMgX19jb250ZXh0X18gYW5kCi8vIF9fY2F1c2VfXy4KLy8gRXhwb3J0IGZvciAnX3NxbGl0ZTMnIHNoYXJlZCBleHRlbnNpb24uClB5QVBJX0ZVTkMoUHlPYmplY3QqKSBfUHlFcnJfRm9ybWF0RnJvbUNhdXNlKAogICAgUHlPYmplY3QgKmV4Y2VwdGlvbiwKICAgIGNvbnN0IGNoYXIgKmZvcm1hdCwgICAvKiBBU0NJSS1lbmNvZGVkIHN0cmluZyAgKi8KICAgIC4uLgogICAgKTsKCmV4dGVybiBpbnQgX1B5RXhjZXB0aW9uX0FkZE5vdGUoCiAgICAgUHlPYmplY3QgKmV4YywKICAgICBQeU9iamVjdCAqbm90ZSk7CgpleHRlcm4gaW50IF9QeUVycl9DaGVja1NpZ25hbHModm9pZCk7CgovKiBTdXBwb3J0IGZvciBhZGRpbmcgcHJvZ3JhbSB0ZXh0IHRvIFN5bnRheEVycm9ycyAqLwoKLy8gRSAgIFB5TGlzdF9TRVRfSVRFTShsaXN0LCBpLCBwaWRfb2JqKTsKICAgIH0KCiAgICBwaWRfYXJyYXlfY2xlYW51cCgmcmVzdWx0KTsKICAgIHJldHVybiBsaXN0Owp9Ci8vIENvcHlyaWdodCAyMDE5IFRoZSBHbyBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgovLyBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQovLyBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCgovKgogKiBPbiBBSVgsIGNhbGwgdG8gX2Nnb190b3BvZnN0YWNrIGFuZCBHbyBtYWluIGFyZSBmb3JjZWQgdG8gYmUgYSBsb25nY2FsbC4KICogV2l0aG91dCBpdCwgbGQgbWlnaHQgYWRkIHRyYW1wb2xpbmVzIGluIHRoZSBtaWRkbGUgb2YgLnRleHQgc2VjdGlvbgogKiB0byByZWFjaCB0aGVzZSBmdW5jdGlvbnMgd2hpY2ggYXJlIG5vcm1hbGx5IGRlY2xhcmVkIGluIHJ1bgoKLyogbm90ZTogZmFzdHNlYXJjaCBtYXkgYWNjZXNzIHNbbl0sIHdoaWNoIGlzbid0IGEgcHJvYmxlbSB3aGVuIHVzaW5nCiAgIFB5dGhvbidzIG9yZGluYXJ5IHN0cmluZyB0eXBlcywgYnV0IG1heSBjYXVzZSBwcm9ibGVtcyBpZiB5b3UncmUKICAgdXNpbmcgdGhpcyBjb2RlIGluIG90aGVyIGNvbnRleHRzLiAgYWxzbywgdGhlIGNvdW50IG1vZGUgcmV0dXJucyAtMQogICBpZiB0aGVyZSBjYW5ub3QgcG9zc2libHkgYmUgYSBtYXRjaCBpbiB0aGUgdGFyZ2V0IHN0cmluZywgYW5kIDAgaWYKICAgaXQgaGFzIGFjdHVhbGx5IGNoZWNrZWQgZm9yIG1hdGNoZXMsIGJ1dCBkaWRuJ3QgZmluZCBhbnkuICBjYWxsZXJzCiAgIGJld2FyZSEgKi8KCi8qIElmIHRoZSBzdHJpbmdzIGFyZSBsb25nIGVub3VnaCwgdXNlIENyb2NoZW1vcmUgYW5kIFBlcnJpbidzIFR3by1XYXkKICAgYWxnb3JpdGhtLCB3aGljaCBoYXMgd29yc3QtY25kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCiAqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIGFyICpmaWxlbmFtZSwKICAgIHVpbnQ2NF90IHNhbXBsZV9pbnRlcnZhbF91cywKICAgIGludCBjb21wcmVzc2lvbl90eXBlLAogICAgdWludDY0X3Qgc3RhcnRfdGltZV91cwopOwoKLyoKICogV3JpdGUgYSBzYW1wbGUgdG8gdGhlIGJpbmFyeSBmaWxlLgogKgogKiBBcmd1bWVudHM6CiAqICAgd3JpdGVyOiBXcml0ZXIgZnJvbSBiaW5hcnlfd3JpdGVyX2NyZWF0ZQogKiAgIHN0YWNrX2ZyYW1lczogTGlzdCBvZiBJbnRlcnByZXRlckluZm8gc3RydWN0IHNlcXVlbmNlcwogKiAgIHRpbWVzdGFtcF91czogQ3VycmVudCB0aW1lc3RhbXAgaW4gbWljcm9zZWNvbmRzIChmcm9tIHRpbWUubW9ub3RvbmljKCkgKiAxZTYpCiAqCiAqIFJldHVybnM6CiAqICAgMCBvbiBzdWNjZXNzLCAtMSBvbiBmYWlsdXJlIChQeUVyciBzZXQpCiAqLwppbnQgYmluYXJ5X3dyaXRlcl93cml0ZV9zYW1wbGUoCiAgICBCaW5hcnRfYXV0b2NvbnZvbHV0ZShtcGRfdWludF90ICpjMSwgbXBkX3NpemVfdCBuLCBpbnQgbW9kbnVtKTsKCgpNUERfUFJBR01BKE1QRF9ISURFX1NZTUJPTFNfRU5EKSAvKiByZXN0b3JlIHByZXZpb3VzIHNjb3BlIHJ1bGVzICovCgoKI2VuZGlmIC8qIExJQk1QREVDX0NPTlZPTFVURV9IXyAqLwovKiBUdXBsZSBvYmplY3QgaW50ZXJmYWNlICovCgojaWZuZGVmIFB5X1RVUExFT0JKRUNUX0gKI2RlZmluZSBQeV9UVVBMRU9CSkVDVF9ICiNpZmRlZiBfX2NwbHVzcGx1cwpleHRlcm4gIkMiIHsKI2VuZGlmCgovKgpBbm90aGVyIGdlbmVyYWxseSB1c2VmdWwgb2JqZWN0IHR5cGUgaXMgYSB0dXBsZSBvZiBvYmplY3QgcG9pbnRlcnMuCkZvciBQeXRob24sIHRoaXMgaXMgYW4gaW1tdXRhYmxlIHR5cGUuICBDIGNvZGUgY2FuIGNoYW5nZSB0aGUgdHVwbGUgaXRlbXMKKGJ1dCBub3QgdGhlaXIgbnVtYmVyKSwgYW5kIGV2ZW4gdXNlICBiZSBjaGFuZ2VkIHRvIHNvbWV0aGluZyByZWFzb25hYmxlIGZvciB5b3VyCiAgIG1vZHVsZS4gSWYgeW91ciBtb2R1bGUgaXMgbmFtZWQgZm9vIHlvdXIgc291cmNlIGZpbGUgc2hvdWxkIGJlIG5hbWVkCiAgIGZvby5jIG9yIGZvb21vZHVsZS5jLgoKICAgWW91IHdpbGwgcHJvYmFibHkgd2FudCB0byBkZWxldGUgYWxsIHJlZmVyZW5jZXMgdG8gJ3hfYXR0cicgYW5kIGFkZAogICB5b3VyIG93biB0eXBlcyBvZiBhdHRyaWJ1dGVzIGluc3RlYWQuICBNYXliZSB5b3Ugd2FudCB0byBuYW1lIHlvdXIKICAgbG9jYWwgdmFyaWFibGVzIG90aGVyIHRoYW4gJ3NlbGYnLiAgSWYgeW91ciBvYmplY3QgdHlwZSBpcyBuZWVkZWQgaW4KICAgb3RoZXIgZmlsZXMsIHlvdSdsbCBoYXZlIHRvIGNyZWF0ZSBhIGZpbGUgImZvb2Jhcm9iamVjdC5oIjsgc2VlCiAgIGZsb2F0b2JqZWN0LmggZm9yIGFuIGV4YW1wbGUuCgogICBUaGlzIG1vZGFsRnJlZShhZGRyLCBzaXplLCBNRU1fREVDT01NSVQpOwogICpuZWVkc19yZWNvbW1pdCA9IHRydWU7ICAvLyBmb3Igc2FmZXR5LCBhc3N1bWUgYWx3YXlzIGRlY29tbWl0dGVkIGV2ZW4gaW4gdGhlIGNhc2Ugb2YgYW4gZXJyb3IuCiAgcmV0dXJuIChvayA/IDAgOiAoaW50KUdldExhc3RFcnJvcigpKTsKfQoKaW50IF9taV9wcmltX3Jlc2V0KHZvaWQqIGFkZHIsIHNpemVfdCBzaXplKSB7CiAgdm9pZCogcCA9IFZpcnR1YWxBbGxvYyhhZGRyLCBzaXplLCBNRU1fUkVTRVQsIFBBR0VfUkVBRFdSSVRFKTsKICBtaV9hc3NlcnRfaW50ZXJuYWwocCA9PSBhZGRyKTsKICAjaWYgMAogIGlmIChwICE9IE5VTEwpIHsKICAgIFZpcnR1YWxVbmxvY2soYWRkcixzaXplKTsgLy8gVmlydHVhbFVubG9jayBhZnRlciBNRU1fUkVTRVQgcmVtb3ZlcyB0aGUgbWVtb3J5IGRpcmVjdGx5IGZyb20gdGhlIHdvcmtpbmcgc2V0CiAgfQogICNlbmVfY291bnQ7CnByaXZhdGU6CiAgICAvLyBidWZmZXIgdGhhdCBjYW4gZ2V0IGNvcnJ1cHRlZAogICAgaW50KiBpbnRlcm5hbF9kYXRhOwp9OwoKaW50IFZpcnR1YWxQeU9iamVjdDo6aW5zdGFuY2VfY291bnQgPSAwOwoKLy8gQ29udmVydGluZyBmcm9tIGZ1bmN0aW9uIHBvaW50ZXIgdG8gdm9pZCogaGFzIHVuZGVmaW5lZCBiZWhhdmlvciwgYnV0Ci8vIHdvcmtzIG9uIGFsbCBrbm93biBwbGF0Zm9ybXMsIGFuZCBDUHl0aG9uJ3MgbW9kdWxlIGFuZCB0eXBlIHNsb3RzIGN1cnJlbnRseQovLyBuZWVkIGl0LgovLyAoR0NDIGRvZXNuJ3QgaGF2ZSBhIG5hcnJvd2VyIGNhdGVnb3J5IGZvciB0aGlzIHRoYW4gLVdwZWRhbnRpYy4pCl9QeV9DT01QX0RJQUdfUFVTSAojaWYgZGVmaW5lZChfX0dOVUNfXykKI3ByYWdtYSBHQ0MgZGlhZ25vc3RpYyBpZ25vcmVkICItV3BlZGFudGljIgojZWxpZiBkZWZpbmVkKF9fY2xhbmdfXykKI1B5X3RwX2dldGF0dHJvLCBQeU9iamVjdF9HZW5lcmljR2V0QXR0cn0sCiAgICB7UHlfdHBfdHJhdmVyc2UsIGFycmF5aXRlcl90cmF2ZXJzZX0sCiAgICB7UHlfdHBfaXRlciwgUHlPYmplY3RfU2VsZkl0ZXJ9LAogICAge1B5X3RwX2l0ZXJuZXh0LCBhcnJheWl0ZXJfbmV4dH0sCiAgICB7UHlfdHBfbWV0aG9kcywgYXJyYXlpdGVyX21ldGhvZHN9LAogICAgezAsIE5VTEx9LAp9OwoKc3RhdGljIFB5VHlwZV9TcGVjIGFycmF5aXRlcl9zcGVjID0gewogICAgLm5hbWUgPSAiYXJyYXkuYXJyYXlpdGVyYXRvciIsCiAgICAuYmFzaWNzaXplID0gc2l6ZW9mKGFycmF5aXRlcm9iamVjdCksCiAgICAuZmxhZ3MgPSAoUHlfVFBGTEFHU19ERUZBVUxUIHwgUHlfVFBGTEFHU19IQVZFX0dDIHwKICAgICAgICAgICAgICBQeV9UUEZMQUdTX0RJU0FMTE9XX0lOU1RBTlRJQVRJT04gfCBQeV9UUEZMQUdTX0lNTVVUQUJMRVRZUEUpLAogIC8qIE1ldGhvZHMgKi8Kc3RhdGljIHZvaWQKYXJyYXlfZGVhbGxvYyhQeU9iamVjdCAqb3ApCnsKICAgIFB5VHlwZU9iamVjdCAqdHAgPSBQeV9UWVBFKG9wKTsKICAgIFB5T2JqZWN0X0dDX1VuVHJhY2sob3ApOwoKICAgIGFycmF5b2JqZWN0ICpzZWxmID0gYXJyYXlvYmplY3RfQ0FTVChvcCk7CiAgICBGVF9DTEVBUl9XRUFLUkVGUyhvcCwgc2VsZi0+d2Vha3JlZmxpc3QpOwogICAgaWYgKHNlbGYtPm9iX2l0ZW0gIT0gTlVMTCkgewogICAgICAgIFB5TWVtX0ZyZWUoc2VsZi0+b2JfaXRlbSk7CiAgICB9CiAgICB0cC0+dHBfZnJlZShvcCk7CiAgICBQeV9ERUNSRUYodHApOwp9CgpzdGF0aWMgUHlPYmplY3QgKgphcnJheV9yaWNoY29tcGFyZShQeU9iamVjdCAqdiwgUHlPYmplY3QgKncsIGludCBvcCkKewogICAgYXJyYXlfc3RhdGUgKnN0YXRlID0gZmluZF9hcnJheV9zdGF0ZV9ieV90eXBlKFB5X1RZUEUodikpOwogIGFybmluZ19jb3VudDsgLy8gPSAwOyAgLy8gd2hlbiA+PSBtYXhfd2FybmluZ19jb3VudCBzdG9wIGVtaXR0aW5nIHdhcm5pbmdzCgovLyBXaGVuIG92ZXJyaWRpbmcgbWFsbG9jLCB3ZSBtYXkgcmVjdXJzZSBpbnRvIG1pX3ZmcHJpbnRmIGlmIGFuIGFsbG9jYXRpb24KLy8gaW5zaWRlIHRoZSBDIHJ1bnRpbWUgY2F1c2VzIGFub3RoZXIgbWVzc2FnZS4KLy8gSW4gc29tZSBjYXNlcyAobGlrZSBvbiBtYWNPUykgdGhlIGxvYWRlciBhbHJlYWR5IGFsbG9jYXRlcyB3aGljaAovLyBjYWxscyBpbnRvIG1pbWFsbG9jOyBpZiB3ZSB0aGVuIGFjY2VzcyB0aHJlYWQgbG9jYWxzIChsaWtlIGByZWN1cnNlYCkKLy8gdGhpcyBtYXkgY3Jhc2ggYXMgdGhlIGFjY2VzcyBtYXkgY2FsbCBfdGx2X2Jvb3RzdHJhcCB0aGF0IHRyaWVzIHRvCi8vIChyZWN1cnNpdmVseSkgaW52b2tlIG1hbGxvYyBhZ2FpbiB0byBhbGxvY2F0ZSBzcGFjZSBmb3MgbWVhbnQgZm9yIHVzZSBieSB0aGUgUHl0aG9uXG4iCiJpbnRlcnByZXRlciBhbmQgbm90IGZvciBnZW5lcmFsIHVzZSwgaXQgaXMgYmV0dGVyIHRvIHVzZVxuIgoiaW1wb3J0bGliLmltcG9ydF9tb2R1bGUoKSB0byBwcm9ncmFtbWF0aWNhbGx5IGltcG9ydCBhIG1vZHVsZS5cbiIKIlxuIgoiVGhlIGdsb2JhbHMgYXJndW1lbnQgaXMgb25seSB1c2VkIHRvIGRldGVybWluZSB0aGUgY29udGV4dDtcbiIKInRoZXkgYXJlIG5vdCBtb2RpZmllZC4gIFRoZSBsb2NhbHMgYXJndW1lbnQgaXMgdW51c2VkLiAgVGhlIGZyb21saXN0XG4iCiJzaG91bGQgYmUgYSBsaXN0IG9mIG5hbWVzIHRvIGVtdWxhdGUgYGBmcm9tIG5hbWUgaW1wb3J0IC4uLmBgLCBvciBhblxuIgoiZW1wdHkgbGlzdCB0byBlbXVsYXRlIGBgaW1wb3J0IG5hbWVgYC5cbiIKIldoZW4gaW1wb3J0aW5nIGEgbW9kdWxlIGZyb20gYSBwYWNrYWdlLCBub3RlIHRoYSAgIHN0cmluZyA9IGZhc3RhcmdzWzJdOwpza2lwX29wdGlvbmFsX2t3b25seToKICAgIHJldHVybl92YWx1ZSA9IHB5X3NoYTNfbmV3X2ltcGwodHlwZSwgZGF0YV9vYmosIHVzZWRmb3JzZWN1cml0eSwgc3RyaW5nKTsKCmV4aXQ6CiAgICByZXR1cm4gcmV0dXJuX3ZhbHVlOwp9CgpQeURvY19TVFJWQVIoX3NoYTNfc2hhM18yMjRfY29weV9fZG9jX18sCiJjb3B5KCRzZWxmLCAvKVxuIgoiLS1cbiIKIlxuIgoiUmV0dXJuIGEgY29weSBvZiB0aGUgaGFzaCBvYmplY3QuIik7CgojZGVmaW5lIF9TSEEzX1NIQTNfMjI0X0NPUFlfTUVUSE9EREVGICAgIFwKICAgIHsiY29weSIsIF9QeUNGdW5jdGlvbl9DQVNUKF9zaGEzX3NoYTNfMjI0X2NvcHkpLCBNRVRIX01FVEhPRHxNRVRIX0ZBU1RDQUxMfE1FVEhfS0VZV09SRFMsIF9zaGEzX3NoYTNfMjI0X2NvcHlfX2RvY19ffSwKCnN0YXRpYyBQeU9iamVjdCAqCl9zaGEzaWQKZnJhbWVfa2V5X2Rlc3Ryb3kodm9pZCAqa2V5KQp7CiAgICBQeU1lbV9GcmVlKGtleSk7Cn0KCnN0YXRpYyBpbmxpbmUgaW50CndyaXRlcl9pbnRlcm5fc3RyaW5nKEJpbmFyeVdyaXRlciAqd3JpdGVyLCBQeU9iamVjdCAqc3RyaW5nLCB1aW50MzJfdCAqaW5kZXgpCnsKICAgIHZvaWQgKmV4aXN0aW5nID0gX1B5X2hhc2h0YWJsZV9nZXQod3JpdGVyLT5zdHJpbmdfaGFzaCwgc3RyaW5nKTsKICAgIGlmIChleGlzdGluZyAhPSBOVUxMKSB7CiAgICAgICAgKmluZGV4ID0gKHVpbnQzMl90KSh1aW50cHRyX3QpZXhpc3RpbmcgLSAxOyAgLyogaW5kZXgrMSBzdG9yZWQgdG8gZGlzdGluZ3Vpc2ggZnJvbSBOVUxMICovCiAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgaWYgKHdyaXRlci0+c3RyaW5nX2NvdW50ID49IHdyaXRlci0+c3RyaW5nX2NhcGFjaXR5KSB7CiAgICAgICAgaWYgKGdyb3dfcGFyYWxsZWxfYXJyYXlzdmlldy5idWY7CiAgICAqYnVmZmVyX2xlbiA9IHZpZXcubGVuOwogICAgUHlCdWZmZXJfUmVsZWFzZSgmdmlldyk7CiAgICByZXR1cm4gMDsKfQoKLyogVGFrZXMgYW4gYXJiaXRyYXJ5IG9iamVjdCB3aGljaCBtdXN0IHN1cHBvcnQgdGhlIChjaGFyYWN0ZXIsIHNpbmdsZSBzZWdtZW50KQogICBidWZmZXIgaW50ZXJmYWNlIGFuZCByZXR1cm5zIGEgcG9pbnRlciB0byBhIHJlYWQtb25seSBtZW1vcnkgbG9jYXRpb24KICAgdXNhYmxlIGFzIGNoYXJhY3RlciBiYXNlZCBpbnB1dCBmb3Igc3Vic2VxdWVudCBwcm9jZXNzaW5nLgoKICAgUmV0dXJuIDAgb24gc3VjY2Vzcy4gIGJ1ZmZlciBhbmQgYnVmZmVyX2xlbiBhcmUgb25seSBzZXQgaW4gY2FzZSBubyBlcnJvcgogICBvY2N1cnMuIE90aGVyd2lzZSwgLTEgaXMgcmV0dXJuZWQgYW5kIGFuIGV4Y2VwdGlvbiBzZXQuICovClB5QVBJX0ZVTkMoaW50KSAvKiBhYmlfb25seSAqZTogb2JqZWN0CiAgICAgICAgTXVzdCBiZSByZWFkYWJsZSBiaW5hcnkgZmlsZS4KICAgIC8KICAgICoKICAgIGFsbG93X2NvZGU6IGJvb2wgPSBUcnVlCiAgICAgICAgQWxsb3cgdG8gbG9hZCBjb2RlIG9iamVjdHMuCgpSZWFkIG9uZSB2YWx1ZSBmcm9tIHRoZSBvcGVuIGZpbGUgYW5kIHJldHVybiBpdC4KCklmIG5vIHZhbGlkIHZhbHVlIGlzIHJlYWQgKGUuZy4gYmVjYXVzZSB0aGUgZGF0YSBoYXMgYSBkaWZmZXJlbnQgUHl0aG9uCnZlcnNpb24ncyBpbmNvbXBhdGlibGUgbWFyc2hhbCBmb3JtYXQpLCByYWlzZSBFT0ZFcnJvciwgVmFsdWVFcnJvciBvcgpUeXBlRXJyb3IuCgpOb3RlOiBJZiBhbiBvYmplY3QgY29udGFpbmluZyBhbiB1bnN1cHBvcnRlZCB0eXBlIHdhcyBtYXJzaGFsbGVkIHdpdGgKZHVtcCgpLCBsb2FkKCkgd2lsbCBzdWJzdGl0dXRlIE5vbmUgZm9yIHRoZSB1bm1hcnNoYWxsYWJsZSB0eXBlLgpbY2xpc2xvdHMsCiAgICAubV90cmF2ZXJzZSA9IHdpbmFwaV90cmF2ZXJzZSwKICAgIC5tX2NsZWFyID0gd2luYXBpX2NsZWFyLAogICAgLm1fZnJlZSA9IHdpbmFwaV9mcmVlLAp9OwoKUHlNT0RJTklUX0ZVTkMKUHlJbml0X193aW5hcGkodm9pZCkKewogICAgcmV0dXJuIFB5TW9kdWxlRGVmX0luaXQoJndpbmFwaV9tb2R1bGUpOwp9CgovKiBXcml0ZSBQeXRob24gb2JqZWN0cyB0byBmaWxlcyBhbmQgcmVhZCB0aGVtIGJhY2suCiAgIFRoaXMgaXMgcHJpbWFyaWx5IGludGVuZGVkIGZvciB3cml0aW5nIGFuZCByZWFkaW5nIGNvbXBpbGVkIFB5dGhvbiBjb2RlLAogICBldmVuIHRob3VnaCBkaWN0cywgbGlzdHMsIHNldHMgYW5kIGZyb3plbnNldHMsIG5vdCBjb21tb25seSBzZWVuIGluCiAgIGNvZGUgb2JqZWN0cywgYXJlIHN1cHBvcnRlZC4KICAgVmVyc2lvbiAzIG9mIHRoaXMgcHJvdG9jb2wgcHJvcGVybHkgc3VwcG9ydHMgZWN0ICptb2R1bGUsIFB5T2JqZWN0ICpQeV9VTlVTRUQoaWdub3JlZCkpCnsKICAgIHJldHVybiBfaW1wX2xvY2tfaGVsZF9pbXBsKG1vZHVsZSk7Cn0KClB5RG9jX1NUUlZBUihfaW1wX2FjcXVpcmVfbG9ja19fZG9jX18sCiJhY3F1aXJlX2xvY2soJG1vZHVsZSwgLylcbiIKIi0tXG4iCiJcbiIKIkFjcXVpcmVzIHRoZSBpbnRlcnByZXRlclwncyBpbXBvcnQgbG9jayBmb3IgdGhlIGN1cnJlbnQgdGhyZWFkLlxuIgoiXG4iCiJUaGlzIGxvY2sgc2hvdWxkIGJlIHVzZWQgYnkgaW1wb3J0IGhvb2tzIHRvIGVuc3VyZSB0aHJlYWQtc2FmZXR5IHdoZW4gaW1wb3J0aW5nXG4iCiJtb2R1bGVzLiBPbiBwbGF0Zm9ybXMgd2l0aG91dCB0aHJlYWRzLCB0aGlzIGZ1bmN0aW9uIGRvZXMgbm90aGluZy4iKTsKCiNkZWZpbmUgX0lNUF9BQ1FVSVJFX0xPQ0tfTUVUSE9EREVGICAgIFwKICAgIHsiYWNxdWlyZV9sb2NrIiwgKFB5Q0Z1dCAqc291cmNlb2JqID0gUHlfTm9uZTsKCiAgICBhcmdzID0gX1B5QXJnX1VucGFja0tleXdvcmRzKGFyZ3MsIG5hcmdzLCBOVUxMLCBrd25hbWVzLCAmX3BhcnNlciwKICAgICAgICAgICAgLyptaW5wb3MqLyA0LCAvKm1heHBvcyovIDgsIC8qbWlua3cqLyAwLCAvKnZhcnBvcyovIDAsIGFyZ3NidWYpOwogICAgaWYgKCFhcmdzKSB7CiAgICAgICAgZ290byBleGl0OwogICAgfQogICAgbWVzc2FnZSA9IGFyZ3NbMF07CiAgICBjYXRlZ29yeSA9IGFyZ3NbMV07CiAgICBpZiAoIVB5VW5pY29kZV9DaGVjayhhcmdzWzJdKSkgewogICAgICAgIF9QeUFyZ19CYWRBcmd1bWVudCgid2Fybl9leHBsaWNpdCIsICJhcmd1bWVudCAnZmlsZW5hbWUnIiwgInN0ciIsIGFyZ3NbMl0pOwogICAgICAgIGdvdG8gZXhpdDsKICAgIH0KICAgIGZpbGVuYW1lID0gYXJnc1syXTsKICAgIGxpbmVubyA9IFB5TG9uZ19Bc0ludChhcmdzWzNdKTsKZSA9IFB5VmFyT2JqZWN0X0hFQURfSU5JVCgmUHlUdXBsZV9UeXBlLCBOVU1fS0VZV09SRFMpCiAgICAgICAgLm9iX2hhc2ggPSAtMSwKICAgICAgICAub2JfaXRlbSA9IHsgJl9QeV9JRChldmVudCksIH0sCiAgICB9OwogICAgI3VuZGVmIE5VTV9LRVlXT1JEUwogICAgI2RlZmluZSBLV1RVUExFICgmX2t3dHVwbGUub2JfYmFzZS5vYl9iYXNlKQoKICAgICNlbHNlICAvLyAhUHlfQlVJTERfQ09SRQogICAgIyAgZGVmaW5lIEtXVFVQTEUgTlVMTAogICAgI2VuZGlmICAvLyAhUHlfQlVJTERfQ09SRQoKICAgIHN0YXRpYyBjb25zdCBjaGFyICogY29uc3QgX2tleXdvcmRzW10gPSB7ImV2ZW50IiwgTlVMTH07CiAgICBzdGF0aWMgX1B5QXJnX1BhcnNlciBfcGFyc2VyID0gewogICAgICAgIC5rZXl3b3JkcyA9IF9rZXl3b3JkcywKICAgICAgICAuZm5hbWUgPSAiT3ZlcmxhcHBlZCIsCiAgICAgICAgLmt3dHVwbGUgPSBLV1RVICBQeV9VTlJFQUNIQUJMRSgpOwp9CiNlbmRpZgoKCnN0YXRpYyBpbnQKc3RhY2tfYWxsb2NhdGUoX1B5VU9wSW5zdHJ1Y3Rpb24gKmJ1ZmZlciwgX1B5VU9wSW5zdHJ1Y3Rpb24gKm91dHB1dCwgaW50IGxlbmd0aCkKewogICAgYXNzZXJ0KGJ1ZmZlclswXS5vcGNvZGUgPT0gX1NUQVJUX0VYRUNVVE9SKTsKICAgIC8qIFRoZSBpbnB1dCBidWZmZXIgYW5kIG91dHB1dCBidWZmZXJzIHdpbGwgb3ZlcmxhcC4KICAgICAgIE1ha2Ugc3VyZSB0aGF0IHdlIGNhbiBtb3ZlIGluc3RydWN0aW9ucyB0byB0aGUgb3V0cHV0CiAgICAgICB3aXRob3V0IG92ZXJ3cml0aW5nIHRoZSBpbnB1dC4gKi8KICAgIGlmIChidWZmZXIgPT0gb3V0cHV0KSB7CiAgICAgICAgLy8gVGhpcyBjYW4gb25seSBoYXBwZW4gaWYgb3B0aW1pemVyIGhhcyBub3QgYmVlbiBydW4KICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiBfc3RhdGUuc3RhY2tfZGVwdGggPj0gMCk7CiNpZm5kZWYgUHlfR0lMX0RJU0FCTEVECiAgICBhc3NlcnQoX3RzdGF0ZS0+aml0X3RyYWNlcl9zdGF0ZS0+aW5pdGlhbF9zdGF0ZS5mdW5jICE9IE5VTEwpOwogICAgaW50ZXJwLT5jb21waWxpbmcgPSB0cnVlOwogICAgLy8gVGhlIGZpcnN0IGV4ZWN1dG9yIGluIGEgY2hhaW4gYW5kIHRoZSBNQVhfQ0hBSU5fREVQVEgndGggZXhlY3V0b3IgKm11c3QqCiAgICAvLyBtYWtlIHByb2dyZXNzIGluIG9yZGVyIHRvIGF2b2lkIGluZmluaXRlIGxvb3BzIG9yIGV4Y2Vzc2l2ZWx5LWxvbmcKICAgIC8vIHNpZGUtZXhpdCBjaGFpbnMuIFdlIGNhbiBvbmx5IGluc2VydCB0aGUgZXhlY3V0b3IgaW50byB0aGUgYnl0ZWNvZGUgaWYKICAgIC8vIHRoaXMgaXMgdHJ1ZSwgc2luY2UgYSBkZW9wdCB3b24ndCBpbmZpbml0ZWx5IHJlLWVudGVyIHRoZSBleGVjdXRvcjoKICAgIGNoYWluX2RlcHRQVEhSRUFEX0NSRUFURV9ERVRBQ0hFRCk7CglwdGhyZWFkX2F0dHJfZ2V0c3RhY2tzaXplKCZhdHRyLCAmc2l6ZSk7CgoJLy8gTGVhdmUgc3RhY2tsbz0wIGFuZCBzZXQgc3RhY2toaT1zaXplOyBtc3RhcnQgd2lsbCBkbyB0aGUgcmVzdC4KCXRzLT5nLT5zdGFja2hpID0gc2l6ZTsKCWVyciA9IF9jZ29fdHJ5X3B0aHJlYWRfY3JlYXRlKCZwLCAmYXR0ciwgdGhyZWFkZW50cnksIHRzKTsKCglwdGhyZWFkX3NpZ21hc2soU0lHX1NFVE1BU0ssICZvc2V0LCBuaWwpOwoKCWlmIChlcnIgIT0gMCkgewoJCWZhdGFsZigicHRocmVhZF9jcmVhdGUgZmFpbGVkOiAlcyIsIHN0cmVycm9yKGVycikpOwoJfQp9CgpleHRlcm4gdm9pZCBjcm9zc2NhbGwxKHZvaWQgKCpmbikodm9pZCksIHZvaWQgKCpzZXRnX2djYykodm9pZCopLCB2b2lkICpnKTsKc3RhdGljIHZvaWQqCnRocmVhZGVudHJ5KHZvaWQgKnYpCnsKCVRocmVhZFN0YXJ0IHR1ZGUgImtybWwvaW50ZXJuYWwvdGFyZ2V0LmgiCgovKiBUaGUgRiogZm9ybWFsaXphdGlvbiB0YWxrcyBhYm91dCB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIHRoZSBhcnJheS4gVGhlIEMKICAgaW1wbGVtZW50YXRpb24gd2FudHMgYSBudW1iZXIgb2YgYnl0ZXMgaW4gdGhlIGFycmF5LiBLYVJhTWVMIGlzIGF3YXJlIG9mIHRoaXMKICAgYW5kIGluc2VydHMgYSBzaXplb2YgbXVsdGlwbGljYXRpb24uICovCnZvaWQgTGliX01lbXplcm8wX21lbXplcm8wKHZvaWQgKmRzdCwgdWludDY0X3QgbGVuKSB7CiAgLyogVGhpcyBpcyBzYWZlOiBrYXJhbWVsIGNoZWNrcyBhdCBydW4tdGltZSAoaWYgbmVlZGVkKSB0aGF0IGFsbCBvYmplY3Qgc2l6ZXMKICAgICBmaXQgd2l0aGluIGEgc2l6ZV90LCBzbyB0aGUgc2l6ZSB3ZSByZWNlaXZlIGhhcyBiZWVuIGNoZWNrZWQgYXQKICAgICBhbGxvY2F0aW9uLXRpbWUsIHBvc3NpYmx5IHZfYWZ0ZXJfZmluYWxpemF0aW9uKHZvaWQpCnsKICAgIF90ZXN0ZW1iZWRfaW5pdGlhbGl6ZSgpOwogICAgUHlfRmluYWxpemUoKTsKICAgIFB5VGhyZWFkX2hhbmRsZV90IGhhbmRsZTsKICAgIFB5VGhyZWFkX2lkZW50X3QgaWRlbnQ7CiAgICBQeUV2ZW50IGV2ZW50ID0gezB9OwogICAgaWYgKFB5VGhyZWFkX3N0YXJ0X2pvaW5hYmxlX3RocmVhZCgmZG9fZ2lsc3RhdGVfZW5zdXJlLCAmZXZlbnQsICZpZGVudCwgJmhhbmRsZSkgPCAwKSB7CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQogICAgUHlFdmVudF9XYWl0KCZldmVudCk7CiAgICAvLyBXZSdyZSBub3cgcHJldHR5IGNvbmZpZGVudCB0aGF0IHRoZSB0aHJlYWQgd2VudCBmb3IKICAgIC8vIFB5R0lMU3RhdGVfRW5zdXJlKCksIGJ1dCB0aGF0IG1lYW5zIGl0IGdvdCBodW5nLgogICAgcmV0dXJuIFB5VGhyZWFkX2RldGFjaF90aHJlYWQoaGFuZGxlKTsKfQoKLyogKiogICBtYXhpbXVtIGRpZmZlcmVuY2UgZm9yIGJlaW5nIGNvbnNpZGVyZWQgImNsb3NlIiwgcmVnYXJkbGVzcyBvZiB0aGUKICAgICAgICBtYWduaXR1ZGUgb2YgdGhlIGlucHV0IHZhbHVlcwoKRGV0ZXJtaW5lIHdoZXRoZXIgdHdvIGZsb2F0aW5nLXBvaW50IG51bWJlcnMgYXJlIGNsb3NlIGluIHZhbHVlLgoKUmV0dXJuIFRydWUgaWYgYSBpcyBjbG9zZSBpbiB2YWx1ZSB0byBiLCBhbmQgRmFsc2Ugb3RoZXJ3aXNlLgoKRm9yIHRoZSB2YWx1ZXMgdG8gYmUgY29uc2lkZXJlZCBjbG9zZSwgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiB0aGVtCm11c3QgYmUgc21hbGxlciB0aGFuIGF0IGxlYXN0IG9uZSBvZiB0aGUgdG9sZXJhbmNlcy4KCi1pbmYsIGluZiBhbmQgTmFOIGJlaGF2ZSBzaW1pbGFybHkgdG8gdGhlIElFRUUgNzU0IFN0YW5kYXJkLiAgVGhhdAppcywgTmFOIGlzIG5vdCBjbG9zZSB0byBhbnl0aGluZywgZXZlbiBpdHNieSBpdHNlbGYuICovCiAgICBQeU9iamVjdCAqcmVzID0gbWF0aF8xKGFyZywgZnVuYywgMCwgImV4cGVjdGVkIGEgcG9zaXRpdmUgaW5wdXQsIGdvdCAlcyIpOwogICAgaWYgKHJlcyA9PSBOVUxMICYmCiAgICAgICAgUHlFcnJfRXhjZXB0aW9uTWF0Y2hlcyhQeUV4Y19PdmVyZmxvd0Vycm9yKSAmJgogICAgICAgIFB5SW5kZXhfQ2hlY2soYXJnKSkKICAgIHsKICAgICAgICAvKiBIZXJlIHRoZSBjb252ZXJzaW9uIHRvIGRvdWJsZSBvdmVyZmxvd2VkLCBidXQgaXQncyBwb3NzaWJsZQogICAgICAgICAgIHRvIGNvbXB1dGUgdGhlIGxvZyBhbnl3YXkuICBDbGVhciB0aGUgZXhjZXB0aW9uLCBjb252ZXJ0IHRvCiAgICAgICAgICAgaW50ZWdlciBhbmQgY29udGludWUuICovCiAgICAgICAgUHlFcnJfQ2xlYXIoKTsKICAgICAgICBhcmcgPSBfUHlOdW1iZXJfSW5kZXgoYXJnKTsKICAgICAgICBpZiAoYXJnID09IE5VTEwpIHtyZSBmb3IgYW55IHB1cnBvc2UsCiAqIGluY2x1ZGluZyBjb21tZXJjaWFsIGFwcGxpY2F0aW9ucywgYW5kIHRvIGFsdGVyIGl0IGFuZCByZWRpc3RyaWJ1dGUgaXQKICogZnJlZWx5LCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgcmVzdHJpY3Rpb25zOgogKgogKiAxLiBUaGUgb3JpZ2luIG9mIHRoaXMgc29mdHdhcmUgbXVzdCBub3QgYmUgbWlzcmVwcmVzZW50ZWQ7IHlvdSBtdXN0IG5vdAogKiAgICBjbGFpbSB0aGF0IHlvdSB3cm90ZSB0aGUgb3JpZ2luYWwgc29mdHdhcmUuIElmIHlvdSB1c2UgdGhpcyBzb2Z0d2FyZQogKiAgICBpbiBhIHByb2R1Y3QsIGFuIGFja25vd2xlZGdtZW50IGluIHRoZSBwcm9kdWN0IGRvY3VtZW50YXRpb24gd291bGQgYmUKICogICAgYXBwcmVjaWF0ZWQgYnV0IGlzIG5vdCByZXF1aXJlZC4KICogMi4gQWx0ZXJlZCBzb3VyY2UgdmVyc2lvbnMgbXVzdCBiZSBwbGFpbmx5IG1hcmtlZCBhcyA+dV9tZXRhZGF0YS51X2NlbGx2YXJzLCBuYW1lKTsKfQoKaW50Cl9QeUNvbXBpbGVfTG9va3VwQXJnKGNvbXBpbGVyICpjLCBQeUNvZGVPYmplY3QgKmNvLCBQeU9iamVjdCAqbmFtZSkKewogICAgLyogU3BlY2lhbCBjYXNlOiBJZiBhIGNsYXNzIGNvbnRhaW5zIGEgbWV0aG9kIHdpdGggYQogICAgICogZnJlZSB2YXJpYWJsZSB0aGF0IGhhcyB0aGUgc2FtZSBuYW1lIGFzIGEgbWV0aG9kLAogICAgICogdGhlIG5hbWUgd2lsbCBiZSBjb25zaWRlcmVkIGZyZWUgKmFuZCogbG9jYWwgaW4gdGhlCiAgICAgKiBjbGFzcy4gIEl0IHNob3VsZCBiZSBoYW5kbGVkIGJ5IHRoZSBjbG9zdXJlLCBhcwogICAgICogd2VsbCBhcyBieSB0aGUgbm9ybWFsIG5hbWUgbG9va3VwIGxvZ2ljLgogICAgICovCiAgICBpbnQgcmVmdHlwZSA9IF9QeUNvbXBpbGVfR2V0UmVmVHlwZShjLCBuYW1lKTsKICAgIGlmIChyZWZ0eXBlID09IC0xKSB7CiB0dXJuIE5VTEw7Cn0KCi8qW2NsaW5pYyBpbnB1dF0KQHBlcm1pdF9sb25nX2RvY3N0cmluZ19ib2R5Cl9tdWx0aWJ5dGVjb2RlYy5NdWx0aWJ5dGVDb2RlYy5kZWNvZGUKCiAgaW5wdXQ6IFB5X2J1ZmZlcgogIGVycm9yczogc3RyKGFjY2VwdD17c3RyLCBOb25lVHlwZX0pID0gTm9uZQoKRGVjb2RlcyAnaW5wdXQnLgoKJ2Vycm9ycycgbWF5IGJlIGdpdmVuIHRvIHNldCBhIGRpZmZlcmVudCBlcnJvciBoYW5kbGluZyBzY2hlbWUuIERlZmF1bHQgaXMKJ3N0cmljdCcgbWVhbmluZyB0aGF0IGVuY29kaW5nIGVycm9ycyByYWlzZSBhIFVuaWNvZGVEZWNvZGVFcnJvci4gT3RoZXIgcG9zc2libGUKdmFsdWVzIGFyZSAnaWdub3JlJyBhbmQgJ3JlcGxhY2UnIGFzIHdlbGwgYXMgYW55IG90aGVyIG5hbWUgcmVnaXN0ZXJlZCB3aXRoCmNvZGVjcy5yZWdpc3Rlcl9lcnJvciB0aGF0IGlzIGFibGUgdG8gaGFuZGxlIFVuaWNuX29wY29kZXM7CiAgICAvKiBUaGUgdG9vbHMgdGhhdCBhcmUgdG8gYmUgbm90aWZpZWQgZm9yIGluc3RydWN0aW9uIGV2ZW50cyBmb3IgdGhlIG1hdGNoaW5nIGNvZGUgdW5pdCAqLwogICAgdWludDhfdCAqcGVyX2luc3RydWN0aW9uX3Rvb2xzOwp9IF9QeUNvTW9uaXRvcmluZ0RhdGE7CgoKI2lmZGVmIF9fY3BsdXNwbHVzCn0KI2VuZGlmCiNlbmRpZiAvKiAhUHlfSU5URVJOQUxfSU5TVFJVTUVOVF9IICovCiNpZm5kZWYgUHlfQ1BZVEhPTl9NRVRIT0RPQkpFQ1RfSAojICBlcnJvciAidGhpcyBoZWFkZXIgZmlsZSBtdXN0IG5vdCBiZSBpbmNsdWRlZCBkaXJlY3RseSIKI2VuZGlmCgovLyBQeUNGdW5jdGlvbk9iamVjdCBzdHJ1Y3R1cmUKCnR5cGVkZWYgc3RydWN0IHsKICAgIFB5T2JqZWN0X0hFQUQKICAgIFB5TWV0aG9kRGVmICptX21sOyAvKiBEZXNjcmlwdGlvbiBvZiB0aGUgQyBmdW5jdGlvbiB0byBjYWxsICovCiBpbnB1dD1hOTA0OTA1NDAxM2ExYjc3XSovCi8qIE1JVCBMaWNlbnNlCiAqCiAqIENvcHlyaWdodCAoYykgMjAxNi0yMDIyIElOUklBLCBDTVUgYW5kIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbgogKiBDb3B5cmlnaHQgKGMpIDIwMjItMjAyMyBIQUNMKiBDb250cmlidXRvcnMKICoKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL19yZWNhbGxvY19hbGlnbmVkKG1pX3ByaW1fZ2V0X2RlZmF1bHRfaGVhcCgpLCBwLCBuZXdjb3VudCwgc2l6ZSwgYWxpZ25tZW50KTsKfQovKltjbGluaWMgaW5wdXRdCnByZXNlcnZlCltjbGluaWMgc3RhcnQgZ2VuZXJhdGVkIGNvZGVdKi8KCiNpZiBkZWZpbmVkKFB5X0JVSUxEX0NPUkUpICYmICFkZWZpbmVkKFB5X0JVSUxEX0NPUkVfTU9EVUxFKQojICBpbmNsdWRlICJweWNvcmVfZ2MuaCIgICAgICAgICAgLy8gUHlHQ19IZWFkCiMgIGluY2x1ZGUgInB5Y29yZV9ydW50aW1lLmgiICAgICAvLyBfUHlfSUQoKQojZW5kaWYKI2luY2x1ZGUgInB5Y29yZV9sb25nLmgiICAgICAgICAgIC8vIF9QeUxvbmdfVUludDMyX0NvbnZlcnRlcigpCiNpbmNsdWRlICJweWNvcmVfbW9kc3VwcG9ydC5oIiAgICAvLyBfUHlBcmdfQ2hlY2tQb3NpdGlvbmFsKCkKCnN0YXRpYyBpbnQKcHlzcWxpdGVfY3Vyc29yX2luaXRfaW1wbChweXNxbGV0YXJnczEoUHlPYmplY3QgKmFyZ3MsIGNvbnN0IGNoYXIgKmZvcm1hdCwgdmFfbGlzdCAqcF92YSwgaW50IGZsYWdzKQp7CiAgICBQeU9iamVjdCAqKnN0YWNrOwogICAgUHlfc3NpemVfdCBuYXJnczsKCiAgICBpZiAoIShmbGFncyAmIEZMQUdfQ09NUEFUKSkgewogICAgICAgIGFzc2VydChhcmdzICE9IE5VTEwpOwoKICAgICAgICBpZiAoIVB5VHVwbGVfQ2hlY2soYXJncykpIHsKICAgICAgICAgICAgUHlFcnJfU2V0U3RyaW5nKFB5RXhjX1N5c3RlbUVycm9yLAogICAgICAgICAgICAgICAgIm5ldyBzdHlsZSBnZXRhcmdzIGZvcm1hdCBidXQgYXJndW1lbnQgaXMgbm90IGEgdHVwbGUiKTsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgICAgICBzdGFjayA9IF9QeVR1cGxlX0lURU1TKGFyZ3MpOwogICAgICAgIG5hcmdzID0gUHlUdXBsZV9HRVRfU0laRShhcmdzKTsKICAgIH0KICAgIGVsc2UgewogIHR1cm4gLTE7CiNlbmRpZgp9CiNpZm5kZWYgUHlfQlVJTERfQ09SRV9CVUlMVElOCiMgIGRlZmluZSBQeV9CVUlMRF9DT1JFX01PRFVMRSAxCiNlbmRpZgoKLyogQWx3YXlzIGVuYWJsZSBhc3NlcnRpb25zICovCiN1bmRlZiBOREVCVUcKCiNpbmNsdWRlICJQeXRob24uaCIKI2luY2x1ZGUgInB5Y29yZV9vYmplY3QuaCIgICAgICAgIC8vIF9QeU9iamVjdF9Jc0ZyZWVkKCkKCgovLyBVc2VkIGZvciBjbG9uZV93aXRoX2NvbnZfZjEgYW5kIGNsb25lX3dpdGhfY29udl92Mgp0eXBlZGVmIHN0cnVjdCB7CiAgICBjb25zdCBjaGFyICpuYW1lOwp9IGN1c3RvbV90OwoKc3RhdGljIGludApjdXN0b21fY29udmVydGVyKFB5T2JqZWN0ICpvYmosIGN1c3RvbV90ICp2YWwpCnsKICAgIHJldHVybiAxOwp9CgoKI2luY2x1ZGUgImNsaW5pYy9fdGVzdGNsaW5pYy5jLmgiCgoKLyogUGFjayBhcmd1bWVudHMgdG8gYSB0dXBsZSwgaW1wbCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUwogKiBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikKICogSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QKICogTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWQogKiBPVVQgT0YgVEhFIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GCiAqIFNVQ0ggREFNQUdFLgogKi8KCgojaW5jbHVkZSAibXBkZWNpbWFsLmgiCgojaW5jbHVkZSA8YXNzZXJ0Lmg+CiNpbmNsdWRlIDxzdGRsaWIuaD4KCiNpbmNsdWRlICJiaXRzLmgiCiNpbmNsdWRlICJudW1iZXJ0aGVvcnkuaHBlKTsKICAgIHJldHVybiAwOwp9CgpzdGF0aWMgdm9pZApfYWJjbW9kdWxlX2ZyZWUodm9pZCAqbW9kdWxlKQp7CiAgICAodm9pZClfYWJjbW9kdWxlX2NsZWFyKChQeU9iamVjdCAqKW1vZHVsZSk7Cn0KCnN0YXRpYyBQeU1vZHVsZURlZl9TbG90IF9hYmNtb2R1bGVfc2xvdHNbXSA9IHsKICAgIHtQeV9tb2RfZXhlYywgX2FiY21vZHVsZV9leGVjfSwKICAgIHtQeV9tb2RfbXVsdGlwbGVfaW50ZXJwcmV0ZXJzLCBQeV9NT0RfUEVSX0lOVEVSUFJFVEVSX0dJTF9TVVBQT1JURUR9LAogICAge1B5X21vZF9naWwsIFB5X01PRF9HSUxfTk9UX1VTRUR9LAogICAgezAsIE5VTEx9Cn07CgpzdGF0aWMgc3RydWN0IFB5TW9kdWxlRGVmIF9hYmNtb2R1bGUgPSB7CiAgICBQeU1vZHVsZURlZl9IRUFEX0lOSVQsCiAgICAubV9uYW1lID0gIl9hYmMiLAogICAgLm1fZG9jID0gX2FiY19fZG9jX18sCiAgICAubV9zaXplID0gc2l6ZW9mKG9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0CiAqICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUKICogICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KICoKICogVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQVVUSE9SIEFORCBDT05UUklCVVRPUlMgIkFTIElTIiBBTkQKICogQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQQ==';

let cachedDictionary: Buffer | null = null;

export function getCppDictionary(): Buffer {
  if (!cachedDictionary) {
    cachedDictionary = Buffer.from(DICTIONARY_BASE64, 'base64');
  }
  return cachedDictionary;
}

export const CPP_DICTIONARY_META: DictionaryMeta = {
  name: 'C++ Dictionary',
  version: '2.0.0',
  description: 'Trained ZSTD dictionary optimized for C++ code compression',
  frameworks: ["cpp","c++","qt"],
  sizeBytes: 262144,
  patternCount: 0, // Trained dictionary - patterns are internal
  trainedOn: ['sample cpp files'],
};
