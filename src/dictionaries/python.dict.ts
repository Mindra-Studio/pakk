/**
 * PAKK Trained ZSTD Dictionary for Python
 *
 * This is a REAL trained ZSTD dictionary (not just text patterns).
 * Trained using: zstd --train on sample Python files.
 *
 * Size: 524288 bytes
 * Generated: 2026-01-31T16:08:29.431Z
 */

import type { DictionaryMeta } from '../core/types.js';

// Base64-encoded trained ZSTD dictionary
const DICTIONARY_BASE64 = 'N6Qw7GOLmztBELASNwcwDMMwDMMwDMPAhfFqZmiLXL1FdlsVsyu7t1ha+4bWYUQ+gO5FVdhj6wH5WQC/rZcb2wQRYWQrscENqwQjASAACItHZDKRRCAQFEmTHwQgARCUjCKZExGLBOJoMAliHEZBEAQhY4wxBhljkKmhmQEAAGR3Vz3KkCEAAAAAAAAAAAAAAAABAAAABAAAAAgAAAAgZXEoInNsaWNlWzEsICpUZW5kKCJDb3JvdXRpbmUgY3JlYXRlZCBhdCAobW9zdCByZWNlbnQgY2FsbCBsYXN0KVxuIikKICAgICAgICBtc2dfbGluZXMgKz0gdHJhY2ViYWNrLmZvcm1hdF9saXN0KGxpc3QoZXh0cmFjdCgpKSkKICAgIG1zZyA9ICIiLmpvaW4obXNnX2xpbmVzKS5yc3RyaXAoIlxuIikKICAgICMgUGFzc2luZyBzb3VyY2U9IGhlcmUgbWVhbnMgdGhhdCBpZiB0aGUgdXNlciBoYXBwZW5zIHRvIGhhdmUgdHJhY2VtYWxsb2MKICAgICMgZW5hYmxlZCBhbmQgdHJhY2tpbmcgd2hlcmUgdGhlIGNvcm91dGluZSB3YXMgY3JlYXRlZCwgdGhlIHdhcm5pbmcgd2lsbAogICAgIyBjb250YWluIHRoYXQgdHJhY2ViYWNrLiBUaGlzIGRvZXMgbWVhbiB0aGF0IGlmIHRoZXkgaGF2ZSAqYm90aCoKICAgICMgY29yb3V0aW5lIG9yaWdpbiB0cmFja2luZyAqYW5kKiB0cmFjZW1hbGxvYyBlbmFibGVkLCB0aGV5J2xsIGdldCB0d28KICAgICMgcGFydGlhbGx5LXJlZHVuZGFudCB0cmFjZWJhY2tzLiBJZiB3ZSB3YW50ZWQgdG8gYmUgY2xldmVyIHdlIGNvdWxkCiAgICAjIHByb2JhYmx5IGRldGVjdCB0aGlzIGNhc2UgYW5kIGF2b2lkIGl0LCBidXQgZm9yIG5vdyB3ZSBkb24ndCBib3RoZXIuCiAgICBfd20ud2FybigKICAgICAgICBtc2csIGNhdGVnb3J5PVJ1bnRpbWVXYXJuaW5nLCBzdGFja2xldmVsPTIsIHNvdXJjZT1jb3JvCiAgICApCgoKZGVmIF9zZXR1cF9kZWZhdWx0cygpOgogICAgIyBTZXZlcmFsIHdhcm5pbmcgY2F0ZWdvcmllcyBhcmUgaWdub3JlZCBieSBkZWZhdWx0IGluIHJlZ3VsYXIgYnVpbGRzCiAgICBpZiBoYXNhdHRyKHN5cywgJ2dldHRvdGFscmVmY291bnQnKToKICAgICAgICByZXR1cm4KICAgIF93bS5maWx0ZXJ3YXJuaW5ncygiZGVmYXVsdCIsIGNhdGVnb3J5PURlcHJlY2F0aW9uV2FybmluZywgbW9kdWxlPSJfX21haW5fXyIsIGFwcGVuZD0xKQogICAgX3dtLnNpbXBsZWZpbHRlcigiaWdub3JlIiwgY2F0ZWdvcnk9RGVwcmVjYXRpb25XYXJuaW5nLCBhcHBlbmQ9MSkKICAgIF93bS5zaW1wbGVmaWx0ZXIoImlnbm9yZSIsIGNhdGVnb3J5PVBlbmRpbmdEZXByZWNhdGlvbldhcm5pbmcsIGFwcGVuZD0xKQogICAgX3dtLnNpbXBsZWZpbHRlcigiaWdub3JlIiwgY2F0ZWdvcnk9SW1wb3J0V2FybmluZywgYXBwZW5kPTEpCiAgICBfd20uc2ltcGxlZmlsdGVyKCJpZ25vcmUiLCBjYXRlZ29yeT1SZXNvdXJjZVdhcm5pbmcsIGFwcGVuZD0xKQppbXBvcnQgb3MucGF0aApmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKClRFU1RfUk9PVCA9IG9zLnBhdGguZGlybmFtZShfX2ZpbGVfXykKClRFU1RfU0VUVElOR1MgPSB7CiAgICAiTUVESUFfVVJMIjogIm1lZGlhLyIsCiAgICAiU1RBVElDX1VSTCI6ICJzdGF0aWMvIiwKICAgICJNRURJQV9ST09UIjogb3MucGF0aC5qb2luKFRFU1RfUk9PVCwgInByb2plY3QiLCAic2l0ZV9tZWRpYSIsICJtZWRpYSIpLAogICAgIlNUQVRJQ19ST09UX3R5cGVwYXJhbXNfZHVuZGVyX2Z1bmN0aW9uXzAzKHNlbGYpOgogICAgICAgIGNvZGUgPSAiIiIKICAgICAgICAgICAgZGVmIGZ1bmNbQV0oKToKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgZnVuYy5fX3R5cGVfcGFyYW1zX18gPSAoKQogICAgICAgICIiIgoKICAgICAgICBucyA9IHJ1bl9jb2RlKGNvZGUpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChuc1siZnVuYyJdLl9fdHlwZV9wYXJhbXNfXywgKCkpCgoKCiMgQWxsIHRoZXNlIHR5cGUgYWxpYXNlcyBhcmUgdXNlZCBmb3IgcGlja2xpbmcgdGVzdHM6ClQgPSBUeXBlVmFyKCdUJykKZGVmIGZ1bmMxW1hdKHg6IFgpIC0+IFg6IC4uLgpkZWYgZnVuYzJbWCwgWV0oeDogWCB8IFkpIC0+IFggfCBZOiAuLi4KZGVmIGZ1bmMzW1gsICpZLCAqKlpdKHg6IFgsIHk6IHR1cGxlWypZXSwgejogWikgLT4gWDogLi4uCmRlZiBmdW5jNFtYOiBpbnQsIFk6IChieXRlcywgc3RyKV0oeDogWCwgeTogWSkgLT4gWCB8IFk6IC4uLgoKY2xhc3MgQ2xhc3MxW1hdOiAuLi4KY2xhc3MgQ2xhc3MyW1gsIFldOiAuLi4KY2xhc3MgQ2xhc3MzW1gsICpZLCAqKlpdOiAuLi4KY2xhc3MgQ2xhc3M0W1g6IGludCwgWTogKGJ5dGVzLCBzdHIpXTogLi4uCgoKY2xhc3MgVHlwZVBhcmFtc1BpY2tsZVRlc3QodW5pdHRlc3QuVGVzdENhc2UpOgogICAgZGVmIHRlc3RfcGlja2xpbmdfZnVuY3Rpb25zKHNlbGYpOgogICAgICAgIHRoaW5nc190b190ZXN0ID0gWwogICAgICAgICAgICBmdW5jMSwKICAgICAgICAgICAgZnVuYzIsCiAgICAgICAgICAgIGZ1bmMzLAogICAgICAgICAgICBmdW5jNCwKICAgICAgICBdCiAgICAgICAgZm9yIHRoaW5nIGluIHRoaW5nc190b190ZXN0OgogICAgICAgICAgICBmb3IgcHJvdG8gaW4gcmFuZ2UocGlja2xlLkhJR0hFU1RfUFJPVE9DT0wgKyAxKToKICAgICAgICAgICAgICAgIHdpdGggc2VsZi5zdWJUZXN0KHRoaW5nPXRoaW5nLCBwcm90bz1wcm90byk6CiAgICAgICAgICAgICAgICAgICAgcGlja2xlZCA9IHBpY2tsZS5kdW1wcyh0aGluZywgcHJvdG9jb2w9cHJvdG8pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChwaWNrbGUubG9hZHMocGlja2xlZCksIHRoaW5nKQoKICAgIGRlZiB0ZXN0X3BpY2tsaW5nX2NsYXNzZXMoc2VsZik6CiAgICAgICAgdGhpbmdzX3RvX3Rlc3QgPSBbCiAgICAgICAgICAgIENsYXNzMSwKICAgICAgICAgICAgQ2xhc3MxW2ludF0sCiAgICAgICAgICAgIENsYXNzMVtUXSwKCiAgICAgICAgICAgIENsYXNzMiwKICAgICAgICAgICAgQ2xhc3MyW2ludCwgVF0sCiAgICAgICAgICAgIENsYXNzMltULCBpbnRdLAogICAgICAgICAgICBDbGFzczJbaW50LCBzdHJdLAoKICAgICAgICAgICAgQ2xhc3MzLAogICAgICAgICAgICBDbGFzczNbaW50LCBULCBzdHIsIGJ5dGVzLCBbZmxvYXQsIG9iamVjdCwgVF1dLAoKICAgICAgICAgICAgQ2xhc3M0LAogICAgICAgICAgICBDbGFzczRbaW50LCBieXRlc10sCmRlZiBlb2ZfcmVjZWl2ZWQoc2VsZik6CiAgICAgICAgICAgICAgICBzZWxmLm9uX2VvZi5zZXRfcmVzdWx0KFRydWUpCgogICAgICAgIGFzeW5jIGRlZiBjbGllbnQoYWRkcik6CiAgICAgICAgICAgIGF3YWl0IGFzeW5jaW8uc2xlZXAoMC41KQoKICAgICAgICAgICAgb25fZGF0YTEgPSBzZWxmLmxvb3AuY3JlYXRlX2Z1dHVyZSgpCiAgICAgICAgICAgIG9uX2RhdGEyID0gc2VsZi5sb29wLmNyZWF0ZV9mdXR1cmUoKQogICAgICAgICAgICBvbl9lb2YgPSBzZWxmLmxvb3AuY3JlYXRlX2Z1dHVyZSgpCgogICAgICAgICAgICB0ciwgcHJvdG8gPSBhd2FpdCBzZWxmLmxvb3AuY3JlYXRlX2Nvbm5lY3Rpb24oCiAgICAgICAgICAgICAgICBsYW1iZGE6IENsaWVudFByb3RvRmlyc3Qob25fZGF0YTEpLCAqYWRkcikKCiAgICAgICAgICAgIHRyLndyaXRlKEhFTExPX01TRykKICAgICAgICAgICAgbmV3X3RyID0gYXdhaXQgc2VsZi5sb29wLnN0YXJ0X3Rscyh0ciwgcHJvdG8sIGNsaWVudF9jb250ZXh0KQoKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChhd2FpdCBvbl9kYXRhMSwgYidPJykKICAgICAgICAgICAgbmV3X3RyLndyaXRlKEhFTExPX01TRykKCiAgICAgICAgICAgIG5ld190ci5zZXRfcHJvdG9jb2woQ2xpZW50UHJvdG9TZWNvbmQob25fZGF0YTIsIG9uX2VvZikpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYXdhaXQgb25fZGF0YTIsIGInMicpCiAgICAgICAgICAgIG5ld190ci53cml0ZShIRUxMT19NU0cpCiAgICAgICAgICAgIGF3YWl0IG9uX2VvZgoKICAgICAgICAgICAgbmV3X3RyLmNsb3NlKCkKCiAgICAgICAgICAgICMgY29ubmVjdGlvbl9tYWRlKCkgc2hvdWxkIGJlIGNhbGxlZCBvbmx5IG9uY2UgLS0gd2hlbgogICAgICAgICAgICAjIHdlIGVzdGFibGlzaCBjb25uZWN0aW9uIGZvciB0aGUgZmlyc3QgdGltZS4gU3RhcnQgVExTCiAgICAgICAgICAgICMgZG9lc24ndCBjYWxsIGNvbm5lY3Rpb25fbWFkZSgpIG9uIGFwcGxpY2F0aW9uIHByb3RvY29scy4KICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjbGllbnRfY29uX21hZGVfY2FsbHMsIDEpCgogICAgICAgIHdpdGggc2VsZi50Y3Bfc2VydmVyKHNlcnZlLCB0aW1lb3V0PXNlbGYuVElNRU9VVCkgYXMgc3J2OgogICAgICAgICAgICBzZWxmLmxvb3AucnVuX3VudGlsX2NvbXBsZXRlKAogICAgICAgICAgICAgICAgYXN5bmNpby53YWl0X2ZvcihjbGllbnQoc3J2LmFkZHIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0PXNlbGYuVElNRU9VVCkpCgogICAgZGVmIHRlc3Rfc3RhcnRfdGxzX3Nsb3dfY2xpZW50X2NhbmNlbChzZWxmKToKICAgICAgICBIRUxMT19NU0cgPSBiJzEnICogc2VsZi5QQVlMT0FEX1NJWkUKCiAgICAgICAgY2xpZW50X2NvbnRleHQgPSB0ZXN0X3V0aWxzLnNpbXBsZV9jbGllbnRfc3NsY29udGV4dCgpCiAgICAgICAgc2VydmVyX3dhaXRzX29uX2hhbmRzaGFrZSA9IHNhZ2VyIGNhbGxzIHdhaXQoKSBhbmQgY2xvc2VzIHJlc291cmNlcwogICAgICAgIHdpdGggcDoKICAgICAgICAgICAgcGFzcwoKCmNsYXNzIE92ZXJsYXBwZWRSZWZsZWFrVGVzdHModW5pdHRlc3QuVGVzdENhc2UpOgoKICAgIGRlZiB0ZXN0X3dzYXNlbmR0b19mYWlsdXJlKHNlbGYpOgogICAgICAgIG92ID0gX292ZXJsYXBwZWQuT3ZlcmxhcHBlZCgpCiAgICAgICAgYnVmID0gYnl0ZWFycmF5KDQwOTYpCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFJhaXNlcyhPU0Vycm9yKToKICAgICAgICAgICAgb3YuV1NBU2VuZFRvKDB4MTIzNCwgYnVmLCAwLCAoIjEyNy4wLjAuMSIsIDEpKQoKICAgIGRlZiB0ZXN0X3dzYXJlY3Zmcm9tX2ZhaWx1cmUoc2VsZik6CiAgICAgICAgb3YgPSBfb3ZlcmxhcHBlZC5PdmVybGFwcGVkKCkKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzKE9TRXJyb3IpOgogICAgICAgICAgICBvdi5XU0FSZWN2RnJvbSgweDEyMzQsIDEwMjQsIDApCgogICAgZGVmIHRlc3Rfd3NhcmVjdmZyb21pbnRvX2ZhaWx1cmUoc2VsZik6CiAgICAgICAgb3YgPSBfb3ZlcmxhcHBlZC5PdmVybGFwcGVkKCkKICAgICAgICBidWYgPSBieXRlYXJyYXkoNDA5NikKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzKE9TRXJyb3IpOgogICAgICAgICAgICBvdi5XU0FSZWN2RnJvbUludG8oMHgxMjM0LCBidWYsIGxlbihidWYpLCAwKQoKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICB1bml0dGVzdC5tYWluKCkKaW1wb3J0IF9zaWduYWwKZnJvbSBfc2lnbmFsIGltcG9ydCAqCmZyb20gZW51bSBpbXBvcnQgSW50RW51bSBhcyBfSW50RW51bQoKX2dsb2JhbHMgPSBnbG9iYWxzKCkKCl9JbnRFbnVtLl9jb252ZXJ0XygKICAgICAgICAnU2lnbmFscycsIF9fbmFtZV9fLAogICAgICAgIGxhbWJkYSBuYW1lOgogICAgICAgICAgICBuYW1lLmlzdXBwZXIoKQogICAgICAgICAgICBhbmQgKG5hbWUuc3RhcnRzd2l0aCgnU0lHJykgYW5kIG5vdCBuYW1lLnN0YXJ0c3dpdGgoJ1NJR18nKSkKICAgICAgICAgICAgb3IgbmFtZS5zdGFydHN3aXRoKCdDVFJMXycpKQoKX0ludEVudW0uX2NvbnZlcnRfKAogICAgICAgICdIYW5kbGVycycsIF9fbmFtZV9fLAogICAgICAgIGxhbWJkYSBuYW1lOiBuYW1lIGluICgnU0lHX0RGTCcsICdTSUdfSUdOJykpCgppZiAncHRocmVhZF9zaWdtYXNrJyBpbiBfZ2xvYmFsczoKICAgIF9JbnRFbnVtLl9jb252ZXJ0XygKICAgICAgICAgICAgJ1NpZ21hc2tzJywgX19uYW1lX18sCiAgICAgICAgICAgIGxhbWJkYSBuYW1lOiBuYW1lIGluICgnU0lHX0JMT0NLJywgJ1NJR19VTkJMT0NLJywgJ1NJR19TRVRNQVNLJykpCgoKZGVmIF9pbnRfdG9fZW51bSh2YWx1ZSwgZW51bV9rbGFzcyk6CiAgICAiIiJDb252ZXJ0IGEgcG9zc2libGUgbnVtZXJpYyB2YWx1ZSB0byBhbiBJbnRFbnVtIG1lbWJlci4KICAgIElmIGl0J3Mgbm90IGEga25vd24gbWVtYmVyLCByZXR1cm4gdGhlIHZhbHVlIGl0c2Ugbm8tbWRjMiIpCiAgICBvcy5zeXN0ZW0oInBlcmwgQ29uZmlndXJlICIrY29uZmlndXJlKyIgbm8taWRlYSBuby1tZGMyIikKICAgIHByaW50KGRvX3NjcmlwdCkKICAgIG9zLnN5c3RlbShkb19zY3JpcHQpCgpkZWYgZml4X3VwbGluaygpOgogICAgIyB1cGxpbmsuYyB0cmllcyB0byBmaW5kIHRoZSBPUEVOU1NMX0FwcGxpbmsgZnVuY3Rpb24gZXhwb3J0ZWQgZnJvbSB0aGUgY3VycmVudAogICAgIyBleGVjdXRhYmxlLiBIb3dldmVyLCB3ZSBleHBvcnQgaXQgZnJvbSBfc3NsW19kXS5weWQgaW5zdGVhZC4gU28gd2UgdXBkYXRlIHRoZQogICAgIyBtb2R1bGUgbmFtZSBoZXJlIGJlZm9yZSBidWlsZGluZy4KICAgIHdpdGggb3BlbignbXNcXHVwbGluay5jJywgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmMToKICAgICAgICBjb2RlID0gbGlzdChmMSkKICAgIG9zLnJlcGxhY2UoJ21zXFx1cGxpbmsuYycsICdtc1xcdXBsaW5rLmMub3JpZycpCiAgICBhbHJlYWR5X3BhdGNoZWQgPSBGYWxzZQogICAgd2l0aCBvcGVuKCdtc1xcdXBsaW5rLmMnLCAndycsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGYyOgogICAgICAgIGZvciBsaW5lIGluIGNvZGU6CiAgICAgICAgICAgIGlmIG5vdCBhbHJlYWR5X3BhdGNoZWQ6CiAgICAgICAgICAgICAgICBpZiByZS5zZWFyY2goJ01PRElGSUVEIEZPUiBDUFlUSE9OIF9zc2wgTU9EVUxFJywgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgYWxyZWFkeV9wYXRjaGVkID0gVHJ1ZQogICAgICAgICAgICAgICAgZWxpZiByZS5tYXRjaChyJ15ccytpZlxzKlwoXChoXHMqPVxzKkdldE1vZHVsZUhhbmRsZVtBV10/XChOVUxMXClcKVxzKj09XHMqTlVMTFwpJywgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgZjIud3JpdGUoIi8qIE1PRElGSUVEIEZPUiBDUFlUSE9OIF9zc2wgTU9EVUxFICovXG4iKQogICAgICAgICAgICAgICAgICAgIGYyLndyaXRlKCdpZiAoKGggPSBHZXRNb2R1bGVIYW5kbGVXKEwiX3NzbC5weWQiKSkgPT0gTlVMTCkgaWYgKChoID0gR2V0TW9kdWxlSGFuZGxlVyhMIl9zc2xfZC5weWQiKSkgPT0gTlVMTClcbicpCiAgICAgICAgICAgICAgICAgICAgYWxyZWFkeV9wYXRjaGVkID0gVHJ1ZQogICAgICAgICAgICBmMi53cml0ZShsaW5lKQogICAgaWYgbm90IGFscmVhZHlfcGF0Y2hlZDoKICAgICAgICBwcmludCgiV0FSTjogZmFpbGVkIHRvIHBhdGNoIG1zXFx1cGxpbmsuYyIpCgpkZWYgcHJlcChhcmNoKToKICAgIG1ha2VmaWxlX3RlbXBsYXRlID0gIm1zXFxudGRsbHt9Lm1hayIKICAgIGdlbmVyYXRlZF9tYWtlZmlsZSA9IG1ha2VmaWxlX3RlbXBsYXRlLmZvcm1hdCgnJykKICAgIGlmIGFyY2ggPT0gIng4NiI6CiAgICAgICAgY29uZmlndXJlID0gIlZDLVdJTjMyIgogICAgICAgIGRvX3NjcmlwdCA9ICJtc1xcZG9fbmFzbSIKICAgICAgICBzdWZmaXggPSAiMzIiCiAgICBlbGlmIGFyY2ggPT0gImFtZDY0IjoKICAgICAgICBjb25maWd1cmUgPSAiVkMtV0lONjRBIgogICBlbGYuX3ZpZXcoYikKICAgICAgICAgICAgbW0gPSBtLnRvcmVhZG9ubHkoKQogICAgICAgICAgICBzZWxmLmFzc2VydFRydWUobW0ucmVhZG9ubHkpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShtZW1vcnl2aWV3KG1tKS5yZWFkb25seSkKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChtbS50b2xpc3QoKSwgbS50b2xpc3QoKSkKICAgICAgICAgICAgbW0ucmVsZWFzZSgpCiAgICAgICAgICAgIG0udG9saXN0KCkKCiAgICBkZWYgdGVzdF9pc3N1ZTIyNjY4KHNlbGYpOgogICAgICAgIGEgPSBhcnJheS5hcnJheSgnSCcsIFsyNTYsIDI1NiwgMjU2LCAyNTZdKQogICAgICAgIHggPSBtZW1vcnl2aWV3KGEpCiAgICAgICAgbSA9IHguY2FzdCgnQicpCiAgICAgICAgYiA9IG0uY2FzdCgnSCcpCiAgICAgICAgYyA9IGJbMDoyXQogICAgICAgIGQgPSBtZW1vcnl2aWV3KGIpCgogICAgICAgIGRlbCBiCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoY1swXSwgMjU2KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZFswXSwgMjU2KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYy5mb3JtYXQsICJIIikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGQuZm9ybWF0LCAiSCIpCgogICAgICAgIF8gPSBtLmNhc3QoJ0knKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoY1swXSwgMjU2KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZFswXSwgMjU2KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYy5mb3JtYXQsICJIIikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGQuZm9ybWF0LCAiSCIpCgogICAgZGVmIHRlc3RfaGV4X3VzZV9hZnRlcl9mcmVlKHNlbGYpOgogICAgICAgICMgUHJldmVudCBVQUYgaW4gbWVtb3J5dmlldy5oZXgoc2VwKSB3aXRoIHJlLWVudHJhbnQgc2VwLl9fbGVuX18uCiAgICAgICAgIyBSZWdyZXNzaW9uIHRlc3QgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9weXRob24vY3B5dGhvbi9pc3N1ZXMvMTQzMTk1LgogICAgICAgIGJhID0gYnl0ZWFycmF5KGInQScgKiAxMDI0KQogICAgICAgIG12ID0gbWVtb3J5dmlldyhiYSkKCiAgICAgICAgY2xhc3MgUyhieXRlcyk6CiAgICAgICAgICAgIGRlZiBfX2xlbl9fKHNlbGYpOgogICAgICAgICAgICAgICAgbXYucmVsZWFzZSgpCiAgICAgICAgICAgICAgICBiYS5jbGVhcigpCiAgICAgICAgICAgICAgICByZXR1cm4gMQoKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhCdWZmZXJFcnJvciwgbXYuaGV4LCBTKGInOicpKQoKCiMgVmFyaWF0aW9ucyBvbiBzb3VyY2Ugb2JqZWN0cyBmb3IgdGhlIGJ1ZmZlcjogYnl0ZXMtbGlrZSBvYmplY3RzLCB0aGVuIGFycmF5cwojIHdpdGggaXRlbXNpemUgPiAxLgojIE5PVEU6IHN1cHBvcnQgZm9yIG11bHRpLWRpbWVuc2lvbmFsIG9iamVjdHMgaXMgdW5pbXBsZW1lbnRlZC4KCmNsYXNzIEJhc2VCeXRlc01lbW9yeVRlc3RzKEFic3RyYWN0TWVtb3J5VGVzdHMpOgogICAgcm9fdHlwZSA9IGJ5dGVzCiAgICByd190eXBpbihwYXRoLCAnY3VyJykpOgogICAgICAgICAgICBpZiBsZW4oZW50cnkpIDwgMSBvciBlbnRyeVswXSAhPSAnLic6CiAgICAgICAgICAgICAgICByYWlzZSBOb3RFbXB0eUVycm9yKCdGb2xkZXIgY29udGFpbnMgbWVzc2FnZShzKTogJXMnICUgZm9sZGVyKQogICAgICAgIGZvciBlbnRyeSBpbiBvcy5saXN0ZGlyKHBhdGgpOgogICAgICAgICAgICBpZiBlbnRyeSAhPSAnbmV3JyBhbmQgZW50cnkgIT0gJ2N1cicgYW5kIGVudHJ5ICE9ICd0bXAnIGFuZCBcCiAgICAgICAgICAgICAgIG9zLnBhdGguaXNkaXIob3MucGF0aC5qb2luKHBhdGgsIGVudHJ5KSk6CiAgICAgICAgICAgICAgICByYWlzZSBOb3RFbXB0eUVycm9yKCJGb2xkZXIgY29udGFpbnMgc3ViZGlyZWN0b3J5ICclcyc6ICVzIiAlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmb2xkZXIsIGVudHJ5KSkKICAgICAgICBmb3Igcm9vdCwgZGlycywgZmlsZXMgaW4gb3Mud2FsayhwYXRoLCB0b3Bkb3duPUZhbHNlKToKICAgICAgICAgICAgZm9yIGVudHJ5IGluIGZpbGVzOgogICAgICAgICAgICAgICAgb3MucmVtb3ZlKG9zLnBhdGguam9pbihyb290LCBlbnRyeSkpCiAgICAgICAgICAgIGZvciBlbnRyeSBpbiBkaXJzOgogICAgICAgICAgICAgICAgb3Mucm1kaXIob3MucGF0aC5qb2luKHJvb3QsIGVudHJ5KSkKICAgICAgICBvcy5ybWRpcihwYXRoKQoKICAgIGRlZiBjbGVhbihzZWxmKToKICAgICAgICAiIiJEZWxldGUgb2xkIGZpbGVzIGluICJ0bXAiLiIiIgogICAgICAgIG5vdyA9IHRpbWUudGltZSgpCiAgICAgICAgZm9yIGVudHJ5IGluIG9zLmxpc3RkaXIob3MucGF0aC5qb2luKHNlbGYuX3BhdGgsICd0bXAnKSk6CiAgICAgICAgICAgIHBhdGggPSBvcy5wYXRoLmpvaW4oc2VsZi5fcGF0aCwgJ3RtcCcsIGVudHJ5KQogICAgICAgICAgICBpZiBub3cgLSBvcy5wYXRoLmdldGF0aW1lKHBhdGgpID4gMTI5NjAwOiAgICMgNjAgKiA2MCAqIDM2CiAgICAgICAgICAgICAgICBvcy5yZW1vdmUocGF0aCkKCiAgICBfY291bnQgPSAxICAjIFRoaXMgaXMgdXNlZCB0byBnZW5lcmF0ZSB1bmlxdWUgZmlsZSBuYW1lcy4KCiAgICBkZWYgX2NyZWF0ZV90bXAoc2VsZik6CiAgICAgICAgIiIiQ3JlYXRlIGEgZmlsZSBpbiB0aGUgdG1wIHN1YmRpcmVjdG9yeSBhbmQgb3BlbiBhbmQgcmV0dXJuIGl0LiIiIgogICAgICAgIG5vdyA9IHRpbWUudGltZSgpCiAgICAgICAgaG9zdG5hbWUgPSBzb2NrZXQuZ2V0aG9zdG5hbWUoKQogICAgICAgIGlmICcvJyBpbiBob3N0bmFtZToKICAgICAgICAgICAgaG9zdG5hbWUgPSBob3N0bmFtZS5yZXBsYWNlKCcvJywgcidcMDU3JykKICAgICAgICBpZiAnOicgaW4gaG9zdG5hbWU6CiAgICAgICAgICAgIGhvc3RuYW1lID0gaG9zdG5hbWUucmVwbGFjZSgnOicsIHInXDA3MicpCiAgICAgICAgdW5pcSA9ICIlcy5NJXNQJXNRJXMuJXMiICUgKGludChub3cpLCBpbnQobm93ICUgMSAqIDFlNiksIG9zLmdldHBpZCgpLAppbk9wKGV4cHIsIGFzdC5TdWIoKSwgdGVybSwgbGluZW5vPWV4cHIubGluZW5vLCBjb2xfb2Zmc2V0PWV4cHIuY29sX29mZnNldCwgZW5kX2xpbmVubz10ZXJtLmVuZF9saW5lbm8sIGVuZF9jb2xfb2Zmc2V0PXRlcm0uZW5kX2NvbF9vZmZzZXQpIH0KICAgICAgICAgICAgfCB0ZXJtIHsgdGVybSB9CiAgICAgICAgICAgICkKICAgICAgICB0ZXJtOiAoIGw9dGVybSAnKicgcj1mYWN0b3IgeyBhc3QuQmluT3AobCwgYXN0Lk11bHQoKSwgciwgbGluZW5vPWwubGluZW5vLCBjb2xfb2Zmc2V0PWwuY29sX29mZnNldCwgZW5kX2xpbmVubz1yLmVuZF9saW5lbm8sIGVuZF9jb2xfb2Zmc2V0PXIuZW5kX2NvbF9vZmZzZXQpIH0KICAgICAgICAgICAgfCBsPXRlcm0gJy8nIHI9ZmFjdG9yIHsgYXN0LkJpbk9wKGwsIGFzdC5EaXYoKSwgciwgbGluZW5vPWwubGluZW5vLCBjb2xfb2Zmc2V0PWwuY29sX29mZnNldCwgZW5kX2xpbmVubz1yLmVuZF9saW5lbm8sIGVuZF9jb2xfb2Zmc2V0PXIuZW5kX2NvbF9vZmZzZXQpIH0KICAgICAgICAgICAgfCBmYWN0b3IgeyBmYWN0b3IgfQogICAgICAgICAgICApCiAgICAgICAgZmFjdG9yOiAoICcoJyBleHByICcpJyB7IGV4cHIgfQogICAgICAgICAgICAgICAgfCBhdG9tIHsgYXRvbSB9CiAgICAgICAgICAgICAgICApCiAgICAgICAgYXRvbTogKCBuPU5BTUUgeyBhc3QuTmFtZShpZD1uLnN0cmluZywgY3R4PWFzdC5Mb2FkKCksIGxpbmVubz1uLnN0YXJ0WzBdLCBjb2xfb2Zmc2V0PW4uc3RhcnRbMV0sIGVuZF9saW5lbm89bi5lbmRbMF0sIGVuZF9jb2xfb2Zmc2V0PW4uZW5kWzFdKSB9CiAgICAgICAgICAgIHwgbj1OVU1CRVIgeyBhc3QuQ29uc3RhbnQodmFsdWU9YXN0LmxpdGVyYWxfZXZhbChuLnN0cmluZyksIGxpbmVubz1uLnN0YXJ0WzBdLCBjb2xfb2Zmc2V0PW4uc3RhcnRbMV0sIGVuZF9saW5lbm89bi5lbmRbMF0sIGVuZF9jb2xfb2Zmc2V0PW4uZW5kWzFdKSB9CiAgICAgICAgICAgICkKICAgICAgICAiIiIKICAgICAgICBwYXJzZXJfY2xhc3MgPSBtYWtlX3BhcnNlcihncmFtbWFyKQogICAgICAgIG5vZGUgPSBwYXJzZV9zdHJpbmcoIigxICsgMiozICsgNSkvKDYgLSAyKVxuIiwgcGFyc2VyX2NsYXNzKQogICAgICAgIGNvZGUgPSBjb21waWxlKG5vZGUsICIiLCAiZXZhbCIpCiAgICAgICAgdmFsID0gZXZhbChjb2RlKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwodmFsLCAzLjApCgogICAgZGVmIHRlc3RfZl9zdHJpbmdfaW5fYWN0aW9uKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgZ3JhbW1hciA9ICIiIgogICAgICAgIHN0YXJ0OiBuPU5BTUUgTkVXTElORT8gJCB7IGYibmFtZSAtPiB7bi5zdHJpbmd9IiB9CiAgICAgICAgIiIiCiAgICAgICAgcGFyc2VyX2NsYXNzID0gbWFrZV9wYXJzZXIoZ3JhbW1hcikKICAgICAgICBub2RlID0gcGFyc2Vfc3RyaW5nKCJhIiwgcGFyc2VyX2NsYXNzKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwobm9kZS5zdHJpcCgpLCAibmFtZSAtPiAgYSIpCgphcmdzLmdldChVc2VyTW9kZWwuVVNFUk5BTUVfRklFTEQpCiAgICAgICAgaWYgdXNlcm5hbWUgaXMgTm9uZSBvciBwYXNzd29yZCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICB0cnk6CiAgICAgICAgICAgIHVzZXIgPSBhd2FpdCBVc2VyTW9kZWwuX2RlZmF1bHRfbWFuYWdlci5hZ2V0X2J5X25hdHVyYWxfa2V5KHVzZXJuYW1lKQogICAgICAgIGV4Y2VwdCBVc2VyTW9kZWwuRG9lc05vdEV4aXN0OgogICAgICAgICAgICAjIFJ1biB0aGUgZGVmYXVsdCBwYXNzd29yZCBoYXNoZXIgb25jZSB0byByZWR1Y2UgdGhlIHRpbWluZwogICAgICAgICAgICAjIGRpZmZlcmVuY2UgYmV0d2VlbiBhbiBleGlzdGluZyBhbmQgYSBub25leGlzdGVudCB1c2VyICgjMjA3NjApLgogICAgICAgICAgICBVc2VyTW9kZWwoKS5zZXRfcGFzc3dvcmQocGFzc3dvcmQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgYXdhaXQgdXNlci5hY2hlY2tfcGFzc3dvcmQocGFzc3dvcmQpIGFuZCBzZWxmLnVzZXJfY2FuX2F1dGhlbnRpY2F0ZSgKICAgICAgICAgICAgICAgIHVzZXIKICAgICAgICAgICAgKToKICAgICAgICAgICAgICAgIHJldHVybiB1c2VyCgogICAgZGVmIHVzZXJfY2FuX2F1dGhlbnRpY2F0ZShzZWxmLCB1c2VyKToKICAgICAgICAiIiIKICAgICAgICBSZWplY3QgdXNlcnMgd2l0aCBpc19hY3RpdmU9RmFsc2UuIEN1c3RvbSB1c2VyIG1vZGVscyB0aGF0IGRvbid0IGhhdmUKICAgICAgICB0aGF0IGF0dHJpYnV0ZSBhcmUgYWxsb3dlZC4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gZ2V0YXR0cih1c2VyLCAiaXNfYWN0aXZlIiwgVHJ1ZSkKCiAgICBkZWYgX2dldF91c2VyX3Blcm1pc3Npb25zKHNlbGYsIHVzZXJfb2JqKToKICAgICAgICByZXR1cm4gdXNlcl9vYmoudXNlcl9wZXJtaXNzaW9ucy5hbGwoKQoKICAgIGRlZiBfZ2V0X2dyb3VwX3Blcm1pc3Npb25zKHNlbGYsIHVzZXJfb2JqKToKICAgICAgICByZXR1cm4gUGVybWlzc2lvbi5vYmplY3RzLmZpbHRlcihncm91cF9faW49dXNlcl9vYmouZ3JvdXBzLmFsbCgpKQoKICAgIGRlZiBfZ2V0X3Blcm1pc3Npb25zKHNlbGYsIHVzZXJfb2JqLCBvYmosIGZyb21fbmFtZSk6CiAgICAgICAgIiIiCiAgICAgICAgUmV0dXJuIHRoZSBwZXJtaXNzaW9ucyBvZiBgdXNlcl9vYmpgIGZyb20gYGZyb21fbmFtZWAuIGBmcm9tX25hbWVgIGNhbgogICAgICAgIGJlIGVpdGhlciAiZ3JvdXAiIG9yICJ1c2VyIiB0byByZXR1cm4gcGVybWlzc2lvbnMgZnJvbQogICAgICAgIGBfZ2V0X2dyb3VwX3Blcm1pc3Npb25zYCBvciBgX2dldF91c2VyX3Blcm1pc3Npb25zYCByZXNwZWN0aXZlbHkuCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHVzZXJfb2JqLmlzX2FjdGl2ZSBvciB1c2VyX29iai5pc19hbm9ueW1vdXMgb3Igb2JqIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXR1cm4gc2V0KCkKCiAgICAgICAgcGVybV9jYWNoZV9uYW1lID0gIl8lc19wZXJtX2NhY2hlIiAlIGZncwojIFppcCBBcHBub3RlOiA0LjQuNCBnZW5lcmFsIHB1cnBvc2UgYml0IGZsYWc6ICgyIGJ5dGVzKQpfTUFTS19FTkNSWVBURUQgPSAxIDw8IDAKIyBCaXRzIDEgYW5kIDIgaGF2ZSBkaWZmZXJlbnQgbWVhbmluZ3MgZGVwZW5kaW5nIG9uIHRoZSBjb21wcmVzc2lvbiB1c2VkLgpfTUFTS19DT01QUkVTU19PUFRJT05fMSA9IDEgPDwgMQojIF9NQVNLX0NPTVBSRVNTX09QVElPTl8yID0gMSA8PCAyCiMgX01BU0tfVVNFX0RBVEFfREVTQ1JJUFRPUjogSWYgc2V0LCBjcmMtMzIsIGNvbXByZXNzZWQgc2l6ZSBhbmQgdW5jb21wcmVzc2VkCiMgc2l6ZSBhcmUgemVybyBpbiB0aGUgbG9jYWwgaGVhZGVyIGFuZCB0aGUgcmVhbCB2YWx1ZXMgYXJlIHdyaXR0ZW4gaW4gdGhlIGRhdGEKIyBkZXNjcmlwdG9yIGltbWVkaWF0ZWx5IGZvbGxvd2luZyB0aGUgY29tcHJlc3NlZCBkYXRhLgpfTUFTS19VU0VfREFUQV9ERVNDUklQVE9SID0gMSA8PCAzCiMgQml0IDQ6IFJlc2VydmVkIGZvciB1c2Ugd2l0aCBjb21wcmVzc2lvbiBtZXRob2QgOCwgZm9yIGVuaGFuY2VkIGRlZmxhdGluZy4KIyBfTUFTS19SRVNFUlZFRF9CSVRfNCA9IDEgPDwgNApfTUFTS19DT01QUkVTU0VEX1BBVENIID0gMSA8PCA1Cl9NQVNLX1NUUk9OR19FTkNSWVBUSU9OID0gMSA8PCA2CiMgX01BU0tfVU5VU0VEX0JJVF83ID0gMSA8PCA3CiMgX01BU0tfVU5VU0VEX0JJVF84ID0gMSA8PCA4CiMgX01BU0tfVU5VU0VEX0JJVF85ID0gMSA8PCA5CiMgX01BU0tfVU5VU0VEX0JJVF8xMCA9IDEgPDwgMTAKX01BU0tfVVRGX0ZJTEVOQU1FID0gMSA8PCAxMQojIEJpdCAxMjogUmVzZXJ2ZWQgYnkgUEtXQVJFIGZvciBlbmhhbmNlZCBjb21wcmVzc2lvbi4KIyBfTUFTS19SRVNFUlZFRF9CSVRfMTIgPSAxIDw8IDEyCiMgX01BU0tfRU5DUllQVEVEX0NFTlRSQUxfRElSID0gMSA8PCAxMwojIEJpdCAxNCwgMTU6IFJlc2VydmVkIGJ5IFBLV0FSRQojIF9NQVNLX1JFU0VSVkVEX0JJVF8xNCA9IDEgPDwgMTQKIyBfTUFTS19SRVNFUlZFRF9CSVRfMTUgPSAxIDw8IDE1CgojIFRoZSAibG9jYWwgZmlsZSBoZWFkZXIiIHN0cnVjdHVyZSwgbWFnaWMgbnVtYmVyLCBzaXplLCBhbmQgaW5kaWNlcwojIChzZWN0aW9uIFYuQSBpbiB0aGUgZm9ybWF0IGRvY3VtZW50KQpzdHJ1Y3RGaWxlSGVhZGVyID0gIjw0czJCNEhMMkwySCIKc3RyaW5nRmlsZUhlYWRlciA9IGIiUEtcMDAzXDAwNCIKc2l6ZUZpbGVIZWFkZXIgPSBzdHJ1Y3QuY2FsY3NpemUoc3RydWN0RmlsZUhlYWRlcikKCl9GSF9TSUdOQVRVUkUgPSAwCl9GSF9FWFRSQUNUX1ZFUlNJT04gPSAxCl9GSF9FWFRSQUNUX1NZU1RFTSA9IDIKX0ZIX0dFTkVSQUxfUFVSUE9TRV9GTEFHX0JJVFMgPSAzCl9GSF9DT01QUkVTU0lPTl9NRVRIT0QgPSA0Cl9GSF9MQVNUX01PRF9USU1FID0gNQpfRkhfTEFTVF9NT0RfREFURSA9IDYKX0ZIX0NSQyA9IDcKX0ZIX0NPTVBSRVNTRURfU0laRSA9IDgKX0ZIX1VOQ09NUFJFU1NFRF9TSVpFID0gOQpfRkh1aXJlZDogSXRlcmFibGVbUGFyYW1ldGVyXSwKICAgIHJpZ2h0OiBTZXF1ZW5jZVtJdGVyYWJsZVtQYXJhbWV0ZXJdXQopIC0+IHR1cGxlW1BhcmFtVHVwbGUsIC4uLl06CiAgICAiIiIKICAgIEdlbmVyYXRvciBmdW5jdGlvbiB0aGF0IGNvbXB1dGVzIHRoZSBzZXQgb2YgYWNjZXB0YWJsZQogICAgYXJndW1lbnQgbGlzdHMgZm9yIHRoZSBwcm92aWRlZCBpdGVyYWJsZXMgb2YKICAgIGFyZ3VtZW50IGdyb3Vwcy4gIChBY3R1YWxseSBpdCBnZW5lcmF0ZXMgYSB0dXBsZSBvZiB0dXBsZXMuKQoKICAgIEFsZ29yaXRobTogcHJlZmVyIGxlZnQgb3B0aW9ucyBvdmVyIHJpZ2h0IG9wdGlvbnMuCgogICAgSWYgcmVxdWlyZWQgaXMgZW1wdHksIGxlZnQgbXVzdCBhbHNvIGJlIGVtcHR5LgogICAgIiIiCiAgICByZXF1aXJlZCA9IHR1cGxlKHJlcXVpcmVkKQogICAgaWYgbm90IHJlcXVpcmVkOgogICAgICAgIGlmIGxlZnQ6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoInJlcXVpcmVkIGlzIGVtcHR5IGJ1dCBsZWZ0IGlzIG5vdCIpCgogICAgYWNjdW11bGF0b3I6IGxpc3RbUGFyYW1UdXBsZV0gPSBbXQogICAgY291bnRzID0gc2V0KCkKICAgIGZvciByIGluIHBlcm11dGVfcmlnaHRfb3B0aW9uX2dyb3VwcyhyaWdodCk6CiAgICAgICAgZm9yIGwgaW4gcGVybXV0ZV9sZWZ0X29wdGlvbl9ncm91cHMobGVmdCk6CiAgICAgICAgICAgIHQgPSBsICsgcmVxdWlyZWQgKyByCiAgICAgICAgICAgIGlmIGxlbih0KSBpbiBjb3VudHM6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBjb3VudHMuYWRkKGxlbih0KSkKICAgICAgICAgICAgYWNjdW11bGF0b3IuYXBwZW5kKHQpCgogICAgYWNjdW11bGF0b3Iuc29ydChrZXk9bGVuKQogICAgcmV0dXJuIHR1cGxlKGFjY3VtdWxhdG9yKQppbXBvcnQgZ2V0cGFzcwppbXBvcnQgb3MKaW1wb3J0IHVuaXR0ZXN0CmZyb20gaW8gaW1wb3J0IEJ5dGVzSU8sIFN0cmluZ0lPLCBUZXh0SU9XcmFwcGVyCmZyb20gdW5pdHRlc3QgaW1wb3J0IG1vY2sKZnJvbSB0ZXN0IGltcG9ydCBzdXBwb3J0Cgp0cnk6CiAgICBpbXBvcnQgdGVybWlvcwpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICB0ZXJtaW9zID0gTm9uZQp0cnk6CiAgICBpbXBvcnQgcHdkCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIHB3ZCA9IE5vbmUKCkBtb2NrLnBhdGNoKCdvcy5lbnZpcm9uJykKY2xhc3MgR2V0cGFzc0dldHVzZXJUZXN0KHVuaXR0ZXN0LlRlc3RDYXNlKToKCiAgICBkZWYgdGVzdF91c2VybmFtZV90YWtlc191c2VybmFtZV9mcm9tX2VudihzZWxmLCBlbnZpcm9uKToKICAgICAgICBleHBlY3RlZF9uYW1lID0gJ3NvbWVfbmFtZScKICAgICAgICBlbnZpcm9uLmdldC5yZXR1cm5fdmFsdWUgPSBleHBlY3RlZF9uYW1lCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChleHBlY3RlZF9uYW1lLCBnZXRwYXNzLmdldHVzZXIoKSkKCiAgICBkZWYgdGVzdF91c2VybmFtZV9wcmlvcml0aWVzX29mX2Vudl92YWx1b3J0JyksICAgICgnc3RlcCcsKSwKICAgIDM6ICgnY2FsbCcsIDUsICdtYWluJyksICAgICAgICAgICAgKCdicmVhaycsICgndGVzdF9tb2R1bGUucHknLCBOb25lLCBGYWxzZSwgTm9uZSwgJ2Z1bmMnKSksCiAgICA0OiAoJ05vbmUnLCA1LCAnbWFpbicpLCAgICAgICAgICAgICgnY29udGludWUnLCksCiAgICA1OiAoJ2xpbmUnLCAzLCAnZnVuYycsICh7MTogMX0sIFtdKSksICgnc3RlcCcsKSwKICAgICAgQnBOdW0gVGVtcCBFbmIgSGl0cyBJZ25vcmUgV2hlcmUKICAgICAgMSAgICAgbm8gICB5ZXMgMSAgICAwICAgICAgYXQgdGVzdF9tb2R1bGUucHk6MgogICAgNjogKCdyZXR1cm4nLCAzLCAnZnVuYycpLCAgICAgICAgICAoJ3N0ZXAnLCksCiAgICA3OiAoJ2xpbmUnLCA3LCAnbWFpbicpLCAgICAgICAgICAgICgnc3RlcCcsKSwKICAgIDg6ICgncmV0dXJuJywgNywgJ21haW4nKSwgICAgICAgICAgKCdxdWl0JywpLAoKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKCiAgICAiIiIKICAgIGRlZiBnZW4oYSwgYik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aGlsZSAxOgogICAgICAgICAgICAgICAgeCA9IG5leHQoYSkKICAgICAgICAgICAgICAgIHkgPSBuZXh0KGIpCiAgICAgICAgICAgICAgICB5aWVsZCB4CiAgICAgICAgICAgICAgICB5aWVsZCB5CiAgICAgICAgZXhjZXB0IFN0b3BJdGVyYXRpb246CiAgICAgICAgICAgIHJldHVybgoKICAgICMgU3RlcCBvdmVyIHRoZSBpbXBvcnQgc3RhdGVtZW50IGluIHRmdW5jX2ltcG9ydCB1c2luZyAnbmV4dCcgYW5kIHN0ZXAKICAgICMgaW50byBtYWluKCkgaW4gdGVzdF9tb2R1bGUuCiAgICBzbCA9IFsoJ25leHQnLCApLCAoJ3N0ZXAnLCApXQogICAgc2wuZXh0ZW5kKHNldF9saXN0KQoKICAgIHRlc3QgPSBCYXNlVGVzdENhc2UoKQogICAgdGVzdC5kcnlfcnVuID0gVHJ1ZQogICAgdGVzdC5pZCA9IGxhbWJkYSA6IE5vbmUKICAgIHRlc3QuZXhwZWN0X3NldCA9IGxpc3QoZ2VuKHJlcGVhdCgoKSksIGl0ZXIoc2wpKSkKICAgIHdpdGggY3JlYXRlX21vZHVsZXMobW9kdWxlcyk6CiAgICAgICAgd2l0aCBUcmFjZXJSdW4odGVzdCwgc2tpcD1za2lwKSBhcyB0cmFjZXI6CiAgICAgICAgICAgIHRyYWNlci5ydW5jYWxsKHRmdW5jX2ltcG9ydCkKCkBjb250ZXh0bWFuYWdlcgpkZWYgY3JlYXRlX21vZHVsZXMobW9kdWxlcyk6CiAgICB3aXRoIG9zX2hlbHBlci50ZW1wX2N3ZCgpOgogICAgICAgIHN5cy5wYXRoLmFwcGVuZChvcy5nZXRjd2QoKSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZvciBtIGluIG1vZHVsZXM6CiAgICAgICAgICAgICAgICBmbmFtZSA9IG0gKyAnLnB5JwogICAgICAgICAgICAgICAgd2l0aCBvcGVuKGZuYW1lLCAndycsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgZi53cml0ZSh0ZXh0d3JhcC5kZWRlbnQobW9kdWxlc1ttdHpvZmZzZXQgPSB0enNpZ24gKiAoICh0em9mZnNldC8vMTAwKSozNjAwICsgKHR6b2Zmc2V0ICUgMTAwKSo2MCkKICAgICMgRGF5bGlnaHQgU2F2aW5nIFRpbWUgZmxhZyBpcyBzZXQgdG8gLTEsIHNpbmNlIERTVCBpcyB1bmtub3duLgogICAgcmV0dXJuIFt5eSwgbW0sIGRkLCB0aGgsIHRtbSwgdHNzLCAwLCAxLCAtMSwgdHpvZmZzZXRdCgoKZGVmIHBhcnNlZGF0ZShkYXRhKToKICAgICIiIkNvbnZlcnQgYSB0aW1lIHN0cmluZyB0byBhIHRpbWUgdHVwbGUuIiIiCiAgICB0ID0gcGFyc2VkYXRlX3R6KGRhdGEpCiAgICBpZiBpc2luc3RhbmNlKHQsIHR1cGxlKToKICAgICAgICByZXR1cm4gdFs6OV0KICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIHQKCgpkZWYgbWt0aW1lX3R6KGRhdGEpOgogICAgIiIiVHVybiBhIDEwLXR1cGxlIGFzIHJldHVybmVkIGJ5IHBhcnNlZGF0ZV90eigpIGludG8gYSBQT1NJWCB0aW1lc3RhbXAuIiIiCiAgICBpZiBkYXRhWzldIGlzIE5vbmU6CiAgICAgICAgIyBObyB6b25lIGluZm8sIHNvIGxvY2FsdGltZSBpcyBiZXR0ZXIgYXNzdW1wdGlvbiB0aGFuIEdNVAogICAgICAgIHJldHVybiB0aW1lLm1rdGltZShkYXRhWzo4XSArICgtMSwpKQogICAgZWxzZToKICAgICAgICAjIERlbGF5IHRoZSBpbXBvcnQsIHNpbmNlIG1rdGltZV90eiBpcyByYXJlbHkgdXNlZAogICAgICAgIGltcG9ydCBjYWxlbmRhcgoKICAgICAgICB0ID0gY2FsZW5kYXIudGltZWdtKGRhdGEpCiAgICAgICAgcmV0dXJuIHQgLSBkYXRhWzldCgoKZGVmIHF1b3RlKHN0cik6CiAgICAiIiJQcmVwYXJlIHN0cmluZyB0byBiZSB1c2VkIGluIGEgcXVvdGVkIHN0cmluZy4KCiAgICBUdXJucyBiYWNrc2xhc2ggYW5kIGRvdWJsZSBxdW90ZSBjaGFyYWN0ZXJzIGludG8gcXVvdGVkIHBhaXJzLiAgVGhlc2UKICAgIGFyZSB0aGUgb25seSBjaGFyYWN0ZXJzIHRoYXQgbmVlZCB0byBiZSBxdW90ZWQgaW5zaWRlIGEgcXVvdGVkIHN0cmluZy4KICAgIERvZXMgbm90IGFkZCB0aGUgc3Vycm91bmRpbmcgZG91YmxlIHF1b3Rlcy4KICAgICIiIgogICAgcmV0dXJuIHN0ci5yZXBsYWNlKCdcXCcsICdcXFxcJykucmVwbGFjZSgnIicsICdcXCInKQoKCmNsYXNzIEFkZHJsaXN0Q2xhc3M6CiAgICAiIiJBZGRyZXNzIHBhcnNlciBjbGFzcyBieSBCZW4gRXNjb3RvLgoKICAgIFRvIHVuZGVyc3RhbmQgd2hhdCB0aGlzIGNsYXNzIGRvZXMsIGl0IGhlbHBzIHRvIGhhdmUgYSBjb3B5IG9mIFJGQyAyODIyIGluCiAgICBmcm9udCBvZiB5b3UuCgogICAgTm90ZTogdGhpcyBjbGFzcyBpbnRlcmZhY2UgaXMgZGVwcmVjYXRlZCBhbmQgbWF5IGJlIHJlbW92ZWQgaW4gdGhlIGZ1dHVyZS4KICAgIFVzZSBlbWFpbC51dGlscy5BZGRyZXNzTGlzdCBpbnN0ZWFkLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGZpZWxkKToKICAgICAgICAiIiJJbml0aWFsaXplIGEgbmV3IGluc3RhbmNlLgoKICAgICAgICAnZmllbGQnIGlzIGFuIHVucGFyc2VkIGFkLCAyLCAxMCwgVHJ1ZSwgRmFsc2UpKSkKICAgICAgICBFcXVhbChzZWFyY2godGV4dCwgcGF0LCBUcnVlKSwgKCdiJywgKHRleHQsIHBhdCwgMiwgMTYsIFRydWUsIFRydWUpKSkKCgpjbGFzcyBGb3J3YXJkQmFja3dhcmRUZXN0KHVuaXR0ZXN0LlRlc3RDYXNlKToKICAgICMgVGVzdCB0aGF0IHNlYXJjaF9mb3J3YXJkIG1ldGhvZCBmaW5kcyB0aGUgdGFyZ2V0LgojIyAgICBAY2xhc3NtZXRob2QKIyMgICAgZGVmIHRlYXJEb3duQ2xhc3MoY2xzKToKIyMgICAgICAgIGNscy5yb290LmRlc3Ryb3koKQojIyAgICAgICAgZGVsIGNscy5yb290CgogICAgQGNsYXNzbWV0aG9kCiAgICBkZWYgc2V0VXBDbGFzcyhjbHMpOgogICAgICAgIGNscy5lbmdpbmUgPSBzZS5TZWFyY2hFbmdpbmUoTm9uZSkKIyMgICAgICAgIHJlcXVpcmVzKCdndWknKQojIyAgICAgICAgY2xzLnJvb3QgPSBUaygpCiMjICAgICAgICBjbHMudGV4dCA9IFRleHQobWFzdGVyPWNscy5yb290KQogICAgICAgIGNscy50ZXh0ID0gbW9ja1RleHQoKQogICAgICAgICMgc2VhcmNoX2JhY2t3YXJkIGNhbGxzIGluZGV4KCdlbmQtMWMnKQogICAgICAgIGNscy50ZXh0LmluZGV4ID0gbGFtYmRhIGluZGV4OiAnNC4wJwogICAgICAgIHRlc3RfdGV4dCA9ICgKICAgICAgICAgICAgJ0ZpcnN0IGxpbmVcbicKICAgICAgICAgICAgJ0xpbmUgd2l0aCB0YXJnZXRcbicKICAgICAgICAgICAgJ0xhc3QgbGluZVxuJykKICAgICAgICBjbHMudGV4dC5pbnNlcnQoJzEuMCcsIHRlc3RfdGV4dCkKICAgICAgICBjbHMucGF0ID0gcmUuY29tcGlsZSgndGFyZ2V0JykKICAgICAgICBjbHMucmVzID0gKDIsICgxMCwgMTYpKSAgIyBsaW5lLCBzbGljZSBpbmRleGVzIG9mICd0YXJnZXQnCiAgICAgICAgY2xzLmZhaWxwYXQgPSByZS5jb21waWxlKCd4eXonKSAgIyBub3QgaW4gdGV4dAogICAgICAgIGNscy5lbXB0eXBhdCA9IHJlLmNvbXBpbGUocidcdyonKSAgIyBlbXB0eSBtYXRjaCBwb3NzaWJsZQoKICAgIGRlZiBtYWtlX3NlYXJjaChzZWxmLCBmdW5jKToKICAgICAgICBkZWYgc2VhcmNoKHBhdCwgbGluZSwgY29sLCB3cmFwLCBvaz0wKToKICAgICAgICAgICAgcmVzID0gZnVuYyhzZWxmLnRleHQsIHBhdCwgbGluZSwgY29sLCB3cmFwLCBvaykKICAgICAgICAgICAgIyByZXMgaXMgKGxpbmUsIG1hdGNob2JqZWN0KSBvciBOb25lCiAgICAgICAgICAgIHJldHVybiAocmVzWzBdLCByZXNbMV0uc3BhbigpKSBpZiByZXMgZWxzZSByZXMKICAgICAgICByZXR1cm4gc2VhcmNoCgogICAgZGVmIHRlc3Rfc2VhcmNoX2ZvcndhcmQoc2VsZik6CiAgICAgICAgIyBzZWFyY2ggZm9yIG5vbi1lbXB0eSBtYXRjaAogICAgICAgIEVxdWFsID0gc2VsZi5hc3NlcnRFcXVhbAogICAgICAgIGZvcndhcmQgPSBzZWxmLm1ha2Vfc2VhcmNoKHNlbGYuZW5naW5lLnNlYXJjaF9mb3J3YXJkKQogICAgICAgIHBhdCA9IHNlbGYucGF0CiAgICAgICAgRXF1YWwoZm9yd2FyZChwYXQsIDEsIDAsIFRydWUpLCBzb2xkZXIKICAgICAgICAgICAgICAgICMgQWRkIGNvbHVtbnMgYWxpYXNlcyB0byB0aGUgZmlyc3Qgc2VsZWN0IHRvIGF2b2lkICJPUkEtMDA5MTg6CiAgICAgICAgICAgICAgICAjIGNvbHVtbiBhbWJpZ3VvdXNseSBkZWZpbmVkIiB3aGVuIHR3byBvciBtb3JlIGNvbHVtbnMgaW4gdGhlCiAgICAgICAgICAgICAgICAjIGZpcnN0IHNlbGVjdCBoYXZlIHRoZSBzYW1lIHZhbHVlLgogICAgICAgICAgICAgICAgaWYgbm90IHF1ZXJ5OgogICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyID0gIiVzIGNvbF8lcyIgJSAocGxhY2Vob2xkZXIsIGkpCiAgICAgICAgICAgICAgICBzZWxlY3QuYXBwZW5kKHBsYWNlaG9sZGVyKQogICAgICAgICAgICBzdWZmaXggPSBzZWxmLmNvbm5lY3Rpb24uZmVhdHVyZXMuYmFyZV9zZWxlY3Rfc3VmZml4CiAgICAgICAgICAgIHF1ZXJ5LmFwcGVuZChmIlNFTEVDVCAlc3tzdWZmaXh9IiAlICIsICIuam9pbihzZWxlY3QpKQogICAgICAgICMgQnVsayBpbnNlcnQgdG8gdGFibGVzIHdpdGggT3JhY2xlIGlkZW50aXR5IGNvbHVtbnMgY2F1c2VzIE9yYWNsZSB0bwogICAgICAgICMgYWRkIHNlcXVlbmNlLm5leHR2YWwgdG8gaXQuIFNlcXVlbmNlLm5leHR2YWwgY2Fubm90IGJlIHVzZWQgd2l0aCB0aGUKICAgICAgICAjIFVOSU9OIG9wZXJhdG9yLiBUbyBwcmV2ZW50IGluY29ycmVjdCBTUUwsIG1vdmUgVU5JT04gdG8gYSBzdWJxdWVyeS4KICAgICAgICByZXR1cm4gIlNFTEVDVCAqIEZST00gKCVzKSIgJSAiIFVOSU9OIEFMTCAiLmpvaW4ocXVlcnkpCgogICAgZGVmIHN1YnRyYWN0X3RlbXBvcmFscyhzZWxmLCBpbnRlcm5hbF90eXBlLCBsaHMsIHJocyk6CiAgICAgICAgaWYgaW50ZXJuYWxfdHlwZSA9PSAiRGF0ZUZpZWxkIjoKICAgICAgICAgICAgbGhzX3NxbCwgbGhzX3BhcmFtcyA9IGxocwogICAgICAgICAgICByaHNfc3FsLCByaHNfcGFyYW1zID0gcmhzCiAgICAgICAgICAgIHBhcmFtcyA9ICgqbGhzX3BhcmFtcywgKnJoc19wYXJhbXMpCiAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAiTlVNVE9EU0lOVEVSVkFMKFRPX05VTUJFUiglcyAtICVzKSwgJ0RBWScpIiAlIChsaHNfc3FsLCByaHNfc3FsKSwKICAgICAgICAgICAgICAgIHBhcmFtcywKICAgICAgICAgICAgKQogICAgICAgIHJldHVybiBzdXBlcigpLnN1YnRyYWN0X3RlbXBvcmFscyhpbnRlcm5hbF90eXBlLCBsaHMsIHJocykKCiAgICBkZWYgY29uZGl0aW9uYWxfZXhwcmVzc2lvbl9zdXBwb3J0ZWRfaW5fd2hlcmVfY2xhdXNlKHNlbGYsIGV4cHJlc3Npb24pOgogICAgICAgICIiIgogICAgICAgIE9yYWNsZSBzdXBwb3J0cyBvbmx5IEVYSVNUUyguLi4pIG9yIGZpbHRlcnMgaW4gdGhlIFdIRVJFIGNsYXVzZSwgb3RoZXJzCiAgICAgICAgbXVzdCBiZSBjb21wYXJlZCB3aXRoIFRydWUuCiAgICAgICAgIiIiCiAgICAgICAgaWYgaXNpbnN0YW5jZShleHByZXNzaW9uLCAoRXhpc3RzLCBMb29rdXAsIFdoZXJlTm9kZi5jb25zb2xlID0gY29kZS5JbnRlcmFjdGl2ZUNvbnNvbGUobG9jYWxfZXhpdD1UcnVlKQogICAgICAgIHNlbGYubW9ja19zeXMoKQoKICAgIEB1bml0dGVzdC5za2lwSWYoc3lzLmZsYWdzLm5vX3NpdGUsICJleGl0KCkgaXNuJ3QgZGVmaW5lZCB1bmxlc3MgdGhlcmUncyBhIHNpdGUgbW9kdWxlIikKICAgIGRlZiB0ZXN0X2V4aXQoc2VsZik6CiAgICAgICAgIyBkZWZhdWx0IGV4aXQgbWVzc2FnZQogICAgICAgIHNlbGYuaW5mdW5jLnNpZGVfZWZmZWN0ID0gWyJleGl0KCkiXQogICAgICAgIHNlbGYuY29uc29sZS5pbnRlcmFjdChiYW5uZXI9JycpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChsZW4oc2VsZi5zdGRlcnIubWV0aG9kX2NhbGxzKSwgMikKICAgICAgICBlcnJfbXNnID0gc2VsZi5zdGRlcnIubWV0aG9kX2NhbGxzWzFdCiAgICAgICAgZXhwZWN0ZWQgPSAnbm93IGV4aXRpbmcgSW50ZXJhY3RpdmVDb25zb2xlLi4uXG4nCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChlcnJfbXNnLCBbJ3dyaXRlJywgKGV4cGVjdGVkLCksIHt9XSkKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgdW5pdHRlc3QubWFpbigpCmltcG9ydCBvcwpmcm9tIHVuaXR0ZXN0Lm1vY2sgaW1wb3J0IHBhdGNoCgppbXBvcnQgZGphbmdvCmZyb20gZGphbmdvLmFwcHMgaW1wb3J0IEFwcENvbmZpZywgYXBwcwpmcm9tIGRqYW5nby5hcHBzLnJlZ2lzdHJ5IGltcG9ydCBBcHBzCmZyb20gZGphbmdvLmNvbnRyaWIuYWRtaW4ubW9kZWxzIGltcG9ydCBMb2dFbnRyeQpmcm9tIGRqYW5nby5jb3JlLmV4Y2VwdGlvbnMgaW1wb3J0IEFwcFJlZ2lzdHJ5Tm90UmVhZHksIEltcHJvcGVybHlDb25maWd1cmVkCmZyb20gZGphbmdvLmRiIGltcG9ydCBjb25uZWN0aW9ucywgbW9kZWxzCmZyb20gZGphbmdvLnRlc3QgaW1wb3J0ICgKICAgIFNpbXBsZVRlc3RDYXNlLAogICAgVHJhbnNhY3Rpb25UZXN0Q2FzZSwKICAgIG92ZXJyaWRlX3NldHRpbmdzLAogICAgc2tpcFVubGVzc0RCRmVhdHVyZSwKKQpmcm9tIGRqYW5nby50ZXN0LnV0aWxzIGltcG9ydCBleHRlbmRfc3lzX3BhdGgsIGlzb2xhdGVfYXBwcwpmcm9tIGRqYW5nby51dGlscy5mdW5jdGlvbmFsIGltcG9ydCBjYWNoZWRfcHJvcGVydHkKCmZyb20gLm1vZGVscyBpbXBvcnQgU29BbHRlcm5hdGl2ZSwgVG90YWxseU5vcm1hbCwgbmV3X2FwcHMKZnJvbSAub25lX2NvbmZpZ19hcHAuYXBwcyBpbXBvcnQgT25lQ29uZmlnCmZyb20gLnR3b19jb25maWdzX29uZV9kZWZhdWx0X2FwcC5hcHBzIGltcG9ydCBUd29Db25maWcKCiMgU21hbGwgbGlzdCB3aXRoIGEgdmFyaWV0eSBvZiBjYXNlcyBmb3IgdGVzdHMgdGhhdCBpdGVyYXRlIG9uIGluc3RhbGxlZCBhcHBzLgojIEludGVudGlvbmFsbHkgbm90IGluIGFscGhhYmV0aWNhbCBvcmRlciB0byBjaGVjayBpZiB0aGUgb3JkZXIgaXMgcHJlc2VydmVkLgoKU09NRV9JTlNUQUxMRURfQVBQUyA9IFsKICAgICJhcHBzLmFwcHMuTXlBZG1pbiIsCiBtc2V0Lm5vbl9mb3JtX2Vycm9ycygpLAogICAgICAgICAgICBbIlBsZWFzZSBzdWJtaXQgYXQgbW9zdCAzMCBmb3Jtcy4iXSwKICAgICAgICApCgogICAgZGVmIHRlc3RfYWJzb2x1dGVfbWF4X2ludmFsaWQoc2VsZik6CiAgICAgICAgbXNnID0gIidhYnNvbHV0ZV9tYXgnIG11c3QgYmUgZ3JlYXRlciBvciBlcXVhbCB0byAnbWF4X251bScuIgogICAgICAgIGZvciBtYXhfbnVtIGluIFtOb25lLCAzMV06CiAgICAgICAgICAgIHdpdGggc2VsZi5zdWJUZXN0KG1heF9udW09bWF4X251bSk6CiAgICAgICAgICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzTWVzc2FnZShWYWx1ZUVycm9yLCBtc2cpOgogICAgICAgICAgICAgICAgICAgIGZvcm1zZXRfZmFjdG9yeShGYXZvcml0ZURyaW5rRm9ybSwgbWF4X251bT1tYXhfbnVtLCBhYnNvbHV0ZV9tYXg9MzApCgogICAgZGVmIHRlc3RfbW9yZV9pbml0aWFsX2Zvcm1fcmVzdWx0X2luX29uZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBPbmUgZm9ybSBmcm9tIGluaXRpYWwgYW5kIGV4dHJhPTMgd2l0aCBtYXhfbnVtPTIgcmVzdWx0cyBpbiB0aGUgb25lCiAgICAgICAgaW5pdGlhbCBmb3JtIGFuZCBvbmUgZXh0cmEuCiAgICAgICAgIiIiCiAgICAgICAgTGltaXRlZEZhdm9yaXRlRHJpbmtGb3JtU2V0ID0gZm9ybXNldF9mYWN0b3J5KAogICAgICAgICAgICBGYXZvcml0ZURyaW5rRm9ybSwgZXh0cmE9MywgbWF4X251bT0yCiAgICAgICAgKQogICAgICAgIGZvcm1zZXQgPSBMaW1pdGVkRmF2b3JpdGVEcmlua0Zvcm1TZXQoaW5pdGlhbD1beyJuYW1lIjogIkdpbiBUb25pYyJ9XSkKICAgICAgICBzZWxmLmFzc2VydEhUTUxFcXVhbCgKICAgICAgICAgICAgIlxuIi5qb2luKHN0cihmb3JtKSBmb3IgZm9ybSBpbiBmb3Jtc2V0LmZvcm1zKSwKICAgICAgICAgICAgIiIiCiAgICAgICAgICAgIDxkaXY+PGxhYmVsIGZvcj0iaWRfZm9ybS0wLW5hbWUiPk5hbWU6PC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImZvcm0tMC1uYW1lIiB2YWx1ZT0iR2luIFRvbmljIiBpZD0iaWRfZm9ybS0wLW5hbWUiPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdj48bGFiZWwgZm9yPSJpZF9mb3JtLTEtbmFtZSI+TmFtZTo8L2xhYmVsPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0iZm9ybS0xLW5hbWUiIGlkPSJpZF9mb3JtLTEtbmFtZSI+PC9kaXY+IiIiLAogICAgICAgICkKCiAgICBkZWYgdGVzdF9tYW5hZ2VtZW50X2Zvcm1fZmllbGRfbmFtZXMoc2VsZik6CiAgICAgICAgIiIiVGhlIG1hbmFnZW1lbnQgZm9ybSBjbGFzcyBoYXMgZmllbGQgbmFtZXMgbWF0Y2hpbmcgdGhlIGNvbnN0YW50cy4iIiIKICAgICAgICBzZWxmLmFzc2VydENvdW50RXF1YWwoCiAgICAgICAgICAgIE1hbmFnZW1lbnRGb3JtLmJhc2VfZmllbGRzLAogICAgICAgICAgICBbCiAgICAgICAgICAgICAgICBUT1RBTF9GT1JNX0NPVU5ULAogICAnXHhkNycgICAgICMgIDB4RDcgLT4gTVVMVElQTElDQVRJT04gU0lHTgogICAgJ1x1MDE1OCcgICAjICAweEQ4IC0+IExBVElOIENBUElUQUwgTEVUVEVSIFIgV0lUSCBDQVJPTgogICAgJ1x1MDE2ZScgICAjICAweEQ5IC0+IExBVElOIENBUElUQUwgTEVUVEVSIFUgV0lUSCBSSU5HIEFCT1ZFCiAgICAnXHhkYScgICAgICMgIDB4REEgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgVSBXSVRIIEFDVVRFCiAgICAnXHUwMTcwJyAgICMgIDB4REIgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgVSBXSVRIIERPVUJMRSBBQ1VURQogICAgJ1x4ZGMnICAgICAjICAweERDIC0+IExBVElOIENBUElUQUwgTEVUVEVSIFUgV0lUSCBESUFFUkVTSVMKICAgICdceGRkJyAgICAgIyAgMHhERCAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBZIFdJVEggQUNVVEUKICAgICdcdTAxNjInICAgIyAgMHhERSAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBUIFdJVEggQ0VESUxMQQogICAgJ1x4ZGYnICAgICAjICAweERGIC0+IExBVElOIFNNQUxMIExFVFRFUiBTSEFSUCBTCiAgICAnXHUwMTU1JyAgICMgIDB4RTAgLT4gTEFUSU4gU01BTEwgTEVUVEVSIFIgV0lUSCBBQ1VURQogICAgJ1x4ZTEnICAgICAjICAweEUxIC0+IExBVElOIFNNQUxMIExFVFRFUiBBIFdJVEggQUNVVEUKICAgICdceGUyJyAgICAgIyAgMHhFMiAtPiBMQVRJTiBTTUFMTCBMRVRURVIgQSBXSVRIIENJUkNVTUZMRVgKICAgICdcdTAxMDMnICAgIyAgMHhFMyAtPiBMQVRJTiBTTUFMTCBMRVRURVIgQSBXSVRIIEJSRVZFCiAgICAnXHhlNCcgICAgICMgIDB4RTQgLT4gTEFUSU4gU01BTEwgTEVUVEVSIEEgV0lUSCBESUFFUkVTSVMKICAgICdcdTAxM2EnICAgIyAgMHhFNSAtPiBMQVRJTiBTTUFMTCBMRVRURVIgTCBXSVRIIEFDVVRFCiAgICAnXHUwMTA3JyAgICMgIDB4RTYgLT4gTEFUSU4gU01BTEwgTEVUVEVSIEMgV0lUSCBBQ1VURQogICAgJ1x4ZTcnICAgICAjICAweEU3IC0+IExBVElOIFNNQUxMIExFVFRFUiBDIFdJVEggQ0VESUxMQQogICAgJ1x1MDEwZCcgICAjICAweEU4IC0+IExBVElOIFNNQUxMIExFVFRFUiBDIFdJVEggQ0FST04KICAgICdceGU5JyAgICAgIyAgMHhFOSAtPiBMQVRJTiBTTUFMTCBMRVRURVIgRSBXSVRIIEFDVVRFCiAgICAnXHUwMTE5JyAgICMgIDB4RUEgLT4gTEFUSU4gU01BTEwgTEVUVEVSIEUgV0lUSCBPR09ORUsKICAgICdceGViJyAgICAgIyAgMHhFQiAtPiBMQVRJTiBTTUFMTCBMRVRURVIgRSBXSVRIIERJQUVSRVNJUwogICAgJ1x1MDExYicgICAjICAweEVDIC0+IExBVElOIFNNQUxMIExFVFRFUiBFIFdJVEggQ0FST04KICAgICdceGVkJyAgICAgIyAgMHhFRCAtPiBMQVRJTiBTTUFMTCBMRVRURVIgSSBXSVRIIEFDVVRFCiAgICAnXHhlZScgICAgICMgIDB4RUUgLT4gTEFUSU4gU01BTEwgTEVUVEVSIEkgV0lUSCBDSVJDVU1GTEVYCiAgICAnXHUwMTBmJyAgICMgIDB4RUYgLT4gTEFUSU4gU01BTEwgTEVUVEVSIEQgV0lUSCBDQVJPTgogICAgJ1x1MDExMWNhbGxfd2l0aF9mdW5jdGlvbl9zcGVjKHNlbGYpOgogICAgICAgIGRlZiBmKGEsIGIsIGMsIGQ9Tm9uZSk6IHBhc3MKCiAgICAgICAgbW9jayA9IE1vY2soc3BlYz1mKQoKICAgICAgICBtb2NrKDEsIGI9MiwgYz0zKQogICAgICAgIG1vY2soNCwgNSwgYz02LCBkPTcpCiAgICAgICAgbW9jay5hc3NlcnRfYW55X2NhbGwoMSwgMiwgMykKICAgICAgICBtb2NrLmFzc2VydF9hbnlfY2FsbChhPTEsIGI9MiwgYz0zKQogICAgICAgIG1vY2suYXNzZXJ0X2FueV9jYWxsKDQsIDUsIDYsIDcpCiAgICAgICAgbW9jay5hc3NlcnRfYW55X2NhbGwoYT00LCBiPTUsIGM9NiwgZD03KQogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKEFzc2VydGlvbkVycm9yLCBtb2NrLmFzc2VydF9hbnlfY2FsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAxLCBiPTMsIGM9MikKICAgICAgICAjIEV4cGVjdGVkIGNhbGwgZG9lc24ndCBtYXRjaCB0aGUgc3BlYydzIHNpZ25hdHVyZQogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXMoQXNzZXJ0aW9uRXJyb3IpIGFzIGNtOgogICAgICAgICAgICBtb2NrLmFzc2VydF9hbnlfY2FsbChlPTgpCiAgICAgICAgc2VsZi5hc3NlcnRJc0luc3RhbmNlKGNtLmV4Y2VwdGlvbi5fX2NhdXNlX18sIFR5cGVFcnJvcikKCgogICAgZGVmIHRlc3RfbW9ja19jYWxsc19jcmVhdGVfYXV0b3NwZWMoc2VsZik6CiAgICAgICAgZGVmIGYoYSwgYik6IHBhc3MKICAgICAgICBvYmogPSBJdGVyKCkKICAgICAgICBvYmouZiA9IGYKCiAgICAgICAgZnVuY3MgPSBbCiAgICAgICAgICAgIGNyZWF0ZV9hdXRvc3BlYyhmKSwKICAgICAgICAgICAgY3JlYXRlX2F1dG9zcGVjKG9iaikuZgogICAgICAgIF0KICAgICAgICBmb3IgZnVuYyBpbiBmdW5jczoKICAgICAgICAgICAgZnVuYygxLCAyKQogICAgICAgICAgICBmdW5jKDMsIDQpCgogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKAogICAgICAgICAgICAgICAgZnVuYy5tb2NrX2NhbGxzLCBbY2FsbCgxLCAyKSwgY2FsbCgzLCA0KV0KICAgICAgICAgICAgKQoKICAgICNJc3N1ZTIxMjIyCiAgICBkZWYgdGVzdF9jcmVhdGVfYXV0b3NwZWNfd2l0aF9uYW1lKHNlbGYpOgogICAgICAgIG0gPSBtb2NrLmNyZWF0ZV9hdXRvc3BlYyhvYmplY3QoKSwgbmFtZT0nc3dlZXRfZnVuYycpCiAgICAgICAgc2VsZi5hc3NlcnRJbignc3dlZXRfZnVuYycsIHJlcHIobSkpCgogICAgI0lzc3VlMjMwNzgKICAgIGRlZiB0ZXN0X2NyZWF0ZV9hdXRvc3BlY19jbGFzc21ldGhvZF9hbmRfc3RhdGljbWV0aG9kKHNlbGYpOgogICAgICAgIGNsYXNzIFRlc3RDbGFzczoKICAgICAgICAgICAgQGNsYXNzbWV0aG9kCiAgICAgICAgICAgIGRlZiBjbGFzc19tZXRob2QoY2xzKTogcGFzcwoKICAgICAgICAgICAgQHN0YXRpY21ldGhvZAogICAgICAgICAgICBkZWYgc3RhdGljX21ldGhvZCgpOiBwYXNzCiAgICAgICAgZm9yIG1ldGhvZCBpbiAoJ2NsYXNzX21ldGhvZCcsICdzdGF0aWNfbWV0aG9kJyk6CmFsKG1vZHVsZS5fX25hbWVfXywgJ3BrZycpCgogICAgZGVmIHRlc3Rfd2Fybl93aGVuX3BhY2thZ2VfYW5kX3NwZWNfZGlzYWdyZWUoc2VsZik6CiAgICAgICAgIyBSYWlzZSBhIERlcHJlY2F0aW9uV2FybmluZyBpZiBfX3BhY2thZ2VfXyAhPSBfX3NwZWNfXy5wYXJlbnQuCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFdhcm5zKERlcHJlY2F0aW9uV2FybmluZyk6CiAgICAgICAgICAgIHNlbGYuaW1wb3J0X21vZHVsZSh7J19fcGFja2FnZV9fJzogJ3BrZy5mYWtlJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnX19zcGVjX18nOiBGYWtlU3BlYygncGtnLmZha2VmYWtlJyl9KQoKICAgIGRlZiB0ZXN0X2JhZF9fcGFja2FnZV9fKHNlbGYpOgogICAgICAgIGdsb2JhbHMgPSB7J19fcGFja2FnZV9fJzogJzxub3QgcmVhbD4nfQogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXMoTW9kdWxlTm90Rm91bmRFcnJvcik6CiAgICAgICAgICAgIHNlbGYuX19pbXBvcnRfXygnJywgZ2xvYmFscywge30sIFsncmVsaW1wb3J0J10sIDEpCgogICAgZGVmIHRlc3RfYnVua19fcGFja2FnZV9fKHNlbGYpOgogICAgICAgIGdsb2JhbHMgPSB7J19fcGFja2FnZV9fJzogNDJ9CiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFJhaXNlcyhUeXBlRXJyb3IpOgogICAgICAgICAgICBzZWxmLl9faW1wb3J0X18oJycsIGdsb2JhbHMsIHt9LCBbJ3JlbGltcG9ydCddLCAxKQoKCmNsYXNzIEZha2VTcGVjOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHBhcmVudCk6CiAgICAgICAgc2VsZi5wYXJlbnQgPSBwYXJlbnQKCgpjbGFzcyBVc2luZ19fcGFja2FnZV9fUEVQNDUxKFVzaW5nX19wYWNrYWdlX18pOgogICAgbW9ja19tb2R1bGVzID0gdXRpbC5tb2NrX3NwZWMKCgooRnJvemVuX1VzaW5nUGFja2FnZVBFUDQ1MSwKIFNvdXJjZV9Vc2luZ1BhY2thZ2VQRVA0NTEKICkgPSB1dGlsLnRlc3RfYm90aChVc2luZ19fcGFja2FnZV9fUEVQNDUxLCBfX2ltcG9ydF9fPXV0aWwuX19pbXBvcnRfXykKCgpjbGFzcyBTZXR0aW5nX19wYWNrYWdlX186CgogICAgIiIiQmVjYXVzZSBfX3BhY2thZ2VfXyBpcyBhIG5ldyBmZWF0dXJlLCBpdCBpcyBub3QgYWx3YXlzIHNldCBieSBhIGxvYWRlci4KICAgIEltcG9ydCB3aWxsIHNldCBpdCBhcyBuZWVkZWQgdG8gaGVscCB3aXRoIHRoZSB0cmFuc2l0aW9uIHRvIHJlbHlpbmcgb24KICAgIF9fcGFja2FnZV9fLgoKICAgIEZvciBhIHRvcC1sZXZlbCBtb2R1bGUsIF9fcGFja2FnZV9fIGlzIHNldCB0byBOb25lIFt0b3AtbGV2ZWxdLiBGb3IgYQogICAgcGFja2FnZSBfX25hbWVfXyBpcyB1c2VkIGZvciBfX3BhY2thZ2VfXyBbcGFja2FnZV0uIEZvciBzdWJtb2R1bGVzIHRoZQogICAgdmFsdWUgaXMgX19uYW1lX18ucnNwbGl0KCcuJywgMSlbMF0gW3N1Ym1vZHVsZV0uCgogICAgIiIiCgogICAgX19pbXBvcnRfXyA9IHV0aWwuX19pbXBvcnRfX1snU291cmNlJ10KCiAgICAjIFt0b3AtbGV2ZWxdCiAgICAgIGRlZ3JlZSA9IEludGVnZXJGaWVsZCh3aWRnZXQ9U2VsZWN0KGNob2ljZXM9KCgxLCBnZXR0ZXh0X2xhenkoInRlc3QiKSksKSkpCgogICAgICAgIENvcHlGb3JtKCkKCgpAamluamEyX3Rlc3RzCmNsYXNzIEppbmphMkZvcm1zSTE4blRlc3RzKEZvcm1zSTE4blRlc3RzKToKICAgIHBhc3MKIiIiIFRlc3QgSXRlcmF0b3IgTGVuZ3RoIFRyYW5zcGFyZW5jeQoKU29tZSBmdW5jdGlvbnMgb3IgbWV0aG9kcyB3aGljaCBhY2NlcHQgZ2VuZXJhbCBpdGVyYWJsZSBhcmd1bWVudHMgaGF2ZQpvcHRpb25hbCwgbW9yZSBlZmZpY2llbnQgY29kZSBwYXRocyBpZiB0aGV5IGtub3cgaG93IG1hbnkgaXRlbXMgdG8gZXhwZWN0LgpGb3IgaW5zdGFuY2UsIG1hcChmdW5jLCBpdGVyYWJsZSksIHdpbGwgcHJlLWFsbG9jYXRlIHRoZSBleGFjdCBhbW91bnQgb2YKc3BhY2UgcmVxdWlyZWQgd2hlbmV2ZXIgdGhlIGl0ZXJhYmxlIGNhbiByZXBvcnQgaXRzIGxlbmd0aC4KClRoZSBkZXNpcmVkIGludmFyaWFudCBpczogIGxlbihpdCk9PWxlbihsaXN0KGl0KSkuCgpBIGNvbXBsaWNhdGlvbiBpcyB0aGF0IGFuIGl0ZXJhYmxlIGFuZCBpdGVyYXRvciBjYW4gYmUgdGhlIHNhbWUgb2JqZWN0LiBUbwptYWludGFpbiB0aGUgaW52YXJpYW50LCBhbiBpdGVyYXRvciBuZWVkcyB0byBkeW5hbWljYWxseSB1cGRhdGUgaXRzIGxlbmd0aC4KRm9yIGluc3RhbmNlLCBhbiBpdGVyYWJsZSBzdWNoIGFzIHJhbmdlKDEwKSBhbHdheXMgcmVwb3J0cyBpdHMgbGVuZ3RoIGFzIHRlbiwKYnV0IGl0PWl0ZXIocmFuZ2UoMTApKSBzdGFydHMgYXQgdGVuLCBhbmQgdGhlbiBnb2VzIHRvIG5pbmUgYWZ0ZXIgbmV4dChpdCkuCkhhdmluZyB0aGlzIGNhcGFiaWxpdHkgbWVhbnMgdGhhdCBtYXAoKSBjYW4gaWdub3JlIHRoZSBkaXN0aW5jdGlvbiBiZXR3ZWVuCm1hcChmdW5jLCBpdGVyYWJsZSkgYW5kIG1hcChmdW5jLCBpdGVyKGl0ZXJhYmxlKSkuCgpXaGVuIHRoZSBpdGVyYWJsZSBpcyBpbW11dGFibGUsIHRoZSBpbXBsZW1lbnRhdGlvbiBjYW4gc3RyYWlnaHQtZm9yd2FyZGx5CnJlcG9ydCB0aGUgb3JpZ2luYWwgbGVuZ3RoIG1pbnVzIHRoZSBjdW11bGF0aXZlIG51bWJlciBvZiBjYWxscyB0byBuZXh0KCkuClRoaXMgaXMgdGhlIGNhc2UgZm9yIHR1cGxlcywgcmFuZ2Ugb2JqZWN0cywgYW5kIGl0ZXJ0b29scy5yZXBlYXQoKS4KClNvbWUgY29udGFpbmVycyBiZWNvbWUgdGVtcG9yYXJpbHkgaW1tdXRhYmxlIGR1cmluZyBpdGVyYXRpb24uICBUaGlzIGluY2x1ZGVzCmRpY3RzLCBzZXRzLCBhbmQgY29sbGVjdGlvbnMuZGVxdWUuICBUaGVpciBpbXBsZW1lbnRhdGlvbiBpcyBlcXVhbGx5IHNpbXBsZQp0aG91Z2ggdGhleSBuZWVkIHRvIHBlcm1hbmVudGx5IHNldCB0aGVpciBsZW5ndGggdG8gemVybyB3aGVuZXZlciB0aGVyZSBpcwphbiBhdHRlbXB0IHRvIGl0ZXJhdGUgYWZ0ZXIgYSBsZW5ndGggbXV0YXRpb24uCgpUaGUgc2l0dWF0aW9uIHNsaWdodGx5IG1vciAgIyBUdXJuIG9mZiBkZWZhdWx0IGltcGxpY2l0IGZsYWdzIChlLmcuIHJlLlUpIGJlY2F1c2UgcmVnZXhlcyB3aXRoIHRoZQogICAgICAgICMgc2FtZSBpbXBsaWNpdCBhbmQgZXhwbGljaXQgZmxhZ3MgYXJlbid0IGVxdWFsLgogICAgICAgIGZsYWdzID0gc2VsZi52YWx1ZS5mbGFncyBeIHJlLmNvbXBpbGUoIiIpLmZsYWdzCiAgICAgICAgcmVnZXhfZmxhZ3MsIGZsYWdfaW1wb3J0cyA9IHNlcmlhbGl6ZXJfZmFjdG9yeShmbGFncykuc2VyaWFsaXplKCkKICAgICAgICBpbXBvcnRzID0geyJpbXBvcnQgcmUiLCAqcGF0dGVybl9pbXBvcnRzLCAqZmxhZ19pbXBvcnRzfQogICAgICAgIGFyZ3MgPSBbcmVnZXhfcGF0dGVybl0KICAgICAgICBpZiBmbGFnczoKICAgICAgICAgICAgYXJncy5hcHBlbmQocmVnZXhfZmxhZ3MpCiAgICAgICAgcmV0dXJuICJyZS5jb21waWxlKCVzKSIgJSAiLCAiLmpvaW4oYXJncyksIGltcG9ydHMKCgpjbGFzcyBTZXF1ZW5jZVNlcmlhbGl6ZXIoQmFzZVNlcXVlbmNlU2VyaWFsaXplcik6CiAgICBkZWYgX2Zvcm1hdChzZWxmKToKICAgICAgICByZXR1cm4gIlslc10iCgoKY2xhc3MgU2V0U2VyaWFsaXplcihCYXNlVW5vcmRlcmVkU2VxdWVuY2VTZXJpYWxpemVyKToKICAgIGRlZiBfZm9ybWF0KHNlbGYpOgogICAgICAgICMgU2VyaWFsaXplIGFzIGEgc2V0IGxpdGVyYWwgZXhjZXB0IHdoZW4gdmFsdWUgaXMgZW1wdHkgYmVjYXVzZSB7fQogICAgICAgICMgaXMgYW4gZW1wdHkgZGljdC4KICAgICAgICByZXR1cm4gInslc30iIGlmIHNlbGYudmFsdWUgZWxzZSAic2V0KCVzKSIKCgpjbGFzcyBTZXR0aW5nc1JlZmVyZW5jZVNlcmlhbGl6ZXIoQmFzZVNlcmlhbGl6ZXIpOgogICAgZGVmIHNlcmlhbGl6ZShzZWxmKToKICAgICAgICByZXR1cm4gInNldHRpbmdzLiVzIiAlIHNlbGYudmFsdWUuc2V0dGluZ19uYW1lLCB7CiAgICAgICAgICAgICJmcm9tIGRqYW5nby5jb25mIGltcG9ydCBzZXR0aW5ncyIKICAgICAgICB9CgoKY2xhc3MgVHVwbGVTZXJpYWxpemVyKEJhc2VTZXF1ZW5jZVNlcmlhbGl6ZXIpOgogICAgZGVmIF9mb3JtYXQoc2VsZik6CiAgICAgICAgIyBXaGVuIGxlbih2YWx1ZSk9PTAsIHRoZSBlbXB0eSB0dXBsZSBzaG91bGQgYmUgc2VyaWFsaXplZCBhcyAiKCkiLAogICAgICAgICMgbm90ICIoLCkiIGJlY2F1c2UgKCwpIGlzIGludmFsaWQgUHl0aG9uIHN5bnRheC4KICAgICAgICByZXR1cm4gIiglcykiIGlmIGxlbihzZWxmLnZhbHVlKSAhPSAxIGVsc2UgIiglcywpIgoKCmNsYXNzIFR5cGVTZXJpYWxpemVyKEJhc2VTZXJpYWxpemVyKToKICAgIGRlZiBzZXJpYWxpemUoc2VsZik6CiAgICAgICAgc3BlY2lhbF9jYXNlcyA9IFsKICAgICAgICAgICAgKG1vZGVscy5Nb2RlbCwgIm1vZGVscy5Nb2RlbCIsIFsiZnJvbSBkamFuZ28uZGIgaW1wb3J0IG1vZGVscyJdKSwKICAgICAgICAgICAgKHR5cGVzLk5vbmVUeXBlLCAidHlwZXMuTm9uZVR5cGUiLCBbImltcG9ydCB0eXBlcyJdKSxyc2VyLmZlZWQocykKICAgICAgICBwYXJzZXIuY2xvc2UoKQogICAgICAgIGV2ZW50cyA9IHBhcnNlci5nZXRfZXZlbnRzKCkKICAgICAgICBpZiBldmVudHMgIT0gZXhwZWN0ZWRfZXZlbnRzOgogICAgICAgICAgICBzZWxmLmZhaWwoInJlY2VpdmVkIGV2ZW50cyBkaWQgbm90IG1hdGNoIGV4cGVjdGVkIGV2ZW50cyIgKwogICAgICAgICAgICAgICAgICAgICAgIlxuU291cmNlOlxuIiArIHJlcHIoc291cmNlKSArCiAgICAgICAgICAgICAgICAgICAgICAiXG5FeHBlY3RlZDpcbiIgKyBwcHJpbnQucGZvcm1hdChleHBlY3RlZF9ldmVudHMpICsKICAgICAgICAgICAgICAgICAgICAgICJcblJlY2VpdmVkOlxuIiArIHBwcmludC5wZm9ybWF0KGV2ZW50cykpCgogICAgZGVmIF9ydW5fY2hlY2tfZXh0cmEoc2VsZiwgc291cmNlLCBldmVudHMpOgogICAgICAgIHNlbGYuX3J1bl9jaGVjayhzb3VyY2UsIGV2ZW50cywKICAgICAgICAgICAgY29sbGVjdG9yPUV2ZW50Q29sbGVjdG9yRXh0cmEoY29udmVydF9jaGFycmVmcz1GYWxzZSkpCgoKY2xhc3MgSFRNTFBhcnNlclRlc3RDYXNlKFRlc3RDYXNlQmFzZSk6CgogICAgZGVmIHRlc3RfcHJvY2Vzc2luZ19pbnN0cnVjdGlvbl9vbmx5KHNlbGYpOgogICAgICAgIHNlbGYuX3J1bl9jaGVjaygiPD9wcm9jZXNzaW5nIGluc3RydWN0aW9uPiIsIFsKICAgICAgICAgICAgKCJwaSIsICJwcm9jZXNzaW5nIGluc3RydWN0aW9uIiksCiAgICAgICAgICAgIF0pCiAgICAgICAgc2VsZi5fcnVuX2NoZWNrKCI8P3Byb2Nlc3NpbmcgaW5zdHJ1Y3Rpb24gPz4iLCBbCiAgICAgICAgICAgICgicGkiLCAicHJvY2Vzc2luZyBpbnN0cnVjdGlvbiA/IiksCiAgICAgICAgICAgIF0pCgogICAgZGVmIHRlc3Rfc2ltcGxlX2h0bWwoc2VsZik6CiAgICAgICAgc2VsZi5fcnVuX2NoZWNrKCIiIgo8IURPQ1RZUEUgaHRtbCBQVUJMSUMgJ2Zvbyc+CjxIVE1MPiZlbnRpdHk7JiMzMjsKPCEtLWNvbW1lbnQxYQotPjwvZm9vPjxiYXI+Jmx0Ozw/cGk/PjwvZm9vPGJhcgpjb21tZW50MWItLT4KPEltZyBzUmM9J0JhcicgaXNNQVA+c2FtcGxlCnRleHQKJiN4MjAxQzsKPCEtLWNvbW1lbnQyYS0tIC0tY29tbWVudDJiLS0+CjwvSHRtbD4KIiIiLCBbCiAgICAoImRhdGEiLCAiXG4iKSwKICAgICgiZGVjbCIsICJET0NUWVBFIGh0bWwgUFVCTElDICdmb28nIiksCiAgICAoImRhdGEiLCAiXG4iKSwKICAgICgic3RhcnR0YWciLCAiaHRtbCIsIFtdKSwKICAgICgiZW50aXR5cmVmIiwgImVudGl0eSIpLAogICAgKCJjaGFycmVmIiwgIjMyIiksCiAgICAoImRhdGEiLCAiXG4iKSwKICAgICgiY29tbWVudCIsICJjb21tZW50MWFcbi0+PC9mb28+PGJhcj4mbHQ7PD9waT8+PC9mb288YmFyXG5jb21tZW50MWIiKSwKICAgICgiZGF0YSIsICJcbiIpLAogICAgKCJzdGFydHRhZyIsICJpbWciLCBbKCJzcmMiLCAiQmFyIiksICgiaXNtYXAiLCBOb25lKV0pLAogICAgKCJkYXRhIiwgInNhbXBsZVxudGV4dFxuIiksb2YgdGV4dCcsICdVSC1VSCcsIEZBSUwpLAogICAgKCcoP2kpbXVsdGlwbGUgd29yZHMnLCAnTVVMVElQTEUgV09SRFMsIFlFQUgnLCBTVUNDRUVELCAnZm91bmQnLCAnTVVMVElQTEUgV09SRFMnKSwKICAgICgnKD9pKSguKiljKC4qKScsICdBQkNERScsIFNVQ0NFRUQsICdmb3VuZCsiLSIrZzErIi0iK2cyJywgJ0FCQ0RFLUFCLURFJyksCiAgICAoJyg/aSlcXCgoLiopLCAoLiopXFwpJywgJyhBLCBCKScsIFNVQ0NFRUQsICdnMisiLSIrZzEnLCAnQi1BJyksCiAgICAoJyg/aSlba10nLCAnQUInLCBGQUlMKSwKIyAgICAoJyg/aSlhYmNkJywgJ0FCQ0QnLCBTVUNDRUVELCAnZm91bmQrIi0iK1xcZm91bmQrIi0iK1xcXFxmb3VuZCcsICdBQkNELSQmLVxcQUJDRCcpLAojICAgICgnKD9pKWEoYmMpZCcsICdBQkNEJywgU1VDQ0VFRCwgJ2cxKyItIitcXGcxKyItIitcXFxcZzEnLCAnQkMtJDEtXFxCQycpLAogICAgKCcoP2kpYVstXT9jJywgJ0FDJywgU1VDQ0VFRCwgJ2ZvdW5kJywgJ0FDJyksCiAgICAoJyg/aSkoYWJjKVxcMScsICdBQkNBQkMnLCBTVUNDRUVELCAnZzEnLCAnQUJDJyksCiAgICAoJyg/aSkoW2EtY10qKVxcMScsICdBQkNBQkMnLCBTVUNDRUVELCAnZzEnLCAnQUJDJyksCiAgICAoJ2EoPyFiKS4nLCAnYWJhZCcsIFNVQ0NFRUQsICdmb3VuZCcsICdhZCcpLAogICAgKCdhKD89ZCkuJywgJ2FiYWQnLCBTVUNDRUVELCAnZm91bmQnLCAnYWQnKSwKICAgICgnYSg/PWN8ZCkuJywgJ2FiYWQnLCBTVUNDRUVELCAnZm91bmQnLCAnYWQnKSwKICAgICgnYSg/OmJ8Y3xkKSguKScsICdhY2UnLCBTVUNDRUVELCAnZzEnLCAnZScpLAogICAgKCdhKD86YnxjfGQpKiguKScsICdhY2UnLCBTVUNDRUVELCAnZzEnLCAnZScpLAogICAgKCdhKD86YnxjfGQpKz8oLiknLCAnYWNlJywgU1VDQ0VFRCwgJ2cxJywgJ2UnKSwKICAgICgnYSg/OmJ8KGN8ZSl7MSwyfT98ZCkrPyguKScsICdhY2UnLCBTVUNDRUVELCAnZzEgKyBnMicsICdjZScpLAoKICAgICMgbG9va2JlaGluZDogc3BsaXQgYnkgOiBidXQgbm90IGlmIGl0IGlzIGVzY2FwZWQgYnkgLS4KICAgICgnKD88IS0pOiguKj8pKD88IS0pOicsICdhOmJjLTpkZTpmJywgU1VDQ0VFRCwgJ2cxJywgJ2JjLTpkZScgKSwKICAgICMgZXNjYXBpbmcgd2l0aCBcIGFzIHdlIGtub3cgaXQKICAgICgnKD88IVxcXFwpOiguKj8pKD88IVxcXFwpOicsICdhOmJjXFw6ZGU6ZicsIFNVQ0NFRUQsICdnMScsICdiY1xcOmRlJyApLAogICAgIyB0ZXJtaW5hdGluZyB3aXRoICcgYW5kIGVzY2FwaW5nIHdpdGggPyBhcyBpbiBlZGlmYWN0CiAgICAoIig/PCFcXD8pJyguKj8pKD88IVxcPyknIiwgImEnYmM/J2RlJ2YiLCBTVUNDRUVELCAnZzEnLCAiYmM/J2RlIiApLAoKICAgICMgQ29tbWVudHMgdXNpbmcgdGhlICg/Iy4uLikgc3ludGF4CgogICAgKCd3KD8jIGNvbW1lbnQnLCAndycsIFNZTlRBWF9FUlJPUiksCiAgICAoJ3coPyMgY29tbWVudCAxKXh5KD8jIGNvbW1lbnQgMil6JywgJ3d4eXonaXR5ICgwLWJpZyBudW1iZXIpLiBCb3RoIHRoZSBwcmlvcml0aWVzIGFuZCB0aGUgZmFjaWxpdGllcyBtYXAKICAgICMgcm91Z2hseSBvbmUtdG8tb25lIHRvIHN0cmluZ3MgaW4gdGhlIHN5c2xvZ2QoOCkgc291cmNlIGNvZGUuICBUaGlzCiAgICAjIG1hcHBpbmcgaXMgaW5jbHVkZWQgaW4gdGhpcyBmaWxlLgogICAgIwogICAgIyBwcmlvcml0aWVzICh0aGVzZSBhcmUgb3JkZXJlZCkKCiAgICBMT0dfRU1FUkcgICAgID0gMCAgICAgICAjICBzeXN0ZW0gaXMgdW51c2FibGUKICAgIExPR19BTEVSVCAgICAgPSAxICAgICAgICMgIGFjdGlvbiBtdXN0IGJlIHRha2VuIGltbWVkaWF0ZWx5CiAgICBMT0dfQ1JJVCAgICAgID0gMiAgICAgICAjICBjcml0aWNhbCBjb25kaXRpb25zCiAgICBMT0dfRVJSICAgICAgID0gMyAgICAgICAjICBlcnJvciBjb25kaXRpb25zCiAgICBMT0dfV0FSTklORyAgID0gNCAgICAgICAjICB3YXJuaW5nIGNvbmRpdGlvbnMKICAgIExPR19OT1RJQ0UgICAgPSA1ICAgICAgICMgIG5vcm1hbCBidXQgc2lnbmlmaWNhbnQgY29uZGl0aW9uCiAgICBMT0dfSU5GTyAgICAgID0gNiAgICAgICAjICBpbmZvcm1hdGlvbmFsCiAgICBMT0dfREVCVUcgICAgID0gNyAgICAgICAjICBkZWJ1Zy1sZXZlbCBtZXNzYWdlcwoKICAgICMgIGZhY2lsaXR5IGNvZGVzCiAgICBMT0dfS0VSTiAgICAgID0gMCAgICAgICAjICBrZXJuZWwgbWVzc2FnZXMKICAgIExPR19VU0VSICAgICAgPSAxICAgICAgICMgIHJhbmRvbSB1c2VyLWxldmVsIG1lc3NhZ2VzCiAgICBMT0dfTUFJTCAgICAgID0gMiAgICAgICAjICBtYWlsIHN5c3RlbQogICAgTE9HX0RBRU1PTiAgICA9IDMgICAgICAgIyAgc3lzdGVtIGRhZW1vbnMKICAgIExPR19BVVRIICAgICAgPSA0ICAgICAgICMgIHNlY3VyaXR5L2F1dGhvcml6YXRpb24gbWVzc2FnZXMKICAgIExPR19TWVNMT0cgICAgPSA1ICAgICAgICMgIG1lc3NhZ2VzIGdlbmVyYXRlZCBpbnRlcm5hbGx5IGJ5IHN5c2xvZ2QKICAgIExPR19MUFIgICAgICAgPSA2ICAgICAgICMgIGxpbmUgcHJpbnRlciBzdWJzeXN0ZW0KICAgIExPR19ORVdTICAgICAgPSA3ICAgICAgICMgIG5ldHdvcmsgbmV3cyBzdWJzeXN0ZW0KICAgIExPR19VVUNQICAgICAgPSA4ICAgICAgICMgIFVVQ1Agc3Vic3lzdGVtCiAgICBMT0dfQ1JPTiAgICAgID0gOSAgICAgICAjICBjbG9jayBkYWVtb24KICAgIExPR19BVVRIUFJJViAgPSAxMCAgICAgICMgIHNlY3VyaXR5L2F1dGhvcml6YXRpb24gbWVzc2FnZXMgKHByaXZhdGUpCiAgICBMT0dfRlRQICAgICAgID0gMTEgICAgICAjICBGVFAgZGFlbW9uCiAgICBMT0dfTlRQICAgICAgID0gMTIgICAgICAjICBOVFAgc3Vic3lzdGVtCiAgICBMT0dfU0VDVVJJVFkgID0gMTMgICAgICAjICBMb2cgYXVkaXQKICAgIExPR19DT05TT0xFICAgPSAxNCAgICAgICMgIExvZyBhbGVydAogICAgTE9HX1NPTENST04gICA9IDE1ICAgICAgIyAgU2NoZWR1bGluZyBkYWVtb24gKFNvbGFyaXMpJ3gnXSkpCgogICAgICAgICMgbm9uLWludGVnZXIgdmFsdWUKICAgICAgICB4LnZhbHVlID0gbmV3dmFsID0gbmV3dmFsICsgMS41CiAgICAgICAgeC51cGRhdGUoKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoeC52YWx1ZSwgaW50KG5ld3ZhbCkpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjb252KHgubGFiZWxbJ3RleHQnXSksIGludChuZXd2YWwpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZmxvYXQoeC5zY2FsZS5nZXQoKSksIG5ld3ZhbCkKCiAgICAgICAgeC5kZXN0cm95KCkKCgogICAgZGVmIHRlc3RfcmVzaXplKHNlbGYpOgogICAgICAgIHggPSB0dGsuTGFiZWxlZFNjYWxlKHNlbGYucm9vdCkKICAgICAgICB4LnBhY2soZXhwYW5kPVRydWUsIGZpbGw9J2JvdGgnKQogICAgICAgIGdjX2NvbGxlY3QoKSAgIyBGb3IgUHlQeSBvciBvdGhlciBHQ3MuCiAgICAgICAgeC51cGRhdGUoKQoKICAgICAgICB3aWR0aCwgaGVpZ2h0ID0geC5tYXN0ZXIud2luZm9fd2lkdGgoKSwgeC5tYXN0ZXIud2luZm9faGVpZ2h0KCkKICAgICAgICB3aWR0aF9uZXcsIGhlaWdodF9uZXcgPSB3aWR0aCAqIDIsIGhlaWdodCAqIDIKCiAgICAgICAgeC52YWx1ZSA9IDMKICAgICAgICB4LnVwZGF0ZSgpCiAgICAgICAgeC5tYXN0ZXIud21fZ2VvbWV0cnkoIiVkeCVkIiAlICh3aWR0aF9uZXcsIGhlaWdodF9uZXcpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoaW50KHgubGFiZWwucGxhY2VfaW5mbygpWyd4J10pLAogICAgICAgICAgICB4LnNjYWxlLmNvb3JkcygpWzBdKQoKICAgICAgICAjIFJlc2V0IGdlb21ldHJ5CiAgICAgICAgeC5tYXN0ZXIud21fZ2VvbWV0cnkoIiVkeCVkIiAlICh3aWR0aCwgaGVpZ2h0KSkKICAgICAgICB4LmRlc3Ryb3koKQoKCmNsYXNzIE9wdGlvbk1lbnVUZXN0KEFic3RyYWN0VGtUZXN0LCB1bml0dGVzdC5UZXN0Q2FzZSk6CgogICAgZGVmIHNldFVwKHNlbGYpOgogICAgICAgIHN1cGVyKCkuc2V0VXAoKQogICAgICAgIHNlbGYudGV4dHZhciA9IHRraW50ZXIuU3RyaW5nVmFyKHNlbGYucm9vdCkKCiAgICBkZWYgdGVhckRvd24oc2VsZik6CiAgICAgICAgZGVsIHNlbGYudGV4dHZhcgogICAgICAgIHN1cGVyKCkudGVhckRvd24oKQoKCiAgICBkZWYgdGVzdF93aWRnZXRfZGVzdHJveShzZWxmKToKICAgICAgICB2YXIgPSB0a2ludGVyLlN0cmluZ1ZhcihzZWxmLnJvb3QpCiAgICAgICAgb3B0bWVudSA9IHR0ay5PcHRpb25NZW51KHNlbGYucm9vdCwgdmFyKQogICAgICAgIG5hbWUgPSB2YXIuX25hbWUKICAgICAgICBvcHRtZW51LnVwZGF0ZV9pZGxldGFza3MoKQogICAgICAgIG9wdG1lbnUuZGVzdHJveSgpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChvcHRtZW51LnRrLmdsb2JhbGdldHZhcihuYW1lKSwgdmFyLmdldCgpKQogICAgICAgIGRlbCB2YXIKICAgICAgICBnY19jb2xsZWN0KCkgICMgRm9yIFB5UHkgb3Igb3RoZXIgR0NzLgogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKHRraW50ZXIuVGNsIG5vICdyZXF1ZXN0JyBhdHRyaWJ1dGUuIERpZCB5b3Ugb3ZlcnJpZGUgIgogICAgICAgICAgICAic2V0dXAoKSBhbmQgZm9yZ2V0IHRvIGNhbGwgc3VwZXIoKT8iCiAgICAgICAgKQogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXNNZXNzYWdlKEF0dHJpYnV0ZUVycm9yLCBtc2cpOgogICAgICAgICAgICBUZXN0Vmlldy5hc192aWV3KCkoc2VsZi5yZi5nZXQoIi8iKSkKCiAgICBkZWYgdGVzdF9zZXR1cF9hZGRzX2FyZ3Nfa3dhcmdzX3JlcXVlc3Qoc2VsZik6CiAgICAgICAgcmVxdWVzdCA9IHNlbGYucmYuZ2V0KCIvIikKICAgICAgICBhcmdzID0gKCJhcmcgMSIsICJhcmcgMiIpCiAgICAgICAga3dhcmdzID0geyJrd2FyZ18xIjogMSwgImt3YXJnXzIiOiAieWVhciJ9CgogICAgICAgIHZpZXcgPSBWaWV3KCkKICAgICAgICB2aWV3LnNldHVwKHJlcXVlc3QsICphcmdzLCAqKmt3YXJncykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlcXVlc3QsIHZpZXcucmVxdWVzdCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGFyZ3MsIHZpZXcuYXJncykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGt3YXJncywgdmlldy5rd2FyZ3MpCgogICAgZGVmIHRlc3RfZGlyZWN0X2luc3RhbnRpYXRpb24oc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgSXQgc2hvdWxkIGJlIHBvc3NpYmxlIHRvIHVzZSB0aGUgdmlldyBieSBkaXJlY3RseSBpbnN0YW50aWF0aW5nIGl0CiAgICAgICAgd2l0aG91dCBnb2luZyB0aHJvdWdoIC5hc192aWV3KCkgKCMyMTU2NCkuCiAgICAgICAgIiIiCiAgICAgICAgdmlldyA9IFBvc3RPbmx5VmlldygpCiAgICAgICAgcmVzcG9uc2UgPSB2aWV3LmRpc3BhdGNoKHNlbGYucmYuaGVhZCgiLyIpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2Uuc3RhdHVzX2NvZGUsIDQwNSkKCiAgICBkZWYgdGVzdF9tZXRob2Rfbm90X2FsbG93ZWRfcmVzcG9uc2VfbG9nZ2VkKHNlbGYpOgogICAgICAgIGZvciBwYXRoLCBlc2NhcGVkIGluIFsKICAgICAgICAgICAgKCIvZm9vLyIsICIvZm9vLyIpLAogICAgICAgICAgICAociIvJTFCWzE7MzFtTk9XIElOIFJFRCEhITFCWzBtLyIsIHIiL1x4MWJbMTszMW1OT1cgSU4gUkVEISEhMUJbMG0vIiksCiAgICAgICAgXToKICAgICAgICAgICAgd2l0aCBzZWxmLnN1YlRlc3QocGF0aD1wYXRoKToKICAgICAgICAgICAgICAgIHJlcXVlc3QgPSBzZWxmLnJmLmdldChwYXRoLCBSRVFVRVNUX01FVEhPRD0iQk9HVVMiKQogICAgICAgICAgICAgICAgd2l0aCBzZWxmLmFzc2VydExvZ3MoImRqYW5nby5yZXF1ZXN0IiwgIldBUk5JTkciKSBhcyBoYW5kbGVyOgogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gU2ltcGxlVmlldy5hc192aWV3KCkocmVxdWVzdCkKCiAgICAgICAgICAgICAgICBzZWxmLmFzc2VydExvZ1JlY29yZCgKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLAogICAgICAgICAgICAgICAgICAgIGYiTWV0aG9kIE5vdCBBbGxvd2VkIChCT0dVUyk6IFsyMCwgMzBdKQoKICAgICAgICBjLmNvb3JkcyhpLCAnMjAnLCAnMzBjJywgJzYwaScsICcxMHAnKQogICAgICAgIGNvb3JkcyA9IGMuY29vcmRzKGkpCiAgICAgICAgc2VsZi5hc3NlcnRJc0luc3RhbmNlKGNvb3JkcywgbGlzdCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGxlbihjb29yZHMpLCA0KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoY29vcmRzWzBdLCAyMCkKICAgICAgICBmb3IgaSBpbiByYW5nZSg0KToKICAgICAgICAgICAgc2VsZi5hc3NlcnRJc0luc3RhbmNlKGNvb3Jkc1tpXSwgZmxvYXQpCgogICAgQHJlcXVpcmVzX3RrKDgsIDYpCiAgICBkZWYgdGVzdF9tb3ZldG8oc2VsZik6CiAgICAgICAgd2lkZ2V0ID0gc2VsZi5jcmVhdGUoKQogICAgICAgIGkxID0gd2lkZ2V0LmNyZWF0ZV9yZWN0YW5nbGUoMSwgMSwgMjAsIDIwLCB0YWdzPSdncm91cCcpCiAgICAgICAgaTIgPSB3aWRnZXQuY3JlYXRlX3JlY3RhbmdsZSgzMCwgMzAsIDUwLCA3MCwgdGFncz0nZ3JvdXAnKQogICAgICAgIHgxLCB5MSwgXywgXyA9IHdpZGdldC5iYm94KGkxKQogICAgICAgIHgyLCB5MiwgXywgXyA9IHdpZGdldC5iYm94KGkyKQogICAgICAgIHdpZGdldC5tb3ZldG8oJ2dyb3VwJywgMjAwLCAxMDApCiAgICAgICAgeDFfMiwgeTFfMiwgXywgXyA9IHdpZGdldC5iYm94KGkxKQogICAgICAgIHgyXzIsIHkyXzIsIF8sIF8gPSB3aWRnZXQuYmJveChpMikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHgxXzIsIDIwMCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHkxXzIsIDEwMCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHgyIC0geDEsIHgyXzIgLSB4MV8yKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoeTIgLSB5MSwgeTJfMiAtIHkxXzIpCiAgICAgICAgd2lkZ2V0LnRhZ19sb3dlcihpMiwgaTEpCiAgICAgICAgd2lkZ2V0Lm1vdmV0bygnZ3JvdXAnLCB5PTUwKQogICAgICAgIHgxXzMsIHkxXzMsIF8sIF8gPSB3aWRnZXQuYmJveChpMSkKICAgICAgICB4Ml8zLCB5Ml8zLCBfLCBfID0gd2lkZ2V0LmJib3goaTIpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCh5Ml8zLCA1MCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHgyXzMsIHgyXzIpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCh4Ml8yIC0geDFfMiwgeDJfMyAtIHgxXzMpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCh5Ml8yIC0geTFfMiwgeTJfMyAtIHkxXzMpCgoKQGFkZF9jb25maWd1cmVfdGVzdHMoSW50ZWdlclNpemVUZXN0cywgU3RhbmRhcmRPcHRpb25zVGVzdHMpCmNsYXNzIExpc3Rib3hUZXN0KEFic3RyYWN0V2lkZ2V0VGVzdCwgdW5pdHRlc3QuVGVzdENhc2UpOgogICAgT1BUSU9OUyA9ICgKICAgICAgICAnYWN0aXZlc3R5bGUnLCAnYmFja2dyb3VuZCcsICdib3JkZXJ3aWR0aCcsICdjdXJzb3InLAogICAgICAgICdkaXNhYmxlZGZvcmVncm91bmQnLCAnZXhwb3J0c2VsZWN0aW9uJywKICAgICAgICAnZm9udCcsICdmb3JlZ3JvdW5kJywgJ2hlaWdodCcscXVhbCh4ZmxCeXRlLCBiJ1x4MDInKSAjIG1heGltdW0gY29tcHJlc3Npb24KCiAgICAgICAgICAgIG9zQnl0ZSA9IGZSZWFkLnJlYWQoMSkKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChvc0J5dGUsIGInXHhmZicpICMgT1MgInVua25vd24iIChPUy1pbmRlcGVuZGVudCkKCiAgICAgICAgICAgICMgU2luY2UgdGhlIEZOQU1FIGZsYWcgaXMgc2V0LCB0aGUgemVyby10ZXJtaW5hdGVkIGZpbGVuYW1lIGZvbGxvd3MuCiAgICAgICAgICAgICMgUkZDIDE5NTIgc3BlY2lmaWVzIHRoYXQgdGhpcyBpcyB0aGUgbmFtZSBvZiB0aGUgaW5wdXQgZmlsZSwgaWYgYW55LgogICAgICAgICAgICAjIEhvd2V2ZXIsIHRoZSBnemlwIG1vZHVsZSBkZWZhdWx0cyB0byBzdG9yaW5nIHRoZSBuYW1lIG9mIHRoZSBvdXRwdXQKICAgICAgICAgICAgIyBmaWxlIGluIHRoaXMgZmllbGQuCiAgICAgICAgICAgIG5hbWVCeXRlcyA9IGZSZWFkLnJlYWQobGVuKGV4cGVjdGVkbmFtZSkpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwobmFtZUJ5dGVzLCBleHBlY3RlZG5hbWUpCgogICAgICAgICAgICAjIFNpbmNlIG5vIG90aGVyIGZsYWdzIHdlcmUgc2V0LCB0aGUgaGVhZGVyIGVuZHMgaGVyZS4KICAgICAgICAgICAgIyBSYXRoZXIgdGhhbiBwcm9jZXNzIHRoZSBjb21wcmVzc2VkIGRhdGEsIGxldCdzIHNlZWsgdG8gdGhlIHRyYWlsZXIuCiAgICAgICAgICAgIGZSZWFkLnNlZWsob3Muc3RhdChzZWxmLmZpbGVuYW1lKS5zdF9zaXplIC0gOCkKCiAgICAgICAgICAgIGNyYzMyQnl0ZXMgPSBmUmVhZC5yZWFkKDQpICMgQ1JDMzIgb2YgdW5jb21wcmVzc2VkIGRhdGEgW2RhdGExXQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGNyYzMyQnl0ZXMsIGInXHhhZlx4ZDdkXHg4MycpCgogICAgICAgICAgICBpc2l6ZUJ5dGVzID0gZlJlYWQucmVhZCg0KQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGlzaXplQnl0ZXMsIHN0cnVjdC5wYWNrKCc8aScsIGxlbihkYXRhMSkpKQoKICAgIGRlZiB0ZXN0X21ldGFkYXRhX2FzY2lpX25hbWUoc2VsZik6CiAgICAgICAgc2VsZi5maWxlbmFtZSA9IG9zX2hlbHBlci5URVNURk5fQVNDSUkKICAgICAgICBzZWxmLnRlc3RfbWV0YWRhdGEoKQoKICAgIGRlZiB0ZXN0X2NvbXByZXNzbGV2ZWxfbWV0YWRhdGEoc2VsZik6CiAgICAgICAgIyBzZWUgUkZDIDE5NTI6IGh0dHA6Ly93d3cuZmFxcy5vcmcvcmZjcy9yZmMxOTUyLmh0bWwKICAgICAgICAjIHNwZWNpZmljYWxseSwgZGlzY3Vzc2lvbiBvZiBYRkwgaW4gc2VjdGlvbiAyLjMuMQogICAgICAgIGNhc2VzID0gWwogICAgICAgICAgICAoJ2Zhc3QnLCAxLCBiJ1x4MDQnKSwKICAgICAgICAgICAgKCdiZXN0JywgOSwgYidceDAyJyksCiAgICAgICAgICAgICgndHJhZGVvZmYnLCA2LCBiJ1x4MDAnKSwKICAgICAgICBdCiAgICAgICAgeGZsT2Zmc2V0ID0gOAoKICAgICAgICBmb3IgKG5hbWUsIGxldmVsLCBleHBlY3RlZFhmbEJ5dGUpIGluIGMgJ1x1ZmU3ZCcgICAjICAweDAwZjAgLT4gQVJBQklDIFNIQUREQSBNRURJQUwgRk9STQogICAgJ1x1MDY1MScgICAjICAweDAwZjEgLT4gQVJBQklDIFNIQUREQUgKICAgICdcdWZlZTUnICAgIyAgMHgwMGYyIC0+IEFSQUJJQyBMRVRURVIgTk9PTiBJU09MQVRFRCBGT1JNCiAgICAnXHVmZWU5JyAgICMgIDB4MDBmMyAtPiBBUkFCSUMgTEVUVEVSIEhFSCBJU09MQVRFRCBGT1JNCiAgICAnXHVmZWVjJyAgICMgIDB4MDBmNCAtPiBBUkFCSUMgTEVUVEVSIEhFSCBNRURJQUwgRk9STQogICAgJ1x1ZmVmMCcgICAjICAweDAwZjUgLT4gQVJBQklDIExFVFRFUiBBTEVGIE1BS1NVUkEgRklOQUwgRk9STQogICAgJ1x1ZmVmMicgICAjICAweDAwZjYgLT4gQVJBQklDIExFVFRFUiBZRUggRklOQUwgRk9STQogICAgJ1x1ZmVkMCcgICAjICAweDAwZjcgLT4gQVJBQklDIExFVFRFUiBHSEFJTiBNRURJQUwgRk9STQogICAgJ1x1ZmVkNScgICAjICAweDAwZjggLT4gQVJBQklDIExFVFRFUiBRQUYgSVNPTEFURUQgRk9STQogICAgJ1x1ZmVmNScgICAjICAweDAwZjkgLT4gQVJBQklDIExJR0FUVVJFIExBTSBXSVRIIEFMRUYgV0lUSCBNQUREQSBBQk9WRSBJU09MQVRFRCBGT1JNCiAgICAnXHVmZWY2JyAgICMgIDB4MDBmYSAtPiBBUkFCSUMgTElHQVRVUkUgTEFNIFdJVEggQUxFRiBXSVRIIE1BRERBIEFCT1ZFIEZJTkFMIEZPUk0KICAgICdcdWZlZGQnICAgIyAgMHgwMGZiIC0+IEFSQUJJQyBMRVRURVIgTEFNIElTT0xBVEVEIEZPUk0KICAgICdcdWZlZDknICAgIyAgMHgwMGZjIC0+IEFSQUJJQyBMRVRURVIgS0FGIElTT0xBVEVEIEZPUk0KICAgICdcdWZlZjEnICAgIyAgMHgwMGZkIC0+IEFSQUJJQyBMRVRURVIgWUVIIElTT0xBVEVEIEZPUk0KICAgICdcdTI1YTAnICAgIyAgMHgwMGZlIC0+IEJMQUNLIFNRVUFSRQogICAgJ1x1ZmZmZScgICAjICAweDAwZmYgLT4gVU5ERUZJTkVECikKCiMjIyBFbmNvZGluZyBNYXAKCmVuY29kaW5nX21hcCA9IHsKICAgIDB4MDAwMDogMHgwMDAwLCAgICAgIyAgTlVMTAogICAgMHgwMDAxOiAweDAwMDEsICAgICAjICBTVEFSVCBPRiBIRUFESU5HCiAgICAweDAwMDI6IDB4MDAwMiwgICAgICMgIFNUQVJUIE9GIFRFWFQKICAgIDB4MDAwMzogMHgwMDAzLCAgICAgIyAgRU5EIE9GIFRFWFQKICAgIDB4MDAwNDogMHgwMDA0LCAgICAgIyAgRU5EIE9GIFRSQU5TTUlTU0lPTgogICAgMHgwMDA1OiAweDAwMDUsICAgICAjICBFTlFVSVJZCiAgICAweDAwMDY6IDB4MDAwNiwgICAgICMgIEFDS05PV0xFREdFCiAgICAweDAwMDc6IDB4MDAwNywgICAgICMgIEJFTEwKICAgIDB4MDAwODogMHgwMDA4LCAgICAgIyAgQkFDS1NQQUNFCiAgICAweDAwMDk6IDB4MDAwOSwgICAgICMgIEhPUklaT05UQUwgVEFCVUxBVElPTgogICAgMHgwMDBhOiAweDAwMGEsICAgICAjICBMSU5FIEZFRUQKICAgIDB4MDAwYjogMHgwMDBiLCAgICAgIyAgVkVSVElDQUwgVEFCVUxBVElPTgogICAgMHgwMDBjOiAweDAwMGMsICBhbWVzIG11c3QgYmUgaW4gcmFuZ2UnIGluIHN0ZGVycjoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgYictWCB0cmFjZW1hbGxvYz1ORlJBTUU6IGludmFsaWQgbnVtYmVyIG9mIGZyYW1lcycgaW4gc3RkZXJyOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBzZWxmLmZhaWwoZiJ1bmV4cGVjdGVkIG91dHB1dDoge3N0ZGVyciFhfSIpCgogICAgQGZvcmNlX25vdF9jb2xvcml6ZWQKICAgIGRlZiB0ZXN0X3N5c194b3B0aW9uc19pbnZhbGlkKHNlbGYpOgogICAgICAgIGZvciBuZnJhbWUgaW4gSU5WQUxJRF9ORlJBTUU6CiAgICAgICAgICAgIHdpdGggc2VsZi5zdWJUZXN0KG5mcmFtZT1uZnJhbWUpOgogICAgICAgICAgICAgICAgc2VsZi5jaGVja19zeXNfeG9wdGlvbnNfaW52YWxpZChuZnJhbWUpCgogICAgQHVuaXR0ZXN0LnNraXBJZihfdGVzdGNhcGkgaXMgTm9uZSwgJ25lZWQgX3Rlc3RjYXBpJykKICAgIGRlZiB0ZXN0X3B5bWVtX2FsbG9jMChzZWxmKToKICAgICAgICAjIElzc3VlICMyMTYzOTogQ2hlY2sgdGhhdCBQeU1lbV9NYWxsb2MoMCkgd2l0aCB0cmFjZW1hbGxvYyBlbmFibGVkCiAgICAgICAgIyBkb2VzIG5vdCBjcmFzaC4KICAgICAgICBjb2RlID0gJ2ltcG9ydCBfdGVzdGNhcGk7IF90ZXN0Y2FwaS50ZXN0X3B5bWVtX2FsbG9jMCgpOyAxJwogICAgICAgIGFzc2VydF9weXRob25fb2soJy1YJywgJ3RyYWNlbWFsbG9jJywgJy1jJywgY29kZSkKCgpAdW5pdHRlc3Quc2tpcElmKF90ZXN0Y2FwaSBpcyBOb25lLCAnbmVlZCBfdGVzdGNhcGknKQpjbGFzcyBUZXN0Q0FQSSh1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICBtYXhEaWZmID0gODAgKiAyMAoKICAgIGRlZiBzZXRVcChzZWxmKToKICAgICAgICBpZiB0cmFjZW1hbGxvYy5pc190cmFjaW5nKCk6CiAgICAgICAgICAgIHNlbGYuc2tpcFRlc3QoInRyYWNlbWFsbG9jIG11c3QgYmUgc3RvcHBlZCBiZWZvcmUgdGhlIHRlc3QiKQoKICAgICAgICBzZWxmLmRvbWFpbiA9IDUKICAgICAgICBzZWxmLnNpemUgPSAxMjMKICAgICAgICBzZWxmLm9iaiA9IGFsbG9jYXRlX2J5dGVzKHNlbGYuc2l6ZSlbMF0KCiAgICAgICAgIyBmb3IgdGhlIHR5cGUgIm9iamVjdCIsIGlkKG9iaikgaXMgdGhlIGFkZHJlc3Mgb2YgaXRzIG1lbW9yeSBibG9jay4KICAgICAgICAjIFRoaXMgdHlwZSBpcyBub3QgdHJhY2tlZCBieSB0aGUgZ2FyYmFnZSBjb2xsZWN0b3IKICAgICAgICBzZWxmLnB0ciA9IGlkKHNlbGYub2JqKQoKICAgIGRlZiB0ZWFyRG93bihzZWxmKToKICAgICAgICB0cmFjZW1hbGxvYy5zdG9wKCkKCiAgICBkZWYgZ2V0X3RyYWNlYmFjayhzZWxmKToKICAgICAgICBmcmFtZXMgPSBfdGVzdGludGVybmFsY2FwaS5fUHlUcmFjZU1hbGxvY19HZXRUcmFjZWJhY2soc2VsZi5kb21haW4sIHNlbGYucHRyKQogICAgICAgIGlmIGZyYW1lcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHRyYWNlbWFsbG9jLlRyYWNlYmFjayhmcmFtZXMpCiB1dCwgIkV4YW1wbGUgcHJvcGVydHkgfCBFeGFtcGxlIG1ldGhvZCIpCgogICAgQHNldHVwKHsidGVtcGxhdGUiOiAie3sgbWVhbHMubHVuY2ggfX0ifSkKICAgIGRlZiB0ZXN0X2FjY2Vzc19jbGFzc19wcm9wZXJ0eV9pZl9nZXRpdGVtX2lzX2RlZmluZWRfaW5fbWV0YWNsYXNzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIElmIHRoZSBtZXRhY2xhc3MgZGVmaW5lcyBfX2dldGl0ZW1fXywgdGhlIHRlbXBsYXRlIHN5c3RlbSBzaG91bGQgdXNlCiAgICAgICAgaXQgdG8gcmVzb2x2ZSB0aGUgZG90IG5vdGF0aW9uLgogICAgICAgICIiIgoKICAgICAgICBjbGFzcyBNZWFsTWV0YSh0eXBlKToKICAgICAgICAgICAgZGVmIF9fZ2V0aXRlbV9fKGNscywgbmFtZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0YXR0cihjbHMsIG5hbWUpICsgIiBpcyB5dW1teS4iCgogICAgICAgIGNsYXNzIE1lYWxzKG1ldGFjbGFzcz1NZWFsTWV0YSk6CiAgICAgICAgICAgIGx1bmNoID0gInNvdXAiCiAgICAgICAgICAgIGRvX25vdF9jYWxsX2luX3RlbXBsYXRlcyA9IFRydWUKCiAgICAgICAgICAgICMgTWFrZSBjbGFzcyB0eXBlIHN1YnNjcmlwdGFibGUuCiAgICAgICAgICAgIGRlZiBfX2NsYXNzX2dldGl0ZW1fXyhjbHMsIGtleSk6CiAgICAgICAgICAgICAgICBmcm9tIHR5cGVzIGltcG9ydCBHZW5lcmljQWxpYXMKCiAgICAgICAgICAgICAgICByZXR1cm4gR2VuZXJpY0FsaWFzKGNscywga2V5KQoKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKE1lYWxzLmx1bmNoLCAic291cCIpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChNZWFsc1sibHVuY2giXSwgInNvdXAgaXMgeXVtbXkuIikKCiAgICAgICAgb3V0cHV0ID0gc2VsZi5lbmdpbmUucmVuZGVyX3RvX3N0cmluZygidGVtcGxhdGUiLCB7Im1lYWxzIjogTWVhbHN9KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwob3V0cHV0LCAic291cCBpcyB5dW1teS4iKQoKCmNsYXNzIEJsb2NrQ29udGV4dFRlc3RzKFNpbXBsZVRlc3RDYXNlKToKICAgIGRlZiB0ZXN0X3JlcHIoc2VsZik6CiAgICAgICAgYmxvY2tfY29udGV4dCA9IEJsb2NrQ29udGV4dCgpCiAgICAgICAgYmxvY2tfY29udGV4dC5hZGRfYmxvY2tzKHsiY29udGVudCI6IEJsb2NrTm9kZSgiY29udGVudCIsIFtdKX0pCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgKICAgICAgICAgICAgcmVwcihibG9ja19jb250ZXh0KSwKICAgICAgICAgICAgIjxCbG9ja0NvbnRleHQ6IGJsb2Nrcz1kZWZhdWx0ZGljdCg8Y2xhc3MgJ2xpc3QnPiwgIgogICAgICAgICAgICAieydjb250ZW50JzogWzxCbG9jayBOb2RlOiBjb250ZW50LiBDb250ZW50czogW10+XX0pPiIsCiAgICAgICAgKQoKCmNsYXNzIFRlbXBsYXRlTmFtZUluRXhjZXB0aW9uVGVzdHMoU2ltcGxlVGVzdENhc2UpOgogICAgdGVtcGxhdGVfZXJyb3JfbXNnID0gKAogICAgICAgICJJbnZhbGlkIGJsb2NrIHRhZyBvbiBsaW5lIDE6ICdlbmRmb3InLiBEaWQgeW91IGZvcmdldCB0b3JvbSBkb2N1dGlscy5ub2RlcyBpbXBvcnQgTm9kZQogICAgZnJvbSBzcGhpbnguYXBwbGljYXRpb24gaW1wb3J0IFNwaGlueAogICAgZnJvbSBzcGhpbngudXRpbC50eXBpbmcgaW1wb3J0IEV4dGVuc2lvbk1ldGFkYXRhCgoKY2xhc3Mgc25pcHBldF9zdHJpbmdfbm9kZShub2Rlcy5pbmxpbmUpOiAgIyBub3FhOiBOODAxIChzbmFrZV9jYXNlIGlzIGZpbmUpCiAgICAiIiJOb2RlIGZvciBhIHN0cmluZyBsaXRlcmFsIGluIGEgZ3JhbW1hciBzbmlwcGV0LiIiIgoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIHJhd3NvdXJjZTogc3RyID0gJycsCiAgICAgICAgdGV4dDogc3RyID0gJycsCiAgICAgICAgKmNoaWxkcmVuOiBOb2RlLAogICAgICAgICoqYXR0cmlidXRlczogQW55LAogICAgKSAtPiBOb25lOgogICAgICAgIHN1cGVyKCkuX19pbml0X18ocmF3c291cmNlLCB0ZXh0LCAqY2hpbGRyZW4sICoqYXR0cmlidXRlcykKICAgICAgICAjIFVzZSB0aGUgUHlnbWVudHMgaGlnaGxpZ2h0IGNsYXNzIGZvciBgTGl0ZXJhbC5TdHJpbmcuT3RoZXJgCiAgICAgICAgc2VsZlsnY2xhc3NlcyddLmFwcGVuZCgnc3gnKQoKCmNsYXNzIEdyYW1tYXJTbmlwcGV0QmFzZShTcGhpbnhEaXJlY3RpdmUpOgogICAgIiIiQ29tbW9uIGZ1bmN0aW9uYWxpdHkgZm9yIEdyYW1tYXJTbmlwcGV0RGlyZWN0aXZlICYgQ29tcGF0UHJvZHVjdGlvbkxpc3QuIiIiCgogICAgIyBUaGUgb3B0aW9uL2FyZ3VtZW50IGhhbmRsaW5nIGlzIGxlZnQgdG8gdGhlIGluZGl2aWR1YWwgY2xhc3Nlcy4KCiAgICBncmFtbWFyX3JlOiBGaW5hbCA9IHJlLmNvbXBpbGUoCiAgICAgICAgciIiIgogICAgICAgICAgICAoP1A8cnVsZV9uYW1lPl5bYS16QS1aMC05X10rKSAgICAgIyBpZGVudGlmaWVyIGF0IHN0YXJ0IG9mIGxpbmUKICAgICAgICAgICAgKD89OikgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgLi4uIGZvbGxvd2VkIGJ5IGEgY29sb24KICAgICAgICB8CiAgICAgICAgICAgICg/UDxydWxlX3JlZj5gW15cc2BdK2ApICAgICAgICAgICAjIGlkZW50aWZpZXIgaW4gYmFja3F1b3RlcwogICAgICAgIHwKICAgICAgICAgICAgKD9QPHNpbmdsZV9xdW90ZWQ+J1teJ10qJykgICAgICAgICMgc3RyaW5nIGluICdxdW90ZXMnCiAgICAgICAgfAogICAgICAgICAgICAoP1A8ZG91YmxlX3F1b3RlZD4iW14iXSoiKSAgICAgICAgIyBzdHJpbmcgaW4gInF1b3RlcyIKICAgICAgICAiIiIsCiAgICAgICAgcmUuVkVSQk9TRSwKICAgICkKCiAgICBkZWYgbWFrZV9ncmFtbWFyX3NuaXBwZXQoCiAgICAgICAgc2VsZiwgb3B0aW9uczogZGljdFtzdHIsIEFueV0sIGNvbnRlbnQ6IFNlcXVlbmNlW3N0cl0KICAgICkgLT4gbGlzdFthZGRub2Rlcy5wcm9kdWN0aW9ubGlzdF06CiAgICAgICAgIiIiQ3JlYXRlIGEgbGl0ZXJhbCBibG9jayBmcm9tIG9wdGlvbnMgJiBjb250ZW50LiIiIgoKICAgICAgICBncm91cF9uYW1lID0gb3B0aW9uc1snZ3JvdXAnXXBhdGNoW0xJU1RbMF1dID0gbG9hZF9saXN0CgogICAgZGVmIGxvYWRfZGljdChzZWxmKToKICAgICAgICBpdGVtcyA9IHNlbGYucG9wX21hcmsoKQogICAgICAgIGQgPSB7aXRlbXNbaV06IGl0ZW1zW2krMV0KICAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKDAsIGxlbihpdGVtcyksIDIpfQogICAgICAgIHNlbGYuYXBwZW5kKGQpCiAgICBkaXNwYXRjaFtESUNUWzBdXSA9IGxvYWRfZGljdAoKICAgICMgSU5TVCBhbmQgT0JKIGRpZmZlciBvbmx5IGluIGhvdyB0aGV5IGdldCBhIGNsYXNzIG9iamVjdC4gIEl0J3Mgbm90CiAgICAjIG9ubHkgc2Vuc2libGUgdG8gZG8gdGhlIHJlc3QgaW4gYSBjb21tb24gcm91dGluZSwgdGhlIHR3byByb3V0aW5lcwogICAgIyBwcmV2aW91c2x5IGRpdmVyZ2VkIGFuZCBncmV3IGRpZmZlcmVudCBidWdzLgogICAgIyBrbGFzcyBpcyB0aGUgY2xhc3MgdG8gaW5zdGFudGlhdGUsIGFuZCBrIHBvaW50cyB0byB0aGUgdG9wbW9zdCBtYXJrCiAgICAjIG9iamVjdCwgZm9sbG93aW5nIHdoaWNoIGFyZSB0aGUgYXJndW1lbnRzIGZvciBrbGFzcy5fX2luaXRfXy4KICAgIGRlZiBfaW5zdGFudGlhdGUoc2VsZiwga2xhc3MsIGFyZ3MpOgogICAgICAgIGlmIChhcmdzIG9yIG5vdCBpc2luc3RhbmNlKGtsYXNzLCB0eXBlKSBvcgogICAgICAgICAgICBoYXNhdHRyKGtsYXNzLCAiX19nZXRpbml0YXJnc19fIikpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGtsYXNzKCphcmdzKQogICAgICAgICAgICBleGNlcHQgVHlwZUVycm9yIGFzIGVycjoKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiaW4gY29uc3RydWN0b3IgZm9yICVzOiAlcyIgJQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChrbGFzcy5fX25hbWVfXywgc3RyKGVycikpLCBlcnIuX190cmFjZWJhY2tfXykKICAgICAgICBlbHNlOgogICAgICAgICAgICB2YWx1ZSA9IGtsYXNzLl9fbmV3X18oa2xhc3MpCiAgICAgICAgc2VsZi5hcHBlbmQodmFsdWUpCgogICAgZGVmIGxvYWRfaW5zdChzZWxmKToKICAgICAgICBtb2R1bGUgPSBzZWxmLnJlYWRsaW5lKClbOi0xXS5kZWNvZGUoImFzY2lpIikKICAgICAgICBuYW1lID0gc2VsZi5yZWFkbGluZSgpWzotMV0uZGVjb2RlKCJhc2NpaSIpCiAgICAgICAga2xhc3MgPSBzZWxmLmZpbmRfY2xhc3MobW9kdWxlLCBuYW1lKQogICAgICAgIHNlbGYuX2luc3RhbnRpYXRlKGtsYXNzLCBzZWxmLnBvcF9tYXJrKCkpCiAgICBkaXNwYXRjaFtJTlNUWzBdXSA9IGxvYWRfaW5zdAoKICAgIGRlZiBsb2FkX29iaihzZWxmKToKICAgICAgICAjIFN0YWNrIGlzIC4uLiBtYXJrb2JqZWN0IGNsYXNzb2JqZWN0IGFyZzEgYXJnMiAuLi4KICAgICAgICBhcmdzID0gc2VsZi5wb3BfbWFyaygpCiAgICAgICAgY2xzID0gYXJncy5wb3AoMCkKICAgICAgICBzZWxmLl9pbnN0YW50aWF0ZShjbHMsIGFyZ3MpCiAgICBkaXNwYXRjaFtPQkpbMF1dID0gbG9hZF9vYmoKCiAgIChHcm91cCgnYmF6JywgW2FdKSwgZykKICAgICAgICBzZWxmLmFzc2VydE5vdEVxdWFsKEdyb3VwKCdmb28gYmFyJywgW10pLCBnKQogICAgICAgIHNlbGYuYXNzZXJ0RmFsc2UoZyA9PSBvYmplY3QoKSkKICAgICAgICBzZWxmLmFzc2VydFRydWUoZyA9PSBBTFdBWVNfRVEpCgoKY2xhc3MgVGVzdEZvbGRpbmcoVGVzdEhlYWRlckJhc2UpOgoKICAgIGRlZiB0ZXN0X2FkZHJlc3NfZGlzcGxheV9uYW1lcyhzZWxmKToKICAgICAgICAiIiJUZXN0IHRoZSBmb2xkaW5nIGFuZCBlbmNvZGluZyBvZiBhZGRyZXNzIGhlYWRlcnMuIiIiCiAgICAgICAgZm9yIG5hbWUsIHJlc3VsdCBpbiAoCiAgICAgICAgICAgICAgICAoJ0ZvbyBCYXIsIEZyYW5jZScsICciRm9vIEJhciwgRnJhbmNlIicpLAogICAgICAgICAgICAgICAgKCdGb28gQmFyIChGcmFuY2UpJywgJyJGb28gQmFyIChGcmFuY2UpIicpLAogICAgICAgICAgICAgICAgKCdGb28gQmFyLCBFc3Bhw7FhJywgJ0ZvbyA9P3V0Zi04P3E/QmFyPTJDX0VzcGE9QzM9QjFhPz0nKSwKICAgICAgICAgICAgICAgICgnRm9vIEJhciAoRXNwYcOxYSknLCAnRm9vIEJhciA9P3V0Zi04P2I/S0VWemNHSERzV0VwPz0nKSwKICAgICAgICAgICAgICAgICgnRm9vLCBCYXIgRXNwYcOxYScsICc9P3V0Zi04P3E/Rm9vPTJDX0Jhcl9Fc3BhPUMzPUIxYT89JyksCiAgICAgICAgICAgICAgICAoJ0ZvbywgQmFyIFtFc3Bhw7FhXScsICc9P3V0Zi04P3E/Rm9vPTJDX0Jhcl89NUJFc3BhPUMzPUIxYT01RD89JyksCiAgICAgICAgICAgICAgICAoJ0ZvbyBCw6RyLCBGcmFuY2UnLCAnRm9vID0/dXRmLTg/cT9CPUMzPUE0cj0yQz89IEZyYW5jZScpLAogICAgICAgICAgICAgICAgKCdGb28gQsOkciA8RnJhbmNlPicsICdGb28gPT91dGYtOD9xP0I9QzM9QTRyXz0zQ0ZyYW5jZT0zRT89JyksCiAgICAgICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAgICAgJ0zDtHJlbSBpcHN1bSBkw7Rsw7RyIHNpdCBhbWV0LCBjw7Ruc2VjdGV0dWVyIGFkaXBpc2NpbmcuICcKICAgICAgICAgICAgICAgICAgICAnU3VzcGVuZGlzc2UgcMO0dGVudGkuIEFsaXF1YW0gbmliaC4gU3VzcGVuZGlzc2UgcMO0dGVudGkuJywKICAgICAgICAgICAgICAgICAgICAnPT91dGYtOD9xP0w9QzM9QjRyZW1faXBzdW1fZD1DMz1CNGw9QzM9QjRyX3NpdF9hbWV0PTJDX2MnCiAgICAgICAgICAgICAgICAgICAgJz1DMz1CNG5zZWN0ZXR1ZXI/PVxuID0/dXRmLTg/cT9fYWRpcGlzY2luZz0yRV9TdXNwZW5kaXNzZScKICAgICAgICAgICAgICAgICAgICAnX3A9QzM9QjR0ZW50aT0yRV9BbGlxdWFtX25pYmg9MkU/PVxuIFN1c3BlbmRpc3NlID0/dXRmLTgnCiAgICAgICAgICAgICAgICAgICAgJz9xP3A9QzM9QjR0ZW50aT0yRT89JywKICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgKToKICAgICAgICAgICAgaCA9IHNlbGYubWFrZV9oZWFkZXIoJ1RvJywgQWRkcmVzcyhuYW1lLCBhZGRyX3NwZWM9J2FAYi5jb20nKSkKIGVjdF0pLAoKICAgICAgICAjIEJ1dCB1bmtub3duIG5hbWVzIGFyZSBPSy4gIFdlIGNvdWxkIG1ha2Ugbm9uLUlBTkEgbmFtZXMgYSBkZWZlY3QsIGJ1dAogICAgICAgICMgYnkgbm90IGRvaW5nIHNvIHdlIG1ha2Ugb3Vyc2VsdmVzIGZ1dHVyZSBwcm9vZi4gIFRoZSBmYWN0IHRoYXQgdGhleQogICAgICAgICMgYXJlIHVua25vd24gd2lsbCBiZSBkZXRlY3RhYmxlIGJ5IHRoZSBmYWN0IHRoYXQgdGhleSBkb24ndCBhcHBlYXIgaW4KICAgICAgICAjIHRoZSBtaW1lX3JlZ2lzdHJ5Li4uYW5kIHRoZSBhcHBsaWNhdGlvbiBpcyBmcmVlIHRvIGV4dGVuZCB0aGF0IGxpc3QKICAgICAgICAjIHRvIGhhbmRsZSB0aGVtIGV2ZW4gaWYgdGhlIGNvcmUgbGlicmFyeSBkb2Vzbid0LgoKICAgICAgICAndW5rbm93bl9jb250ZW50X3R5cGUnOiAoCiAgICAgICAgICAgICdiYWQvbmFtZXMnLAogICAgICAgICAgICAnYmFkL25hbWVzJywKICAgICAgICAgICAgJ2JhZCcsCiAgICAgICAgICAgICduYW1lcycpLAoKICAgICAgICAjIFRoZSBjb250ZW50IHR5cGUgaXMgY2FzZSBpbnNlbnNpdGl2ZSwgYW5kIENGV1MgaXMgaWdub3JlZC4KCiAgICAgICAgJ21peGVkX2Nhc2VfY29udGVudF90eXBlJzogKAogICAgICAgICAgICAnSW1BZ2UvSlBlZycsCiAgICAgICAgICAgICdpbWFnZS9qcGVnJywKICAgICAgICAgICAgJ2ltYWdlJywKICAgICAgICAgICAgJ2pwZWcnKSwKCiAgICAgICAgJ3NwYWNlc19pbl9jb250ZW50X3R5cGUnOiAoCiAgICAgICAgICAgICcgIHRleHQgIC8gIHBsYWluICAnLAogICAgICAgICAgICAndGV4dC9wbGFpbicsCiAgICAgICAgICAgICd0ZXh0JywKICAgICAgICAgICAgJ3BsYWluJyksCgogICAgICAgICdjZndzX2luX2NvbnRlbnRfdHlwZSc6ICgKICAgICAgICAgICAgJyhmb28pIHRleHQgKGJhcikvKGJheilwbGFpbihzdHVmZiknLAogICAgICAgICAgICAndGV4dC9wbGFpbicsCiAgICAgICAgICAgICd0ZXh0JywKICAgICAgICAgICAgJ3BsYWluJyksCgogICAgICAgICMgdGVzdCBzb21lIHBhcmFtZXRlcnMgKG1vcmUgdGVzdHMgY291bGQgYmUgYWRkZWQgZm9yIHBhcmFtZXRlcnMKICAgICAgICAjIGFzc29jaWF0ZWQgd2l0aCBvdGhlciBjb250ZW50IHR5cGVzLCBidXQgc2luY2UgcGFyYW1ldGVyIHBhcnNpbmcgaXMKICAgICAgICAjIGdlbmVyaWMgdGhleSB3b3VsZCBiZSByZWR1bmRhbnQgZm9yIHRoZSBjdXJyZW50IGltcGxlbWVudGF0aW9uKS4KCiAgICAgICAgJ2NoYXJzZXRfcGFyYW0nOiAoCiAgICAgICAgICAgICd0ZXh0L3BsYWluOyBjaGFyc2V0PSJ1dGYtOCInLAogICAgICAgICAgICAndGV4dC9wbGFpbicsCiAgICAgICAgICAgICd0ZXh0JywKICAgICAgICAgICAgJ3BsYWluJywKICAgICAgICAgICAgeydjaGFyc2V0JzogJ3V0Zi04J30pLAoKICAgICAgICAnY2FwaXRhbGl6ZWRfY2hhcnNldCc6ICgKICAgICAgICAgICAgJ3RleHQvcGxhaW47IGNoYXJzZXQ9IlVTLUFTQ0lJIicsCiBlc3RfbTJtX2NvbGxlY3Rpb24oc2VsZik6CiAgICAgICAgYiA9IEJvb2sub2JqZWN0cy5jcmVhdGUoCiAgICAgICAgICAgIHRpdGxlPSJQcm8gRGphbmdvIiwgcHVibGlzaGVkPWRhdGV0aW1lLmRhdGUoMjAwOCwgMTIsIDE2KQogICAgICAgICkKCiAgICAgICAgcCA9IFBlcnNvbi5vYmplY3RzLmNyZWF0ZShuYW1lPSJNYXJ0eSBBbGNoaW4iKQogICAgICAgICMgdGVzdCBhZGQKICAgICAgICBiLmF1dGhvcnMuYWRkKHApCiAgICAgICAgIyB0ZXN0IHJlbW92ZQogICAgICAgIGIuYXV0aG9ycy5yZW1vdmUocCkKICAgICAgICAjIHRlc3QgY2xlYXIKICAgICAgICBiLmF1dGhvcnMuY2xlYXIoKQogICAgICAgICMgdGVzdCBzZXRhdHRyCiAgICAgICAgYi5hdXRob3JzLnNldChbcF0pCiAgICAgICAgIyB0ZXN0IE0yTSBjb2xsZWN0aW9uCiAgICAgICAgYi5kZWxldGUoKQoKICAgIGRlZiB0ZXN0X2ZvcmVpZ25rZXlfY29sbGVjdGlvbihzZWxmKToKICAgICAgICBwZXJzb24gPSBQZXJzb24ub2JqZWN0cy5jcmVhdGUobmFtZT0iQm9iIikKICAgICAgICBQZXQub2JqZWN0cy5jcmVhdGUob3duZXI9cGVyc29uLCBuYW1lPSJXYXJ0IikKICAgICAgICAjIHRlc3QgcmVsYXRlZCBGSyBjb2xsZWN0aW9uCiAgICAgICAgcGVyc29uLmRlbGV0ZSgpCgoKY2xhc3MgU3luY09ubHlEZWZhdWx0RGF0YWJhc2VSb3V0ZXI6CiAgICBkZWYgYWxsb3dfbWlncmF0ZShzZWxmLCBkYiwgYXBwX2xhYmVsLCAqKmhpbnRzKToKICAgICAgICByZXR1cm4gZGIgPT0gREVGQVVMVF9EQl9BTElBUwoKCmNsYXNzIE1pZ3JhdGVUZXN0Q2FzZShUZXN0Q2FzZSk6CiAgICAjIExpbWl0IG1lbW9yeSB1c2FnZSB3aGVuIGNhbGxpbmcgJ21pZ3JhdGUnLgogICAgYXZhaWxhYmxlX2FwcHMgPSBbCiAgICAgICAgIm11bHRpcGxlX2RhdGFiYXNlIiwKICAgICAgICAiZGphbmdvLmNvbnRyaWIuYXV0aCIsCiAgICAgICAgImRqYW5nby5jb250cmliLmNvbnRlbnR0eXBlcyIsCiAgICBdCiAgICBkYXRhYmFzZXMgPSB7ImRlZmF1bHQiLCAib3RoZXIifQoKICAgIGRlZiB0ZXN0X21pZ3JhdGVfdG9fb3RoZXJfZGF0YWJhc2Uoc2VsZik6CiAgICAgICAgIiIiUmVncmVzc2lvbiB0ZXN0IGZvciAjMTYwMzk6IG1pZ3JhdGUgd2l0aCAtLWRhdGFiYXNlIG9wdGlvbi4iIiIKICAgICAgICBjdHMgPSBDb250ZW50VHlwZS5vYmplY3RzLnVzaW5nKCJvdGhlciIpLmZpbHRlcihhcHBfbGFiZWw9Im11bHRpcGxlX2RhdGFiYXNlIikKCiAgICAgICAgY291bnQgPSBjdHMuY291bnQoKQogICAgICAgIHNlbGYuYXNzZXJ0R3JlYXRlcihjb3VudCwgMCkKCiAgICAgICAgY3RzLmRlbGV0ZSgpCiAgICAgICAgbWFuYWdlbWVudC5jYWxsX2NvbW1hbmQoCiAgICAgICAgICAgICJtaWdyYXRlIiwgdmVyYm9zaXR5PTAsIGludGVyYWN0aXZlPUZhbHNlLCBkYXRhYmFzZT0ib3RoZXIiCiAgICAgICAgKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoY3RzLmNvdW50KCksIGNvdW50KQoKbHQiKS5jb3VudCgpLCAxKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoQm9vay5hdXRob3JzLnRocm91Z2gub2JqZWN0cy51c2luZygib3RoZXIiKS5jb3VudCgpLCAwKQoKICAgICAgICAjIElmIHlvdSBjcmVhdGUgYW4gb2JqZWN0IHRocm91Z2ggYSBNMk0gcmVsYXRpb24sIGl0IHdpbGwgYmUKICAgICAgICAjIHdyaXR0ZW4gdG8gdGhlIHdyaXRlIGRhdGFiYXNlLCBldmVuIGlmIHRoZSBvcmlnaW5hbCBvYmplY3QKICAgICAgICAjIHdhcyBvbiB0aGUgcmVhZCBkYXRhYmFzZQogICAgICAgIGFsaWNlID0gZGl2ZS5hdXRob3JzLmNyZWF0ZShuYW1lPSJBbGljZSIsIHBrPTMpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChhbGljZS5fc3RhdGUuZGIsICJkZWZhdWx0IikKCiAgICAgICAgIyBTYW1lIGdvZXMgZm9yIGdldF9vcl9jcmVhdGUsIHJlZ2FyZGxlc3Mgb2Ygd2hldGhlciBnZXR0aW5nIG9yCiAgICAgICAgIyBjcmVhdGluZwogICAgICAgIGFsaWNlLCBjcmVhdGVkID0gZGl2ZS5hdXRob3JzLmdldF9vcl9jcmVhdGUobmFtZT0iQWxpY2UiKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYWxpY2UuX3N0YXRlLmRiLCAiZGVmYXVsdCIpCgogICAgICAgIGJvYiwgY3JlYXRlZCA9IGRpdmUuYXV0aG9ycy5nZXRfb3JfY3JlYXRlKG5hbWU9IkJvYiIsIGRlZmF1bHRzPXsicGsiOiA0fSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGJvYi5fc3RhdGUuZGIsICJkZWZhdWx0IikKCiAgICBkZWYgdGVzdF9vMm9fY3Jvc3NfZGF0YWJhc2VfcHJvdGVjdGlvbihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBPcGVyYXRpb25zIHRoYXQgaW52b2x2ZSBzaGFyaW5nIEZLIG9iamVjdHMgYWNyb3NzIGRhdGFiYXNlcyByYWlzZSBhbgogICAgICAgIGVycm9yCiAgICAgICAgIiIiCiAgICAgICAgIyBDcmVhdGUgYSB1c2VyIGFuZCBwcm9maWxlIG9uIHRoZSBkZWZhdWx0IGRhdGFiYXNlCiAgICAgICAgYWxpY2UgPSBVc2VyLm9iamVjdHMuZGJfbWFuYWdlcigiZGVmYXVsdCIpLmNyZWF0ZV91c2VyKAogICAgICAgICAgICAiYWxpY2UiLCAiYWxpY2VAZXhhbXBsZS5jb20iCiAgICAgICAgKQoKICAgICAgICAjIENyZWF0ZSBhIHVzZXIgYW5kIHByb2ZpbGUgb24gdGhlIG90aGVyIGRhdGFiYXNlCiAgICAgICAgYm9iID0gVXNlci5vYmplY3RzLmRiX21hbmFnZXIoIm90aGVyIikuY3JlYXRlX3VzZXIoImJvYiIsICJib2JAZXhhbXBsZS5jb20iKQoKICAgICAgICAjIFNldCBhIG9uZS10by1vbmUgcmVsYXRpb24gd2l0aCBhbiBvYmplY3QgZnJvbSBhIGRpZmZlcmVudCBkYXRhYmFzZQogICAgICAgIGFsaWNlX3Byb2ZpbGUgPSBVc2VyUHJvZmlsZS5vYmplY3RzLmNyZWF0ZSh1c2VyPWFsaWNlLCBmbGF2b3I9ImNob2NvbGF0ZSIpCiAgICAgICAgYm9iLnVzZXJwcm9maWxlID0gYWxpY2VfcHJvZmlsZQoKICAgICAgICAjIERhdGFiYXNlIGFzc2lnbm1lbnRzIG9mIG9yaWdpbmFsIG9iamVjdHMgaGF2ZW4ndCBjaGFuZ2VkLi4uCiBvcihmJ3Vuc3VwcG9ydGVkIGtpbmQgaW4ge2l0ZW0hcn0nKQogICAgcmV0dXJuIGNvbGxhdGVkCgoKZGVmIGdyb3VwX2J5X2tpbmRzKGl0ZW1zKToKICAgICMgQ29sbGF0ZSBpbnRvIGtpbmQgZ3JvdXBzIChkZWNsLCB0eXBlLCBldGMuKS4KICAgIGNvbGxhdGVkID0ge19LSU5ELmdldF9ncm91cChrKTogW10gZm9yIGsgaW4gX0tJTkR9CiAgICBmb3IgaXRlbSBpbiBpdGVtczoKICAgICAgICBncm91cCA9IF9LSU5ELmdldF9ncm91cChpdGVtLmtpbmQpCiAgICAgICAgY29sbGF0ZWRbZ3JvdXBdLmFwcGVuZChpdGVtKQogICAgcmV0dXJuIGNvbGxhdGVkCiIiIgpUaGlzIG1vZHVsZSBpcyBmb3IgdGhlIG1pc2NlbGxhbmVvdXMgR0VPUyByb3V0aW5lcywgcGFydGljdWxhcmx5IHRoZQpvbmVzIHRoYXQgcmV0dXJuIHRoZSBhcmVhLCBkaXN0YW5jZSwgYW5kIGxlbmd0aC4KIiIiCgpmcm9tIGN0eXBlcyBpbXBvcnQgUE9JTlRFUiwgY19kb3VibGUsIGNfaW50Cgpmcm9tIGRqYW5nby5jb250cmliLmdpcy5nZW9zLmxpYmdlb3MgaW1wb3J0IEdFT01fUFRSLCBHRU9TRnVuY0ZhY3RvcnkKZnJvbSBkamFuZ28uY29udHJpYi5naXMuZ2Vvcy5wcm90b3R5cGVzLmVycmNoZWNrIGltcG9ydCBjaGVja19kYmwsIGNoZWNrX3N0cmluZwpmcm9tIGRqYW5nby5jb250cmliLmdpcy5nZW9zLnByb3RvdHlwZXMuZ2VvbSBpbXBvcnQgZ2Vvc19jaGFyX3AKCl9fYWxsX18gPSBbImdlb3NfYXJlYSIsICJnZW9zX2Rpc3RhbmNlIiwgImdlb3NfbGVuZ3RoIiwgImdlb3NfaXN2YWxpZHJlYXNvbiJdCgoKY2xhc3MgRGJsRnJvbUdlb20oR0VPU0Z1bmNGYWN0b3J5KToKICAgICIiIgogICAgQXJndW1lbnQgaXMgYSBHZW9tZXRyeSwgcmV0dXJuIHR5cGUgaXMgZG91YmxlIHRoYXQgaXMgcGFzc2VkCiAgICBpbiBieSByZWZlcmVuY2UgYXMgdGhlIGxhc3QgYXJndW1lbnQuCiAgICAiIiIKCiAgICByZXN0eXBlID0gY19pbnQgICMgU3RhdHVzIGNvZGUgcmV0dXJuZWQKICAgIGVycmNoZWNrID0gc3RhdGljbWV0aG9kKGNoZWNrX2RibCkKCgojICMjIyBjdHlwZXMgcHJvdG90eXBlcyAjIyMKCiMgQXJlYSwgZGlzdGFuY2UsIGFuZCBsZW5ndGggcHJvdG90eXBlcy4KZ2Vvc19hcmVhID0gRGJsRnJvbUdlb20oIkdFT1NBcmVhIiwgYXJndHlwZXM9W0dFT01fUFRSLCBQT0lOVEVSKGNfZG91YmxlKV0pCmdlb3NfZGlzdGFuY2UgPSBEYmxGcm9tR2VvbSgKICAgICJHRU9TRGlzdGFuY2UiLCBhcmd0eXBlcz1bR0VPTV9QVFIsIEdFT01fUFRSLCBQT0lOVEVSKGNfZG91YmxlKV0KKQpnZW9zX2xlbmd0aCA9IERibEZyb21HZW9tKCJHRU9TTGVuZ3RoIiwgYXJndHlwZXM9W0dFT01fUFRSLCBQT0lOVEVSKGNfZG91YmxlKV0pCmdlb3NfaXN2YWxpZHJlYXNvbiA9IEdFT1NGdW5jRmFjdG9yeSgKICAgICJHRU9TaXNWYWxpZFJlYXNvbiIsIHJlc3R5cGU9Z2Vvc19jaGFyX3AsIGVycmNoZWNrPWNoZWNrX3N0cmluZywgYXJndHlwZXM9W0dFT01fUFRSXQopCmltcG9ydCBoYXNodWFsKG51bWVyaWMsICIwODAwIDM1NjkzNzciKQogICAgICAgIGxhenlfbnVtZXJpYyA9IGxhenlzdHIodGV4dC5waG9uZTJudW1lcmljKCIwODAwIGZsb3dlcnMiKSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGxhenlfbnVtZXJpYywgIjA4MDAgMzU2OTM3NyIpCgogICAgZGVmIHRlc3Rfc2x1Z2lmeShzZWxmKToKICAgICAgICBpdGVtcyA9ICgKICAgICAgICAgICAgIyBnaXZlbiAtIGV4cGVjdGVkIC0gVW5pY29kZT8KICAgICAgICAgICAgKCJIZWxsbywgV29ybGQhIiwgImhlbGxvLXdvcmxkIiwgRmFsc2UpLAogICAgICAgICAgICAoInNwYW0gJiBlZ2dzIiwgInNwYW0tZWdncyIsIEZhbHNlKSwKICAgICAgICAgICAgKCIgbXVsdGlwbGUtLS1kYXNoIGFuZCAgc3BhY2UgIiwgIm11bHRpcGxlLWRhc2gtYW5kLXNwYWNlIiwgRmFsc2UpLAogICAgICAgICAgICAoIlx0IHdoaXRlc3BhY2UtaW4tdmFsdWUgXG4iLCAid2hpdGVzcGFjZS1pbi12YWx1ZSIsIEZhbHNlKSwKICAgICAgICAgICAgKCJ1bmRlcnNjb3JlX2luLXZhbHVlIiwgInVuZGVyc2NvcmVfaW4tdmFsdWUiLCBGYWxzZSksCiAgICAgICAgICAgICgiX19zdHJpcF9fdW5kZXJzY29yZS12YWx1ZV9fXyIsICJzdHJpcF9fdW5kZXJzY29yZS12YWx1ZSIsIEZhbHNlKSwKICAgICAgICAgICAgKCItLXN0cmlwLWRhc2gtdmFsdWUtLS0iLCAic3RyaXAtZGFzaC12YWx1ZSIsIEZhbHNlKSwKICAgICAgICAgICAgKCJfX3N0cmlwLW1peGVkLXZhbHVlLS0tIiwgInN0cmlwLW1peGVkLXZhbHVlIiwgRmFsc2UpLAogICAgICAgICAgICAoIl8gLXN0cmlwLW1peGVkLXZhbHVlIF8tIiwgInN0cmlwLW1peGVkLXZhbHVlIiwgRmFsc2UpLAogICAgICAgICAgICAoInNwYW0gJiDEscOnw7zFnyIsICJzcGFtLcSxw6fDvMWfIiwgVHJ1ZSksCiAgICAgICAgICAgICgiZm9vIMSxw6cgYmFyIiwgImZvby3EscOnLWJhciIsIFRydWUpLAogICAgICAgICAgICAoIiAgICBmb28gxLHDpyBiYXIiLCAiZm9vLcSxw6ctYmFyIiwgVHJ1ZSksCiAgICAgICAgICAgICgi5L2g5aW9IiwgIuS9oOWlvSIsIFRydWUpLAogICAgICAgICAgICAoIsSwc3RhbmJ1bCIsICJpc3RhbmJ1bCIsIFRydWUpLAogICAgICAgICkKICAgICAgICBmb3IgdmFsdWUsIG91dHB1dCwgaXNfdW5pY29kZSBpbiBpdGVtczoKICAgICAgICAgICAgd2l0aCBzZWxmLnN1YlRlc3QodmFsdWU9dmFsdWUpOgogICAgICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCh0ZXh0LnNsdWdpZnkodmFsdWUsIGFsbG93X3VuaWNvZGU9aXNfdW5pY29kZSksIG91dHB1dCkKICAgICAgICAjIEludGVybmluZyB0aGUgcmVzdWx0IG1heSBiZSB1c2VmdWwsIGUuZy4gd2hlbiBmZWQgdG8gUGF0aC4KICAgICAgICB3aXRoIHNlbGYuc3ViVGVzdCgiaW50ZXJuIik6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoc3lzLmludGVybih0ZXh0LnNsdWdpZnkoImEiKSksICJhIikKCiAgICBkZWYgdGVzdF91bmVzY2FwZV9zdHJpbmdfbGl0ZXJhbChzbnQ9KC03NS4yNzQyMDAsIDM5Ljg0NjUwNCwgLTc0Ljk1OTcxNywgNDAuMTE5MDQwKSwgICMgR290IGV4dGVudCBmcm9tIFFHSVMKICAgICAgICBmaWVsZF92YWx1ZXM9ewogICAgICAgICAgICAidXVpZCI6IFsKICAgICAgICAgICAgICAgICIxMzc4YzI2Zi1jYmU2LTQ0YjAtOTI5Zi1lYjMzMGQ0OTkxZjUiLAogICAgICAgICAgICAgICAgImZhMmJhNjdjLWExMzUtNDMzOC1iOTI0LWE5NjIyYjVkODY5ZiIsCiAgICAgICAgICAgICAgICAiNDQ5NGMxZjMtNTVhYi00MjU2LWIzNjUtMTIxMTVjYjM4OGQ1IiwKICAgICAgICAgICAgXSwKICAgICAgICAgICAgIm5hbWUiOiBbIlBoaWxhZGVscGhpYSIsIE5vbmUsICJub3J0aCJdLAogICAgICAgICAgICAibnVtIjogWzEuMDAxLCBOb25lLCAwLjBdLAogICAgICAgICAgICAiaW50ZWdlciI6IFs1LCBOb25lLCA4XSwKICAgICAgICAgICAgImJvb2xlYW4iOiBbVHJ1ZSwgTm9uZSwgRmFsc2VdLAogICAgICAgICAgICAiZGF0ZXRpbWUiOiBbCiAgICAgICAgICAgICAgICBkYXRldGltZS5zdHJwdGltZSgiMTk5NC0wOC0xNFQxMTozMjoxNCIsIGRhdGV0aW1lX2Zvcm1hdCksCiAgICAgICAgICAgICAgICBOb25lLAogICAgICAgICAgICAgICAgZGF0ZXRpbWUuc3RycHRpbWUoIjIwMTgtMTEtMjlUMDM6MDI6NTIiLCBkYXRldGltZV9mb3JtYXQpLAogICAgICAgICAgICBdLAogICAgICAgIH0sCiAgICAgICAgZmlkcz1yYW5nZSgzKSwKICAgICksCikKCmJhZF9kcyA9IChUZXN0RFMoImZvbyIpLCkKCgpjbGFzcyBEYXRhU291cmNlVGVzdChTaW1wbGVUZXN0Q2FzZSk6CiAgICBkZWYgdGVzdDAxX3ZhbGlkX3NocChzZWxmKToKICAgICAgICAiVGVzdGluZyB2YWxpZCBTSFAgRGF0YSBTb3VyY2UgZmlsZXMuIgoKICAgICAgICBmb3Igc291cmNlIGluIGRzX2xpc3Q6CiAgICAgICAgICAgICMgTG9hZGluZyB1cCB0aGUgZGF0YSBzb3VyY2UKICAgICAgICAgICAgZHMgPSBEYXRhU291cmNlKHNvdXJjZS5kcykKCiAgICAgICAgICAgICMgVGhlIGxheWVyIGNvdW50IGlzIHdoYXQncyBleHBlY3RlZCAob25seSAxIGxheWVyIGluIGEgU0hQIGZpbGUpLgogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKDEsIGxlbihkcykpCgogICAgICAgICAgICAjIE1ha2luZyBzdXJlIEdldE5hbWUgd29ya3MKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzb3VyY2UuZHMsIGRzLm5hbWUpCgogICAgICAgICAgICAjIE1ha2luZyBzdXJlIHRoZSBkcml2ZXIgbmFtZSBtYXRjaGVzIHVwCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoc291cmNlLmRyaXZlciwgc3RyKGRzLmRyaXZlcikpCgogICAgICAgICAgICAjIE1ha2luZyBzdXJlIGluZGV4aW5nIHdvcmtzCiAgICAgICAgICAgIG1zZyA9ICJJbmRleCBvdXQgb2YgcmFuZ2Ugd2hlbiBhY2Nlc3NpbmcgbGF5ZXJzIGluIGEgZGF0YXNvdXJjZTogJXMuIgogICAgICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzTWVzc2FnZShJbmRleAojIEV4cGFuZCBYSW5jbHVkZSBkaXJlY3RpdmVzLgojCiMgQHBhcmFtIGVsZW0gUm9vdCBFbGVtZW50IG9yIGFueSBFbGVtZW50VHJlZSBvZiBhIHRyZWUgdG8gYmUgZXhwYW5kZWQKIyBAcGFyYW0gbG9hZGVyIE9wdGlvbmFsIHJlc291cmNlIGxvYWRlci4gIElmIG9taXR0ZWQsIGl0IGRlZmF1bHRzCiMgICAgIHRvIHtAbGluayBkZWZhdWx0X2xvYWRlcn0uICBJZiBnaXZlbiwgaXQgc2hvdWxkIGJlIGEgY2FsbGFibGUKIyAgICAgdGhhdCBpbXBsZW1lbnRzIHRoZSBzYW1lIGludGVyZmFjZSBhcyA8Yj5kZWZhdWx0X2xvYWRlcjwvYj4uCiMgQHBhcmFtIGJhc2VfdXJsIFRoZSBiYXNlIFVSTCBvZiB0aGUgb3JpZ2luYWwgZmlsZSwgdG8gcmVzb2x2ZQojICAgICByZWxhdGl2ZSBpbmNsdWRlIGZpbGUgcmVmZXJlbmNlcy4KIyBAcGFyYW0gbWF4X2RlcHRoIFRoZSBtYXhpbXVtIG51bWJlciBvZiByZWN1cnNpdmUgaW5jbHVzaW9ucy4KIyAgICAgTGltaXRlZCB0byByZWR1Y2UgdGhlIHJpc2sgb2YgbWFsaWNpb3VzIGNvbnRlbnQgZXhwbG9zaW9uLgojICAgICBQYXNzIE5vbmUgdG8gZGlzYWJsZSB0aGUgbGltaXRhdGlvbi4KIyBAdGhyb3dzIExpbWl0ZWRSZWN1cnNpdmVJbmNsdWRlRXJyb3IgSWYgdGhlIHtAbGluayBtYXhfZGVwdGh9IHdhcyBleGNlZWRlZC4KIyBAdGhyb3dzIEZhdGFsSW5jbHVkZUVycm9yIElmIHRoZSBmdW5jdGlvbiBmYWlscyB0byBpbmNsdWRlIGEgZ2l2ZW4KIyAgICAgcmVzb3VyY2UsIG9yIGlmIHRoZSB0cmVlIGNvbnRhaW5zIG1hbGZvcm1lZCBYSW5jbHVkZSBlbGVtZW50cy4KIyBAdGhyb3dzIE9TRXJyb3IgSWYgdGhlIGZ1bmN0aW9uIGZhaWxzIHRvIGxvYWQgYSBnaXZlbiByZXNvdXJjZS4KIyBAdGhyb3dzIFZhbHVlRXJyb3IgSWYgbmVnYXRpdmUge0BsaW5rIG1heF9kZXB0aH0gaXMgcGFzc2VkLgojIEByZXR1cm5zIE5vbmUuIE1vZGlmaWVzIHRyZWUgcG9pbnRlZCBieSB7QGxpbmsgZWxlbX0KCmRlZiBpbmNsdWRlKGVsZW0sIGxvYWRlcj1Ob25lLCBiYXNlX3VybD1Ob25lLAogICAgICAgICAgICBtYXhfZGVwdGg9REVGQVVMVF9NQVhfSU5DTFVTSU9OX0RFUFRIKToKICAgIGlmIG1heF9kZXB0aCBpcyBOb25lOgogICAgICAgIG1heF9kZXB0aCA9IC0xCiAgICBlbGlmIG1heF9kZXB0aCA8IDA6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiZXhwZWN0ZWQgbm9uLW5lZ2F0aXZlIGRlcHRoIG9yIE5vbmUgZm9yICdtYXhfZGVwdGgnLCBnb3QgJXIiICUgbWF4X2RlcHRoKQoKICAgIGlmIGhhc2F0dHIoZWxlbSwgJ2dldHJvb3QnKToKICAgICAgICBlbGVtID0gZWxlbS5nZXRyb290KCkKICAgIGlmIGxvYWRlciBpcyBOb25lOgogICAgICAgIGxvYWRlciA9IGRlZmF1bHRfbG9hZGVyCgogICAgX2luY2x1ZGUoZWxlbSwgbG9hZGVyLCBiYXNlX3VybCwgbWF4X2RlcHRoLCBzZXQoKSkKCgpkZWYgX2luY2x1ZGUoZWxlbSwgbG9hZGVyLCBiYXNlX3VybCwgbWF4X2RlcHRoLCBfcGFyZW50X2hyZWZzKToKICJQQVRIIiwKICAgICAgICAiUEFUSEVYVCIsCiAgICAgICAgIlBJUF9DT05GSUdfRklMRSIsCiAgICAgICAgIlBMQVQiLAogICAgICAgICJQT1NJWExZX0NPUlJFQ1QiLAogICAgICAgICJQWVRIT05fQ09MT1JTIiwKICAgICAgICAiUFlfU0FYX1BBUlNFUiIsCiAgICAgICAgIlByb2dyYW1GaWxlcyIsCiAgICAgICAgIlByb2dyYW1GaWxlcyh4ODYpIiwKICAgICAgICAiUlVOTklOR19PTl9WQUxHUklORCIsCiAgICAgICAgIlNES19UT09MU19CSU4iLAogICAgICAgICJTRVJWRVJfU09GVFdBUkUiLAogICAgICAgICJTSEVMTCIsCiAgICAgICAgIlNPVVJDRV9EQVRFX0VQT0NIIiwKICAgICAgICAiU1lTVEVNUk9PVCIsCiAgICAgICAgIlRFTVAiLAogICAgICAgICJURVJNIiwKICAgICAgICAiVElMRV9MSUJSQVJZIiwKICAgICAgICAiVE1QIiwKICAgICAgICAiVE1QRElSIiwKICAgICAgICAiVFJBVklTIiwKICAgICAgICAiVFoiLAogICAgICAgICJVU0VSUFJPRklMRSIsCiAgICAgICAgIlZJUlRVQUxfRU5WIiwKICAgICAgICAiV0FZTEFORF9ESVNQTEFZIiwKICAgICAgICAiV0lORElSIiwKICAgICAgICAiX1BZVEhPTl9IT1NUUlVOTkVSIiwKICAgICAgICAiX1BZVEhPTl9IT1NUX1BMQVRGT1JNIiwKICAgICAgICAiX1BZVEhPTl9QUk9KRUNUX0JBU0UiLAogICAgICAgICJfUFlUSE9OX1NZU0NPTkZJR0RBVEFfTkFNRSIsCiAgICAgICAgIl9QWVRIT05fU1lTQ09ORklHREFUQV9QQVRIIiwKICAgICAgICAiX19QWVZFTlZfTEFVTkNIRVJfXyIsCgogICAgICAgICMgU2FuaXRpemVyIG9wdGlvbnMKICAgICAgICAiQVNBTl9PUFRJT05TIiwKICAgICAgICAiTFNBTl9PUFRJT05TIiwKICAgICAgICAiTVNBTl9PUFRJT05TIiwKICAgICAgICAiVFNBTl9PUFRJT05TIiwKICAgICAgICAiVUJTQU5fT1BUSU9OUyIsCiAgICApKQogICAgZm9yIG5hbWUsIHZhbHVlIGluIG9zLmVudmlyb24uaXRlbXMoKToKICAgICAgICB1bmFtZSA9IG5hbWUudXBwZXIoKQogICAgICAgIGlmICh1bmFtZSBpbiBFTlZfVkFSUwogICAgICAgICAgICMgQ29weSBQWVRIT04qIHZhcmlhYmxlcyBsaWtlIFBZVEhPTlBBVEgKICAgICAgICAgICAjIENvcHkgTENfKiB2YXJpYWJsZXMgbGlrZSBMQ19BTEwKICAgICAgICAgICBvciB1bmFtZS5zdGFydHN3aXRoKCgiUFlUSE9OIiwgIkxDXyIpKQogICAgICAgICAgICMgVmlzdWFsIFN0dWRpbzogVlMxNDBDT01OVE9PTFMKICAgICAgICAgICBvciAodW5hbWUuc3RhcnRzd2l0aCgiVlMiKSBhbmQgdW5hbWUuZW5kc3dpdGgoIkNPTU5UT09MUyIpKSk6CiAgICAgICAgICAgIGluZm9fYWRkKCdvcy5lbnZpcm9uWyVzXScgJSBuYW1lLCB2YWx1ZSkKCiAgICBpZiBoYXNhdHRyKG9zLCAndW1hc2snKToKICAgICAgICBtYXNrID0gb3MudW1hc2soMCkKICAgICAgICBvcy51bWFzayhtYXNrKQogICAgICAgIGluZm9fYWRkKCJvcy51bWFzayIsICcwbyUwM28nICUgbWFzaykKCgpkZWYgY29sbGVjdF9wd2QoaW5mb19hZGQpOmdyYW0gaXMgaW52YWxpZCwgYnV0IGNhbid0IGNvbXBsYWluCiAgICAgICAgICAgICAgICBsYXN0Y2ggPSBjaCArIGNvZGVbcF0KICAgICAgICAgICAgcCA9IHArMSAgICAgIyBiZXlvbmQgZXNjYXBlZCBjaGFyCgogICAgICAgICMgZW5kIHdoaWxlIHAgPCBxOgoKICAgICAgICBzZWxmLmxhc3RjaCA9IGxhc3RjaAogICAgICAgIHNlbGYubGFzdG9wZW5icmFja2V0cG9zID0gc3RhY2tbLTFdIGlmIHN0YWNrIGVsc2UgTm9uZQogICAgICAgIHNlbGYuc3RtdF9icmFja2V0aW5nID0gdHVwbGUoYnJhY2tldGluZykKCiAgICBkZWYgY29tcHV0ZV9icmFja2V0X2luZGVudChzZWxmKToKICAgICAgICAiIiJSZXR1cm4gbnVtYmVyIG9mIHNwYWNlcyB0aGUgbmV4dCBsaW5lIHNob3VsZCBiZSBpbmRlbnRlZC4KCiAgICAgICAgTGluZSBjb250aW51YXRpb24gbXVzdCBiZSBDX0JSQUNLRVQuCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5fc3R1ZHkyKCkKICAgICAgICBhc3NlcnQgc2VsZi5jb250aW51YXRpb24gPT0gQ19CUkFDS0VUCiAgICAgICAgaiA9IHNlbGYubGFzdG9wZW5icmFja2V0cG9zCiAgICAgICAgY29kZSA9IHNlbGYuY29kZQogICAgICAgIG4gPSBsZW4oY29kZSkKICAgICAgICBvcmlnaSA9IGkgPSBjb2RlLnJmaW5kKCdcbicsIDAsIGopICsgMQogICAgICAgIGogPSBqKzEgICAgICMgb25lIGJleW9uZCBvcGVuIGJyYWNrZXQKICAgICAgICAjIGZpbmQgZmlyc3QgbGlzdCBpdGVtOyBzZXQgaSB0byBzdGFydCBvZiBpdHMgbGluZQogICAgICAgIHdoaWxlIGogPCBuOgogICAgICAgICAgICBtID0gX2l0ZW1yZShjb2RlLCBqKQogICAgICAgICAgICBpZiBtOgogICAgICAgICAgICAgICAgaiA9IG0uZW5kKCkgLSAxICAgICAjIGluZGV4IG9mIGZpcnN0IGludGVyZXN0aW5nIGNoYXIKICAgICAgICAgICAgICAgIGV4dHJhID0gMAogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgdGhpcyBsaW5lIGlzIGp1bms7IGFkdmFuY2UgdG8gbmV4dCBsaW5lCiAgICAgICAgICAgICAgICBpID0gaiA9IGNvZGUuZmluZCgnXG4nLCBqKSArIDEKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIG5vdGhpbmcgaW50ZXJlc3RpbmcgZm9sbG93cyB0aGUgYnJhY2tldDsKICAgICAgICAgICAgIyByZXByb2R1Y2UgdGhlIGJyYWNrZXQgbGluZSdzIGluZGVudGF0aW9uICsgYSBsZXZlbAogICAgICAgICAgICBqID0gaSA9IG9yaWdpCiAgICAgICAgICAgIHdoaWxlIGNvZGVbal0gaW4gIiBcdCI6CiAgICAgICAgICAgICAgICBqID0gaisxCiAgICAgICAgICAgIGV4dHJhID0gc2VsZi5pbmRlbnR3aWR0aAogICAgICAgIHJldHVybiBsZW4oY29kZVtpOmpdLmV4cGFuZHRhYnMoc2VsZi50YWJ3aWR0aCkpICsgZXh0cmEKCiAgICBkZWYgZ2V0X251bV9saW5lc19pbl9zdG10KHNlbGYpOgogICAgICAgICIiIlJldHVybiBudW1iZXIgb2YgcGh5c2ljYWwgbGluZXMgaW4gbGFzdCBzdG10LgoKIG9zaXRlX3BrKHNlbGYpOgogICAgICAgIHN1YnF1ZXJ5ID0gQ29tbWVudC5vYmplY3RzLmZpbHRlcihwaz1PdXRlclJlZigiaWQiKSkudmFsdWVzKCJpZCIpWzoxXQogICAgICAgIHF1ZXJ5c2V0ID0gQ29tbWVudC5vYmplY3RzLmZpbHRlcihpZD1TdWJxdWVyeShzdWJxdWVyeSkpCgogICAgICAgIG1zZyA9ICJDb21wb3NpdGUgZmllbGQgbG9va3VwcyBvbmx5IHdvcmsgd2l0aCBjb21wb3NpdGUgZXhwcmVzc2lvbnMuIgogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXNNZXNzYWdlKFZhbHVlRXJyb3IsIG1zZyk6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocXVlcnlzZXQuY291bnQoKSwgNSkKCiAgICBkZWYgdGVzdF9vdXRlcl9yZWZfaW5fZmlsdGVyZWRfcmVsYXRpb24oc2VsZik6CiAgICAgICAgbXNnID0gKAogICAgICAgICAgICAiVGhpcyBxdWVyeXNldCBjb250YWlucyBhIHJlZmVyZW5jZSB0byBhbiBvdXRlciBxdWVyeSBhbmQgbWF5IG9ubHkgYmUgdXNlZCAiCiAgICAgICAgICAgICJpbiBhIHN1YnF1ZXJ5LiIKICAgICAgICApCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFJhaXNlc01lc3NhZ2UoVmFsdWVFcnJvciwgbXNnKToKICAgICAgICAgICAgc2VsZi5hc3NlcnRTZXF1ZW5jZUVxdWFsKAogICAgICAgICAgICAgICAgVGVuYW50Lm9iamVjdHMuYW5ub3RhdGUoCiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWRfdG9rZW5zPUZpbHRlcmVkUmVsYXRpb24oCiAgICAgICAgICAgICAgICAgICAgICAgICJ0b2tlbnMiLAogICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb249USh0b2tlbnNfX3BrX19ndGU9T3V0ZXJSZWYoInRva2VucyIpKSwKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICApLmZpbHRlcihmaWx0ZXJlZF90b2tlbnM9KDEsIDEpKSwKICAgICAgICAgICAgICAgIFtzZWxmLnRlbmFudF8xXSwKICAgICAgICAgICAgKQoKICAgIGRlZiB0ZXN0X2ZpbHRlcl9ieV90dXBsZV9jb250YWluaW5nX2V4cHJlc3Npb24oc2VsZik6CiAgICAgICAgcGtfbG9va3VwID0gKHNlbGYuY29tbWVudF8xLnRlbmFudC5pZCwgKFZhbHVlKHNlbGYuY29tbWVudF8xLmlkKSArIDEpIC0gMSkKICAgICAgICBmb3IgbG9va3VwIGluICh7InBrIjogcGtfbG9va3VwfSwgeyJwa19faW4iOiBbcGtfbG9va3VwXX0pOgogICAgICAgICAgICB3aXRoIHNlbGYuc3ViVGVzdChsb29rdXA9bG9va3VwKToKICAgICAgICAgICAgICAgIHFzID0gQ29tbWVudC5vYmplY3RzLmZpbHRlcigqKmxvb2t1cCkKICAgICAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocXMuZ2V0KCksIHNlbGYuY29tbWVudF8xKQoKCkBza2lwVW5sZXNzREJGZWF0dXJlKCJzdXBwb3J0c190dXBsZV9sb29rdXBzIikKY2xhc3MgQ29tcG9zaXRlUEtGaWx0ZXJUdXBsZUxvb2t1cEZhbGxiYWNrVGVzdHMoQ29tcG9zaXRlUEtGaWx0ZXJUZXN0cyk6CiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgZmVhdHVyZV9wYXRjaF8xID0gcDk5OTk5OTQ0ODc2NjU0NjU1NTQ3NjA3MTcwMzk1MzI1Nzg1NDZlLTQ3JywKICAgICAgICAgICAgIyBmYWlsaW5nIGNhc2UgZm9yIG9mZi1ieS1vbmUgZXJyb3IgaW50cm9kdWNlZCBieSBNRVREIGluCiAgICAgICAgICAgICMgcjc3NDgzIChkdG9hLmMgY2xlYW51cCksIGZpeGVkIGluIHI3NzQ5MAogICAgICAgICAgICAnOTY1NDM3MTc2MzMzNjU0OTMxNzk5MDM1NTEzNjcxOTk3MTE4MzQ1NTcwMDQ1OTE0NDY5JyAjLi4uCiAgICAgICAgICAgICc2MjEzNDEzMzUwODIxNDE2MzEyMTk0NDIwMDA3OTkxMzA2OTA4NDcwMTQ3MzIyMDIwMTIxMDE4MzY4ZTAnLAogICAgICAgICAgICAjIGluY29ycmVjdCBsc2IgZGV0ZWN0aW9uIGZvciByb3VuZC1oYWxmLXRvLWV2ZW4gd2hlbgogICAgICAgICAgICAjIGJjLT5zY2FsZSAhPSAwIChpc3N1ZSA3NjMyLCBidWcgNikuCiAgICAgICAgICAgICcxMDQzMDg0ODUyNDE5ODM5OTA2NjY3MTM0MDE3MDgwNzIxNzU3NzMxNjUwMzQyNzg2ODUnICMuLi4KICAgICAgICAgICAgJzY4MjY0NjExMTc2MjI5MjQwOTMzMDkyODczOTc1MTcwMjQwNDY1ODE5Nzg3MjMxOTEyOScgIy4uLgogICAgICAgICAgICAnMDM2NTE5OTQ3NDM1MzE5NDE4Mzg3ODM5NzU4OTkwNDc4NTQ5NDc3Nzc3NTg2NjczMDc1JyAjLi4uCiAgICAgICAgICAgICc5NDU4NDQ4OTU5ODEwMTIwMjQzODc5OTIxMzU2MTcwNjQ1MzIxNDE0ODkyNzg4MTUyMzknICMuLi4KICAgICAgICAgICAgJzg0OTEwODEwNTk1MTYxOTk5NzgyOTE1MzYzMzUzNTMxNDg0OTk5OTY3NDI2NjE2OTI1OCcgIy4uLgogICAgICAgICAgICAnOTI4OTQwNjkyMjM5Njg0NzcxNTkwMDY1MDI3MDI1ODM1ODA0ODYzNTg1NDU0ODcyNDk5JyAjLi4uCiAgICAgICAgICAgICczMjA1MDAwMjMxMjYxNDI1NTM5MzI2NTQzNzAzNjIwMjQxMDQ0NjIyNTUyNDQwMzQwNTMnICMuLi4KICAgICAgICAgICAgJzIwMzk5ODk2NDM2MDg4MjQ4NzM3ODMzNDg2MDE5NzcyNTEzOTE1MTI2NTU5MDgzMjg4NycgIy4uLgogICAgICAgICAgICAnNDMzNzM2MTg5NDY4ODU4NjE0NTIxNzA4NTY3NjQ2NzQzNDU1NjAxOTA1OTM1NTk1MzgxJyAjLi4uCiAgICAgICAgICAgICc4NTI3MjM3MjM2NDU3OTk4NjY2NzI1NTg1NzY5OTM5NzgwMjUwMzM1OTA3Mjg2ODcyMDYnICMuLi4KICAgICAgICAgICAgJzI5NjM3OTgwMTM2MzAyNDA5NDA0ODMyNzI3MzkxMzA3OTYxMjQ2OTk4MjU4NTY3NDgyNCcgIy4uLgogICAgICAgICAgICAnMTU2MDAwNzgzMTY3OTYzMDgxNjE2MjE0NzEwNjkxNzU5ODY0MzMyMzM5MjM5Njg4NzM0JyAjLi4uCiAgICAgICAgICAgICc2NTY1NDg3OTA2NTY0ODY2NDYxMDY5ODM0NTA4MDkwNzM3NTA1MzU2MjQ4OTQyOTYyNDInICMuLi4KICAgICAgICAgICAgJzA3MjAxMDE5NTcxMDI3NjA3MzA0MjAzNjQyNTU3OTg1MjQ1OTU1NjE4MzU0MTE5OTAxMicgIy4uLgogICAgICAgICAgICAnNjUyNTcxMTIzODk4OTk2NTc0NTYzODI0NDI0MzMwOTYwMDI3ODczNTE2MDgyNzYzNjcxODc1ZUluKAogICAgICAgICAgICAnPHByZSBjbGFzcz0iZXhjZXB0aW9uX3ZhbHVlIj5DYW4mI3gyNzt0IGZpbmQgbXkga2V5czwvcHJlPicsIGh0bWwKICAgICAgICApCiAgICAgICAgc2VsZi5hc3NlcnROb3RJbignPHRoIHNjb3BlPSJyb3ciPlJlcXVlc3QgTWV0aG9kOjwvdGg+JywgaHRtbCkKICAgICAgICBzZWxmLmFzc2VydE5vdEluKCc8dGggc2NvcGU9InJvdyI+UmVxdWVzdCBVUkw6PC90aD4nLCBodG1sKQogICAgICAgIHNlbGYuYXNzZXJ0Tm90SW4oJzxoMyBpZD0idXNlci1pbmZvIj5VU0VSPC9oMz4nLCBodG1sKQogICAgICAgIHNlbGYuYXNzZXJ0SW4oJzx0aCBzY29wZT0icm93Ij5FeGNlcHRpb24gVHlwZTo8L3RoPicsIGh0bWwpCiAgICAgICAgc2VsZi5hc3NlcnRJbignPHRoIHNjb3BlPSJyb3ciPkV4Y2VwdGlvbiBWYWx1ZTo8L3RoPicsIGh0bWwpCiAgICAgICAgc2VsZi5hc3NlcnRJbigiPGgyPlRyYWNlYmFjayAiLCBodG1sKQogICAgICAgIHNlbGYuYXNzZXJ0SW4oIjxoMj5SZXF1ZXN0IGluZm9ybWF0aW9uPC9oMj4iLCBodG1sKQogICAgICAgIHNlbGYuYXNzZXJ0SW4oIjxwPlJlcXVlc3QgZGF0YSBub3Qgc3VwcGxpZWQ8L3A+IiwgaHRtbCkKCiAgICBkZWYgdGVzdF9zaGFyaW5nX3RyYWNlYmFjayhzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIk9vcHMiKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICBleGNfdHlwZSwgZXhjX3ZhbHVlLCB0YiA9IHN5cy5leGNfaW5mbygpCiAgICAgICAgcmVwb3J0ZXIgPSBFeGNlcHRpb25SZXBvcnRlcihOb25lLCBleGNfdHlwZSwgZXhjX3ZhbHVlLCB0YikKICAgICAgICBodG1sID0gcmVwb3J0ZXIuZ2V0X3RyYWNlYmFja19odG1sKCkKICAgICAgICBzZWxmLmFzc2VydEluKAogICAgICAgICAgICAnPGZvcm0gYWN0aW9uPSJodHRwczovL2RwYXN0ZS5jb20vIiBuYW1lPSJwYXN0ZWZvcm0iICcKICAgICAgICAgICAgJ2lkPSJwYXN0ZWZvcm0iIG1ldGhvZD0icG9zdCI+JywKICAgICAgICAgICAgaHRtbCwKICAgICAgICApCgogICAgZGVmIHRlc3RfZW9sX3N1cHBvcnQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgVGhlIEV4Y2VwdGlvblJlcG9ydGVyIHN1cHBvcnRzIFVuaXgsIFdpbmRvd3MgYW5kIE1hY2ludG9zaCBFT0wgbWFya2VycwogICAgICAgICIiIgogICAgICAgIExJTkVTID0gWyJwcmludCAlZCIgJSBpIGZvciBpIGluIHJhbmdlKDEsIDYpXQogICAgICAgIHJlcG9ydGVyID0gRXhjZXB0aW9uUmVwb3J0ZXIoTm9uZSwgTm9uZSwgTm9uZSwgTm9uZSkKCiAgICAgICAgZm9yIG5ld2xpbmUgaW4gWyJcbiIsICJcclxuIiwgIlxyIl06CiAgICAgICAgICAgIGZkLCBmaWxlbmFtZSA9IHRlbXBmaWxlLm1rc3RlbXAodGV4dD1GYWxzZSkKICAgICAgICAgICAgb3Mud3JpdGUoZmQsIChuZXdsaW5lLmpvaW4oTElORVMpICsgbmV3bGluZSkuZW5jb2RlKCkpCiAgICAgICAgICAgIG9zLmNsb3NlKGZkKQoKICAgICJsYW5nX3N0YXRzIiwKICAgICAgICBoZWxwPSJwcmludCB0aGUgYXBwcm94aW1hdGUgbnVtYmVyIG9mIGNoYW5nZWQvYWRkZWQgc3RyaW5ncyBpbiB0aGUgZW4gY2F0YWxvZyIsCiAgICApCiAgICBhZGRfY29tbW9uX2FyZ3VtZW50cyhwYXJzZXJfc3RhdHMpCgogICAgcGFyc2VyX2ZldGNoID0gc3VicGFyc2Vycy5hZGRfcGFyc2VyKAogICAgICAgICJmZXRjaCIsCiAgICAgICAgaGVscD0iZmV0Y2ggdHJhbnNsYXRpb25zIGZyb20gVHJhbnNpZmV4LCB3cmFwIGxvbmcgbGluZXMsIGdlbmVyYXRlIG1vIGZpbGVzIiwKICAgICkKICAgIGFkZF9jb21tb25fYXJndW1lbnRzKHBhcnNlcl9mZXRjaCkKICAgIHBhcnNlcl9mZXRjaC5hZGRfYXJndW1lbnQoCiAgICAgICAgIi1zIiwKICAgICAgICAiLS1zaW5jZSIsCiAgICAgICAgZGVzdD0iZGF0ZV9zaW5jZSIsCiAgICAgICAgbWV0YXZhcj0iWVlZWS1NTS1ERCIsCiAgICAgICAgdHlwZT1kYXRldGltZS5mcm9taXNvZm9ybWF0LAogICAgICAgIGhlbHA9KAogICAgICAgICAgICAiZmV0Y2ggdHJhbnNsYXRpb25zIHRoYXQgd2VyZSBkb25lIGFmdGVyIHRoaXMgZGF0ZSAoSVNPIGZvcm1hdCBZWVlZLU1NLUREKS4iCiAgICAgICAgKSwKICAgICkKCiAgICBvcHRpb25zID0gcGFyc2VyLnBhcnNlX2FyZ3MoKQogICAga3dhcmdzID0gb3B0aW9ucy5fX2RpY3RfXwogICAgY21kID0ga3dhcmdzLnBvcCgiY21kIikKICAgIGV2YWwoY21kKSgqKmt3YXJncykKIiIidHVydGxlZGVtby9ieXRlZGVzaWduLnB5CgpBbiBleGFtcGxlIGFkYXB0ZWQgZnJvbSB0aGUgZXhhbXBsZS1zdWl0ZQpvZiBQeXRob25DYXJkJ3MgdHVydGxlIGdyYXBoaWNzLgoKSXQncyBiYXNlZCBvbiBhbiBhcnRpY2xlIGluIEJZVEUgbWFnYXppbmUKUHJvYmxlbSBTb2x2aW5nIHdpdGggTG9nbzogVXNpbmcgVHVydGxlCkdyYXBoaWNzIHRvIFJlZHJhdyBhIERlc2lnbgpOb3ZlbWJlciAxOTgyLCBwLiAxMTggLSAxMzQKCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCkR1ZSB0byB0aGUgc3RhdGVtZW50Cgp0LmRlbGF5KDApCgppbiBsaW5lIDE1Miwgd2hpY2ggc2V0cyB0aGUgYW5pbWF0aW9uIGRlbGF5CnRvIDAsIHRoaXMgYW5pbWF0aW9uIHJ1bnMgaW4gImxpbmUgcGVyIGxpbmUiCm1vZGUgYXMgZmFzdCBhcyBwb3NzaWJsZS4KIiIiCgpmcm9tIHR1cnRsZSBpbXBvcnQgVHVydGxlLCBtYWlubG9vcApmcm9tIHRpbWUgaW1wb3J0IHBlcmZfY291bnRlciBhcyBjbG9jawoKIyB3cmFwcGVyIGZvciBhbnkgYWRkaXRpb25hbCBkcmF3aW5nIHJvdXRpbmVzCiMgdGhhdCBuZWVkIHRvIGtub3cgYWJvdXQgZWFjaCBvdGhlcgpjbGFzcyBEZXNpZ25lcihUdXJ0bGUpOgoKICAgIGRlZiBkZXNpZ24oc2VsZiwgaG9tZVBvcywgc2NhbGUpOgogICAgICAgIHNlbGYudXAoKQogICAgICAgIGZvciBpIGluIHJhbmdlKDUpOgogICAgICAgICAgICBzZWxmLmZvcndhcmQoNjQuNjUgKiBzY2FsZSkKIHRleHQoJycnXAptc2dpZCAiZm9vIgptc2dpZF9wbHVyYWwgImZvb3MiCm1zZ3N0ciAiYmFyIgonJycpCgogICAgICAgICAgICByZXMgPSBhc3NlcnRfcHl0aG9uX2ZhaWx1cmUobXNnZm10X3B5LCAnaW52YWxpZC5wbycpCiAgICAgICAgICAgIGVyciA9IHJlcy5lcnIuZGVjb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0SW4oJ2luZGV4ZWQgbXNnc3RyIHJlcXVpcmVkIGZvciBwbHVyYWwnLCBlcnIpCgogICAgZGVmIHRlc3RfZ2VuZXJpY19zeW50YXhfZXJyb3Ioc2VsZik6CiAgICAgICAgd2l0aCB0ZW1wX2N3ZCgpOgogICAgICAgICAgICBQYXRoKCdpbnZhbGlkLnBvJykud3JpdGVfdGV4dCgnJydcCiJmb28iCicnJykKCiAgICAgICAgICAgIHJlcyA9IGFzc2VydF9weXRob25fZmFpbHVyZShtc2dmbXRfcHksICdpbnZhbGlkLnBvJykKICAgICAgICAgICAgZXJyID0gcmVzLmVyci5kZWNvZGUoJ3V0Zi04JykKICAgICAgICAgICAgc2VsZi5hc3NlcnRJbignU3ludGF4IGVycm9yJywgZXJyKQoKCmNsYXNzIFBPUGFyc2VyVGVzdCh1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiB0ZWFyRG93bkNsYXNzKGNscyk6CiAgICAgICAgIyBtc2dmbXQgdXNlcyBhIGdsb2JhbCB2YXJpYWJsZSB0byBzdG9yZSBtZXNzYWdlcywKICAgICAgICAjIGNsZWFyIGl0IGFmdGVyIHRoZSB0ZXN0cy4KICAgICAgICBtc2dmbXQuTUVTU0FHRVMuY2xlYXIoKQoKICAgIGRlZiB0ZXN0X3N0cmluZ3Moc2VsZik6CiAgICAgICAgIyBUZXN0IHRoYXQgdGhlIFBPIHBhcnNlciBjb3JyZWN0bHkgaGFuZGxlcyBhbmQgdW5lc2NhcGUKICAgICAgICAjIHN0cmluZ3MgaW4gdGhlIFBPIGZpbGUuCiAgICAgICAgIyBUaGUgUE8gZmlsZSBmb3JtYXQgYWxsb3dzIGZvciBhIHZhcmlldHkgb2YgZXNjYXBlIHNlcXVlbmNlcywKICAgICAgICAjIG9jdGFsIGFuZCBoZXggZXNjYXBlcy4KICAgICAgICB2YWxpZF9zdHJpbmdzID0gKAogICAgICAgICAgICAjIGVtcHR5IHN0cmluZ3MKICAgICAgICAgICAgKCciIicsICcnKSwKICAgICAgICAgICAgKCciIiAiIiAiIicsICcnKSwKICAgICAgICAgICAgIyBhbGxvd2VkIGVzY2FwZSBzZXF1ZW5jZXMKICAgICAgICAgICAgKHInIlxcIicsICdcXCcpLAogICAgICAgICAgICAociciXCIiJywgJyInKSwKICAgICAgICAgICAgKHInIlx0IicsICdcdCcpLAogICAgICAgICAgICAociciXG4iJywgJ1xuJyksCiAgICAgICAgICAgIChyJyJcciInLCAnXHInKSwKICAgICAgICAgICAgKHInIlxmIicsICdcZicpLAogICAgICAgICAgICAociciXGEiJywgJ1xhJyksCiAgICAgICAgICAgIChyJyJcYiInLCAnXGInKSwKICAgICAgICAgICAgKHInIlx2IicsICdcdicpLAogICAgICAgICAgICAjIG5vbi1lbXB0eSBzdHJpbmdzCiAgICAgICAgICAgICgnImZvbyInLCAnZm9vJyksCiAgICAgICAgICAgICgnImZvbyIgImJhciInLCAnZm9vYmFyJyksCiAgICAgICAgICAgICgnImZvbyIiYmFyIlR5cGUgZG9lcyBub3QgcmVxdWlyZSBHREFMIGFuZCBtYWtlcyBpdCBlYXN5IHRvIGNvbnZlcnQKICAgICAgICAgICAgIyBmcm9tIE9HQyBnZW9tIHR5cGUgbmFtZSB0byBEamFuZ28gZmllbGQuCiAgICAgICAgICAgIG9ncl90eXBlID0gcm93WzJdCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uob2dyX3R5cGUsIGludCkgYW5kIG9ncl90eXBlID4gMTAwMDoKICAgICAgICAgICAgICAgICMgU3BhdGlhTGl0ZSB1c2VzIFNGU1FMIDEuMiBvZmZzZXRzIDEwMDAgKFopLCAyMDAwIChNKSwgYW5kCiAgICAgICAgICAgICAgICAjIDMwMDAgKFpNKSB0byBpbmRpY2F0ZSB0aGUgcHJlc2VuY2Ugb2YgaGlnaGVyIGRpbWVuc2lvbmFsCiAgICAgICAgICAgICAgICAjIGNvb3JkaW5hdGVzIChNIG5vdCB5ZXQgc3VwcG9ydGVkIGJ5IERqYW5nbykuCiAgICAgICAgICAgICAgICBvZ3JfdHlwZSA9IG9ncl90eXBlICUgMTAwMCArIE9HUkdlb21UeXBlLndrYjI1Yml0CiAgICAgICAgICAgIGZpZWxkX3R5cGUgPSBPR1JHZW9tVHlwZShvZ3JfdHlwZSkuZGphbmdvCgogICAgICAgICAgICAjIEdldHRpbmcgYW55IEdlb21ldHJ5RmllbGQga2V5d29yZCBhcmd1bWVudHMgdGhhdCBhcmUgbm90IHRoZQogICAgICAgICAgICAjIGRlZmF1bHQuCiAgICAgICAgICAgIGRpbSA9IHJvd1swXQogICAgICAgICAgICBzcmlkID0gcm93WzFdCiAgICAgICAgICAgIGZpZWxkX3BhcmFtcyA9IHt9CiAgICAgICAgICAgIGlmIHNyaWQgIT0gNDMyNjoKICAgICAgICAgICAgICAgIGZpZWxkX3BhcmFtc1sic3JpZCJdID0gc3JpZAogICAgICAgICAgICBpZiAoaXNpbnN0YW5jZShkaW0sIHN0cikgYW5kICJaIiBpbiBkaW0pIG9yIGRpbSA9PSAzOgogICAgICAgICAgICAgICAgZmllbGRfcGFyYW1zWyJkaW0iXSA9IDMKICAgICAgICByZXR1cm4gZmllbGRfdHlwZSwgZmllbGRfcGFyYW1zCgogICAgZGVmIGdldF9jb25zdHJhaW50cyhzZWxmLCBjdXJzb3IsIHRhYmxlX25hbWUpOgogICAgICAgIGNvbnN0cmFpbnRzID0gc3VwZXIoKS5nZXRfY29uc3RyYWludHMoY3Vyc29yLCB0YWJsZV9uYW1lKQogICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAiU0VMRUNUIGZfZ2VvbWV0cnlfY29sdW1uICIKICAgICAgICAgICAgIkZST00gZ2VvbWV0cnlfY29sdW1ucyAiCiAgICAgICAgICAgICJXSEVSRSBmX3RhYmxlX25hbWU9JXMgQU5EIHNwYXRpYWxfaW5kZXhfZW5hYmxlZD0xIiwKICAgICAgICAgICAgKHRhYmxlX25hbWUsKSwKICAgICAgICApCiAgICAgICAgZm9yIHJvdyBpbiBjdXJzb3IuZmV0Y2hhbGwoKToKICAgICAgICAgICAgY29uc3RyYWludHNbIiVzX19zcGF0aWFsX19pbmRleCIgJSByb3dbMF1dID0gewogICAgICAgICAgICAgICAgImNvbHVtbnMiOiBbcm93WzBdXSwKICAgICAgICAgICAgICAgICJwcmltYXJ5X2tleSI6IEZhbHNlLAogICAgICAgICAgICAgICAgInVuaXF1ZSI6IEZhbHNlLAogICAgICAgICAgICAgICAgImZvcmVpZ25fa2V5IjogTiMgcG9zc2liaWxpdHkgb2YgdGFraW5nIHRoZSBsb2cgb2YgemVyby4KCiAgICAgICAgcmV0dXJuIC1fbG9nKDEuMCAtIHNlbGYucmFuZG9tKCkpIC8gbGFtYmQKCiAgICBkZWYgdm9ubWlzZXN2YXJpYXRlKHNlbGYsIG11LCBrYXBwYSk6CiAgICAgICAgIiIiQ2lyY3VsYXIgZGF0YSBkaXN0cmlidXRpb24uCgogICAgICAgIG11IGlzIHRoZSBtZWFuIGFuZ2xlLCBleHByZXNzZWQgaW4gcmFkaWFucyBiZXR3ZWVuIDAgYW5kIDIqcGksIGFuZAogICAgICAgIGthcHBhIGlzIHRoZSBjb25jZW50cmF0aW9uIHBhcmFtZXRlciwgd2hpY2ggbXVzdCBiZSBncmVhdGVyIHRoYW4gb3IKICAgICAgICBlcXVhbCB0byB6ZXJvLiAgSWYga2FwcGEgaXMgZXF1YWwgdG8gemVybywgdGhpcyBkaXN0cmlidXRpb24gcmVkdWNlcwogICAgICAgIHRvIGEgdW5pZm9ybSByYW5kb20gYW5nbGUgb3ZlciB0aGUgcmFuZ2UgMCB0byAyKnBpLgoKICAgICAgICAiIiIKICAgICAgICAjIEJhc2VkIHVwb24gYW4gYWxnb3JpdGhtIHB1Ymxpc2hlZCBpbjogRmlzaGVyLCBOLkkuLAogICAgICAgICMgIlN0YXRpc3RpY2FsIEFuYWx5c2lzIG9mIENpcmN1bGFyIERhdGEiLCBDYW1icmlkZ2UKICAgICAgICAjIFVuaXZlcnNpdHkgUHJlc3MsIDE5OTMuCgogICAgICAgICMgVGhhbmtzIHRvIE1hZ251cyBLZXNzbGVyIGZvciBhIGNvcnJlY3Rpb24gdG8gdGhlCiAgICAgICAgIyBpbXBsZW1lbnRhdGlvbiBvZiBzdGVwIDQuCgogICAgICAgIHJhbmRvbSA9IHNlbGYucmFuZG9tCiAgICAgICAgaWYga2FwcGEgPD0gMWUtNjoKICAgICAgICAgICAgcmV0dXJuIFRXT1BJICogcmFuZG9tKCkKCiAgICAgICAgcyA9IDAuNSAvIGthcHBhCiAgICAgICAgciA9IHMgKyBfc3FydCgxLjAgKyBzICogcykKCiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgdTEgPSByYW5kb20oKQogICAgICAgICAgICB6ID0gX2NvcyhfcGkgKiB1MSkKCiAgICAgICAgICAgIGQgPSB6IC8gKHIgKyB6KQogICAgICAgICAgICB1MiA9IHJhbmRvbSgpCiAgICAgICAgICAgIGlmIHUyIDwgMS4wIC0gZCAqIGQgb3IgdTIgPD0gKDEuMCAtIGQpICogX2V4cChkKToKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgIHEgPSAxLjAgLyByCiAgICAgICAgZiA9IChxICsgeikgLyAoMS4wICsgcSAqIHopCiAgICAgICAgdTMgPSByYW5kb20oKQogICAgICAgIGlmIHUzID4gMC41OgogICAgICAgICAgICB0aGV0YSA9IChtdSArIF9hY29zKGYpKSAlIFRXT1BJCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdGhldGEgPSAobXUgLSBfYWNvcyhmKSkgJSBUV09QSQoKICAgICAgICByZXR1cm4gdGhldGEKCiAgICBkZWYgZ2FtbWF2YXJpYXRlKHNlbGYsIGFscGhhLCBiZXRhKToKICAgICAgICAiIiJHYW1tYSBkaXN0cmlidXRpb24uICBOb3QgdGhlIGdhbW1hIGZ1bmN0aW9uIQoKICAgICAgICBDb25kaXRpb25zIG9uIHRoZSBwYXJhbWV0ZXJzIGFyZSBhbHBoYSA+IDAgYW5kIGJldGEgPiAwLgoKIC0xLCAxNikKICAgICAgICBzZWxmLmFkZENsZWFudXAobW0uY2xvc2UpCiAgICAgICAgbW0ud3JpdGUoYidweXRob24nKQogICAgICAgIHJlc3VsdCA9IG1tLmZsdXNoKCkKICAgICAgICBzZWxmLmFzc2VydElzTm9uZShyZXN1bHQpCiAgICAgICAgaWYgKHN5cy5wbGF0Zm9ybS5zdGFydHN3aXRoKCgnbGludXgnLCAnYW5kcm9pZCcpKQogICAgICAgICAgICBhbmQgbm90IGluX3N5c3RlbWRfbnNwYXduX3N5bmNfc3VwcHJlc3NlZCgpKToKICAgICAgICAgICAgIyAnb2Zmc2V0JyBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgbW1hcC5QQUdFU0laRSBvbiBMaW51eC4KICAgICAgICAgICAgIyBTZWUgYnBvLTM0NzU0IGZvciBkZXRhaWxzLgogICAgICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhPU0Vycm9yLCBtbS5mbHVzaCwgMSwgbGVuKGIncHl0aG9uJykpCgogICAgZGVmIHRlc3RfcmVwcihzZWxmKToKICAgICAgICBvcGVuX21tYXBfcmVwcl9wYXQgPSByZS5jb21waWxlKAogICAgICAgICAgICByIjxtbWFwLm1tYXAgY2xvc2VkPUZhbHNlLCAiCiAgICAgICAgICAgIHIiYWNjZXNzPSg/UDxhY2Nlc3M+XFMrKSwgIgogICAgICAgICAgICByImxlbmd0aD0oP1A8bGVuZ3RoPlxkKyksICIKICAgICAgICAgICAgciJwb3M9KD9QPHBvcz5cZCspLCAiCiAgICAgICAgICAgIHIib2Zmc2V0PSg/UDxvZmZzZXQ+XGQrKT4iKQogICAgICAgIGNsb3NlZF9tbWFwX3JlcHJfcGF0ID0gcmUuY29tcGlsZShyIjxtbWFwLm1tYXAgY2xvc2VkPVRydWU+IikKICAgICAgICBtYXBzaXplcyA9ICg1MCwgMTAwLCAxXzAwMCwgMV8wMDBfMDAwLCAxMF8wMDBfMDAwKQogICAgICAgIG9mZnNldHMgPSB0dXBsZSgobWFwc2l6ZSAvLyAyIC8vIG1tYXAuQUxMT0NBVElPTkdSQU5VTEFSSVRZKQogICAgICAgICAgICAgICAgICAgICAgICAqIG1tYXAuQUxMT0NBVElPTkdSQU5VTEFSSVRZIGZvciBtYXBzaXplIGluIG1hcHNpemVzKQogICAgICAgIGZvciBvZmZzZXQsIG1hcHNpemUgaW4gemlwKG9mZnNldHMsIG1hcHNpemVzKToKICAgICAgICAgICAgZGF0YSA9IGInYScgKiBtYXBzaXplCiAgICAgICAgICAgIGxlbmd0aCA9IG1hcHNpemUgLSBvZmZzZXQKICAgICAgICAgICAgYWNjZXNzZXMgPSAoJ0FDQ0VTU19ERUZBVUxUJywgJ0FDQ0VTU19SRUFEJywKICAgICAgICAgICAgICAgICAgICAgICAgJ0FDQ0VTU19DT1BZJywgJ0FDQ0VTU19XUklURScpCiAgICAgICAgICAgIHBvc2l0aW9ucyA9ICgwLCBsZW5ndGgvLzEwLCBsZW5ndGgvLzUsIGxlbmd0aC8vNCkKICAgICAgICAgICAgd2l0aCBvcGVuKFRFU1RGTiwgIndiKyIpIGFzIGZwOgogICAgICAgICAgICAgICAgZnAud3JpdGUoZGF0YSkKICAgICAgICAgICAgICAgIGZwLmZsdXNoKCkKICAgICAgICAgICAgICAgIGZvciBhY2Nlc3MsIHBvcyBpbiBpdGVydG9vbHMucHJvZHVjdChhY2Nlc3NlcywgcG9zaXRpb25zKToKICAgICAgICAgICAgICAgICAgICBhY2NpbnQgPSBnZXRhdHRyKG1tYXAsIGFjY2VzcykKIGVwYXRoX3RvX3VyaShQYXRoKCJ1cGxvYWRcXHRlc3QucG5nIikpLCAidXBsb2FkL3Rlc3QucG5nIikKCiAgICBkZWYgdGVzdF9pcmlfdG9fdXJpKHNlbGYpOgogICAgICAgIGNhc2VzID0gWwogICAgICAgICAgICAjIFZhbGlkIFVURi04IHNlcXVlbmNlcyBhcmUgZW5jb2RlZC4KICAgICAgICAgICAgKCJyZWQlMDlyb3PDqSNyZWQiLCAicmVkJTA5cm9zJUMzJUE5I3JlZCIpLAogICAgICAgICAgICAoIi9ibG9nL2Zvci9Kw7xyZ2VuIE3DvG5zdGVyLyIsICIvYmxvZy9mb3IvSiVDMyVCQ3JnZW4lMjBNJUMzJUJDbnN0ZXIvIiksCiAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICJsb2NhdGlvbnMvJXMiICUgcXVvdGVfcGx1cygiUGFyaXMgJiBPcmzDqWFucyIpLAogICAgICAgICAgICAgICAgImxvY2F0aW9ucy9QYXJpcyslMjYrT3JsJUMzJUE5YW5zIiwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgIyBSZXNlcnZlZCBjaGFycyByZW1haW4gdW5lc2NhcGVkLgogICAgICAgICAgICAoIiUmIiwgIiUmIiksCiAgICAgICAgICAgICgicmVkJuKZpXJvcyUjcmVkIiwgInJlZCYlRTIlOTklQTVyb3MlI3JlZCIpLAogICAgICAgICAgICAoZ2V0dGV4dF9sYXp5KCJyZWQm4pmlcm9zJSNyZWQiKSwgInJlZCYlRTIlOTklQTVyb3MlI3JlZCIpLAogICAgICAgIF0KCiAgICAgICAgZm9yIGlyaSwgdXJpIGluIGNhc2VzOgogICAgICAgICAgICB3aXRoIHNlbGYuc3ViVGVzdChpcmkpOgogICAgICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChpcmlfdG9fdXJpKGlyaSksIHVyaSkKCiAgICAgICAgICAgICAgICAjIFRlc3QgaWRlbXBvdGVuY3kuCiAgICAgICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGlyaV90b191cmkoaXJpX3RvX3VyaShpcmkpKSwgdXJpKQoKICAgIGRlZiB0ZXN0X3VyaV90b19pcmkoc2VsZik6CiAgICAgICAgY2FzZXMgPSBbCiAgICAgICAgICAgIChOb25lLCBOb25lKSwKICAgICAgICAgICAgIyBWYWxpZCBVVEYtOCBzZXF1ZW5jZXMgYXJlIGRlY29kZWQuCiAgICAgICAgICAgICgiLyVlMiU4OSVBYiVFMiU5OSVhNSVFMiU4OSVhQi8iLCAiL+KJq+KZpeKJqy8iKSwKICAgICAgICAgICAgKCIvJUUyJTk5JUE1JUUyJTk5JUE1Lz91dGY4PSVFMiU5QyU5MyIsICIv4pml4pmlLz91dGY4PeKckyIpLAogICAgICAgICAgICAoIi8lNDElNWElNkIvIiwgIi9BWmsvIiksCiAgICAgICAgICAgICMgUmVzZXJ2ZWQgYW5kIG5vbi1VUkwgdmFsaWQgQVNDSUkgY2hhcnMgYXJlIG5vdCBkZWNvZGVkLgogICAgICAgICAgICAoIi8lMjUlMjAlMDIlNDElN2IvIiwgIi8lMjUlMjAlMDJBJTdiLyIpLAogICAgICAgICAgICAjIEJyb2tlbiBVVEYtOCBzZXF1ZW5jZXMgcmVtYWluIGVzY2FwZWQuCiAgICAgICAgICAgICgiLyVBQWQlQUFqJUFBYSVBQW4lQUFnJUFBbyVBQS8iLCAiLyVBQWQlQUFqJUFBYSVBQW4lQUFnJUFBbyVBQS8iKSwKICAgICAgICAgICAgKCIvJUUyJTk5JUE1JUUyJUUyJTk5JUE1LyIsICIv4pmlJUUy4pmlL3VhbChzcnZfcHJvdG8uZGF0YSwgc2VsZi5EQVRBKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoc2VsZi5maWxlLnRlbGwoKSwgbGVuKHNlbGYuREFUQSkpCgogICAgIyBPbiBTb2xhcmlzLCBsb3dlcmluZyBTT19SQ1ZCVUYgb24gYSBUQ1AgY29ubmVjdGlvbiBhZnRlciBpdCBoYXMgYmVlbgogICAgIyBlc3RhYmxpc2hlZCBoYXMgbm8gZWZmZWN0LiBEdWUgdG8gaXRzIGFnZSwgdGhpcyBidWcgYWZmZWN0cyBib3RoIE9yYWNsZQogICAgIyBTb2xhcmlzIGFzIHdlbGwgYXMgYWxsIG90aGVyIE9wZW5Tb2xhcmlzIGZvcmtzICh1bmxlc3MgdGhleSBmaXhlZCBpdAogICAgIyB0aGVtc2VsdmVzKS4KICAgIEB1bml0dGVzdC5za2lwSWYoc3lzLnBsYXRmb3JtLnN0YXJ0c3dpdGgoJ3N1bm9zJyksCiAgICAgICAgICAgICAgICAgICAgICJEb2Vzbid0IHdvcmsgb24gU29sYXJpcyIpCiAgICBkZWYgdGVzdF9zZW5kZmlsZV9jbG9zZV9wZWVyX2luX3RoZV9taWRkbGVfb2ZfcmVjZWl2aW5nKHNlbGYpOgogICAgICAgIHNydl9wcm90bywgY2xpX3Byb3RvID0gc2VsZi5wcmVwYXJlX3NlbmRmaWxlKGNsb3NlX2FmdGVyPTEwMjQpCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFJhaXNlcyhDb25uZWN0aW9uRXJyb3IpOgogICAgICAgICAgICBzZWxmLnJ1bl9sb29wKAogICAgICAgICAgICAgICAgc2VsZi5sb29wLnNlbmRmaWxlKGNsaV9wcm90by50cmFuc3BvcnQsIHNlbGYuZmlsZSkpCiAgICAgICAgc2VsZi5ydW5fbG9vcChzcnZfcHJvdG8uZG9uZSkKCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKDEwMjQgPD0gc3J2X3Byb3RvLm5ieXRlcyA8IGxlbihzZWxmLkRBVEEpLAogICAgICAgICAgICAgICAgICAgICAgICBzcnZfcHJvdG8ubmJ5dGVzKQogICAgICAgIGlmIG5vdCAoc3lzLnBsYXRmb3JtID09ICd3aW4zMicKICAgICAgICAgICAgICAgIGFuZCBpc2luc3RhbmNlKHNlbGYubG9vcCwgYXN5bmNpby5Qcm9hY3RvckV2ZW50TG9vcCkpOgogICAgICAgICAgICAjIE9uIFdpbmRvd3MsIFByb2FjdG9yIHVzZXMgdHJhbnNtaXRGaWxlLCB3aGljaCBkb2VzIG5vdCB1cGRhdGUgdGVsbCgpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZSgxMDI0IDw9IHNlbGYuZmlsZS50ZWxsKCkgPCBsZW4oc2VsZi5EQVRBKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmlsZS50ZWxsKCkpCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKGNsaV9wcm90by50cmFuc3BvcnQuaXNfY2xvc2luZygpKQoKICAgIGRlZiB0ZXN0X3NlbmRmaWxlX2ZhbGxiYWNrX2Nsb3NlX3BlZXJfaW5fdGhlX21pZGRsZV9vZl9yZWNlaXZpbmcoc2VsZik6CgogICAgICAgIGRlZiBzZW5kZmlsZV9uYXRpdmUodHJhbnNwLCBmaWxlLCBvZmZzZXQsIGNvdW50KToKICAgICAgICAgICAgIyB0byByYWlzZSBTZW5kZmlsZU5vdEF2YWlsYWJsZUVycm9yCiAgICAgICAgICAgIHJldHVybiBiYXNlX2V2ZW50cy5CYXNlRXZlbnRMb29wLl9zZW5kZmlsZV9uYXRpdmUoCiAgbm5vdCBkbyB0aGlzIGZvciBjKyswMyB1bmxpbWl0ZWQgQVBJLCBzaW5jZSBzZXZlcmFsIGhlYWRlcnMgaW4KICAgICAgICAjIEluY2x1ZGUvY3B5dGhvbi8gdXNlIGNvbW1hcyBhdCBlbmQgb2YgYGVudW1gIGRlY2xhcmF0aW9ucywgYSBDKysxMQogICAgICAgICMgZmVhdHVyZSBmb3Igd2hpY2ggR0NDIGhhcyBubyBuYXJyb3dlciBvcHRpb24gdGhhbiAtV3BlZGFudGljIGl0c2VsZi4KICAgICAgICAnLXBlZGFudGljLWVycm9ycycsCgogICAgICAgICMgV2UgYWxzbyB1c2UgYGxvbmcgbG9uZ2AsIGEgQysrMTEgZmVhdHVyZSB3ZSBjYW4gZW5hYmxlIGluZGl2aWR1YWxseS4KICAgICAgICAnLVduby1sb25nLWxvbmcnLAogICAgXQplbHNlOgogICAgIyBNU1ZDIGNvbXBpbGVyIGZsYWdzCiAgICBDUFBGTEFHUyA9IFsKICAgICAgICAjIERpc3BsYXkgd2FybmluZ3MgbGV2ZWwgMSB0byA0CiAgICAgICAgJy9XNCcsCiAgICAgICAgIyBUcmVhdCBhbGwgY29tcGlsZXIgd2FybmluZ3MgYXMgY29tcGlsZXIgZXJyb3JzCiAgICAgICAgJy9XWCcsCiAgICBdCiAgICBDUFBGTEFHU19QRURBTlRJQyA9IFtdCgoKZGVmIG1haW4oKToKICAgIGNwcGZsYWdzID0gbGlzdChDUFBGTEFHUykKICAgIHN0ZCA9IG9zLmVudmlyb24uZ2V0KCJDUFlUSE9OX1RFU1RfQ1BQX1NURCIsICIiKQogICAgbW9kdWxlX25hbWUgPSBvcy5lbnZpcm9uWyJDUFlUSE9OX1RFU1RfRVhUX05BTUUiXQogICAgbGltaXRlZCA9IGJvb2wob3MuZW52aXJvbi5nZXQoIkNQWVRIT05fVEVTVF9MSU1JVEVEIiwgIiIpKQogICAgaW50ZXJuYWwgPSBib29sKGludChvcy5lbnZpcm9uLmdldCgiVEVTVF9JTlRFUk5BTF9DX0FQSSIsICIwIikpKQoKICAgIGNwcGZsYWdzID0gbGlzdChDUFBGTEFHUykKICAgIGNwcGZsYWdzLmFwcGVuZChmJy1ETU9EVUxFX05BTUU9e21vZHVsZV9uYW1lfScpCgogICAgIyBBZGQgLXN0ZD1TVEQgb3IgL3N0ZDpTVEQgKE1TVkMpIGNvbXBpbGVyIGZsYWcKICAgIGlmIHN0ZDoKICAgICAgICBpZiBzdXBwb3J0Lk1TX1dJTkRPV1M6CiAgICAgICAgICAgIGNwcGZsYWdzLmFwcGVuZChmJy9zdGQ6e3N0ZH0nKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNwcGZsYWdzLmFwcGVuZChmJy1zdGQ9e3N0ZH0nKQoKICAgICAgICBpZiBsaW1pdGVkIG9yIChzdGQgIT0gJ2MrKzAzJyk6CiAgICAgICAgICAgICMgU2VlIENQUEZMQUdTX1BFREFOVElDIGRvY3N0cmluZwogICAgICAgICAgICBjcHBmbGFncy5leHRlbmQoQ1BQRkxBR1NfUEVEQU5USUMpCgogICAgIyBnaC0xMDU3NzY6IFdoZW4gImdjYyAtc3RkPTExIiBpcyB1c2VkIGFzIHRoZSBDKysgY29tcGlsZXIsIC1zdGQ9YzExCiAgICAjIG9wdGlvbiBlbWl0cyBhIEMrKyBjb21waWxlciB3YXJuaW5nLiBSZW1vdmUgIi1zdGQxMSIgb3B0aW9uIGZyb20gdGhlCiAgICAjIENDIGNvbW1hbmQuCiAgICBjbWQgPSAoc3lzY29uZmlnLmdldF9jb25maWdfdmFyKCdDQycpIG9yICcnKQogICAgaWYgY21kIGlzdXN0b20uZ2V0X21vZGVsX2FkbWluKENpdHkpCiAgICAgICAgZm9ybSA9IGdlb2FkbWluLmdldF9jaGFuZ2VsaXN0X2Zvcm0oTm9uZSkoKQogICAgICAgIHdpZGdldCA9IGZvcm1bInBvaW50Il0uZmllbGQud2lkZ2V0CiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCh3aWRnZXQuYXR0cnNbImRlZmF1bHRfbGF0Il0sIDU1KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwod2lkZ2V0LmF0dHJzWyJkZWZhdWx0X2xvbiJdLCAzNykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHdpZGdldC5hdHRyc1siZGVmYXVsdF96b29tIl0sIDEyKQppbXBvcnQgbG9nZ2luZwppbXBvcnQgY29sbGVjdGlvbnMKCmZyb20gLmNhc2UgaW1wb3J0IF9CYXNlVGVzdENhc2VDb250ZXh0CgoKX0xvZ2dpbmdXYXRjaGVyID0gY29sbGVjdGlvbnMubmFtZWR0dXBsZSgiX0xvZ2dpbmdXYXRjaGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbInJlY29yZHMiLCAib3V0cHV0Il0pCgpjbGFzcyBfQ2FwdHVyaW5nSGFuZGxlcihsb2dnaW5nLkhhbmRsZXIpOgogICAgIiIiCiAgICBBIGxvZ2dpbmcgaGFuZGxlciBjYXB0dXJpbmcgYWxsIChyYXcgYW5kIGZvcm1hdHRlZCkgbG9nZ2luZyBvdXRwdXQuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgbG9nZ2luZy5IYW5kbGVyLl9faW5pdF9fKHNlbGYpCiAgICAgICAgc2VsZi53YXRjaGVyID0gX0xvZ2dpbmdXYXRjaGVyKFtdLCBbXSkKCiAgICBkZWYgZmx1c2goc2VsZik6CiAgICAgICAgcGFzcwoKICAgIGRlZiBlbWl0KHNlbGYsIHJlY29yZCk6CiAgICAgICAgc2VsZi53YXRjaGVyLnJlY29yZHMuYXBwZW5kKHJlY29yZCkKICAgICAgICBtc2cgPSBzZWxmLmZvcm1hdChyZWNvcmQpCiAgICAgICAgc2VsZi53YXRjaGVyLm91dHB1dC5hcHBlbmQobXNnKQoKCmNsYXNzIF9Bc3NlcnRMb2dzQ29udGV4dChfQmFzZVRlc3RDYXNlQ29udGV4dCk6CiAgICAiIiJBIGNvbnRleHQgbWFuYWdlciBmb3IgYXNzZXJ0TG9ncygpIGFuZCBhc3NlcnROb0xvZ3MoKSAiIiIKCiAgICBMT0dHSU5HX0ZPUk1BVCA9ICIlKGxldmVsbmFtZSlzOiUobmFtZSlzOiUobWVzc2FnZSlzIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB0ZXN0X2Nhc2UsIGxvZ2dlcl9uYW1lLCBsZXZlbCwgbm9fbG9ncywgZm9ybWF0dGVyPU5vbmUpOgogICAgICAgIF9CYXNlVGVzdENhc2VDb250ZXh0Ll9faW5pdF9fKHNlbGYsIHRlc3RfY2FzZSkKICAgICAgICBzZWxmLmxvZ2dlcl9uYW1lID0gbG9nZ2VyX25hbWUKICAgICAgICBpZiBsZXZlbDoKICAgICAgICAgICAgc2VsZi5sZXZlbCA9IGxvZ2dpbmcuX25hbWVUb0xldmVsLmdldChsZXZlbCwgbGV2ZWwpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5sZXZlbCA9IGxvZ2dpbmcuSU5GTwogICAgICAgIHNlbGYubXNnID0gTm9uZQogICAgICAgIHNlbGYubm9fbG9ncyA9IG5vX2xvZ3MKICAgICAgICBzZWxmLmZvcm1hdHRlciA9IGZvd2lzZSB1bmNhdWdodCBleGNlcHRpb25zICh0aG9zZSB0aGF0IHdpbGwKICAgIGdlbmVyYXRlIEhUVFAgNTAwIHJlc3BvbnNlcykuCiAgICAiIiIKICAgIGlmIHNldHRpbmdzLkRFQlVHX1BST1BBR0FURV9FWENFUFRJT05TOgogICAgICAgIHJhaXNlCgogICAgaWYgc2V0dGluZ3MuREVCVUc6CiAgICAgICAgcmV0dXJuIGRlYnVnLnRlY2huaWNhbF81MDBfcmVzcG9uc2UocmVxdWVzdCwgKmV4Y19pbmZvKQoKICAgICMgUmV0dXJuIGFuIEh0dHBSZXNwb25zZSB0aGF0IGRpc3BsYXlzIGEgZnJpZW5kbHkgZXJyb3IgbWVzc2FnZS4KICAgIGNhbGxiYWNrID0gcmVzb2x2ZXIucmVzb2x2ZV9lcnJvcl9oYW5kbGVyKDUwMCkKICAgIHJldHVybiBjYWxsYmFjayhyZXF1ZXN0KQoiIiJKU09OIHRva2VuIHNjYW5uZXIKIiIiCmltcG9ydCByZQp0cnk6CiAgICBmcm9tIF9qc29uIGltcG9ydCBtYWtlX3NjYW5uZXIgYXMgY19tYWtlX3NjYW5uZXIKZXhjZXB0IEltcG9ydEVycm9yOgogICAgY19tYWtlX3NjYW5uZXIgPSBOb25lCgpfX2FsbF9fID0gWydtYWtlX3NjYW5uZXInXQoKTlVNQkVSX1JFID0gcmUuY29tcGlsZSgKICAgIHInKC0/KD86MHxbMS05XVswLTldKikpKFwuWzAtOV0rKT8oW2VFXVstK10/WzAtOV0rKT8nLAogICAgKHJlLlZFUkJPU0UgfCByZS5NVUxUSUxJTkUgfCByZS5ET1RBTEwpKQoKZGVmIHB5X21ha2Vfc2Nhbm5lcihjb250ZXh0KToKICAgIHBhcnNlX29iamVjdCA9IGNvbnRleHQucGFyc2Vfb2JqZWN0CiAgICBwYXJzZV9hcnJheSA9IGNvbnRleHQucGFyc2VfYXJyYXkKICAgIHBhcnNlX3N0cmluZyA9IGNvbnRleHQucGFyc2Vfc3RyaW5nCiAgICBtYXRjaF9udW1iZXIgPSBOVU1CRVJfUkUubWF0Y2gKICAgIHN0cmljdCA9IGNvbnRleHQuc3RyaWN0CiAgICBwYXJzZV9mbG9hdCA9IGNvbnRleHQucGFyc2VfZmxvYXQKICAgIHBhcnNlX2ludCA9IGNvbnRleHQucGFyc2VfaW50CiAgICBwYXJzZV9jb25zdGFudCA9IGNvbnRleHQucGFyc2VfY29uc3RhbnQKICAgIG9iamVjdF9ob29rID0gY29udGV4dC5vYmplY3RfaG9vawogICAgb2JqZWN0X3BhaXJzX2hvb2sgPSBjb250ZXh0Lm9iamVjdF9wYWlyc19ob29rCiAgICBtZW1vID0gY29udGV4dC5tZW1vCgogICAgZGVmIF9zY2FuX29uY2Uoc3RyaW5nLCBpZHgpOgogICAgICAgIHRyeToKICAgICAgICAgICAgbmV4dGNoYXIgPSBzdHJpbmdbaWR4XQogICAgICAgIGV4Y2VwdCBJbmRleEVycm9yOgogICAgICAgICAgICByYWlzZSBTdG9wSXRlcmF0aW9uKGlkeCkgZnJvbSBOb25lCgogICAgICAgIGlmIG5leHRjaGFyID09ICciJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlX3N0cmluZyhzdHJpbmcsIGlkeCArIDEsIHN0cmljdCkKICAgICAgICBlbGlmIG5leHRjaGFyID09ICd7JzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlX29iamVjdCgoc3RyaW5nLCBpZHggKyAxKSwgc3RyaWN0LAogICAgICAgICAgICAgICAgX3NjYW5fb25jZSwgb2JqZWN0X2hvb2ssIG9ianRlIGEgQyBmaWxlIHdpdGggYSBHTlUgSW5kaXJlY3QgRnVuY3Rpb24gKEZPT19DKQogICAgICAgICAgICAjIGFuZCBjb21waWxlIGl0IGludG8gYSBzaGFyZWQgbGlicmFyeS4KICAgICAgICAgICAgc3JjbmFtZSA9IG9zLnBhdGguam9pbihkLCAnZm9vLmMnKQogICAgICAgICAgICBkc3RuYW1lID0gb3MucGF0aC5qb2luKGQsICdsaWJmb28uc28nKQogICAgICAgICAgICB3aXRoIG9wZW4oc3JjbmFtZSwgJ3cnKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZShGT09fQy5yZXBsYWNlKCckREVTQ1JJUFRPUicsIHN0cihwaXBlX3cpKSkKICAgICAgICAgICAgYXJncyA9IFsnZ2NjJywgJy1mUElDJywgJy1zaGFyZWQnLCAnLW8nLCBkc3RuYW1lLCBzcmNuYW1lXQogICAgICAgICAgICBwID0gc3VicHJvY2Vzcy5ydW4oYXJncywgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSkKCiAgICAgICAgICAgIGlmIHAucmV0dXJuY29kZSAhPSAwOgogICAgICAgICAgICAgICAgIyBJRlVOQyBpcyBub3Qgc3VwcG9ydGVkIG9uIGFsbCBhcmNoaXRlY3R1cmVzLgogICAgICAgICAgICAgICAgaWYgcGxhdGZvcm0ubWFjaGluZSgpID09ICd4ODZfNjQnOgogICAgICAgICAgICAgICAgICAgICMgSXQgc2hvdWxkIGJlIHN1cHBvcnRlZCBoZXJlLiBTb21ldGhpbmcgZWxzZSB3ZW50IHdyb25nLgogICAgICAgICAgICAgICAgICAgIHAuY2hlY2tfcmV0dXJuY29kZSgpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgSUZVTkMgbWlnaHQgbm90IGJlIHN1cHBvcnRlZCBvbiB0aGlzIG1hY2hpbmUuCiAgICAgICAgICAgICAgICAgICAgc2VsZi5za2lwVGVzdChmImNvdWxkIG5vdCBjb21waWxlIGluZGlyZWN0IGZ1bmN0aW9uOiB7cH0iKQoKICAgICAgICAgICAgIyBDYXNlICMxOiBUZXN0ICdQeUNGdW5jUHRyX0Zyb21EbGwnIGZyb20gTW9kdWxlcy9fY3R5cGVzL19jdHlwZXMuYwogICAgICAgICAgICBMID0gQ0RMTChkc3RuYW1lKQogICAgICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzUmVnZXgoQXR0cmlidXRlRXJyb3IsICJmdW5jdGlvbiAnZm9vJyBub3QgZm91bmQiKToKICAgICAgICAgICAgICAgICMgVHJ5IGFjY2Vzc2luZyB0aGUgJ2Zvbycgc3ltYm9sLgogICAgICAgICAgICAgICAgIyBJdCBzaG91bGQgcmVzb2x2ZSB2aWEgZGxzeW0oKSB0byBOVUxMLAogICAgICAgICAgICAgICAgIyBhbmQgc2luY2Ugd2Ugc3ViamVjdGl2ZWx5IHRyZWF0IE5VTEwKICAgICAgICAgICAgICAgICMgYWRkcmVzc2VzIGFzIGVycm9ycywgd2Ugc2hvdWxkIGdldAogICAgICAgICAgICAgICAgIyBhbiBlcnJvci4KICAgICAgICAgICAgICAgIEwuZm9vCgogICAgICAgICAgICAjIEFzc2VydCB0aGF0IHRoZSBJRlVOQyB3YXMgY2FsbGVkCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwob3MucmVhZChwaXBlX3IsIDIpLCBiJ09LJykKCiAgICAgICAgICAgICMgQ2FzZSAjMjogVGVzdCAnQ0RhdGFUeXBlX2luX2RsbF9pbXBsJyBmcm1lcywgcmVscm9vdD1yZWxyb290KQogICAgaXRlbXMsIHBlZWtlZCA9IGl0ZXJ1dGlsLnBlZWtfYW5kX2l0ZXIoaXRlbXMpCiAgICBpZiBub3QgaXRlbXM6CiAgICAgICAgcmFpc2Ugb25lbXB0eQogICAgaWYgaXNpbnN0YW5jZShwZWVrZWQsIHN0cik6CiAgICAgICAgaWYgcmVscm9vdCBhbmQgcmVscm9vdCBpcyBub3QgZnN1dGlsLlVTRV9DV0Q6CiAgICAgICAgICAgIHJlbHJvb3QgPSBvcy5wYXRoLmFic3BhdGgocmVscm9vdCkKICAgICAgICBjaGVjayA9IChsYW1iZGE6IFRydWUpCiAgICAgICAgZm9yIGZpbGVuYW1lLCBpc21hbnkgaW4gaXRlcnV0aWwuaXRlcl9tYW55KGl0ZW1zLCBvbmVtcHR5KToKICAgICAgICAgICAgcmVsZmlsZSA9IGZzdXRpbC5mb3JtYXRfZmlsZW5hbWUoZmlsZW5hbWUsIHJlbHJvb3QsIGZpeHJvb3Q9RmFsc2UpCiAgICAgICAgICAgIHlpZWxkIGZpbGVuYW1lLCByZWxmaWxlLCBjaGVjaywgaXNtYW55CiAgICBlbGlmIGxlbihwZWVrZWQpID09IDQ6CiAgICAgICAgeWllbGQgZnJvbSBpdGVtcwogICAgZWxzZToKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yCgoKZGVmIHRyYWNrX3Byb2dyZXNzX2NvbXBhY3QoaXRlbXMsICosIGdyb3Vwcz01LCAqKm1hcmtfa3dhcmdzKToKICAgIGxhc3QgPSBvcy5saW5lc2VwCiAgICBtYXJrcyA9IGl0ZXJfbWFya3MoZ3JvdXBzPWdyb3VwcywgKiptYXJrX2t3YXJncykKICAgIGZvciBpdGVtIGluIGl0ZW1zOgogICAgICAgIGxhc3QgPSBuZXh0KG1hcmtzKQogICAgICAgIHByaW50KGxhc3QsIGVuZD0nJywgZmx1c2g9VHJ1ZSkKICAgICAgICB5aWVsZCBpdGVtCiAgICBpZiBub3QgbGFzdC5lbmRzd2l0aChvcy5saW5lc2VwKToKICAgICAgICBwcmludCgpCgoKZGVmIHRyYWNrX3Byb2dyZXNzX2ZsYXQoaXRlbXMsIGZtdD0nPHt9PicpOgogICAgZm9yIGl0ZW0gaW4gaXRlbXM6CiAgICAgICAgcHJpbnQoZm10LmZvcm1hdChpdGVtKSwgZmx1c2g9VHJ1ZSkKICAgICAgICB5aWVsZCBpdGVtCgoKZGVmIGl0ZXJfbWFya3MobWFyaz0nLicsICosIGdyb3VwPTUsIGdyb3Vwcz0yLCBsaW5lcz1fTk9UX1NFVCwgc2VwPScgJyk6CiAgICBtYXJrID0gbWFyayBvciAnJwogICAgZ3JvdXAgPSBncm91cCBpZiBncm91cCBhbmQgZ3JvdXAgPiAxIGVsc2UgMQogICAgZ3JvdXBzID0gZ3JvdXBzIGlmIGdyb3VwcyBhbmQgZ3JvdXBzID4gMSBlbHNlIDEKCiAgICBzZXAgPSBmJ3ttYXJrfXtzZXB9JyBpZiBzZXAgZWxzZSBtYXJrCiAgICBlbmQgPSBmJ3ttYXJrfXtvcy5saW5lc2VwfScKICAgIGRpdiA9IG9zLmxpbmVzZXAKICAgIHBlcmxpbmUgPSBncm91cCAqIGdyb3VwcwogICAgaWYgbGluZXMgaXMgX05PVF9TRVQ6CiAgICAgICAgIyBCeSBkZWZhdWx0IHdlIHRyeSB0byBwdXQgYWJvdXQgMTAwIGluIGVhY2ggbGluZSBncm91cC4KICAgICAgICBwZXJsaW5lcyA9IDEwMCAvLyBwZXJsaW5lICogcGVybGluZQogICAgZWxpZiBub3QgbGluZXMgb3IgbGluZXMgPCAwOmFsIHN0dWZmCgpkZWYgZXNjYXBlKHMpOgogICAgcyA9IHMucmVwbGFjZSgiJiIsICImYW1wOyIpCiAgICBzID0gcy5yZXBsYWNlKCI8IiwgIiZsdDsiKQogICAgcmV0dXJuIHMucmVwbGFjZSgiPiIsICImZ3Q7IiwpCgojIHVzZWQgaW4gVXNlci1BZ2VudCBoZWFkZXIgc2VudApfX3ZlcnNpb25fXyA9ICclZC4lZCcgJSBzeXMudmVyc2lvbl9pbmZvWzoyXQoKIyB4bWxycGMgaW50ZWdlciBsaW1pdHMKTUFYSU5UID0gIDIqKjMxLTEKTUlOSU5UID0gLTIqKjMxCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgRXJyb3IgY29uc3RhbnRzIChmcm9tIERhbiBMaWJieSdzIHNwZWNpZmljYXRpb24gYXQKIyBodHRwOi8veG1scnBjLWVwaS5zb3VyY2Vmb3JnZS5uZXQvc3BlY3MvcmZjLmZhdWx0X2NvZGVzLnBocCkKCiMgUmFuZ2VzIG9mIGVycm9ycwpQQVJTRV9FUlJPUiAgICAgICA9IC0zMjcwMApTRVJWRVJfRVJST1IgICAgICA9IC0zMjYwMApBUFBMSUNBVElPTl9FUlJPUiA9IC0zMjUwMApTWVNURU1fRVJST1IgICAgICA9IC0zMjQwMApUUkFOU1BPUlRfRVJST1IgICA9IC0zMjMwMAoKIyBTcGVjaWZpYyBlcnJvcnMKTk9UX1dFTExGT1JNRURfRVJST1IgID0gLTMyNzAwClVOU1VQUE9SVEVEX0VOQ09ESU5HICA9IC0zMjcwMQpJTlZBTElEX0VOQ09ESU5HX0NIQVIgPSAtMzI3MDIKSU5WQUxJRF9YTUxSUEMgICAgICAgID0gLTMyNjAwCk1FVEhPRF9OT1RfRk9VTkQgICAgICA9IC0zMjYwMQpJTlZBTElEX01FVEhPRF9QQVJBTVMgPSAtMzI2MDIKSU5URVJOQUxfRVJST1IgICAgICAgID0gLTMyNjAzCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgRXhjZXB0aW9ucwoKIyMKIyBCYXNlIGNsYXNzIGZvciBhbGwga2luZHMgb2YgY2xpZW50LXNpZGUgZXJyb3JzLgoKY2xhc3MgRXJyb3IoRXhjZXB0aW9uKToKICAgICIiIkJhc2UgY2xhc3MgZm9yIGNsaWVudCBlcnJvcnMuIiIiCiAgICBfX3N0cl9fID0gb2JqZWN0Ll9fc3RyX18KCiMjCiMgSW5kaWNhdGVzIGFuIEhUVFAtbGV2ZWwgcHJvdG9jb2wgZXJyb3IuICBUaGlzIGlzIHJhaXNlZCBieSB0aGUgSFRUUAojIHRyYW5zcG9ydCBsYXllciwgaWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGVycm9yIGNvZGUgb3RoZXIgdGhhbiAyMDAKIyAoT0spLgojCiMgQHBhcmFtIHVybCBUaGUgdGFyZ2V0IFVSTC4KIyBAcGFyYW0gZXJyY29kZSBUaGUgSFRUUCBlcnJvciBjb2RlLgojIEBwYXJhbSBlcnJtc2cgVGhlIEhUVFAgZXJyb3IgbWVzc2FnZS4KIyBAcGFyYW0gaGVhZGVycyBUaGUgSFRUUCBoZWFkZXIgZGljdGlvbmFyeS4KCmNsYXNzIFByb3RvY29sRXJyb3IoRXJyb3IpOgogICAgIiIiSW5kaWNhdGVzIGFuIEhUVFAgcHJvdG9jb2wgZXJyb3IuIiIiCiAgICBkZWYgX19pbml0X18oc2VsZiwgdXJsLCBlcnJjb2RlLCBlcnJtYWxsX2V4Y2VwdGlvbl9oYW5kbGVyKGNvbnRleHQpCgogICAgICAgICMgV2FpdCB1bnRpbCBhbGwgY2FuY2VsbGVkIG92ZXJsYXBwZWQgY29tcGxldGU6IGRvbid0IGV4aXQgd2l0aCBydW5uaW5nCiAgICAgICAgIyBvdmVybGFwcGVkIHRvIHByZXZlbnQgYSBjcmFzaC4gRGlzcGxheSBwcm9ncmVzcyBldmVyeSBzZWNvbmQgaWYgdGhlCiAgICAgICAgIyBsb29wIGlzIHN0aWxsIHJ1bm5pbmcuCiAgICAgICAgbXNnX3VwZGF0ZSA9IDEuMAogICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLm1vbm90b25pYygpCiAgICAgICAgbmV4dF9tc2cgPSBzdGFydF90aW1lICsgbXNnX3VwZGF0ZQogICAgICAgIHdoaWxlIHNlbGYuX2NhY2hlOgogICAgICAgICAgICBpZiBuZXh0X21zZyA8PSB0aW1lLm1vbm90b25pYygpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCclciBpcyBydW5uaW5nIGFmdGVyIGNsb3NpbmcgZm9yICUuMWYgc2Vjb25kcycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZiwgdGltZS5tb25vdG9uaWMoKSAtIHN0YXJ0X3RpbWUpCiAgICAgICAgICAgICAgICBuZXh0X21zZyA9IHRpbWUubW9ub3RvbmljKCkgKyBtc2dfdXBkYXRlCgogICAgICAgICAgICAjIGhhbmRsZSBhIGZldyBldmVudHMsIG9yIHRpbWVvdXQKICAgICAgICAgICAgc2VsZi5fcG9sbChtc2dfdXBkYXRlKQoKICAgICAgICBzZWxmLl9yZXN1bHRzID0gW10KCiAgICAgICAgX3dpbmFwaS5DbG9zZUhhbmRsZShzZWxmLl9pb2NwKQogICAgICAgIHNlbGYuX2lvY3AgPSBOb25lCgogICAgZGVmIF9fZGVsX18oc2VsZik6CiAgICAgICAgc2VsZi5jbG9zZSgpCgoKY2xhc3MgX1dpbmRvd3NTdWJwcm9jZXNzVHJhbnNwb3J0KGJhc2Vfc3VicHJvY2Vzcy5CYXNlU3VicHJvY2Vzc1RyYW5zcG9ydCk6CgogICAgZGVmIF9zdGFydChzZWxmLCBhcmdzLCBzaGVsbCwgc3RkaW4sIHN0ZG91dCwgc3RkZXJyLCBidWZzaXplLCAqKmt3YXJncyk6CiAgICAgICAgc2VsZi5fcHJvYyA9IHdpbmRvd3NfdXRpbHMuUG9wZW4oCiAgICAgICAgICAgIGFyZ3MsIHNoZWxsPXNoZWxsLCBzdGRpbj1zdGRpbiwgc3Rkb3V0PXN0ZG91dCwgc3RkZXJyPXN0ZGVyciwKICAgICAgICAgICAgYnVmc2l6ZT1idWZzaXplLCAqKmt3YXJncykKCiAgICAgICAgZGVmIGNhbGxiYWNrKGYpOgogICAgICAgICAgICByZXR1cm5jb2RlID0gc2VsZi5fcHJvYy5wb2xsKCkKICAgICAgICAgICAgc2VsZi5fcHJvY2Vzc19leGl0ZWQocmV0dXJuY29kZSkKCiAgICAgICAgZiA9IHNlbGYuX2xvb3AuX3Byb2FjdG9yLndhaXRfZm9yX2hhbmRsZShpbnQoc2VsZi5fcHJvYy5faGFuZGxlKSkKICAgICAgICBmLmFkZF9kb25lX2NhbGxiYWNrKGNhbGxiYWNrKQoKClNlbGVjdG9yRXZlbnRMb29wID0gX1dpbmRvd3NTZWxlY3RvckV2ZW50TG9vcAoKCmNsYXNzIF9XaW5kb3dzU2VsZWN0b3JFdmVudExvb3BQb2xpY3koZXZlbnRzLl9CYXNlRGVmYXVsdEV2ZW50TG9vcFBvbGljeSk6CiAgICBfbG9vMHgwM2MyOiAoMHgwM2MzLCksICMgJ8+CJzogJ8+DJwogICAgIyBHUkVFSyBTTUFMTCBMRVRURVIgU0lHTUE6IEdSRUVLIFNNQUxMIExFVFRFUiBGSU5BTCBTSUdNQQogICAgMHgwM2MzOiAoMHgwM2MyLCksICMgJ8+DJzogJ8+CJwogICAgIyBHUkVFSyBTTUFMTCBMRVRURVIgUEhJOiBHUkVFSyBQSEkgU1lNQk9MCiAgICAweDAzYzY6ICgweDAzZDUsKSwgIyAnz4YnOiAnz5UnCiAgICAjIEdSRUVLIEJFVEEgU1lNQk9MOiBHUkVFSyBTTUFMTCBMRVRURVIgQkVUQQogICAgMHgwM2QwOiAoMHgwM2IyLCksICMgJ8+QJzogJ86yJwogICAgIyBHUkVFSyBUSEVUQSBTWU1CT0w6IEdSRUVLIFNNQUxMIExFVFRFUiBUSEVUQQogICAgMHgwM2QxOiAoMHgwM2I4LCksICMgJ8+RJzogJ864JwogICAgIyBHUkVFSyBQSEkgU1lNQk9MOiBHUkVFSyBTTUFMTCBMRVRURVIgUEhJCiAgICAweDAzZDU6ICgweDAzYzYsKSwgIyAnz5UnOiAnz4YnCiAgICAjIEdSRUVLIFBJIFNZTUJPTDogR1JFRUsgU01BTEwgTEVUVEVSIFBJCiAgICAweDAzZDY6ICgweDAzYzAsKSwgIyAnz5YnOiAnz4AnCiAgICAjIEdSRUVLIEtBUFBBIFNZTUJPTDogR1JFRUsgU01BTEwgTEVUVEVSIEtBUFBBCiAgICAweDAzZjA6ICgweDAzYmEsKSwgIyAnz7AnOiAnzronCiAgICAjIEdSRUVLIFJITyBTWU1CT0w6IEdSRUVLIFNNQUxMIExFVFRFUiBSSE8KICAgIDB4MDNmMTogKDB4MDNjMSwpLCAjICfPsSc6ICfPgScKICAgICMgR1JFRUsgTFVOQVRFIEVQU0lMT04gU1lNQk9MOiBHUkVFSyBTTUFMTCBMRVRURVIgRVBTSUxPTgogICAgMHgwM2Y1OiAoMHgwM2I1LCksICMgJ8+1JzogJ861JwogICAgIyBDWVJJTExJQyBTTUFMTCBMRVRURVIgVkU6IENZUklMTElDIFNNQUxMIExFVFRFUiBST1VOREVEIFZFCiAgICAweDA0MzI6ICgweDFjODAsKSwgIyAn0LInOiAn4bKAJwogICAgIyBDWVJJTExJQyBTTUFMTCBMRVRURVIgREU6IENZUklMTElDIFNNQUxMIExFVFRFUiBMT05HLUxFR0dFRCBERQogICAgMHgwNDM0OiAoMHgxYzgxLCksICMgJ9C0JzogJ+GygScKICAgICMgQ1lSSUxMSUMgU01BTEwgTEVUVEVSIE86IENZUklMTElDIFNNQUxMIExFVFRFUiBOQVJST1cgTwogICAgMHgwNDNlOiAoMHgxYzgyLCksICMgJ9C+JzogJ+GygicKICAgICMgQ1lSSUxMSUMgU01BTEwgTEVUVEVSIEVTOiBDWVJJTExJQyBTTUFMTCBMRVRURVIgV0lERSBFUwogICAgMHgwNDQxOiAoMHgxYzgzLCksICMgJ9GBJzogJ+GygycKICAgICMgQ1lSSUxMSUMgU01BTEwgTEVUVEVSIFRFOiBDWVJJTExJQyBTTUFMTCBMRVRURVIgVEFMTCBURSwgQ1lSSUxMSUMgU01BTEwgTEVUVEVSIFRIUkVFLUxFR0dFRCBURQogICAgMHgwNDQyOiAoMHgxYzg0LCAweDFjODUpLCAjICfRgic6ICfhsoThsoUnCiAgICAjIENZUklMTElDIFNNQUxMIExFVFRFUiBIQVJEIFNJR046IENZUklMTElDIFNNQUxMIExFVFRFUiBUQUxMIEhBUkQgU0lHTgogICAgMHgwNDRhOiAoMHgxYzg2LCksICMgJ9GKJzogJ+GyhicKICBpc3QgZm9ybWF0dGluZwogICAgICAgIGNoZWNrX2FnYWluc3QoCiAgICAgICAgICAgIHR0ay5fZm9ybWF0X29wdGRpY3QoeydmZyc6ICdibHVlJywgJ3BhZGRpbmcnOiBbMSwgMiwgMywgNF19KSwKICAgICAgICAgICAgeyctZmcnOiAnYmx1ZScsICctcGFkZGluZyc6ICcxIDIgMyA0J30pCgogICAgICAgICMgY2hlY2sgdHVwbGUgZm9ybWF0dGluZyAoc2FtZSBhcyBsaXN0KQogICAgICAgIGNoZWNrX2FnYWluc3QoCiAgICAgICAgICAgIHR0ay5fZm9ybWF0X29wdGRpY3Qoeyd0ZXN0JzogKDEsIDIsICcnLCAwKX0pLAogICAgICAgICAgICB7Jy10ZXN0JzogJzEgMiB7fSAwJ30pCgogICAgICAgICMgY2hlY2sgdW50b3VjaGVkIHZhbHVlcwogICAgICAgIGNoZWNrX2FnYWluc3QoCiAgICAgICAgICAgIHR0ay5fZm9ybWF0X29wdGRpY3Qoeyd0ZXN0JzogeydsZWZ0JzogJ2FzIGlzJ319KSwKICAgICAgICAgICAgeyctdGVzdCc6IHsnbGVmdCc6ICdhcyBpcyd9fSkKCiAgICAgICAgIyBjaGVjayBzY3JpcHQgZm9ybWF0dGluZwogICAgICAgIGNoZWNrX2FnYWluc3QoCiAgICAgICAgICAgIHR0ay5fZm9ybWF0X29wdGRpY3QoCiAgICAgICAgICAgICAgICB7J3Rlc3QnOiBbMSwgLTEsICcnLCAnMm0nLCAwXSwgJ3Rlc3QyJzogMywKICAgICAgICAgICAgICAgICAndGVzdDMnOiAnJywgJ3Rlc3Q0JzogJ2FiYyBkZWYnLAogICAgICAgICAgICAgICAgICd0ZXN0NSc6ICciYWJjIicsICd0ZXN0Nic6ICd7fScsCiAgICAgICAgICAgICAgICAgJ3Rlc3Q3JzogJ30gLXNwYW0geyd9LCBzY3JpcHQ9VHJ1ZSksCiAgICAgICAgICAgIHsnLXRlc3QnOiAnezEgLTEge30gMm0gMH0nLCAnLXRlc3QyJzogJzMnLAogICAgICAgICAgICAgJy10ZXN0Myc6ICd7fScsICctdGVzdDQnOiAne2FiYyBkZWZ9JywKICAgICAgICAgICAgICctdGVzdDUnOiAneyJhYmMifScsICctdGVzdDYnOiByJ1x7XH0nLAogICAgICAgICAgICAgJy10ZXN0Nyc6IHInXH1cIC1zcGFtXCBceyd9KQoKICAgICAgICBvcHRzID0geyfOsc6yzrMnOiBUcnVlLCAnw6EnOiBGYWxzZX0KICAgICAgICBvcmlnX29wdHMgPSBvcHRzLmNvcHkoKQogICAgICAgICMgY2hlY2sgaWYgZ2l2aW5nIHVuaWNvZGUga2V5cyBpcyBmaW5lCiAgICAgICAgY2hlY2tfYWdhaW5zdCh0dGsuX2Zvcm1hdF9vcHRkaWN0KG9wdHMpLCB7Jy3Osc6yzrMnOiBUcnVlLCAnLcOhJzogRmFsc2V9KQogICAgICAgICMgb3B0cyBzaG91bGQgcmVtYWluIHVuY2hhbmdlZAogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwob3B0cywgb3JpZ19vcHRzKQoKICAgICAgICAjIHBhc3NpbmcgdmFsdWVzIHdpdGggc3BhY2VzIGluc2lkZSBhIHR1cGxlL2xpc3QKICAgICAgICBjaGVja19hZ2FpbnN0KAogICAgICAgICAgICB0dGsuX2Zvcm1hdF9vcHRkaWN0KAogICAgICAgICAgICAgICAgeydvcHRpb24nOiAoJ29uZSB0d28nLCAndGhyZWUnKX0pLAogICAgICAgICAgICB7Jy1vcHRpb24nOiAne29uZSB0d299IHRocmVlJ30pCiBpKzE6XSA9PSAiIjogIyBodHRwOi8vZm9vLmNvbTovID09IGh0dHA6Ly9mb28uY29tLwogICAgICAgICAgICAgICAgICAgICAgICBwb3J0ID0gc2VsZi5kZWZhdWx0X3BvcnQKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBJbnZhbGlkVVJMKCJub25udW1lcmljIHBvcnQ6ICclcyciICUgaG9zdFtpKzE6XSkKICAgICAgICAgICAgICAgIGhvc3QgPSBob3N0WzppXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcG9ydCA9IHNlbGYuZGVmYXVsdF9wb3J0CiAgICAgICAgaWYgaG9zdCBhbmQgaG9zdFswXSA9PSAnWycgYW5kIGhvc3RbLTFdID09ICddJzoKICAgICAgICAgICAgaG9zdCA9IGhvc3RbMTotMV0KCiAgICAgICAgcmV0dXJuIChob3N0LCBwb3J0KQoKICAgIGRlZiBzZXRfZGVidWdsZXZlbChzZWxmLCBsZXZlbCk6CiAgICAgICAgc2VsZi5kZWJ1Z2xldmVsID0gbGV2ZWwKCiAgICBkZWYgX3dyYXBfaXB2NihzZWxmLCBpcCk6CiAgICAgICAgaWYgYic6JyBpbiBpcCBhbmQgaXBbMF0gIT0gYidbJ1swXToKICAgICAgICAgICAgcmV0dXJuIGIiWyIgKyBpcCArIGIiXSIKICAgICAgICByZXR1cm4gaXAKCiAgICBkZWYgX3R1bm5lbChzZWxmKToKICAgICAgICBjb25uZWN0ID0gYiJDT05ORUNUICVzOiVkICVzXHJcbiIgJSAoCiAgICAgICAgICAgIHNlbGYuX3dyYXBfaXB2NihzZWxmLl90dW5uZWxfaG9zdC5lbmNvZGUoImlkbmEiKSksCiAgICAgICAgICAgIHNlbGYuX3R1bm5lbF9wb3J0LAogICAgICAgICAgICBzZWxmLl9odHRwX3Zzbl9zdHIuZW5jb2RlKCJhc2NpaSIpKQogICAgICAgIGhlYWRlcnMgPSBbY29ubmVjdF0KICAgICAgICBmb3IgaGVhZGVyLCB2YWx1ZSBpbiBzZWxmLl90dW5uZWxfaGVhZGVycy5pdGVtcygpOgogICAgICAgICAgICBoZWFkZXJzLmFwcGVuZChmIntoZWFkZXJ9OiB7dmFsdWV9XHJcbiIuZW5jb2RlKCJsYXRpbi0xIikpCiAgICAgICAgaGVhZGVycy5hcHBlbmQoYiJcclxuIikKICAgICAgICAjIE1ha2luZyBhIHNpbmdsZSBzZW5kKCkgY2FsbCBpbnN0ZWFkIG9mIG9uZSBwZXIgbGluZSBlbmNvdXJhZ2VzCiAgICAgICAgIyB0aGUgaG9zdCBPUyB0byB1c2UgYSBtb3JlIG9wdGltYWwgcGFja2V0IHNpemUgaW5zdGVhZCBvZgogICAgICAgICMgcG90ZW50aWFsbHkgZW1pdHRpbmcgYSBzZXJpZXMgb2Ygc21hbGwgcGFja2V0cy4KICAgICAgICBzZWxmLnNlbmQoYiIiLmpvaW4oaGVhZGVycykpCiAgICAgICAgZGVsIGhlYWRlcnMKCiAgICAgICAgcmVzcG9uc2UgPSBzZWxmLnJlc3BvbnNlX2NsYXNzKHNlbGYuc29jaywgbWV0aG9kPXNlbGYuX21ldGhvZCkKICAgICAgICB0cnk6CiAgICAgICAgICAgICh2ZXJzaW9uLCBjb2RlLCBtZXNzYWdlKSA9IHJlc3BvbnNlLl9yZWFkX3N0YXR1cygpCgogICAgICAgICAgICBzZWxmLl9yYXdfcHJveHlfaGVhZGVycyA9IF9yZWFkX2hlYWRlcnMocmVzcG9uc2UuZnAsIHNlbGYubWF4X3Jlc3B5X2l0ZW0gaW4gbm9kZS5maW5kYWxsKG5vZGVzLmRlZmluaXRpb25fbGlzdF9pdGVtKToKICAgICAgICAgICAgdGVybSA9IGdsb3NzYXJ5X2l0ZW1bMF0uYXN0ZXh0KCkKICAgICAgICAgICAgZGVmaW5pdGlvbiA9IGdsb3NzYXJ5X2l0ZW1bLTFdCgogICAgICAgICAgICByZW5kZXJlZCA9IGFwcC5idWlsZGVyLnJlbmRlcl9wYXJ0aWFsKGRlZmluaXRpb24pCiAgICAgICAgICAgIHRlcm1zW3Rlcm0ubG93ZXIoKV0gPSB7CiAgICAgICAgICAgICAgICAndGl0bGUnOiB0ZXJtLAogICAgICAgICAgICAgICAgJ2JvZHknOiByZW5kZXJlZFsnZnJhZ21lbnQnXSwKICAgICAgICAgICAgfQoKCmRlZiB3cml0ZV9nbG9zc2FyeV9qc29uKGFwcDogU3BoaW54LCBfZXhjOiBFeGNlcHRpb24pIC0+IE5vbmU6CiAgICBpZiBub3QgZ2V0YXR0cihhcHAuZW52LCAnZ2xvc3NhcnlfdGVybXMnLCBOb25lKToKICAgICAgICByZXR1cm4KCiAgICBsb2dnZXIuaW5mbygnV3JpdGluZyBnbG9zc2FyeS5qc29uJywgY29sb3I9J2dyZWVuJykKICAgIGRlc3QgPSBQYXRoKGFwcC5vdXRkaXIsICdfc3RhdGljJywgJ2dsb3NzYXJ5Lmpzb24nKQogICAgZGVzdC5wYXJlbnQubWtkaXIoZXhpc3Rfb2s9VHJ1ZSkKICAgIGRlc3Qud3JpdGVfdGV4dChqc29uLmR1bXBzKGFwcC5lbnYuZ2xvc3NhcnlfdGVybXMpLCBlbmNvZGluZz0ndXRmLTgnKQoKCmRlZiBzZXR1cChhcHA6IFNwaGlueCkgLT4gRXh0ZW5zaW9uTWV0YWRhdGE6CiAgICBhcHAuY29ubmVjdCgnZG9jdHJlZS1yZXNvbHZlZCcsIHByb2Nlc3NfZ2xvc3Nhcnlfbm9kZXMpCiAgICBhcHAuY29ubmVjdCgnYnVpbGQtZmluaXNoZWQnLCB3cml0ZV9nbG9zc2FyeV9qc29uKQoKICAgIHJldHVybiB7CiAgICAgICAgJ3ZlcnNpb24nOiAnMS4wJywKICAgICAgICAncGFyYWxsZWxfcmVhZF9zYWZlJzogVHJ1ZSwKICAgICAgICAncGFyYWxsZWxfd3JpdGVfc2FmZSc6IFRydWUsCiAgICB9CiIiIgpQb3N0R0lTIHRvIEdEQUwgY29udmVyc2lvbiBjb25zdGFudCBkZWZpbml0aW9ucwoiIiIKCiMgTG9va3VwIHRvIGNvbnZlcnQgcGl4ZWwgdHlwZSB2YWx1ZXMgZnJvbSBHREFMIHRvIFBvc3RHSVMKR0RBTF9UT19QT1NUR0lTID0gW05vbmUsIDQsIDYsIDUsIDgsIDcsIDEwLCAxMSwgTm9uZSwgTm9uZSwgTm9uZSwgTm9uZV0KCiMgTG9va3VwIHRvIGNvbnZlcnQgcGl4ZWwgdHlwZSB2YWx1ZXMgZnJvbSBQb3N0R0lTIHRvIEdEQUwKUE9TVEdJU19UT19HREFMID0gWzEsIDEsIDEsIDMsIDEsIDMsIDIsIDUsIDQsIE5vbmUsIDYsIDcsIE5vbmUsIE5vbmVdCgojIFN0cnVjdCBwYWNrIHN0cnVjdHVyZSBmb3IgcmFzdGVyIGhlYWRlciwgdGhlIHJhc3RlciBoZWFkZXIgaGFzIHRoZQojIGZvbGxvd2luZyBzdHJ1Y3R1cmU6CiMKIyBFbmRpYW5uZXNzLCBQb3N0R0lTIHJhc3RlciB2ZXJzaW9uLCBudW1iZXIgb2YgYmFuZHMsIHNjYWxlLCBvcmlnaW4sCiMgc2tldywgc3JpZCwgd2lkdGgsIGFuZCBoZWlnaHQuCiMKIyBTY2FsZSxtcF8yLmdldF9wcmV2aW91c19ieV9jcmVhdGVkKCksIHN0YW1wXzEpCiIiIlRlc3Qgc2NyaXB0IGZvciB0aGUgZGJtLm9wZW4gZnVuY3Rpb24gYmFzZWQgb24gdGVzdGR1bWJkYm0ucHkiIiIKCmltcG9ydCB1bml0dGVzdAppbXBvcnQgZGJtCmltcG9ydCBvcwpmcm9tIHRlc3Quc3VwcG9ydCBpbXBvcnQgaW1wb3J0X2hlbHBlcgpmcm9tIHRlc3Quc3VwcG9ydCBpbXBvcnQgb3NfaGVscGVyCgoKdHJ5OgogICAgZnJvbSBkYm0gaW1wb3J0IHNxbGl0ZTMgYXMgZGJtX3NxbGl0ZTMKZXhjZXB0IEltcG9ydEVycm9yOgogICAgZGJtX3NxbGl0ZTMgPSBOb25lCgoKdHJ5OgogICAgZnJvbSBkYm0gaW1wb3J0IG5kYm0KZXhjZXB0IEltcG9ydEVycm9yOgogICAgbmRibSA9IE5vbmUKCmRpcm5hbWUgPSBvc19oZWxwZXIuVEVTVEZOCl9mbmFtZSA9IG9zLnBhdGguam9pbihkaXJuYW1lLCBvc19oZWxwZXIuVEVTVEZOKQoKIwojIEl0ZXJhdGVzIG92ZXIgZXZlcnkgZGF0YWJhc2UgbW9kdWxlIHN1cHBvcnRlZCBieSBkYm0gY3VycmVudGx5IGF2YWlsYWJsZS4KIwpkZWYgZGJtX2l0ZXJhdG9yKCk6CiAgICBmb3IgbmFtZSBpbiBkYm0uX25hbWVzOgogICAgICAgIHRyeToKICAgICAgICAgICAgbW9kID0gX19pbXBvcnRfXyhuYW1lLCBmcm9tbGlzdD1bJ29wZW4nXSkKICAgICAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgZGJtLl9tb2R1bGVzW25hbWVdID0gbW9kCiAgICAgICAgeWllbGQgbW9kCgojCiMgQ2xlYW4gdXAgYWxsIHNjcmF0Y2ggZGF0YWJhc2VzIHdlIG1pZ2h0IGhhdmUgY3JlYXRlZCBkdXJpbmcgdGVzdGluZwojCmRlZiBjbGVhdW51cF90ZXN0X2RpcigpOgogICAgb3NfaGVscGVyLnJtdHJlZShkaXJuYW1lKQoKZGVmIHNldHVwX3Rlc3RfZGlyKCk6CiAgICBjbGVhdW51cF90ZXN0X2RpcigpCiAgICBvcy5ta2RpcihkaXJuYW1lKQoKCmNsYXNzIEFueURCTVRlc3RDYXNlOgogICAgX2RpY3QgPSB7J2EnOiBiJ1B5dGhvbjonLAogICAgICAgICAgICAgJ2InOiBiJ1Byb2dyYW1taW5nJywKICAgICAgICAgICAgICdjJzogYid0aGUnLAogICAgICAgICAgICAgJ2QnOiBiJ3dheScsCiAgICAgICAgICAgICAnZic6IGInR3VpZG8nLAogICAgICAgICAgICAgJ2cnOiBiJ2ludGVuZGVkJywKICAgICAgICAgICAgIH0KCiAgICBkZWYgaW5pdF9kYihzZWxmKToKICAgICAgICBmID0gZGJtLm9wZW4oX2ZuYW1lLCAnbicpCiAgICAgICAgZm9yIGsgaW4gc2VsZi5fZGljdDoKICAgICAgICAgICAgZltrLmVuY29kZSgiYXNjaWkiKV0gPSBzZWxmLl9kaWN0W2tdCiAgICAgICAgZi5jbG9zZSgpCgogICAgZGVmIGtleXNfaGVscGVyKHNlbGYsIGYpOgogICAgICAgIGtleXMgPSBzb3J0ZWQoay5kZWNvZGUoImFzY2lpIikgZm9yIGsgaW4gZi5rZXlzKCkpCiAgICAgICAgZGtleXMgPSBzb3J0ZWQoc2VsZi5fZGljdC5rZXlzKCkpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChrZXlzLCBka2V5cykKICB0dXJuIFpFUk8KCiAgICBkZWYgdHpuYW1lKHNlbGYsIGR0KToKICAgICAgICByZXR1cm4gX3RpbWUudHpuYW1lW3NlbGYuX2lzZHN0KGR0KV0KCiAgICBkZWYgX2lzZHN0KHNlbGYsIGR0KToKICAgICAgICB0dCA9IChkdC55ZWFyLCBkdC5tb250aCwgZHQuZGF5LAogICAgICAgICAgICAgIGR0LmhvdXIsIGR0Lm1pbnV0ZSwgZHQuc2Vjb25kLAogICAgICAgICAgICAgIGR0LndlZWtkYXkoKSwgMCwgMCkKICAgICAgICBzdGFtcCA9IF90aW1lLm1rdGltZSh0dCkKICAgICAgICB0dCA9IF90aW1lLmxvY2FsdGltZShzdGFtcCkKICAgICAgICByZXR1cm4gdHQudG1faXNkc3QgPiAwCgpMb2NhbCA9IExvY2FsVGltZXpvbmUoKQoKCiMgQSBjb21wbGV0ZSBpbXBsZW1lbnRhdGlvbiBvZiBjdXJyZW50IERTVCBydWxlcyBmb3IgbWFqb3IgVVMgdGltZSB6b25lcy4KCmRlZiBmaXJzdF9zdW5kYXlfb25fb3JfYWZ0ZXIoZHQpOgogICAgZGF5c190b19nbyA9IDYgLSBkdC53ZWVrZGF5KCkKICAgIGlmIGRheXNfdG9fZ286CiAgICAgICAgZHQgKz0gdGltZWRlbHRhKGRheXNfdG9fZ28pCiAgICByZXR1cm4gZHQKCgojIFVTIERTVCBSdWxlcwojCiMgVGhpcyBpcyBhIHNpbXBsaWZpZWQgKGkuZS4sIHdyb25nIGZvciBhIGZldyBjYXNlcykgc2V0IG9mIHJ1bGVzIGZvciBVUwojIERTVCBzdGFydCBhbmQgZW5kIHRpbWVzLiBGb3IgYSBjb21wbGV0ZSBhbmQgdXAtdG8tZGF0ZSBzZXQgb2YgRFNUIHJ1bGVzCiMgYW5kIHRpbWV6b25lIGRlZmluaXRpb25zLCB2aXNpdCB0aGUgT2xzb24gRGF0YWJhc2UgKG9yIHRyeSBweXR6KToKIyBodHRwOi8vd3d3LnR3aW5zdW4uY29tL3R6L3R6LWxpbmsuaHRtCiMgaHR0cHM6Ly9zb3VyY2Vmb3JnZS5uZXQvcHJvamVjdHMvcHl0ei8gKG1pZ2h0IG5vdCBiZSB1cC10by1kYXRlKQojCiMgSW4gdGhlIFVTLCBzaW5jZSAyMDA3LCBEU1Qgc3RhcnRzIGF0IDJhbSAoc3RhbmRhcmQgdGltZSkgb24gdGhlIHNlY29uZAojIFN1bmRheSBpbiBNYXJjaCwgd2hpY2ggaXMgdGhlIGZpcnN0IFN1bmRheSBvbiBvciBhZnRlciBNYXIgOC4KRFNUU1RBUlRfMjAwNyA9IGRhdGV0aW1lKDEsIDMsIDgsIDIpCiMgYW5kIGVuZHMgYXQgMmFtIChEU1QgdGltZSkgb24gdGhlIGZpcnN0IFN1bmRheSBvZiBOb3YuCkRTVEVORF8yMDA3ID0gZGF0ZXRpbWUoMSwgMTEsIDEsIDIpCiMgRnJvbSAxOTg3IHRvIDIwMDYsIERTVCB1c2VkIHRvIHN0YXJ0IGF0IDJhbSAoc3RhbmRhcmQgdGltZSkgb24gdGhlIGZpcnN0CiMgU3VuZGF5IGluIEFwcmlsIGFuZCB0byBlbmQgYXQgMmFtIChEU1QgdGltZSkgb24gdGhlIGxhc3QKIyBTdW5kYXkgb2YgT2N0b2Jlciwgd2hpY2ggaXMgdGhlIGZpcnN0IFN1bmRheSBvbiBvciBhZnRlciBPY3QgMjUuCkRTVFNUQVJUXzE5ODdfMjAwNiA9IGRhdGV0aW1lKDEsIDQsIDEsIDIpCkRTVEVORF8xOTg3XzIwMDYgPSBkYXRldGltZSgxLCAxMCwgMjUsIDIpCiMgRnJvbSAxOTY3IHRvIDE5ODYsIERTICAjIENPTVBBUkVfT1AoaXMpLCBJU19PUCAoMCkKICAgICAgICAjIHdpdGggY29uc3RhbnQgZm9sZGluZyB3ZSBzaG91bGQgZXhwZWN0IGEgSVNfT1AgKDEpCiAgICAgICAgY29kZV9vYmogPSBuZXh0KGNvbnN0IGZvciBjb25zdCBpbiBnLl9fY29kZV9fLmNvX2NvbnN0cwogICAgICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGNvbnN0LCB0eXBlcy5Db2RlVHlwZSkgYW5kIGNvbnN0LmNvX25hbWUgPT0gIl9fYW5ub3RhdGVfXyIpCiAgICAgICAgY29kZXMgPSBbKGkub3BuYW1lLCBpLmFyZ3ZhbCkgZm9yIGkgaW4gZGlzLmdldF9pbnN0cnVjdGlvbnMoY29kZV9vYmopXQogICAgICAgIHNlbGYuYXNzZXJ0Tm90SW4oKCdVTkFSWV9OT1QnLCBOb25lKSwgY29kZXMpCiAgICAgICAgc2VsZi5hc3NlcnRJbigoJ0lTX09QJywgMSksIGNvZGVzKQoKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICB1bml0dGVzdC5tYWluKCkKIyBVbml0IHRlc3RzIGZvciB0eXBlY2FzdCBmdW5jdGlvbnMgaW4gZGphbmdvLmRiLmJhY2tlbmRzLnV0aWwKCmltcG9ydCBkYXRldGltZQppbXBvcnQgdW5pdHRlc3QKCmZyb20gZGphbmdvLmRiLmJhY2tlbmRzIGltcG9ydCB1dGlscyBhcyB0eXBlY2FzdHMKClRFU1RfQ0FTRVMgPSB7CiAgICAidHlwZWNhc3RfZGF0ZSI6ICgKICAgICAgICAoIiIsIE5vbmUpLAogICAgICAgIChOb25lLCBOb25lKSwKICAgICAgICAoIjIwMDUtMDgtMTEiLCBkYXRldGltZS5kYXRlKDIwMDUsIDgsIDExKSksCiAgICAgICAgKCIxOTkwLTAxLTAxIiwgZGF0ZXRpbWUuZGF0ZSgxOTkwLCAxLCAxKSksCiAgICApLAogICAgInR5cGVjYXN0X3RpbWUiOiAoCiAgICAgICAgKCIiLCBOb25lKSwKICAgICAgICAoTm9uZSwgTm9uZSksCiAgICAgICAgKCIwOjAwOjAwIiwgZGF0ZXRpbWUudGltZSgwLCAwKSksCiAgICAgICAgKCIwOjMwOjAwIiwgZGF0ZXRpbWUudGltZSgwLCAzMCkpLAogICAgICAgICgiODo1MDowMCIsIGRhdGV0aW1lLnRpbWUoOCwgNTApKSwKICAgICAgICAoIjA4OjUwOjAwIiwgZGF0ZXRpbWUudGltZSg4LCA1MCkpLAogICAgICAgICgiMTI6MDA6MDAiLCBkYXRldGltZS50aW1lKDEyLCAwMCkpLAogICAgICAgICgiMTI6MzA6MDAiLCBkYXRldGltZS50aW1lKDEyLCAzMCkpLAogICAgICAgICgiMTM6MDA6MDAiLCBkYXRldGltZS50aW1lKDEzLCAwMCkpLAogICAgICAgICgiMjM6NTk6MDAiLCBkYXRldGltZS50aW1lKDIzLCA1OSkpLAogICAgICAgICgiMDA6MDA6MTIiLCBkYXRldGltZS50aW1lKDAsIDAsIDEyKSksCiAgICAgICAgKCIwMDowMDoxMi41IiwgZGF0ZXRpbWUudGltZSgwLCAwLCAxMiwgNTAwMDAwKSksCiAgICAgICAgKCI3OjIyOjEzLjMxMiIsIGRhdGV0aW1lLnRpbWUoNywgMjIsIDEzLCAzMTIwMDApKSwKICAgICAgICAoIjEyOjQ1OjMwLjEyNjYzMSIsIGRhdGV0aW1lLnRpbWUoMTIsIDQ1LCAzMCwgMTI2NjMxKSksCiAgICAgICAgKCIxMjo0NTozMC4xMjY2MzAiLCBkJ2JhciciKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoc2VsZi5jdS5yb3djb3VudCwgMikKCiAgICBkZWYgdGVzdF9yb3djb3VudF9zZWxlY3Qoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgcHlzcWxpdGUgZG9lcyBub3Qga25vdyB0aGUgcm93Y291bnQgb2YgU0VMRUNUIHN0YXRlbWVudHMsIGJlY2F1c2Ugd2UKICAgICAgICBkb24ndCBmZXRjaCBhbGwgcm93cyBhZnRlciBleGVjdXRpbmcgdGhlIHNlbGVjdCBzdGF0ZW1lbnQuIFRoZSByb3djb3VudAogICAgICAgIGhhcyB0aHVzIHRvIGJlIC0xLgogICAgICAgICIiIgogICAgICAgIHNlbGYuY3UuZXhlY3V0ZSgic2VsZWN0IDUgdW5pb24gc2VsZWN0IDYiKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoc2VsZi5jdS5yb3djb3VudCwgLTEpCgogICAgZGVmIHRlc3Rfcm93Y291bnRfZXhlY3V0ZW1hbnkoc2VsZik6CiAgICAgICAgc2VsZi5jdS5leGVjdXRlKCJkZWxldGUgZnJvbSB0ZXN0IikKICAgICAgICBzZWxmLmN1LmV4ZWN1dGVtYW55KCJpbnNlcnQgaW50byB0ZXN0KG5hbWUpIHZhbHVlcyAoPykiLCBbKDEsKSwgKDIsKSwgKDMsKV0pCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzZWxmLmN1LnJvd2NvdW50LCAzKQoKICAgIEB1bml0dGVzdC5za2lwSWYoc3FsaXRlLnNxbGl0ZV92ZXJzaW9uX2luZm8gPCAoMywgMzUsIDApLAogICAgICAgICAgICAgICAgICAgICAiUmVxdWlyZXMgU1FMaXRlIDMuMzUuMCBvciBuZXdlciIpCiAgICBkZWYgdGVzdF9yb3djb3VudF91cGRhdGVfcmV0dXJuaW5nKHNlbGYpOgogICAgICAgICMgZ2gtOTM0MjE6IHJvd2NvdW50IGlzIHVwZGF0ZWQgY29ycmVjdGx5IGZvciBVUERBVEUuLi5SRVRVUk5JTkcgcXVlcmllcwogICAgICAgIHNlbGYuY3UuZXhlY3V0ZSgidXBkYXRlIHRlc3Qgc2V0IG5hbWU9J2Jhcicgd2hlcmUgbmFtZT0nZm9vJyByZXR1cm5pbmcgMSIpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzZWxmLmN1LmZldGNob25lKClbMF0sIDEpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzZWxmLmN1LnJvd2NvdW50LCAxKQoKICAgIGRlZiB0ZXN0X3Jvd2NvdW50X3ByZWZpeGVkX3dpdGhfY29tbWVudChzZWxmKToKICAgICAgICAjIGdoLTc5NTc5OiByb3djb3VudCBpcyB1cGRhdGVkIGV2ZW4gaWYgcXVlcnkgaXMgcHJlZml4ZWQgd2l0aCBjb21tZW50cwogICAgICAgIHNlbGYuY3UuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgLS0gZm9vCiAgICAgICAgICAgIGluc2VydCBpbnRvIHRlc3QobmFtZSkgdmFsdWVzICgnZm9vJyksICgnZm9vJykKICAgICAgICAiIiIpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzZWxmLmN1LnJvd2NvdW50LCAyKQogICAgICAgIHNlbGYuY3UuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgLyogLS0gbWVzc3kgKnIgLyogLyogKiogKi0gKi0tCiAgICAgICAgICAgICovCiAgICAgICAgICAgIC8qIG9uZSBtb3JlICovIGluc2VydCBpbnRvIHRlc3QobmFtZSkgdmFsdWVzICgnbWVzc3knKQogICAgIHtzfWYie3p9e299PHt6fSB7b308e3p9e259MHt6fXtvfT57en0ge299Pnt6fXtzfSJ7en0KICAgICAgICAgICAgIiIiCiAgICAgICAgKS5mb3JtYXQoKipjb2xvcnMpLnJlcGxhY2UoIjwiLCAieyIpLnJlcGxhY2UoIj4iLCAifSIpCiAgICAgICAgZXZlbnRzID0gY29kZV90b19ldmVudHMoY29kZSkKICAgICAgICByZWFkZXIsIF8gPSBoYW5kbGVfYWxsX2V2ZW50cyhldmVudHMpCiAgICAgICAgc2VsZi5hc3NlcnRfc2NyZWVuX2VxdWFsKHJlYWRlciwgY29kZSwgY2xlYW49VHJ1ZSkKICAgICAgICBzZWxmLm1heERpZmY9Tm9uZQogICAgICAgIHNlbGYuYXNzZXJ0X3NjcmVlbl9lcXVhbChyZWFkZXIsIGV4cGVjdGVkKQoKICAgIGRlZiB0ZXN0X2NvbnRyb2xfY2hhcmFjdGVycyhzZWxmKToKICAgICAgICBjb2RlID0gJ2ZsYWcgPSAi8J+Ps++4j+KAjfCfjIgiJwogICAgICAgIGV2ZW50cyA9IGNvZGVfdG9fZXZlbnRzKGNvZGUpCiAgICAgICAgcmVhZGVyLCBfID0gaGFuZGxlX2FsbF9ldmVudHMoZXZlbnRzKQogICAgICAgIHNlbGYuYXNzZXJ0X3NjcmVlbl9lcXVhbChyZWFkZXIsICdmbGFnID0gIvCfj7PvuI9cXHUyMDBk8J+MiCInLCBjbGVhbj1UcnVlKQogICAgICAgIHNlbGYuYXNzZXJ0X3NjcmVlbl9lcXVhbChyZWFkZXIsICdmbGFnIHtvfT17en0ge3N9IvCfj7PvuI9cXHUyMDBk8J+MiCJ7en0nLmZvcm1hdCgqKmNvbG9ycykpCiIiIkdlbmVyYXRlIExpYi9rZXl3b3JkLnB5IGZyb20gdGhlIEdyYW1tYXIgYW5kIFRva2VucyBmaWxlcyB1c2luZyBwZ2VuIiIiCgppbXBvcnQgYXJncGFyc2UKCmZyb20gLmJ1aWxkIGltcG9ydCBidWlsZF9wYXJzZXIsIGdlbmVyYXRlX3Rva2VuX2RlZmluaXRpb25zCmZyb20gLmNfZ2VuZXJhdG9yIGltcG9ydCBDUGFyc2VyR2VuZXJhdG9yCgpURU1QTEFURSA9IHInJycKIiIiS2V5d29yZHMgKGZyb20gIkdyYW1tYXIvcHl0aG9uLmdyYW0iKQoKVGhpcyBmaWxlIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkOyBwbGVhc2UgZG9uJ3QgbXVjayBpdCB1cCEKClRvIHVwZGF0ZSB0aGUgc3ltYm9scyBpbiB0aGlzIGZpbGUsICdjZCcgdG8gdGhlIHRvcCBkaXJlY3Rvcnkgb2YKdGhlIHB5dGhvbiBzb3VyY2UgdHJlZSBhbmQgcnVuOgoKICAgIFBZVEhPTlBBVEg9VG9vbHMvcGVnX2dlbmVyYXRvciBweXRob24zIC1tIHBlZ2VuLmtleXdvcmRnZW4gXAogICAgICAgIEdyYW1tYXIvcHl0aG9uLmdyYW0gXAogICAgICAgIEdyYW1tYXIvVG9rZW5zIFwKICAgICAgICBMaWIva2V5d29yZC5weQoKQWx0ZXJuYXRpdmVseSwgeW91IGNhbiBydW4gJ21ha2UgcmVnZW4ta2V5d29yZCcuCiIiIgoKX19hbGxfXyA9IFsiaXNrZXl3b3JkIiwgImlzc29mdGtleXdvcmQiLCAia3dsaXN0IiwgInNvZnRrd2xpc3QiXQoKa3dsaXN0ID0gWwp7a2V5d29yZHN9Cl0KCnNvZnRrd2xpc3QgPSBbCntzb2Z0X2tleXdvcmRzfQpdCgppc2tleXdvcmQgPSBmcm96ZW5zZXQoa3dsaXN0KS5fX2NvbnRhaW5zX18KaXNzb2YgWyJ6aC1oYW5zIl0sCiAgICB9LAogICAgInpoLXR3IjogewogICAgICAgICJmYWxsYmFjayI6IFsiemgtaGFudCJdLAogICAgfSwKfQpmcm9tIGRqYW5nby5kYi5tb2RlbHMgaW1wb3J0IFEKZnJvbSBkamFuZ28udGVzdCBpbXBvcnQgVGVzdENhc2UKCmZyb20gLm1vZGVscyBpbXBvcnQgQ29tbWVudCwgRm9ydW0sIEl0ZW0sIFBvc3QsIFByb3BlcnR5VmFsdWUsIFN5c3RlbURldGFpbHMsIFN5c3RlbUluZm8KCgpjbGFzcyBOdWxsRmtUZXN0cyhUZXN0Q2FzZSk6CiAgICBkZWYgdGVzdF9udWxsX2ZrKHNlbGYpOgogICAgICAgIGQgPSBTeXN0ZW1EZXRhaWxzLm9iamVjdHMuY3JlYXRlKGRldGFpbHM9IkZpcnN0IGRldGFpbHMiKQogICAgICAgIHMgPSBTeXN0ZW1JbmZvLm9iamVjdHMuY3JlYXRlKHN5c3RlbV9uYW1lPSJGaXJzdCBmb3J1bSIsIHN5c3RlbV9kZXRhaWxzPWQpCiAgICAgICAgZiA9IEZvcnVtLm9iamVjdHMuY3JlYXRlKHN5c3RlbV9pbmZvPXMsIGZvcnVtX25hbWU9IkZpcnN0IGZvcnVtIikKICAgICAgICBwID0gUG9zdC5vYmplY3RzLmNyZWF0ZShmb3J1bT1mLCB0aXRsZT0iRmlyc3QgUG9zdCIpCiAgICAgICAgYzEgPSBDb21tZW50Lm9iamVjdHMuY3JlYXRlKHBvc3Q9cCwgY29tbWVudF90ZXh0PSJNeSBmaXJzdCBjb21tZW50IikKICAgICAgICBjMiA9IENvbW1lbnQub2JqZWN0cy5jcmVhdGUoY29tbWVudF90ZXh0PSJNeSBzZWNvbmQgY29tbWVudCIpCgogICAgICAgICMgU3RhcnRpbmcgZnJvbSBjb21tZW50LCBtYWtlIHN1cmUgdGhhdCBhIC5zZWxlY3RfcmVsYXRlZCguLi4pIHdpdGggYQogICAgICAgICMgc3BlY2lmaWVkIHNldCBvZiBmaWVsZHMgd2lsbCBwcm9wZXJseSBMRUZUIEpPSU4gbXVsdGlwbGUgbGV2ZWxzIG9mCiAgICAgICAgIyBOVUxMcyAoYW5kIHRoZSB0aGluZ3MgdGhhdCBjb21lIGFmdGVyIHRoZSBOVUxMcywgb3IgZWxzZSBkYXRhIHRoYXQKICAgICAgICAjIHNob3VsZCBleGlzdCB3b24ndCkuIFJlZ3Jlc3Npb24gdGVzdCBmb3IgIzczNjkuCiAgICAgICAgYyA9IENvbW1lbnQub2JqZWN0cy5zZWxlY3RfcmVsYXRlZCgpLmdldChpZD1jMS5pZCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGMucG9zdCwgcCkKICAgICAgICBzZWxmLmFzc2VydElzTm9uZShDb21tZW50Lm9iamVjdHMuc2VsZWN0X3JlbGF0ZWQoKS5nZXQoaWQ9YzIuaWQpLnBvc3QpCgogICAgICAgIHNlbGYuYXNzZXJ0UXVlcnlTZXRFcXVhbCgKICAgICAgICAgICAgQ29tbWVudC5vYmplY3RzLnNlbGVjdF9yZWxhdGVkKCJwb3N0X19mb3J1bV9fc3lzdGVtX2luZm8iKS5hbGwoKSwKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgKGMxLmlkLCAiTXkgZmlyc3QgY29tbWVudCIsICI8UG9zdDogRmlyc3QgUG9zdD4iKSwKICAgICAgICAgICAgICAgIChjMi5pZCwgIk15IHNlY29uZCBjb21tZW50IiwgIk5vbmUiKSwKICAgICAgICAgICAgXSwKICAgICAgICAgICAgdHJhbnNmb3JtPWxhbWJkYSBjOiAoYy5pZCwgYy5jb210ZW0KCmRlZiBfc2lmdHVwX21heChoZWFwLCBwb3MpOgogICAgJ01heGhlYXAgdmFyaWFudCBvZiBfc2lmdHVwJwogICAgZW5kcG9zID0gbGVuKGhlYXApCiAgICBzdGFydHBvcyA9IHBvcwogICAgbmV3aXRlbSA9IGhlYXBbcG9zXQogICAgIyBCdWJibGUgdXAgdGhlIGxhcmdlciBjaGlsZCB1bnRpbCBoaXR0aW5nIGEgbGVhZi4KICAgIGNoaWxkcG9zID0gMipwb3MgKyAxICAgICMgbGVmdG1vc3QgY2hpbGQgcG9zaXRpb24KICAgIHdoaWxlIGNoaWxkcG9zIDwgZW5kcG9zOgogICAgICAgICMgU2V0IGNoaWxkcG9zIHRvIGluZGV4IG9mIGxhcmdlciBjaGlsZC4KICAgICAgICByaWdodHBvcyA9IGNoaWxkcG9zICsgMQogICAgICAgIGlmIHJpZ2h0cG9zIDwgZW5kcG9zIGFuZCBub3QgaGVhcFtyaWdodHBvc10gPCBoZWFwW2NoaWxkcG9zXToKICAgICAgICAgICAgY2hpbGRwb3MgPSByaWdodHBvcwogICAgICAgICMgTW92ZSB0aGUgbGFyZ2VyIGNoaWxkIHVwLgogICAgICAgIGhlYXBbcG9zXSA9IGhlYXBbY2hpbGRwb3NdCiAgICAgICAgcG9zID0gY2hpbGRwb3MKICAgICAgICBjaGlsZHBvcyA9IDIqcG9zICsgMQogICAgIyBUaGUgbGVhZiBhdCBwb3MgaXMgZW1wdHkgbm93LiAgUHV0IG5ld2l0ZW0gdGhlcmUsIGFuZCBidWJibGUgaXQgdXAKICAgICMgdG8gaXRzIGZpbmFsIHJlc3RpbmcgcGxhY2UgKGJ5IHNpZnRpbmcgaXRzIHBhcmVudHMgZG93bikuCiAgICBoZWFwW3Bvc10gPSBuZXdpdGVtCiAgICBfc2lmdGRvd25fbWF4KGhlYXAsIHN0YXJ0cG9zLCBwb3MpCgpkZWYgbWVyZ2UoKml0ZXJhYmxlcywga2V5PU5vbmUsIHJldmVyc2U9RmFsc2UpOgogICAgJycnTWVyZ2UgbXVsdGlwbGUgc29ydGVkIGlucHV0cyBpbnRvIGEgc2luZ2xlIHNvcnRlZCBvdXRwdXQuCgogICAgU2ltaWxhciB0byBzb3J0ZWQoaXRlcnRvb2xzLmNoYWluKCppdGVyYWJsZXMpKSBidXQgcmV0dXJucyBhIGdlbmVyYXRvciwKICAgIGRvZXMgbm90IHB1bGwgdGhlIGRhdGEgaW50byBtZW1vcnkgYWxsIGF0IG9uY2UsIGFuZCBhc3N1bWVzIHRoYXQgZWFjaCBvZgogICAgdGhlIGlucHV0IHN0cmVhbXMgaXMgYWxyZWFkeSBzb3J0ZWQgKHNtYWxsZXN0IHRvIGxhcmdlc3QpLgoKICAgID4+PiBsaXN0KG1lcmdlKFsxLDMsNSw3XSwgWzAsMiw0LDhdLCBbNSwxMCwxNSwyMF0sIFtdLCBbMjVdKSkKICAgIFswLCAxLCAyLCAzLCA0LCA1LCA1LCA3LCA4LCAxMCwgMTUsIDIwLCAyNV0KCiAgICBJZiAqa2V5KiBpcyBub3QgTm9uZSwgYXBwbGllcyBhIGtleSBmdW5jdGlvbiB0byBlYWNoIGVsZW1lbnQgdG8gZGV0ZXJtaW5lCiAgICBpdHMgc29ydCBvcmRlci4KCiAgICA+Pj4gbGlzdChtZXJnZShbJ2RvZycsICdob3JzZSddLCBbJ2NhdCcsICdmaXNoJywgJ2thbmdhcm9vJ10sIGtleT1sZW4pKQogICAgWydkb2cnLCAnY2F0JywgJ2Zpc2gnLCAnaG9yc2UnLCAna2FuZ2Fyb28nXQoKICAgICcnJwoKICAgIGggPSBbXQogICAgaF9hcHBlbmQgPSBoLmFwcGVuZAoKICBuICIlc2FydGljbGUvJXMvIiAlIChpdGVtLmVudHJ5LmdldF9hYnNvbHV0ZV91cmwoKSwgaXRlbS5waykKCiAgICBkZWYgaXRlbV9jb21tZW50cyhzZWxmLCBpdGVtKToKICAgICAgICByZXR1cm4gIiVzY29tbWVudHMiICUgc2VsZi5pdGVtX2xpbmsoaXRlbSkKCiAgICBkZWYgaXRlbV9kZXNjcmlwdGlvbihzZWxmLCBpdGVtKToKICAgICAgICByZXR1cm4gIkFydGljbGUgZGVzY3JpcHRpb246ICVzIiAlIGl0ZW0udGl0bGUKCiAgICBkZWYgaXRlbV90aXRsZShzZWxmLCBpdGVtKToKICAgICAgICByZXR1cm4gIlRpdGxlOiAlcyIgJSBpdGVtLnRpdGxlCgoKY2xhc3MgVGVzdEZlZWRXaXRoU3R5bGVzaGVldHMoVGVzdFJzczJGZWVkKToKICAgIHN0eWxlc2hlZXRzID0gWwogICAgICAgICIvc3R5bGVzaGVldDEueHNsIiwKICAgICAgICBmZWVkZ2VuZXJhdG9yLlN0eWxlc2hlZXQoIi9zdHlsZXNoZWV0Mi54c2wiKSwKICAgIF0KCgpjbGFzcyBOYWl2ZURhdGVzRmVlZChUZXN0QXRvbUZlZWQpOgogICAgIiIiCiAgICBBIGZlZWQgd2l0aCBuYWl2ZSAobm9uLXRpbWV6b25lLWF3YXJlKSBkYXRlcy4KICAgICIiIgoKICAgIGRlZiBpdGVtX3B1YmRhdGUoc2VsZiwgaXRlbSk6CiAgICAgICAgcmV0dXJuIGl0ZW0ucHVibGlzaGVkCgoKY2xhc3MgVFpBd2FyZURhdGVzRmVlZChUZXN0QXRvbUZlZWQpOgogICAgIiIiCiAgICBBIGZlZWQgd2l0aCB0aW1lem9uZS1hd2FyZSBkYXRlcy4KICAgICIiIgoKICAgIGRlZiBpdGVtX3B1YmRhdGUoc2VsZiwgaXRlbSk6CiAgICAgICAgIyBQcm92aWRlIGEgd2VpcmQgb2Zmc2V0IHNvIHRoYXQgdGhlIHRlc3QgY2FuIGtub3cgaXQncyBnZXR0aW5nIHRoaXMKICAgICAgICAjIHNwZWNpZmljIG9mZnNldCBhbmQgbm90IGFjY2lkZW50YWxseSBnZXR0aW5nIG9uIGZyb20KICAgICAgICAjIHNldHRpbmdzLlRJTUVfWk9ORS4KICAgICAgICByZXR1cm4gaXRlbS5wdWJsaXNoZWQucmVwbGFjZSh0emluZm89Z2V0X2ZpeGVkX3RpbWV6b25lKDQyKSkKCgpjbGFzcyBUZXN0RmVlZFVybEZlZWQoVGVzdEF0b21GZWVkKToKICAgIGZlZWRfdXJsID0gImh0dHA6Ly9leGFtcGxlLmNvbS9jdXN0b21mZWVkdXJsLyIKCgpjbGFzcyBNeUN1c3RvbUF0b20xRmVlZChmZWVkZ2VuZXJhdG9yLkF0b20xRmVlZCk6CiAgICAiIiIKICAgIFRlc3Qgb2YgYSBjdXN0b20gZmVlZCBnZW5lcmF0b3IgY2xhc3MuCiAgICAiIiIKCiAgICBkZWYgcm9vdF9hdHRyaWJ1dGVzKHNlbGYpOgogICAgICAgIGF0dHJzID0gc3VwZXIoKS5yb290X2F0dHJpYnV0ZXMoKQogICAgICAgIGF0dHJzWyJkamFuZ28iXSA9ICJyb2NrcyIKICAgICAgICByZXR1cm4gYXR0cnMKCiAgICBkZWYgYWRkX3Jvb3RfZWxlbWVudHMoc2VsZiwgaGFuZGxlcik6CiAgICAgICAgc3VwZXIoKS5hZGRfcm9vdF9lbGVtZW50cyhoYW5kbGVyKQogICAgICAgIGhhbmRsZXIuYWRkUXVpY2tFbGVtZW50KCJzcGFtIiwgImVnZ3MiKQoKICAgIGRlZiBpdGVtX2F0dHJWYXJ5OiBDb29raWUnIHRvIHByZXZlbnQgdGhlICdTZXQtQ29va2llJwogICAgICAgICMgZnJvbSBiZWluZyBjYWNoZWQuCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5oZWFkZXJzWyJWYXJ5Il0sICJDb29raWUiKQoKICAgIEBvdmVycmlkZV9zZXR0aW5ncygKICAgICAgICBTRVNTSU9OX0NPT0tJRV9ET01BSU49Ii5leGFtcGxlLmxvY2FsIiwgU0VTU0lPTl9DT09LSUVfUEFUSD0iL2V4YW1wbGUvIgogICAgKQogICAgZGVmIHRlc3Rfc2Vzc2lvbl9kZWxldGVfb25fZW5kX3dpdGhfY3VzdG9tX2RvbWFpbl9hbmRfcGF0aChzZWxmKToKICAgICAgICBkZWYgcmVzcG9uc2VfZW5kaW5nX3Nlc3Npb24ocmVxdWVzdCk6CiAgICAgICAgICAgIHJlcXVlc3Quc2Vzc2lvbi5mbHVzaCgpCiAgICAgICAgICAgIHJldHVybiBIdHRwUmVzcG9uc2UoIlNlc3Npb24gdGVzdCIpCgogICAgICAgIHJlcXVlc3QgPSBzZWxmLnJlcXVlc3RfZmFjdG9yeS5nZXQoIi8iKQogICAgICAgIG1pZGRsZXdhcmUgPSBTZXNzaW9uTWlkZGxld2FyZShyZXNwb25zZV9lbmRpbmdfc2Vzc2lvbikKCiAgICAgICAgIyBCZWZvcmUgZGVsZXRpbmcsIHRoZXJlIGhhcyB0byBiZSBhbiBleGlzdGluZyBjb29raWUKICAgICAgICByZXF1ZXN0LkNPT0tJRVNbc2V0dGluZ3MuU0VTU0lPTl9DT09LSUVfTkFNRV0gPSAiYWJjIgoKICAgICAgICAjIEhhbmRsZSB0aGUgcmVzcG9uc2UgdGhyb3VnaCB0aGUgbWlkZGxld2FyZQogICAgICAgIHJlc3BvbnNlID0gbWlkZGxld2FyZShyZXF1ZXN0KQoKICAgICAgICAjIFRoZSBjb29raWUgd2FzIGRlbGV0ZWQsIG5vdCByZWNyZWF0ZWQuCiAgICAgICAgIyBBIGRlbGV0ZWQgY29va2llIGhlYWRlciB3aXRoIGEgY3VzdG9tIGRvbWFpbiBhbmQgcGF0aCBsb29rcyBsaWtlOgogICAgICAgICMgIFNldC1Db29raWU6IHNlc3Npb25pZD07IERvbWFpbj0uZXhhbXBsZS5sb2NhbDsKICAgICAgICAjICAgICAgICAgICAgICBleHBpcmVzPVRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UOyBNYXgtQWdlPTA7CiAgICAgICAgIyAgICAgICAgICAgICAgUGF0aD0vZXhhbXBsZS8KICAgICAgICBzZWxmLmFzc2VydEVxdWFsKAogICAgICAgICAgICAnU2V0LUNvb2tpZToge309IiI7IERvbWFpbj0uZXhhbXBsZS5sb2NhbDsgZXhwaXJlcz1UaHUsICcKICAgICAgICAgICAgIjAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVDsgTWF4LUFnZT0wOyBQYXRoPS9leGFtcGxlLzsgU2FtZVNpdGU9e30iLmZvcm1hdCgKICAgICAgICAgICAgICAgIHNldHRpbmdzLlNFU1NJT05fQ09PS0lFX05BTUUsCiAgICAgICAgICAgICAgICBzZXR0aW5ncy5TRVNTSU9OX0NPT0tJRV9TQU1FU0lURSwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgc3RyKHJlc3BvbnNlLmNvb2tpZXNbc2V0dGluZ3MuU0VTU0lPTl9DT09LSUVfTkFNRV0pLAogICAgICAgICkKCiAgICBkZWYgdGVzdF9mbHVzaF9lbXB0eV93aXRob3V0X3Nlc3Npb25fY29va2llX2RvZXNudF9ldF9sYXN0X2Vycm9yKCksIDMyKQoKICAgICAgICBjdHlwZXMuc2V0X2xhc3RfZXJyb3IoMCkKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgdW5pdHRlc3QubWFpbigpCiIiIgpBbiBhdXRvLWNvbXBsZXRpb24gd2luZG93IGZvciBJRExFLCB1c2VkIGJ5IHRoZSBhdXRvY29tcGxldGUgZXh0ZW5zaW9uCiIiIgppbXBvcnQgcGxhdGZvcm0KCmZyb20gdGtpbnRlciBpbXBvcnQgKgpmcm9tIHRraW50ZXIudHRrIGltcG9ydCBTY3JvbGxiYXIKCmZyb20gaWRsZWxpYi5hdXRvY29tcGxldGUgaW1wb3J0IEZJTEVTLCBBVFRSUwpmcm9tIGlkbGVsaWIubXVsdGljYWxsIGltcG9ydCBNQ19TSElGVAoKSElERV9WSVJUVUFMX0VWRU5UX05BTUUgPSAiPDxhdXRvY29tcGxldGV3aW5kb3ctaGlkZT4+IgpISURFX0ZPQ1VTX09VVF9TRVFVRU5DRSA9ICI8Rm9jdXNPdXQ+IgpISURFX1NFUVVFTkNFUyA9IChISURFX0ZPQ1VTX09VVF9TRVFVRU5DRSwgIjxCdXR0b25QcmVzcz4iKQpLRVlQUkVTU19WSVJUVUFMX0VWRU5UX05BTUUgPSAiPDxhdXRvY29tcGxldGV3aW5kb3cta2V5cHJlc3M+PiIKIyBXZSBuZWVkIHRvIGJpbmQgZXZlbnQgYmV5b25kIDxLZXk+IHNvIHRoYXQgdGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkCiMgYmVmb3JlIHRoZSBkZWZhdWx0IHNwZWNpZmljIElETEUgZnVuY3Rpb24KS0VZUFJFU1NfU0VRVUVOQ0VTID0gKCI8S2V5PiIsICI8S2V5LUJhY2tTcGFjZT4iLCAiPEtleS1SZXR1cm4+IiwgIjxLZXktVGFiPiIsCiAgICAgICAgICAgICAgICAgICAgICAiPEtleS1VcD4iLCAiPEtleS1Eb3duPiIsICI8S2V5LUhvbWU+IiwgIjxLZXktRW5kPiIsCiAgICAgICAgICAgICAgICAgICAgICAiPEtleS1Qcmlvcj4iLCAiPEtleS1OZXh0PiIsICI8S2V5LUVzY2FwZT4iKQpLRVlSRUxFQVNFX1ZJUlRVQUxfRVZFTlRfTkFNRSA9ICI8PGF1dG9jb21wbGV0ZXdpbmRvdy1rZXlyZWxlYXNlPj4iCktFWVJFTEVBU0VfU0VRVUVOQ0UgPSAiPEtleVJlbGVhc2U+IgpMSVNUVVBEQVRFX1NFUVVFTkNFID0gIjxCMS1CdXR0b25SZWxlYXNlPiIKV0lOQ09ORklHX1NFUVVFTkNFID0gIjxDb25maWd1cmU+IgpET1VCTEVDTElDS19TRVFVRU5DRSA9ICI8QjEtRG91YmxlLUJ1dHRvblJlbGVhc2U+IgoKY2xhc3MgQXV0b0NvbXBsZXRlV2luZG93OgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB3aWRnZXQsIHRhZ3MpOgogICAgICAgICMgVGhlIHdpZGdldCAoVGV4dCkgb24gd2hpY2ggd2UgcGxhY2UgdGhlIEF1dG9Db21wbGV0ZVdpbmRvdwogICAgICAgIHNlbGYud2lkZ2V0ID0gd2lkZ2V0CiAgICAgICAgIyBUYWdzIHRvIG1hcmsgaW5zZXJ0ZWQgdGV4dCB3aXRoCiAgICAgICAgc2VsZi50YWdzID0gdGFncwogICAgICAgICMgVGhlIHdpZGdldHMgd2UgY3JlYXRlCiAgICAgICAgc2VsZi5hdXRvY29tcGxldGV3aW5kb3cgPSBzZWxmLmxpc3Rib3ggPSBzZWxmLnNjcm9sbGJhciA9IE5vbmUKICAgICAgICAjIFRoZSBkZWZhdWx0IGZvcmVoZSBYQ09GRiAoYWthIEFJWCkgc3R5bGUgLSBvbmUgZGlyZWN0b3J5IChvbmUgYXJjaGl2ZSBmaWxlKSBpcyBzdWZmaWNpZW50CmFzIG11bHRpcGxlIHNoYXJlZCBsaWJyYXJpZXMgY2FuIGJlIGluIHRoZSBhcmNoaXZlIC0gZXZlbiBzaGFyaW5nIHRoZSBzYW1lIG5hbWUuCkluIGRvY3VtZW50YXRpb24gdGhlIGFyY2hpdmUgaXMgYWxzbyByZWZlcnJlZCB0byBhcyB0aGUgImJhc2UiIGFuZCB0aGUgc2hhcmVkCmxpYnJhcnkgb2JqZWN0IGlzIHJlZmVycmVkIHRvIGFzIHRoZSAibWVtYmVyIi4KCkZvciBkbG9wZW4oKSBvbiBBSVggKHJlYWQgaW5pdEFuZExvYWQoKSkgdGhlIGNhbGxzIGFyZSBzaW1pbGFyLgpEZWZhdWx0IGFjdGl2aXR5IG9jY3VycyB3aGVuIG5vIHBhdGggaW5mb3JtYXRpb24gaXMgcHJvdmlkZWQuIFdoZW4gcGF0aAppbmZvcm1hdGlvbiBpcyBwcm92aWRlZCBkbG9wZW4oKSBkb2VzIG5vdCBzZWFyY2ggYW55IG90aGVyIGRpcmVjdG9yaWVzLgoKRm9yIFNWUjQgLSB0aGUgc2hhcmVkIGxpYnJhcnkgbmFtZSBpcyB0aGUgbmFtZSBvZiB0aGUgZmlsZSBleHBlY3RlZDogbGliRk9PLnNvCkZvciBBSVggLSB0aGUgc2hhcmVkIGxpYnJhcnkgaXMgZXhwcmVzc2VkIGFzIGJhc2UobWVtYmVyKS4gVGhlIHNlYXJjaCBpcyBmb3IgdGhlCmJhc2UgKGUuZy4sIGxpYkZPTy5hKSBhbmQgb25jZSB0aGUgYmFzZSBpcyBmb3VuZCB0aGUgc2hhcmVkIGxpYnJhcnkgLSBpZGVudGlmaWVkIGJ5Cm1lbWJlciAoZS5nLiwgbGliRk9PLnNvLCBvciBzaHIubykgaXMgbG9jYXRlZCBhbmQgbG9hZGVkLgoKVGhlIG1vZGUgYml0IFJUTERfTUVNQkVSIHRlbGxzIGluaXRBbmRMb2FkKCkgdGhhdCBpdCBuZWVkcyB0byB1c2UgdGhlIEFJWCAoU1ZSMykKbmFtaW5nIHN0eWxlLgoiIiIKX19hdXRob3JfXyA9ICJNaWNoYWVsIEZlbHQgPGFpeHRvb2xzQGZlbHQuZGVtb24ubmw+IgoKaW1wb3J0IHJlCmZyb20gb3MgaW1wb3J0IGVudmlyb24sIHBhdGgKZnJvbSBzeXMgaW1wb3J0IGV4ZWN1dGFibGUKZnJvbSBjdHlwZXMgaW1wb3J0IGNfdm9pZF9wLCBzaXplb2YKZnJvbSBzdWJwcm9jZXNzIGltcG9ydCBQb3BlbiwgUElQRSwgREVWTlVMTAoKIyBFeGVjdXRhYmxlIGJpdCBzaXplIC0gMzIgb3IgNjQKIyBVc2VkIHRvIGZpbHRlciB0aGUgc2VhcmNoIGluIGFuIGFyY2hpdmUgYnkgc2l6ZSwgZS5nLiwgLVg2NApBSVhfQUJJID0gc2l6ZW9mKGNfdm9pZF9wKSAqIDgKCgpmcm9tIHN5cyBpbXBvcnQgbWF4c2l6ZQpkZWYgX2xhc3RfdmVyc2lvbihsaWJuYW1lcywgc2VwKToKICAgIGRlZiBfbnVtX3ZlcnNpb24obGlibmFtZSk6CiAgICAgICAgIyAibGlieHl6LnNvLk1BSk9SLk1JTk9SIiA9PiBbTUFKT1IsIE1JTk9SXQogICAgICAgIHBhcnRzID0gbGlibmFtZS5zcGxpdChzZXApCiAgICAgICAgbnVtcyA9IFtdCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aGlsZSBwYXJ0czoKICAgICAgICAgICAgICAgIG51bXMuaW5zZXJ0KDAsIGludChwYXJ0cy4gICAoInRpdGxlIiwgbW9kZWxzLkNoYXJGaWVsZChtYXhfbGVuZ3RoPTEwMCkpLAogICAgICAgICAgICBdLAogICAgICAgICAgICBvcHRpb25zPXsKICAgICAgICAgICAgICAgICJtYW5hZ2VkIjogRmFsc2UsCiAgICAgICAgICAgIH0sCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFsdGVyRmllbGQoCiAgICAgICAgICAgIG1vZGVsX25hbWU9ImJvb2siLAogICAgICAgICAgICBuYW1lPSJpZCIsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5CaWdBdXRvRmllbGQoCiAgICAgICAgICAgICAgICBhdXRvX2NyZWF0ZWQ9VHJ1ZSwgcHJpbWFyeV9rZXk9VHJ1ZSwgc2VyaWFsaXplPUZhbHNlLCB2ZXJib3NlX25hbWU9IklEIgogICAgICAgICAgICApLAogICAgICAgICksCiAgICBdCmltcG9ydCB1bml0dGVzdAoKZnJvbSBkamFuZ28uY29yZS5tYW5hZ2VtZW50LmNvbG9yIGltcG9ydCBub19zdHlsZQpmcm9tIGRqYW5nby5kYiBpbXBvcnQgY29ubmVjdGlvbgpmcm9tIGRqYW5nby50ZXN0IGltcG9ydCBUcmFuc2FjdGlvblRlc3RDYXNlCgpmcm9tIC4ubW9kZWxzIGltcG9ydCBQZXJzb24sIFRhZwoKCkB1bml0dGVzdC5za2lwVW5sZXNzKGNvbm5lY3Rpb24udmVuZG9yID09ICJvcmFjbGUiLCAiT3JhY2xlIHRlc3RzIikKY2xhc3MgT3BlcmF0aW9uc1Rlc3RzKFRyYW5zYWN0aW9uVGVzdENhc2UpOgogICAgYXZhaWxhYmxlX2FwcHMgPSBbImJhY2tlbmRzIl0KCiAgICBkZWYgdGVzdF9zZXF1ZW5jZV9uYW1lX3RydW5jYXRpb24oc2VsZik6CiAgICAgICAgc2VxX25hbWUgPSBjb25uZWN0aW9uLm9wcy5fZ2V0X25vX2F1dG9maWVsZF9zZXF1ZW5jZV9uYW1lKAogICAgICAgICAgICAic2NoZW1hX2F1dGhvcndpdGhldmVubG9uZ2VlODY5IgogICAgICAgICkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHNlcV9uYW1lLCAiU0NIRU1BX0FVVEhPUldJVEhFVkVOTE9CMEI4X1NRIikKCiAgICBkZWYgdGVzdF9zcWxfZmx1c2goc2VsZik6CiAgICAgICAgc3RhdGVtZW50cyA9IGNvbm5lY3Rpb24ub3BzLnNxbF9mbHVzaCgKICAgICAgICAgICAgbm9fc3R5bGUoKSwKICAgICAgICAgICAgW1BlcnNvbi5fbWV0YS5kYl90YWJsZSwgVGFnLl9tZXRhLmRiX3RhYmxlXSwKICAgICAgICApCiAgICAgICAgIyBUaGUgdGFibGVzIGFuZCBjb25zdHJhaW50cyBhcmUgcHJvY2Vzc2VkIGluIGFuIHVub3JkZXJlZCBzZXQuCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgKICAgICAgICAgICAgc3RhdGVtZW50c1swXSwKICAgICAgICAgICAgJ0FMVEVSIFRBQkxFICJCQUNLRU5EU19UQUciIERJU0FCTEUgQ09OU1RSQUlOVCAnCiAgICAgICAgICAgICciQkFDS0VORFNfX0NPTlRFTlRfVF9GRDlEN0E4NV9GIiBLRUVQIElOREVYOycsCiAgICAgICAgKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoCiAgICAgICAgICAgIHNvcnRlZChzdGF0ZW1lbnRzWzE6LTFdKSwKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgJ1RSVU5DQVRFIFRxdWFsKCgibm8gYWN0aXZlIGlucHV0KCkiLCksIGNtLmV4Y2VwdGlvbi5hcmdzKQogICAgICAgIHNlbGYuYXNzZXJ0SXNOb25lKGZpbGVpbnB1dC5fc3RhdGUpCgogICAgZGVmIHRlc3Rfc3RhdGVfaXNfbm90X05vbmUoc2VsZik6CiAgICAgICAgIiIiVGVzdHMgZmlsZWlucHV0Lmlzc3RkaW4oKSB3aGVuIGZpbGVpbnB1dC5fc3RhdGUgaXMgbm90IE5vbmUuCiAgICAgICAgICAgRW5zdXJlIHRoYXQgaXQgaW52b2tlcyBmaWxlaW5wdXQuX3N0YXRlLmlzc3RkaW4oKSBleGFjdGx5IG9uY2UsCiAgICAgICAgICAgcmV0dXJucyB3aGF0ZXZlciBpdCByZXR1cm5zLCBhbmQgZG9lcyBub3QgbW9kaWZ5IGZpbGVpbnB1dC5fc3RhdGUKICAgICAgICAgICB0byBwb2ludCB0byBhIGRpZmZlcmVudCBvYmplY3QuIiIiCiAgICAgICAgaXNzdGRpbl9yZXR2YWwgPSBvYmplY3QoKQogICAgICAgIGluc3RhbmNlID0gTW9ja0ZpbGVJbnB1dCgpCiAgICAgICAgaW5zdGFuY2UucmV0dXJuX3ZhbHVlc1siaXNzdGRpbiJdID0gaXNzdGRpbl9yZXR2YWwKICAgICAgICBmaWxlaW5wdXQuX3N0YXRlID0gaW5zdGFuY2UKICAgICAgICByZXR2YWwgPSBmaWxlaW5wdXQuaXNzdGRpbigpCiAgICAgICAgc2VsZi5hc3NlcnRFeGFjdGx5T25lSW52b2NhdGlvbihpbnN0YW5jZSwgImlzc3RkaW4iKQogICAgICAgIHNlbGYuYXNzZXJ0SXMocmV0dmFsLCBpc3N0ZGluX3JldHZhbCkKICAgICAgICBzZWxmLmFzc2VydElzKGZpbGVpbnB1dC5fc3RhdGUsIGluc3RhbmNlKQoKY2xhc3MgSW52b2NhdGlvblJlY29yZGVyOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmludm9jYXRpb25fY291bnQgPSAwCgogICAgZGVmIF9fY2FsbF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgc2VsZi5pbnZvY2F0aW9uX2NvdW50ICs9IDEKICAgICAgICBzZWxmLmxhc3RfaW52b2NhdGlvbiA9IChhcmdzLCBrd2FyZ3MpCiAgICAgICAgcmV0dXJuIGlvLkJ5dGVzSU8oYidzb21lIGJ5dGVzJykKCgpjbGFzcyBUZXN0X2hvb2tfY29tcHJlc3NlZCh1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICAiIiJVbml0IHRlc3RzIGZvciBmaWxlaW5wdXQuaG9va19jb21wcmVzc2VkKCkiIiIKCiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgc2VsZi5mYWtlX29wZW4gPSBJbnZvY2F0aW9uUmVjb3JkZXIoKQoKICAgIGRlZiB0ZXN0X2VtcHR5X3N0cmluZyhzZWxmKToKICAgICAgICBzZWxmLmRvX3Rlc3RfdXNlX2J1aWx0aW5fb3Blbl90ZXh0KCIiLCAiciIpCgogICAgZGVmIHRlc3Rfbm9fZXh0KHNlbGYpOgogICAgICAgIHNlbGYuZG9fdGVzdF91c2VfYnVpbHRpbl9vcGVuX3RleHQoImFiY2QiLCAiciIpCgogICAgQHVuaXR0ZXN0LnNraXBVbmxlc3MoZ3ppcCwgIlJlcXVpcmVzIGd6aXAgYW5kIHpsaWIiKQogICAgZGVmIHRlc3RfZ3pfZXh0X2Zha2Uoc2VsZik6CiAgICAgICAgb3JpZ2luYWxfb3BlbiA9IGd6aXAub3BlbgogICAgICAgIGd6aXAub3BlbiBodHRwcz1yZXF1ZXN0LmlzX3NlY3VyZSgpLAogICAgICAgICkKICAgICAgICByZXR1cm4gcmVkaXJlY3RfdG8gaWYgdXJsX2lzX3NhZmUgZWxzZSAiIgoKICAgIGRlZiBnZXRfc3VjY2Vzc191cmxfYWxsb3dlZF9ob3N0cyhzZWxmLCByZXF1ZXN0PU5vbmUpOgogICAgICAgIGlmIHJlcXVlc3QgaXMgTm9uZToKICAgICAgICAgICAgcmVxdWVzdCA9IHNlbGYucmVxdWVzdAogICAgICAgIHJldHVybiB7cmVxdWVzdC5nZXRfaG9zdCgpLCAqc2VsZi5zdWNjZXNzX3VybF9hbGxvd2VkX2hvc3RzfQoKICAgIGRlZiBnZXRfZGVmYXVsdF9yZWRpcmVjdF91cmwoc2VsZik6CiAgICAgICAgIiIiUmV0dXJuIHRoZSBkZWZhdWx0IHJlZGlyZWN0IFVSTC4iIiIKICAgICAgICBpZiBzZWxmLm5leHRfcGFnZToKICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVfdXJsKHNlbGYubmV4dF9wYWdlKQogICAgICAgIHJhaXNlIEltcHJvcGVybHlDb25maWd1cmVkKCJObyBVUkwgdG8gcmVkaXJlY3QgdG8uIFByb3ZpZGUgYSBuZXh0X3BhZ2UuIikKCgpAbWV0aG9kX2RlY29yYXRvcigKICAgIFtsb2dpbl9ub3RfcmVxdWlyZWQsIHNlbnNpdGl2ZV9wb3N0X3BhcmFtZXRlcnMoKSwgY3NyZl9wcm90ZWN0LCBuZXZlcl9jYWNoZV0sCiAgICBuYW1lPSJkaXNwYXRjaCIsCikKY2xhc3MgTG9naW5WaWV3KFJlZGlyZWN0VVJMTWl4aW4sIEZvcm1WaWV3KToKICAgICIiIgogICAgRGlzcGxheSB0aGUgbG9naW4gZm9ybSBhbmQgaGFuZGxlIHRoZSBsb2dpbiBhY3Rpb24uCiAgICAiIiIKCiAgICBmb3JtX2NsYXNzID0gQXV0aGVudGljYXRpb25Gb3JtCiAgICBhdXRoZW50aWNhdGlvbl9mb3JtID0gTm9uZQogICAgdGVtcGxhdGVfbmFtZSA9ICJyZWdpc3RyYXRpb24vbG9naW4uaHRtbCIKICAgIHJlZGlyZWN0X2F1dGhlbnRpY2F0ZWRfdXNlciA9IEZhbHNlCiAgICBleHRyYV9jb250ZXh0ID0gTm9uZQoKICAgIGRlZiBkaXNwYXRjaChzZWxmLCByZXF1ZXN0LCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgIGlmIHNlbGYucmVkaXJlY3RfYXV0aGVudGljYXRlZF91c2VyIGFuZCBzZWxmLnJlcXVlc3QudXNlci5pc19hdXRoZW50aWNhdGVkOgogICAgICAgICAgICByZWRpcmVjdF90byA9IHNlbGYuZ2V0X3N1Y2Nlc3NfdXJsKCkKICAgICAgICAgICAgaWYgcmVkaXJlY3RfdG8gPT0gc2VsZi5yZXF1ZXN0LnBhdGg6CiAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgICAgICJSZWRpcmVjdGlvbiBsb29wIGZvciBhdXRoZW50aWNhdGVkIHVzZXIgZGV0ZWN0ZWQuIENoZWNrIHRoYXQgIgogICAgICAgICAgICAgICAgICAgICJ5b3VyIExPR0lOX1JFRElSRUNUX1VSTCBkb2Vzbid0IHBvaW50IHRvIGEgbG9naW4gcGFnZS4iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIHJldHVybiBIdHRwUmVzcG9uc2VSZWRpcmVjdChyZWRpcmVjdF90bykKICAgICAgICByZXR1cm4gc3VwZXIoKS5kaXNwYXRjaChyZXF1ICAgIlNlZTogJiN4Mjc7JmVhY3V0ZTsgaXMgYW4gYXBvc3Ryb3BoZSBmb2xsb3dlZCBieSBlIGFjdXRlIiwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgKCI8YWRmPmEiLCAiYSIpLAogICAgICAgICAgICAoIjwvYWRmPmEiLCAiYSIpLAogICAgICAgICAgICAoIjxhc2RmPjxhc2RmPmUiLCAiZSIpLAogICAgICAgICAgICAoImhpLCA8ZiB4IiwgImhpLCA8ZiB4IiksCiAgICAgICAgICAgICgiMjM0PDIzNSwgcmlnaHQ/IiwgIjIzNDwyMzUsIHJpZ2h0PyIpLAogICAgICAgICAgICAoImE0PGE1IHJpZ2h0PyIsICJhNDxhNSByaWdodD8iKSwKICAgICAgICAgICAgKCJiNz5iMiEiLCAiYjc+YjIhIiksCiAgICAgICAgICAgICgiPC9mZSIsICI8L2ZlIiksCiAgICAgICAgICAgICgiPHg+Yjx5PiIsICJiIiksCiAgICAgICAgICAgICgiYTxwIG9uY2xpY2s9XCJhbGVydCgnPHRlc3Q+JylcIj5iPC9wPmMiLCAiYWJjIiksCiAgICAgICAgICAgICgiYTxwIGEgPmI8L3A+YyIsICJhYmMiKSwKICAgICAgICAgICAgKCJkPGE6YiBjOmQ+ZTwvcD5mIiwgImRlZiIpLAogICAgICAgICAgICAoJzxzdHJvbmc+Zm9vPC9zdHJvbmc+PGEgaHJlZj0iaHR0cDovL2V4YW1wbGUuY29tIj5iYXI8L2E+JywgImZvb2JhciIpLAogICAgICAgICAgICAjIGNhdXNlZCBpbmZpbml0ZSBsb29wIG9uIFB5dGhvbnMgbm90IHBhdGNoZWQgd2l0aAogICAgICAgICAgICAjIGh0dHBzOi8vYnVncy5weXRob24ub3JnL2lzc3VlMjAyODgKICAgICAgICAgICAgKCImZ290Y2hhJiM7PD4iLCAiJmdvdGNoYSYjOzw+IiksCiAgICAgICAgICAgICgiPHNjPCEtLSAtLT5yaXB0PnRlc3Q8PCEtLSAtLT4vc2NyaXB0PiIsICJyaXB0PnRlc3QiKSwKICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgIjxzY3JpcHQ+YWxlcnQoKTwvc2NyaXB0PiZoIiwKICAgICAgICAgICAgICAgICJhbGVydCgpJmg7IiBpZiBodG1scGFyc2VyX2ZpeGVkX2luY29tcGxldGVfZW50aXRpZXMgZWxzZSAiYWxlcnQoKWgiLAogICAgICAgICAgICApLAogICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAiPjwhIiArICgiJiIgKiAxNjAwMCkgKyAiRCIsCiAgICAgICAgICAgICAgICAiPiIgaWYgaHRtbHBhcnNlcl9maXhlZF9zZWN1cml0eSBlbHNlICI+PCEiICsgKCImIiAqIDE2MDAwKSArICJEIiwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgKCJYPDw8PGJyPmJyPmJyPmJyPlgiLCAiWFgiKSwKICAgICAgICAgICAgKCI8IiAqIDUwICsgImE+IiAqIDUwLCAiIiksCiAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICI+IiArICI8YSIgKiA1MDAgKyAiYSIsCiAgICAgICAgICAgICAgICAiPiIgaWYgaHRtbHBhcnNlcl9maXhlZF9zZWN1cml0eSBlbHNlICI+IiArICI8YSIgKiA1MDAgKyAiYSIsCiAgICAgICAgICAgICksCiAgICAgICAgICAgICgiPGEiICogNDkgKyAiYSIgKiA5NTEsICI8YSIgKiA0OSArICJhIiAqIDk1MSksCiAgICAgICAgICAgICgiPCIgKyAiYSIgKiAxXzAwMiwgICAiRm9sbG93aW5nIG1vZHVsZXMgYnVpbHQgc3VjY2Vzc2Z1bGx5ICIKICAgICAgICAgICAgICAgICJidXQgd2VyZSByZW1vdmVkIGJlY2F1c2UgdGhleSBjb3VsZCBub3QgYmUgaW1wb3J0ZWQ6IgogICAgICAgICAgICApCiAgICAgICAgICAgIHByaW50X3RocmVlX2NvbHVtbihzZWxmLmZhaWxlZF9vbl9pbXBvcnQpCiAgICAgICAgICAgIHByaW50KCkKCiAgICAgICAgaWYgYW55KAogICAgICAgICAgICBtb2RpbmZvLm5hbWUgPT0gIl9zc2wiIGZvciBtb2RpbmZvIGluIHNlbGYubWlzc2luZyArIHNlbGYuZmFpbGVkX29uX2ltcG9ydAogICAgICAgICk6CiAgICAgICAgICAgIHByaW50KCJDb3VsZCBub3QgYnVpbGQgdGhlIHNzbCBtb2R1bGUhIikKICAgICAgICAgICAgcHJpbnQoIlB5dGhvbiByZXF1aXJlcyBhIE9wZW5TU0wgMS4xLjEgb3IgbmV3ZXIiKQogICAgICAgICAgICBpZiBzeXNjb25maWcuZ2V0X2NvbmZpZ192YXIoIk9QRU5TU0xfTERGTEFHUyIpOgogICAgICAgICAgICAgICAgcHJpbnQoIkN1c3RvbSBsaW5rZXIgZmxhZ3MgbWF5IHJlcXVpcmUgLS13aXRoLW9wZW5zc2wtcnBhdGg9YXV0byIpCiAgICAgICAgICAgIHByaW50KCkKCiAgICAgICAgZGlzYWJsZWQgPSBsZW4oc2VsZi5kaXNhYmxlZF9jb25maWd1cmUpICsgbGVuKHNlbGYuZGlzYWJsZWRfc2V0dXApCiAgICAgICAgcHJpbnQoCiAgICAgICAgICAgIGYiQ2hlY2tlZCB7bGVuKHNlbGYubW9kdWxlcyl9IG1vZHVsZXMgKCIKICAgICAgICAgICAgZiJ7bGVuKHNlbGYuYnVpbHRpbl9vayl9IGJ1aWx0LWluLCAiCiAgICAgICAgICAgIGYie2xlbihzZWxmLnNoYXJlZF9vayl9IHNoYXJlZCwgIgogICAgICAgICAgICBmIntsZW4oc2VsZi5ub3RhdmFpbGFibGUpfSBuL2Egb24ge3NlbGYucGxhdGZvcm19LCAiCiAgICAgICAgICAgIGYie2Rpc2FibGVkfSBkaXNhYmxlZCwgIgogICAgICAgICAgICBmIntsZW4oc2VsZi5taXNzaW5nKX0gbWlzc2luZywgIgogICAgICAgICAgICBmIntsZW4oc2VsZi5mYWlsZWRfb25faW1wb3J0KX0gZmFpbGVkIG9uIGltcG9ydCkiCiAgICAgICAgKQoKICAgIGRlZiBjaGVja19zdHJpY3RfYnVpbGQoc2VsZikgLT4gTm9uZToKICAgICAgICAiIiJGYWlsIGlmIG1vZHVsZXMgYXJlIG1pc3NpbmcgYW5kIGl0J3MgYSBzdHJpY3QgYnVpbGQiIiIKICAgICAgICBpZiBzZWxmLnN0cmljdF9leHRlbnNpb25zX2J1aWxkIGFuZCAoc2VsZi5mYWlsZWRfb25faW1wb3J0IG9yIHNlbGYubWlzc2luZyk6CiAgICAgICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcigiRmFpbGVkIHRvIGJ1aWxkIHNvbWUgc3RkbGliIG1vZHVsZXMiKQoKICAgIGRlZiBsaXN0X21vZHVsZV9uYW1lcyhzZWxmLCAqLCBhbGw6IGJvb2wgPSBGYWxzZSkgLT4gc2V0W3N0cl06CiAgICAgICAgbmFtZXMgPSB7bW9kaW5mby5uYW1lIGZvciBtb2RpbmZvIGluIHNlbGYubW9kdWxlc30KICAgICAgICBpZiBhbGw6CiAgICAgICAgICAgIG5hbWVzLnVwZGF0ZShXSU5ETyd0IGFsc28gZ290dGVuIHJlbWFwcGVkIHRvIHRoZSBvdGhlciByZXBsYWNlZAogICAgICAgICMgbm9kZS4KICAgICAgICBvdGhlcl9yZXBsYWNlZF9ub2RlID0gZ3JhcGgubm9kZV9tYXBbKCJhcHBfYSIsICIwMDAxIildCiAgICAgICAgc2VsZi5hc3NlcnROb3RJbihjaGlsZF9ub2RlLCBvdGhlcl9yZXBsYWNlZF9ub2RlLmNoaWxkcmVuKQogICAgICAgIHNlbGYuYXNzZXJ0Tm90SW4ob3RoZXJfcmVwbGFjZWRfbm9kZSwgY2hpbGRfbm9kZS5wYXJlbnRzKQoKICAgIGRlZiB0ZXN0X2luZmluaXRlX2xvb3Aoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgVGVzdHMgYSBjb21wbGV4IGRlcGVuZGVuY3kgZ3JhcGg6CgogICAgICAgIGFwcF9hOiAgICAgICAgMDAwMSA8LQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKICAgICAgICBhcHBfYjogICAgICAgIDAwMDEgPC0geCAwMDAyIDwtCiAgICAgICAgICAgICAgICAgICAgICAgLyAgICAgICAgICAgICAgIFwKICAgICAgICBhcHBfYzogICAwMDAxPC0gIDwtLS0tLS0tLS0tLS0tIHggMDAwMgoKICAgICAgICBBbmQgYXBwbHkgc3F1YXNoaW5nIG9uIGFwcF9jLgogICAgICAgICIiIgogICAgICAgIGdyYXBoID0gTWlncmF0aW9uR3JhcGgoKQoKICAgICAgICBncmFwaC5hZGRfbm9kZSgoImFwcF9hIiwgIjAwMDEiKSwgTm9uZSkKICAgICAgICBncmFwaC5hZGRfbm9kZSgoImFwcF9iIiwgIjAwMDEiKSwgTm9uZSkKICAgICAgICBncmFwaC5hZGRfbm9kZSgoImFwcF9iIiwgIjAwMDIiKSwgTm9uZSkKICAgICAgICBncmFwaC5hZGRfbm9kZSgoImFwcF9jIiwgIjAwMDFfc3F1YXNoZWRfMDAwMiIpLCBOb25lKQoKICAgICAgICBncmFwaC5hZGRfZGVwZW5kZW5jeSgKICAgICAgICAgICAgImFwcF9iLjAwMDEiLCAoImFwcF9iIiwgIjAwMDEiKSwgKCJhcHBfYyIsICIwMDAxX3NxdWFzaGVkXzAwMDIiKQogICAgICAgICkKICAgICAgICBncmFwaC5hZGRfZGVwZW5kZW5jeSgiYXBwX2IuMDAwMiIsICgiYXBwX2IiLCAiMDAwMiIpLCAoImFwcF9hIiwgIjAwMDEiKSkKICAgICAgICBncmFwaC5hZGRfZGVwZW5kZW5jeSgiYXBwX2IuMDAwMiIsICgiYXBwX2IiLCAiMDAwMiIpLCAoImFwcF9iIiwgIjAwMDEiKSkKICAgICAgICBncmFwaC5hZGRfZGVwZW5kZW5jeSgKICAgICAgICAgICAgImFwcF9jLjAwMDFfc3F1YXNoZWRfMDAwMiIsCiAgICAgICAgICAgICgiYXBwX2MiLCAiMDAwMV9zcXVhc2hlZF8wMDAyIiksCiAgICAgICAgICAgICgiYXBwX2IiLCAiMDAwMiIpLAogICAgICAgICkKCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFJhaXNlcyhDaXJjdWxhckRlcGVuZGVuY3lFcnJvcik6CiAgICAgICAgICAgIGdyYXBoLmVuc3VyZV9ub3RfY3ljbGljKCkKCiAgICBkZWYgdGVzdF9zdHJpbmdpZnkoc2VsZik6CiAgICAgICAgZ3JhcGggPSBNaWdyYXRpb25HcmFwaCgpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzdHIoZ3JhcGgpLCAiR3JhcGg6IDAgbm9kZXMsIDAgZWRnZXMiKQoKIHJvcigicmVkdWN0aW9uIGZ1bmN0aW9ucyBtdXN0IGJlIGNhbGxhYmxlIikKICAgIGRpc3BhdGNoX3RhYmxlW29iX3R5cGVdID0gcGlja2xlX2Z1bmN0aW9uCgogICAgIyBUaGUgY29uc3RydWN0b3Jfb2IgZnVuY3Rpb24gaXMgYSB2ZXN0aWdlIG9mIHNhZmUgZm9yIHVucGlja2xpbmcuCiAgICAjIFRoZXJlIGlzIG5vIHJlYXNvbiBmb3IgdGhlIGNhbGxlciB0byBwYXNzIGl0IGFueW1vcmUuCiAgICBpZiBjb25zdHJ1Y3Rvcl9vYiBpcyBub3QgTm9uZToKICAgICAgICBjb25zdHJ1Y3Rvcihjb25zdHJ1Y3Rvcl9vYikKCmRlZiBjb25zdHJ1Y3RvcihvYmplY3QpOgogICAgaWYgbm90IGNhbGxhYmxlKG9iamVjdCk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKCJjb25zdHJ1Y3RvcnMgbXVzdCBiZSBjYWxsYWJsZSIpCgojIEV4YW1wbGU6IHByb3ZpZGUgcGlja2xpbmcgc3VwcG9ydCBmb3IgY29tcGxleCBudW1iZXJzLgoKZGVmIHBpY2tsZV9jb21wbGV4KGMpOgogICAgcmV0dXJuIGNvbXBsZXgsIChjLnJlYWwsIGMuaW1hZykKCnBpY2tsZShjb21wbGV4LCBwaWNrbGVfY29tcGxleCwgY29tcGxleCkKCmRlZiBwaWNrbGVfdW5pb24ob2JqKToKICAgIGltcG9ydCB0eXBpbmcsIG9wZXJhdG9yCiAgICByZXR1cm4gb3BlcmF0b3IuZ2V0aXRlbSwgKHR5cGluZy5Vbmlvbiwgb2JqLl9fYXJnc19fKQoKcGlja2xlKHR5cGUoaW50IHwgc3RyKSwgcGlja2xlX3VuaW9uKQoKZGVmIHBpY2tsZV9zdXBlcihvYmopOgogICAgcmV0dXJuIHN1cGVyLCAob2JqLl9fdGhpc2NsYXNzX18sIG9iai5fX3NlbGZfXykKCnBpY2tsZShzdXBlciwgcGlja2xlX3N1cGVyKQoKIyBTdXBwb3J0IGZvciBwaWNrbGluZyBuZXctc3R5bGUgb2JqZWN0cwoKZGVmIF9yZWNvbnN0cnVjdG9yKGNscywgYmFzZSwgc3RhdGUpOgogICAgaWYgYmFzZSBpcyBvYmplY3Q6CiAgICAgICAgb2JqID0gb2JqZWN0Ll9fbmV3X18oY2xzKQogICAgZWxzZToKICAgICAgICBvYmogPSBiYXNlLl9fbmV3X18oY2xzLCBzdGF0ZSkKICAgICAgICBpZiBiYXNlLl9faW5pdF9fICE9IG9iamVjdC5fX2luaXRfXzoKICAgICAgICAgICAgYmFzZS5fX2luaXRfXyhvYmosIHN0YXRlKQogICAgcmV0dXJuIG9iagoKX0hFQVBUWVBFID0gMTw8OQpfbmV3X3R5cGUgPSB0eXBlKGludC5fX25ld19fKQoKIyBQeXRob24gY29kZSBmb3Igb2JqZWN0Ll9fcmVkdWNlX2V4X18gZm9yIHByb3RvY29scyAwIGFuZCAxCgpkZWYgX3JlZHVjZV9leChzZWxmLCBwcm90byk6CiAgICBhc3NlcnQgcHJvdG8gPCAyCiAgICBjbHMgPSBzZWxmLl9fY2xhc3NfXwogICAgZm9yIGJhc2UgaW4gY2xzLl9fbXJvX186CiAgICAgICAgaWYgaGFzYXR0cihiYXNlLCAnX19mbGFnc19fJykgYW5kIG5vdCBiYXNlLl9fZmxhZ3NfXyAmIF9IRUFQVFlQRToKICAgICAgICAgICAgYnJlYWsKICAgICAgICBuZXcgPSBiYXNlLl9fbmV3X18KICAgICAgICBpZiBpc2luc3RhbmNlKG5ldywgX25ld190eXBlKSBhbmQgbmV3Ll9fc2VsZl9fIG8gcnVuLgoKQ2FsbGVkIGJ5IGBgLmdpdGh1Yi93b3JrZmxvd3MvcmV1c2FibGUtY29udGV4dC55bWxgYC4KV2Ugb25seSB3YW50IHRvIHJ1biB0ZXN0cyBvbiBQUnMgd2hlbiByZWxhdGVkIGZpbGVzIGFyZSBjaGFuZ2VkLApvciB3aGVuIHNvbWVvbmUgdHJpZ2dlcnMgYSBtYW51YWwgd29ya2Zsb3cgcnVuLgpUaGlzIGltcHJvdmVzIGRldmVsb3BlciBleHBlcmllbmNlIGJ5IG5vdCBkb2luZyAoc2xvdykKdW5uZWNlc3Nhcnkgd29yayBpbiBHSEEsIGFuZCBzYXZlcyBDSSByZXNvdXJjZXMuCiIiIgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCBhbm5vdGF0aW9ucwoKaW1wb3J0IG9zCmltcG9ydCBzdWJwcm9jZXNzCmZyb20gZGF0YWNsYXNzZXMgaW1wb3J0IGRhdGFjbGFzcywgZmllbGRzCmZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aAoKVFlQRV9DSEVDS0lORyA9IEZhbHNlCmlmIFRZUEVfQ0hFQ0tJTkc6CiAgICBmcm9tIGNvbGxlY3Rpb25zLmFiYyBpbXBvcnQgU2V0CgpHSVRIVUJfREVGQVVMVF9CUkFOQ0ggPSBvcy5lbnZpcm9uWyJHSVRIVUJfREVGQVVMVF9CUkFOQ0giXQpHSVRIVUJfV09SS0ZMT1dTX1BBVEggPSBQYXRoKCIuZ2l0aHViL3dvcmtmbG93cyIpCgpSVU5fVEVTVFNfSUdOT1JFID0gZnJvemVuc2V0KHsKICAgIFBhdGgoIlRvb2xzL2NoZWNrLWMtYXBpLWRvY3MvaWdub3JlZF9jX2FwaS50eHQiKSwKICAgIFBhdGgoIi5naXRodWIvQ09ERU9XTkVSUyIpLAogICAgUGF0aCgiLnByZS1jb21taXQtY29uZmlnLnlhbWwiKSwKICAgIFBhdGgoIi5ydWZmLnRvbWwiKSwKICAgIFBhdGgoIm15cHkuaW5pIiksCn0pCgpVTklYX0JVSUxEX1NZU1RFTV9GSUxFX05BTUVTID0gZnJvemVuc2V0KHsKICAgIFBhdGgoImFjbG9jYWwubTQiKSwKICAgIFBhdGgoImNvbmZpZy5ndWVzcyIpLAogICAgUGF0aCgiY29uZmlnLnN1YiIpLAogICAgUGF0aCgiY29uZmlndXJlIiksCiAgICBQYXRoKCJjb25maWd1cmUuYWMiKSwKICAgIFBhdGgoImluc3RhbGwtc2giKSwKICAgIFBhdGgoIk1ha2VmaWxlLnByZS5pbiIpLAogICAgUGF0aCgiTW9kdWxlcy9tYWtlc2V0dXAiKSwKICAgIFBhdGgoIk1vZHVsZXMvU2V0dXAiKSwKICAgIFBhdGgoIk1vZHVsZXMvU2V0dXAuYm9vdHN0cmFwLmluIiksCiAgICBQYXRoKCJNb2R1bGVzL1NldHVwLnN0ZGxpYi5pbiIpLAogICAgUGF0aCgiVG9vbHMvYnVpbGQvcmVnZW4tY29uZmlndXJlLnNoIiksCn0pCgpTVUZGSVhFU19DX09SX0NQUCA9IGZyb3plbnNldCh7Ii5jIiwgIi5oIiwgIi5jcHAifSkKU1VGRklYRVNfRE9DVU1FTlRBVElPTiA9IGZyb3plbnNldCh7Ii5yc3QiLCAiLm1kIn0pCgpBTkRST0lEX0RJUlMgPSBmcm96ZW5zZXQoeyJBbmRyb2lkIn0pCklPU19ESVJTID0gZnJvemVuc2V0KHsiQXBwbGUiLCAiaU9TIn0pCk1BQ09TX0RJUlMgPSBmcm96ZW5zZXQoeyJNYWMifSkKV0FTSV9ESVJTID0gZnJvemVuc2V0KHtQYXRoKCJQbGF0Zm9ybXMiLCAiV0FTSSIpfSkKCkxJQlJBUllfRlVaWkVSX1BBVCBhbiBvcy53cml0ZSB0aGF0IG9ubHkgd3JpdGVzIHBhcnRpYWwgZGF0YS4KICAgICAgICBkZWYgd3JpdGUoZmQsIGRhdGEpOgogICAgICAgICAgICBpZiBzZWxmLnNlZW5fd3JpdGUgYW5kIHNlbGYubmV2ZXJfY29tcGxldGU6CiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICBzZWxmLnNlZW5fd3JpdGUgPSBUcnVlCiAgICAgICAgICAgIHJldHVybiBvbGR3cml0ZShmZCwgZGF0YVs6c2VsZi50cnVuY2F0ZV9hdF9sZW5ndGhdKQoKICAgICAgICAjIE5lZWQgdG8gcGF0Y2ggX2lvIHRvIGJlIF9weWlvLCBzbyB0aGF0IGlvLkZpbGVJTyBpcyBhZmZlY3RlZCBieSB0aGUKICAgICAgICAjIG9zLndyaXRlIHBhdGNoLgogICAgICAgIHNlbGYuY2hpbGRyZW4gPSBbCiAgICAgICAgICAgIHN1cHBvcnQuc3dhcF9hdHRyKF9ib290c3RyYXBfZXh0ZXJuYWwsICdfaW8nLCBfcHlpbyksCiAgICAgICAgICAgIHN1cHBvcnQuc3dhcF9hdHRyKG9zLCAnd3JpdGUnLCB3cml0ZSkKICAgICAgICBdCiAgICAgICAgZm9yIGNoaWxkIGluIHNlbGYuY2hpbGRyZW46CiAgICAgICAgICAgIGNoaWxkLl9fZW50ZXJfXygpCiAgICAgICAgcmV0dXJuIHNlbGYKCiAgICBkZWYgX19leGl0X18oc2VsZiwgZXhjX3R5cGUsIGV4Y192YWwsIGV4Y190Yik6CiAgICAgICAgZm9yIGNoaWxkIGluIHNlbGYuY2hpbGRyZW46CiAgICAgICAgICAgIGNoaWxkLl9fZXhpdF9fKGV4Y190eXBlLCBleGNfdmFsLCBleGNfdGIpCgoKY2xhc3MgTWlzY1Rlc3RzKHVuaXR0ZXN0LlRlc3RDYXNlKToKCiAgICBkZWYgdGVzdF9hdG9taWNfd3JpdGVfcmV0cmllc19pbmNvbXBsZXRlX3dyaXRlcyhzZWxmKToKICAgICAgICB0cnVuY2F0ZV9hdF9sZW5ndGggPSAxMDAKICAgICAgICBsZW5ndGggPSB0cnVuY2F0ZV9hdF9sZW5ndGggKiAyCgogICAgICAgIHdpdGggUGF0Y2hBdG9taWNXcml0ZXModHJ1bmNhdGVfYXRfbGVuZ3RoPXRydW5jYXRlX2F0X2xlbmd0aCkgYXMgY206CiAgICAgICAgICAgICMgTWFrZSBzdXJlIHdlIHdyaXRlIHNvbWV0aGluZyBsb25nZXIgdGhhbiB0aGUgcG9pbnQgd2hlcmUgd2UKICAgICAgICAgICAgIyB0cnVuY2F0ZS4KICAgICAgICAgICAgY29udGVudCA9IGIneCcgKiBsZW5ndGgKICAgICAgICAgICAgX2Jvb3RzdHJhcF9leHRlcm5hbC5fd3JpdGVfYXRvbWljKG9zX2hlbHBlci5URVNURk4sIGNvbnRlbnQpCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKGNtLnNlZW5fd3JpdGUpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwob3Muc3RhdChzdXBwb3J0Lm9zX2hlbHBlci5URVNURk4pLnN0X3NpemUsIGxlbmd0aCkKICAgICAgICBvcy51bmxpbmsoc3VwcG9ydC5vc19oZWxwZXIuVEVTVEZOKQoKICAgIGRlZiB0ZXN0X2F0b21pY193cml0ZV9lcnJvcnNfaWZfdW5hYmxlX3RvX2NvbXBsZXRlKHNlbGYpOgogICAgICAgIHRydW5jYXRlX2F0X2xlbmd0aCA9IDEwMAoKICAgICAgICB3aXRoICgKICAgICAgICAgICAgUGF0YyAgJ3JlcXVpcmVzIHN5cy5pbXBsZW1lbnRhdGlvbi5jYWNoZV90YWcgdG8gbm90IGJlIE5vbmUnKQogICAgZGVmIHRlc3Rfc291cmNlX2Zyb21fY2FjaGVfcGF0aF9saWtlX2FyZyhzZWxmKToKICAgICAgICBwYXRoID0gcGF0aGxpYi5QdXJlUGF0aCgnZm9vJywgJ2JhcicsICdiYXonLCAnX19weWNhY2hlX18nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdxdXgue30ucHljJy5mb3JtYXQoc2VsZi50YWcpKQogICAgICAgIGV4cGVjdCA9IG9zLnBhdGguam9pbignZm9vJywgJ2JhcicsICdiYXonLCAncXV4LnB5JykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHNlbGYudXRpbC5zb3VyY2VfZnJvbV9jYWNoZShwYXRoKSwgZXhwZWN0KQoKICAgIEB1bml0dGVzdC5za2lwSWYoc3lzLmltcGxlbWVudGF0aW9uLmNhY2hlX3RhZyBpcyBOb25lLAogICAgICAgICAgICAgICAgICAgICAncmVxdWlyZXMgc3lzLmltcGxlbWVudGF0aW9uLmNhY2hlX3RhZyB0byBub3QgYmUgTm9uZScpCiAgICBkZWYgdGVzdF9jYWNoZV9mcm9tX3NvdXJjZV9yZXNwZWN0c19weWNhY2hlX3ByZWZpeChzZWxmKToKICAgICAgICAjIElmIHB5Y2FjaGVfcHJlZml4IGlzIHNldCwgY2FjaGVfZnJvbV9zb3VyY2Ugd2lsbCByZXR1cm4gYSBieXRlY29kZQogICAgICAgICMgcGF0aCBpbnNpZGUgdGhhdCBkaXJlY3RvcnkgKGluIGEgc3ViZGlyZWN0b3J5IG1pcnJvcmluZyB0aGUgLnB5IGZpbGUncwogICAgICAgICMgcGF0aCkgcmF0aGVyIHRoYW4gaW4gYSBfX3B5Y2FjaGVfXyBkaXIgbmV4dCB0byB0aGUgcHkgZmlsZS4KICAgICAgICBweWNhY2hlX3ByZWZpeGVzID0gWwogICAgICAgICAgICBvcy5wYXRoLmpvaW4ob3MucGF0aC5zZXAsICd0bXAnLCAnYnl0ZWNvZGUnKSwKICAgICAgICAgICAgb3MucGF0aC5qb2luKG9zLnBhdGguc2VwLCAndG1wJywgJ1x1MjYwMycpLCAgIyBub24tQVNDSUkgaW4gcGF0aCEKICAgICAgICAgICAgb3MucGF0aC5qb2luKG9zLnBhdGguc2VwLCAndG1wJywgJ3RyYWlsaW5nLXNsYXNoJykgKyBvcy5wYXRoLnNlcCwKICAgICAgICBdCiAgICAgICAgZHJpdmUgPSAnJwogICAgICAgIGlmIG9zLm5hbWUgPT0gJ250JzoKICAgICAgICAgICAgZHJpdmUgPSAnQzonCiAgICAgICAgICAgIHB5Y2FjaGVfcHJlZml4ZXMgPSBbCiAgICAgICAgICAgICAgICBmJ3tkcml2ZX17cHJlZml4fScgZm9yIHByZWZpeCBpbiBweWNhY2hlX3ByZWZpeGVzXQogICAgICAgICAgICBweWNhY2hlX3ByZWZpeGVzICs9IFtyJ1xcP1xDOlxmb28nLCByJ1xcbG9jYWxob3N0XGMkXGJhciddCiAgICAgICAgZm9yIHB5Y2FjaGVfcHJlZml4IGluIHB5Y2FjaGVfcHJlZml4ZXM6CiAgICAgICAgICAgIHdpdGggc2VsZi5zdWJUZXN0KHBhdGg9cHljYWNoZV9wcmVmaXgpOgogICAgICAgICAgICAgICAgcGF0aCA9IGRyaXZlICsgb3MucGF0aC5qb2luKAogICAgICAgICAgICAgICAgICAgIG9zLnBhdGguc2VwLCAnZm8geCwgLywgeT0xLCAqLCB6PTM6IHggKyB5ICsgeicpCiAgICAgICAgZXEoJ2xhbWJkYSB4PTEsIC8sIHk9MiwgKiwgej0zOiB4ICsgeSArIHonKQogICAgICAgIGVxKCdsYW1iZGEgeD0xLCAvLCB5PTIsICosIHo6IHggKyB5ICsgeicpCiAgICAgICAgZXEoJ2xhbWJkYSB4PTEsIHk9Miwgej0zLCAvLCB3PTQsICosIGwsIGwyOiB4ICsgeSArIHogKyB3ICsgbCArIGwyJykKICAgICAgICBlcSgnbGFtYmRhIHg9MSwgeT0yLCB6PTMsIC8sIHc9NCwgKiwgbCwgbDIsICoqa3dhcmdzOiB4ICsgeSArIHogKyB3ICsgbCArIGwyJykKICAgICAgICBlcSgnbGFtYmRhIHgsIC8sIHk9MSwgKiwgejogeCArIHkgKyB6JykKICAgICAgICBlcSgnbGFtYmRhIHg6IGxhbWJkYSB5OiB4ICsgeScpCiAgICAgICAgZXEoJzEgaWYgVHJ1ZSBlbHNlIDInKQogICAgICAgIGVxKCdzdHIgb3IgTm9uZSBpZiBpbnQgb3IgVHJ1ZSBlbHNlIHN0ciBvciBieXRlcyBvciBOb25lJykKICAgICAgICBlcSgnc3RyIG9yIE5vbmUgaWYgKDEgaWYgVHJ1ZSBlbHNlIDIpIGVsc2Ugc3RyIG9yIGJ5dGVzIG9yIE5vbmUnKQogICAgICAgIGVxKCIwIGlmIG5vdCB4IGVsc2UgMSBpZiB4ID4gMCBlbHNlIC0xIikKICAgICAgICBlcSgiKDEgaWYgeCA+IDAgZWxzZSAtMSkgaWYgeCBlbHNlIDAiKQogICAgICAgIGVxKCJ7JzIuNyc6IGRlYWQsICczLjcnOiBsb25nX2xpdmUgb3IgZGllX2hhcmR9IikKICAgICAgICBlcSgieycyLjcnOiBkZWFkLCAnMy43JzogbG9uZ19saXZlIG9yIGRpZV9oYXJkLCAqKnsnMy42JzogdmVyeWdvb2R9fSIpCiAgICAgICAgZXEoInsqKmEsICoqYiwgKipjfSIpCiAgICAgICAgZXEoInsnMi43JywgJzMuNicsICczLjcnLCAnMy44JywgJzMuOScsICc0LjAnIGlmIGdpbGVjdG9teSBlbHNlICczLjEwJ30iKQogICAgICAgIGVxKCJ7KmEsICpiLCAqY30iKQogICAgICAgIGVxKCIoeydhJzogJ2InfSwgVHJ1ZSBvciBGYWxzZSwgK3ZhbHVlLCAnc3RyaW5nJywgYidieXRlcycpIG9yIE5vbmUiKQogICAgICAgIGVxKCIoKSIpCiAgICAgICAgZXEoIihhLCkiKQogICAgICAgIGVxKCIoYSwgYikiKQogICAgICAgIGVxKCIoYSwgYiwgYykiKQogICAgICAgIGVxKCIoKmEsICpiLCAqYykiKQogICAgICAgIGVxKCJbXSIpCiAgICAgICAgZXEoIlsxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5LCAxMCBvciBBLCAxMSBvciBCLCAxMiBvciBDXSIpCiAgICAgICAgZXEoIlsqYSwgKmIsICpjXSIpCiAgICAgICAgZXEoIntpIGZvciBpIGluICgxLCAyLCAzKX0iKQogICAgICAgIGVxKCJ7aSAqKiAyIGZvciBpIGluICgxLCAyLCAzKX0iKQogICAgICAgIGVxKCJ7aSAqKiAyIGZvciBpLCBfIGluICgoMSwgJ2EnKSwgKDIsICdiJyksICgzLCAnYycpKX0iKQogICAgICAgIGVxKCJ7aSAqKiAyICsgaiBmb3IgaSBpbiAoMSwgMiwgMykgZm9yIGogaW4gKDEsIDIsIDMpfSIpCiAgICAgICAgZXEoIltpIGZvciBpIGluICgxLCAyLCAzKV0iKQogICAgICAgIGVxKCJbaSAqKiA+PiBndDIgPSBPR1JHZW9tVHlwZSgnUG9seWdvbicpICMgVXNpbmcgYSBzdHJpbmcKID4+PiBndDMgPSBPR1JHZW9tVHlwZSgnUE9MWUdPTicpICMgSXQncyBjYXNlLWluc2Vuc2l0aXZlCiA+Pj4gIyBFcXVpdmFsZW5jZSB3b3JrcyB3L25vbi1PR1JHZW9tVHlwZSBvYmplY3RzOgogPj4+IHByaW50KGd0MSA9PSAzLCBndDEgPT0gJ1BvbHlnb24nKQogVHJ1ZSBUcnVlCiIiIgoKaW1wb3J0IHN5cwpmcm9tIGJpbmFzY2lpIGltcG9ydCBiMmFfaGV4CmZyb20gY3R5cGVzIGltcG9ydCBieXJlZiwgY19jaGFyX3AsIGNfZG91YmxlLCBjX3VieXRlLCBjX3ZvaWRfcCwgc3RyaW5nX2F0Cgpmcm9tIGRqYW5nby5jb250cmliLmdpcy5nZGFsLmJhc2UgaW1wb3J0IEdEQUxCYXNlCmZyb20gZGphbmdvLmNvbnRyaWIuZ2lzLmdkYWwuZW52ZWxvcGUgaW1wb3J0IEVudmVsb3BlLCBPR1JFbnZlbG9wZQpmcm9tIGRqYW5nby5jb250cmliLmdpcy5nZGFsLmVycm9yIGltcG9ydCBHREFMRXhjZXB0aW9uLCBTUlNFeGNlcHRpb24KZnJvbSBkamFuZ28uY29udHJpYi5naXMuZ2RhbC5nZW9tdHlwZSBpbXBvcnQgT0dSR2VvbVR5cGUKZnJvbSBkamFuZ28uY29udHJpYi5naXMuZ2RhbC5wcm90b3R5cGVzIGltcG9ydCBnZW9tIGFzIGNhcGkKZnJvbSBkamFuZ28uY29udHJpYi5naXMuZ2RhbC5wcm90b3R5cGVzIGltcG9ydCBzcnMgYXMgc3JzX2FwaQpmcm9tIGRqYW5nby5jb250cmliLmdpcy5nZGFsLnNycyBpbXBvcnQgQ29vcmRUcmFuc2Zvcm0sIFNwYXRpYWxSZWZlcmVuY2UKZnJvbSBkamFuZ28uY29udHJpYi5naXMuZ2VvbWV0cnkgaW1wb3J0IGhleF9yZWdleCwganNvbl9yZWdleCwgd2t0X3JlZ2V4CmZyb20gZGphbmdvLnV0aWxzLmVuY29kaW5nIGltcG9ydCBmb3JjZV9ieXRlcwoKCiMgRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZSB0aGUgT0dSIEMgQVBJIHNvdXJjZSBjb2RlOgojICBodHRwczovL2dkYWwub3JnL2FwaS92ZWN0b3JfY19hcGkuaHRtbAojCiMgVGhlIE9HUl9HXyogcm91dGluZXMgYXJlIHJlbGV2YW50IGhlcmUuCmNsYXNzIE9HUkdlb21ldHJ5KEdEQUxCYXNlKToKICAgICIiIkVuY2Fwc3VsYXRlIGFuIE9HUiBnZW9tZXRyeS4iIiIKCiAgICBkZXN0cnVjdG9yID0gY2FwaS5kZXN0cm95X2dlb20KICAgIGdlb3Nfc3VwcG9ydCA9IFRydWUKCiAgICBkZWYgX19pbml0X18oc2VsZiwgZ2VvbV9pbnB1dCwgc3JzPU5vbmUpOgogICAgICAgICIiIkluaXRpYWxpemUgR2VvbWV0cnkgb24gZWl0aGVyIFdLVCBvciBhbiBPR1IgcG9pbnRlciBhcyBpbnB1dC4iIiIKICAgICAgICBzdHJfaW5zdGFuY2UgPSBpc2luc3RhbmNlKGdlb21faW5wdXQsIHN0cikKCiAgICAgICAgIyBJZiBIRVgsIHVucGFjayBpbnB1dCB0byBhIGJpbmFyeSBidWZmZXIuCiAgICAgICAgaWYgc3RyX2luc3RhbmNlIGFuZCBoZXhfcmVnZXgubWF0Y2goZ2VvbV9pbnB1dCk6CiAgICAgICAgICAgIGdlb21faW5wdXQgPSBtZW1vcnl2aWV3KGJ5dGVzLmZyb21oZXgoZ2Vlc19uZXdfY2xhc3Nfbm9fY2FsbGJhY2soc2VsZik6CiAgICAgICAgVCA9IFR5cGVWYXIoJ1QnLCBpbmZlcl92YXJpYW5jZT1UcnVlKQogICAgICAgIEtsYXNzID0gdHlwZXMubmV3X2NsYXNzKCdLbGFzcycsIChHZW5lcmljW1RdLCksIHt9KQoKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKEtsYXNzLl9fYmFzZXNfXywgKEdlbmVyaWMsKSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKEtsYXNzLl9fb3JpZ19iYXNlc19fLCAoR2VuZXJpY1tUXSwpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoS2xhc3MuX190eXBlX3BhcmFtc19fLCAoKSkgICMgbXVzdCBiZSBleHBsaWNpdGx5IHNldAogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoS2xhc3MuX19wYXJhbWV0ZXJzX18sIChULCkpCgoKY2xhc3MgVHlwZVBhcmFtc01hbmdsaW5nVGVzdCh1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICBkZWYgdGVzdF9tYW5nbGluZyhzZWxmKToKICAgICAgICBjbGFzcyBGb29bX19UXToKICAgICAgICAgICAgcGFyYW0gPSBfX1QKICAgICAgICAgICAgZGVmIG1ldGhbX19VXShzZWxmLCBhcmc6IF9fVCwgYXJnMjogX19VKToKICAgICAgICAgICAgICAgIHJldHVybiAoX19ULCBfX1UpCiAgICAgICAgICAgIHR5cGUgQWxpYXNbX19WXSA9IChfX1QsIF9fVikKCiAgICAgICAgVCA9IEZvby5fX3R5cGVfcGFyYW1zX19bMF0KICAgICAgICBzZWxmLmFzc2VydEVxdWFsKFQuX19uYW1lX18sICJfX1QiKQogICAgICAgIFUgPSBGb28ubWV0aC5fX3R5cGVfcGFyYW1zX19bMF0KICAgICAgICBzZWxmLmFzc2VydEVxdWFsKFUuX19uYW1lX18sICJfX1UiKQogICAgICAgIFYgPSBGb28uQWxpYXMuX190eXBlX3BhcmFtc19fWzBdCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChWLl9fbmFtZV9fLCAiX19WIikKCiAgICAgICAgYW5ubyA9IEZvby5tZXRoLl9fYW5ub3RhdGlvbnNfXwogICAgICAgIHNlbGYuYXNzZXJ0SXMoYW5ub1siYXJnIl0sIFQpCiAgICAgICAgc2VsZi5hc3NlcnRJcyhhbm5vWyJhcmcyIl0sIFUpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChGb28oKS5tZXRoKDEsIDIpLCAoVCwgVSkpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoRm9vLkFsaWFzLl9fdmFsdWVfXywgKFQsIFYpKQoKICAgIGRlZiB0ZXN0X25vX2xlYWt5X21hbmdsaW5nX2luX21vZHVsZShzZWxmKToKICAgICAgICBucyA9IHJ1bl9jb2RlKCIiIgogICAgICAgICAgICBfX2JlZm9yZSA9ICJiZWZvcmUiCiAgICAgICAgICAgIGNsYXNzIFhbVF06IHBhc3MKICAgICAgICAgICAgX19hZnRlciA9ICJhZnRlciIKICAgICAgICAiIiIpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChuc1siX19iZWZvcmUiXSwgImJlZm9yZSIpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChuc1siX19hZnRlciJdLCAiYWZ0ZXIiKQoKICAgIGRlZiB0ZXN0X25vX2xlYWt5X21hbmdsaW5nX2luX2Z1bmN0aW9uKHNlbGYpOgogICAgICAgIG5zID0gcnVuX2NvZGUoIiIiCiAgICAgICAgICAgIGRlZiBmKCk6CiB3cy5kZWJ1ZyBpbXBvcnQgRXhjZXB0aW9uUmVwb3J0ZXIKCmZyb20gLi51dGlscyBpbXBvcnQgc2V0dXAKCnBhcnRpYWxfdGVtcGxhdGVzID0gewogICAgInBhcnRpYWxfYmFzZS5odG1sIjogKAogICAgICAgICI8bWFpbj57JSBibG9jayBtYWluICV9RGVmYXVsdCBtYWluIGNvbnRlbnQueyUgZW5kYmxvY2sgbWFpbiAlfTwvbWFpbj4iCiAgICApLAogICAgInBhcnRpYWxfaW5jbHVkZWQuaHRtbCI6ICgKICAgICAgICAiSU5DTFVERUQgVEVNUExBVEUgU1RBUlRcbiIKICAgICAgICAieyUgcGFydGlhbGRlZiBpbmNsdWRlZC1wYXJ0aWFsICV9XG4iCiAgICAgICAgIlRISVMgSVMgQ09OVEVOVCBGUk9NIFRIRSBJTkNMVURFRCBQQVJUSUFMXG4iCiAgICAgICAgInslIGVuZHBhcnRpYWxkZWYgJX1cblxuIgogICAgICAgICJOb3cgdXNpbmcgdGhlIHBhcnRpYWw6IHslIHBhcnRpYWwgaW5jbHVkZWQtcGFydGlhbCAlfVxuIgogICAgICAgICJJTkNMVURFRCBURU1QTEFURSBFTkRcbiIKICAgICksCn0KCnZhbGlkX3BhcnRpYWxkZWZfbmFtZXMgPSAoCiAgICAiZG90LmluLm5hbWUiLAogICAgIidzcGFjZSBpbiBuYW1lJyIsCiAgICAiZXhjbGFtYXRpb24hIiwKICAgICJAYXQiLAogICAgInNsYXNoL3NvbWV0aGluZyIsCiAgICAiaW5saW5lIiwKICAgICJpbmxpbmUtaW5saW5lIiwKICAgICJJTkxJTkUiICJ3aXRoK3BsdXMiLAogICAgIndpdGgmYW1wIiwKICAgICJ3aXRoJXBlcmNlbnQiLAogICAgIndpdGgsY29tbWEiLAogICAgIndpdGg6Y29sb24iLAogICAgIndpdGg7c2VtaWNvbG9uIiwKICAgICJbYnJhY2tldHNdIiwKICAgICIocGFyZW5zKSIsCiAgICAie2N1cmx5fSIsCikKCgpkZWYgZ2VuX3BhcnRpYWxfdGVtcGxhdGUobmFtZSwgKmFyZ3MsICoqa3dhcmdzKToKICAgIGlmIGFyZ3Mgb3Iga3dhcmdzOgogICAgICAgIGV4dHJhID0gIiAiLmpvaW4oKGFyZ3MsICooIntrfT17dn0iIGZvciBrLCB2IGluIGt3YXJncy5pdGVtcygpKSkpICsgIiAiCiAgICBlbHNlOgogICAgICAgIGV4dHJhID0gIiIKICAgIHJldHVybiAoCiAgICAgICAgZiJ7eyUgcGFydGlhbGRlZiB7bmFtZX0ge2V4dHJhfSV9fVRFU1Qgd2l0aCB7bmFtZX0he3slIGVuZHBhcnRpYWxkZWYgJX19IgogICAgICAgIGYie3slIHBhcnRpYWwge25hbWV9ICV9fSIKICAgICkKCgpjbGFzcyBQYXJ0aWFsVGFnVGVzdHMoU2ltcGxlVGVzdENhc2UpOgogICAgbGlicmFyaWVzID0geyJiYWRfdGFnIjogInRlbXBsYXRlX3Rlc3RzLnRlbXBsYXRldGFncy5iYWRfdGFnIn0KCiAgICBAc2V0dXAoe25hbWU6IGdlbl9wYXJ0aWFsX3RlbXBsYXRlKG5hbWUpIGZvciBuYW1lIGluIHZhbGlkX3BhcnRpYWxkZWZfbmFtZXN9KQogICAgZGVmIHRlc3RfdmFsaWRfcGFydGlhbGRlZl9uYW1lcyhzZWxmKToKICAgICAgICBmb3IgdGVtcGxhdGVfbmFtZSBpbiB2YWxpZF9wYXJ0aWFsZGVmX25hbWVzOgogICAgICAgICAgICB3aXRoIHNlbGYuc3ViVGVzdCh0ZW1wbGF0ZV9uYW1lPXRlbXBsdHlwZT1zdWJ0eXBlLAogICAgICAgICAgICAgICAgZmlsZW5hbWU9ZmlsZW5hbWUsCiAgICAgICAgICAgICkKCiAgICBkZWYgX3NldF9saXN0X2hlYWRlcl9pZl9ub3RfZW1wdHkoc2VsZiwgbXNnLCBoZWFkZXIsIHZhbHVlcyk6CiAgICAgICAgIiIiCiAgICAgICAgU2V0IG1zZydzIGhlYWRlciwgZWl0aGVyIGZyb20gc2VsZi5leHRyYV9oZWFkZXJzLCBpZiBwcmVzZW50LCBvciBmcm9tCiAgICAgICAgdGhlIHZhbHVlcyBhcmd1bWVudCBpZiBub3QgZW1wdHkuCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBtc2dbaGVhZGVyXSA9IHNlbGYuZXh0cmFfaGVhZGVyc1toZWFkZXJdCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBpZiB2YWx1ZXM6CiAgICAgICAgICAgICAgICBtc2dbaGVhZGVyXSA9ICIsICIuam9pbihzdHIodikgZm9yIHYgaW4gdmFsdWVzKQoKICAgIGRlZiBfaWRuYV9lbmNvZGVfYWRkcmVzc19oZWFkZXJfZG9tYWlucyhzZWxmLCBtc2cpOgogICAgICAgICIiIgogICAgICAgIElmIG1zZy5wb2xpY3kgZG9lcyBub3QgcGVybWl0IHV0ZjggaW4gaGVhZGVycywgSUROQSBlbmNvZGUgYWxsCiAgICAgICAgbm9uLUFTQ0lJIGRvbWFpbnMgaW4gaXRzIGFkZHJlc3MgaGVhZGVycy4KICAgICAgICAiIiIKICAgICAgICAjIEF2b2lkcyBhIHByb2JsZW0gd2hlcmUgUHl0aG9uJ3MgZW1haWwgaW5jb3JyZWN0bHkgY29udmVydHMgbm9uLUFTQ0lJCiAgICAgICAgIyBkb21haW5zIHRvIFJGQyAyMDQ3IGVuY29kZWQtd29yZHM6CiAgICAgICAgIyBodHRwczovL2dpdGh1Yi5jb20vcHl0aG9uL2NweXRob24vaXNzdWVzLzgzOTM4LgogICAgICAgICMgVGhpcyBhcHBsaWVzIHRvIHRoZSBkb21haW4gb25seSwgbm90IHRvIHRoZSBsb2NhbHBhcnQgKHVzZXJuYW1lKS4KICAgICAgICAjIFRoZXJlIGlzIG5vIFJGQyB0aGF0IHBlcm1pdHMgYW55IDctYml0IGVuY29kaW5nIGZvciBub24tQVNDSUkKICAgICAgICAjIGNoYXJhY3RlcnMgYmVmb3JlIHRoZSAnQCcuCiAgICAgICAgaWYgbm90IGdldGF0dHIobXNnLnBvbGljeSwgInV0ZjgiLCBGYWxzZSk6CiAgICAgICAgICAgICMgTm90IHVzaW5nIFNNVFBVVEY4LCBzbyBhcHBseSBJRE5BIGVuY29kaW5nIGluIGFsbCBhZGRyZXNzCiAgICAgICAgICAgICMgaGVhZGVycy4gSUROQSBlbmNvZGluZyBkb2VzIG5vdCBhbHRlciBkb21haW5zIHRoYXQgYXJlIGFscmVhZHkKICAgICAgICAgICAgIyBBU0NJSS4KICAgICAgICAgICAgZm9yIGZpZWxkLCB2YWx1ZSBpbiBtc2cuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIEFkZHJlc3NIZWFkZXIpIGFuZCBhbnkoCiAgICAgICAgICAgICAgICAgICAgbm90IGFkZHIuZG9tYWluLmlzYXNjaWkoKSBmb3IgYWRkciBpbiB2YWx1ZS5hZGRyZXNzZXMKICAgICAgICAgICAgICAgICk6CiAgICAgICAgICAgICAgICAgICAgbXNnLnJlcGxhY2VfaGVhZGVyKAogZWxmLmNtZHNbaV0KCiAgICBkZWYgcmVkbyhzZWxmLCB0ZXh0KToKICAgICAgICBmb3IgY21kIGluIHNlbGYuY21kczoKICAgICAgICAgICAgY21kLnJlZG8odGV4dCkKCiAgICBkZWYgdW5kbyhzZWxmLCB0ZXh0KToKICAgICAgICBjbWRzID0gc2VsZi5jbWRzWzpdCiAgICAgICAgY21kcy5yZXZlcnNlKCkKICAgICAgICBmb3IgY21kIGluIGNtZHM6CiAgICAgICAgICAgIGNtZC51bmRvKHRleHQpCgogICAgZGVmIGJ1bXBfZGVwdGgoc2VsZiwgaW5jcj0xKToKICAgICAgICBzZWxmLmRlcHRoID0gc2VsZi5kZXB0aCArIGluY3IKICAgICAgICByZXR1cm4gc2VsZi5kZXB0aAoKCmRlZiBfdW5kb19kZWxlZ2F0b3IocGFyZW50KTogICMgaHRlc3QgIwogICAgZnJvbSB0a2ludGVyIGltcG9ydCBUb3BsZXZlbCwgVGV4dCwgQnV0dG9uCiAgICBmcm9tIGlkbGVsaWIucGVyY29sYXRvciBpbXBvcnQgUGVyY29sYXRvcgogICAgdG9wID0gVG9wbGV2ZWwocGFyZW50KQogICAgdG9wLnRpdGxlKCJUZXN0IFVuZG9EZWxlZ2F0b3IiKQogICAgeCwgeSA9IG1hcChpbnQsIHBhcmVudC5nZW9tZXRyeSgpLnNwbGl0KCcrJylbMTpdKQogICAgdG9wLmdlb21ldHJ5KCIrJWQrJWQiICUgKHgsIHkgKyAxNzUpKQoKICAgIHRleHQgPSBUZXh0KHRvcCwgaGVpZ2h0PTEwKQogICAgdGV4dC5wYWNrKCkKICAgIHRleHQuZm9jdXNfc2V0KCkKICAgIHAgPSBQZXJjb2xhdG9yKHRleHQpCiAgICBkID0gVW5kb0RlbGVnYXRvcigpCiAgICBwLmluc2VydGZpbHRlcihkKQoKICAgIHVuZG8gPSBCdXR0b24odG9wLCB0ZXh0PSJVbmRvIiwgY29tbWFuZD1sYW1iZGE6ZC51bmRvX2V2ZW50KE5vbmUpKQogICAgdW5kby5wYWNrKHNpZGU9J2xlZnQnKQogICAgcmVkbyA9IEJ1dHRvbih0b3AsIHRleHQ9IlJlZG8iLCBjb21tYW5kPWxhbWJkYTpkLnJlZG9fZXZlbnQoTm9uZSkpCiAgICByZWRvLnBhY2soc2lkZT0nbGVmdCcpCiAgICBkdW1wID0gQnV0dG9uKHRvcCwgdGV4dD0iRHVtcCIsIGNvbW1hbmQ9bGFtYmRhOmQuZHVtcF9ldmVudChOb25lKSkKICAgIGR1bXAucGFjayhzaWRlPSdsZWZ0JykKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgZnJvbSB1bml0dGVzdCBpbXBvcnQgbWFpbgogICAgbWFpbignaWRsZWxpYi5pZGxlX3Rlc3QudGVzdF91bmRvJywgdmVyYm9zaXR5PTIsIGV4aXQ9RmFsc2UpCgogICAgZnJvbSBpZGxlbGliLmlkbGVfdGVzdC5odGVzdCBpbXBvcnQgcnVuCiAgICBydW4oX3VuZG9fZGVsZWdhdG9yKQoiIiIKKioqKioqKiogTW9kZWxzIGZvciB0ZXN0X2RhdGEucHkgKioqKioqKioqKioKVGhlIGZvbGxvd2luZyBjbGFzc2VzIGFyZSBmb3IgdGVzdGluZyBiYXNpYyBkYXRhIG1hcnNoYWxsaW5nLCBpbmNsdWRpbmcKTlVMTCB2YWx1ZXMsIHdoZXJlIGFsbG93ZWQuClRoZSBiYXNpYyBpZGVhIGlzIHRvIGhhdmUgYSBtb2RlbCBmb3IgZWFjaCBEamFuZ28gZGF0YSB0eXBlLgoiIiIKCmltcG9ydCB1dWlkCgpmcm90YXJ0PU5vbmUsIHN0b3A9Tm9uZSk6CiAgICAgICAgIiIiSW5pdGlhbGl6ZSBhIF9QYXJ0aWFsRmlsZS4iIiIKICAgICAgICBfUHJveHlGaWxlLl9faW5pdF9fKHNlbGYsIGYsIHN0YXJ0KQogICAgICAgIHNlbGYuX3N0YXJ0ID0gc3RhcnQKICAgICAgICBzZWxmLl9zdG9wID0gc3RvcAoKICAgIGRlZiB0ZWxsKHNlbGYpOgogICAgICAgICIiIlJldHVybiB0aGUgcG9zaXRpb24gd2l0aCByZXNwZWN0IHRvIHN0YXJ0LiIiIgogICAgICAgIHJldHVybiBfUHJveHlGaWxlLnRlbGwoc2VsZikgLSBzZWxmLl9zdGFydAoKICAgIGRlZiBzZWVrKHNlbGYsIG9mZnNldCwgd2hlbmNlPTApOgogICAgICAgICIiIkNoYW5nZSBwb3NpdGlvbiwgcG9zc2libHkgd2l0aCByZXNwZWN0IHRvIHN0YXJ0IG9yIHN0b3AuIiIiCiAgICAgICAgaWYgd2hlbmNlID09IDA6CiAgICAgICAgICAgIHNlbGYuX3BvcyA9IHNlbGYuX3N0YXJ0CiAgICAgICAgICAgIHdoZW5jZSA9IDEKICAgICAgICBlbGlmIHdoZW5jZSA9PSAyOgogICAgICAgICAgICBzZWxmLl9wb3MgPSBzZWxmLl9zdG9wCiAgICAgICAgICAgIHdoZW5jZSA9IDEKICAgICAgICBfUHJveHlGaWxlLnNlZWsoc2VsZiwgb2Zmc2V0LCB3aGVuY2UpCgogICAgZGVmIF9yZWFkKHNlbGYsIHNpemUsIHJlYWRfbWV0aG9kKToKICAgICAgICAiIiJSZWFkIHNpemUgYnl0ZXMgdXNpbmcgcmVhZF9tZXRob2QsIGhvbm9yaW5nIHN0YXJ0IGFuZCBzdG9wLiIiIgogICAgICAgIHJlbWFpbmluZyA9IHNlbGYuX3N0b3AgLSBzZWxmLl9wb3MKICAgICAgICBpZiByZW1haW5pbmcgPD0gMDoKICAgICAgICAgICAgcmV0dXJuIGInJwogICAgICAgIGlmIHNpemUgaXMgTm9uZSBvciBzaXplIDwgMCBvciBzaXplID4gcmVtYWluaW5nOgogICAgICAgICAgICBzaXplID0gcmVtYWluaW5nCiAgICAgICAgcmV0dXJuIF9Qcm94eUZpbGUuX3JlYWQoc2VsZiwgc2l6ZSwgcmVhZF9tZXRob2QpCgogICAgZGVmIGNsb3NlKHNlbGYpOgogICAgICAgICMgZG8gKm5vdCogY2xvc2UgdGhlIHVuZGVybHlpbmcgZmlsZSBvYmplY3QgZm9yIHBhcnRpYWwgZmlsZXMsCiAgICAgICAgIyBzaW5jZSBpdCdzIGdsb2JhbCB0byB0aGUgbWFpbGJveCBvYmplY3QKICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdfZmlsZScpOgogICAgICAgICAgICBkZWwgc2VsZi5fZmlsZQoKCmRlZiBfbG9ja19maWxlKGYsIGRvdGxvY2s9VHJ1ZSk6CiAgICAiIiJMb2NrIGZpbGUgZiB1c2luZyBsb2NrZiBhbmQgZG90IGxvY2tpbmcuIiIiCiAgICBkb3Rsb2NrX2RvbmUgPSBGYWxzZQogICAgdHJ5OgogICAgICAgIGlmIGZjbnRsOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmY250bC5sb2NrZihmLCBmY250bC5MT0NLX0VYIHwgZmNudGwuTE9DS19OQikKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3IgYXMgZToKICAgICAgICAgICAgICAgIGlmIGUuZXJybm8gaW4gKGVycm5vLkVBR0FJTiwgZXJybm8uRUFDQ0VTLCBlcnJuby5FUk9GUyk6CiAwMWE6IDB4MDAxYSwgICAgICMgIFNVQlNUSVRVVEUKICAgIDB4MDAxYjogMHgwMDFiLCAgICAgIyAgRVNDQVBFCiAgICAweDAwMWM6IDB4MDAxYywgICAgICMgIEZJTEUgU0VQQVJBVE9SCiAgICAweDAwMWQ6IDB4MDAxZCwgICAgICMgIEdST1VQIFNFUEFSQVRPUgogICAgMHgwMDFlOiAweDAwMWUsICAgICAjICBSRUNPUkQgU0VQQVJBVE9SCiAgICAweDAwMWY6IDB4MDAxZiwgICAgICMgIFVOSVQgU0VQQVJBVE9SCiAgICAweDAwMjA6IDB4MDAyMCwgICAgICMgIFNQQUNFCiAgICAweDAwMjE6IDB4MDAyMSwgICAgICMgIEVYQ0xBTUFUSU9OIE1BUksKICAgIDB4MDAyMjogMHgwMDIyLCAgICAgIyAgUVVPVEFUSU9OIE1BUksKICAgIDB4MDAyMzogMHgwMDIzLCAgICAgIyAgTlVNQkVSIFNJR04KICAgIDB4MDAyNDogMHgwMDI0LCAgICAgIyAgRE9MTEFSIFNJR04KICAgIDB4MDAyNTogMHgwMDI1LCAgICAgIyAgUEVSQ0VOVCBTSUdOCiAgICAweDAwMjY6IDB4MDAyNiwgICAgICMgIEFNUEVSU0FORAogICAgMHgwMDI3OiAweDAwMjcsICAgICAjICBBUE9TVFJPUEhFCiAgICAweDAwMjg6IDB4MDAyOCwgICAgICMgIExFRlQgUEFSRU5USEVTSVMKICAgIDB4MDAyOTogMHgwMDI5LCAgICAgIyAgUklHSFQgUEFSRU5USEVTSVMKICAgIDB4MDAyYTogMHgwMDJhLCAgICAgIyAgQVNURVJJU0sKICAgIDB4MDAyYjogMHgwMDJiLCAgICAgIyAgUExVUyBTSUdOCiAgICAweDAwMmM6IDB4MDAyYywgICAgICMgIENPTU1BCiAgICAweDAwMmQ6IDB4MDAyZCwgICAgICMgIEhZUEhFTi1NSU5VUwogICAgMHgwMDJlOiAweDAwMmUsICAgICAjICBGVUxMIFNUT1AKICAgIDB4MDAyZjogMHgwMDJmLCAgICAgIyAgU09MSURVUwogICAgMHgwMDMwOiAweDAwMzAsICAgICAjICBESUdJVCBaRVJPCiAgICAweDAwMzE6IDB4MDAzMSwgICAgICMgIERJR0lUIE9ORQogICAgMHgwMDMyOiAweDAwMzIsICAgICAjICBESUdJVCBUV08KICAgIDB4MDAzMzogMHgwMDMzLCAgICAgIyAgRElHSVQgVEhSRUUKICAgIDB4MDAzNDogMHgwMDM0LCAgICAgIyAgRElHSVQgRk9VUgogICAgMHgwMDM1OiAweDAwMzUsICAgICAjICBESUdJVCBGSVZFCiAgICAweDAwMzY6IDB4MDAzNiwgICAgICMgIERJR0lUIFNJWAogICAgMHgwMDM3OiAweDAwMzcsICAgICAjICBESUdJVCBTRVZFTgogICAgMHgwMDM4OiAweDAwMzgsICAgICAjICBESUdJVCBFSUdIVAogICAgMHgwMDM5OiAweDAwMzksICAgICAjICBESUdJVCBOSU5FCiAgICAweDAwM2E6IDB4MDAzYSwgICAgICMgIENPTE9OCiAgICAweDAwM2I6IDB4MDAzYiwgICAgICMgIFNFTUlDT0xPTgogICAgMHgwMDNjOiAweDAwM2MsICAgICAjICBMRVNTLVRIQU4gU0lHTgogICAgMHgwMDNkOiAweDAwM2QsICAgICAjICBFUVVBTFMgU0lHTgogICAgMHgwMDNlOiAweDAwM2UsICAgICAjICBHUkVBVEVSLVRIQU4gU0lHTgogICAgMHgwMDNmOiAweDAwM2YsICAgICAjICBRVUVTVElPTiBNQVJLCiAgICAweDAwNDA6IDB4MDA0MCwgICBuc2V0KHsnbWVtbycsICdjdXN0b20nLCAndGVzdCd9KSwKICAgICAgICAgICAgICAgICAgICAgICAgZiJtdWx0aV9mbGFnX3J1bGUgZmxhZ3Mgc2hvdWxkIGNvbnRhaW4gbWVtbywgY3VzdG9tLCB0ZXN0LCBnb3Qge211bHRpX2ZsYWdfcnVsZS5mbGFnc30iKQoKICAgICAgICAjIFRlc3Qgc2luZ2xlIGN1c3RvbSBmbGFnIHJ1bGUKICAgICAgICBzaW5nbGVfY3VzdG9tX3J1bGUgPSBydWxlc1snc2luZ2xlX2N1c3RvbV9mbGFnJ10KICAgICAgICBzZWxmLmFzc2VydEZhbHNlKCdtZW1vJyBub3QgaW4gc2ltcGxlX3J1bGUuZmxhZ3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAic2luZ2xlX2N1c3RvbV9mbGFnIHNob3VsZCBub3QgaGF2ZSBtZW1vIikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHNpbmdsZV9jdXN0b21fcnVsZS5mbGFncywgZnJvemVuc2V0KFsnY3VzdG9tJ10pLAogICAgICAgICAgICAgICAgICAgICAgICBmInNpbmdsZV9jdXN0b21fZmxhZyBmbGFncyBzaG91bGQgYmUgeydjdXN0b20nfSwgZ290IHtzaW5nbGVfY3VzdG9tX3J1bGUuZmxhZ3N9IikKCiAgICAgICAgIyBUZXN0IG5vIGZsYWdzIHJ1bGUKICAgICAgICBub19mbGFnc19ydWxlID0gcnVsZXNbJ25vX2ZsYWdzX3J1bGUnXQogICAgICAgIHNlbGYuYXNzZXJ0RmFsc2UoJ21lbW8nIG5vdCBpbiBzaW1wbGVfcnVsZS5mbGFncywKICAgICAgICAgICAgICAgICAgICAgICAgICJub19mbGFnc19ydWxlIHNob3VsZCBub3QgaGF2ZSBtZW1vIikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKG5vX2ZsYWdzX3J1bGUuZmxhZ3MsIGZyb3plbnNldCgpLAogICAgICAgICAgICAgICAgICAgICAgICBmIm5vX2ZsYWdzX3J1bGUgZmxhZ3Mgc2hvdWxkIGJlIHRoZSBlbXB0eSBzZXQsIGdvdCB7bm9fZmxhZ3NfcnVsZS5mbGFnc30iKQpmcm9tIGRqYW5nby5jb250cmliLmF1dGggaW1wb3J0IHZpZXdzIGFzIGF1dGhfdmlld3MKZnJvbSBkamFuZ28udXJscyBpbXBvcnQgcGF0aApmcm9tIGRqYW5nby52aWV3cy5nZW5lcmljIGltcG9ydCBSZWRpcmVjdFZpZXcKCmZyb20gLiBpbXBvcnQgdmlld3MKCnVybHBhdHRlcm5zID0gWwogICAgcGF0aCgidXBsb2FkX3ZpZXcvIiwgdmlld3MudXBsb2FkX3ZpZXcsIG5hbWU9InVwbG9hZF92aWV3IiksCiAgICBwYXRoKCJnZXRfdmlldy8iLCB2aWV3cy5nZXRfdmlldywgbmFtZT0iZ2V0X3ZpZXciKSwKICAgIHBhdGgoImNidl92aWV3LyIsIHZpZXdzLkNCVmlldy5hc192aWV3KCkpLAogICAgcGF0aCgicG9zdF92aWV3LyIsIHZpZXdzLnBvc3RfdmlldyksCiAgICBwYXRoKCJwb3N0X3RoZW5fZ2V0X3ZpZXcvIiwgdmlld3MucG9zdF90aGVuX2dldF92aWV3KSwKICAgIHBhdGgoInB1dF92aWV3LyIsIHZpZXdzLnB1dF92aWV3KSwKICAgIHBhdGgoInRyYWNlX3ZpZXcvIiwgdmlld3MudHJhY2VfdmlldyksCiAgICBwYXRoKCJoZWFkZXJfdmlldy8iLCB2aWV3cy52aWV3X3dpdGhfaGVhZGVyKSwKICAgIHBhdGgoInJhd19wb3N0ICAgIHguY29tbWVudCA9IGZwLnJlYWQoY2VudGRpcltfQ0RfQ09NTUVOVF9MRU5HVEhdKQogICAgICAgICAgICB4LmhlYWRlcl9vZmZzZXQgPSBjZW50ZGlyW19DRF9MT0NBTF9IRUFERVJfT0ZGU0VUXQogICAgICAgICAgICAoeC5jcmVhdGVfdmVyc2lvbiwgeC5jcmVhdGVfc3lzdGVtLCB4LmV4dHJhY3RfdmVyc2lvbiwgeC5yZXNlcnZlZCwKICAgICAgICAgICAgIHguZmxhZ19iaXRzLCB4LmNvbXByZXNzX3R5cGUsIHQsIGQsCiAgICAgICAgICAgICB4LkNSQywgeC5jb21wcmVzc19zaXplLCB4LmZpbGVfc2l6ZSkgPSBjZW50ZGlyWzE6MTJdCiAgICAgICAgICAgIGlmIHguZXh0cmFjdF92ZXJzaW9uID4gTUFYX0VYVFJBQ1RfVkVSU0lPTjoKICAgICAgICAgICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IoInppcCBmaWxlIHZlcnNpb24gJS4xZiIgJQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoeC5leHRyYWN0X3ZlcnNpb24gLyAxMCkpCiAgICAgICAgICAgIHgudm9sdW1lLCB4LmludGVybmFsX2F0dHIsIHguZXh0ZXJuYWxfYXR0ciA9IGNlbnRkaXJbMTU6MThdCiAgICAgICAgICAgICMgQ29udmVydCBkYXRlL3RpbWUgY29kZSB0byAoeWVhciwgbW9udGgsIGRheSwgaG91ciwgbWluLCBzZWMpCiAgICAgICAgICAgIHguX3Jhd190aW1lID0gdAogICAgICAgICAgICB4LmRhdGVfdGltZSA9ICggKGQ+PjkpKzE5ODAsIChkPj41KSYweEYsIGQmMHgxRiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQ+PjExLCAodD4+NSkmMHgzRiwgKHQmMHgxRikgKiAyICkKICAgICAgICAgICAgeC5fZGVjb2RlRXh0cmEob3JpZ19maWxlbmFtZV9jcmMpCiAgICAgICAgICAgIHguaGVhZGVyX29mZnNldCA9IHguaGVhZGVyX29mZnNldCArIGNvbmNhdAogICAgICAgICAgICBzZWxmLmZpbGVsaXN0LmFwcGVuZCh4KQogICAgICAgICAgICBzZWxmLk5hbWVUb0luZm9beC5maWxlbmFtZV0gPSB4CgogICAgICAgICAgICAjIHVwZGF0ZSB0b3RhbCBieXRlcyByZWFkIGZyb20gY2VudHJhbCBkaXJlY3RvcnkKICAgICAgICAgICAgdG90YWwgPSAodG90YWwgKyBzaXplQ2VudHJhbERpciArIGNlbnRkaXJbX0NEX0ZJTEVOQU1FX0xFTkdUSF0KICAgICAgICAgICAgICAgICAgICAgKyBjZW50ZGlyW19DRF9FWFRSQV9GSUVMRF9MRU5HVEhdCiAgICAgICAgICAgICAgICAgICAgICsgY2VudGRpcltfQ0RfQ09NTUVOVF9MRU5HVEhdKQoKICAgICAgICAgICAgaWYgc2VsZi5kZWJ1ZyA+IDI6CiAgICAgICAgICAgICAgICBwcmludCgidG90YWwiLCB0b3RhbCkKCiAgICAgICAgZW5kX29mZnNldCA9IHNlbGYuc3RhcnRfZGlyCiAgICAgICAgZm9yIHppbmZvIGluIHJldmVyc2VkKHNvcnRlZChzZWxmLmZpbGVsaXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PWxhbWJkYSB6aW5mbzogemluZm8uaGVhZGVyX29mZnNldCkpOgogICAgICAgICAgICB6aW5mby5fZW5kX29pdGgoKG9zLnBhdGguc2VwLCBvcy5wYXRoLmFsdHNlcCkpCiAgICAgICAgcmV0dXJuIEZhbHNlCgoKIyBaSVAgZW5jcnlwdGlvbiB1c2VzIHRoZSBDUkMzMiBvbmUtYnl0ZSBwcmltaXRpdmUgZm9yIHNjcmFtYmxpbmcgc29tZQojIGludGVybmFsIGtleXMuIFdlIG5vdGljZWQgdGhhdCBhIGRpcmVjdCBpbXBsZW1lbnRhdGlvbiBpcyBmYXN0ZXIgdGhhbgojIHJlbHlpbmcgb24gYmluYXNjaWkuY3JjMzIoKS4KCl9jcmN0YWJsZSA9IE5vbmUKZGVmIF9nZW5fY3JjKGNyYyk6CiAgICBmb3IgaiBpbiByYW5nZSg4KToKICAgICAgICBpZiBjcmMgJiAxOgogICAgICAgICAgICBjcmMgPSAoY3JjID4+IDEpIF4gMHhFREI4ODMyMAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNyYyA+Pj0gMQogICAgcmV0dXJuIGNyYwoKIyBaSVAgc3VwcG9ydHMgYSBwYXNzd29yZC1iYXNlZCBmb3JtIG9mIGVuY3J5cHRpb24uIEV2ZW4gdGhvdWdoIGtub3duCiMgcGxhaW50ZXh0IGF0dGFja3MgaGF2ZSBiZWVuIGZvdW5kIGFnYWluc3QgaXQsIGl0IGlzIHN0aWxsIHVzZWZ1bAojIHRvIGJlIGFibGUgdG8gZ2V0IGRhdGEgb3V0IG9mIHN1Y2ggYSBmaWxlLgojCiMgVXNhZ2U6CiMgICAgIHpkID0gX1ppcERlY3J5cHRlcihteXB3ZCkKIyAgICAgcGxhaW5fYnl0ZXMgPSB6ZChjeXBoZXJfYnl0ZXMpCgpkZWYgX1ppcERlY3J5cHRlcihwd2QpOgogICAga2V5MCA9IDMwNTQxOTg5NgogICAga2V5MSA9IDU5MTc1MTA0OQogICAga2V5MiA9IDg3ODA4MjE5MgoKICAgIGdsb2JhbCBfY3JjdGFibGUKICAgIGlmIF9jcmN0YWJsZSBpcyBOb25lOgogICAgICAgIF9jcmN0YWJsZSA9IGxpc3QobWFwKF9nZW5fY3JjLCByYW5nZSgyNTYpKSkKICAgIGNyY3RhYmxlID0gX2NyY3RhYmxlCgogICAgZGVmIGNyYzMyKGNoLCBjcmMpOgogICAgICAgICIiIkNvbXB1dGUgdGhlIENSQzMyIHByaW1pdGl2ZSBvbiBvbmUgYnl0ZS4iIiIKICAgICAgICByZXR1cm4gKGNyYyA+PiA4KSBeIGNyY3RhYmxlWyhjcmMgXiBjaCkgJiAweEZGXQoKICAgIGRlZiB1cGRhdGVfa2V5cyhjKToKICAgICAgICBub25sb2NhbCBrZXkwLCBrZXkxLCBrZXkyCiAgICAgICAga2V5MCA9IGNyYzMyKGMsIGtleTApCiAgICAgICAga2V5MSA9IChrZXkxICsgKGtleTAgJiAweEZGKSkgJiAweEZGRkZGRkZGCiAgICAgICAga2V5MSA9IChrZXkxICogMTM0Nzc1ODEzICsgMSkgJiAweEZGRkZGRkZGCiAgICAgICAga2V5MiA9IGNyYzMyKGtleTEgPj4gMjQsIGtleTIpCgogICAgZm9yIHAgaW4gcHdkOgogICAgICAgIHVwZGF0ZV9rZXlzKHApCgogICAgZGVmIGRlY3J5cHRlcihkYXRhKToKICAgICAgICAiIiJEZWNyeXB0IGEgYnl0ZXMgb2JqZWN0LiIiIgogICAgICAgIHJlc3VsdCA9IGJ5dGVhcnJheSgpCiAgICAgICAgYXBwZW5kID0gcmVzdWx0LmFwcGVuZAogICAgICAgIGZvciBjIGluIGRhdGE6CiAgICAgICAgICAgIGsgPSBrZXkyIHwgMgogICAgICAgICAgICBjIF49ICgoayAqIChrXjEpKSA+PiBwZXIKCnZlcmJvc2UgPSB0ZXN0LnN1cHBvcnQudmVyYm9zZQoKIyBMaWJyYXJ5IG1vZHVsZXMgY292ZXJlZCBieSB0aGlzIHRlc3Qgc2V0CiMgIHBkYiAoSXNzdWUgNDIwMSkKIyAgaW5zcGVjdCAoSXNzdWUgNDIyMykKIyAgZG9jdGVzdCAoSXNzdWUgNDE5NykKCiMgT3RoZXIgdGVzdCBtb2R1bGVzIHdpdGggemlwaW1wb3J0IHJlbGF0ZWQgdGVzdHMKIyAgdGVzdF96aXBpbXBvcnQgKG9mIGNvdXJzZSEpCiMgIHRlc3RfY21kX2xpbmVfc2NyaXB0IChjb3ZlcnMgdGhlIHppcGltcG9ydCBzdXBwb3J0IGluIHJ1bnB5KQoKIyBSZXRyaWV2ZSBzb21lIGhlbHBlcnMgZnJvbSBvdGhlciB0ZXN0IGNhc2VzCmZyb20gdGVzdC50ZXN0X2RvY3Rlc3QgaW1wb3J0ICh0ZXN0X2RvY3Rlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYW1wbGVfZG9jdGVzdCwgc2FtcGxlX2RvY3Rlc3Rfbm9fZG9jdGVzdHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYW1wbGVfZG9jdGVzdF9ub19kb2NzdHJpbmdzLCBzYW1wbGVfZG9jdGVzdF9za2lwKQoKCmRlZiBfcnVuX29iamVjdF9kb2N0ZXN0KG9iaiwgbW9kdWxlKToKICAgIGZpbmRlciA9IGRvY3Rlc3QuRG9jVGVzdEZpbmRlcih2ZXJib3NlPXZlcmJvc2UsIHJlY3Vyc2U9RmFsc2UpCiAgICBydW5uZXIgPSBkb2N0ZXN0LkRvY1Rlc3RSdW5uZXIodmVyYm9zZT12ZXJib3NlKQogICAgIyBVc2UgdGhlIG9iamVjdCdzIGZ1bGx5IHF1YWxpZmllZCBuYW1lIGlmIGl0IGhhcyBvbmUKICAgICMgT3RoZXJ3aXNlLCB1c2UgdGhlIG1vZHVsZSdzIG5hbWUKICAgIHRyeToKICAgICAgICBuYW1lID0gIiVzLiVzIiAlIChvYmouX19tb2R1bGVfXywgb2JqLl9fcXVhbG5hbWVfXykKICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICBuYW1lID0gbW9kdWxlLl9fbmFtZV9fCiAgICBmb3IgZXhhbXBsZSBpbiBmaW5kZXIuZmluZChvYmosIG5hbWUsIG1vZHVsZSk6CiAgICAgICAgcnVubmVyLnJ1bihleGFtcGxlKQogICAgZiwgdCA9IHJ1bm5lci5mYWlsdXJlcywgcnVubmVyLnRyaWVzCiAgICBpZiBmOgogICAgICAgIHJhaXNlIHRlc3Quc3VwcG9ydC5UZXN0RmFpbGVkKCIlZCBvZiAlZCBkb2N0ZXN0cyBmYWlsZWQiICUgKGYsIHQpKQogICAgaWYgdmVyYm9zZToKICAgICAgICBwcmludCAoJ2RvY3Rlc3QgKCVzKSAuLi4gJWQgdGVzdHMgd2l0aCB6ZXJvIGZhaWx1cmVzJyAlIChtb2R1bGUuX19uYW1lX18sIHQpKQogICAgcmV0dXJuIGYsIHQKCgoKY2xhc3MgWmlwU3VwcG9ydFRlc3RzKHVuaXR0ZXN0LlRlc3RDYXNlKToKICAgICMgVGhpcyB1c2VkIHRvIHVzZSB0aGUgSW1wb3J0SG9va3NCYXNlVGVzdENhc2UgdG8gcmVzdG9yZQogICAgIyB0aGUgc3RhdGUgb2YgdGhlIGltcG9ydCByZWxhdGVkIGluZm9ybWF0aW9uCiAgICAjIGluIHRoZSBzeXMgbW9kdWxlIGFmdGVyIGVhY2ggdGVzdC4gSG93ZXZlciwgdGhhdCByZXN0b3JlcwogICAgIyAqdG9vIG11Y2gqIGluZm8uX3R5cGVfID0gbmFtZXNwYWNlWyJfdHlwZV8iXSA9IEMKICAgICAgICAgICAgICAgIGFzc2VydCBub3QgaGFzYXR0cihDLCAnX19wb2ludGVyX3R5cGVfXycpCiAgICAgICAgICAgICAgICBzdXBlcigpLl9faW5pdF9fKG5hbWUsIGJhc2VzLCBuYW1lc3BhY2UpCiAgICAgICAgICAgICAgICBhc3NlcnQgQy5fX3BvaW50ZXJfdHlwZV9fIGlzIHNlbGYKCiAgICAgICAgY2xhc3MgQyhjX3ZvaWRfcCk6ICAjIGN0eXBlcyB0eXBlCiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgY2xhc3MgUChjdHlwZXMuX1BvaW50ZXIsIG1ldGFjbGFzcz1Qb2ludGVyTWV0YSk6CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgc2VsZi5hc3NlcnRJcyhQLl90eXBlXywgQykKICAgICAgICBzZWxmLmFzc2VydElzKFAsIFBPSU5URVIoQykpCiIiIiBUZXN0IHRoZSBiZGIgbW9kdWxlLgoKICAgIEEgdGVzdCBkZWZpbmVzIGEgbGlzdCBvZiB0dXBsZXMgdGhhdCBtYXkgYmUgc2VlbiBhcyBwYWlyZWQgdHVwbGVzLCBlYWNoCiAgICBwYWlyIGJlaW5nIGRlZmluZWQgYnkgJ2V4cGVjdF90dXBsZSwgc2V0X3R1cGxlJyBhcyBmb2xsb3dzOgoKICAgICAgICAoW2V2ZW50LCBbbGluZW5vWywgY29fbmFtZVssIGVhcmdzXV1dXSksIChzZXRfdHlwZSwgW3NhcmdzXSkKCiAgICAqICdleHBlY3RfdHVwbGUnIGRlc2NyaWJlcyB0aGUgZXhwZWN0ZWQgY3VycmVudCBzdGF0ZSBvZiB0aGUgQmRiIGluc3RhbmNlLgogICAgICBJdCBtYXkgYmUgdGhlIGVtcHR5IHR1cGxlIGFuZCBubyBjaGVjayBpcyBkb25lIGluIHRoYXQgY2FzZS4KICAgICogJ3NldF90dXBsZScgZGVmaW5lcyB0aGUgc2V0XyooKSBtZXRob2QgdG8gYmUgaW52b2tlZCB3aGVuIHRoZSBCZGIKICAgICAgaW5zdGFuY2UgcmVhY2hlcyB0aGlzIHN0YXRlLgoKICAgIEV4YW1wbGUgb2YgYW4gJ2V4cGVjdF90dXBsZSwgc2V0X3R1cGxlJyBwYWlyOgoKICAgICAgICAoJ2xpbmUnLCAyLCAndGZ1bmNfbWFpbicpLCAoJ3N0ZXAnLCApCgogICAgRGVmaW5pdGlvbnMgb2YgdGhlIG1lbWJlcnMgb2YgdGhlICdleHBlY3RfdHVwbGUnOgogICAgICAgIGV2ZW50OgogICAgICAgICAgICBOYW1lIG9mIHRoZSB0cmFjZSBldmVudC4gVGhlIHNldCBtZXRob2RzIHRoYXQgZG8gbm90IGdpdmUgYmFjawogICAgICAgICAgICBjb250cm9sIHRvIHRoZSB0cmFjZXIgWzFdIGRvIG5vdCB0cmlnZ2VyIGEgdHJhY2VyIGV2ZW50IGFuZCBpbgogICAgICAgICAgICB0aGF0IGNhc2UgdGhlIG5leHQgJ2V2ZW50JyBtYXkgYmUgJ05vbmUnIGJ5IGNvbnZlbnRpb24sIGl0cyB2YWx1ZQogICAgICAgICAgICBpcyBub3QgY2hlY2tlZC4KICAgICAgICAgICAgWzFdIE1ldGhvZHMgdGhhdCB0cmlnZ2VyIGEgdHJhY2UgZXZlbnQgYXJlIHNldF9zdGVwKCksIHNldF9uZXh0KCksCiAgICAgICAgICAgIHNldF9yZXR1cm4oKSwgc2V0X3VudGlsKCkgYW5kIHNldF9jb250aW51ZSgpLgogICAgICAgIGxpbmVubzoKICAgICAgICAgICAgTGluZSBudW1ub3QgZGF0YTogICMgVGhpcyBoYXBwZW5zIGZvciB3aGl0ZXNwYWNlLW9ubHkgaW5wdXQuCiAgICAgICAgcmV0dXJuIE5vbmUKICAgICMgVGhlIEZXUyBhZnRlciB0aGUgY29tbWEgYWZ0ZXIgdGhlIGRheS1vZi13ZWVrIGlzIG9wdGlvbmFsLCBzbyBzZWFyY2ggYW5kCiAgICAjIGFkanVzdCBmb3IgdGhpcy4KICAgIGlmIGRhdGFbMF0uZW5kc3dpdGgoJywnKSBvciBkYXRhWzBdLmxvd2VyKCkgaW4gX2RheW5hbWVzOgogICAgICAgICMgVGhlcmUncyBhIGRheW5hbWUgaGVyZS4gU2tpcCBpdAogICAgICAgIGRlbCBkYXRhWzBdCiAgICBlbHNlOgogICAgICAgIGkgPSBkYXRhWzBdLnJmaW5kKCcsJykKICAgICAgICBpZiBpID49IDA6CiAgICAgICAgICAgIGRhdGFbMF0gPSBkYXRhWzBdW2krMTpdCiAgICBpZiBsZW4oZGF0YSkgPT0gMzogIyBSRkMgODUwIGRhdGUsIGRlcHJlY2F0ZWQKICAgICAgICBzdHVmZiA9IGRhdGFbMF0uc3BsaXQoJy0nKQogICAgICAgIGlmIGxlbihzdHVmZikgPT0gMzoKICAgICAgICAgICAgZGF0YSA9IHN0dWZmICsgZGF0YVsxOl0KICAgIGlmIGxlbihkYXRhKSA9PSA0OgogICAgICAgIHMgPSBkYXRhWzNdCiAgICAgICAgaSA9IHMuZmluZCgnKycpCiAgICAgICAgaWYgaSA9PSAtMToKICAgICAgICAgICAgaSA9IHMuZmluZCgnLScpCiAgICAgICAgaWYgaSA+IDA6CiAgICAgICAgICAgIGRhdGFbMzpdID0gW3NbOmldLCBzW2k6XV0KICAgICAgICBlbHNlOgogICAgICAgICAgICBkYXRhLmFwcGVuZCgnJykgIyBEdW1teSB0egogICAgaWYgbGVuKGRhdGEpIDwgNToKICAgICAgICByZXR1cm4gTm9uZQogICAgZGF0YSA9IGRhdGFbOjVdCiAgICBbZGQsIG1tLCB5eSwgdG0sIHR6XSA9IGRhdGEKICAgIGlmIG5vdCAoZGQgYW5kIG1tIGFuZCB5eSk6CiAgICAgICAgcmV0dXJuIE5vbmUKICAgIG1tID0gbW0ubG93ZXIoKQogICAgaWYgbW0gbm90IGluIF9tb250aG5hbWVzOgogICAgICAgIGRkLCBtbSA9IG1tLCBkZC5sb3dlcigpCiAgICAgICAgaWYgbW0gbm90IGluIF9tb250aG5hbWVzOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgbW0gPSBfbW9udGhuYW1lcy5pbmRleChtbSkgKyAxCiAgICBpZiBtbSA+IDEyOgogICAgICAgIG1tIC09IDEyCiAgICBpZiBkZFstMV0gPT0gJywnOgogICAgICAgIGRkID0gZGRbOi0xXQogICAgaSA9IHl5LmZpbmQoJzonKQogICAgaWYgaSA+IDA6CiAgICAgICAgeXksIHRtID0gdG0sIHl5CiAgICBpZiB5eVstMV0gPT0gJywnOgogICAgICAgIHl5ID0geXlbOi0xXQogICAgICAgIGlmIG5vdCB5eToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgIGlmIG5vdCB5eVswXS5pc2RpZ2l0KCk6CiAgICAgICAgeXksIHR6ID0gdHosIHl5CiAgICBpZiB0bVstMV0gPT0gJywnOgogICAgICAgIHRtID0gdG1bOi0xXQogICAgdG0gPSB0bS5zcGxpdCgnOicpCiAgICBpZiBsZW4odG0pID09IDI6CiAgICAgICAgW3RoaCwgdG1tXSA9IHRtCiAgICAgICAgdHNzID0gJzAnCiAgbGUgdGhhdCByZXR1cm5zIGRlZmF1bHRfc3RvcmFnZSBpcyBub3Qgb21pdHRlZCB3aGVuCiAgICAgICAgZGVjb25zdHJ1Y3RpbmcuCiAgICAgICAgIiIiCiAgICAgICAgb2JqID0gU3RvcmFnZSgpCiAgICAgICAgKl8sIGt3YXJncyA9IG9iai5fbWV0YS5nZXRfZmllbGQoInN0b3JhZ2VfY2FsbGFibGVfZGVmYXVsdCIpLmRlY29uc3RydWN0KCkKICAgICAgICBzZWxmLmFzc2VydElzKGt3YXJnc1sic3RvcmFnZSJdLCBjYWxsYWJsZV9kZWZhdWx0X3N0b3JhZ2UpCgoKIyBUZXN0cyBmb3IgYSByYWNlIGNvbmRpdGlvbiBvbiBmaWxlIHNhdmluZyAoIzQ5NDgpLgojIFRoaXMgaXMgd3JpdHRlbiBpbiBzdWNoIGEgd2F5IHRoYXQgaXQnbGwgYWx3YXlzIHBhc3Mgb24gcGxhdGZvcm1zCiMgd2l0aG91dCB0aHJlYWRpbmcuCgoKY2xhc3MgU2xvd0ZpbGUoQ29udGVudEZpbGUpOgogICAgZGVmIGNodW5rcyhzZWxmKToKICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAgICAgcmV0dXJuIHN1cGVyKCkuY2h1bmtzKCkKCgpjbGFzcyBGaWxlU2F2ZVJhY2VDb25kaXRpb25UZXN0KFNpbXBsZVRlc3RDYXNlKToKICAgIGRlZiBzZXRVcChzZWxmKToKICAgICAgICBzZWxmLnN0b3JhZ2VfZGlyID0gdGVtcGZpbGUubWtkdGVtcCgpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHNodXRpbC5ybXRyZWUsIHNlbGYuc3RvcmFnZV9kaXIpCiAgICAgICAgc2VsZi5zdG9yYWdlID0gRmlsZVN5c3RlbVN0b3JhZ2Uoc2VsZi5zdG9yYWdlX2RpcikKICAgICAgICBzZWxmLnRocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuc2F2ZV9maWxlLCBhcmdzPVsiY29uZmxpY3QiXSkKCiAgICBkZWYgc2F2ZV9maWxlKHNlbGYsIG5hbWUpOgogICAgICAgIG5hbWUgPSBzZWxmLnN0b3JhZ2Uuc2F2ZShuYW1lLCBTbG93RmlsZShiIkRhdGEiKSkKCiAgICBkZWYgdGVzdF9yYWNlX2NvbmRpdGlvbihzZWxmKToKICAgICAgICBzZWxmLnRocmVhZC5zdGFydCgpCiAgICAgICAgc2VsZi5zYXZlX2ZpbGUoImNvbmZsaWN0IikKICAgICAgICBzZWxmLnRocmVhZC5qb2luKCkKICAgICAgICBmaWxlcyA9IHNvcnRlZChvcy5saXN0ZGlyKHNlbGYuc3RvcmFnZV9kaXIpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZmlsZXNbMF0sICJjb25mbGljdCIpCiAgICAgICAgc2VsZi5hc3NlcnRSZWdleChmaWxlc1sxXSwgImNvbmZsaWN0XyVzIiAlIEZJTEVfU1VGRklYX1JFR0VYKQoKCkB1bml0dGVzdC5za2lwSWYoCiAgICBzeXMucGxhdGZvcm0gPT0gIndpbjMyIiwgIldpbmRvd3Mgb25seSBwYXJ0aWFsbHkgc3VwcG9ydHMgdW1hc2tzIGFuZCBjaG1vZC4iCikKY2xhc3MgRmlsZVN0b3JhZ2VQZXJtaXNzaW9ucyh1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgc2VsZi51bWFzayA9IDBvMDI3CiAgICAgICAgb2xkX3VtYXNrID0gb3MudW1hc2soc2VsZi51bWFzaykKICAgICAgICBzZWxmLmFkZENsZWFudXAob3MudW1hc2ssIG9sZF9kb2NzLm9yYWNsZS5jb20vZW4vZGF0YWJhc2Uvb3JhY2xlL29yYWNsZS1kYXRhYmFzZS8yMS9zcWxyZi9ST1VORC1hbmQtVFJVTkMtRGF0ZS1GdW5jdGlvbnMuaHRtbAogICAgICAgIHRydW5jX3BhcmFtID0gTm9uZQogICAgICAgIGlmIGxvb2t1cF90eXBlIGluICgieWVhciIsICJtb250aCIpOgogICAgICAgICAgICB0cnVuY19wYXJhbSA9IGxvb2t1cF90eXBlLnVwcGVyKCkKICAgICAgICBlbGlmIGxvb2t1cF90eXBlID09ICJxdWFydGVyIjoKICAgICAgICAgICAgdHJ1bmNfcGFyYW0gPSAiUSIKICAgICAgICBlbGlmIGxvb2t1cF90eXBlID09ICJ3ZWVrIjoKICAgICAgICAgICAgdHJ1bmNfcGFyYW0gPSAiSVciCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIGYiVFJVTkMoe3NxbH0pIiwgcGFyYW1zCiAgICAgICAgcmV0dXJuIGYiVFJVTkMoe3NxbH0sICVzKSIsICgqcGFyYW1zLCB0cnVuY19wYXJhbSkKCiAgICAjIE9yYWNsZSBjcmFzaGVzIHdpdGggIk9SQS0wMzExMzogZW5kLW9mLWZpbGUgb24gY29tbXVuaWNhdGlvbiBjaGFubmVsIgogICAgIyBpZiB0aGUgdGltZSB6b25lIG5hbWUgaXMgcGFzc2VkIGluIHBhcmFtZXRlci4gVXNlIGludGVycG9sYXRpb24gaW5zdGVhZC4KICAgICMgaHR0cHM6Ly9ncm91cHMuZ29vZ2xlLmNvbS9mb3J1bS8jIW1zZy9kamFuZ28tZGV2ZWxvcGVycy96d1FqdTdoYkc3OC85bDkzNHllbHdmc0oKICAgICMgVGhpcyByZWdleHAgbWF0Y2hlcyBhbGwgdGltZSB6b25lIG5hbWVzIGZyb20gdGhlIHpvbmVpbmZvIGRhdGFiYXNlLgogICAgX3R6bmFtZV9yZSA9IF9sYXp5X3JlX2NvbXBpbGUociJeW1x3LzorLV0rJCIpCgogICAgZGVmIF9wcmVwYXJlX3R6bmFtZV9kZWx0YShzZWxmLCB0em5hbWUpOgogICAgICAgIHR6bmFtZSwgc2lnbiwgb2Zmc2V0ID0gc3BsaXRfdHpuYW1lX2RlbHRhKHR6bmFtZSkKICAgICAgICByZXR1cm4gZiJ7c2lnbn17b2Zmc2V0fSIgaWYgb2Zmc2V0IGVsc2UgdHpuYW1lCgogICAgZGVmIF9jb252ZXJ0X3NxbF90b190eihzZWxmLCBzcWwsIHBhcmFtcywgdHpuYW1lKToKICAgICAgICBpZiBub3QgKHNldHRpbmdzLlVTRV9UWiBhbmQgdHpuYW1lKToKICAgICAgICAgICAgcmV0dXJuIHNxbCwgcGFyYW1zCiAgICAgICAgaWYgbm90IHNlbGYuX3R6bmFtZV9yZS5tYXRjaCh0em5hbWUpOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJJbnZhbGlkIHRpbWUgem9uZSBuYW1lOiAlcyIgJSB0em5hbWUpCiAgICAgICAgIyBDb252ZXJ0IGZyb20gY29ubmVjdGlvbiB0aW1lem9uZSB0byB0aGUgbG9jYWwgdGltZSwgcmV0dXJuaW5nCiAgICAgICAgIyBUSU1FU1RBTVAgV0lUSCBUSU1FIFpPTkUgYW5kIGNhc3QgaXQgYmFjayB0byBUSU1FU1RBTVAgdG8gc3RyaXAgdGhlCiAgICAgICAgIyBUSU1FIFpPTkUgZGV0YWlscy4KICAgICAgICBpZiBzZWxmLmNvbm5lY3Rpb24udGltZXpvbmVfbmFtZSAhPSB0em5hbWU6CiAgICAgICAgICAgIGZyb21fdGltZWRlZiBjbWQodGtwYXRoLCBmdW5jKToKICAgICAgICAgICAgYXNzZXJ0IGlzaW5zdGFuY2UodGtwYXRoLCBzdHIpCiAgICAgICAgICAgIGFzc2VydCBpc2luc3RhbmNlKGZ1bmMsIHR5cGUoY21kKSkKICAgICAgICBjbHMucm9vdC5jcmVhdGVjb21tYW5kID0gY21kCgogICAgQGNsYXNzbWV0aG9kCiAgICBkZWYgdGVhckRvd25DbGFzcyhjbHMpOgogICAgICAgIGNscy5yb290LnVwZGF0ZV9pZGxldGFza3MoKQogICAgICAgIGNscy5yb290LmRlc3Ryb3koKQogICAgICAgIGRlbCBjbHMucm9vdAoKICAgIEBtb2NrLnBhdGNoKCdpZGxlbGliLm1hY29zeC5vdmVycmlkZVJvb3RNZW51JykgICMyNzMxMgogICAgZGVmIHRlc3Rfc2V0dXBhcHAoc2VsZiwgb3ZlcnJpZGVSb290TWVudSk6CiAgICAgICAgIkNhbGwgc2V0dXBBcHAgd2l0aCBlYWNoIHBvc3NpYmxlIGdyYXBoaWNzIHR5cGUuIgogICAgICAgIHJvb3QgPSBzZWxmLnJvb3QKICAgICAgICBmbGlzdCA9IEZpbGVMaXN0KHJvb3QpCiAgICAgICAgZm9yIHRrdHlwZSBpbiBhbGx0eXBlczoKICAgICAgICAgICAgd2l0aCBzZWxmLnN1YlRlc3QodGt0eXBlPXRrdHlwZSk6CiAgICAgICAgICAgICAgICBtYWNvc3guX3RrX3R5cGUgPSB0a3R5cGUKICAgICAgICAgICAgICAgIG1hY29zeC5zZXR1cEFwcChyb290LCBmbGlzdCkKICAgICAgICAgICAgICAgIGlmIHRrdHlwZSBpbiAoJ2NhcmJvbicsICdjb2NvYScpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShvdmVycmlkZVJvb3RNZW51LmNhbGxlZCkKICAgICAgICAgICAgICAgIG92ZXJyaWRlUm9vdE1lbnUucmVzZXRfbW9jaygpCgoKaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKICAgIHVuaXR0ZXN0Lm1haW4odmVyYm9zaXR5PTIpCiIiIgpTeW5kaWNhdGlvbiBmZWVkIGdlbmVyYXRpb24gbGlicmFyeSAtLSB1c2VkIGZvciBnZW5lcmF0aW5nIFJTUywgZXRjLgoKU2FtcGxlIHVzYWdlOgoKPj4+IGZyb20gZGphbmdvLnV0aWxzIGltcG9ydCBmZWVkZ2VuZXJhdG9yCj4+PiBmZWVkID0gZmVlZGdlbmVyYXRvci5Sc3MyMDFyZXYyRmVlZCgKLi4uICAgICB0aXRsZT0iUG95bnRlciBFLU1lZGlhIFRpZGJpdHMiLAouLi4gICAgIGxpbms9Imh0dHA6Ly93d3cucG95bnRlci5vcmcvY29sdW1uLmFzcD9pZD0zMSIsCi4uLiAgICAgZGVzY3JpcHRpb249IkEgZ3JvdXAgYmxvZyBieSB0aGUgc2hhcnBlc3QgbWluZHMgaW4gb25saW5lIGpvdXJuYWxpc20uIiwKLi4uICAgICBsYW5ndWFnZT0iZW4iLAouLi4gKQo+Pj4gZmVlZC5hZGRfaXRlbSgKLi4uICAgICB0aXRsZT0iSGVsbG8iLAouLi4gICAgIGxpbms9Imh0dHA6Ly93d3cuaG9sb3ZhdHkuY29tL3Rlc3QvIiwKLi4uICAgICBkZXNjcmlwdGlvbj0iVGVzdGluZy4iCi4uLiApCj4+PiB3aXRoIG9wZW4oJ3Rlc3QucnNzJywgJ3cnKSBhcyBmcDoKLi4uICAgICBmZWVkLndyaXRlKGZwLCAndXRmLTgnKQoKRm9yIGRlZmluaXRpb25zIG9mIHRoZSBkaWZmZXJlbnQgdmVyRSBTT0xJRFVTCiAgICAnXScgICAgICAgICMgIDB4NUQgLT4gUklHSFQgU1FVQVJFIEJSQUNLRVQKICAgICdeJyAgICAgICAgIyAgMHg1RSAtPiBDSVJDVU1GTEVYIEFDQ0VOVAogICAgJ18nICAgICAgICAjICAweDVGIC0+IExPVyBMSU5FCiAgICAnYCcgICAgICAgICMgIDB4NjAgLT4gR1JBVkUgQUNDRU5UCiAgICAnYScgICAgICAgICMgIDB4NjEgLT4gTEFUSU4gU01BTEwgTEVUVEVSIEEKICAgICdiJyAgICAgICAgIyAgMHg2MiAtPiBMQVRJTiBTTUFMTCBMRVRURVIgQgogICAgJ2MnICAgICAgICAjICAweDYzIC0+IExBVElOIFNNQUxMIExFVFRFUiBDCiAgICAnZCcgICAgICAgICMgIDB4NjQgLT4gTEFUSU4gU01BTEwgTEVUVEVSIEQKICAgICdlJyAgICAgICAgIyAgMHg2NSAtPiBMQVRJTiBTTUFMTCBMRVRURVIgRQogICAgJ2YnICAgICAgICAjICAweDY2IC0+IExBVElOIFNNQUxMIExFVFRFUiBGCiAgICAnZycgICAgICAgICMgIDB4NjcgLT4gTEFUSU4gU01BTEwgTEVUVEVSIEcKICAgICdoJyAgICAgICAgIyAgMHg2OCAtPiBMQVRJTiBTTUFMTCBMRVRURVIgSAogICAgJ2knICAgICAgICAjICAweDY5IC0+IExBVElOIFNNQUxMIExFVFRFUiBJCiAgICAnaicgICAgICAgICMgIDB4NkEgLT4gTEFUSU4gU01BTEwgTEVUVEVSIEoKICAgICdrJyAgICAgICAgIyAgMHg2QiAtPiBMQVRJTiBTTUFMTCBMRVRURVIgSwogICAgJ2wnICAgICAgICAjICAweDZDIC0+IExBVElOIFNNQUxMIExFVFRFUiBMCiAgICAnbScgICAgYmxlIHQodCkiKQogICAgICAgICAgICAgICAgY3guZXhlY3V0ZW1hbnkoImluc2VydCBpbnRvIHQgdmFsdWVzKD8pIiwgKCh2LCkgZm9yIHYgaW4gcmFuZ2UoMykpKQoKICAgIEB3aXRoX3RyYWNlYmFja3MoCiAgICAgICAgc3FsaXRlLkRhdGFFcnJvciwKICAgICAgICByZWdleD0iRXhwYW5kZWQgU1FMIHN0cmluZyBleGNlZWRzIHRoZSBtYXhpbXVtIHN0cmluZyBsZW5ndGgiCiAgICApCiAgICBkZWYgdGVzdF90cmFjZV90b29fbXVjaF9leHBhbmRlZF9zcWwoc2VsZik6CiAgICAgICAgIyBJZiB0aGUgZXhwYW5kZWQgc3RyaW5nIGlzIHRvbyBsYXJnZSwgd2UnbGwgZmFsbCBiYWNrIHRvIHRoZQogICAgICAgICMgdW5leHBhbmRlZCBTUUwgc3RhdGVtZW50LgogICAgICAgICMgVGhlIHJlc3VsdGluZyBzdHJpbmcgbGVuZ3RoIGlzIGxpbWl0ZWQgYnkgdGhlIHJ1bnRpbWUgbGltaXQKICAgICAgICAjIFNRTElURV9MSU1JVF9MRU5HVEguCiAgICAgICAgdGVtcGxhdGUgPSAic2VsZWN0IDEgYXMgYSB3aGVyZSBhPSIKICAgICAgICBjYXRlZ29yeSA9IHNxbGl0ZS5TUUxJVEVfTElNSVRfTEVOR1RICiAgICAgICAgd2l0aCBtZW1vcnlfZGF0YWJhc2UoKSBhcyBjeCwgY3hfbGltaXQoY3gsIGNhdGVnb3J5PWNhdGVnb3J5KSBhcyBsaW06CiAgICAgICAgICAgIG9rX3BhcmFtID0gImEiCiAgICAgICAgICAgIGJhZF9wYXJhbSA9ICJhIiAqIGxpbQoKICAgICAgICAgICAgdW5leHBhbmRlZF9xdWVyeSA9IHRlbXBsYXRlICsgIj8iCiAgICAgICAgICAgIGV4cGVjdGVkID0gW3VuZXhwYW5kZWRfcXVlcnldCiAgICAgICAgICAgIHdpdGggc2VsZi5jaGVja19zdG10X3RyYWNlKGN4LCBleHBlY3RlZCk6CiAgICAgICAgICAgICAgICBjeC5leGVjdXRlKHVuZXhwYW5kZWRfcXVlcnksIChiYWRfcGFyYW0sKSkKCiAgICAgICAgICAgIGV4cGFuZGVkX3F1ZXJ5ID0gZiJ7dGVtcGxhdGV9J3tva19wYXJhbX0nIgogICAgICAgICAgICB3aXRoIHNlbGYuY2hlY2tfc3RtdF90cmFjZShjeCwgW2V4cGFuZGVkX3F1ZXJ5XSk6CiAgICAgICAgICAgICAgICBjeC5leGVjdXRlKHVuZXhwYW5kZWRfcXVlcnksIChva19wYXJhbSwpKQoKICAgIEB3aXRoX3RyYWNlYmFja3MoWmVyb0RpdmlzaW9uRXJyb3IsIHJlZ2V4PSJkaXZpc2lvbiBieSB6ZXJvIikKICAgIGRlZiB0ZXN0X3RyYWNlX2JhZF9oYW5kbGVyKHNlbGYpOgogICAgICAgIHdpdGggbWVtb3J5X2RhdGFiYXNlKCkgYXMgY3g6CiAgICAgICAgICAgIGN4LnNldF90cmFjZV9jYWxsYmFjayhsYW1iZGEgc3RtdDogNS8wKQogICAgICAgICAgICBjeC5leGVjdXRlKCJzZWxlY3QgMSIpCgogICAgZGVmIHRlc3Rfc2V0X3RyYWNlX2NhbGxiYWNrX2tleXdvcmRfYXJncyhzZWxmKToKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzUmVnZXgoVHlwZUVycm9yLAogICAgICAgICAgICAgICAgJ3Rha2VzIGV4YWN0bHkgMSBwb3NpdGlvbmFsIGFyZ3VtZW50Jyk6CiAgICAgICAgICAgIHNlbGYuY29uLnNlaygpKCkKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChtb2NrLm1vY2tfY2FsbHMsIFtjYWxsKCksIGNhbGwoKSgpXSkKCgogICAgZGVmIHRlc3RfbWFuYWdlcl9tb2NrKHNlbGYpOgogICAgICAgIGNsYXNzIEZvbyhvYmplY3QpOgogICAgICAgICAgICBvbmUgPSAnb25lJwogICAgICAgICAgICB0d28gPSAndHdvJwogICAgICAgIG1hbmFnZXIgPSBNb2NrKCkKICAgICAgICBwMSA9IHBhdGNoLm9iamVjdChGb28sICdvbmUnKQogICAgICAgIHAyID0gcGF0Y2gub2JqZWN0KEZvbywgJ3R3bycpCgogICAgICAgIG1vY2tfb25lID0gcDEuc3RhcnQoKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwMS5zdG9wKQogICAgICAgIG1vY2tfdHdvID0gcDIuc3RhcnQoKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwMi5zdG9wKQoKICAgICAgICBtYW5hZ2VyLmF0dGFjaF9tb2NrKG1vY2tfb25lLCAnb25lJykKICAgICAgICBtYW5hZ2VyLmF0dGFjaF9tb2NrKG1vY2tfdHdvLCAndHdvJykKCiAgICAgICAgRm9vLnR3bygpCiAgICAgICAgRm9vLm9uZSgpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwobWFuYWdlci5tb2NrX2NhbGxzLCBbY2FsbC50d28oKSwgY2FsbC5vbmUoKV0pCgoKICAgIGRlZiB0ZXN0X21hZ2ljX21ldGhvZHNfbW9ja19jYWxscyhzZWxmKToKICAgICAgICBmb3IgS2xhc3MgaW4gTW9jaywgTWFnaWNNb2NrOgogICAgICAgICAgICBtID0gS2xhc3MoKQogICAgICAgICAgICBtLl9faW50X18gPSBNb2NrKHJldHVybl92YWx1ZT0zKQogICAgICAgICAgICBtLl9fZmxvYXRfXyA9IE1hZ2ljTW9jayhyZXR1cm5fdmFsdWU9My4wKQogICAgICAgICAgICBpbnQobSkKICAgICAgICAgICAgZmxvYXQobSkKCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwobS5tb2NrX2NhbGxzLCBbY2FsbC5fX2ludF9fKCksIGNhbGwuX19mbG9hdF9fKCldKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKG0ubWV0aG9kX2NhbGxzLCBbXSkKCiAgICBkZWYgdGVzdF9tb2NrX29wZW5fcmV1c2VfaXNzdWVfMjE3NTAoc2VsZik6CiAgICAgICAgbW9ja2VkX29wZW4gPSBtb2NrLm1vY2tfb3BlbihyZWFkX2RhdGE9J2RhdGEnKQogICAgICAgIGYxID0gbW9ja2VkX29wZW4oJ2EtbmFtZScpCiAgICAgICAgZjFfZGF0YSA9IGYxLnJlYWQoKQogICAgICAgIGYyID0gbW9ja2VkX29wZW4oJ2Fub3RoZXItbmFtZScpCiAgICAgICAgZjJfZGF0YSA9IGYyLnJlYWQoKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZjFfZGF0YSwgZjJfZGF0YSkKCiAgICBkZWYgdGVzdF9tb2NrX29wZW5fZHVuZGVyX2l0ZXJfaXNzdWUoc2VsZik6CiAgICAgICAgIyBUZXN0IGR1bmRlcl9pdGVyIG1ldGhvZCBnZW5lcmF0ZXMgdGhlIGV4cGVjdGVkIHJlc3VsdCBhbmQKICAgICAgICAjIGNvbnN1bWVzIHRoZSBpdGVyYXRvci4KICAgICAgICBtb2NrZWRfb3BlbiA9IG1vY2subW9ja19vcGVuKHJlYWRfZGF0YT0nUmVtYXJrYWJsZVxuTm9yd2VnaWFuIEJsdWUnKQogeV9ib29rIikpLCA0KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoCiAgICAgICAgICAgIGxlbihCb29rLm9iamVjdHMucmF3KCJTRUxFQ1QgKiBGUk9NIHJhd19xdWVyeV9ib29rIFdIRVJFIGlkID0gMCIpKSwgMAogICAgICAgICkKIiIiUEVQIDM2NiAoIk1haW4gbW9kdWxlIGV4cGxpY2l0IHJlbGF0aXZlIGltcG9ydHMiKSBzcGVjaWZpZXMgdGhlCnNlbWFudGljcyBmb3IgdGhlIF9fcGFja2FnZV9fIGF0dHJpYnV0ZSBvbiBtb2R1bGVzLiBUaGlzIGF0dHJpYnV0ZSBpcwp1c2VkLCB3aGVuIGF2YWlsYWJsZSwgdG8gZGV0ZWN0IHdoaWNoIHBhY2thZ2UgYSBtb2R1bGUgYmVsb25ncyB0byAoaW5zdGVhZApvZiB1c2luZyB0aGUgdHlwaWNhbCBfX3BhdGhfXy9fX25hbWVfXyB0ZXN0KS4KCiIiIgppbXBvcnQgdW5pdHRlc3QKaW1wb3J0IHdhcm5pbmdzCmZyb20gdGVzdC50ZXN0X2ltcG9ydGxpYiBpbXBvcnQgdXRpbAoKCmNsYXNzIFVzaW5nX19wYWNrYWdlX186CgogICAgIiIiVXNlIG9mIF9fcGFja2FnZV9fIHN1cGVyc2VkZXMgdGhlIHVzZSBvZiBfX25hbWVfXy9fX3BhdGhfXyB0byBjYWxjdWxhdGUKICAgIHdoYXQgcGFja2FnZSBhIG1vZHVsZSBiZWxvbmdzIHRvLiBUaGUgYmFzaWMgYWxnb3JpdGhtIGlzIFtfX3BhY2thZ2VfX106OgoKICAgICAgZGVmIHJlc29sdmVfbmFtZShuYW1lLCBwYWNrYWdlLCBsZXZlbCk6CiAgICAgICAgICBsZXZlbCAtPSAxCiAgICAgICAgICBiYXNlID0gcGFja2FnZS5yc3BsaXQoJy4nLCBsZXZlbClbMF0KICAgICAgICAgIHJldHVybiAnezB9LnsxfScuZm9ybWF0KGJhc2UsIG5hbWUpCgogICAgQnV0IHNpbmNlIHRoZXJlIGlzIG5vIGd1YXJhbnRlZSB0aGF0IF9fcGFja2FnZV9fIGhhcyBiZWVuIHNldCAob3Igbm90IGJlZW4KICAgIHNldCB0byBOb25lIFtOb25lXSksIHRoZXJlIGhhcyB0byBiZSBhIHdheSB0byBjYWxjdWxhdGUgdGhlIGF0dHJpYnV0ZSdzIHZhbHVlCiAgICBbX19uYW1lX19dOjoKCiAgICAgIGRlZiBjYWxjX3BhY2thZ2UoY2FsbGVyX25hbWUsIGhhc19fX3BhdGhfXyk6CiAgICAgICAgICBpZiBoYXNfX3BhdGhfXzoKICAgICAgICAgICAgICByZXR1cm4gY2FsbGVyX25hbWUKICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgcmV0dXJuIGNhbGxlcl9uYW1lLnJzcGxpdCgnLicsIDEpWzBdCgogICAgVGhlbiB0aGUgbm9ybWFsIGFsZ29yaXRobSBmb3IgcmVsYXRpdmUgbmFtZSBpbXBvcnRzIGNhbiBwcm9jZWVkIGFzIGlmCiAgICBfX3BhY2thZ2VfXyBoYWQgYmVlbiBzZXQuCgogICAgIiIiCgogICAgZGVmIGltcG9ydF9tb2R1bGUoc2VsZiwgZ2xvYmFsc18pOgogICAgICAgIHdpdGggc2VsZi5tb2NrX21vZHVsZXMoJ3BrZy5fX2luaXRfXycsICdwa2cuZmFrZScpIGFzIGltcG9ydGVyOgogICAgICAgICAgICB3aXRoIHV0aWwuaW1wb3J0X3N0YXRlKG1ldGFfcGF0aD1baW1wb3J0ZXJdKToKICAgICAgICAgICAgICAgIHNlbGYuX19pbXBvcnRfXygncGtnLmZha2UnKQogIGluIHNuZGhkciB0aGF0IGRvbid0IGhhdmUgTUlNRSB0eXBlcy4gOigKIyBBZGRpdGlvbmFsIG9uZXMgdG8gYmUgYWRkZWQgdG8gc25kaGRyPyBtaWRpLCBtcDMsIHJlYWxhdWRpbywgd21hPz8KZGVmIF93aGF0KGRhdGEpOgogICAgIyBUcnkgdG8gaWRlbnRpZnkgYSBzb3VuZCBmaWxlIHR5cGUuCiAgICAjCiAgICAjIHNuZGhkci53aGF0KCkgaGFkIGEgcHJldHR5IGNydWRkeSBpbnRlcmZhY2UsIHVuZm9ydHVuYXRlbHkuICBUaGlzIGlzIHdoeQogICAgIyB3ZSByZS1kbyBpdCBoZXJlLiAgSXQgd291bGQgYmUgZWFzaWVyIHRvIHJldmVyc2UgZW5naW5lZXIgdGhlIFVuaXggJ2ZpbGUnCiAgICAjIGNvbW1hbmQgYW5kIHVzZSB0aGUgc3RhbmRhcmQgJ21hZ2ljJyBmaWxlLCBhcyBzaGlwcGVkIHdpdGggYSBtb2Rlcm4gVW5peC4KICAgIGZvciB0ZXN0Zm4gaW4gX3J1bGVzOgogICAgICAgIGlmIHJlcyA6PSB0ZXN0Zm4oZGF0YSk6CiAgICAgICAgICAgIHJldHVybiByZXMKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIE5vbmUKCgpkZWYgcnVsZShydWxlZnVuYyk6CiAgICBfcnVsZXMuYXBwZW5kKHJ1bGVmdW5jKQogICAgcmV0dXJuIHJ1bGVmdW5jCgoKQHJ1bGUKZGVmIF9haWZmKGgpOgogICAgaWYgbm90IGguc3RhcnRzd2l0aChiJ0ZPUk0nKToKICAgICAgICByZXR1cm4gTm9uZQogICAgaWYgaFs4OjEyXSBpbiB7YidBSUZDJywgYidBSUZGJ306CiAgICAgICAgcmV0dXJuICd4LWFpZmYnCiAgICBlbHNlOgogICAgICAgIHJldHVybiBOb25lCgoKQHJ1bGUKZGVmIF9hdShoKToKICAgIGlmIGguc3RhcnRzd2l0aChiJy5zbmQnKToKICAgICAgICByZXR1cm4gJ2Jhc2ljJwogICAgZWxzZToKICAgICAgICByZXR1cm4gTm9uZQoKCkBydWxlCmRlZiBfd2F2KGgpOgogICAgIyAnUklGRicgPGxlbj4gJ1dBVkUnICdmbXQgJyA8bGVuPgogICAgaWYgbm90IGguc3RhcnRzd2l0aChiJ1JJRkYnKSBvciBoWzg6MTJdICE9IGInV0FWRScgb3IgaFsxMjoxNl0gIT0gYidmbXQgJzoKICAgICAgICByZXR1cm4gTm9uZQogICAgZWxzZToKICAgICAgICByZXR1cm4gIngtd2F2IgojIFRoaXMgdGVzdHMgdGhlIGludGVybmFsIF9vYmplY3RzIGF0dHJpYnV0ZQoKIyBYWFggVGhpcyB0ZXN0IG11c3QgYmUgcmV2aWV3ZWQgZm9yIGNvcnJlY3RuZXNzISEhCgojIGN0eXBlcycgdHlwZXMgYXJlIGNvbnRhaW5lciB0eXBlcy4KIwojIFRoZXkgaGF2ZSBhbiBpbnRlcm5hbCBtZW1vcnkgYmxvY2ssIHdoaWNoIG9ubHkgY29uc2lzdHMgb2Ygc29tZSBieXRlcywKIyBidXQgaXQgaGFzIHRvIGtlZXAgcmVmZXJlbmNlcyB0byBvdGhlciBvYmplY3RzIGFzIHdlbGwuIFRoaXMgaXMgbm90CiMgcmVhbGx5IG5lZWRlZCBmb3IgdHJpdmlhbCBDIHR5cGVzIGxpa2UgaW50IG9yIGNoYXIsIGJ1dCBpdCBpcyBpbXBvcnRhbnQKIyBmb3IgYWdncmVnYXRlIHR5cGVzIGxpa2Ugc3RyaW5ncyBvciBwb2ludGVycyBpbiBwYXJ0aWN1bGFyLgojCiMgV2hhdCBhYm91dCBwb2llY2soIjxhIGhyZWY9amF2YXNjcmlwdDpwb3B1cCgnL3BvcHVwL2hlbHAuaHRtbCcpPiIsCiAgICAgICAgICAgICAgICAgICAgICAgIFsoInN0YXJ0dGFnIiwgImEiLAogICAgICAgICAgICAgICAgICAgICAgICAgIFsoImhyZWYiLCAiamF2YXNjcmlwdDpwb3B1cCgnL3BvcHVwL2hlbHAuaHRtbCcpIildKV0pCgogICAgZGVmIHRlc3RfZW5kX3RhZ19pbl9hdHRyaWJ1dGVfdmFsdWUoc2VsZik6CiAgICAgICAgIyBzZWUgIzE3NDU3NjEKICAgICAgICBzZWxmLl9ydW5fY2hlY2soIjxhIGhyZWY9J2h0dHA6Ly93d3cuZXhhbXBsZS5vcmcvXCI+Oyc+c3BhbTwvYT4iLAogICAgICAgICAgICAgICAgICAgICAgICBbKCJzdGFydHRhZyIsICJhIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBbKCJocmVmIiwgImh0dHA6Ly93d3cuZXhhbXBsZS5vcmcvXCI+OyIpXSksCiAgICAgICAgICAgICAgICAgICAgICAgICAoImRhdGEiLCAic3BhbSIpLCAoImVuZHRhZyIsICJhIildKQoKICAgIGRlZiB0ZXN0X3dpdGhfdW5xdW90ZWRfYXR0cmlidXRlcyhzZWxmKToKICAgICAgICAjIHNlZSAjMTIwMDgKICAgICAgICBodG1sID0gKCI8aHRtbD48Ym9keSBiZ2NvbG9yPWQwY2E5MCB0ZXh0PScxODEwMDgnPiIKICAgICAgICAgICAgICAgICI8dGFibGUgY2VsbHNwYWNpbmc9MCBjZWxscGFkZGluZz0xIHdpZHRoPTEwMCUgPjx0cj4iCiAgICAgICAgICAgICAgICAiPHRkIGFsaWduPWxlZnQ+PGZvbnQgc2l6ZT0tMT4iCiAgICAgICAgICAgICAgICAiLSA8YSBocmVmPS9yYWJvdGEvPjxzcGFuIGNsYXNzPWVuPiBzb2Z0d2FyZS1hbmQtaTwvc3Bhbj48L2E+IgogICAgICAgICAgICAgICAgIi0gPGEgaHJlZj0nLzEvJz48c3BhbiBjbGFzcz1lbj4gbGlicmFyeTwvc3Bhbj48L2E+PC90YWJsZT4iKQogICAgICAgIGV4cGVjdGVkID0gWwogICAgICAgICAgICAoJ3N0YXJ0dGFnJywgJ2h0bWwnLCBbXSksCiAgICAgICAgICAgICgnc3RhcnR0YWcnLCAnYm9keScsIFsoJ2JnY29sb3InLCAnZDBjYTkwJyksICgndGV4dCcsICcxODEwMDgnKV0pLAogICAgICAgICAgICAoJ3N0YXJ0dGFnJywgJ3RhYmxlJywKICAgICAgICAgICAgICAgIFsoJ2NlbGxzcGFjaW5nJywgJzAnKSwgKCdjZWxscGFkZGluZycsICcxJyksICgnd2lkdGgnLCAnMTAwJScpXSksCiAgICAgICAgICAgICgnc3RhcnR0YWcnLCAndHInLCBbXSksCiAgICAgICAgICAgICgnc3RhcnR0YWcnLCAndGQnLCBbKCdhbGlnbicsICdsZWZ0JyldKSwKICAgICAgICAgICAgKCdzdGFydHRhZycsICdmb250JywgWygnc2l6ZScsICctMScpXSksCiAgICAgICAgICAgICgnZGF0YScsICctICcpLCAoJ3N0YXJ0dGFnJywgJ2EnLCBbKCdocmVmJywgJy9yYWJvdGEvJyldKSwKICAgICAgICAgICAgKCdzdGFydHRhZycsICdzcGFuJywgWygnY2xhc3MnLCAnZW4nKV0pLCAoJ2RhdGEnLCAnIHNvZnR3YXJlLWFuZC1pJyksCiAgICAgICAgICAgICgnZW5kdGFnJywgJ3NwYW4nKSwgKCdlbmR0YWcnLCAnYScpLApwaWxlciksCiAgICAgICAgICAgIGYiPFNRTENvbXBpbGVyIG1vZGVsPUl0ZW0gY29ubmVjdGlvbj0iCiAgICAgICAgICAgIGYiPERhdGFiYXNlV3JhcHBlciB2ZW5kb3I9e2Nvbm5lY3Rpb24udmVuZG9yIXJ9IGFsaWFzPSdkZWZhdWx0Jz4gIgogICAgICAgICAgICBmInVzaW5nPSdkZWZhdWx0Jz4iLAogICAgICAgICkKCiAgICBkZWYgdGVzdF9leGVjdXRlX3NxbF9zdXBwcmVzc2VzX2N1cnNvcl9jbG9zaW5nX2ZhaWx1cmVfb25fZXhjZXB0aW9uKHNlbGYpOgogICAgICAgIHF1ZXJ5ID0gUXVlcnkoSXRlbSkKICAgICAgICBjb21waWxlciA9IFNRTENvbXBpbGVyKHF1ZXJ5LCBjb25uZWN0aW9uLCBOb25lKQogICAgICAgIGN1cnNvciA9IG1vY2suTWFnaWNNb2NrKCkKCiAgICAgICAgIyBXaGVuIGV4ZWN1dGlvbiBmYWlscywgdGhlIGN1cnNvciBtYXkgaGF2ZSBiZWVuIGNsb3NlZC4KICAgICAgICAjIERqYW5nbydzIGF0dGVtcHQgdG8gY2xvc2UgaXQgYWdhaW4gd2lsbCBmYWlsLCBhbmQgbmVlZHMgY2F0Y2hpbmcuCiAgICAgICAgZXhlY3V0ZV9lcnIgPSBEYXRhYmFzZUVycm9yKCJleGVjdXRlIGZhaWxlZCIpCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUuc2lkZV9lZmZlY3QgPSBleGVjdXRlX2VycgogICAgICAgIGN1cnNvci5jbG9zZS5zaWRlX2VmZmVjdCA9IERhdGFiYXNlRXJyb3IoImNsb3NlIGZhaWxlZCIpCgogICAgICAgIHdpdGggbW9jay5wYXRjaC5vYmplY3QoY29ubmVjdGlvbiwgImN1cnNvciIsIHJldHVybl92YWx1ZT1jdXJzb3IpOgogICAgICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzKERhdGFiYXNlRXJyb3IpIGFzIGN0eDoKICAgICAgICAgICAgICAgIGNvbXBpbGVyLmV4ZWN1dGVfc3FsKCJTRUxFQ1QgMSIsIFtdKQoKICAgICAgICAjIFRoZXJlIGlzIG5vIGlycmVsZXZhbnQgY29udGV4dCBmcm9tIHRyeWluZyB0byBjbG9zZSBhIGNsb3NlZCBjdXJzb3IuCiAgICAgICAgZXhjID0gY3R4LmV4Y2VwdGlvbgogICAgICAgIHNlbGYuYXNzZXJ0SXMoZXhjLCBleGVjdXRlX2VycikKICAgICAgICBzZWxmLmFzc2VydElzTm9uZShleGMuX19jYXVzZV9fKQogICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShleGMuX19zdXBwcmVzc19jb250ZXh0X18pCiIiIlRlc3RzIGZvciBIVE1MUGFyc2VyLnB5LiIiIgoKaW1wb3J0IGh0bWwucGFyc2VyCmltcG9ydCBwcHJpbnQKaW1wb3J0IHVuaXR0ZXN0Cgpmcm9tIHVuaXR0ZXN0Lm1vY2sgaW1wb3J0IHBhdGNoCmZyb20gdGVzdCBpbXBvcnQgc3VwcG9ydAoKClNBTVBMRV9SQ0RBVEEgPSAoCiAgICAnPCEtLSBub3QgYSBjb21tZW50IC0tPicKICAgICI8bm90IGE9J3N0YXJ0IHRhZyc+IgogICAgJzwhW0NEQVRBW25vdCBhIGNkYXRhXV0+JwogICAgJzwhbm90IGEgYm9ndXMgY29tbWVudD4nCiAgICAnPC9ub3QgYSBib2d1cyBjb21tZW50PicKICAgICdcdTI2MDMnCikKClNBTVBMRV9SQVdURVhUID0gU0FNUExFX1JDREFUQSArICcmYW1wOyYjOTc4NjsnCgoKY2xhc3MgRXZlbmVyZSAnZnV0dXJlJyBpcyBhbiBpbnN0YW5jZSBvZiBhc3luY2lvLkZ1dHVyZSBvciBhc3luY2lvLlRhc2suCgogICAgICAnY2FsbF9zdGFjaycgaXMgYSB0dXBsZSBvZiBGcmFtZUdyYXBoRW50cnkgb2JqZWN0cy4KCiAgICAgICdhd2FpdGVkX2J5JyBpcyBhIHR1cGxlIG9mIEZ1dHVyZUNhbGxHcmFwaCBvYmplY3RzLgoKICAgICogRnJhbWVDYWxsR3JhcGhFbnRyeShmcmFtZSkKCiAgICAgIFdoZXJlICdmcmFtZScgaXMgYSBmcmFtZSBvYmplY3Qgb2YgYSByZWd1bGFyIFB5dGhvbiBmdW5jdGlvbgogICAgICBpbiB0aGUgY2FsbCBzdGFjay4KCiAgICBSZWNlaXZlcyBhbiBvcHRpb25hbCAnZnV0dXJlJyBhcmd1bWVudC4gSWYgbm90IHBhc3NlZCwKICAgIHRoZSBjdXJyZW50IHRhc2sgd2lsbCBiZSB1c2VkLiBJZiB0aGVyZSdzIG5vIGN1cnJlbnQgdGFzaywgdGhlIGZ1bmN0aW9uCiAgICByZXR1cm5zIE5vbmUuCgogICAgSWYgImNhcHR1cmVfY2FsbF9ncmFwaCgpIiBpcyBpbnRyb3NwZWN0aW5nICp0aGUgY3VycmVudCB0YXNrKiwgdGhlCiAgICBvcHRpb25hbCBrZXl3b3JkLW9ubHkgJ2RlcHRoJyBhcmd1bWVudCBjYW4gYmUgdXNlZCB0byBza2lwIHRoZSBzcGVjaWZpZWQKICAgIG51bWJlciBvZiBmcmFtZXMgZnJvbSB0b3Agb2YgdGhlIHN0YWNrLgoKICAgIElmIHRoZSBvcHRpb25hbCBrZXl3b3JkLW9ubHkgJ2xpbWl0JyBhcmd1bWVudCBpcyBwcm92aWRlZCwgZWFjaCBjYWxsIHN0YWNrCiAgICBpbiB0aGUgcmVzdWx0aW5nIGdyYXBoIGlzIHRydW5jYXRlZCB0byBpbmNsdWRlIGF0IG1vc3QgYGBhYnMobGltaXQpYGAKICAgIGVudHJpZXMuIElmICdsaW1pdCcgaXMgcG9zaXRpdmUsIHRoZSBlbnRyaWVzIGxlZnQgYXJlIHRoZSBjbG9zZXN0IHRvCiAgICB0aGUgaW52b2NhdGlvbiBwb2ludC4gSWYgJ2xpbWl0JyBpcyBuZWdhdGl2ZSwgdGhlIHRvcG1vc3QgZW50cmllcyBhcmUKICAgIGxlZnQuIElmICdsaW1pdCcgaXMgb21pdHRlZCBvciBOb25lLCBhbGwgZW50cmllcyBhcmUgcHJlc2VudC4KICAgIElmICdsaW1pdCcgaXMgMCwgdGhlIGNhbGwgc3RhY2sgaXMgbm90IGNhcHR1cmVkIGF0IGFsbCwgb25seQogICAgImF3YWl0ZWQgYnkiIGluZm9ybWF0aW9uIGlzIHByZXNlbnQuCiAgICAiIiIKCiAgICBsb29wID0gZXZlbnRzLl9nZXRfcnVubmluZ19sb29wKCkKCiAgICBpZiBmdXR1cmUgaXMgbm90IE5vbmU6CiAgICAgICAgIyBDaGVjayBpZiB3ZSdyZSBpbiBhIGNvbnRleHQgb2YgYSBydW5uaW5nIGV2ZW50IGxvb3A7CiAgICAgICAgIyBpZiB5ZXMgLSBjaGVjayBpZiB0aGUgcGFzc2VkIGZ1dHVyZSBpcyB0aGUgY3VycmVudGx5CiAgICAgICAgIyBydW5uaW5nIHRhc2sgb3Igbm90LgogICAgICAgIGlmIGxvb3AgaXMgTm9uZSBvciBmdXR1cmUgaXMgbm90IHRhc2tzLmN1cnJlbnRfdGFzayhsb29wPWxvb3ApOgogICAgICAgICAgICByZXR1cm4gX2J1aWxkX2dyYXBoX2Zvcl9mdXR1cmUoZnV0dXJlLCBsaW1pdD1saW1pdHRlc3QuQmFzZVRlc3RTdWl0ZS5fY2xlYW51cCA9IEZhbHNlICAjIHR5cGU6IGlnbm9yZVthdHRyLWRlZmluZWRdCgogICAgaWYgcnVudGVzdHMuZ2NfdGhyZXNob2xkIGlzIG5vdCBOb25lOgogICAgICAgIGdjLnNldF90aHJlc2hvbGQocnVudGVzdHMuZ2NfdGhyZXNob2xkKQoKICAgIHJhbmRvbS5zZWVkKHJ1bnRlc3RzLnJhbmRvbV9zZWVkKQoKICAgICMgc3lzLnN0ZG91dCBpcyByZWRpcmVjdGVkIHRvIGEgU3RyaW5nSU8gaW4gc2luZ2xlIHByb2Nlc3MgbW9kZSBvbiB3aGljaAogICAgIyBjb2xvciBhdXRvLWRldGVjdCBmYWlscyBhcyBTdHJpbmdJTyBpcyBub3QgYSBUVFkuIElmIHRoZSBvcmlnaW5hbAogICAgIyBzeXMuc3Rkb3V0IHN1cHBvcnRzIGNvbG9yIHBhc3MgdGhhdCB0aHJvdWdoIHdpdGggRk9SQ0VfQ09MT1Igc28gdGhhdCB3aGVuCiAgICAjIHJlc3VsdHMgYXJlIHByaW50ZWQsIHN1Y2ggYXMgd2l0aCAtVywgdGhleSBnZXQgY29sb3IuCiAgICBpZiBjYW5fY29sb3JpemUoZmlsZT1zeXMuc3Rkb3V0KToKICAgICAgICBvcy5lbnZpcm9uWydGT1JDRV9DT0xPUiddID0gIjEiCiMhL3Vzci9iaW4vZW52IHB5dGhvbjMKIyAtKi0gbW9kZTogcHl0aG9uIC0qLQoKIyBSZSB0ZXN0IHN1aXRlIGFuZCBiZW5jaG1hcmsgc3VpdGUgdjEuNQoKIyBUaGUgMyBwb3NzaWJsZSBvdXRjb21lcyBmb3IgZWFjaCBwYXR0ZXJuCltTVUNDRUVELCBGQUlMLCBTWU5UQVhfRVJST1JdID0gcmFuZ2UoMykKCiMgQmVuY2htYXJrIHN1aXRlIChuZWVkcyBleHBhbnNpb24pCiMKIyBUaGUgYmVuY2htYXJrIHN1aXRlIGRvZXMgbm90IHRlc3QgY29ycmVjdG5lc3MsIGp1c3Qgc3BlZWQuICBUaGUKIyBmaXJzdCBlbGVtZW50IG9mIGVhY2ggdHVwbGUgaXMgdGhlIHJlZ2V4IHBhdHRlcm47IHRoZSBzZWNvbmQgaXMgYQojIHN0cmluZyB0byBtYXRjaCBpdCBhZ2FpbnN0LiAgVGhlIGJlbmNobWFya2luZyBjb2RlIHdpbGwgZW1iZWQgdGhlCiMgc2Vjb25kIHN0cmluZyBpbnNpZGUgc2V2ZXJhbCBzaXplcyBvZiBwYWRkaW5nLCB0byB0ZXN0IGhvdyByZWdleAojIG1hdGNoaW5nIHBlcmZvcm1zIG9uIGxhcmdlIHN0cmluZ3MuCgpiZW5jaG1hcmtzID0gWwoKICAgICMgdGVzdCBjb21tb24gcHJlZml4CiAgICAoJ1B5dGhvbnxQZXJsJywgJ1BlcmwnKSwgICAgIyBBbHRlcm5hdGlvbgogICAgKCcoUHl0aG9ufFBlcmwpJywgJ1BlcmwnKSwgICMgR3JvdXBlZCBhbHRlcm5hdGlvbgoKICAgICgnUHl0aG9ufFBlcmx8VGNsJywgJ1BlcmwnKSwgICAgICAgICMgQWx0ZXJuYXRpb24KICAgICgnKFB5dGhvbnxQZXJsfFRjbCknLCAnUGVybCcpLCAgICAgICMgR3JvdXBlZCBhbHRlcm5hdGlvbgoKICAgICgnKFB5dGhvbilcXDEnLCAnUHl0aG9uUHl0aG9uJyksICAgICMgQmFja3JlZmVyZW5jZQogICAgKCcoWzBhLXpdW2EtejAtOV0qLCkrJywgJ2E1LGI3LGM5LCcpLCAjIERpc2FibGUgdGhlIGZhc3RtYXAgb3B0aW1pemF0aW9uCiAgICAoJyhbYS16XVtlbGYuYXRUaW1lLnNlY29uZCkKCiAgICAgICAgICAgIHIgPSByb3RhdGVfdHMgLSAoKGN1cnJlbnRIb3VyICogNjAgKyBjdXJyZW50TWludXRlKSAqIDYwICsKICAgICAgICAgICAgICAgIGN1cnJlbnRTZWNvbmQpCiAgICAgICAgICAgIGlmIHIgPD0gMDoKICAgICAgICAgICAgICAgICMgUm90YXRlIHRpbWUgaXMgYmVmb3JlIHRoZSBjdXJyZW50IHRpbWUgKGZvciBleGFtcGxlIHdoZW4KICAgICAgICAgICAgICAgICMgc2VsZi5yb3RhdGVBdCBpcyAxMzo0NSBhbmQgaXQgbm93IDE0OjE1KSwgcm90YXRpb24gaXMKICAgICAgICAgICAgICAgICMgdG9tb3Jyb3cuCiAgICAgICAgICAgICAgICByICs9IF9NSUROSUdIVAogICAgICAgICAgICAgICAgY3VycmVudERheSA9IChjdXJyZW50RGF5ICsgMSkgJSA3CiAgICAgICAgICAgIHJlc3VsdCA9IGN1cnJlbnRUaW1lICsgcgogICAgICAgICAgICAjIElmIHdlIGFyZSByb2xsaW5nIG92ZXIgb24gYSBjZXJ0YWluIGRheSwgYWRkIGluIHRoZSBudW1iZXIgb2YgZGF5cyB1bnRpbAogICAgICAgICAgICAjIHRoZSBuZXh0IHJvbGxvdmVyLCBidXQgb2Zmc2V0IGJ5IDEgc2luY2Ugd2UganVzdCBjYWxjdWxhdGVkIHRoZSB0aW1lCiAgICAgICAgICAgICMgdW50aWwgdGhlIG5leHQgZGF5IHN0YXJ0cy4gIFRoZXJlIGFyZSB0aHJlZSBjYXNlczoKICAgICAgICAgICAgIyBDYXNlIDEpIFRoZSBkYXkgdG8gcm9sbG92ZXIgaXMgdG9kYXk7IGluIHRoaXMgY2FzZSwgZG8gbm90aGluZwogICAgICAgICAgICAjIENhc2UgMikgVGhlIGRheSB0byByb2xsb3ZlciBpcyBmdXJ0aGVyIGluIHRoZSBpbnRlcnZhbCAoaS5lLiwgdG9kYXkgaXMKICAgICAgICAgICAgIyAgICAgICAgIGRheSAyIChXZWRuZXNkYXkpIGFuZCByb2xsb3ZlciBpcyBvbiBkYXkgNiAoU3VuZGF5KS4gIERheXMgdG8KICAgICAgICAgICAgIyAgICAgICAgIG5leHQgcm9sbG92ZXIgaXMgc2ltcGx5IDYgLSAyIC0gMSwgb3IgMy4KICAgICAgICAgICAgIyBDYXNlIDMpIFRoZSBkYXkgdG8gcm9sbG92ZXIgaXMgYmVoaW5kIHVzIGluIHRoZSBpbnRlcnZhbCAoaS5lLiwgdG9kYXkKICAgICAgICAgICAgIyAgICAgICAgIGlzIGRheSA1IChTYXR1cmRheSkgYW5kIHJvbGxvdmVyIGlzIG9uIGRheSAzIChUaHVyc2RheSkuCiAgICAgICAgICAgICMgICAgICAgICBEYXlzIHRvIHJvbGxvdmVyIGlzIDYgLSA1ICsgMywgb3IgNC4gIEluIHRoaXMgY2FzZSwgaXQncyB0aGUKICAgICAgICAgICAgIyAgICAgICAgIG51bWJlciBvZiBkYXlzIGxlZnQgaW4gdGhlIGN1cnJlbnQgd2VlayAoMSkgcGx1cyB0aGUgbnVtYmVyCiAgICAgICAgICAgICMgICAgICAgICBvZiBkYXlzIGluIHRoZSBuZXh0IHdlZWsgdW50aWwgdGhlIHJvbGxvdmVyIGRheSAoMykuCiAgICAgICAgICAgICMgVGhlIGNhbGN1bGF0aW9ucyBkZXNjcmliZWQgaW4gMikgYW5kIDMpIGFib3ZlIG5lZWQgdG8gaGF2ZSBhIGRheSBhZGRlZC4KICAgICAgICAgICAgIyBUaGlzIGlzIGJyeXNldCA9IFt7Im5hbWUiOiAiTGVubm9uIn0sIHsibmFtZSI6ICJPbm8ifV0KICAgICAgICBzZWxmLmFzc2VydE5vdEVxdWFsKHRlc3Rfdmlldy5xdWVyeXNldCwgcXVlcnlzZXQpCiAgICAgICAgIyBPdmVyd3JpdGUgdGhlIHZpZXcncyBxdWVyeXNldCB3aXRoIHF1ZXJ5c2V0IGZyb20ga3dhcmcKICAgICAgICBjb250ZXh0ID0gdGVzdF92aWV3LmdldF9jb250ZXh0X2RhdGEob2JqZWN0X2xpc3Q9cXVlcnlzZXQpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjb250ZXh0WyJvYmplY3RfbGlzdCJdLCBxdWVyeXNldCkKCgpjbGFzcyBTaW5nbGVPYmplY3RUZW1wbGF0ZVJlc3BvbnNlTWl4aW5UZXN0KFNpbXBsZVRlc3RDYXNlKToKICAgIGRlZiB0ZXN0X3RlbXBsYXRlX21peGluX3dpdGhvdXRfdGVtcGxhdGUoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgV2Ugd2FudCB0byBtYWtlcyBzdXJlIHRoYXQgaWYgeW91IHVzZSBhIHRlbXBsYXRlIG1peGluLCBidXQgZm9yZ2V0IHRoZQogICAgICAgIHRlbXBsYXRlLCBpdCBzdGlsbCB0ZWxscyB5b3UgaXQncyBJbXByb3Blcmx5Q29uZmlndXJlZCBpbnN0ZWFkIG9mCiAgICAgICAgVGVtcGxhdGVEb2VzTm90RXhpc3QuCiAgICAgICAgIiIiCiAgICAgICAgdmlldyA9IHZpZXdzLlRlbXBsYXRlUmVzcG9uc2VXaXRob3V0VGVtcGxhdGUoKQogICAgICAgIG1zZyA9ICgKICAgICAgICAgICAgIlNpbmdsZU9iamVjdFRlbXBsYXRlUmVzcG9uc2VNaXhpbiByZXF1aXJlcyBhIGRlZmluaXRpb24gIgogICAgICAgICAgICAib2YgJ3RlbXBsYXRlX25hbWUnLCAndGVtcGxhdGVfbmFtZV9maWVsZCcsIG9yICdtb2RlbCc7ICIKICAgICAgICAgICAgIm9yIGFuIGltcGxlbWVudGF0aW9uIG9mICdnZXRfdGVtcGxhdGVfbmFtZXMoKScuIgogICAgICAgICkKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzTWVzc2FnZShJbXByb3Blcmx5Q29uZmlndXJlZCwgbXNnKToKICAgICAgICAgICAgdmlldy5nZXRfdGVtcGxhdGVfbmFtZXMoKQoiIiJVbml0IHRlc3RzIGZvciBtZW1vcnktYmFzZWQgZmlsZS1saWtlIG9iamVjdHMuClN0cmluZ0lPIC0tIGZvciB1bmljb2RlIHN0cmluZ3MKQnl0ZXNJTyAtLSBmb3IgYnl0ZXMKIiIiCgppbXBvcnQgdW5pdHRlc3QKZnJvbSB0ZXN0IGltcG9ydCBzdXBwb3J0CgppbXBvcnQgZ2MKaW1wb3J0IGlvCmltcG9ydCBfcHlpbyBhcyBweWlvCmltcG9ydCBwaWNrbGUKaW1wb3J0IHN5cwppbXBvcnQgd2Vha3JlZgoKY2xhc3MgSW50TGlrZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBudW0pOgogICAgICAgIHNlbGYuX251bSA9IG51bQogICAgZGVmIF9faW5kZXhfXyhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5fbnVtCiAgICBfX2ludF9fID0gX19pbmRleF9fCgpjbGFzcyBNZW1vcnlTZWVrVGVzdE1peGluOgoKICAgIGRlZiB0ZXN0SW5pdChzZWxmKToKICAgICAgICBidWYgPSBzZWxmLmJ1ZnR5cGUoIjEyMzQ1Njc4OTAiKQogICAgICAgIGJ5dGVzSW8gPSBzZSAgIlRydWUiOiBUcnVlLAogICAgICAgICAgICAgICAgImEiOiAyLAogICAgICAgICAgICAgICAgInoiOiAiOCIsCiAgICAgICAgICAgIH0sCiAgICAgICAgKQoKICAgIGRlZiB0ZXN0X2ZsYXR0ZW5fY29udGV4dF93aXRoX2NvbnRleHRfY29weShzZWxmKToKICAgICAgICBjdHgxID0gQ29udGV4dCh7ImEiOiAyfSkKICAgICAgICBjdHgyID0gY3R4MS5uZXcoQ29udGV4dCh7ImIiOiA0fSkpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgKICAgICAgICAgICAgY3R4Mi5kaWN0cywgW3siVHJ1ZSI6IFRydWUsICJGYWxzZSI6IEZhbHNlLCAiTm9uZSI6IE5vbmV9LCB7ImIiOiA0fV0KICAgICAgICApCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgKICAgICAgICAgICAgY3R4Mi5mbGF0dGVuKCksCiAgICAgICAgICAgIHsiRmFsc2UiOiBGYWxzZSwgIk5vbmUiOiBOb25lLCAiVHJ1ZSI6IFRydWUsICJiIjogNH0sCiAgICAgICAgKQoKICAgIGRlZiB0ZXN0X2NvbnRleHRfY29tcGFyYWJsZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICAjMjE3NjUgLS0gZXF1YWxpdHkgY29tcGFyaXNvbiBzaG91bGQgd29yawogICAgICAgICIiIgoKICAgICAgICB0ZXN0X2RhdGEgPSB7IngiOiAieSIsICJ2IjogInoiLCAiZCI6IHsibyI6IG9iamVjdCwgImEiOiAiYiJ9fQoKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKENvbnRleHQodGVzdF9kYXRhKSwgQ29udGV4dCh0ZXN0X2RhdGEpKQoKICAgICAgICBhID0gQ29udGV4dCgpCiAgICAgICAgYiA9IENvbnRleHQoKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYSwgYikKCiAgICAgICAgIyB1cGRhdGUgb25seSBhCiAgICAgICAgYS51cGRhdGUoeyJhIjogMX0pCiAgICAgICAgc2VsZi5hc3NlcnROb3RFcXVhbChhLCBiKQoKICAgICAgICAjIHVwZGF0ZSBib3RoIHRvIGNoZWNrIHJlZ3Jlc3Npb24KICAgICAgICBhLnVwZGF0ZSh7ImMiOiAzfSkKICAgICAgICBiLnVwZGF0ZSh7ImMiOiAzfSkKICAgICAgICBzZWxmLmFzc2VydE5vdEVxdWFsKGEsIGIpCgogICAgICAgICMgbWFrZSBjb250ZXh0cyBlcXVhbHMgYWdhaW4KICAgICAgICBiLnVwZGF0ZSh7ImEiOiAxfSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGEsIGIpCgogICAgZGVmIHRlc3RfY29weV9yZXF1ZXN0X2NvbnRleHRfdHdpY2Uoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgIzI0MjczIC0tIENvcHkgdHdpY2Ugc2hvdWxkbid0IHJhaXNlIGFuIGV4Y2VwdGlvbgogICAgICAgICIiIgogICAgICAgIFJlcXVlc3RDb250ZXh0KEh0dHBSZXF1ZXN0KCkpLm5ldygpLm5ldygpCgogICAgZGVmIHRlc3Rfc2V0X3Vwd2FyZChzZWxmKToKICAgICAgICBjID0gQ29udGV4dCh7ImEiOiAxfSkKICAgICAgICBjLnNldF91cHdhcmQoImEiLCAyKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYy5nZXQoImEiKSwgMikKCiAgICBkZWYgdGVzdF9zZXRfdXB3YXJkX2VtcHR5X2NvbnRleHQoc2VsZik6CiAgICAgICAgZW1wdHlfY29udGV4dCA9IENvYW1lOiBKb2huCgotIHBrOiA0CiAgbW9kZWw6IHNlcmlhbGl6ZXJzLmF1dGhvcgogIGZpZWxkczoKICAgIG5hbWU6IFNtaXRoCiIiIgogICAgICAgIHN0cmVhbSA9IHRlc3Rfc3RyaW5nLmVuY29kZSgidXRmLTgiKQogICAgICAgIGRlc2VyaWFsaXplciA9IFlhbWxEZXNlcmlhbGl6ZXIoc3RyZWFtX29yX3N0cmluZz1zdHJlYW0pCgogICAgICAgIGZpcnN0X2l0ZW0gPSBuZXh0KGRlc2VyaWFsaXplcikKICAgICAgICBzZWNvbmRfaXRlbSA9IG5leHQoZGVzZXJpYWxpemVyKQoKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGZpcnN0X2l0ZW0ub2JqZWN0LCBzZWxmLmphbmUpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzZWNvbmRfaXRlbS5vYmplY3QsIHNlbGYuam9lKQoKICAgIGRlZiB0ZXN0X2NyYWZ0ZWRfeG1sX3JlamVjdGVkKHNlbGYpOgogICAgICAgIGRlcHRoID0gMTAwCiAgICAgICAgbGVhZl90ZXh0X2xlbiA9IDEwMDAKICAgICAgICBuZXN0ZWRfb3BlbiA9ICI8bmVzdGVkPiIgKiBkZXB0aAogICAgICAgIG5lc3RlZF9jbG9zZSA9ICI8L25lc3RlZD4iICogZGVwdGgKICAgICAgICBsZWFmID0gIngiICogbGVhZl90ZXh0X2xlbgogICAgICAgIGZpZWxkX2NvbnRlbnQgPSBmIntuZXN0ZWRfb3Blbn17bGVhZn17bmVzdGVkX2Nsb3NlfSIKICAgICAgICBjcmFmdGVkX3htbCA9IHRleHR3cmFwLmRlZGVudChmIiIiCiAgICAgICAgPGRqYW5nby1vYmplY3RzIHZlcnNpb249IjEuMCI+CiAgICAgICAgICAgIDxvYmplY3QgbW9kZWw9ImNvbnRlbnR0eXBlcy5jb250ZW50dHlwZSIgcGs9IjEiPgogICAgICAgICAgICAgICAgPGZpZWxkIG5hbWU9ImFwcF9sYWJlbCI+e2ZpZWxkX2NvbnRlbnR9PC9maWVsZD4KICAgICAgICAgICAgICAgIDxmaWVsZCBuYW1lPSJtb2RlbCI+bTwvZmllbGQ+CiAgICAgICAgICAgIDwvb2JqZWN0PgogICAgICAgIDwvZGphbmdvLW9iamVjdHM+IiIiKQoKICAgICAgICBtc2cgPSAiVW5leHBlY3RlZCBlbGVtZW50OiAnbmVzdGVkJyIKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzTWVzc2FnZShTdXNwaWNpb3VzT3BlcmF0aW9uLCBtc2cpOgogICAgICAgICAgICBsaXN0KFhNTERlc2VyaWFsaXplcihjcmFmdGVkX3htbCkpCmltcG9ydCBkYXRldGltZQoKZnJvbSBkamFuZ28uY29yZSBpbXBvcnQgc2lnbmluZwpmcm9tIGRqYW5nby50ZXN0IGltcG9ydCBTaW1wbGVUZXN0Q2FzZSwgb3ZlcnJpZGVfc2V0dGluZ3MKZnJvbSBkamFuZ28udGVzdC51dGlscyBpbXBvcnQgZnJlZXplX3RpbWUKZnJvbSBkamFuZ28udXRpbHMuY3J5cHRvIGltcG9ydCBJbnZhbGlkQWxnb3JpdGhtCgoKY2xhc3MgVGVzdFNpZ25lcihTaW1wbGVUZXN0Q2FzZSk6CiAgICBkZWYgdGVzdF9zaWduYXR1cmUoc2VsZik6CiAgICAgICAgInNpZ25hdHVyZSgpIG1ldGhvZCBzaG91bGQgZ2VuZXJhdGUgYSBzaWduYXR1cmUiCiAgICAgICAgc2lnbmVyID0gc2lnbmluZy5TaWduZXIoa2V5PSJwcmVkaWN0YWJsZS1zZWNyZXQiKQpkLiIKCnJlcXVpcmVfUE9TVCA9IHJlcXVpcmVfaHR0cF9tZXRob2RzKFsiUE9TVCJdKQpyZXF1aXJlX1BPU1QuX19kb2NfXyA9ICJEZWNvcmF0b3IgdG8gcmVxdWlyZSB0aGF0IGEgdmlldyBvbmx5IGFjY2VwdHMgdGhlIFBPU1QgbWV0aG9kLiIKCnJlcXVpcmVfc2FmZSA9IHJlcXVpcmVfaHR0cF9tZXRob2RzKFsiR0VUIiwgIkhFQUQiXSkKcmVxdWlyZV9zYWZlLl9fZG9jX18gPSAoCiAgICAiRGVjb3JhdG9yIHRvIHJlcXVpcmUgdGhhdCBhIHZpZXcgb25seSBhY2NlcHRzIHNhZmUgbWV0aG9kczogR0VUIGFuZCBIRUFELiIKKQoKCmRlZiBjb25kaXRpb24oZXRhZ19mdW5jPU5vbmUsIGxhc3RfbW9kaWZpZWRfZnVuYz1Ob25lKToKICAgICIiIgogICAgRGVjb3JhdG9yIHRvIHN1cHBvcnQgY29uZGl0aW9uYWwgcmV0cmlldmFsIChvciBjaGFuZ2UpIGZvciBhIHZpZXcKICAgIGZ1bmN0aW9uLgoKICAgIFRoZSBwYXJhbWV0ZXJzIGFyZSBjYWxsYWJsZXMgdG8gY29tcHV0ZSB0aGUgRVRhZyBhbmQgbGFzdCBtb2RpZmllZCB0aW1lIGZvcgogICAgdGhlIHJlcXVlc3RlZCByZXNvdXJjZSwgcmVzcGVjdGl2ZWx5LiBUaGUgY2FsbGFibGVzIGFyZSBwYXNzZWQgdGhlIHNhbWUKICAgIHBhcmFtZXRlcnMgYXMgdGhlIHZpZXcgaXRzZWxmLiBUaGUgRVRhZyBmdW5jdGlvbiBzaG91bGQgcmV0dXJuIGEgc3RyaW5nIChvcgogICAgTm9uZSBpZiB0aGUgcmVzb3VyY2UgZG9lc24ndCBleGlzdCksIHdoaWxlIHRoZSBsYXN0X21vZGlmaWVkIGZ1bmN0aW9uCiAgICBzaG91bGQgcmV0dXJuIGEgZGF0ZXRpbWUgb2JqZWN0IChvciBOb25lIGlmIHRoZSByZXNvdXJjZSBkb2Vzbid0IGV4aXN0KS4KCiAgICBUaGUgRVRhZyBmdW5jdGlvbiBzaG91bGQgcmV0dXJuIGEgY29tcGxldGUgRVRhZywgaW5jbHVkaW5nIHF1b3RlcyAoZS5nLgogICAgJyJldGFnIicpLCBzaW5jZSB0aGF0J3MgdGhlIG9ubHkgd2F5IHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gd2VhayBhbmQgc3Ryb25nCiAgICBFVGFncy4gSWYgYW4gdW5xdW90ZWQgRVRhZyBpcyByZXR1cm5lZCAoZS5nLiAnZXRhZycpLCBpdCB3aWxsIGJlIGNvbnZlcnRlZAogICAgdG8gYSBzdHJvbmcgRVRhZyBieSBhZGRpbmcgcXVvdGVzLgoKICAgIFRoaXMgZGVjb3JhdG9yIHdpbGwgZWl0aGVyIHBhc3MgY29udHJvbCB0byB0aGUgd3JhcHBlZCB2aWV3IGZ1bmN0aW9uIG9yCiAgICByZXR1cm4gYW4gSFRUUCAzMDQgcmVzcG9uc2UgKHVubW9kaWZpZWQpIG9yIDQxMiByZXNwb25zZSAocHJlY29uZGl0aW9uCiAgICBmYWlsZWQpLCBkZXBlbmRpbmcgdXBvbiB0aGUgcmVxdWVzdCBtZXRob2QuIEluIGVpdGhlciBjYXNlLCB0aGUgZGVjb3JhdG9yCiAgICB3aWxsIGFkZCB0aGUgZ2VuZXJhdGVkIEVUYWcgYW5kIExhc3QtTW9kaWZpZWQgaGVhZGVycyB0byB0aGUgcmVzcG9uc2UgaWYKICAgIHRoZSBoZWFkZXJzIGFyZW4ndCBhbHJlYWR5IHNldCBhbmQgaWYgdGhlIHJlcXVlc3QncyBtZXRob2QgaXMgc2FmZS4KICBzeXMKCgojIFNraXAgdGVzdHMgaWYgdGhlIGJ6MiBtb2R1bGUgZG9lc24ndCBleGlzdC4KYnoyID0gaW1wb3J0X2hlbHBlci5pbXBvcnRfbW9kdWxlKCdiejInKQpmcm9tIGJ6MiBpbXBvcnQgQloyRmlsZSwgQloyQ29tcHJlc3NvciwgQloyRGVjb21wcmVzc29yCgpoYXNfY21kbGluZV9idW56aXAyID0gTm9uZQoKZGVmIGV4dF9kZWNvbXByZXNzKGRhdGEpOgogICAgZ2xvYmFsIGhhc19jbWRsaW5lX2J1bnppcDIKICAgIGlmIGhhc19jbWRsaW5lX2J1bnppcDIgaXMgTm9uZToKICAgICAgICBoYXNfY21kbGluZV9idW56aXAyID0gYm9vbChzaHV0aWwud2hpY2goJ2J1bnppcDInKSkKICAgIGlmIGhhc19jbWRsaW5lX2J1bnppcDI6CiAgICAgICAgcmV0dXJuIHN1YnByb2Nlc3MuY2hlY2tfb3V0cHV0KFsnYnVuemlwMiddLCBpbnB1dD1kYXRhKQogICAgZWxzZToKICAgICAgICByZXR1cm4gYnoyLmRlY29tcHJlc3MoZGF0YSkKCmNsYXNzIEJhc2VUZXN0KHVuaXR0ZXN0LlRlc3RDYXNlKToKICAgICJCYXNlIGZvciBvdGhlciB0ZXN0Y2FzZXMuIgoKICAgIFRFWFRfTElORVMgPSBbCiAgICAgICAgYidyb290Ong6MDowOnJvb3Q6L3Jvb3Q6L2Jpbi9iYXNoXG4nLAogICAgICAgIGInYmluOng6MToxOmJpbjovYmluOlxuJywKICAgICAgICBiJ2RhZW1vbjp4OjI6MjpkYWVtb246L3NiaW46XG4nLAogICAgICAgIGInYWRtOng6Mzo0OmFkbTovdmFyL2FkbTpcbicsCiAgICAgICAgYidscDp4OjQ6NzpscDovdmFyL3Nwb29sL2xwZDpcbicsCiAgICAgICAgYidzeW5jOng6NTowOnN5bmM6L3NiaW46L2Jpbi9zeW5jXG4nLAogICAgICAgIGInc2h1dGRvd246eDo2OjA6c2h1dGRvd246L3NiaW46L3NiaW4vc2h1dGRvd25cbicsCiAgICAgICAgYidoYWx0Ong6NzowOmhhbHQ6L3NiaW46L3NiaW4vaGFsdFxuJywKICAgICAgICBiJ21haWw6eDo4OjEyOm1haWw6L3Zhci9zcG9vbC9tYWlsOlxuJywKICAgICAgICBiJ25ld3M6eDo5OjEzOm5ld3M6L3Zhci9zcG9vbC9uZXdzOlxuJywKICAgICAgICBiJ3V1Y3A6eDoxMDoxNDp1dWNwOi92YXIvc3Bvb2wvdXVjcDpcbicsCiAgICAgICAgYidvcGVyYXRvcjp4OjExOjA6b3BlcmF0b3I6L3Jvb3Q6XG4nLAogICAgICAgIGInZ2FtZXM6eDoxMjoxMDA6Z2FtZXM6L3Vzci9nYW1lczpcbicsCiAgICAgICAgYidnb3BoZXI6eDoxMzozMDpnb3BoZXI6L3Vzci9saWIvZ29waGVyLWRhdGE6XG4nLAogICAgICAgIGInZnRwOng6MTQ6NTA6RlRQIFVzZXI6L3Zhci9mdHA6L2Jpbi9iYXNoXG4nLAogICAgICAgIGInbm9ib2R5Ong6NjU1MzQ6NjU1MzQ6Tm9ib2R5Oi9ob21lOlxuJywKICAgICAgICBiJ3Bvc3RmaXg6eDoxMDA6MTAxOnBvc3RmaXg6L3Zhci9zcG9vbC9wb3N0Zml4OlxuJywKICAgICAgICBiJ25pZW1leWVyOng6NTAwOjUwMDo6L2hvbWUvbmllbWV5ZXI6L2Jpbi9iYXNoXG4nLAogICAgICAgIGIncG9zdGdyZXM6eDoxMDE6MTAyOlBvc3RncmVTUUwgU2VydmVyOi92YXIvbGliL3Bnc3FsOi9iaW51cm4gZnJvemVuLCBzb3VyY2UKCgpkZWYgdGVzdF9ib3RoKHRlc3RfY2xhc3MsIGJhc2U9Tm9uZSwgKiprd2FyZ3MpOgogICAgcmV0dXJuIHNwbGl0X2Zyb3plbih0ZXN0X2NsYXNzLCBiYXNlLCAqKmt3YXJncykKCgpDQVNFX0lOU0VOU0lUSVZFX0ZTID0gVHJ1ZQojIFdpbmRvd3MgaXMgdGhlIG9ubHkgT1MgdGhhdCBpcyAqYWx3YXlzKiBjYXNlLWluc2Vuc2l0aXZlCiMgKE9TIFggKmNhbiogYmUgY2FzZS1zZW5zaXRpdmUpLgppZiBzeXMucGxhdGZvcm0gbm90IGluICgnd2luMzInLCAnY3lnd2luJyk6CiAgICBjaGFuZ2VkX25hbWUgPSBfX2ZpbGVfXy51cHBlcigpCiAgICBpZiBjaGFuZ2VkX25hbWUgPT0gX19maWxlX186CiAgICAgICAgY2hhbmdlZF9uYW1lID0gX19maWxlX18ubG93ZXIoKQogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGNoYW5nZWRfbmFtZSk6CiAgICAgICAgQ0FTRV9JTlNFTlNJVElWRV9GUyA9IEZhbHNlCgpzb3VyY2VfaW1wb3J0bGliID0gaW1wb3J0X2ltcG9ydGxpYignaW1wb3J0bGliJylbJ1NvdXJjZSddCl9faW1wb3J0X18gPSB7J0Zyb3plbic6IHN0YXRpY21ldGhvZChidWlsdGlucy5fX2ltcG9ydF9fKSwKICAgICAgICAgICAgICAnU291cmNlJzogc3RhdGljbWV0aG9kKHNvdXJjZV9pbXBvcnRsaWIuX19pbXBvcnRfXyl9CgoKZGVmIGNhc2VfaW5zZW5zaXRpdmVfdGVzdHModGVzdCk6CiAgICAiIiJDbGFzcyBkZWNvcmF0b3IgdGhhdCBudWxsaWZpZXMgdGVzdHMgcmVxdWlyaW5nIGEgY2FzZS1pbnNlbnNpdGl2ZQogICAgZmlsZSBzeXN0ZW0uIiIiCiAgICByZXR1cm4gdW5pdHRlc3Quc2tpcElmKG5vdCBDQVNFX0lOU0VOU0lUSVZFX0ZTLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVzIGEgY2FzZS1pbnNlbnNpdGl2ZSBmaWxlc3lzdGVtIikodGVzdCkKCgpkZWYgc3VibW9kdWxlKHBhcmVudCwgbmFtZSwgcGtnX2RpciwgY29udGVudD0nJyk6CiAgICBwYXRoID0gb3MucGF0aC5qb2luKHBrZ19kaXIsIG5hbWUgKyAnLnB5JykKICAgIHdpdGggb3BlbihwYXRoLCAndycsIGVuY29kaW5nPSd1dGYtOCcpIGFzIHN1YmZpbGU6CiAgICAgICAgc3ViZmlsZS53cml0ZShjb250ZW50KQogICAgcmV0dXJuICd7fS57fScuZm9ybWF0KHBhcmVudCwgbmFtZSksIHBhdGgKCgpkZWYgZ2V0X2NvZGVfZnJvbV9weWMocHljX3BhdGgpOgogICAgIiIiUmVhZHMgYSBweWMgZmlsZSBhbmQgcmV0dXJucyB0aGUgdW5tYXJzaGFsbGVkIGNvZGUgb2JqZWN0IHdpdGhpbi4KCiAgICBObyBoZWFkZXIgdmFsaWRhdGlvbiBpcyBwZXJmb3JtZWQuCiAgICAiIiIKICAgIHdpdGggb3BlbihweWNfcGF0aCwgJ3JiJykgYXMgcHljX2Y6CiAgICAgICAgcHljX2Yuc2VlaygxNikKICAgICAgICByZXR1cm4gbWFyc2hhbC5sb2FkKHB5Y19mKQoKCkBjb250ZXh0bGliLmNvbnRleHRtYW5hZ2VyCmRlZiB1bmNhY2hlKCpuYW1lcyk6CiAgICAiIiJVbmNhY2hlIGEgbW9kdWxlIGZyb20gc3lzLm1vZHVsZXMuCgplc3QgZmFpbGVkLCB5b3UgcHJvYmFibHkgYWRkZWQgYSBuZXcgImZvcm1hdCB1bml0IgogICAgICAgIGluIFB5dGhvbi9nZXRhcmdzLmMsIGJ1dCBuZWdsZWN0ZWQgdG8gdXBkYXRlIG91ciBwb29yIGZyaWVuZAogICAgICAgIHNraXBpdGVtKCkgaW4gdGhlIHNhbWUgZmlsZS4gIChJZiBzbywgc2hhbWUgb24geW91ISkKCiAgICAgICAgV2l0aCBhIGZldyBleGNlcHRpb25zKiosIHRoaXMgZnVuY3Rpb24gYnJ1dGUtZm9yY2UgdGVzdHMgYWxsCiAgICAgICAgcHJpbnRhYmxlIEFTQ0lJKioqIGNoYXJhY3RlcnMgKDMyIHRvIDEyNiBpbmNsdXNpdmUpIGFzIGZvcm1hdCB1bml0cywKICAgICAgICBjaGVja2luZyB0byBzZWUgdGhhdCBQeUFyZ19QYXJzZVR1cGxlQW5kS2V5d29yZHMoKSByZXR1cm4gY29uc2lzdGVudAogICAgICAgIGVycm9ycyBib3RoIHdoZW4gdGhlIHVuaXQgaXMgYXR0ZW1wdGVkIHRvIGJlIHVzZWQgYW5kIHdoZW4gaXQgaXMKICAgICAgICBza2lwcGVkLiAgSWYgdGhlIGZvcm1hdCB1bml0IGRvZXNuJ3QgZXhpc3QsIHdlJ2xsIGdldCBvbmUgb2YgdHdvCiAgICAgICAgc3BlY2lmaWMgZXJyb3IgbWVzc2FnZXMgKG9uZSBmb3IgdXNlZCwgb25lIGZvciBza2lwcGVkKTsgaWYgaXQgZG9lcwogICAgICAgIGV4aXN0IHdlICp3b24ndCogZ2V0IHRoYXQgZXJyb3ItLXdlJ2xsIGdldCBlaXRoZXIgbm8gZXJyb3Igb3Igc29tZQogICAgICAgIG90aGVyIGVycm9yLiAgSWYgd2UgZ2V0IHRoZSBzcGVjaWZpYyAiZG9lcyBub3QgZXhpc3QiIGVycm9yIGZvciBvbmUKICAgICAgICB0ZXN0IGFuZCBub3QgZm9yIHRoZSBvdGhlciwgdGhlcmUncyBhIG1pc21hdGNoLCBhbmQgdGhlIHRlc3QgZmFpbHMuCgogICAgICAgICAgICoqIFNvbWUgZm9ybWF0IHVuaXRzIGhhdmUgc3BlY2lhbCBmdW5ueSBzZW1hbnRpY3MgYW5kIGl0IHdvdWxkCiAgICAgICAgICAgICAgYmUgZGlmZmljdWx0IHRvIGFjY29tbW9kYXRlIHRoZW0gaGVyZS4gIFNpbmNlIHRoZXNlIGFyZSBhbGwKICAgICAgICAgICAgICB3ZWxsLWVzdGFibGlzaGVkIGFuZCBwcm9wZXJseSBza2lwcGVkIGluIHNraXBpdGVtKCkgd2UgY2FuCiAgICAgICAgICAgICAgZ2V0IGF3YXkgd2l0aCBub3QgdGVzdGluZyB0aGVtLS10aGlzIHRlc3QgaXMgcmVhbGx5IGludGVuZGVkCiAgICAgICAgICAgICAgdG8gY2F0Y2ggKm5ldyogZm9ybWF0IHVuaXRzLgoKICAgICAgICAgICoqKiBQeXRob24gQyBzb3VyY2UgZmlsZXMgbXVzdCBiZSBBU0NJSS4gIFRoZXJlZm9yZSBpdCdzIGltcG9zc2libGUKICAgICAgICAgICAgICB0byBoYXZlIG5vbi1BU0NJSSBmb3JtYXQgdW5pdHMuCgogICAgICAgICIiIgogICAgICAgIGVtcHR5X3R1cGxlID0gKCkKICAgICAgICB0dXBsZV8xID0gKDAsKQogICAgICAgIGRpY3RfYiA9IHsnYic6MX0KICAgICAgICBrZXl3b3JkcyA9IFsiYSIsICJiIl0KCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMzIsIDEyNyk6CiAgICAgICAgICAgIGMgPSBjaHIoaSkKCiBmaWxlX3JlYWRsaW5lKCkKCiAgICBkZWYgX2NodW5rZWRfZmlsZV9yZWFkKHNlbGYsIHNpemUpOgogICAgICAgIGN1cnNpemUgPSBtaW4oc2l6ZSwgX01JTl9SRUFEX0JVRl9TSVpFKQogICAgICAgIGIgPSBzZWxmLmZpbGVfcmVhZChjdXJzaXplKQogICAgICAgIHdoaWxlIGN1cnNpemUgPCBzaXplIGFuZCBsZW4oYikgPT0gY3Vyc2l6ZToKICAgICAgICAgICAgZGVsdGEgPSBtaW4oY3Vyc2l6ZSwgc2l6ZSAtIGN1cnNpemUpCiAgICAgICAgICAgIGIgKz0gc2VsZi5maWxlX3JlYWQoZGVsdGEpCiAgICAgICAgICAgIGN1cnNpemUgKz0gZGVsdGEKICAgICAgICByZXR1cm4gYgoKICAgIGRlZiBsb2FkX2ZyYW1lKHNlbGYsIGZyYW1lX3NpemUpOgogICAgICAgIGlmIHNlbGYuY3VycmVudF9mcmFtZSBhbmQgc2VsZi5jdXJyZW50X2ZyYW1lLnJlYWQoKSAhPSBiJyc6CiAgICAgICAgICAgIHJhaXNlIFVucGlja2xpbmdFcnJvcigKICAgICAgICAgICAgICAgICJiZWdpbm5pbmcgb2YgYSBuZXcgZnJhbWUgYmVmb3JlIGVuZCBvZiBjdXJyZW50IGZyYW1lIikKICAgICAgICBkYXRhID0gc2VsZi5fY2h1bmtlZF9maWxlX3JlYWQoZnJhbWVfc2l6ZSkKICAgICAgICBpZiBsZW4oZGF0YSkgPCBmcmFtZV9zaXplOgogICAgICAgICAgICByYWlzZSBFT0ZFcnJvcgogICAgICAgIHNlbGYuY3VycmVudF9mcmFtZSA9IGlvLkJ5dGVzSU8oZGF0YSkKCgojIFRvb2xzIHVzZWQgZm9yIHBpY2tsaW5nLgoKZGVmIF9nZXRhdHRyaWJ1dGUob2JqLCBkb3R0ZWRfcGF0aCk6CiAgICBmb3Igc3VicGF0aCBpbiBkb3R0ZWRfcGF0aDoKICAgICAgICBvYmogPSBnZXRhdHRyKG9iaiwgc3VicGF0aCkKICAgIHJldHVybiBvYmoKCmRlZiB3aGljaG1vZHVsZShvYmosIG5hbWUpOgogICAgIiIiRmluZCB0aGUgbW9kdWxlIGFuIG9iamVjdCBiZWxvbmcgdG8uIiIiCiAgICBkb3R0ZWRfcGF0aCA9IG5hbWUuc3BsaXQoJy4nKQogICAgbW9kdWxlX25hbWUgPSBnZXRhdHRyKG9iaiwgJ19fbW9kdWxlX18nLCBOb25lKQogICAgaWYgJzxsb2NhbHM+JyBpbiBkb3R0ZWRfcGF0aDoKICAgICAgICByYWlzZSBQaWNrbGluZ0Vycm9yKGYiQ2FuJ3QgcGlja2xlIGxvY2FsIG9iamVjdCB7b2JqIXJ9IikKICAgIGlmIG1vZHVsZV9uYW1lIGlzIE5vbmU6CiAgICAgICAgIyBQcm90ZWN0IHRoZSBpdGVyYXRpb24gYnkgdXNpbmcgYSBsaXN0IGNvcHkgb2Ygc3lzLm1vZHVsZXMgYWdhaW5zdCBkeW5hbWljCiAgICAgICAgIyBtb2R1bGVzIHRoYXQgdHJpZ2dlciBpbXBvcnRzIG9mIG90aGVyIG1vZHVsZXMgdXBvbiBjYWxscyB0byBnZXRhdHRyLgogICAgICAgIGZvciBtb2R1bGVfbmFtZSwgbW9kdWxlIGluIHN5cy5tb2R1bGVzLmNvcHkoKS5pdGVtcygpOgogICAgICAgICAgICBpZiAobW9kdWxlX25hbWUgPT0gJ19fbWFpbl9fJwogICAgICAgICAgICAgICAgb3IgbW9kdWxlX25hbWUgPT0gJ19fbXBfbWFpbl9fJyAgIyBicG8tNDI0MDYKICAtLS0rICAgICArLS0tLS0tLS0tLS0rICAgICstLS0tLS0tLS0rCgpFeGVjdXRvci5zdWJtaXQoKSBjYWxsZWQ6Ci0gY3JlYXRlcyBhIHVuaXF1ZWx5IG51bWJlcmVkIF9Xb3JrSXRlbSBhbmQgYWRkcyBpdCB0byB0aGUgIldvcmsgSXRlbXMiIGRpY3QKLSBhZGRzIHRoZSBpZCBvZiB0aGUgX1dvcmtJdGVtIHRvIHRoZSAiV29yayBJZHMiIHF1ZXVlCgpMb2NhbCB3b3JrZXIgdGhyZWFkOgotIHJlYWRzIHdvcmsgaWRzIGZyb20gdGhlICJXb3JrIElkcyIgcXVldWUgYW5kIGxvb2tzIHVwIHRoZSBjb3JyZXNwb25kaW5nCiAgV29ya0l0ZW0gZnJvbSB0aGUgIldvcmsgSXRlbXMiIGRpY3Q6IGlmIHRoZSB3b3JrIGl0ZW0gaGFzIGJlZW4gY2FuY2VsbGVkIHRoZW4KICBpdCBpcyBzaW1wbHkgcmVtb3ZlZCBmcm9tIHRoZSBkaWN0LCBvdGhlcndpc2UgaXQgaXMgcmVwYWNrYWdlZCBhcyBhCiAgX0NhbGxJdGVtIGFuZCBwdXQgaW4gdGhlICJDYWxsIFEiLiBOZXcgX0NhbGxJdGVtcyBhcmUgcHV0IGluIHRoZSAiQ2FsbCBRIgogIHVudGlsICJDYWxsIFEiIGlzIGZ1bGwuIE5PVEU6IHRoZSBzaXplIG9mIHRoZSAiQ2FsbCBRIiBpcyBrZXB0IHNtYWxsIGJlY2F1c2UKICBjYWxscyBwbGFjZWQgaW4gdGhlICJDYWxsIFEiIGNhbiBubyBsb25nZXIgYmUgY2FuY2VsbGVkIHdpdGggRnV0dXJlLmNhbmNlbCgpLgotIHJlYWRzIF9SZXN1bHRJdGVtcyBmcm9tICJSZXN1bHQgUSIsIHVwZGF0ZXMgdGhlIGZ1dHVyZSBzdG9yZWQgaW4gdGhlCiAgIldvcmsgSXRlbXMiIGRpY3QgYW5kIGRlbGV0ZXMgdGhlIGRpY3QgZW50cnkKClByb2Nlc3MgIzEuLm46Ci0gcmVhZHMgX0NhbGxJdGVtcyBmcm9tICJDYWxsIFEiLCBleGVjdXRlcyB0aGUgY2FsbHMsIGFuZCBwdXRzIHRoZSByZXN1bHRpbmcKICBfUmVzdWx0SXRlbXMgaW4gIlJlc3VsdCBRIgoiIiIKCl9fYXV0aG9yX18gPSAnQnJpYW4gUXVpbmxhbiAoYnJpYW5Ac3dlZXRhcHAuY29tKScKCmltcG9ydCBvcwpmcm9tIGNvbmN1cnJlbnQuZnV0dXJlcyBpbXBvcnQgX2Jhc2UKaW1wb3J0IHF1ZXVlCmltcG9ydCBtdWx0aXByb2Nlc3NpbmcgYXMgbXAKIyBUaGlzIGltcG9ydCBpcyByZXF1aXJlZCB0byBsb2FkIHRoZSBtdWx0aXByb2Nlc3NpbmcuY29ubmVjdGlvbiBzdWJtb2R1bGUKIyBzbyB0aGF0IGl0IGNhbiBiZSBhY2Nlc3NlZCBsYXRlciBhcyBgbXAuY29ubmVjdGlvbmAKaW1wb3J0IG11bHRpcHJvY2Vzc2luZy5jb25uZWN0aW9uCmZyb20gbXVsdGlwcm9jZXNzaW5nLnF1ZXVlcyBpbXBvcnQgUXVldWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgd2Vha3JlZgpmcm9tIGZ1bmN0b29scyBpbXBvcnQgcGFydGlhbAppbXBvcnQgaXRlcnRvb2xzCmltcG9ydCBzeXMKZnJvbSB0cmFjZWJhY2sgaW1wb3J0IGZvcm1hdF9leGNlcHRpb24KCgpfdGhyZWFkc193YWtldXBzID0gd2Vha3JlZi5XZWFrS2V5RGljdGlvbmFyeSgpCl9nbG9iYWxfc2h1dGRvd24gPSBGYWxzZQoKCmNsYXNzIF9UaHJlYWRXYWtldXA6CiAjIFhYWDogSSB3b3VsZCBzYXkgdGhpcyBvbmUgc2hvdWxkIGRlZmF1bHQgdG8gYXNjaWkvZW4gZm9yIHRoZQogICAgICAgICMgImVuY29kZWQiIHNlZ21lbnQsIHNpbmNlIHRoZSBmaXJzdCBzZWdtZW50IGlzIG5vdCBlbmNvZGVkIGFuZCBpcwogICAgICAgICMgaW4gZG91YmxlIHF1b3RlcywgbWFraW5nIHRoZSB2YWx1ZSBhIHZhbGlkIG5vbi1lbmNvZGVkIHN0cmluZy4gIFRoZQogICAgICAgICMgb2xkIHBhcnNlciBkZWNvZGVzIHRoaXMganVzdCBsaWtlIHRoZSBwcmV2aW91cyBjYXNlLCB3aGljaCBtYXkgYmUgdGhlCiAgICAgICAgIyBiZXR0ZXIgUG9zdGVsIHJ1bGUsIGJ1dCBjb3VsZCBlcXVhbGx5IHJlc3VsdCBpbiBib3JraW5nIGhlYWRlcnMgdGhhdAogICAgICAgICMgaW50ZW50aW9uYWxseSBoYXZlIHF1b3RlZCBxdW90ZXMgaW4gdGhlbS4gIFdlIGNvdWxkIGdldCB0aGlzIDk4JQogICAgICAgICMgcmlnaHQgaWYgd2UgdHJlYXQgaXQgYXMgYSBxdW90ZWQgc3RyaW5nICp1bmxlc3MqIGl0IG1hdGNoZXMgdGhlCiAgICAgICAgIyBjaGFyc2V0J2xhbmcndmFsdWUgcGF0dGVybiBleGFjdGx5ICphbmQqIHRoZXJlIGlzIGF0IGxlYXN0IG9uZQogICAgICAgICMgZW5jb2RlZCBzZWdtZW50LiAgSW1wbGVtZW50aW5nIHRoYXQgYWxnb3JpdGhtIHdpbGwgcmVxdWlyZSBzb21lCiAgICAgICAgIyByZWZhY3RvcmluZywgc28gSSBoYXZlbid0IGRvbmUgaXQgKHlldCkuCiAgICAgICAgJ3JmYzIyMzFfcXVvdGVkX3VuZW5jb2RlZF90aGVuX2VuY29kZWRfc2VnbWVudHMnOiAoCiAgICAgICAgICAgICgnYXBwbGljYXRpb24veC1mb287JwogICAgICAgICAgICAgICAgJ1x0bmFtZSowPSJ1cy1hc2NpaVwnZW4tdXNcJ015IjsnCiAgICAgICAgICAgICAgICAnXHRuYW1lKjEqPSIgRG9jdW1lbnQiOycKICAgICAgICAgICAgICAgICdcdG5hbWUqMio9IiBGb3IgWW91IicpLAogICAgICAgICAgICAnYXBwbGljYXRpb24veC1mb28nLAogICAgICAgICAgICAnYXBwbGljYXRpb24nLAogICAgICAgICAgICAneC1mb28nLAogICAgICAgICAgICB7J25hbWUnOiAidXMtYXNjaWknZW4tdXMnTXkgRG9jdW1lbnQgRm9yIFlvdSJ9LAogICAgICAgICAgICBbZXJyb3JzLkludmFsaWRIZWFkZXJEZWZlY3RdKjIsCiAgICAgICAgICAgICdhcHBsaWNhdGlvbi94LWZvbzsgbmFtZT0idXMtYXNjaWlcJ2VuLXVzXCdNeSBEb2N1bWVudCBGb3IgWW91IicsCiAgICAgICAgICAgICksCgogICAgICAgICMgTWFrZSBzdXJlIG91ciBmb2xkaW5nIGFsZ29yaXRobSBwcm9kdWNlcyBtdWx0aXBsZSBzZWN0aW9ucyBjb3JyZWN0bHkuCiAgICAgICAgIyBXZSBjb3VsZCBtaXggZW5jb2RlZCBhbmQgbm9uLWVuY29kZWQgc2VnbWVudHMsIGJ1dCB3ZSBkb24ndCwgd2UganVzdAogICAgICAgICMgbWFrZSB0aGVtIGFsbCBlbmNvZGVkLiAgSXQgbWlnaHQgYmUgd29ydGggZml4aW5nIHRoYXQsIHNpbmNlIHRoZQogICAgICAgICMgc2VjdGlvbnMgY2FuICAgZiJ0aGUgY3VycmVudCB3b3JraW5nIGRpcmVjdG9yeSBhbmQgdGhlIFB5dGhvbiBzb3VyY2UgY29kZSAiCiAgICAgICAgICAgIGYiZGlyZWN0b3J5IGhhdmUgZGlmZmVyZW50IG1vdW50IGRyaXZlcyAiCiAgICAgICAgICAgIGYiKHtjd2RfZHJpdmV9IGFuZCB7cm9vdF9kcml2ZX0pIgogICAgICAgICkKCgpza2lwX2lmX2RpZmZlcmVudF9tb3VudF9kcml2ZXMoKQoKCnRlc3RfdG9vbHMuc2tpcF9pZl9taXNzaW5nKCJjYXNlc19nZW5lcmF0b3IiKQp3aXRoIHRlc3RfdG9vbHMuaW1wb3J0c191bmRlcl90b29sKCJjYXNlc19nZW5lcmF0b3IiKToKICAgIGZyb20gYW5hbHl6ZXIgaW1wb3J0IFN0YWNrSXRlbQogICAgZnJvbSBjd3JpdGVyIGltcG9ydCBDV3JpdGVyCiAgICBpbXBvcnQgcGFyc2VyCiAgICBmcm9tIHN0YWNrIGltcG9ydCBMb2NhbCwgU3RhY2sKICAgIGltcG9ydCB0aWVyMV9nZW5lcmF0b3IKICAgIGltcG9ydCBvcHRpbWl6ZXJfZ2VuZXJhdG9yCgoKZGVmIGhhbmRsZV9zdGRlcnIoKToKICAgIGlmIHN1cHBvcnQudmVyYm9zZSA+IDE6CiAgICAgICAgcmV0dXJuIGNvbnRleHRsaWIubnVsbGNvbnRleHQoKQogICAgZWxzZToKICAgICAgICByZXR1cm4gc3VwcG9ydC5jYXB0dXJlZF9zdGRlcnIoKQoKCmRlZiBwYXJzZV9zcmMoc3JjKToKICAgIHAgPSBwYXJzZXIuUGFyc2VyKHNyYywgInRlc3QuYyIpCiAgICBub2RlcyA9IFtdCiAgICB3aGlsZSBub2RlIDo9IHAuZGVmaW5pdGlvbigpOgogICAgICAgIG5vZGVzLmFwcGVuZChub2RlKQogICAgcmV0dXJuIG5vZGVzCgoKY2xhc3MgVGVzdEVmZmVjdHModW5pdHRlc3QuVGVzdENhc2UpOgogICAgZGVmIHRlc3RfZWZmZWN0X3NpemVzKHNlbGYpOgogICAgICAgIHN0YWNrID0gU3RhY2soKQogICAgICAgIGlucHV0cyA9IFsKICAgICAgICAgICAgeCA6PSBTdGFja0l0ZW0oIngiLCAiMSIpLAogICAgICAgICAgICB5IDo9IFN0YWNrSXRlbSgieSIsICJvcGFyZyIpLAogICAgICAgICAgICB6IDo9IFN0YWNrSXRlbSgieiIsICJvcGFyZyoyIiksCiAgICAgICAgXQogICAgICAgIG91dHB1dHMgPSBbCiAgICAgICAgICAgIFN0YWNrSXRlbSgieCIsICIxIiksCiAgICAgICAgICAgIFN0YWNrSXRlbSgiYiIsICJvcGFyZyo0IiksCiAgICAgICAgICAgIFN0YWNrSXRlbSgiYyIsICIxIiksCiAgICAgICAgXQogICAgICAgIG51bGwgPSBDV3JpdGVyLm51bGwoKQogICAgICAgIHN0YWNrLnBvcCh6LCBudWxsKQogICAgICAgIHN0YWNrLnBvcCh5LCBudWxsKQogICAgICAgIHN0YWNrLnBvcCh4LCBudWxsKQogICAgICAgIGZvciBvdXQgaW4gb3V0cHV0czoKICAgICAgICAgICAgc3RhY2sucHVzaChMb2NhbC51bmRlZmluZWQob3V0KSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHN0YWNrLmJhc2Vfb2Zmc2V0LnRvX2MoKSwgIi0xIC0gb3BhcmcgLSBvcGFyZyoyIikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHN0YWNrLnBoeXNpY2FsX3NwLnRvX2MoKSwgIjAiKQogb3VyY2U9IlB5dGhvbiBXZWVrbHkiLCBjb250ZW50X29iamVjdD1kaXZlCiAgICAgICAgKQoKICAgICAgICAjIFNldCBhIGZvcmVpZ24ga2V5IHdpdGggYW4gb2JqZWN0IGZyb20gYSBkaWZmZXJlbnQgZGF0YWJhc2UKICAgICAgICBtc2cgPSAoCiAgICAgICAgICAgICdDYW5ub3QgYXNzaWduICI8Q29udGVudFR5cGU6IE11bHRpcGxlX0RhdGFiYXNlIHwgYm9vaz4iOiB0aGUgJwogICAgICAgICAgICAiY3VycmVudCBkYXRhYmFzZSByb3V0ZXIgcHJldmVudHMgdGhpcyByZWxhdGlvbi4iCiAgICAgICAgKQogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXNNZXNzYWdlKFZhbHVlRXJyb3IsIG1zZyk6CiAgICAgICAgICAgIHJldmlldzEuY29udGVudF9vYmplY3QgPSBkaXZlCgogICAgICAgICMgQWRkIHRvIGEgZm9yZWlnbiBrZXkgc2V0IHdpdGggYW4gb2JqZWN0IGZyb20gYSBkaWZmZXJlbnQgZGF0YWJhc2UKICAgICAgICBtc2cgPSAoCiAgICAgICAgICAgICI8UmV2aWV3OiBQeXRob24gTW9udGhseT4gaW5zdGFuY2UgaXNuJ3Qgc2F2ZWQuICIKICAgICAgICAgICAgIlVzZSBidWxrPUZhbHNlIG9yIHNhdmUgdGhlIG9iamVjdCBmaXJzdC4iCiAgICAgICAgKQogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXNNZXNzYWdlKFZhbHVlRXJyb3IsIG1zZyk6CiAgICAgICAgICAgIHdpdGggdHJhbnNhY3Rpb24uYXRvbWljKHVzaW5nPSJvdGhlciIpOgogICAgICAgICAgICAgICAgZGl2ZS5yZXZpZXdzLmFkZChyZXZpZXcxKQoKICAgICAgICAjIEJVVCEgaWYgeW91IGFzc2lnbiBhIEZLIG9iamVjdCB3aGVuIHRoZSBiYXNlIG9iamVjdCBoYXNuJ3QKICAgICAgICAjIGJlZW4gc2F2ZWQgeWV0LCB5b3UgaW1wbGljaXRseSBhc3NpZ24gdGhlIGRhdGFiYXNlIGZvciB0aGUKICAgICAgICAjIGJhc2Ugb2JqZWN0LgogICAgICAgIHJldmlldzMgPSBSZXZpZXcoc291cmNlPSJQeXRob24gRGFpbHkiKQogICAgICAgICMgaW5pdGlhbGx5LCBubyBkYiBhc3NpZ25lZAogICAgICAgIHNlbGYuYXNzZXJ0SXNOb25lKHJldmlldzMuX3N0YXRlLmRiKQoKICAgICAgICAjIERpdmUgY29tZXMgZnJvbSAnb3RoZXInLCBzbyByZXZpZXczIGlzIHNldCB0byB1c2UgJ290aGVyJy4uLgogICAgICAgIHJldmlldzMuY29udGVudF9vYmplY3QgPSBkaXZlCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXZpZXczLl9zdGF0ZS5kYiwgIm90aGVyIikKICAgICAgICAjIC4uLiBidXQgaXQgaXNuJ3Qgc2F2ZWQgeWV0CiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgKICAgICAgICAgICAgbGlzdCgKICAgICAgICAgICAgICAgIFJldmlldy5vYmplY3RzLnVzaW5nKCJkZWZhdWx0IikKICAgICAgICAgICAgICAgIC5maWx0ZXIob2JqZWN0X2lkPXByby5waykKICAgICAgICAgICAgICAgIC52YWx1ZXNfbGlzdCgic291cmNlIiwgZmxhdD1UcnVlKQogICAgICAgICAgICApLAogICAgICAgICAgICBbIlB5dGhvbiBNb250aGx5Il0sCiA5ZWE2NTIyMGU1NTc2N2FjOGU5NmIwIiwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgKCJzYWx0IiwgInZhbHVlIiksCiAgICAgICAgICAgICAgICB7ImFsZ29yaXRobSI6ICJzaGEyNTYifSwKICAgICAgICAgICAgICAgICJlZTBiZjc4OWU0ZTAwOTM3MWE1MzcyYzkwZjczZmNmMTc2OTVhODQzOWM5MTA4YjA0ODBmMTRlMzQ3YjNmOWVjIiwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgKCJzYWx0IiwgInZhbHVlIiksCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgImFsZ29yaXRobSI6ICJibGFrZTJiIiwKICAgICAgICAgICAgICAgICAgICAic2VjcmV0IjogIngiICogaGFzaGxpYi5ibGFrZTJiKCkuYmxvY2tfc2l6ZSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiZmM2Yjk4MDBhNTg0ZDQwNzMyYTA3ZmEzM2ZiNjljMzUyMTEyNjk0NDE4MjNiY2E0MzFhMTQzODUzYzMyZiIKICAgICAgICAgICAgICAgICJlODM2Y2YxOWFiODgxNjg5NTI4ZWRlNjQ3ZGFjNDEyMTcwY2Q1ZDM0MDdiNDRjNmQwZjQ0NjMwNjkwYzU0IgogICAgICAgICAgICAgICAgImFkM2Q1OCIsCiAgICAgICAgICAgICksCiAgICAgICAgXQogICAgICAgIGZvciBhcmdzLCBrd2FyZ3MsIGRpZ2VzdCBpbiB0ZXN0czoKICAgICAgICAgICAgd2l0aCBzZWxmLnN1YlRlc3QoYXJncz1hcmdzLCBrd2FyZ3M9a3dhcmdzKToKICAgICAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoc2FsdGVkX2htYWMoKmFyZ3MsICoqa3dhcmdzKS5oZXhkaWdlc3QoKSwgZGlnZXN0KQoKICAgIGRlZiB0ZXN0X2ludmFsaWRfYWxnb3JpdGhtKHNlbGYpOgogICAgICAgIG1zZyA9ICInd2hhdGV2ZXInIGlzIG5vdCBhbiBhbGdvcml0aG0gYWNjZXB0ZWQgYnkgdGhlIGhhc2hsaWIgbW9kdWxlLiIKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzTWVzc2FnZShJbnZhbGlkQWxnb3JpdGhtLCBtc2cpOgogICAgICAgICAgICBzYWx0ZWRfaG1hYygic2FsdCIsICJ2YWx1ZSIsIGFsZ29yaXRobT0id2hhdGV2ZXIiKQoKCmNsYXNzIFRlc3RVdGlsc0NyeXB0b1BCS0RGMih1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICAjIGh0dHBzOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9kcmFmdC1qb3NlZnNzb24tcGJrZGYyLXRlc3QtdmVjdG9ycy0wNgogICAgcmZjX3ZlY3RvcnMgPSBbCiAgICAgICAgewogICAgICAgICAgICAiYXJncyI6IHsKICAgICAgICAgICAgICAgICJwYXNzd29yZCI6ICJwYXNzd29yZCIsCiAgICAgICAgICAgICAgICAic2FsdCI6ICJzYWx0IiwKICAgICAgICAgICAgICAgICJpdGVyYXRpb25zIjogMSwKICAgICAgICAgICAgICAgICJka2xlbiI6IDIwLAogICAgICAgICAgICAgICAgImRpZ2VzdCI6IGhhc2hsaWIuc2hhMSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInJlc3VsdCI6ICIwYzYwYzgwZjk2MWYwZTcxZjNhOWI1MjRhZjYwMTIwNjJmZTAzN2E2IiwKICAgIDB4QjkgLT4gU1VQRVJTQ1JJUFQgT05FCiAgICAnXHhiYScgICAgICMgIDB4QkEgLT4gTUFTQ1VMSU5FIE9SRElOQUwgSU5ESUNBVE9SCiAgICAnXHhiYicgICAgICMgIDB4QkIgLT4gUklHSFQtUE9JTlRJTkcgRE9VQkxFIEFOR0xFIFFVT1RBVElPTiBNQVJLCiAgICAnXHhiYycgICAgICMgIDB4QkMgLT4gVlVMR0FSIEZSQUNUSU9OIE9ORSBRVUFSVEVSCiAgICAnXHhiZCcgICAgICMgIDB4QkQgLT4gVlVMR0FSIEZSQUNUSU9OIE9ORSBIQUxGCiAgICAnXHhiZScgICAgICMgIDB4QkUgLT4gVlVMR0FSIEZSQUNUSU9OIFRIUkVFIFFVQVJURVJTCiAgICAnXHhiZicgICAgICMgIDB4QkYgLT4gSU5WRVJURUQgUVVFU1RJT04gTUFSSwogICAgJ1x4YzAnICAgICAjICAweEMwIC0+IExBVElOIENBUElUQUwgTEVUVEVSIEEgV0lUSCBHUkFWRQogICAgJ1x4YzEnICAgICAjICAweEMxIC0+IExBVElOIENBUElUQUwgTEVUVEVSIEEgV0lUSCBBQ1VURQogICAgJ1x4YzInICAgICAjICAweEMyIC0+IExBVElOIENBUElUQUwgTEVUVEVSIEEgV0lUSCBDSVJDVU1GTEVYCiAgICAnXHhjMycgICAgICMgIDB4QzMgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgQSBXSVRIIFRJTERFCiAgICAnXHhjNCcgICAgICMgIDB4QzQgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgQSBXSVRIIERJQUVSRVNJUwogICAgJ1x4YzUnICAgICAjICAweEM1IC0+IExBVElOIENBUElUQUwgTEVUVEVSIEEgV0lUSCBSSU5HIEFCT1ZFCiAgICAnXHhjNicgICAgICMgIDB4QzYgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgQUUKICAgICdceGM3JyAgICAgIyAgMHhDNyAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBDIFdJVEggQ0VESUxMQQogICAgJ1x4YzgnICAgICAjICAweEM4IC0+IExBVElOIENBUElUQUwgTEVUVEVSIEUgV0lUSCBHUkFWRQogICAgJ1x4YzknICAgICAjICAweEM5IC0+IExBVElOIENBUElUQUwgTEVUVEVSIEUgV0lUSCBBQ1VURQogICAgJ1x4Y2EnICAgICAjICAweENBIC0+IExBVElOIENBUElUQUwgTEVUVEVSIEUgV0lUSCBDSVJDVU1GTEVYCiAgICAnXHhjYicgICAgICMgIDB4Q0IgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgRSBXSVRIIERJQUVSRVNJUwogICAgJ1x4Y2MnICAgICAjICAweENDIC0+IExBVElOIENBUElUQUwgTEVUVEVSIEkgV0lUSCBHUkFWRQogICAgJ1x4Y2QnICAgICAjICAweENEIC0+IExBVElOIENBUElUQUwgTEVUVEVSIEkgV0lUSCBBQ1VURQogICAgJ1x4Y2UnICAgICAjICAweENFIC0+IExBVElOIENBUElUQUwgTEVUVEVSIEkgV0lUSCBDSVJDVU1GTEVYCiAgICAnXHhjZicgICAgICMgIDB4Q0YgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgSSBXSVRIIERJQUVSRVNJUwogICAgJ1x4ZDAnICAgICAjICAweEQwIC0+IExBVElOIENBUElUQUwgTEVUVEVSIEVUSCAoSWNlbGFuZGljKQogICAgJ1x4ZDEnICAgICAjICAweEQxIC0+IExBVElOIENBUElUQUwgTEVUVEVSIE4gV0lUSCBUSUxERQogICAgJ1x4ZDInICAgICAjICAweEQyIC0+IFRlc3REUywgZ2V0X2RzX2ZpbGUKCndnc184NF93a3QgPSAoCiAgICAnR0VPR0NTWyJHQ1NfV0dTXzE5ODQiLERBVFVNWyJXR1NfMTk4NCIsU1BIRVJPSURbIldHU18xOTg0IiwnCiAgICAnNjM3ODEzNywyOTguMjU3MjIzNTYzXV0sUFJJTUVNWyJHcmVlbndpY2giLDBdLFVOSVRbIkRlZ3JlZSIsJwogICAgIjAuMDE3NDUzMjkyNTE5OTQzMjk1XV0iCikKIyBVc2luZyBhIHJlZ2V4IGJlY2F1c2Ugb2Ygc21hbGwgZGlmZmVyZW5jZXMgZGVwZW5kaW5nIG9uIEdEQUwgdmVyc2lvbnMuCndnc184NF93a3RfcmVnZXggPSByJ15HRU9HQ1NcWyIoR0NTXyk/V0dTWyBfXSgxOSk/ODQiLiokJwoKZGF0ZXRpbWVfZm9ybWF0ID0gIiVZLSVtLSVkVCVIOiVNOiVTIgoKIyBMaXN0IG9mIGFjY2VwdGFibGUgZGF0YSBzb3VyY2VzLgpkc19saXN0ID0gKAogICAgVGVzdERTKAogICAgICAgICJ0ZXN0X3BvaW50IiwKICAgICAgICBuZmVhdD01LAogICAgICAgIG5mbGQ9MywKICAgICAgICBnZW9tPSJQT0lOVCIsCiAgICAgICAgZ3R5cGU9MSwKICAgICAgICBkcml2ZXI9IkVTUkkgU2hhcGVmaWxlIiwKICAgICAgICBmaWVsZHM9eyJkYmwiOiBPRlRSZWFsLCAiaW50IjogT0ZUSW50ZWdlciwgInN0ciI6IE9GVFN0cmluZ30sCiAgICAgICAgZXh0ZW50PSgtMS4zNTAxMSwgMC4xNjY2MjMsIC0wLjUyNDA5MywgMC44MjQ1MDgpLCAgIyBHb3QgZXh0ZW50IGZyb20gUUdJUwogICAgICAgIHNyc193a3Q9d2dzXzg0X3drdCwKICAgICAgICBmaWVsZF92YWx1ZXM9ewogICAgICAgICAgICAiZGJsIjogW2Zsb2F0KGkpIGZvciBpIGluIHJhbmdlKDEsIDYpXSwKICAgICAgICAgICAgImludCI6IGxpc3QocmFuZ2UoMSwgNikpLAogICAgICAgICAgICAic3RyIjogW3N0cihpKSBmb3IgaSBpbiByYW5nZSgxLCA2KV0sCiAgICAgICAgfSwKICAgICAgICBmaWRzPXJhbmdlKDUpLAogICAgKSwKICAgIFRlc3REUygKICAgICAgICAidGVzdF92cnQiLAogICAgICAgIGV4dD0idnJ0IiwKICAgICAgICBuZmVhdD0zLAogICAgICAgIG5mbGQ9MywKICAgICAgICBnZW9tPSJQT0lOVCIsCiAgICAgICAgZ3R5cGU9IlBvaW50MjVEIiwKICAgICAgICBkcml2ZXI9Ik9HUl9WUlQiLAogICAgICAgIGZpZWxkcz17CiAgICAgICAgICAgICJQT0lOVF9YIjogT0ZUU3RyaW5nLAogICAgICAgICAgICAiUE9JTlRfWSI6IE9GVFN0cmluZywKICAgICAgICAgICAgIk5VTSI6IE9GVFN0cmluZywKICAgICAgICB9LCAgIyBWUlQgdXNlcyBDU1YsIHdoaWNoIGFsbCB0eXBlcyBhcmUgT0ZUU3RyaW5nLgogICAgICAgIGV4dGVudD0oMS4wLCAyLjAsIDEwMC4wLCA1MjMuNSksICAjIE1pbi9NYXggZnJvbSBDU1YKICAgICAgICBmaWVsZF92YWx1ZXM9ewogICAgICAgICAgICAiUE9JTlRfWCI6IFsiMS4wIiwgIjUuMCIsICIxMDAuMCJdLAogICAgICAgICAgICAiUE9JTlRfWSI6IFsiMi4wIiwgIjIzLjAiLCAiNTIzLjUiXSwKICAgICAgICAgICAgIk5VTSI6IFsiNSIsICIxNyIsICIyMyJdLAogKQoiIiJkaXN0dXRpbHMudW5peGNjb21waWxlcgoKQ29udGFpbnMgdGhlIFVuaXhDQ29tcGlsZXIgY2xhc3MsIGEgc3ViY2xhc3Mgb2YgQ0NvbXBpbGVyIHRoYXQgaGFuZGxlcwp0aGUgInR5cGljYWwiIFVuaXgtc3R5bGUgY29tbWFuZC1saW5lIEMgY29tcGlsZXI6CiAgKiBtYWNyb3MgZGVmaW5lZCB3aXRoIC1EbmFtZVs9dmFsdWVdCiAgKiBtYWNyb3MgdW5kZWZpbmVkIHdpdGggLVVuYW1lCiAgKiBpbmNsdWRlIHNlYXJjaCBkaXJlY3RvcmllcyBzcGVjaWZpZWQgd2l0aCAtSWRpcgogICogbGlicmFyaWVzIHNwZWNpZmllZCB3aXRoIC1sbGxpYgogICogbGlicmFyeSBzZWFyY2ggZGlyZWN0b3JpZXMgc3BlY2lmaWVkIHdpdGggLUxkaXIKICAqIGNvbXBpbGUgaGFuZGxlZCBieSAnY2MnIChvciBzaW1pbGFyKSBleGVjdXRhYmxlIHdpdGggLWMgb3B0aW9uOgogICAgY29tcGlsZXMgLmMgdG8gLm8KICAqIGxpbmsgc3RhdGljIGxpYnJhcnkgaGFuZGxlZCBieSAnYXInIGNvbW1hbmQgKHBvc3NpYmx5IHdpdGggJ3JhbmxpYicpCiAgKiBsaW5rIHNoYXJlZCBsaWJyYXJ5IGhhbmRsZWQgYnkgJ2NjIC1zaGFyZWQnCiIiIgoKaW1wb3J0IG9zLCBzeXMKCmZyb20gZGlzdHV0aWxzLmRlcF91dGlsIGltcG9ydCBuZXdlcgpmcm9tIGRpc3R1dGlscy5jY29tcGlsZXIgaW1wb3J0IENDb21waWxlciwgZ2VuX3ByZXByb2Nlc3Nfb3B0aW9ucwpmcm9tIGRpc3R1dGlscy5lcnJvcnMgaW1wb3J0IERpc3R1dGlsc0V4ZWNFcnJvciwgQ29tcGlsZUVycm9yCgojIFhYWCBUaGluZ3Mgbm90IGN1cnJlbnRseSBoYW5kbGVkOgojICAgKiBvcHRpbWl6YXRpb24vZGVidWcvd2FybmluZyBmbGFnczsgd2UganVzdCB1c2Ugd2hhdGV2ZXIncyBpbiBQeXRob24ncwojICAgICBNYWtlZmlsZSBhbmQgbGl2ZSB3aXRoIGl0LiAgSXMgdGhpcyBhZGVxdWF0ZT8gIElmIG5vdCwgd2UgbWlnaHQKIyAgICAgaGF2ZSB0byBoYXZlIGEgYnVuY2ggb2Ygc3ViY2xhc3NlcyBHTlVDQ29tcGlsZXIsIFNHSUNDb21waWxlciwKIyAgICAgU3VuQ0NvbXBpbGVyLCBhbmQgSSBzdXNwZWN0IGRvd24gdGhhdCByb2FkIGxpZXMgbWFkbmVzcy4KIyAgICogZXZlbiBpZiB3ZSBkb24ndCBrbm93IGEgd2FybmluZyBmbGFnIGZyb20gYW4gb3B0aW1pemF0aW9uIGZsYWcsCiMgICAgIHdlIG5lZWQgc29tZSB3YXkgZm9yIG91dHNpZGVycyB0byBmZWVkIHByZXByb2Nlc3Nvci9jb21waWxlci9saW5rZXIKIyAgICAgZmxhZ3MgaW4gdG8gdXMgLS0gZWcuIGEgc3lzYWRtaW4gbWlnaHQgd2FudCB0byBtYW5kYXRlIGNlcnRhaW4gZmxhZ3MKIyAgICAgdmlhIGEgc2l0ZSBjb25maWcgZmlsZSwgb3IgYSB1c2VyIG1pZ2h0IHdhbnQgdG8gc2V0IHNvbWV0aGluZyBmb3IKIyAgICAgY29tcGlsaW5nIHRoaXMgbW9kdWxlIGRpc3RyaWJ1dGlvbiBvbmx5IHZpYSB0aGUgc2V0dXAucHkgY29tbWFuZAojICAgICBsaW5lLCB3aGF0ZXZlci4gIEFzIGxvbmcgYXMgdGhlc2Ugb3B0aW9ucyBjb21lYidhXHhjMFx4ODBiIGNceGMwXHg4MGQnLCAoJ2FceDAwYicsICdjXHgwMGQnKSksCiAgICAgICAgICAgICgnYSB7YiBjfScsICgnYScsICdiIGMnKSksCiAgICAgICAgICAgIChyJ2EgYlwgYycsICgnYScsICdiIGMnKSksCiAgICAgICAgICAgICgoJ2EnLCAnYiBjJyksICgnYScsICdiIGMnKSksCiAgICAgICAgICAgICgnYSAyJywgKCdhJywgJzInKSksCiAgICAgICAgICAgICgoJ2EnLCAyKSwgKCdhJywgMikpLAogICAgICAgICAgICAoJ2EgMy40JywgKCdhJywgJzMuNCcpKSwKICAgICAgICAgICAgKCgnYScsIDMuNCksICgnYScsIDMuNCkpLAogICAgICAgICAgICAoKCksICgpKSwKICAgICAgICAgICAgKFtdLCAoKSksCiAgICAgICAgICAgIChbJ2EnLCBbJ2InLCAnYyddXSwgKCdhJywgWydiJywgJ2MnXSkpLAogICAgICAgICAgICAoY2FsbCgnbGlzdCcsIDEsICcyJywgKDMuNCwpKSwKICAgICAgICAgICAgICAgICgxLCAnMicsICgzLjQsKSkgaWYgc2VsZi53YW50b2JqZWN0cyBlbHNlCiAgICAgICAgICAgICAgICAoJzEnLCAnMicsICczLjQnKSksCiAgICAgICAgXQogICAgICAgIGlmIG5vdCBzZWxmLndhbnRvYmplY3RzOgogICAgICAgICAgICBleHBlY3RlZCA9ICgnMTInLCAnXHUyMGFjJywgJ1x4ZTJceDgyXHhhYycsICczLjQnKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGV4cGVjdGVkID0gKDEyLCAnXHUyMGFjJywgYidceGUyXHg4Mlx4YWMnLCAoMy40LCkpCiAgICAgICAgdGVzdGNhc2VzICs9IFsKICAgICAgICAgICAgKGNhbGwoJ2RpY3QnLCAnY3JlYXRlJywgMTIsICdcdTIwYWMnLCBiJ1x4ZTJceDgyXHhhYycsICgzLjQsKSksCiAgICAgICAgICAgICAgICBleHBlY3RlZCksCiAgICAgICAgXQogICAgICAgIGRiZ19pbmZvID0gKCd3YW50IG9iamVjdHM/ICVzLCBUY2wgdmVyc2lvbjogJXMsIFRjbCBwYXRjaGxldmVsOiAlcycKICAgICAgICAgICAgICAgICAgICAlIChzZWxmLndhbnRvYmplY3RzLCB0Y2xfdmVyc2lvbiwgc2VsZi5pbnRlcnAuaW5mb19wYXRjaGxldmVsKCkpKQogICAgICAgIGZvciBhcmcsIHJlcyBpbiB0ZXN0Y2FzZXM6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoc3BsaXRsaXN0KGFyZyksIHJlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXJnPSVhLCAlcycgJSAoYXJnLCBkYmdfaW5mbykpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoVGNsRXJyb3IsIHNwbGl0bGlzdCwgJ3snKQoKICAgIGRlZiB0ZXN0X3NwbGl0ZGljdChzZWxmKToKICAgICAgICBzcGxpdGRpY3QgPSB0a2ludGVyLl9zcGxpdGRpY3QKICAgICAgICB0Y2wgPSBzZWxmLmludGVycC50awoKICAgICAgICBhcmcgPSAnLWEgezEgMiAzfSAtc29tZXRoaW5nIGZvbyBzdGF0dXMge30nCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzcGxpdGRpY3QodGNsLCBhcmcsIEZhbHNlKSwKICAgICAgICAgICAgeyctYSc6ICcxIDIgMycsICctc29tZXRoaW5nJzogJ2ZvbycsICdzdGF0dXMnOiAnJ30pCiAgZW5kICclcyc6ICVzIiAlIChiYWNrZW5kLCBlKQogICAgICAgICAgICApIGZyb20gZQogICAgICAgIHJldHVybiBiYWNrZW5kX2Nscyhsb2NhdGlvbiwgcGFyYW1zKQoKCmNhY2hlcyA9IENhY2hlSGFuZGxlcigpCgpjYWNoZSA9IENvbm5lY3Rpb25Qcm94eShjYWNoZXMsIERFRkFVTFRfQ0FDSEVfQUxJQVMpCgoKZGVmIGNsb3NlX2NhY2hlcygqKmt3YXJncyk6CiAgICAjIFNvbWUgY2FjaGVzIG5lZWQgdG8gZG8gYSBjbGVhbnVwIGF0IHRoZSBlbmQgb2YgYSByZXF1ZXN0IGN5Y2xlLiBJZiBub3QKICAgICMgaW1wbGVtZW50ZWQgaW4gYSBwYXJ0aWN1bGFyIGJhY2tlbmQgY2FjaGUuY2xvc2UoKSBpcyBhIG5vLW9wLgogICAgY2FjaGVzLmNsb3NlX2FsbCgpCgoKc2lnbmFscy5yZXF1ZXN0X2ZpbmlzaGVkLmNvbm5lY3QoY2xvc2VfY2FjaGVzKQojIFNldCBvZiB0ZXN0cyBydW4gYnkgZGVmYXVsdCBpZiAtLXBnbyBpcyBzcGVjaWZpZWQuICBUaGUgdGVzdHMgYmVsb3cgd2VyZQojIGNob3NlbiBiYXNlZCBvbiB0aGUgZm9sbG93aW5nIGNyaXRlcmlhOiBlaXRoZXIgdGhleSBleGVyY2lzZSBhIGNvbW1vbmx5IHVzZWQKIyBDIGV4dGVuc2lvbiBtb2R1bGUgb3IgdHlwZSwgb3IgdGhleSBydW4gc29tZSByZWxhdGl2ZWx5IHR5cGljYWwgUHl0aG9uIGNvZGUuCiMgTG9uZyBydW5uaW5nIHRlc3RzIHNob3VsZCBiZSBhdm9pZGVkIGJlY2F1c2UgdGhlIFBHTyBpbnN0cnVtZW50ZWQgZXhlY3V0YWJsZQojIHJ1bnMgc2xvd2x5LgpQR09fVEVTVFMgPSBbCiAgICAndGVzdF9hcnJheScsCiAgICAndGVzdF9iYXNlNjQnLAogICAgJ3Rlc3RfYmluYXNjaWknLAogICAgJ3Rlc3RfYmlub3AnLAogICAgJ3Rlc3RfYmlzZWN0JywKICAgICd0ZXN0X2J5dGVzJywKICAgICd0ZXN0X2J6MicsCiAgICAndGVzdF9jbWF0aCcsCiAgICAndGVzdF9jb2RlY3MnLAogICAgJ3Rlc3RfY29sbGVjdGlvbnMnLAogICAgJ3Rlc3RfY29tcGxleCcsCiAgICAndGVzdF9kYXRhY2xhc3NlcycsCiAgICAndGVzdF9kYXRldGltZScsCiAgICAndGVzdF9kZWNpbWFsJywKICAgICd0ZXN0X2RpZmZsaWInLAogICAgJ3Rlc3RfZmxvYXQnLAogICAgJ3Rlc3RfZnN0cmluZycsCiAgICAndGVzdF9mdW5jdG9vbHMnLAogICAgJ3Rlc3RfZ2VuZXJhdG9ycycsCiAgICAndGVzdF9oYXNobGliJywKICAgICd0ZXN0X2hlYXBxJywKICAgICd0ZXN0X2ludCcsCiAgICAndGVzdF9pdGVydG9vbHMnLAogICAgJ3Rlc3RfanNvbicsCiAgICAndGVzdF9sb25nJywKICAgICd0ZXN0X2x6bWEnLAogICAgJ3Rlc3RfbWF0aCcsCiAgICAndGVzdF9tZW1vcnl2aWV3JywKICAgICd0ZXN0X29wZXJhdG9yJywKICAgICd0ZXN0X29yZGVyZWRfZGljdCcsCiAgICAndGVzdF9wYXRtYScsCiAgICAndGVzdF9waWNrbGUnLAogICAgJ3Rlc3RfcHByaW50JywKICAgICd0ZXN0X3JlJywKICAgICd0ZXN0X3NldCcsCiAgICAndGVzdF9zcWxpdGUzJywKICAgICd0ZXN0X3N0YXRpc3RpY3MnLApsdWU9IkoiPkpvaG48L29wdGlvbj4gIDxvcHRpb24gdmFsdWU9IlAiPlBhdWw8L29wdGlvbj4nCiAgICAgICAgICAgICc8b3B0aW9uIHZhbHVlPSJHIj5HZW9yZ2U8L29wdGlvbj48b3B0aW9uIHZhbHVlPSJSIj5SaW5nbycKICAgICAgICAgICAgIjwvb3B0aW9uPjwvc2VsZWN0PjwvZGl2PiIsCiAgICAgICAgICAgIGZvcm0ucmVuZGVyKCksCiAgICAgICAgKQoiIiJEZWZpbmUgcGFydGlhbCBQeXRob24gY29kZSBQYXJzZXIgdXNlZCBieSBlZGl0b3IgYW5kIGh5cGVycGFyc2VyLgoKSW5zdGFuY2VzIG9mIFBhcnNlTWFwIGFyZSB1c2VkIHdpdGggc3RyLnRyYW5zbGF0ZS4KClRoZSBmb2xsb3dpbmcgYm91bmQgc2VhcmNoIGFuZCBtYXRjaCBmdW5jdGlvbnMgYXJlIGRlZmluZWQ6Cl9zeW5jaHJlIC0gc3RhcnQgb2YgcG9wdWxhciBzdGF0ZW1lbnQ7Cl9qdW5rcmUgLSB3aGl0ZXNwYWNlIG9yIGNvbW1lbnQgbGluZTsKX21hdGNoX3N0cmluZ3JlOiBzdHJpbmcsIHBvc3NpYmx5IHdpdGhvdXQgY2xvc2VyOwpfaXRlbXJlIC0gbGluZSB0aGF0IG1heSBoYXZlIGJyYWNrZXQgc3RydWN0dXJlIHN0YXJ0OwpfY2xvc2VyZSAtIGxpbmUgdGhhdCBtdXN0IGJlIGZvbGxvd2VkIGJ5IGRlZGVudC4KX2NoZXdfb3JkaW5hcnlyZSAtIG5vbi1zcGVjaWFsIGNoYXJhY3RlcnMuCiIiIgppbXBvcnQgcmUKCiMgUmVhc29uIGxhc3Qgc3RhdGVtZW50IGlzIGNvbnRpbnVlZCAob3IgQ19OT05FIGlmIGl0J3Mgbm90KS4KKENfTk9ORSwgQ19CQUNLU0xBU0gsIENfU1RSSU5HX0ZJUlNUX0xJTkUsCiBDX1NUUklOR19ORVhUX0xJTkVTLCBDX0JSQUNLRVQpID0gcmFuZ2UoNSkKCiMgRmluZCB3aGF0IGxvb2tzIGxpa2UgdGhlIHN0YXJ0IG9mIGEgcG9wdWxhciBzdGF0ZW1lbnQuCgpfc3luY2hyZSA9IHJlLmNvbXBpbGUociIiIgogICAgXgogICAgWyBcdF0qCiAgICAoPzogd2hpbGUKICAgIHwgICBlbHNlCiAgICB8ICAgZGVmCiAgICB8ICAgcmV0dXJuCiAgICB8ICAgYXNzZXJ0CiAgICB8ICAgYnJlYWsKICAgIHwgICBjbGFzcwogICAgfCAgIGNvbnRpbnVlCiAgICB8ICAgZWxpZgogICAgfCAgIHRyeQogICAgfCAgIGV4Y2VwdAogICAgfCAgIHJhaXNlCiAgICB8ICAgaW1wb3J0CiAgICB8ICAgeWllbGQKICAgICkKICAgIFxiCiIiIiwgcmUuVkVSQk9TRSB8IHJlLk1VTFRJTElORSkuc2VhcmNoCgojIE1hdGNoIGJsYW5rIGxpbmUgb3Igbm9uLWluZGVudGluZyBjb21tZW50IGxpbmUuCgpfanVua3JlID0gcmUuY29tcGlsZShyIiIiCiAgICBbIFx0XSoKICAgICg/OiBcIyBcUyAuKiApPwogICAgXG4KIiIiLCByZS5WRVJCT1NFKS5tYXRjaAoKIyBNYXRjaCBhbnkgZmxhdm9yIG9mIHN0cmluZzsgdGhlIHRlcm1pbmF0aW5nIHF1b3RlIGlzIG9wdGlvbmFsCiMgc28gdGhhdCB3ZSdyZSByb2J1c3QgaW4gdGhlIGZhY2Ugb2YgaW5jb21wbGV0ZSBwcm9ncmFtIHRleHQuCgpfbWF0Y2hfc3RyaW5ncmUgPSByZS5jb21waWxlKHIiIiIKICAgIFwiIiIgW14iXFxdKiByb20gaXNzdWUgNzc0MwogICAgICAgICAgICAnMTE2NTEyODc0OTQwNTk0MTk1NjM4NjE3OTA3MDkyNTY5ODgxNTE5MDM0NzkzMjI5Mzg1JyAjLi4uCiAgICAgICAgICAgICcyMjg1NjkxNjUxOTE1NDE4OTA4NDY1NjQ2Njk3NzE3MTQ4OTY5MTYwODQ4ODM5ODc5MjAnICMuLi4KICAgICAgICAgICAgJzQ3MzMyMTI2ODEwMDI5Njg1NzYzNjIwMDkyNjA2NTM0MDc2OTY4Mjg2MzM0OTIwNTM2MycgIy4uLgogICAgICAgICAgICAnMzQ5MjQ3NjM3NjYwNjcxNzgzMjA5OTA3OTQ5MjczNjgzMDQwMzk3OTc5OTg0MTA3ODA2JyAjLi4uCiAgICAgICAgICAgICc0NjE4MjI2OTMzMzI3MTI4MjgzOTc2MTc5NDYwMzYyMzk1ODE2MzI5NzY1ODUxMDA2MzMnICMuLi4KICAgICAgICAgICAgJzUyMDI2MDc3MDc2MTA2MDcyNTQwMzkwNDEyMzE0NDM4NDU3MTYxMjA3MzczMjc1NDc3NCcgIy4uLgogICAgICAgICAgICAnNTg4MjExOTQ0NDA2NDY1NTcyNTkxMDIyMDgxOTczODI4NDQ4OTI3MzM4NjAyNTU2Mjg3JyAjLi4uCiAgICAgICAgICAgICc4NTE4MzE3NDU0MTkzOTc0MzMwMTI0OTE4ODQ4Njk0NTQ0NjI0NDA1MzY4OTUwNDc0OTknICMuLi4KICAgICAgICAgICAgJzQzNjU1MTk3NDY0OTczMTkxNzE3MDA5OTM4Nzc2Mjg3MTAyMDQwMzU4Mjk5NDE5MzQzOScgIy4uLgogICAgICAgICAgICAnNzYxOTMzNDEyMTY2ODIxNDg0MDE1ODgzNjMxNjIyNTM5MzE0MjAzNzk5MDM0NDk3OTgyJyAjLi4uCiAgICAgICAgICAgICcxMzAwMzg3NDE3NDE3Mjc5MDc0Mjk1NzU2NzMzMDI0NjEzODAzODY1OTY1MDExODc0ODInICMuLi4KICAgICAgICAgICAgJzAwNjI1NzUyNzcwOTg0MjE3OTMzNjQ4ODM4MTY3MjgxODc5ODQ1MDIyOTMzOTEyMzUyNycgIy4uLgogICAgICAgICAgICAnODU4ODQ0NDQ4MzM2ODE1OTEyMDIwNDUyMjk0NjI0OTE2OTkzNTQ2Mzg4OTU2NTYxNTIyJyAjLi4uCiAgICAgICAgICAgICcxNjE4NzUzNTI1NzI1OTA0MjA4MjM2MDc0Nzg3ODgzOTk0NjAxNjIyMjgzMDg2OTM3NDInICMuLi4KICAgICAgICAgICAgJzA1Mjg3NjYzNDQxNDAzNTMzOTQ4MjA0MDg1MzkwODk4Mzk5MDU1MDA0MTE5ODczMDQ2ODc1ZS0xMDc1JywKCiAgICAgICAgICAgICc1MjU0NDA2NTMzNTI5NTUyNjYxMDk2NjEwNjAzNTgyMDI4MTk1NjEyNTg5ODQ5NjQ5MTMnICMuLi4KICAgICAgICAgICAgJzg5MjI1NjUyNzg0OTc1ODk1NjA0NTIxODI1NzA1OTcxMzc2NTg3NDI1MTQzNjE5MzYxOScgIy4uLgogICAgICAgICAgICAnNDQzMjQ4MjA1OTk4ODcwMDAxNjMzODY1NjU3NTE3NDQ3MzU1OTkyMjI1ODUyOTQ1OTEyJyAjLi4uCiAgICAgICAgICAgICcwMTY2Njg2NjAwMDAyMTAyODM4MDcyMDk4NTA2NjIyMjQ0MTc1MDQ3NTIyNjQ5OTUzNjAnICMuLi4KICAgICAgICAgICAgJzYzMTUxMjAwNzc1Mzg1NTgwMTA3NTM3MzA1NzYzMjE1NzczODc1MjgwMDg0MDMwMjU5NicgIy4uLgogICAgICAgICAgICAnMjM3MDUwMjQ3OTEwNTMwNTM4MjUwMDA4NjgyMjcyNzgzNjYwNzc4MTgvcmFpc2VzNTAwLyIsIGhlYWRlcnM9eyJhY2NlcHQiOiAidGV4dC9wbGFpbiJ9KQogICAgICAgIHNlbGYuYXNzZXJ0Q29udGFpbnMocmVzcG9uc2UsICJPaCBkZWFyLCBhbiBlcnJvciBvY2N1cnJlZCEiLCBzdGF0dXNfY29kZT01MDApCgoKY2xhc3MgRGVidWdWaWV3UXVlcmllc0FsbG93ZWRUZXN0cyhTaW1wbGVUZXN0Q2FzZSk6CiAgICAjIE1heSBuZWVkIGEgcXVlcnkgdG8gaW5pdGlhbGl6ZSBNeVNRTCBjb25uZWN0aW9uCiAgICBkYXRhYmFzZXMgPSB7ImRlZmF1bHQifQoKICAgIGRlZiB0ZXN0X2hhbmRsZV9kYl9leGNlcHRpb24oc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgRW5zdXJlIHRoZSBkZWJ1ZyB2aWV3IHdvcmtzIHdoZW4gYSBkYXRhYmFzZSBleGNlcHRpb24gaXMgcmFpc2VkIGJ5CiAgICAgICAgcGVyZm9ybWluZyBhbiBpbnZhbGlkIHF1ZXJ5IGFuZCBwYXNzaW5nIHRoZSBleGNlcHRpb24gdG8gdGhlIGRlYnVnCiAgICAgICAgdmlldy4KICAgICAgICAiIiIKICAgICAgICB3aXRoIGNvbm5lY3Rpb24uY3Vyc29yKCkgYXMgY3Vyc29yOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiSU5WQUxJRCBTUUwiKQogICAgICAgICAgICBleGNlcHQgRGF0YWJhc2VFcnJvcjoKICAgICAgICAgICAgICAgIGV4Y19pbmZvID0gc3lzLmV4Y19pbmZvKCkKCiAgICAgICAgcmYgPSBSZXF1ZXN0RmFjdG9yeSgpCiAgICAgICAgcmVzcG9uc2UgPSB0ZWNobmljYWxfNTAwX3Jlc3BvbnNlKHJmLmdldCgiLyIpLCAqZXhjX2luZm8pCiAgICAgICAgc2VsZi5hc3NlcnRDb250YWlucyhyZXNwb25zZSwgIk9wZXJhdGlvbmFsRXJyb3IgYXQgLyIsIHN0YXR1c19jb2RlPTUwMCkKCgpAb3ZlcnJpZGVfc2V0dGluZ3MoCiAgICBERUJVRz1UcnVlLAogICAgUk9PVF9VUkxDT05GPSJ2aWV3X3Rlc3RzLnVybHMiLAogICAgIyBObyB0ZW1wbGF0ZSBkaXJlY3RvcmllcyBhcmUgY29uZmlndXJlZCwgc28gbm8gdGVtcGxhdGVzIHdpbGwgYmUgZm91bmQuCiAgICBURU1QTEFURVM9WwogICAgICAgIHsKICAgICAgICAgICAgIkJBQ0tFTkQiOiAiZGphbmdvLnRlbXBsYXRlLmJhY2tlbmRzLmR1bW15LlRlbXBsYXRlU3RyaW5ncyIsCiAgICAgICAgfQogICAgXSwKKQpjbGFzcyBOb25EamFuZ29UZW1wbGF0ZXNEZWJ1Z1ZpZXdUZXN0cyhTaW1wbGVUZXN0Q2FzZSk6CiAgICBkZWYgdGVzdF80MDAoc2VsZik6CiAgICAgICAgIyBXaGVuIERFQlVHPVRydWUsIHRlY2huaWNhbF81MDBfdGVtcGxhdGUoKSBpcyBjYWxsZWQuCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydExvZ3MoImRqYW5nby5zZWN1cml0eSIsICJXQVJOSU5HIik6CiAgICAgICAgICAgIHJlc3BvbnNlID0gc2VsZi5jbGllbnQuZ2V0KCIvcmFpc2VzNDAwLyIpCiAgICAgICAgc2VsZi5hc3NlcnRDb250YWlucyhyZXNwb25zZSwgJzxkaXYgY2xhc3M9ImNvbnRleHQiIGlkPSInLCBzdGF0dXNfY29kZT00MDApCgogICAgZGVmIHRlc3RfNDAwX2JhZF9yZXFlbiA9IG9zLmdldGVudigiVFJBTlNJRkVYX0FQSV9UT0tFTiIpCiAgICBpZiBub3QgYXBpX3Rva2VuOgogICAgICAgIHBhcnNlciA9IENvbmZpZ1BhcnNlcigpCiAgICAgICAgcGFyc2VyLnJlYWQob3MucGF0aC5leHBhbmR1c2VyKCJ+Ly50cmFuc2lmZXhyYyIpKQogICAgICAgIGFwaV90b2tlbiA9IHBhcnNlci5nZXQoImh0dHBzOi8vd3d3LnRyYW5zaWZleC5jb20iLCAidG9rZW4iKQoKICAgIGFzc2VydCBhcGlfdG9rZW4sICJQbGVhc2UgZGVmaW5lIHRoZSBUUkFOU0lGRVhfQVBJX1RPS0VOIGVudiB2YXIuIgogICAgcmV0dXJuIGFwaV90b2tlbgoKCmRlZiBnZXRfYXBpX3Jlc3BvbnNlKGVuZHBvaW50LCBhcGlfdG9rZW49Tm9uZSwgcGFyYW1zPU5vbmUsIHZlcmJvc2l0eT0wKToKICAgIGlmIGFwaV90b2tlbiBpcyBOb25lOgogICAgICAgIGFwaV90b2tlbiA9IGdldF9hcGlfdG9rZW4oKQogICAgaGVhZGVycyA9IHsKICAgICAgICAiQXV0aG9yaXphdGlvbiI6IGYiQmVhcmVyIHthcGlfdG9rZW59IiwKICAgICAgICAiQWNjZXB0IjogImFwcGxpY2F0aW9uL3ZuZC5hcGkranNvbiIsCiAgICAgICAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiwKICAgIH0KICAgIGVuZHBvaW50ID0gZW5kcG9pbnQuc3RyaXAoIi8iKQogICAgdXJsID0gZiJodHRwczovL3Jlc3QuYXBpLnRyYW5zaWZleC5jb20ve2VuZHBvaW50fSIKICAgIGlmIHZlcmJvc2l0eSA+IDI6CiAgICAgICAgcHJpbnQoZiJcbj4+PiBHRVQge3VybD19IHtwYXJhbXM9fSIpCiAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldCh1cmwsIGhlYWRlcnM9aGVhZGVycywgcGFyYW1zPXBhcmFtcykKICAgIGlmIHZlcmJvc2l0eSA+IDI6CiAgICAgICAgcHJpbnQoZiI+Pj4+IEdFVCB7cmVzcG9uc2U9fVxuIikKICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKVsiZGF0YSJdCgoKZGVmIGxpc3RfcmVzb3VyY2VzX3dpdGhfdXBkYXRlcygKICAgIGRhdGVfc2luY2UsIHJlc291cmNlcz1Ob25lLCBsYW5ndWFnZXM9Tm9uZSwgdmVyYm9zaXR5PTAKKToKICAgIGFwaV90b2tlbiA9IGdldF9hcGlfdG9rZW4oKQogICAgcHJvamVjdCA9ICJvOmRqYW5nbzpwOmRqYW5nbyIKICAgIGRhdGVfc2luY2VfaXNvID0gZGF0ZV9zaW5jZS5pc29mb3JtYXQoKS5zdHJpcCgiWiIpICsgIloiCiAgICBpZiB2ZXJib3NpdHk6CiAgICAgICAgcHJpbnQoZiJcbj09IFN0YXJ0aW5nIGxpc3RfcmVzb3VyY2VzX3dpdGhfdXBkYXRlcyBhdCB7ZGF0ZV9zaW5jZV9pc289fSIpCgogICAgaWYgbm90IGxhbmd1YWdlczoKICAgICAgICBsYW5ndWFnZXMgPSBbICAjIExpc3QgbGFuZ3VhZ2VzIHVzaW5nIFRyYW5zaWZleCBwcm9qZWN0cyBBUEkuCiAgICAgICAgICAgIGRbImF0dHJpYnV0ZXMiXVsiY29kZSJdCiAgICAgICAgICAgIGZvciBkIGluIGdldF9hcGlfcmVzcG9uc2UoCiAgICAgICAgICAgICAgICBmInByb2plY3RzL3twcm9qZWN0fS9sYW5zdF9jb29raWVfbm90X3Jlc2V0X29uX2FjY2VwdGVkX3JlcXVlc3Qoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgVGhlIGNzcmYgdG9rZW4gdXNlZCBpbiBwb3N0cyBpcyBjaGFuZ2VkIG9uIGV2ZXJ5IHJlcXVlc3QgKGFsdGhvdWdoCiAgICAgICAgc3RheXMgZXF1aXZhbGVudCkuIFRoZSBjc3JmIGNvb2tpZSBzaG91bGQgbm90IGNoYW5nZSBvbiBhY2NlcHRlZAogICAgICAgIHJlcXVlc3RzLiBJZiBpdCBhcHBlYXJzIGluIHRoZSByZXNwb25zZSwgaXQgc2hvdWxkIGtlZXAgaXRzIHZhbHVlLgogICAgICAgICIiIgogICAgICAgIHJlcSA9IHNlbGYuX2dldF9QT1NUX3JlcXVlc3Rfd2l0aF90b2tlbigpCiAgICAgICAgbXcgPSBDc3JmVmlld01pZGRsZXdhcmUodG9rZW5fdmlldykKICAgICAgICBtdy5wcm9jZXNzX3JlcXVlc3QocmVxKQogICAgICAgIG13LnByb2Nlc3NfdmlldyhyZXEsIHRva2VuX3ZpZXcsICgpLCB7fSkKICAgICAgICByZXNwID0gbXcocmVxKQogICAgICAgIGNzcmZfY29va2llID0gc2VsZi5fcmVhZF9jc3JmX2Nvb2tpZShyZXEsIHJlc3ApCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgKICAgICAgICAgICAgY3NyZl9jb29raWUsCiAgICAgICAgICAgIFRFU1RfU0VDUkVULAogICAgICAgICAgICAiQ1NSRiBjb29raWUgd2FzIGNoYW5nZWQgb24gYW4gYWNjZXB0ZWQgcmVxdWVzdCIsCiAgICAgICAgKQoKICAgIEBvdmVycmlkZV9zZXR0aW5ncyhERUJVRz1UcnVlLCBBTExPV0VEX0hPU1RTPVsid3d3LmV4YW1wbGUuY29tIl0pCiAgICBkZWYgdGVzdF9odHRwc19iYWRfcmVmZXJlcihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBIFBPU1QgSFRUUFMgcmVxdWVzdCB3aXRoIGEgYmFkIHJlZmVyZXIgaXMgcmVqZWN0ZWQKICAgICAgICAiIiIKICAgICAgICByZXEgPSBzZWxmLl9nZXRfUE9TVF9yZXF1ZXN0X3dpdGhfdG9rZW4oKQogICAgICAgIHJlcS5faXNfc2VjdXJlX292ZXJyaWRlID0gVHJ1ZQogICAgICAgIHJlcS5NRVRBWyJIVFRQX0hPU1QiXSA9ICJ3d3cuZXhhbXBsZS5jb20iCiAgICAgICAgcmVxLk1FVEFbIkhUVFBfUkVGRVJFUiJdID0gImh0dHBzOi8vd3d3LmV2aWwub3JnL3NvbWVwYWdlIgogICAgICAgIHJlcS5NRVRBWyJTRVJWRVJfUE9SVCJdID0gIjQ0MyIKICAgICAgICBtdyA9IENzcmZWaWV3TWlkZGxld2FyZShwb3N0X2Zvcm1fdmlldykKICAgICAgICByZXNwb25zZSA9IG13LnByb2Nlc3NfdmlldyhyZXEsIHBvc3RfZm9ybV92aWV3LCAoKSwge30pCiAgICAgICAgc2VsZi5hc3NlcnRDb250YWlucygKICAgICAgICAgICAgcmVzcG9uc2UsCiAgICAgICAgICAgICJSZWZlcmVyIGNoZWNraW5nIGZhaWxlZCAtIGh0dHBzOi8vd3d3LmV2aWwub3JnL3NvbWVwYWdlIGRvZXMgbm90ICIKICAgICAgICAgICAgIm1hdGNoIGFueSB0cnVzdGVkIG9yaWdpbnMuIiwKICAgICAgICAgICAgc3RhdHVzX2NvZGU9NDAzLAogICAgICAgICkKCiAgICBkZWYgX2NoZWNrX3JlZmVyZXJfcmVqZWN0cyhzZW9uLT5qdW1wX3RhcmdldF0iLAogICAgSG9sZVZhbHVlLkVSUk9SX1RBUkdFVDogInN0YXRlLT5pbnN0cnVjdGlvbl9zdGFydHNbaW5zdHJ1Y3Rpb24tPmVycm9yX3RhcmdldF0iLAogICAgSG9sZVZhbHVlLlpFUk86ICIiLAp9CgpfQUFSQ0g2NF9HT1RfUkVMT0NBVElPTlMgPSB7CiAgICAiUl9BQVJDSDY0X0FEUl9HT1RfUEFHRSIsCiAgICAiUl9BQVJDSDY0X0xENjRfR09UX0xPMTJfTkMiLAogICAgIkFSTTY0X1JFTE9DX0dPVF9MT0FEX1BBR0UyMSIsCiAgICAiQVJNNjRfUkVMT0NfR09UX0xPQURfUEFHRU9GRjEyIiwKICAgICJJTUFHRV9SRUxfQVJNNjRfUEFHRUJBU0VfUkVMMjEiLAogICAgIklNQUdFX1JFTF9BUk02NF9QQUdFT0ZGU0VUXzEyTCIsCiAgICAiSU1BR0VfUkVMX0FSTTY0X1BBR0VPRkZTRVRfMTJBIiwKfQoKX1g4Nl9HT1RfUkVMT0NBVElPTlMgPSB7CiAgICAiUl9YODZfNjRfR09UUENSRUxYIiwKICAgICJSX1g4Nl82NF9SRVhfR09UUENSRUxYIiwKICAgICJYODZfNjRfUkVMT0NfR09UIiwKICAgICJYODZfNjRfUkVMT0NfR09UX0xPQUQiLAogICAgIklNQUdFX1JFTF9BTUQ2NF9SRUwzMiIsCn0KCgpAZGF0YWNsYXNzZXMuZGF0YWNsYXNzCmNsYXNzIEhvbGU6CiAgICAiIiIKICAgIEEgImhvbGUiIGluIHRoZSBzdGVuY2lsIHRvIGJlIHBhdGNoZWQgd2l0aCBhIGNvbXB1dGVkIHJ1bnRpbWUgdmFsdWUuCgogICAgQW5hbG9nb3VzIHRvIHJlbG9jYXRpb24gcmVjb3JkcyBpbiBhbiBvYmplY3QgZmlsZS4KICAgICIiIgoKICAgIG9mZnNldDogaW50CiAgICBraW5kOiBfc2NoZW1hLkhvbGVLaW5kCiAgICAjIFBhdGNoIHdpdGggdGhpcyBiYXNlIHZhbHVlOgogICAgdmFsdWU6IEhvbGVWYWx1ZQogICAgIyAuLi5wbHVzIHRoZSBhZGRyZXNzIG9mIHRoaXMgc3ltYm9sOgogICAgc3ltYm9sOiBzdHIgfCBOb25lCiAgICAjIC4uLnBsdXMgdGhpcyBhZGRlbmQ6CiAgICBhZGRlbmQ6IGludAogICAgbmVlZF9zdGF0ZTogYm9vbCA9IEZhbHNlCiAgICBjdXN0b21fbG9jYXRpb246IHN0ciA9ICIiCiAgICBjdXN0b21fdmFsdWU6IHN0ciA9ICIiCiAgICBmdW5jOiBzdHIgPSBkYXRhY2xhc3Nlcy5maWVsZChpbml0PUZhbHNlKQogICAgIyBDb252ZW5pZW5jZSBtZXRob2Q6CiAgICByZXBsYWNlID0gZGF0YWNsYXNzZXMucmVwbGFjZQoKICAgIGRlZiBfX3Bvc3RfaW5pdF9fKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgc2VsZi5mdW5jID0gX1BBVENIX0ZVTkNTW3NlbGYua2luZF0KCiAgICBkZWYgZm9sZChzZWxmLCBvdGhlcjogdHlwaW5nLlNlbGYsIGJvZHk6IGJ5dGVhcnJheSkgLT4gdHlwaW5nLlNlbGYgfCBOb25lOgogICAgICAgICIiIkNvbWJpbmUgdHdvIGhvbGVzIGludG8gYSBzaW5nbGUgaG9sZSwgaWYgcG9zc2libGUuIiIiCiAgICAgICAgaW5zdHJ1Y3Rpb25fYSA9IGludC5mcm9tX2J5dGVzKAogICAgICAgICAgICBib2R5W3NlbGYub2Zmc2V0IDogc2VsZi5vZmZzZXQgKyA0XSwgYnl0ZW9yZGVyPXN5cy5ieXRlb29uIGxpYnJhcmllcyksIGJ1dCB0aGF0J3MgZmluZQojIGZvciBtb3N0IHByb2dyYW1zIGFuZCBpcyBlYXNpZXIgZm9yIHRoZSBjYXN1YWwgdXNlciB0aGFuIG1ha2luZyB0aGVtCiMgaW5zdGFudGlhdGUgdGhlaXIgb3duIFJhbmRvbSgpIGluc3RhbmNlLgoKX2luc3QgPSBSYW5kb20oKQpzZWVkID0gX2luc3Quc2VlZApyYW5kb20gPSBfaW5zdC5yYW5kb20KdW5pZm9ybSA9IF9pbnN0LnVuaWZvcm0KdHJpYW5ndWxhciA9IF9pbnN0LnRyaWFuZ3VsYXIKcmFuZGludCA9IF9pbnN0LnJhbmRpbnQKY2hvaWNlID0gX2luc3QuY2hvaWNlCnJhbmRyYW5nZSA9IF9pbnN0LnJhbmRyYW5nZQpzYW1wbGUgPSBfaW5zdC5zYW1wbGUKc2h1ZmZsZSA9IF9pbnN0LnNodWZmbGUKY2hvaWNlcyA9IF9pbnN0LmNob2ljZXMKbm9ybWFsdmFyaWF0ZSA9IF9pbnN0Lm5vcm1hbHZhcmlhdGUKbG9nbm9ybXZhcmlhdGUgPSBfaW5zdC5sb2dub3JtdmFyaWF0ZQpleHBvdmFyaWF0ZSA9IF9pbnN0LmV4cG92YXJpYXRlCnZvbm1pc2VzdmFyaWF0ZSA9IF9pbnN0LnZvbm1pc2VzdmFyaWF0ZQpnYW1tYXZhcmlhdGUgPSBfaW5zdC5nYW1tYXZhcmlhdGUKZ2F1c3MgPSBfaW5zdC5nYXVzcwpiZXRhdmFyaWF0ZSA9IF9pbnN0LmJldGF2YXJpYXRlCmJpbm9taWFsdmFyaWF0ZSA9IF9pbnN0LmJpbm9taWFsdmFyaWF0ZQpwYXJldG92YXJpYXRlID0gX2luc3QucGFyZXRvdmFyaWF0ZQp3ZWlidWxsdmFyaWF0ZSA9IF9pbnN0LndlaWJ1bGx2YXJpYXRlCmdldHN0YXRlID0gX2luc3QuZ2V0c3RhdGUKc2V0c3RhdGUgPSBfaW5zdC5zZXRzdGF0ZQpnZXRyYW5kYml0cyA9IF9pbnN0LmdldHJhbmRiaXRzCnJhbmRieXRlcyA9IF9pbnN0LnJhbmRieXRlcwoKCiMjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIyAtLS0tLS0tLS0tLS0tLS0tLSB0ZXN0IHByb2dyYW0gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmRlZiBfdGVzdF9nZW5lcmF0b3IobiwgZnVuYywgYXJncyk6CiAgICBmcm9tIHN0YXRpc3RpY3MgaW1wb3J0IHN0ZGV2LCBmbWVhbiBhcyBtZWFuCiAgICBmcm9tIHRpbWUgaW1wb3J0IHBlcmZfY291bnRlcgoKICAgIHQwID0gcGVyZl9jb3VudGVyKCkKICAgIGRhdGEgPSBbZnVuYygqYXJncykgZm9yIGkgaW4gX3JlcGVhdChOb25lLCBuKV0KICAgIHQxID0gcGVyZl9jb3VudGVyKCkKCiAgICB4YmFyID0gbWVhbihkYXRhKQogICAgc2lnbWEgPSBzdGRldihkYXRhLCB4YmFyKQogICAgbG93ID0gbWluKGRhdGEpCiAgICBoaWdoID0gbWF4KGRhdGEpCgogICAgcHJpbnQoZid7dDEgLSB0MDouM2Z9IHNlYywge259IHRpbWVzIHtmdW5jLl9fbmFtZV9ffXthcmdzIXJ9JykKICAgIHByaW50KCdhdmcgJWcsIHN0ZGRldiAlZywgbWluICVnLCBtYXggJWdcbicgJSAoeGJhciwgc2lnbWEsIGxvdywgaGlnaCkpCgoKZGVmIF90ZXN0KE49MTBfMDAwKToKICAgIF90ZXN0X2dlbmVyYXRvcihOLCByYW5kb20sICgpKQogICAgIChfbmFtZSwgTmFtZS5GdW5jdGlvbiksCiAgICAgICAgICAgIChyIltcfHxcLnxcK3xcKnxcP10iLCBPcGVyYXRvciksCiAgICAgICAgICAgIChyInt8fXxcKHxcKXxcW3xcXSIsIFB1bmN0dWF0aW9uKSwKICAgICAgICAgICAgKHIiLiIsIFRleHQpLAogICAgICAgIF0sCiAgICB9CiMgQ29weXJpZ2h0IChjKSAyMDA4LTIwMDkgQXJ5ZWggTGVpYiBUYXVyb2csIGFsbCByaWdodHMgcmVzZXJ2ZWQuCiMgTW9kaWZpZWQgZnJvbSBvcmlnaW5hbCBjb250cmlidXRpb24gYnkgQXJ5ZWggTGVpYiBUYXVyb2csIHdoaWNoIHdhcwojIHJlbGVhc2VkIHVuZGVyIHRoZSBOZXcgQlNEIGxpY2Vuc2UuCgpmcm9tIGRqYW5nby5jb250cmliLmdpcy5nZW9zIGltcG9ydCAoCiAgICBMaW5lYXJSaW5nLAogICAgTGluZVN0cmluZywKICAgIE11bHRpUG9pbnQsCiAgICBQb2ludCwKICAgIFBvbHlnb24sCiAgICBmcm9tc3RyLAopCmZyb20gZGphbmdvLnRlc3QgaW1wb3J0IFNpbXBsZVRlc3RDYXNlCgoKZGVmIGFwaV9nZXRfZGlzdGFuY2UoeCk6CiAgICByZXR1cm4geC5kaXN0YW5jZShQb2ludCgtMjAwLCAtMjAwKSkKCgpkZWYgYXBpX2dldF9idWZmZXIoeCk6CiAgICByZXR1cm4geC5idWZmZXIoMTApCgoKZGVmIGFwaV9nZXRfZ2VvbV90eXBlaWQoeCk6CiAgICByZXR1cm4geC5nZW9tX3R5cGVpZAoKCmRlZiBhcGlfZ2V0X251bV9jb29yZHMoeCk6CiAgICByZXR1cm4geC5udW1fY29vcmRzCgoKZGVmIGFwaV9nZXRfY2VudHJvaWQoeCk6CiAgICByZXR1cm4geC5jZW50cm9pZAoKCmRlZiBhcGlfZ2V0X2VtcHR5KHgpOgogICAgcmV0dXJuIHguZW1wdHkKCgpkZWYgYXBpX2dldF92YWxpZCh4KToKICAgIHJldHVybiB4LnZhbGlkCgoKZGVmIGFwaV9nZXRfc2ltcGxlKHgpOgogICAgcmV0dXJuIHguc2ltcGxlCgoKZGVmIGFwaV9nZXRfcmluZyh4KToKICAgIHJldHVybiB4LnJpbmcKCgpkZWYgYXBpX2dldF9ib3VuZGFyeSh4KToKICAgIHJldHVybiB4LmJvdW5kYXJ5CgoKZGVmIGFwaV9nZXRfY29udmV4X2h1bGwoeCk6CiAgICByZXR1cm4geC5jb252ZXhfaHVsbAoKCmRlZiBhcGlfZ2V0X2V4dGVudCh4KToKICAgIHJldHVybiB4LmV4dGVudAoKCmRlZiBhcGlfZ2V0X2FyZWEoeCk6CiAgICByZXR1cm4geC5hcmVhCgoKZGVmIGFwaV9nZXRfbGVuZ3RoKHgpOgogICAgcmV0dXJuIHgubGVuZ3RoCgoKZ2Vvc19mdW5jdGlvbl90ZXN0cyA9IFsKICAgIHZhbAogICAgZm9yIG5hbWUsIHZhbCBpbiB2YXJzKCkuaXRlbXMoKQogICAgaWYgaGFzYXR0cih2YWwsICJfX2NhbGxfXyIpIGFuZCBuYW1lLnN0YXJ0c3dpdGgoImFwaV9nZXRfIikKXQoKCmNsYXNzIEdFT1NNdXRhdGlvblRlc3QoU2ltcGxlVGVzdENhc2UpOgogICAgIiIiCiAgICBUZXN0cyBQeXRob25pYyBNdXRhYmlsaXR5IG9mIFB5dGhvbiBHRU9TIGdlb21ldHJ5IHdyYXBwZXJzCiAgICBnZXQvc2V0L2RlbGl0ZW0gb24gYSBzbGljZSwgbm9ybWFsIGxpc3QgbWV0aG9kcwogIGZyb20ge21vZH0gaW1wb3J0IG9wZW4sIFRleHRJT1dyYXBwZXIKICAgICAgICAgICAgaW1wb3J0IHBhdGhsaWIKCiAgICAgICAgICAgIHdpdGggb3Blbih7ZmlsZW5hbWUhcn0pIGFzIGY6ICAgICAgICAgICAjIGxpbmUgNQogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgcGF0aGxpYi5QYXRoKHtmaWxlbmFtZSFyfSkucmVhZF90ZXh0KCkgICMgbGluZSA4CiAgICAgICAgJycnKQogICAgICAgIHByb2MgPSBhc3NlcnRfcHl0aG9uX29rKCctWCcsICd3YXJuX2RlZmF1bHRfZW5jb2RpbmcnLCAnLWMnLCBjb2RlKQogICAgICAgIHdhcm5pbmdzID0gcHJvYy5lcnIuc3BsaXRsaW5lcygpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChsZW4od2FybmluZ3MpLCAyKQogICAgICAgIHNlbGYuYXNzZXJ0U3RhcnRzV2l0aCh3YXJuaW5nc1swXSwgYiI8c3RyaW5nPjo1OiBFbmNvZGluZ1dhcm5pbmc6ICIpCiAgICAgICAgc2VsZi5hc3NlcnRTdGFydHNXaXRoKHdhcm5pbmdzWzFdLCBiIjxzdHJpbmc+Ojg6IEVuY29kaW5nV2FybmluZzogIikKCiAgICBkZWYgdGVzdF90ZXh0X2VuY29kaW5nKHNlbGYpOgogICAgICAgICMgUEVQIDU5NywgYnBvLTQ3MDAwLiBpby50ZXh0X2VuY29kaW5nKCkgcmV0dXJucyAibG9jYWxlIiBvciAidXRmLTgiCiAgICAgICAgIyBiYXNlZCBvbiBzeXMuZmxhZ3MudXRmOF9tb2RlCiAgICAgICAgY29kZSA9ICJpbXBvcnQgaW87IHByaW50KGlvLnRleHRfZW5jb2RpbmcoTm9uZSkpIgoKICAgICAgICBwcm9jID0gYXNzZXJ0X3B5dGhvbl9vaygnLVgnLCAndXRmOD0wJywgJy1jJywgY29kZSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGIibG9jYWxlIiwgcHJvYy5vdXQuc3RyaXAoKSkKCiAgICAgICAgcHJvYyA9IGFzc2VydF9weXRob25fb2soJy1YJywgJ3V0Zjg9MScsICctYycsIGNvZGUpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChiInV0Zi04IiwgcHJvYy5vdXQuc3RyaXAoKSkKCgpjbGFzcyBDTWlzY0lPVGVzdChNaXNjSU9UZXN0LCBDVGVzdENhc2UpOgogICAgbmFtZV9vZl9tb2R1bGUgPSAiaW8iLCAiX2lvIgogICAgZXh0cmFfZXhwb3J0ZWQgPSAiQmxvY2tpbmdJT0Vycm9yIiwKCiAgICBkZWYgdGVzdF9yZWFkaW50b19idWZmZXJfb3ZlcmZsb3coc2VsZik6CiAgICAgICAgIyBJc3N1ZSAjMTgwMjUKICAgICAgICBjbGFzcyBCYWRSZWFkZXIoc2VsZi5pby5CdWZmZXJlZElPQmFzZSk6CiAgICAgICAgICAgIGRlZiByZWFkKHNlbGYsIG49LTEpOgogICAgICAgICAgICAgICAgcmV0dXJuIGIneCcgKiAxMCoqNgogICAgICAgIGJ1ZmlvID0gQmFkUmVhZGVyKCkKICAgICAgICBiID0gYnl0ZWFycmF5KDIpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoVmFsdWVFcnJvciwgYnVmaW8ucmVhZGludG8sIGIpCgogICAgZGVmIGNoZWNrX2RhZW1vbl90aHJlYWRzX3NodXRkb3duX2RlYWRsb2NrKHNlbGYsIHN0cmVhbV9uYW1lKToKICAgICAgICAjIElzc3VlICMyMzMwOTogZGVhZGxvY2tzIGF0IGRsZXIuY291bnQgPSA1MAogICAgICAgICAgICBlbmNvZGVkID0gY29kZWNzLmNvZGVfcGFnZV9lbmNvZGUoNDM3LCBpbnB1dCwgInRlc3QuYnVnMzY4MTkiKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGVuY29kZWRbMF0uZGVjb2RlKCksICJhYmNkeCIgKiA1MSkKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChlbmNvZGVkWzFdLCBsZW4oaW5wdXQpKQoKICAgIGRlZiB0ZXN0X3RyYW5zbGF0ZWhlbHBlcihzZWxmKToKICAgICAgICAjIGVuaGFuY2UgY292ZXJhZ2Ugb2Y6CiAgICAgICAgIyBPYmplY3RzL3VuaWNvZGVvYmplY3QuYzo6dW5pY29kZV9lbmNvZGVfY2FsbF9lcnJvcmhhbmRsZXIoKQogICAgICAgICMgYW5kIGNhbGxlcnMKICAgICAgICAjIChVbmZvcnR1bmF0ZWx5IHRoZSBlcnJvcnMgYXJndW1lbnQgaXMgbm90IGRpcmVjdGx5IGFjY2Vzc2libGUKICAgICAgICAjIGZyb20gUHl0aG9uLCBzbyB3ZSBjYW4ndCB0ZXN0IHRoYXQgbXVjaCkKICAgICAgICBjbGFzcyBEKGRpY3QpOgogICAgICAgICAgICBkZWYgX19nZXRpdGVtX18oc2VsZiwga2V5KToKICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IKICAgICAgICAjc2VsZi5hc3NlcnRSYWlzZXMoVmFsdWVFcnJvciwgIlx4ZmYiLnRyYW5zbGF0ZSwgRCgpKQogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFZhbHVlRXJyb3IsICJceGZmIi50cmFuc2xhdGUsIHsweGZmOiBzeXMubWF4dW5pY29kZSsxfSkKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhUeXBlRXJyb3IsICJceGZmIi50cmFuc2xhdGUsIHsweGZmOiAoKX0pCgogICAgZGVmIHRlc3RfYnVnODI4NzM3KHNlbGYpOgogICAgICAgIGNoYXJtYXAgPSB7CiAgICAgICAgICAgIG9yZCgiJiIpOiAiJmFtcDsiLAogICAgICAgICAgICBvcmQoIjwiKTogIiZsdDsiLAogICAgICAgICAgICBvcmQoIj4iKTogIiZndDsiLAogICAgICAgICAgICBvcmQoJyInKTogIiZxdW90OyIsCiAgICAgICAgfQoKICAgICAgICBmb3IgbiBpbiAoMSwgMTAsIDEwMCwgMTAwMCk6CiAgICAgICAgICAgIHRleHQgPSAnYWJjPGRlZj5naGknKm4KICAgICAgICAgICAgdGV4dC50cmFuc2xhdGUoY2hhcm1hcCkKCiAgICBkZWYgdGVzdF9tdXRhdGluZ19kZWNvZGVfaGFuZGxlcihzZWxmKToKICAgICAgICBiYWRkYXRhID0gWwogICAgICAgICAgICAoImFzY2lpIiwgYiJceGZmIiksCiAgICAgICAgICAgICgidXRmLTciLCBiIisrIiksCiAgICAgICAgICAgICgidXRmLTgiLCAgYiJceGZmIiksCiAgICAgICAgICAgICgidXRmLTE2IiwgYiJceGZmIiksCiAgICAgICAgICAgICgidXRmLTMyIiwgYiJceGZmIiksCiAgICAgICAgICAgICgidW5pY29kZS1lc2NhcGUiLCBiIlxcdTEyM2ciKSwKICAgICAgICAgICAgKCJyYXctdW5pY29kZS1lc2NhcGUiLCBiIlxcdTEyM2ciKSwKICAgICAgICBdCgogICAgICAgIGRlZiByZXBsYWNpbmcoZXhjKToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShleGMsIFVuaWNvZGVEZWNvZGVFcmFyeV9kaXJzLmFwcGVuZChwY2J1aWxkKQogICAgICAgICAgICBwcmludChmIkFkZCBQQ2J1aWxkIGRpcmVjdG9yeToge3BjYnVpbGR9IikKCiAgICAjIERpc3BsYXkgaW5mb3JtYXRpb24gdG8gaGVscCBkZWJ1Z2dpbmcKICAgIGZvciBlbnZfbmFtZSBpbiAoJ0NDJywgJ0NGTEFHUycsICdDUFBGTEFHUycpOgogICAgICAgIGlmIGVudl9uYW1lIGluIG9zLmVudmlyb246CiAgICAgICAgICAgIHByaW50KGYie2Vudl9uYW1lfSBlbnYgdmFyOiB7b3MuZW52aXJvbltlbnZfbmFtZV0hcn0iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50KGYie2Vudl9uYW1lfSBlbnYgdmFyOiA8bWlzc2luZz4iKQogICAgcHJpbnQoZiJleHRyYV9jb21waWxlX2FyZ3M6IHtjcHBmbGFncyFyfSIpCgogICAgZXh0ID0gRXh0ZW5zaW9uKAogICAgICAgIG1vZHVsZV9uYW1lLAogICAgICAgIHNvdXJjZXM9W1NPVVJDRV0sCiAgICAgICAgbGFuZ3VhZ2U9J2MrKycsCiAgICAgICAgZXh0cmFfY29tcGlsZV9hcmdzPWNwcGZsYWdzLAogICAgICAgIGluY2x1ZGVfZGlycz1pbmNsdWRlX2RpcnMsCiAgICAgICAgbGlicmFyeV9kaXJzPWxpYnJhcnlfZGlycykKICAgIHNldHVwKG5hbWU9ZidpbnRlcm5hbF97bW9kdWxlX25hbWV9JywKICAgICAgICAgIHZlcnNpb249JzAuMCcsCiAgICAgICAgICBleHRfbW9kdWxlcz1bZXh0XSkKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgbWFpbigpCmltcG9ydCB3YXJuaW5ncwpmcm9tIGlvIGltcG9ydCBTdHJpbmdJTwoKZnJvbSBkamFuZ28udGVtcGxhdGUuYmFzZSBpbXBvcnQgTGV4ZXIsIFRva2VuVHlwZQpmcm9tIGRqYW5nby51dGlscy5yZWdleF9oZWxwZXIgaW1wb3J0IF9sYXp5X3JlX2NvbXBpbGUKCmZyb20gLiBpbXBvcnQgVHJhbnNsYXRvckNvbW1lbnRXYXJuaW5nLCB0cmltX3doaXRlc3BhY2UKClRSQU5TTEFUT1JfQ09NTUVOVF9NQVJLID0gIlRyYW5zbGF0b3JzIgoKZG90X3JlID0gX2xhenlfcmVfY29tcGlsZShyIlxTIikKCgpkZWYgYmxhbmtvdXQoc3JjLCBjaGFyKToKICAgICIiIgogICAgQ2hhbmdlIGV2ZXJ5IG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlciB0byB0aGUgZ2l2ZW4gY2hhci4KICAgIFVzZWQgaW4gdGhlIHRlbXBsYXRpemUgZnVuY3Rpb24uCiAgICAiIiIKICAgIHJldHVybiBkb3RfcmUuc3ViKGNoYXIsIHNyYykKCgpjb250ZXh0X3JlID0gX2xhenlfcmVfY29tcGlsZShyIiIiXlxzKy4qY29udGV4dFxzKygoPzoiW14iXSo/Iil8KD86J1teJ10qPycpKVxzKiIiIikKaW5saW5lX3JlID0gX2xhenlfcmVfY29tcGlsZSgKICAgICMgTWF0Y2ggdGhlIHRyYW5zL3RyYW5zbGF0ZSAnc29tZSB0ZXh0JyBwYXJ0LgogICAgciIiIl5ccyp0cmFucyg/OmxhdGUpP1xzKygoPzoiW14iXSo/Iil8KD86J1teJ10qPycpKSIiIgogICAgIyBNYXRjaCBhbmQgaWdub3JlIG9wdGlvbmFsIGZpbHRlcnMKICAgIHIiIiIoPzpccypcfFxzKlteXHM6XSsoPzo6KD86W15ccyciOl0rfCg/OiJbInRhc2sgJXMgZW50ZXJpbmcgJXMiICUgKGlkZW50LCBpKSkKICAgICAgICAgICAgc2VsZi5iYXIuZW50ZXIoKQogICAgICAgICAgICB2ZXJib3NlX3ByaW50KCJ0YXNrICVzIGxlYXZpbmcgYmFycmllciIgJSBpZGVudCkKICAgICAgICB3aXRoIHNlbGYucnVubmluZ19tdXRleDoKICAgICAgICAgICAgc2VsZi5ydW5uaW5nIC09IDEKICAgICAgICAgICAgIyBNdXN0IHJlbGVhc2UgbXV0ZXggYmVmb3JlIHJlbGVhc2luZyBkb25lLCBlbHNlIHRoZSBtYWluIHRocmVhZCBjYW4KICAgICAgICAgICAgIyBleGl0IGFuZCBzZXQgbXV0ZXggdG8gTm9uZSBhcyBwYXJ0IG9mIGdsb2JhbCB0ZWFyZG93bjsgdGhlbgogICAgICAgICAgICAjIG11dGV4LnJlbGVhc2UoKSByYWlzZXMgQXR0cmlidXRlRXJyb3IuCiAgICAgICAgICAgIGZpbmlzaGVkID0gc2VsZi5ydW5uaW5nID09IDAKICAgICAgICBpZiBmaW5pc2hlZDoKICAgICAgICAgICAgc2VsZi5kb25lX211dGV4LnJlbGVhc2UoKQoKY2xhc3MgTG9ja1Rlc3RzKGxvY2tfdGVzdHMuTG9ja1Rlc3RzKToKICAgIGxvY2t0eXBlID0gdGhyZWFkLmFsbG9jYXRlX2xvY2sKCgpjbGFzcyBUZXN0Rm9ya0luVGhyZWFkKHVuaXR0ZXN0LlRlc3RDYXNlKToKICAgIGRlZiBzZXRVcChzZWxmKToKICAgICAgICBzZWxmLnJlYWRfZmQsIHNlbGYud3JpdGVfZmQgPSBvcy5waXBlKCkKCiAgICBAc3VwcG9ydC5yZXF1aXJlc19mb3JrKCkKICAgIEB0aHJlYWRpbmdfaGVscGVyLnJlYXBfdGhyZWFkcwogICAgZGVmIHRlc3RfZm9ya2ludGhyZWFkKHNlbGYpOgogICAgICAgIHBpZCA9IE5vbmUKCiAgICAgICAgZGVmIGZvcmtfdGhyZWFkKHJlYWRfZmQsIHdyaXRlX2ZkKToKICAgICAgICAgICAgbm9ubG9jYWwgcGlkCgogICAgICAgICAgICAjIElnbm9yZSB0aGUgd2FybmluZyBhYm91dCBmb3JrIHdpdGggdGhyZWFkcy4KICAgICAgICAgICAgd2l0aCB3YXJuaW5ncy5jYXRjaF93YXJuaW5ncyhjYXRlZ29yeT1EZXByZWNhdGlvbldhcm5pbmcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uPSJpZ25vcmUiKToKICAgICAgICAgICAgICAgICMgZm9yayBpbiBhIHRocmVhZCAoREFOR0VSLCB1bmRlZmluZWQgcGVyIFBPU0lYKQogICAgICAgICAgICAgICAgaWYgKHBpZCA6PSBvcy5mb3JrKCkpOgogICAgICAgICAgICAgICAgICAgICMgcGFyZW50IHByb2Nlc3MKICAgICAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgICMgY2hpbGQgcHJvY2VzcwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5jbG9zZShyZWFkX2ZkKQogICAgICAgICAgICAgICAgb3Mud3JpdGUod3JpdGVfZmQsIGIiT0siKQogICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgb3MuX2V4aXQoMCkKCiAgICAgICAgd2l0aCB0aHJlYWRpbmdfaGVscGVyLndhaXRfdGhyZWFkc19leGl0KCk6CiAgICAgICAgICAgIHRocmVhZC5zdGFydF9uZXdfdGhyZWFkKGZvcmtfb2RlbF9faWV4YWN0PSJzdGF0ZSIpLmxhdGVzdCgKICAgICAgICAgICAgImlkIgogICAgICAgICkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKAogICAgICAgICAgICBsb2dlbnRyeS5nZXRfY2hhbmdlX21lc3NhZ2UoKSwKICAgICAgICAgICAgIkNoYW5nZWQgU3RhdGUgbmFtZSAoZnJvbSBmb3Jt4oCZcyBNZXRhLmxhYmVscyksICIKICAgICAgICAgICAgIm5vbGFiZWxfZm9ybV9maWVsZCBhbmQgbm90X2FfZm9ybV9maWVsZC4gIgogICAgICAgICAgICAiQ2hhbmdlZCBDaXR5IHZlcmJvc2VfbmFtZSBmb3IgY2l0eSDigJwlc+KAnS4iICUgY2l0eSwKICAgICAgICApCgoKQG92ZXJyaWRlX3NldHRpbmdzKFJPT1RfVVJMQ09ORj0iYWRtaW5fdmlld3MudXJscyIpCmNsYXNzIFNlbGVuaXVtVGVzdHMoQWRtaW5TZWxlbml1bVRlc3RDYXNlKToKICAgIGF2YWlsYWJsZV9hcHBzID0gWyJhZG1pbl92aWV3cyJdICsgQWRtaW5TZWxlbml1bVRlc3RDYXNlLmF2YWlsYWJsZV9hcHBzCgogICAgZGVmIHNldFVwKHNlbGYpOgogICAgICAgIHNlbGYuc3VwZXJ1c2VyID0gVXNlci5vYmplY3RzLmNyZWF0ZV9zdXBlcnVzZXIoCiAgICAgICAgICAgIHVzZXJuYW1lPSJzdXBlciIsCiAgICAgICAgICAgIHBhc3N3b3JkPSJzZWNyZXQiLAogICAgICAgICAgICBlbWFpbD0ic3VwZXJAZXhhbXBsZS5jb20iLAogICAgICAgICkKICAgICAgICBmb3IgaSBpbiByYW5nZSgxLCAxMTAxKToKICAgICAgICAgICAgTG9nRW50cnkub2JqZWN0cy5sb2dfYWN0aW9ucygKICAgICAgICAgICAgICAgIHNlbGYuc3VwZXJ1c2VyLnBrLAogICAgICAgICAgICAgICAgW3NlbGYuc3VwZXJ1c2VyXSwKICAgICAgICAgICAgICAgIENIQU5HRSwKICAgICAgICAgICAgICAgIGNoYW5nZV9tZXNzYWdlPWYiQ2hhbmdlZCBzb21ldGhpbmcge2l9IiwKICAgICAgICAgICAgKQogICAgICAgIHNlbGYuYWRtaW5fbG9naW4oCiAgICAgICAgICAgIHVzZXJuYW1lPSJzdXBlciIsCiAgICAgICAgICAgIHBhc3N3b3JkPSJzZWNyZXQiLAogICAgICAgICAgICBsb2dpbl91cmw9cmV2ZXJzZSgiYWRtaW46aW5kZXgiKSwKICAgICAgICApCgogICAgZGVmIHRlc3RfcGFnaW5hdGlvbihzZWxmKToKICAgICAgICBmcm9tIHNlbGVuaXVtLndlYmRyaXZlci5jb21tb24uYnkgaW1wb3J0IEJ5CgogICAgICAgIHVzZXJfaGlzdG9yeV91cmwgPSByZXZlcnNlKCJhZG1pbjphdXRoX3VzZXJfaGlzdG9yeSIsIGFyZ3M9KHNlbGYuc3VwZXJ1c2VyLnBrLCkpCiAgICAgICAgc2VsZi5zZWxlbml1bS5nZXQoc2VsZi5saXZlX3NlcnZlcl91cmwgKyB1c2VyX2hpc3RvcnlfdXJsKQoKICAgICAgICBwYWdpbmF0b3IgPSBzZWxmLnNlbGVuaXVtLmZpbmRfZWxlbWVudChCeS5DU1NfU0VMRUNUT1IsICIucGFnaW5hdG9yIikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHBhZ2luYXRvci50YWdfbmFtZSwgIm5hdiIpCiAgICAgICAgbGFiZWxsZWRieSA9IHBhZ2luYXRvci5nZXRfYXR0cmlidXRlKCJhcmlhLWxhYmVsYWRfZGF0YVs1NTVdLm9uX2NwdSwgMSkKCiAgICBkZWYgdGVzdF9kaXNwbGF5X3VzZXNfcGVyX3RocmVhZF9zdGF0c19pbl9wZXJfdGhyZWFkX21vZGUoc2VsZik6CiAgICAgICAgIiIiVGVzdCB0aGF0IGRpc3BsYXkgd2lkZ2V0IHVzZXMgcGVyLXRocmVhZCBzdGF0cyB3aGVuIGluIFBFUl9USFJFQUQgbW9kZS4iIiIKCiAgICAgICAgIyBDcmVhdGUgY29sbGVjdG9yIHdpdGggbW9jayBkaXNwbGF5CiAgICAgICAgY29sbGVjdG9yID0gTGl2ZVN0YXRzQ29sbGVjdG9yKDEwMDAsIGRpc3BsYXk9TW9ja0Rpc3BsYXkoKSkKICAgICAgICBjb2xsZWN0b3Iuc3RhcnRfdGltZSA9IHRpbWUucGVyZl9jb3VudGVyKCkKCiAgICAgICAgIyBDcmVhdGUgMiB0aHJlYWRzIHdpdGggZGlmZmVyZW50IGNoYXJhY3RlcmlzdGljcwogICAgICAgICMgVGhyZWFkIDExMTogYWx3YXlzIGhhcyBHSUwgKDEwIHNhbXBsZXMpCiAgICAgICAgIyBUaHJlYWQgMjIyOiBuZXZlciBoYXMgR0lMICgxMCBzYW1wbGVzKQogICAgICAgIGZvciBfIGluIHJhbmdlKDEwKToKICAgICAgICAgICAgZnJhbWVzMSA9IFtNb2NrRnJhbWVJbmZvKCJmaWxlMS5weSIsIDEwLCAiZnVuYzEiKV0KICAgICAgICAgICAgZnJhbWVzMiA9IFtNb2NrRnJhbWVJbmZvKCJmaWxlMi5weSIsIDIwLCAiZnVuYzIiKV0KICAgICAgICAgICAgdGhyZWFkMSA9IE1vY2tUaHJlYWRJbmZvKAogICAgICAgICAgICAgICAgMTExLCBmcmFtZXMxLCBzdGF0dXM9VEhSRUFEX1NUQVRVU19IQVNfR0lMCiAgICAgICAgICAgICkKICAgICAgICAgICAgdGhyZWFkMiA9IE1vY2tUaHJlYWRJbmZvKDIyMiwgZnJhbWVzMiwgc3RhdHVzPTApICAjIE5vIGZsYWdzCiAgICAgICAgICAgIGludGVycHJldGVyX2luZm8gPSBNb2NrSW50ZXJwcmV0ZXJJbmZvKDAsIFt0aHJlYWQxLCB0aHJlYWQyXSkKICAgICAgICAgICAgY29sbGVjdG9yLmNvbGxlY3QoW2ludGVycHJldGVyX2luZm9dKQoKICAgICAgICAjIEluIEFMTCBtb2RlLCBzaG91bGQgc2hvdyBtaXhlZCBzdGF0cyAoNTAlIG9uIEdJTCwgNTAlIG9mZiBHSUwpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjb2xsZWN0b3Iudmlld19tb2RlLCAiQUxMIikKICAgICAgICB0b3RhbF9oYXNfZ2lsID0gY29sbGVjdG9yLnRocmVhZF9zdGF0dXNfY291bnRzWyJoYXNfZ2lsIl0KICAgICAgICB0b3RhbF90aHJlYWRzID0gY29sbGVjdG9yLnRocmVhZF9zdGF0dXNfY291bnRzWyJ0b3RhbCJdCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCh0b3RhbF9oYXNfZ2lsLCAxMCkgICMgT25seSB0aHJlYWQgMTExIGhhcyBHSUwKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHRvdGFsX3RocmVhZHMsIDIwKSAgIyAxMCBzYW1wbGVzICogMiB0aHJlYWRzCgogICAgICAgICMgU3dpdGNoIHRvIFBFUl9USFJFQUQgbW9kZSBhbmQgc2VsZWN0IHRocmVhZCAxMTEKICAgICAgICBjb2xsZWN0b3Iudmlld19tb2RlID0gIlBFUl9USFJFQUQiCiAgICAgICAgY29sbGVjdG9yLmN1cnJlbnRfdGhyZSBpbiBrd2FyZ3MuaXRlbXMoKToKICAgICAgICAgICAgYXJncy5hcHBlbmQoZid7bmFtZX09e3ZhbHVlIXJ9JykKICAgICAgICByZXR1cm4gZid7dHlwZShzZWxmKS5fX25hbWVfX30oeyIsICIuam9pbihhcmdzKX0pJwoKICAgIGRlZiBfX2NhbGxfXyhzZWxmLCBwYXJzZXIsICosIF9ub29wPShsYW1iZGEgYTogTm9uZSkpOgogICAgICAgIHNlbGYuYXBwbHkocGFyc2VyKQogICAgICAgIHJldHVybiBfbm9vcAoKICAgIGRlZiBhcHBseShzZWxmLCBwYXJzZXIpOgogICAgICAgIGFyZ3MsIGt3YXJncyA9IHNlbGYKICAgICAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCphcmdzLCAqKmt3YXJncykKCgpkZWYgYXBwbHlfY2xpX2FyZ3NwZWNzKHBhcnNlciwgc3BlY3MpOgogICAgcHJvY2Vzc29ycyA9IFtdCiAgICBmb3Igc3BlYyBpbiBzcGVjczoKICAgICAgICBpZiBjYWxsYWJsZShzcGVjKToKICAgICAgICAgICAgcHJvY3MgPSBzcGVjKHBhcnNlcikKICAgICAgICAgICAgX2FkZF9wcm9jcyhwcm9jZXNzb3JzLCBwcm9jcykKICAgICAgICBlbHNlOgogICAgICAgICAgICBhcmdzLCBrd2FyZ3MgPSBzcGVjCiAgICAgICAgICAgIHBhcnNlci5hZGRfYXJndW1lbnQoYXJncywga3dhcmdzKQogICAgcmV0dXJuIHByb2Nlc3NvcnMKCgpkZWYgX2FkZF9wcm9jcyhmbGF0dGVuZWQsIHByb2NzKToKICAgICMgWFhYIEZhaWwgb24gbm9uLWVtcHR5LCBub24tY2FsbGFibGUgcHJvY3M/CiAgICBpZiBub3QgcHJvY3M6CiAgICAgICAgcmV0dXJuCiAgICBpZiBjYWxsYWJsZShwcm9jcyk6CiAgICAgICAgZmxhdHRlbmVkLmFwcGVuZChwcm9jcykKICAgIGVsc2U6CiAgICAgICAgI3Byb2Nlc3NvcnMuZXh0ZW5kKHAgZm9yIHAgaW4gcHJvY3MgaWYgY2FsbGFibGUocCkpCiAgICAgICAgZm9yIHByb2MgaW4gcHJvY3M6CiAgICAgICAgICAgIF9hZGRfcHJvY3MoZmxhdHRlbmVkLCBwcm9jKQoKCmRlZiBhZGRfdmVyYm9zaXR5X2NsaShwYXJzZXIpOgogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLXEnLCAnLS1xdWlldCcsIGFjdGlvbj0nY291bnQnLCBkZWZhdWx0PTApCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctdicsICctLXZlcmJvc2UnLCBhY3Rpb249J2NvdW50JywgZGVmYXVsdD0wKQoKICAgIGRlZiBwcm9jZXNzX2FyZ3MoYXJncywgKiwgYXJndj1Ob25lKToKICAgICAgICBucyA9IHZhcnMoYXJncykKICAgICAgICBrZXkgPSAndmVyYm9zaXR5JwogICAgICAgIGlmIGtleSBpbiBuczoKICAgICAgICAgICAgcGFyc2VyLmVycm9yKGYnZHVwbGljYXRlIGFyZyB7a2V5IXJ9JykKICAgICAgICBuc1trZXldID0gbWF4KDAsIFZFUkJPU0lUWSArIG5zLnBvcCgndmVyYm9zZScpIC0gbnMucG9wKCdxdWlldCcpKQogICAgICAgIHJldHVybiBrZXkKICAgIHJldHVybiBwcm9jZXNzX2FyZ3MKCgpkZWYgYWRkX3RyYWNlYmFja19jbGkocGFyc2VyKToKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoJy0tdHJhY2ViYWNrJywgJy0tdGInLCBhY3Rpb249J3N0b3JlIG9mIEkgYW5kIFEsIHdoaWNoIGNvdmVycyBhIHNsaWdodGx5IGxhcmdlciByYW5nZSkuCklucHV0cyBvdXRzaWRlIHRoZSB2YWxpZCByYW5nZSBtYXkgY2F1c2UgZXhjZXB0aW9ucyBvciBpbnZhbGlkIG91dHB1dHMuCgpTdXBwb3J0ZWQgY29sb3Igc3lzdGVtczoKUkdCOiBSZWQsIEdyZWVuLCBCbHVlIGNvbXBvbmVudHMKWUlROiBMdW1pbmFuY2UsIENocm9taW5hbmNlICh1c2VkIGJ5IGNvbXBvc2l0ZSB2aWRlbyBzaWduYWxzKQpITFM6IEh1ZSwgTHVtaW5hbmNlLCBTYXR1cmF0aW9uCkhTVjogSHVlLCBTYXR1cmF0aW9uLCBWYWx1ZQoiIiIKCiMgUmVmZXJlbmNlczoKIyBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1lJUQojIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSExTX2NvbG9yX3NwYWNlCiMgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9IU1ZfY29sb3Jfc3BhY2UKCl9fYWxsX18gPSBbInJnYl90b195aXEiLCJ5aXFfdG9fcmdiIiwicmdiX3RvX2hscyIsImhsc190b19yZ2IiLAogICAgICAgICAgICJyZ2JfdG9faHN2IiwiaHN2X3RvX3JnYiJdCgojIFNvbWUgZmxvYXRpbmctcG9pbnQgY29uc3RhbnRzCgpPTkVfVEhJUkQgPSAxLjAvMy4wCk9ORV9TSVhUSCA9IDEuMC82LjAKVFdPX1RISVJEID0gMi4wLzMuMAoKIyBZSVE6IHVzZWQgYnkgY29tcG9zaXRlIHZpZGVvIHNpZ25hbHMgKGxpbmVhciBjb21iaW5hdGlvbnMgb2YgUkdCKQojIFk6IHBlcmNlaXZlZCBncmV5IGxldmVsICgwLjAgPT0gYmxhY2ssIDEuMCA9PSB3aGl0ZSkKIyBJLCBROiBjb2xvciBjb21wb25lbnRzCiMKIyBUaGVyZSBhcmUgYSBncmVhdCBtYW55IHZlcnNpb25zIG9mIHRoZSBjb25zdGFudHMgdXNlZCBpbiB0aGVzZSBmb3JtdWxhZS4KIyBUaGUgb25lcyBpbiB0aGlzIGxpYnJhcnkgdXNlcyBjb25zdGFudHMgZnJvbSB0aGUgRkNDIHZlcnNpb24gb2YgTlRTQy4KCmRlZiByZ2JfdG9feWlxKHIsIGcsIGIpOgogICAgeSA9IDAuMzAqciArIDAuNTkqZyArIDAuMTEqYgogICAgaSA9IDAuNzQqKHIteSkgLSAwLjI3KihiLXkpCiAgICBxID0gMC40OCooci15KSArIDAuNDEqKGIteSkKICAgIHJldHVybiAoeSwgaSwgcSkKCmRlZiB5aXFfdG9fcmdiKHksIGksIHEpOgogICAgIyByID0geSArICgwLjI3KnEgKyAwLjQxKmkpIC8gKDAuNzQqMC40MSArIDAuMjcqMC40OCkKICAgICMgYiA9IHkgKyAoMC43NCpxIC0gMC40OCppKSAvICgwLjc0KjAuNDEgKyAwLjI3KjAuNDgpCiAgICAjIGcgPSB5IC0gKDAuMzAqKHIteSkgKyAwLjExKihiLXkpKSAvIDAuNTkKCiAgICByID0geSArIDAuOTQ2ODgyMjE3MDkwMDY5MyppICsgMC42MjM1NTY1ODE5ODYxNDMzKnEKICAgIGcgPSB5IC0gMC4yNzQ3ODc2NDYyOTg5NzgzNCppIC0gMC42MzU2OTEwNzkxODczODAxKnEKICAgIGIgPSB5IC0gMS4xMDg1NDUwMzQ2NDIwMzIyKmkgKyAxLjcwOTAwNjkyODQwNjQ2NjYqcQoKICAgIGlmIHIgPCAwLjA6CiAgICAgICAgciA9IDAuMAogICAgaWYgZyA8dGUoJ1xVMDAwMTIzNDUnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocy5nZXR2YWx1ZSgpLCBiJzEyM1x4ZjBceDkyXHg4ZFx4ODUnKQogICAgICAgIGMud3JpdGUoJ1x1YWMwMFx1MDBhYycpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzLmdldHZhbHVlKCksCiAgICAgICAgICAgIGInMTIzXHhmMFx4OTJceDhkXHg4NScKICAgICAgICAgICAgYidceGVhXHhiMFx4ODBceGMyXHhhYycpCgogICAgZGVmIHRlc3Rfc3RyZWFtd3JpdGVyX3N0cndyaXRlKHNlbGYpOgogICAgICAgIHMgPSBpby5CeXRlc0lPKCkKICAgICAgICB3ciA9IGNvZGVjcy5nZXR3cml0ZXIoJ2diMTgwMzAnKShzKQogICAgICAgIHdyLndyaXRlKCdhYmNkJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHMuZ2V0dmFsdWUoKSwgYidhYmNkJykKCmNsYXNzIFRlc3RfSVNPMjAyMih1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICBkZWYgdGVzdF9nMihzZWxmKToKICAgICAgICBpc28yMDIyanAyID0gYidceDFiKEI6aHU0OnVuaXRceDFiLkFceDFiTmkgZGUgZmFtaWxsZScKICAgICAgICB1bmkgPSAnOmh1NDp1bml0XHhlOSBkZSBmYW1pbGxlJwogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoaXNvMjAyMmpwMi5kZWNvZGUoJ2lzbzIwMjItanAtMicpLCB1bmkpCgogICAgZGVmIHRlc3RfaXNvMjAyMl9qcF9nMChzZWxmKToKICAgICAgICBzZWxmLmFzc2VydE5vdEluKGInXHgwZScsICdcTntTT0ZUIEhZUEhFTn0nLmVuY29kZSgnaXNvLTIwMjItanAtMicpKQogICAgICAgIGZvciBlbmNvZGluZyBpbiAoJ2lzby0yMDIyLWpwLTIwMDQnLCAnaXNvLTIwMjItanAtMycpOgogICAgICAgICAgICBlID0gJ1x1MzQwNicuZW5jb2RlKGVuY29kaW5nKQogICAgICAgICAgICBzZWxmLmFzc2VydEZhbHNlKGFueSh4ID4gMHg4MCBmb3IgeCBpbiBlKSkKCiAgICBAc3VwcG9ydC5yZXF1aXJlc19yZXNvdXJjZSgnY3B1JykKICAgIGRlZiB0ZXN0X2J1ZzE1NzI4MzIoc2VsZik6CiAgICAgICAgZm9yIHggaW4gcmFuZ2UoMHgxMDAwMCwgMHgxMTAwMDApOgogICAgICAgICAgICAjIEFueSBJU08gMjAyMiBjb2RlYyB3aWxsIGNhdXNlIHRoZSBzZWdmYXVsdAogICAgICAgICAgICBjaHIoeCkuZW5jb2RlKCdpc29fMjAyMl9qcCcsICdpZ25vcmUnKQoKY2xhc3MgVGVzdFN0YXRlZnVsKHVuaXR0ZXN0LlRlc3RDYXNlKToKICAgIHRleHQgPSAnXHU0RTE2XHU0RTE2JwogICAgZW5jb2RpbmcgPSAnaXNvLTIwMjItanAnCiAgICBleHBlY3RlZCA9IGInXHgxYiRCQCRAJCcKICAgIHJlc2V0ID0gYidceDFiKEInCiAgICBleHBlY3RlZF9yZXNldCA9IGV4cGVjdGVkICsgcmVzZXQKCiAgICBkZWYgdGVzdF9lbmNvZGUoc2VsZik6CiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzZWxmLnRleHQuZW5jb2RlKHNlbGYuZW5jb2RpbmcpLCBzZWxmLmV4cGVjdGVkX3Jlc2V0KQoKICAgIGRlZiB0ZXN0X2luY3JlbWVudGFsZW5jb2RlcihzZWxmKToKICAgICAgICBlbmNvZGVyID0gY29kZWNzLmdldGludWUpLCBvcy5wYXRoLnJlYWxwYXRoKHN5cy5leGVjdXRhYmxlKSkKCiAgICBAbmVlZHNfaW5zdGFsbGVkX3B5dGhvbgogICAgQHVuaXR0ZXN0LnNraXBJZigKICAgICAgICBpc19hbmRyb2lkIG9yIGlzX2FwcGxlX21vYmlsZSwKICAgICAgICAiQW5kcm9pZCBhbmQgaU9TIHJ1biB0ZXN0cyB2aWEgYSBjdXN0b20gdGVzdGJlZCBtZXRob2QgdGhhdCBkb2Vzbid0IHNoaXAgaGVhZGVycyIKICAgICkKICAgIGRlZiB0ZXN0X2NfYXBpKHNlbGYpOgogICAgICAgIHZhbHVlID0gc2VsZi5rZXkoJ2NfYXBpJykKCiAgICAgICAgIyBTa2lwIGNoZWNrIGlmIGluc3RhbGxhdGlvbiBpcyByZWxvY2F0ZWQKICAgICAgICBpZiBzeXNjb25maWcuX2luc3RhbGxhdGlvbl9pc19yZWxvY2F0ZWQoKToKICAgICAgICAgICAgc2VsZi5za2lwVGVzdCgiSW5zdGFsbGF0aW9uIGlzIHJlbG9jYXRlZCIpCgogICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4odmFsdWVbJ2hlYWRlcnMnXSwgJ1B5dGhvbi5oJykpKQogICAgICAgIHZlcnNpb24gPSBzeXNjb25maWcuZ2V0X2NvbmZpZ192YXIoJ1ZFUlNJT04nKQogICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4odmFsdWVbJ3BrZ2NvbmZpZ19wYXRoJ10sIGYncHl0aG9uLXt2ZXJzaW9ufS5wYycpKSkKCgpAdW5pdHRlc3Quc2tpcElmKAogICAgZ2VuZXJhdGVfYnVpbGRfZGV0YWlscyBpcyBOb25lLAogICAgIkZhaWxlZCB0byBpbXBvcnQgZ2VuZXJhdGUtYnVpbGQtZGV0YWlscyIKKQpAdW5pdHRlc3Quc2tpcElmKG9zLm5hbWUgIT0gJ3Bvc2l4JywgJ0ZlYXR1cmUgb25seSBpbXBsZW1lbnRlZCBvbiBQT1NJWCByaWdodCBub3cnKQpAdW5pdHRlc3Quc2tpcElmKGlzX3dhc20zMiwgJ0ZlYXR1cmUgbm90IGF2YWlsYWJsZSBvbiBXZWJBc3NlbWJseSBidWlsZHMnKQpjbGFzcyBCdWlsZERldGFpbHNSZWxhdGl2ZVBhdGhzVGVzdHModW5pdHRlc3QuVGVzdENhc2UpOgogICAgQHByb3BlcnR5CiAgICBkZWYgYnVpbGRfZGV0YWlsc19hYnNvbHV0ZV9wYXRocyhzZWxmKToKICAgICAgICBkYXRhID0gZ2VuZXJhdGVfYnVpbGRfZGV0YWlscy5nZW5lcmF0ZV9kYXRhKHNjaGVtYV92ZXJzaW9uPScxLjAnKQogICAgICAgIHJldHVybiBqc29uLmxvYWRzKGpzb24uZHVtcHMoZGF0YSkpCgogICAgQHByb3BlcnR5CiAgICBkZWYgYnVpbGRfZGV0YWlsc19yZWxhdGl2ZV9wYXRocyhzZWxmKToKICAgICAgICBkYXRhID0gc2VsZi5idWlsZF9kZXRhaWxzX2Fic29sdXRlX3BhdGhzCiAgICAgICAgZ2VuZXJhdGVfYnVpbGRfZGV0YWlscy5tYWtlX3BhdGhzX3JlbGF0aXZlKGRhdGEsIGNvbmZpZ19wYXRoPU5vbmUpCiAgICAgICAgcmV0dXJuIGRhdGEKCiAgICBkZWYgdGVzdF9yb3VuZF90cmlwKHNlbGYpOgogICAgICAgIGRhdGFfYWJzX3BhdGggPSBzZWxmLmJ1aWxkX2RldGFpbHNfYWJzb2x1dGVfcGF0aHMKICAgICAgICBkYXRhX3JlbF9wYSJhIjogVHJ1ZX0sICd7ImEiOiAxfScpLCBUcnVlKQogICAgICAgIHNlbGYuYXNzZXJ0SXMoZmllbGQuaGFzX2NoYW5nZWQoeyJhIjogMSwgImIiOiAyfSwgJ3siYiI6IDIsICJhIjogMX0nKSwgRmFsc2UpCgogICAgZGVmIHRlc3RfY3VzdG9tX2VuY29kZXJfZGVjb2RlcihzZWxmKToKICAgICAgICBjbGFzcyBDdXN0b21EZWNvZGVyKGpzb24uSlNPTkRlY29kZXIpOgogICAgICAgICAgICBkZWYgX19pbml0X18oc2VsZiwgb2JqZWN0X2hvb2s9Tm9uZSwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICAgICAgICAgIHJldHVybiBzdXBlcigpLl9faW5pdF9fKG9iamVjdF9ob29rPXNlbGYuYXNfdXVpZCwgKmFyZ3MsICoqa3dhcmdzKQoKICAgICAgICAgICAgZGVmIGFzX3V1aWQoc2VsZiwgZGN0KToKICAgICAgICAgICAgICAgIGlmICJ1dWlkIiBpbiBkY3Q6CiAgICAgICAgICAgICAgICAgICAgZGN0WyJ1dWlkIl0gPSB1dWlkLlVVSUQoZGN0WyJ1dWlkIl0pCiAgICAgICAgICAgICAgICByZXR1cm4gZGN0CgogICAgICAgIHZhbHVlID0geyJ1dWlkIjogdXVpZC5VVUlEKCJ7YzE0MWUxNTItNjU1MC00MTcyLWE3ODQtMDU0NDhkOTgyMDRifSIpfQogICAgICAgIGVuY29kZWRfdmFsdWUgPSAneyJ1dWlkIjogImMxNDFlMTUyLTY1NTAtNDE3Mi1hNzg0LTA1NDQ4ZDk4MjA0YiJ9JwogICAgICAgIGZpZWxkID0gSlNPTkZpZWxkKGVuY29kZXI9RGphbmdvSlNPTkVuY29kZXIsIGRlY29kZXI9Q3VzdG9tRGVjb2RlcikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGZpZWxkLnByZXBhcmVfdmFsdWUodmFsdWUpLCBlbmNvZGVkX3ZhbHVlKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZmllbGQuY2xlYW4oZW5jb2RlZF92YWx1ZSksIHZhbHVlKQoKICAgIGRlZiB0ZXN0X2Zvcm1maWVsZF9kaXNhYmxlZChzZWxmKToKICAgICAgICBjbGFzcyBKU09ORm9ybShGb3JtKToKICAgICAgICAgICAganNvbl9maWVsZCA9IEpTT05GaWVsZChkaXNhYmxlZD1UcnVlKQoKICAgICAgICBmb3JtID0gSlNPTkZvcm0oeyJqc29uX2ZpZWxkIjogJ1siYmFyIl0nfSwgaW5pdGlhbD17Impzb25fZmllbGQiOiBbImZvbyJdfSkKICAgICAgICBzZWxmLmFzc2VydEluKCJbJnF1b3Q7Zm9vJnF1b3Q7XTwvdGV4dGFyZWE+IiwgZm9ybS5hc19wKCkpCgogICAgZGVmIHRlc3RfcmVkaXNwbGF5X25vbmVfaW5wdXQoc2VsZik6CiAgICAgICAgY2xhc3MgSlNPTkZvcm0oRm9ybSk6CiAgICAgICAgICAgIGpzb25fZmllbGQgPSBKU09ORmllbGQocmVxdWlyZWQ9VHJ1ZSkKCiAgICAgICAgdGVzdHMgPSBbCiAgICAgICAgICAgIHt9LAogICAgICAgICAgICB7Impzb25fZmllbGQiOiBOb25lfSwKICAgICAgICBdCiAgICAgICAgZm9yIGRhdGEgaW4gdGVzdHM6CiAgICAgICAgICAgIHdpdGggc2VsZi5zdWJUZXN0KGRhdGE9ZGF0YSk6CiAgICAgICAgICAgICAgICBmb3JtID0gSlNPTkZvcm0oZGF0YSkKICAgICAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZm9ybVsianNvbm9ydCBhZGRlZCAoYmFzZWQgb24gdGhlIExldmVsIDIgc3BlY2lmaWNhdGlvbikgYW5kIG90aGVyCiAgICAgICAgICAgbWlub3IgTGV2ZWwgMiBmdW5jdGlvbmFsaXR5LgoKcHVsbGRvbSAtLSBET00gYnVpbGRlciBzdXBwb3J0aW5nIG9uLWRlbWFuZCB0cmVlLWJ1aWxkaW5nIGZvciBzZWxlY3RlZAogICAgICAgICAgIHN1YnRyZWVzIG9mIHRoZSBkb2N1bWVudC4KCiIiIgoKCmNsYXNzIE5vZGU6CiAgICAiIiJDbGFzcyBnaXZpbmcgdGhlIE5vZGVUeXBlIGNvbnN0YW50cy4iIiIKICAgIF9fc2xvdHNfXyA9ICgpCgogICAgIyBET00gaW1wbGVtZW50YXRpb25zIG1heSB1c2UgdGhpcyBhcyBhIGJhc2UgY2xhc3MgZm9yIHRoZWlyIG93bgogICAgIyBOb2RlIGltcGxlbWVudGF0aW9ucy4gIElmIHRoZXkgZG9uJ3QsIHRoZSBjb25zdGFudHMgZGVmaW5lZCBoZXJlCiAgICAjIHNob3VsZCBzdGlsbCBiZSB1c2VkIGFzIHRoZSBjYW5vbmljYWwgZGVmaW5pdGlvbnMgYXMgdGhleSBtYXRjaAogICAgIyB0aGUgdmFsdWVzIGdpdmVuIGluIHRoZSBXM0MgcmVjb21tZW5kYXRpb24uICBDbGllbnQgY29kZSBjYW4KICAgICMgc2FmZWx5IHJlZmVyIHRvIHRoZXNlIHZhbHVlcyBpbiBhbGwgdGVzdHMgb2YgTm9kZS5ub2RlVHlwZQogICAgIyB2YWx1ZXMuCgogICAgRUxFTUVOVF9OT0RFICAgICAgICAgICAgICAgID0gMQogICAgQVRUUklCVVRFX05PREUgICAgICAgICAgICAgID0gMgogICAgVEVYVF9OT0RFICAgICAgICAgICAgICAgICAgID0gMwogICAgQ0RBVEFfU0VDVElPTl9OT0RFICAgICAgICAgID0gNAogICAgRU5USVRZX1JFRkVSRU5DRV9OT0RFICAgICAgID0gNQogICAgRU5USVRZX05PREUgICAgICAgICAgICAgICAgID0gNgogICAgUFJPQ0VTU0lOR19JTlNUUlVDVElPTl9OT0RFID0gNwogICAgQ09NTUVOVF9OT0RFICAgICAgICAgICAgICAgID0gOAogICAgRE9DVU1FTlRfTk9ERSAgICAgICAgICAgICAgID0gOQogICAgRE9DVU1FTlRfVFlQRV9OT0RFICAgICAgICAgID0gMTAKICAgIERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgICAgICA9IDExCiAgICBOT1RBVElPTl9OT0RFICAgICAgICAgICAgICAgPSAxMgoKCiNFeGNlcHRpb25Db2RlCklOREVYX1NJWkVfRVJSICAgICAgICAgICAgICAgICA9IDEKRE9NU1RSSU5HX1NJWkVfRVJSICAgICAgICAgICAgID0gMgpISUVSQVJDSFlfUkVRVUVTVF9FUlIgICAgICAgICAgPSAzCldST05HX0RPQ1VNRU5UX0VSUiAgICAgICAgICAgICA9IDQKSU5WQUxJRF9DSEFSQUNURVJfRVJSICAgICAgICAgID0gNQpOT19EQVRBX0FMTE9XRURfRVJSICAgICAgICAgICAgPSA2Ck5PX01PRElGSUNBVElPTl9BTExPV0VEX0VSUiAgICA9IDcKTk9UX0ZPVU5EX0VSUiAgICAgICAgICAgICAgICAgID0gOApOT1RfU1VQUE9SVEVEX0VSUiAgICAgICAgICAgICAgPSA5CklOVVNFX0FUVFJJQlVURV9FUlIgICAgICAgICAgICA9IDEwCklOVkFMSURfU1RBVEVfRVJSICAgICAgICAgICAgICA9IDExClNZTlRBcmlnaW4sIGFuZCBza2V3IGhhdmUgeCBhbmQgeSB2YWx1ZXMuIFBvc3RHSVMgY3VycmVudGx5IHVzZXMKIyBhIGZpeGVkIGVuZGlhbm5lc3MgKDEpIGFuZCB0aGVyZSBpcyBvbmx5IG9uZSB2ZXJzaW9uICgwKS4KUE9TVEdJU19IRUFERVJfU1RSVUNUVVJFID0gIkIgSCBIIGQgZCBkIGQgZCBkIGkgSCBIIgoKIyBMb29rdXAgdmFsdWVzIHRvIGNvbnZlcnQgR0RBTCBwaXhlbCB0eXBlcyB0byBzdHJ1Y3QgY2hhcmFjdGVycy4gVGhpcyBpcwojIHVzZWQgdG8gcGFjayBhbmQgdW5wYWNrIHRoZSBwaXhlbCB2YWx1ZXMgb2YgUG9zdEdJUyByYXN0ZXIgYmFuZHMuCkdEQUxfVE9fU1RSVUNUID0gWwogICAgTm9uZSwKICAgICJCIiwKICAgICJIIiwKICAgICJoIiwKICAgICJMIiwKICAgICJsIiwKICAgICJmIiwKICAgICJkIiwKICAgIE5vbmUsCiAgICBOb25lLAogICAgTm9uZSwKICAgIE5vbmUsCl0KCiMgU2l6ZSBvZiB0aGUgcGFja2VkIHZhbHVlIGluIGJ5dGVzIGZvciBkaWZmZXJlbnQgbnVtZXJpY2FsIHR5cGVzLgojIFRoaXMgaXMgbmVlZGVkIHRvIGN1dCBjaHVua3Mgb2YgYmFuZCBkYXRhIG91dCBvZiBQb3N0R0lTIHJhc3RlciBzdHJpbmdzCiMgd2hlbiBkZWNvbXBvc2luZyB0aGVtIGludG8gR0RBTFJhc3RlcnMuCiMgU2VlIGh0dHBzOi8vZG9jcy5weXRob24ub3JnL2xpYnJhcnkvc3RydWN0Lmh0bWwjZm9ybWF0LWNoYXJhY3RlcnMKU1RSVUNUX1NJWkUgPSB7CiAgICAiYiI6IDEsICAjIFNpZ25lZCBjaGFyCiAgICAiQiI6IDEsICAjIFVuc2lnbmVkIGNoYXIKICAgICI/IjogMSwgICMgX0Jvb2wKICAgICJoIjogMiwgICMgU2hvcnQKICAgICJIIjogMiwgICMgVW5zaWduZWQgc2hvcnQKICAgICJpIjogNCwgICMgSW50ZWdlcgogICAgIkkiOiA0LCAgIyBVbnNpZ25lZCBJbnRlZ2VyCiAgICAibCI6IDQsICAjIExvbmcKICAgICJMIjogNCwgICMgVW5zaWduZWQgTG9uZwogICAgImYiOiA0LCAgIyBGbG9hdAogICAgImQiOiA4LCAgIyBEb3VibGUKfQoKIyBQaXhlbCB0eXBlIHNwZWNpZmllcyB0eXBlIG9mIHBpeGVsIHZhbHVlcyBpbiBhIGJhbmQuIFN0b3JhZ2UgZmxhZyBzcGVjaWZpZXMKIyB3aGV0aGVyIHRoZSBiYW5kIGRhdGEgaXMgc3RvcmVkIGFzIHBhcnQgb2YgdGhlIGRhdHVtIG9yIGlzIHRvIGJlIGZvdW5kIG9uIHRoZQojIHNlcnZlcidzIGZpbGVzeXN0ZW0uIFRoZXJlIGFyZSBjdXJyZW50bHkgMTEgc3VwcG9ydGVkIHBpeGVsIHZhbHVlIHR5cGVzLCBzbyA0CiMgYml0cyBhcmUgZW5vdWdoIHRvIGFjY291bnQgZm9yIGFsbC4gUmVzZXJ2ZSB0aGUgdXBwZXIgNCBiaXRzIGZvciBnZW5lcmljCiMgZmxhZ3MuIFNlZQojIGh0dHBzOi8vdHJhYy5vc2dlby5vcmcvcG9zdGdpcy93aWtpL1dLVFJhc3Rlci9SRkMvUkZDMV9WMFNlcmlhbEZvcm1hdCNQaXhlbHR5cGVhbmRzdG9yYWdlZmxhZwpCQU5EVFlQRV9QSVhUWVBFX01BU0sgPSAweDBGCkJBTkRUWVBFX0ZMQUdfSEFTTk9EQVRBID0gMSA8PCA2CmltcG9ydCBnYwpmcm9tZGVmIF9oZWxwX3N0dWZmX2ZpbmlzaChpbnF1ZXVlLCB0YXNrX2hhbmRsZXIsIHNpemUpOgogICAgICAgICMgZHJhaW4gaW5xdWV1ZSwgYW5kIHB1dCBzZW50aW5lbHMgYXQgaXRzIGhlYWQgdG8gbWFrZSB3b3JrZXJzIGZpbmlzaAogICAgICAgIHRyeToKICAgICAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgICAgIGlucXVldWUuZ2V0KGJsb2NrPUZhbHNlKQogICAgICAgIGV4Y2VwdCBxdWV1ZS5FbXB0eToKICAgICAgICAgICAgcGFzcwogICAgICAgIGZvciBpIGluIHJhbmdlKHNpemUpOgogICAgICAgICAgICBpbnF1ZXVlLnB1dChOb25lKQoKICAgIGRlZiBfd2FpdF9mb3JfdXBkYXRlcyhzZWxmLCBzZW50aW5lbHMsIGNoYW5nZV9ub3RpZmllciwgdGltZW91dCk6CiAgICAgICAgdGltZS5zbGVlcCh0aW1lb3V0KQppbXBvcnQgZGVjaW1hbAppbXBvcnQganNvbgppbXBvcnQgcmUKCmZyb20gZGphbmdvLmNvcmUgaW1wb3J0IHNlcmlhbGl6ZXJzCmZyb20gZGphbmdvLmNvcmUuc2VyaWFsaXplcnMuYmFzZSBpbXBvcnQgRGVzZXJpYWxpemF0aW9uRXJyb3IKZnJvbSBkamFuZ28uZGIgaW1wb3J0IG1vZGVscwpmcm9tIGRqYW5nby50ZXN0IGltcG9ydCBUZXN0Q2FzZSwgVHJhbnNhY3Rpb25UZXN0Q2FzZQpmcm9tIGRqYW5nby50ZXN0LnV0aWxzIGltcG9ydCBpc29sYXRlX2FwcHMKCmZyb20gLm1vZGVscyBpbXBvcnQgU2NvcmUKZnJvbSAudGVzdHMgaW1wb3J0IFNlcmlhbGl6ZXJzVGVzdEJhc2UsIFNlcmlhbGl6ZXJzVHJhbnNhY3Rpb25UZXN0QmFzZQoKCmNsYXNzIEpzb25sU2VyaWFsaXplclRlc3RDYXNlKFNlcmlhbGl6ZXJzVGVzdEJhc2UsIFRlc3RDYXNlKToKICAgIHNlcmlhbGl6ZXJfbmFtZSA9ICJqc29ubCIKICAgIHBrbGVzc19zdHIgPSBbCiAgICAgICAgJ3sicGsiOiBudWxsLCJtb2RlbCI6ICJzZXJpYWxpemVycy5jYXRlZ29yeSIsImZpZWxkcyI6IHsibmFtZSI6ICJSZWZlcmVuY2UifX0nLAogICAgICAgICd7Im1vZGVsIjogInNlcmlhbGl6ZXJzLmNhdGVnb3J5IiwiZmllbGRzIjogeyJuYW1lIjogIk5vbi1maWN0aW9uIn19JywKICAgIF0KICAgIHBrbGVzc19zdHIgPSAiXG4iLmpvaW4oW3MucmVwbGFjZSgiXG4iLCAiIikgZm9yIHMgaW4gcGtsZXNzX3N0cl0pCgogICAgbWFwcGluZ19vcmRlcmluZ19zdHIgPSAoCiAgICAgICAgJ3sibW9kZWwiOiAic2VyaWFsaXplcnMuYXJ0aWNsZSIsInBrIjogJShhcnRpY2xlX3BrKXMsJwogICAgICAgICciZmllbGRzIjogeycKICAgICAgICAnImF1dGhvciI6ICUoYXV0aG9yX3BrKXMsJwogICAgICAgICciaGVhZGxpbmUiOiAiUG9rZXIgaGFzIG5vIHBsYWNlIG9uIEVTUE4iLCcKICAgICAgICAnInB1Yl9kYXRlIjogIjIwMDYtMDYtMTZUMTE6MDA6MDAiLCcKICAgICAgICAnImNhdGVnb3JpZXMiOiBbJShmaXJzdF9jYXRlZ29yeV9waylzLCUoc2Vjb25kX2NhdGVnb3J5X3BrKXNdLCcKICAgICAgICAnIm1ldGFfZGF0YSI6IFtdLCcKICAgICAgICAnInRvcGljcyI6LnJlc3VsdCArPSBzZWxmLmJ1ZmZlcgogICAgICAgIHNlbGYuYnVmZmVyID0gJycKCiAgICBkZWYgZ2V0dmFsdWUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYucmVzdWx0CiIiIkEgcGFyc2VyIGZvciBIVE1MIGFuZCBYSFRNTC4iIiIKCiMgVGhpcyBmaWxlIGlzIGJhc2VkIG9uIHNnbWxsaWIucHksIGJ1dCB0aGUgQVBJIGlzIHNsaWdodGx5IGRpZmZlcmVudC4KCiMgWFhYIFRoZXJlIHNob3VsZCBiZSBhIHdheSB0byBkaXN0aW5ndWlzaCBiZXR3ZWVuIFBDREFUQSAocGFyc2VkCiMgY2hhcmFjdGVyIGRhdGEgLS0gdGhlIG5vcm1hbCBjYXNlKSwgUkNEQVRBIChyZXBsYWNlYWJsZSBjaGFyYWN0ZXIKIyBkYXRhIC0tIG9ubHkgY2hhciBhbmQgZW50aXR5IHJlZmVyZW5jZXMgYW5kIGVuZCB0YWdzIGFyZSBzcGVjaWFsKQojIGFuZCBDREFUQSAoY2hhcmFjdGVyIGRhdGEgLS0gb25seSBlbmQgdGFncyBhcmUgc3BlY2lhbCkuCgoKaW1wb3J0IHJlCmltcG9ydCBfbWFya3VwYmFzZQoKZnJvbSBodG1sIGltcG9ydCB1bmVzY2FwZQpmcm9tIGh0bWwuZW50aXRpZXMgaW1wb3J0IGh0bWw1IGFzIGh0bWw1X2VudGl0aWVzCgoKX19hbGxfXyA9IFsnSFRNTFBhcnNlciddCgojIFJlZ3VsYXIgZXhwcmVzc2lvbnMgdXNlZCBmb3IgcGFyc2luZwoKaW50ZXJlc3Rpbmdfbm9ybWFsID0gcmUuY29tcGlsZSgnWyY8XScpCmluY29tcGxldGUgPSByZS5jb21waWxlKCcmW2EtekEtWiNdJykKCmVudGl0eXJlZiA9IHJlLmNvbXBpbGUoJyYoW2EtekEtWl1bLS5hLXpBLVowLTldKilbXmEtekEtWjAtOV0nKQpjaGFycmVmID0gcmUuY29tcGlsZSgnJiMoPzpbMC05XSt8W3hYXVswLTlhLWZBLUZdKylbXjAtOWEtZkEtRl0nKQppbmNvbXBsZXRlX2NoYXJyZWYgPSByZS5jb21waWxlKCcmIyg/OlswLTldfFt4WF1bMC05YS1mQS1GXSknKQphdHRyX2NoYXJyZWYgPSByZS5jb21waWxlKHInJigjWzAtOV0rfCNbeFhdWzAtOWEtZkEtRl0rfFthLXpBLVpdW2EtekEtWjAtOV0qKVs7PV0/JykKCnN0YXJ0dGFnb3BlbiA9IHJlLmNvbXBpbGUoJzxbYS16QS1aXScpCmVuZHRhZ29wZW4gPSByZS5jb21waWxlKCc8L1thLXpBLVpdJykKcGljbG9zZSA9IHJlLmNvbXBpbGUoJz4nKQpjb21tZW50Y2xvc2UgPSByZS5jb21waWxlKHInLS0hPz4nKQpjb21tZW50YWJydXB0Y2xvc2UgPSByZS5jb21waWxlKHInLT8+JykKIyBOb3RlOgojICAxKSBpZiB5b3UgY2hhbmdlIHRhZ2ZpbmQvYXR0cmZpbmQgcmVtZW1iZXIgdG8gdXBkYXRlIGxvY2F0ZXRhZ2VuZCB0b287CiMgIDIpIGlmIHlvdSBjaGFuZ2UgdGFnZmluZC9hdHRyZmluZCBhbmQvb3IgbG9jYXRldGFnZW5kIHRoZSBwYXJzZXIgd2lsbAojICAgICBleHBsb2RlLCBzbyBkb24ndCBkbyBpdC4KIyBzZWUgdGhlIEhUTUw1IHNwZWNzIHNlY3Rpb24gIjEzLjIuNS42IFRhZyBvcGVuIHN0YXRlIiwKIyAiMTMuMi41LjggVGFnIG5hbWUgc3RhdGUiIGFuZCAiMTMuMi41LjMzIEF0dHJpYnV0ZSBuYW1lIHN0YXRlIi4KIyBoZyBvciBOb25lIGFsbCBpbnRlcmZhY2VzIGFyZSBhc3N1bWVkCiAgICAgICAgYW5kIGEgbGlzdCBvZiBtdWx0aXBsZSBzb2NrZXRzIHdpbGwgYmUgcmV0dXJuZWQgKG1vc3QgbGlrZWx5CiAgICAgICAgb25lIGZvciBJUHY0IGFuZCBhbm90aGVyIG9uZSBmb3IgSVB2NikuIFRoZSBob3N0IHBhcmFtZXRlciBjYW4gYWxzbyBiZQogICAgICAgIGEgc2VxdWVuY2UgKGUuZy4gbGlzdCkgb2YgaG9zdHMgdG8gYmluZCB0by4KCiAgICAgICAgZmFtaWx5IGNhbiBiZSBzZXQgdG8gZWl0aGVyIEFGX0lORVQgb3IgQUZfSU5FVDYgdG8gZm9yY2UgdGhlCiAgICAgICAgc29ja2V0IHRvIHVzZSBJUHY0IG9yIElQdjYuIElmIG5vdCBzZXQgaXQgd2lsbCBiZSBkZXRlcm1pbmVkCiAgICAgICAgZnJvbSBob3N0IChkZWZhdWx0cyB0byBBRl9VTlNQRUMpLgoKICAgICAgICBmbGFncyBpcyBhIGJpdG1hc2sgZm9yIGdldGFkZHJpbmZvKCkuCgogICAgICAgIHNvY2sgY2FuIG9wdGlvbmFsbHkgYmUgc3BlY2lmaWVkIGluIG9yZGVyIHRvIHVzZSBhIHByZWV4aXN0aW5nCiAgICAgICAgc29ja2V0IG9iamVjdC4KCiAgICAgICAgYmFja2xvZyBpcyB0aGUgbWF4aW11bSBudW1iZXIgb2YgcXVldWVkIGNvbm5lY3Rpb25zIHBhc3NlZCB0bwogICAgICAgIGxpc3RlbigpIChkZWZhdWx0cyB0byAxMDApLgoKICAgICAgICBzc2wgY2FuIGJlIHNldCB0byBhbiBTU0xDb250ZXh0IHRvIGVuYWJsZSBTU0wgb3ZlciB0aGUKICAgICAgICBhY2NlcHRlZCBjb25uZWN0aW9ucy4KCiAgICAgICAgcmV1c2VfYWRkcmVzcyB0ZWxscyB0aGUga2VybmVsIHRvIHJldXNlIGEgbG9jYWwgc29ja2V0IGluCiAgICAgICAgVElNRV9XQUlUIHN0YXRlLCB3aXRob3V0IHdhaXRpbmcgZm9yIGl0cyBuYXR1cmFsIHRpbWVvdXQgdG8KICAgICAgICBleHBpcmUuIElmIG5vdCBzcGVjaWZpZWQgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIHNldCB0byBUcnVlIG9uCiAgICAgICAgVU5JWC4KCiAgICAgICAgcmV1c2VfcG9ydCB0ZWxscyB0aGUga2VybmVsIHRvIGFsbG93IHRoaXMgZW5kcG9pbnQgdG8gYmUgYm91bmQgdG8KICAgICAgICB0aGUgc2FtZSBwb3J0IGFzIG90aGVyIGV4aXN0aW5nIGVuZHBvaW50cyBhcmUgYm91bmQgdG8sIHNvIGxvbmcgYXMKICAgICAgICB0aGV5IGFsbCBzZXQgdGhpcyBmbGFnIHdoZW4gYmVpbmcgY3JlYXRlZC4gVGhpcyBvcHRpb24gaXMgbm90CiAgICAgICAgc3VwcG9ydGVkIG9uIFdpbmRvd3MuCgogICAgICAgIGtlZXBfYWxpdmUgc2V0IHRvIFRydWUga2VlcHMgY29ubmVjdGlvbnMgYWN0aXZlIGJ5IGVuYWJsaW5nIHRoZQogICAgICAgIHBlcmlvZGljIHRyYW5zbWlzc2lvbiBvZiBtZXNzYWdlcy4KCiAgICAgICAgc3NsX2hhbmRzaGFrZV90aW1lb3V0IGlzIHRoZSB0aW1lIGluIHNlY29uZHMgdGhhdCBhbiBTU0wgc2VydmVyCiAgICAgICAgd2lsbCB3YWl0IGZvciBjb21wbGV0aW9uIG9mIHRoZSBTU0wgaGFuZHNoYWtlIGJlZm9yZSBhYm9yICBjeC5kZXNlcmlhbGl6ZShkYXRhKQogICAgICAgICAgICBjeC5leGVjdXRlKCJzZWxlY3QgdCBmcm9tIHQiKQoKICAgIGRlZiB0ZXN0X2Rlc2VyaWFsaXplX3dyb25nX2FyZ3Moc2VsZik6CiAgICAgICAgZGF0YXNldCA9ICgKICAgICAgICAgICAgKEJ1ZmZlckVycm9yLCBtZW1vcnl2aWV3KGIiYmxvYiIpWzo6Ml0pLAogICAgICAgICAgICAoVHlwZUVycm9yLCBbXSksCiAgICAgICAgICAgIChUeXBlRXJyb3IsIDEpLAogICAgICAgICAgICAoVHlwZUVycm9yLCBOb25lKSwKICAgICAgICApCiAgICAgICAgZm9yIGV4YywgYXJnIGluIGRhdGFzZXQ6CiAgICAgICAgICAgIHdpdGggc2VsZi5zdWJUZXN0KGV4Yz1leGMsIGFyZz1hcmcpOgogICAgICAgICAgICAgICAgd2l0aCBtZW1vcnlfZGF0YWJhc2UoKSBhcyBjeDoKICAgICAgICAgICAgICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhleGMsIGN4LmRlc2VyaWFsaXplLCBhcmcpCgogICAgZGVmIHRlc3RfZGVzZXJpYWxpemVfY29ycnVwdF9kYXRhYmFzZShzZWxmKToKICAgICAgICB3aXRoIG1lbW9yeV9kYXRhYmFzZSgpIGFzIGN4OgogICAgICAgICAgICByZWdleCA9ICJmaWxlIGlzIG5vdCBhIGRhdGFiYXNlIgogICAgICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzUmVnZXgoc3FsaXRlLkRhdGFiYXNlRXJyb3IsIHJlZ2V4KToKICAgICAgICAgICAgICAgIGN4LmRlc2VyaWFsaXplKGIiXDBcMVwzIikKICAgICAgICAgICAgICAgICMgU1FMaXRlIGRvZXMgbm90IGdlbmVyYXRlIGFuIGVycm9yIHVudGlsIHlvdSB0cnkgdG8gcXVlcnkgdGhlCiAgICAgICAgICAgICAgICAjIGRlc2VyaWFsaXplZCBkYXRhYmFzZS4KICAgICAgICAgICAgICAgIGN4LmV4ZWN1dGUoImNyZWF0ZSB0YWJsZSBmYWlsKGYpIikKCgpjbGFzcyBPcGVuVGVzdHModW5pdHRlc3QuVGVzdENhc2UpOgogICAgX3NxbCA9ICJjcmVhdGUgdGFibGUgdGVzdChpZCBpbnRlZ2VyKSIKCiAgICBkZWYgdGVzdF9vcGVuX3dpdGhfYnl0ZXNfcGF0aChzZWxmKToKICAgICAgICBwYXRoID0gb3MuZnNlbmNvZGUoVEVTVEZOKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cCh1bmxpbmssIHBhdGgpCiAgICAgICAgc2VsZi5hc3NlcnRGYWxzZShvcy5wYXRoLmV4aXN0cyhwYXRoKSkKICAgICAgICB3aXRoIGNvbnRleHRsaWIuY2xvc2luZyhzcWxpdGUuY29ubmVjdChwYXRoKSkgYXMgY3g6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShvcy5wYXRoLmV4aXN0cyhwYXRoKSkKICAgICAgICAgICAgY3guZXhlY3V0ZShzZWxmLl9zcWwpCgogICAgZGVmIHRlc3Rfb3Blbl93aXRoX3BhdGhfbGlrZV9vYmplY3Qoc2VsZik6CiAgICAgICAgIiIiIENoZWNrcyB0aGF0IHdlIGNhbiBzdWNjZXNzZnVsbHkgY29ubmVjdCB0byBhIGRhdGFiYXNlIHVzaW5nIGFuIG9iamVjdCB0aGF0CiAgICAgICAgICAgIGlzIFBhdGhMaWtlLCBpLmUuIGhhcyBfX2ZzcGF0aF9fKCkuICIiIgogICAgICAgIHBhdGggPSBGYWtlUGF0aChURVNUdXJuIGZpbGVkaWFsb2cuYXNrZGlyZWN0b3J5KCkKCiAgICBkZWYgc2V0dGluZ3NDbGlja2VkKHNlbGYpOgogICAgICAgIGQgPSBEaXNjb3ZlclNldHRpbmdzRGlhbG9nKHNlbGYudG9wLCBzZWxmLnRvcF9sZXZlbF9kaXIsIHNlbGYudGVzdF9maWxlX2dsb2JfcGF0dGVybikKICAgICAgICBzZWxmLnRvcF9sZXZlbF9kaXIgPSBkLnRvcF9sZXZlbF9kaXIKICAgICAgICBzZWxmLnRlc3RfZmlsZV9nbG9iX3BhdHRlcm4gPSBkLnRlc3RfZmlsZV9nbG9iX3BhdHRlcm4KCiAgICBkZWYgbm90aWZ5VGVzdHNEaXNjb3ZlcmVkKHNlbGYsIHRlc3Rfc3VpdGUpOgogICAgICAgIGRpc2NvdmVyZWQgPSB0ZXN0X3N1aXRlLmNvdW50VGVzdENhc2VzKCkKICAgICAgICBzZWxmLnJ1bkNvdW50VmFyLnNldCgwKQogICAgICAgIHNlbGYuZmFpbENvdW50VmFyLnNldCgwKQogICAgICAgIHNlbGYuZXJyb3JDb3VudFZhci5zZXQoMCkKICAgICAgICBzZWxmLnJlbWFpbmluZ0NvdW50VmFyLnNldChkaXNjb3ZlcmVkKQogICAgICAgIHNlbGYucHJvZ3Jlc3NCYXIuc2V0UHJvZ3Jlc3NGcmFjdGlvbigwLjApCiAgICAgICAgc2VsZi5lcnJvckxpc3Rib3guZGVsZXRlKDAsIHRrLkVORCkKICAgICAgICBzZWxmLnN0YXR1c1Zhci5zZXQoIkRpc2NvdmVyaW5nIHRlc3RzIGZyb20gJXMuIEZvdW5kOiAlcyIgJQogICAgICAgICAgICAoc2VsZi5kaXJlY3RvcnlfdG9fcmVhZCwgZGlzY292ZXJlZCkpCiAgICAgICAgc2VsZi5zdG9wR29CdXR0b25bJ3N0YXRlJ10gPSB0ay5OT1JNQUwKCiAgICBkZWYgY3JlYXRlV2lkZ2V0cyhzZWxmKToKICAgICAgICAiIiJDcmVhdGVzIGFuZCBwYWNrcyB0aGUgdmFyaW91cyB3aWRnZXRzLgoKICAgICAgICBXaHkgaXMgaXQgdGhhdCBHVUkgY29kZSBhbHdheXMgZW5kcyB1cCBsb29raW5nIGEgbWVzcywgZGVzcGl0ZSBhbGwgdGhlCiAgICAgICAgYmVzdCBpbnRlbnRpb25zIHRvIGtlZXAgaXQgdGlkeT8gQW5zd2VycyBvbiBhIHBvc3RjYXJkLCBwbGVhc2UuCiAgICAgICAgIiIiCiAgICAgICAgIyBTdGF0dXMgYmFyCiAgICAgICAgc3RhdHVzRnJhbWUgPSB0ay5GcmFtZShzZWxmLnRvcCwgcmVsaWVmPXRrLlNVTktFTiwgYm9yZGVyd2lkdGg9MikKICAgICAgICBzdGF0dXNGcmFtZS5wYWNrKGFuY2hvcj10ay5TVywgZmlsbD10ay5YLCBzaWRlPXRrLkJPVFRPTSkKICAgICAgICB0ay5MYWJlbChzdGF0dXNGcmFtZSwgd2lkdGg9MSwgdGV4dHZhcmlhYmxlPXNlbGYuc3RhdHVzVmFyKS5wYWNrKHNpZGU9dGsuVE9QLCBmaWxsPXRrLlgpCgogICAgICAgICMgQXJlYSB0byBlbnRlciBuYW1lIG9mIHRlc3QgdG8gcnVuCiAgICAgICAgbGVmdEZyYW1lID0gdGsuRnJhbWUoc2VsZi50b3AsIGJvcmRlcndpZHRoPTMpCiAgICAgICAgbGVmdEZyYW1lLnBhY2soZmlsbD10ay5CT1RILCBzaWRlPXRrLkxFRlQsIGFuY2hvcj10ay5OVywgZXhwYW5kPTEpCiAgICAgICAgc3VpdGVOYW1lRnJhbWUgPSB0ay5GcmFtZShsZWZ0RnJhbWUsIGJvcnJXaXRoTTJNLAogICAgQ3VzdG9tVXNlcldpdGhVbmlxdWVDb25zdHJhaW50LAogICAgRW1haWwsCiAgICBPcmdhbml6YXRpb24sCiAgICBVc2VyUHJveHksCikKCk1PQ0tfSU5QVVRfS0VZX1RPX1BST01QVFMgPSB7CiAgICAjIEBtb2NrX2lucHV0cyBkaWN0IGtleTogW2V4cGVjdGVkIHByb21wdCBtZXNzYWdlc10sCiAgICAiYnlwYXNzIjogWyJCeXBhc3MgcGFzc3dvcmQgdmFsaWRhdGlvbiBhbmQgY3JlYXRlIHVzZXIgYW55d2F5PyBbeS9OXTogIl0sCiAgICAiZW1haWwiOiBbIkVtYWlsIGFkZHJlc3M6ICJdLAogICAgImRhdGVfb2ZfYmlydGgiOiBbIkRhdGUgb2YgYmlydGg6ICJdLAogICAgImZpcnN0X25hbWUiOiBbIkZpcnN0IG5hbWU6ICJdLAogICAgInVzZXJuYW1lIjogWwogICAgICAgICJVc2VybmFtZTogIiwKICAgICAgICBsYW1iZGE6ICJVc2VybmFtZSAobGVhdmUgYmxhbmsgdG8gdXNlICclcycpOiAiICUgZ2V0X2RlZmF1bHRfdXNlcm5hbWUoKSwKICAgIF0sCn0KCgpkZWYgbW9ja19pbnB1dHMoaW5wdXRzKToKICAgICIiIgogICAgRGVjb3JhdG9yIHRvIHRlbXBvcmFyaWx5IHJlcGxhY2UgaW5wdXQvZ2V0cGFzcyB0byBhbGxvdyBpbnRlcmFjdGl2ZQogICAgY3JlYXRlc3VwZXJ1c2VyLgogICAgIiIiCgogICAgZGVmIGlubmVyKHRlc3RfZnVuYyk6CiAgICAgICAgZGVmIHdyYXBwZXIoKmFyZ3MpOgogICAgICAgICAgICBjbGFzcyBtb2NrX2dldHBhc3M6CiAgICAgICAgICAgICAgICBAc3RhdGljbWV0aG9kCiAgICAgICAgICAgICAgICBkZWYgZ2V0cGFzcyhwcm9tcHQ9YiJQYXNzd29yZDogIiwgc3RyZWFtPU5vbmUpOgogICAgICAgICAgICAgICAgICAgIGlmIGNhbGxhYmxlKGlucHV0c1sicGFzc3dvcmQiXSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnB1dHNbInBhc3N3b3JkIl0oKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnB1dHNbInBhc3N3b3JkIl0KCiAgICAgICAgICAgIGRlZiBtb2NrX2lucHV0KHByb21wdCk6CiAgICAgICAgICAgICAgICBhc3NlcnQgIl9fcHJveHlfXyIgbm90IGluIHByb21wdAogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBOb25lCiAgICAgICAgICAgICAgICBmb3Iga2V5LCB2YWwgaW4gaW5wdXRzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICAgICAgaWYgdmFsID09ICJLZXlib2FyZEludGVycnVwdCI6CiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIEtleWJvYXJkSW50ZXJydXB0CiAgICAgICAgICAgICAgICAgICAgIyBnZXQoKSBmYWxsYmFjayBiZWNhdXNlIHNvbWV0aW1lcyAna2V5JyBpcyB0aGUgYWN0dWFsCiAgICAgICAgICAgICAgICAgICAgIyBwcm9tcHQgcmF0aGVyIHRoYW4gYSBzaG9ydGN1dCBuYW1lLgogICAgICAgICAgICAgICAgICAgIHByb21wdF9tc2dzID0gTU9DS19JTlBVVF9LRVlfVE9fUFJPTVBUUy5nZXQoa2V5LCBrZXkpCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShwcm9tcHRfbXNncywgbGlzdCk6CmhpY2gKYXJlIG1vcmUgZWZmaWNpZW50IG92ZXJhbGwsIHlldCB0aGUgd29yc3QgY2FzZXMgbWlnaHQgYmUgdGVycmlibGUuCgpIZWFwcyBhcmUgYWxzbyB2ZXJ5IHVzZWZ1bCBpbiBiaWcgZGlzayBzb3J0cy4gIFlvdSBtb3N0IHByb2JhYmx5IGFsbAprbm93IHRoYXQgYSBiaWcgc29ydCBpbXBsaWVzIHByb2R1Y2luZyAicnVucyIgKHdoaWNoIGFyZSBwcmUtc29ydGVkCnNlcXVlbmNlcywgd2hvc2Ugc2l6ZSBpcyB1c3VhbGx5IHJlbGF0ZWQgdG8gdGhlIGFtb3VudCBvZiBDUFUgbWVtb3J5KSwKZm9sbG93ZWQgYnkgYSBtZXJnaW5nIHBhc3NlcyBmb3IgdGhlc2UgcnVucywgd2hpY2ggbWVyZ2luZyBpcyBvZnRlbgp2ZXJ5IGNsZXZlcmx5IG9yZ2FuaXNlZFsxXS4gIEl0IGlzIHZlcnkgaW1wb3J0YW50IHRoYXQgdGhlIGluaXRpYWwKc29ydCBwcm9kdWNlcyB0aGUgbG9uZ2VzdCBydW5zIHBvc3NpYmxlLiAgVG91cm5hbWVudHMgYXJlIGEgZ29vZCB3YXkKdG8gYWNoaWV2ZSB0aGF0LiAgSWYsIHVzaW5nIGFsbCB0aGUgbWVtb3J5IGF2YWlsYWJsZSB0byBob2xkIGEKdG91cm5hbWVudCwgeW91IHJlcGxhY2UgYW5kIHBlcmNvbGF0ZSBpdGVtcyB0aGF0IGhhcHBlbiB0byBmaXQgdGhlCmN1cnJlbnQgcnVuLCB5b3UnbGwgcHJvZHVjZSBydW5zIHdoaWNoIGFyZSB0d2ljZSB0aGUgc2l6ZSBvZiB0aGUKbWVtb3J5IGZvciByYW5kb20gaW5wdXQsIGFuZCBtdWNoIGJldHRlciBmb3IgaW5wdXQgZnV6emlseSBvcmRlcmVkLgoKTW9yZW92ZXIsIGlmIHlvdSBvdXRwdXQgdGhlIDAndGggaXRlbSBvbiBkaXNrIGFuZCBnZXQgYW4gaW5wdXQgd2hpY2gKbWF5IG5vdCBmaXQgaW4gdGhlIGN1cnJlbnQgdG91cm5hbWVudCAoYmVjYXVzZSB0aGUgdmFsdWUgIndpbnMiIG92ZXIKdGhlIGxhc3Qgb3V0cHV0IHZhbHVlKSwgaXQgY2Fubm90IGZpdCBpbiB0aGUgaGVhcCwgc28gdGhlIHNpemUgb2YgdGhlCmhlYXAgZGVjcmVhc2VzLiAgVGhlIGZyZWVkIG1lbW9yeSBjb3VsZCBiZSBjbGV2ZXJseSByZXVzZWQgaW1tZWRpYXRlbHkKZm9yIHByb2dyZXNzaXZlbHkgYnVpbGRpbmcgYSBzZWNvbmQgaGVhcCwgd2hpY2ggZ3Jvd3MgYXQgZXhhY3RseSB0aGUKc2FtZSByYXRlIHRoZSBmaXJzdCBoZWFwIGlzIG1lbHRpbmcuICBXaGVuIHRoZSBmaXJzdCBoZWFwIGNvbXBsZXRlbHkKdmFuaXNoZXMsIHlvdSBzd2l0Y2ggaGVhcHMgYW5kIHN0YXJ0IGEgbmV3IHJ1bi4gIENsZXZlciBhbmQgcXVpdGUKZWZmZWN0aXZlIQoKSW4gYSB3b3JkLCBoZWFwcyBhcmUgdXNlZnVsIG1lbW9yeSBzdHJ1Y3R1cmVzIHRvIGtub3cuICBJIHVzZSB0aGVtIGluCmEgZmV3IGFwcGxpY2F0aW9ucywgYW5kIEkgdGhpbmsgaXQgaXMgZ29vZCB0byBrZWVwIGEgJ2hlYXAnIG1vZHVsZQphcm91bmQuIDotKQoKLS0tLS0tLS0tLS0tLS0tLS0tLS0KWzFdIFRoZSBkaXNrIGJhbGFuY2luZyBhbGdvcml0aG1zIHdoaWNoIGFyZSBjdXJyZW50LCBub3dhZGF5cywgYXJlCm1vcmUgYW5ub3lpbkVBVEVfQkVUQSkKICAgICAgICBzZWxmLmN1LmV4ZWN1dGUoQ1JFQVRFX0FMUEhBKQogICAgICAgIGdvdCA9IGxpc3Qoc2VsZi5jeC5pdGVyZHVtcCgpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZXhwZWN0ZWQsIGdvdCkKCiAgICBkZWYgdGVzdF9kdW1wX2N1c3RvbV9yb3dfZmFjdG9yeShzZWxmKToKICAgICAgICAjIGdoLTExODIyMTogaXRlcmR1bXAgc2hvdWxkIGJlIGFibGUgdG8gY29wZSB3aXRoIGN1c3RvbSByb3cgZmFjdG9yaWVzLgogICAgICAgIGRlZiBkaWN0X2ZhY3RvcnkoY3UsIHJvdyk6CiAgICAgICAgICAgIGZpZWxkcyA9IFtjb2xbMF0gZm9yIGNvbCBpbiBjdS5kZXNjcmlwdGlvbl0KICAgICAgICAgICAgcmV0dXJuIGRpY3QoemlwKGZpZWxkcywgcm93KSkKCiAgICAgICAgc2VsZi5jeC5yb3dfZmFjdG9yeSA9IGRpY3RfZmFjdG9yeQogICAgICAgIENSRUFURV9UQUJMRSA9ICJDUkVBVEUgVEFCTEUgdGVzdCh0KTsiCiAgICAgICAgZXhwZWN0ZWQgPSBbIkJFR0lOIFRSQU5TQUNUSU9OOyIsIENSRUFURV9UQUJMRSwgIkNPTU1JVDsiXQoKICAgICAgICBzZWxmLmN1LmV4ZWN1dGUoQ1JFQVRFX1RBQkxFKQogICAgICAgIGFjdHVhbCA9IGxpc3Qoc2VsZi5jeC5pdGVyZHVtcCgpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZXhwZWN0ZWQsIGFjdHVhbCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHNlbGYuY3gucm93X2ZhY3RvcnksIGRpY3RfZmFjdG9yeSkKCiAgICBAcmVxdWlyZXNfdmlydHVhbF90YWJsZSgiZnRzNCIpCiAgICBkZWYgdGVzdF9kdW1wX3ZpcnR1YWxfdGFibGVzKHNlbGYpOgogICAgICAgICMgZ2gtNjQ2NjIKICAgICAgICBleHBlY3RlZCA9IFsKICAgICAgICAgICAgIkJFR0lOIFRSQU5TQUNUSU9OOyIsCiAgICAgICAgICAgICJQUkFHTUEgd3JpdGFibGVfc2NoZW1hPU9OOyIsCiAgICAgICAgICAgICgiSU5TRVJUIElOVE8gc3FsaXRlX21hc3Rlcih0eXBlLG5hbWUsdGJsX25hbWUscm9vdHBhZ2Usc3FsKSIKICAgICAgICAgICAgICJWQUxVRVMoJ3RhYmxlJywndGVzdCcsJ3Rlc3QnLDAsJ0NSRUFURSBWSVJUVUFMIFRBQkxFIHRlc3QgVVNJTkcgZnRzNChleGFtcGxlKScpOyIpLAogICAgICAgICAgICAiQ1JFQVRFIFRBQkxFICd0ZXN0X2NvbnRlbnQnKGRvY2lkIElOVEVHRVIgUFJJTUFSWSBLRVksICdjMGV4YW1wbGUnKTsiLAogICAgICAgICAgICAiQ1JFQVRFIFRBQkxFICd0ZXN0X2RvY3NpemUnKGRvY2lkIElOVEVHRVIgUFJJTUFSWSBLRVksIHNpemUgQkxPQik7IiwKICAgICAgICAgICAgKCJDUkVBVEUgVEFCTEUgJ3Rlc3Rfc2VnZGlyJyhsZXZlbCBJTlRFR0VSLGlkeCBJTlRFR0VSLHN0YXJ0X2Jsb2NrIElOVEVHRVIsIgogICAgICAgICAgICAgImxlYXZlc19lbmRfYmxvY2sgSU5URUdFUixlbmRfYmxvY2sgSU5URUdFUixyb290IEJMT0IsUFJJTUFSWSBLRVkobGV2ZWwsIGlkeCkpOyIpLAogICAgICAgICAgICAiQ1JFQVRFIFRBQkxFICd0ZXN0X3NlZ21lbnRzJyhibG9ja2lkIGc9MiwgdGhvdXNhbmRfc2VwPSIsIiksICIxMjM0IikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKAogICAgICAgICAgICBuZm9ybWF0KCIxMjM0IiwgIi4iLCBncm91cGluZz0yLCB0aG91c2FuZF9zZXA9IiwiLCBmb3JjZV9ncm91cGluZz1UcnVlKSwKICAgICAgICAgICAgIjEyLDM0IiwKICAgICAgICApCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChuZm9ybWF0KCItMTIzNC4zMyIsICIuIiwgZGVjaW1hbF9wb3M9MSksICItMTIzNC4zIikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKAogICAgICAgICAgICBuZm9ybWF0KAogICAgICAgICAgICAgICAgIjEwMDAwIiwgIi4iLCBncm91cGluZz0zLCB0aG91c2FuZF9zZXA9ImNvbW1hIiwgZm9yY2VfZ3JvdXBpbmc9VHJ1ZQogICAgICAgICAgICApLAogICAgICAgICAgICAiMTBjb21tYTAwMCIsCiAgICAgICAgKQoKICAgIGRlZiB0ZXN0X2xhcmdlX251bWJlcihzZWxmKToKICAgICAgICBtb3N0X21heCA9ICgKICAgICAgICAgICAgInt9MTc5NzY5MzEzNDg2MjMxNTcwODE0NTI3NDIzNzMxNzA0MzU2Nzk4MDcwNTY3NTI1ODQ0OTk2IgogICAgICAgICAgICAiNTk4OTE3NDc2ODAzMTU3MjYwNzgwMDI4NTM4NzYwNTg5NTU4NjMyNzY2ODc4MTcxNTQwNDU4OTUzIgogICAgICAgICAgICAiNTE0MzgyNDY0MjM0MzIxMzI2ODg5NDY0MTgyNzY4NDY3NTQ2NzAzNTM3NTE2OTg2MDQ5OTEwNTc2IgogICAgICAgICAgICAiNTUxMjgyMDc2MjQ1NDkwMDkwMzg5MzI4OTQ0MDc1ODY4NTA4NDU1MTMzOTQyMzA0NTgzMjM2OTAzIgogICAgICAgICAgICAiMjIyOTQ4MTY1ODA4NTU5MzMyMTIzMzQ4Mjc0Nzk3ODI2MjA0MTQ0NzIzMTY4NzM4MTc3MTgwOTE5IgogICAgICAgICAgICAiMjk5ODgxMjUwNDA0MDI2MTg0MTI0ODU4MzZ7fSIKICAgICAgICApCiAgICAgICAgbW9zdF9tYXgyID0gKAogICAgICAgICAgICAie30zNTk1Mzg2MjY5NzI0NjMxNDE2MjkwNTQ4NDc0NjM0MDg3MTM1OTYxNDExMzUwNTE2ODk5OSIKICAgICAgICAgICAgIjMxOTc4MzQ5NTM2MDYzMTQ1MjE1NjAwNTcwNzc1MjExNzkxMTcyNjU1MzM3NTYzNDMwODA5MTc5IgogICAgICAgICAgICAiMDcwMjg3NjQ5Mjg0Njg2NDI2NTM3Nzg5MjgzNjU1MzY5MzUwOTM0MDcwNzUwMzM5NzIwOTk4MjEiCiAgICAgICAgICAgICIxNTMxMDI1NjQxNTI0OTA5ODAxODA3Nzg2NTc4ODgxNTE3MzcwMTY5MTAyNjc4ODQ2MDkxNjY0NyIKICAgICAgICAgICAgIjM4MDY0NDU4OTYzMzE2MTcxMTg2NjQyNDY2OTY1NDk1OTU2NTI0MDgyODk0NDYzMzc0NzYzNTQzIgogICAgICAgICAgICAiNjE4Mzg1OTk3NjI1MDA4MDgwNTIzNjgyNDk3MTY3MzYiCiAgICAgICAgKQogICAgICAgIGludF9tYXggPSBpbnQoZmxvYXRfaW5mby5tYXgpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChuZm9ybWF0KGludF9tYXgsICIuIiksIG1vc3RfbWF4LmZvcm1hdCgiIiwgIjgiKSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKG5mb3JtYXQoaW50X21heCArIDEsICIuInBlbigpLiBJZiBub3QgYXZhaWxhYmxlLAogICAgYWxzbyBzZWFyY2ggZm9yIGEgZmlsZSAob3IgbGluaykgd2l0aCBhIC5zbyBzdWZmaXguCgogICAgQUlYIHN1cHBvcnRzIHR3byB0eXBlcyBvZiBzY2hlbWVzIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCBkbG9wZW4oKS4KICAgIFRoZSBzby1jYWxsZWQgU3lzdGVtViBSZWxlYXNlNCAoc3ZyNCkgZm9ybWF0IGlzIGNvbW1vbmx5IHN1ZmZpeGVkCiAgICB3aXRoIC5zbyB3aGlsZSB0aGUgKGRlZmF1bHQpIEFJWCBzY2hlbWUgaGFzIHRoZSBsaWJyYXJ5IChhcmNoaXZlKQogICAgZW5kaW5nIHdpdGggdGhlIHN1ZmZpeCAuYQogICAgQXMgYW4gYXJjaGl2ZSBoYXMgbXVsdGlwbGUgbWVtYmVycyAoZS5nLiwgMzItYml0IGFuZCA2NC1iaXQpIGluIG9uZSBmaWxlCiAgICB0aGUgYXJndW1lbnQgcGFzc2VkIHRvIGRsb3BlbiBtdXN0IGluY2x1ZGUgYm90aCB0aGUgbGlicmFyeSBhbmQKICAgIHRoZSBtZW1iZXIgbmFtZXMgaW4gYSBzaW5nbGUgc3RyaW5nLgoKICAgIGZpbmRfbGlicmFyeSgpIGxvb2tzIGZpcnN0IGZvciBhbiBhcmNoaXZlICguYSkgd2l0aCBhIHN1aXRhYmxlIG1lbWJlci4KICAgIElmIG5vIGFyY2hpdmUrbWVtYmVyIHBhaXIgaXMgZm91bmQsIGxvb2sgZm9yIGEgLnNvIGZpbGUuCiAgICAiIiIKCiAgICBsaWJwYXRocyA9IGdldF9saWJwYXRocygpCiAgICAoYmFzZSwgbWVtYmVyKSA9IGZpbmRfc2hhcmVkKGxpYnBhdGhzLCBuYW1lKQogICAgaWYgYmFzZSBpcyBub3QgTm9uZToKICAgICAgICByZXR1cm4gZiJ7YmFzZX0oe21lbWJlcn0pIgoKICAgICMgVG8gZ2V0IGhlcmUsIGEgbWVtYmVyIGluIGFuIGFyY2hpdmUgaGFzIG5vdCBiZWVuIGZvdW5kCiAgICAjIEluIG90aGVyIHdvcmRzLCBlaXRoZXI6CiAgICAjIGEpIGEgLmEgZmlsZSB3YXMgbm90IGZvdW5kCiAgICAjIGIpIGEgLmEgZmlsZSBkaWQgbm90IGhhdmUgYSBzdWl0YWJsZSBtZW1iZXIKICAgICMgU28sIGxvb2sgZm9yIGEgLnNvIGZpbGUKICAgICMgQ2hlY2sgbGlicGF0aHMgZm9yIC5zbyBmaWxlCiAgICAjIE5vdGUsIHRoZSBpbnN0YWxsYXRpb24gbXVzdCBwcmVwYXJlIGEgbGluayBmcm9tIGEgLnNvCiAgICAjIHRvIGEgdmVyc2lvbmVkIGZpbGUKICAgICMgVGhpcyBpcyBjb21tb24gcHJhY3RpY2UgYnkgR05VIGxpYnRvb2wgb24gb3RoZXIgcGxhdGZvcm1zCiAgICBzb25hbWUgPSBmImxpYntuYW1lfS5zbyIKICAgIGZvciBkaXIgaW4gbGlicGF0aHM6CiAgICAgICAgIyAvbGliIGlzIGEgc3ltYm9saWMgbGluayB0byAvdXNyL2xpYiwgc2tpcCBpdAogICAgICAgIGlmIGRpciA9PSAiL2xpYiI6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgc2hsaWIgPSBwYXRoLmpvaW4oZGlyLCBzb25hbWUpCiAgICAgICAgaWYgcGF0aC5leGlzdHMoc2hsaWIpOgogICAgICAgICAgICByZXR1cm4gc29uYW1lCiAgICAjIGlmIHdlIGFyZSBoZXJlLCB3ZSBoYXZlIG5vdCBmb3VuZCBhbnl0aGluZyBwbGF1c2libGUgICMgTGF6eSBpbXBvcnQgdG8gc3BlZWR1cCBQeXRob24gc3RhcnR1cCB0aW1lCiAgICAgICAgZ2xvYmFsIGhlYXBxCiAgICAgICAgaWYgaGVhcHEgaXMgTm9uZToKICAgICAgICAgICAgaW1wb3J0IGhlYXBxCgogICAgICAgIHJldHVybiBoZWFwcS5ubGFyZ2VzdChuLCBzZWxmLml0ZW1zKCksIGtleT1faXRlbWdldHRlcigxKSkKCiAgICBkZWYgZWxlbWVudHMoc2VsZik6CiAgICAgICAgJycnSXRlcmF0b3Igb3ZlciBlbGVtZW50cyByZXBlYXRpbmcgZWFjaCBhcyBtYW55IHRpbWVzIGFzIGl0cyBjb3VudC4KCiAgICAgICAgPj4+IGMgPSBDb3VudGVyKCdBQkNBQkMnKQogICAgICAgID4+PiBzb3J0ZWQoYy5lbGVtZW50cygpKQogICAgICAgIFsnQScsICdBJywgJ0InLCAnQicsICdDJywgJ0MnXQoKICAgICAgICBLbnV0aCdzIGV4YW1wbGUgZm9yIHByaW1lIGZhY3RvcnMgb2YgMTgzNjogIDIqKjIgKiAzKiozICogMTcqKjEKCiAgICAgICAgPj4+IGltcG9ydCBtYXRoCiAgICAgICAgPj4+IHByaW1lX2ZhY3RvcnMgPSBDb3VudGVyKHsyOiAyLCAzOiAzLCAxNzogMX0pCiAgICAgICAgPj4+IG1hdGgucHJvZChwcmltZV9mYWN0b3JzLmVsZW1lbnRzKCkpCiAgICAgICAgMTgzNgoKICAgICAgICBOb3RlLCBpZiBhbiBlbGVtZW50J3MgY291bnQgaGFzIGJlZW4gc2V0IHRvIHplcm8gb3IgaXMgYSBuZWdhdGl2ZQogICAgICAgIG51bWJlciwgZWxlbWVudHMoKSB3aWxsIGlnbm9yZSBpdC4KCiAgICAgICAgJycnCiAgICAgICAgIyBFbXVsYXRlIEJhZy5kbyBmcm9tIFNtYWxsdGFsayBhbmQgTXVsdGlzZXQuYmVnaW4gZnJvbSBDKysuCiAgICAgICAgcmV0dXJuIF9jaGFpbi5mcm9tX2l0ZXJhYmxlKF9zdGFybWFwKF9yZXBlYXQsIHNlbGYuaXRlbXMoKSkpCgogICAgIyBPdmVycmlkZSBkaWN0IG1ldGhvZHMgd2hlcmUgbmVjZXNzYXJ5CgogICAgQGNsYXNzbWV0aG9kCiAgICBkZWYgZnJvbWtleXMoY2xzLCBpdGVyYWJsZSwgdj1Ob25lKToKICAgICAgICAjIFRoZXJlIGlzIG5vIGVxdWl2YWxlbnQgbWV0aG9kIGZvciBjb3VudGVycyBiZWNhdXNlIHRoZSBzZW1hbnRpY3MKICAgICAgICAjIHdvdWxkIGJlIGFtYmlndW91cyBpbiBjYXNlcyBzdWNoIGFzIENvdW50ZXIuZnJvbWtleXMoJ2FhYWJiYycsIHY9MikuCiAgICAgICAgIyBJbml0aWFsaXppbmcgY291bnRlcnMgdG8gemVybyB2YWx1ZXMgaXNuJ3QgbmVjZXNzYXJ5IGJlY2F1c2UgemVybwogICAgICAgICMgaXMgYWxyZWFkeSB0aGUgZGVmYXVsdCB2YWx1ZSBmb3IgY291bnRlciBsb29rdXBzLiAgSW5pdGlhbGl6aW5nCiAgICAgICAgIyB0byBvbmUgaXMgZWFzaWx5IGFjY29tcGxpc2hlZCB3aXRoIENvdW50ZXIoc2V0KGl0ZXJhYmxlKSkuICBGb3IKICAgICAgICAjIG1vcmUgZXhvdGljIGNhc2VzLCBjcmVhdGUgYSBkaWN0aW9uYXJ5IGZpcnN0IHVzaW5nIGEgZGljdGlvbmFyeQogICAgICAgICMgY29tcHJlaGVuc2lvbiBvciBkaWN0LmZyb21rZXlzKCkuCiBzdF9ub3RfY2FsbGFibGVfc3BlY19hc19saXN0KHNlbGYpOgogICAgICAgIHNwZWMgPSAoJ2ZvbycsICdiYXInKQogICAgICAgIHAgPSBwYXRjaChNT0ROQU1FLCBzcGVjPXNwZWMpCiAgICAgICAgbSA9IHAuc3RhcnQoKQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5hc3NlcnRGYWxzZShjYWxsYWJsZShtKSkKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBwLnN0b3AoKQoKCiAgICBkZWYgdGVzdF9wYXRjaF9zdG9wYWxsKHNlbGYpOgogICAgICAgIHVubGluayA9IG9zLnVubGluawogICAgICAgIGNoZGlyID0gb3MuY2hkaXIKICAgICAgICBwYXRoID0gb3MucGF0aAogICAgICAgIHBhdGNoKCdvcy51bmxpbmsnLCBzb21ldGhpbmcpLnN0YXJ0KCkKICAgICAgICBwYXRjaCgnb3MuY2hkaXInLCBzb21ldGhpbmdfZWxzZSkuc3RhcnQoKQoKICAgICAgICBAcGF0Y2goJ29zLnBhdGgnKQogICAgICAgIGRlZiBwYXRjaGVkKG1vY2tfcGF0aCk6CiAgICAgICAgICAgIHBhdGNoLnN0b3BhbGwoKQogICAgICAgICAgICBzZWxmLmFzc2VydElzKG9zLnBhdGgsIG1vY2tfcGF0aCkKICAgICAgICAgICAgc2VsZi5hc3NlcnRJcyhvcy51bmxpbmssIHVubGluaykKICAgICAgICAgICAgc2VsZi5hc3NlcnRJcyhvcy5jaGRpciwgY2hkaXIpCgogICAgICAgIHBhdGNoZWQoKQogICAgICAgIHNlbGYuYXNzZXJ0SXMob3MucGF0aCwgcGF0aCkKCiAgICBkZWYgdGVzdF9zdG9wYWxsX2xpZm8oc2VsZik6CiAgICAgICAgc3RvcHBlZCA9IFtdCiAgICAgICAgY2xhc3MgdGhpbmcob2JqZWN0KToKICAgICAgICAgICAgb25lID0gdHdvID0gdGhyZWUgPSBOb25lCgogICAgICAgIGRlZiBnZXRfcGF0Y2goYXR0cmlidXRlKToKICAgICAgICAgICAgY2xhc3MgbXlwYXRjaChfcGF0Y2gpOgogICAgICAgICAgICAgICAgZGVmIHN0b3Aoc2VsZik6CiAgICAgICAgICAgICAgICAgICAgc3RvcHBlZC5hcHBlbmQoYXR0cmlidXRlKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBzdXBlcihteXBhdGNoLCBzZWxmKS5zdG9wKCkKICAgICAgICAgICAgcmV0dXJuIG15cGF0Y2gobGFtYmRhOiB0aGluZywgYXR0cmlidXRlLCBOb25lLCBOb25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICBGYWxzZSwgTm9uZSwgTm9uZSwgTm9uZSwge30pCiAgICAgICAgW2dldF9wYXRjaCh2YWwpLnN0YXJ0KCkgZm9yIHZhbCBpbiAoIm9uZSIsICJ0d28iLCAidGhyZWUiKV0KICAgICAgICBwYXRjaC5zdG9wYWxsKCkKCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzdG9wcGVkLCBbInRocmVlIiwgInR3byIsICJvbmUiXSkKCiAgICBkZWYgdGVzdF9wYXRjaF9kaWN0X3N0b3BhbGwoc2VsZik6CiAgICAgICAgZGljMSA9IHt9CiAgICAgICAgZGljMiA9IHsxOiAnYSd9CiAgICAgICAgZGljMyA9IHsxOiAnQScsIDI6ICdCJ30KICAgICAgICBvcmlnZGljMSA9IGRpYzEuY29weSgpCiAgICAgICAgb3JpZ2RpYzIgPSBkaWMyLmNvcHkoKQogICAgICAgIG9yaWdkaWMzIHJ1ZShvcy5wYXRoLmV4aXN0cyhhZGRyKSkKCiAgICBAc29ja2V0X2hlbHBlci5za2lwX3VubGVzc19iaW5kX3VuaXhfc29ja2V0CiAgICBhc3luYyBkZWYgdGVzdF91bml4X3NlcnZlcl9jbGVhbnVwX3ByZXZlbnRlZChzZWxmKToKICAgICAgICAjIEF1dG9tYXRpYyBjbGVhbnVwIGV4cGxpY2l0bHkgZGlzYWJsZWQKICAgICAgICB3aXRoIHRlc3RfdXRpbHMudW5peF9zb2NrZXRfcGF0aCgpIGFzIGFkZHI6CiAgICAgICAgICAgIGFzeW5jIGRlZiBzZXJ2ZSgqYXJncyk6CiAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICBzcnYgPSBhd2FpdCBhc3luY2lvLnN0YXJ0X3VuaXhfc2VydmVyKHNlcnZlLCBhZGRyLCBjbGVhbnVwX3NvY2tldD1GYWxzZSkKCiAgICAgICAgICAgIHNydi5jbG9zZSgpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShvcy5wYXRoLmV4aXN0cyhhZGRyKSkKCgpAdW5pdHRlc3Quc2tpcFVubGVzcyhoYXNhdHRyKGFzeW5jaW8sICdQcm9hY3RvckV2ZW50TG9vcCcpLCAnV2luZG93cyBvbmx5JykKY2xhc3MgUHJvYWN0b3JTdGFydFNlcnZlclRlc3RzKEJhc2VTdGFydFNlcnZlciwgdW5pdHRlc3QuVGVzdENhc2UpOgoKICAgIGRlZiBuZXdfbG9vcChzZWxmKToKICAgICAgICByZXR1cm4gYXN5bmNpby5Qcm9hY3RvckV2ZW50TG9vcCgpCgoKaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKICAgIHVuaXR0ZXN0Lm1haW4oKQojIENvcHlyaWdodCAoQykgMjAwNy0yMDEyIE1pY2hhZWwgRm9vcmQgJiB0aGUgbW9jayB0ZWFtCiMgRS1tYWlsOiBmdXp6eW1hbiBBVCB2b2lkc3BhY2UgRE9UIG9yZyBET1QgdWsKIyBodHRwOi8vd3d3LnZvaWRzcGFjZS5vcmcudWsvcHl0aG9uL21vY2svCgppbXBvcnQgb3MKaW1wb3J0IHN5cwpmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBPcmRlcmVkRGljdAoKaW1wb3J0IHVuaXR0ZXN0CmltcG9ydCB0ZXN0CmZyb20gdGVzdC50ZXN0X3VuaXR0ZXN0LnRlc3Rtb2NrIGltcG9ydCBzdXBwb3J0CmZyb20gdGVzdC50ZXN0X3VuaXR0ZXN0LnRlc3Rtb2NrLnN1cHBvcnQgaW1wb3J0IFNvbWVDbGFzcywgaXNfaW5zdGFuY2UKCmZyb20gdGVzdC5zdXBwb3J0LmltcG9ydF9oZWxwZXIgaW1wb3J0IERpcnNPblN5c1BhdGgKZnJvbSB0ZXN0LnRlc3RfaW1wb3J0bGliLnV0aWwgaW1wb3J0IHVuY2FjaGUKZnJvbSB1bml0dGVzdC5tb2NrIGltcG9ydCAoCiAgICBOb25DYWxsYWJsZU1vY2ssIENhbGxhYmxlTWl4aW4sIHNlbnRpbmVsLAogICAgTWFnaWNNb2NrLCBNb2NrLCBOb25DYWxsYWJsZU1hZ2ljTW9jaywgcGF0Y2gsIF9wYXRjaCwKICAgIERFRkFVTFQsIGNhbGwsIF9nZXRfdGFyZ2V0CikKCgpidWlsdGluX3N0cmluZyA9ICdidWlsdGlucycKClBUTW9kdWxlID0gc3lzLm1vZHVsZXNbX19uYW1lX19dCk1PRE5BTUUgPSAnJXMuUFRNb2R1bGUnICUgX19uYW1lX18KCgpkZWYgX2dldF9wcm94eShvYmosIGdldF9vbmx5PVRydWUpOgogICAgY2xhc3MgUHJveHkob2JqZSB7TnVsbCx9Qm9vbGVhbkZpZWxkJ3MsICMxNTA0MCIiIgoKICAgIGJmID0gbW9kZWxzLkZvcmVpZ25LZXkoQm9vbGVhbk1vZGVsLCBtb2RlbHMuQ0FTQ0FERSkKICAgIG5iZiA9IG1vZGVscy5Gb3JlaWduS2V5KE51bGxCb29sZWFuTW9kZWwsIG1vZGVscy5DQVNDQURFKQoKCmNsYXNzIEZrVG9DaGFyKG1vZGVscy5Nb2RlbCk6CiAgICAiIiJNb2RlbCB3aXRoIEZLIHRvIGEgbW9kZWwgd2l0aCBhIENoYXJGaWVsZCBwcmltYXJ5IGtleSwgIzE5Mjk5IiIiCgogICAgb3V0ID0gbW9kZWxzLkZvcmVpZ25LZXkoUHJpbWFyeUtleUNoYXJNb2RlbCwgbW9kZWxzLkNBU0NBREUpCgoKY2xhc3MgUmVuYW1lZEZpZWxkKG1vZGVscy5Nb2RlbCk6CiAgICBtb2RlbG5hbWUgPSBtb2RlbHMuSW50ZWdlckZpZWxkKG5hbWU9ImZpZWxkbmFtZSIsIGNob2ljZXM9KCgxLCAiT25lIiksKSkKCgpjbGFzcyBWZXJib3NlTmFtZUZpZWxkKG1vZGVscy5Nb2RlbCk6CiAgICBpZCA9IG1vZGVscy5BdXRvRmllbGQoInZlcmJvc2UgcGsiLCBwcmltYXJ5X2tleT1UcnVlKQogICAgZmllbGQxID0gbW9kZWxzLkJpZ0ludGVnZXJGaWVsZCgidmVyYm9zZSBmaWVsZDEiKQogICAgZmllbGQyID0gbW9kZWxzLkJvb2xlYW5GaWVsZCgidmVyYm9zZSBmaWVsZDIiLCBkZWZhdWx0PUZhbHNlKQogICAgZmllbGQzID0gbW9kZWxzLkNoYXJGaWVsZCgidmVyYm9zZSBmaWVsZDMiLCBtYXhfbGVuZ3RoPTEwKQogICAgZmllbGQ0ID0gbW9kZWxzLkRhdGVGaWVsZCgidmVyYm9zZSBmaWVsZDQiKQogICAgZmllbGQ1ID0gbW9kZWxzLkRhdGVUaW1lRmllbGQoInZlcmJvc2UgZmllbGQ1IikKICAgIGZpZWxkNiA9IG1vZGVscy5EZWNpbWFsRmllbGQoInZlcmJvc2UgZmllbGQ2IiwgbWF4X2RpZ2l0cz02LCBkZWNpbWFsX3BsYWNlcz0xKQogICAgZmllbGQ3ID0gbW9kZWxzLkVtYWlsRmllbGQoInZlcmJvc2UgZmllbGQ3IikKICAgIGZpZWxkOCA9IG1vZGVscy5GaWxlRmllbGQoCiAgICAgICAgInZlcmJvc2UgZmllbGQ4Iiwgc3RvcmFnZT10ZW1wX3N0b3JhZ2UsIHVwbG9hZF90bz0idW51c2VkIgogICAgKQogICAgZmllbGQ5ID0gbW9kZWxzLkZpbGVQYXRoRmllbGQoInZlcmJvc2UgZmllbGQ5IikKICAgIGZpZWxkMTAgPSBtb2RlbHMuRmxvYXRGaWVsZCgidmVyYm9zZSBmaWVsZDEwIikKICAgICMgRG9uJ3Qgd2FudCB0byBkZXBlbmQgb24gUGlsbG93IGluIHRoaXMgdGVzdAogICAgIyBmaWVsZF9pbWFnZSA9IG1vZGVscy5JbWFnZUZpZWxkKCJ2ZXJib3NlIGZpZWxkIikKICAgIGZpZWxkMTEgPSBtb2RlbHMuSW50ZWdlckZpZWxkKCJ2ZXJib3NlIGZpZWxkMTEiKQogICAgZmllbGQxMiA9IG1vZGVscy5HZW5lcmljSVBBZGRyZXNzRmllbGQoInZlcmJvc2UgZmllbGQxMiIsIHByb3RvY29sPSJpcHY0IikKICAgIGZpZWxkMTMgPSBtb2RlbHMuUG9zaXRpdmVJbnRlZ2VyRmllbGQoInZlcmJvc2UgZmllbGQxMyIpCiAgICBmaWVsZDE0ID0gbW9kZWxzLlBvc2l0aXZlU21hbGxJbnRlZyAgQG1vZGlmeV9zZXR0aW5ncyhJTlNUQUxMRURfQVBQUz17InJlbW92ZSI6ICJkamFuZ28uY29udHJpYi5zaXRlcyJ9KQogICAgZGVmIHRlc3Rfc2l0ZW1hcF9nZXRfdXJsc19ub19zaXRlXzIoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQ2hlY2sgd2UgZ2V0IEltcHJvcGVybHlDb25maWd1cmVkIHdoZW4gd2UgZG9uJ3QgcGFzcyBhIHNpdGUgb2JqZWN0IHRvCiAgICAgICAgU2l0ZW1hcC5nZXRfdXJscyBpZiBTaXRlIG9iamVjdHMgZXhpc3RzLCBidXQgdGhlIHNpdGVzIGZyYW1ld29yayBpcyBub3QKICAgICAgICBhY3R1YWxseSBpbnN0YWxsZWQuCiAgICAgICAgIiIiCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFJhaXNlc01lc3NhZ2UoSW1wcm9wZXJseUNvbmZpZ3VyZWQsIHNlbGYudXNlX3NpdGVtYXBfZXJyX21zZyk6CiAgICAgICAgICAgIFNpdGVtYXAoKS5nZXRfdXJscygpCgogICAgZGVmIHRlc3Rfc2l0ZW1hcF9pdGVtKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIENoZWNrIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZSByYXcgaXRlbSBpcyBpbmNsdWRlZCB3aXRoIGVhY2gKICAgICAgICBTaXRlbWFwLmdldF91cmwoKSB1cmwgcmVzdWx0LgogICAgICAgICIiIgogICAgICAgIHRlc3Rfc2l0ZW1hcCA9IFNpdGVtYXAoKQogICAgICAgIHRlc3Rfc2l0ZW1hcC5pdGVtcyA9IFRlc3RNb2RlbC5vYmplY3RzLm9yZGVyX2J5KCJwayIpLmFsbAoKICAgICAgICBkZWYgaXNfdGVzdG1vZGVsKHVybCk6CiAgICAgICAgICAgIHJldHVybiBpc2luc3RhbmNlKHVybFsiaXRlbSJdLCBUZXN0TW9kZWwpCgogICAgICAgIGl0ZW1faW5fdXJsX2luZm8gPSBhbGwobWFwKGlzX3Rlc3Rtb2RlbCwgdGVzdF9zaXRlbWFwLmdldF91cmxzKCkpKQogICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShpdGVtX2luX3VybF9pbmZvKQoKICAgIGRlZiB0ZXN0X2NhY2hlZF9zaXRlbWFwX2luZGV4KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEEgY2FjaGVkIHNpdGVtYXAgaW5kZXggY2FuIGJlIHJlbmRlcmVkICgjMjcxMykuCiAgICAgICAgIiIiCiAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmNsaWVudC5nZXQoIi9jYWNoZWQvaW5kZXgueG1sIikKICAgICAgICBleHBlY3RlZF9jb250ZW50ID0gIiIiPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHNpdGVtYXBpbmRleCB4bWxucz0iaHR0cDovL3d3dy5zaXRlbWFwcy5vcmcvc2NoZW1hcy9zaXRlbWFwLzAuOSI+CjxzaXRlbWFwPjxsb2M+JXMvY2FjaGVkL3NpdGVtYXAtc2ltcGxlLnhtbDwvbG9jPjxsYXN0bW9kPiVzPC9sYXN0bW9kPjwvc2l0ZW1hcD4KPC9zaXRlbWFwaW5kZXg+CiIiIiAlICgKICAgICAgICAgICAgc2VsZi5iYXNlX3VybCwKICAgICAgICAgICAgZGF0ZS50b2RheSgpLAogICAgICAgICkKICAgICAgICBzZWxmLmFzc2VydFhNTEVxdWFsKHJlc3BvbnNlLnRleHQsIGV4cGVjdGVkX2NvbnRlbnQpCgogICAgZGVmIHRlc3RfeF9yb2JvdHNfc2l0ZW1hcChzZWwgICJpbml0aWFsLW1lbWJlcnNoaXBfc2V0LTAtZGF0ZV9qb2luZWQiOiBub3cuc3RyZnRpbWUoIiVZLSVtLSVkICVIOiVNOiVTIiksCiAgICAgICAgICAgICJtZW1iZXJzaGlwX3NldC0wLWthcm1hIjogIiIsCiAgICAgICAgfQogICAgICAgIGZvcm1zZXQgPSBGb3JtU2V0KGRhdGEsIGluc3RhbmNlPXBlcnNvbikKICAgICAgICBzZWxmLmFzc2VydFRydWUoZm9ybXNldC5pc192YWxpZCgpKQoKICAgIGRlZiB0ZXN0X2lubGluZWZvcm1zZXRfZmFjdG9yeV93aXRoX251bGxfZmsoc2VsZik6CiAgICAgICAgIyBpbmxpbmVmb3Jtc2V0X2ZhY3RvcnkgdGVzdHMgd2l0aCBmayBoYXZpbmcgbnVsbD1UcnVlLiBzZWUgIzk0NjIuCiAgICAgICAgIyBjcmVhdGUgc29tZSBkYXRhIHRoYXQgd2lsbCBleGhpYml0IHRoZSBpc3N1ZQogICAgICAgIHRlYW0gPSBUZWFtLm9iamVjdHMuY3JlYXRlKG5hbWU9IlJlZCBWaXBlcnMiKQogICAgICAgIFBsYXllcihuYW1lPSJUaW1teSIpLnNhdmUoKQogICAgICAgIFBsYXllcihuYW1lPSJCb2JieSIsIHRlYW09dGVhbSkuc2F2ZSgpCgogICAgICAgIFBsYXllcklubGluZUZvcm1TZXQgPSBpbmxpbmVmb3Jtc2V0X2ZhY3RvcnkoVGVhbSwgUGxheWVyLCBmaWVsZHM9Il9fYWxsX18iKQogICAgICAgIGZvcm1zZXQgPSBQbGF5ZXJJbmxpbmVGb3JtU2V0KCkKICAgICAgICBzZWxmLmFzc2VydFF1ZXJ5U2V0RXF1YWwoZm9ybXNldC5nZXRfcXVlcnlzZXQoKSwgW10pCgogICAgICAgIGZvcm1zZXQgPSBQbGF5ZXJJbmxpbmVGb3JtU2V0KGluc3RhbmNlPXRlYW0pCiAgICAgICAgcGxheWVycyA9IGZvcm1zZXQuZ2V0X3F1ZXJ5c2V0KCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGxlbihwbGF5ZXJzKSwgMSkKICAgICAgICAocGxheWVyMSwpID0gcGxheWVycwogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocGxheWVyMS50ZWFtLCB0ZWFtKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocGxheWVyMS5uYW1lLCAiQm9iYnkiKQoKICAgIGRlZiB0ZXN0X2lubGluZWZvcm1zZXRfd2l0aF9hcnJheWZpZWxkKHNlbGYpOgogICAgICAgIGNsYXNzIFNpbXBsZUFycmF5RmllbGQoZm9ybXMuQ2hhckZpZWxkKToKICAgICAgICAgICAgIiIiQSBwcm94eSBmb3IgZGphbmdvLmNvbnRyaWIucG9zdGdyZXMuZm9ybXMuU2ltcGxlQXJyYXlGaWVsZC4iIiIKCiAgICAgICAgICAgIGRlZiB0b19weXRob24oc2VsZiwgdmFsdWUpOgogICAgICAgICAgICAgICAgdmFsdWUgPSBzdXBlcigpLnRvX3B5dGhvbih2YWx1ZSkKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS5zcGxpdCgiLCIpIGlmIHZhbHVlIGVsc2UgW10KCiAgICAgICAgY2xhc3MgQm9va0Zvcm0oZm9ybXMuTW9kZWxGb3JtKToKICAgICAgICAgICAgdGl0bGUgPSBTaW1wbGVBcnJheUZpZWxkKCkKCiAgICAgICAgICAgIGNsYXNzIE1ldGE6CiAgICAgICAgICAgICAgICBtb2RlbCA9IEJvb2sKICAgICAgICAgICAgICAgIGZpZWxkcyA9IFsidGl0bGUiXQoKIF9zdHIoc2VsZik6CiAgICAgICAgbm9kZSA9IE5vZGUoKCJhcHBfYSIsICIwMDAxIikpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzdHIobm9kZSksICIoJ2FwcF9hJywgJzAwMDEnKSIpCgogICAgZGVmIHRlc3RfZHVtbXlub2RlX3JlcHIoc2VsZik6CiAgICAgICAgbm9kZSA9IER1bW15Tm9kZSgKICAgICAgICAgICAga2V5PSgiYXBwX2EiLCAiMDAwMSIpLAogICAgICAgICAgICBvcmlnaW49ImFwcF9hLjAwMDEiLAogICAgICAgICAgICBlcnJvcl9tZXNzYWdlPSJ4IGlzIG1pc3NpbmciLAogICAgICAgICkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlcHIobm9kZSksICI8RHVtbXlOb2RlOiAoJ2FwcF9hJywgJzAwMDEnKT4iKQppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHJlCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGUKZnJvbSBkZWNpbWFsIGltcG9ydCBEZWNpbWFsCgpmcm9tIGRqYW5nbyBpbXBvcnQgZm9ybXMKZnJvbSBkamFuZ28uY29yZS5leGNlcHRpb25zIGltcG9ydCBJbXByb3Blcmx5Q29uZmlndXJlZApmcm9tIGRqYW5nby5kYiBpbXBvcnQgbW9kZWxzCmZyb20gZGphbmdvLmZvcm1zLmZvcm1zZXRzIGltcG9ydCBmb3Jtc2V0X2ZhY3RvcnkKZnJvbSBkamFuZ28uZm9ybXMubW9kZWxzIGltcG9ydCAoCiAgICBCYXNlTW9kZWxGb3JtU2V0LAogICAgTW9kZWxGb3JtLAogICAgX2dldF9mb3JlaWduX2tleSwKICAgIGlubGluZWZvcm1zZXRfZmFjdG9yeSwKICAgIG1vZGVsZm9ybXNldF9mYWN0b3J5LAopCmZyb20gZGphbmdvLmZvcm1zLnJlbmRlcmVycyBpbXBvcnQgRGphbmdvVGVtcGxhdGVzCmZyb20gZGphbmdvLmh0dHAgaW1wb3J0IFF1ZXJ5RGljdApmcm9tIGRqYW5nby50ZXN0IGltcG9ydCBUZXN0Q2FzZSwgc2tpcFVubGVzc0RCRmVhdHVyZQoKZnJvbSAubW9kZWxzIGltcG9ydCAoCiAgICBBbHRlcm5hdGVCb29rLAogICAgQXV0aG9yLAogICAgQXV0aG9yTWVldGluZywKICAgIEJldHRlckF1dGhvciwKICAgIEJvb2ssCiAgICBCb29rV2l0aEN1c3RvbVBLLAogICAgQm9va1dpdGhPcHRpb25hbEFsdEVkaXRvciwKICAgIENsYXNzeU1leGljYW5SZXN0YXVyYW50LAogICAgQ3VzdG9tUHJpbWFyeUtleSwKICAgIExvY2F0aW9uLAogICAgTWVtYmVyc2hpcCwKICAgIE1leGljYW5SZXN0YXVyYW50LAogICAgT3duZXIsCiAgICBPd25lclByb2ZpbGUsCiAgICBQZXJzb24sCiAgICBQbGFjZSwKICAgIFBsYXllciwKICAgIFBvZW0sCiAgICBQb2V0LAogICAgUG9zdCwKICAgIFByaWNlLAogICAgUHJvZHVjdCwKICAgIFJlcG9zaXRvcnksCiAgICBSZXN0YXVyYW50LAogICAgUmV2aXNpb24sCiAgICBUZWFtLAopCgoKY2xhc3MgRGVsZXRpb25UZXN0cyhUZXN0Q2FzZSk6CiAgICBkZWYgdGVzdF9kZWxldGlvbihzZWxmKToKICAgICAgICBQb2V0Rm9ybVNldCA9IG1vZGVsZm9ybXNldF9mYWN0b3J5KFBvZXQsIGZpZWxkcz0iX19hbGxfXyIsIGNhbl9kZWxldGU9VHJ1ZSkKICAgICAgICBwb2V0ID0gUG9ldC5vYmplIGluZm8oJ2NhbGxpbmcgam9pbigpIGZvciBwcm9jZXNzICVzJywgcC5uYW1lKQogICAgICAgICAgICAgICAgcC5qb2luKCkKCiAgICAgICAgZGVidWcoJ3J1bm5pbmcgdGhlIHJlbWFpbmluZyAiYXRleGl0IiBmaW5hbGl6ZXJzJykKICAgICAgICBfcnVuX2ZpbmFsaXplcnMoKQoKYXRleGl0LnJlZ2lzdGVyKF9leGl0X2Z1bmN0aW9uKQoKIwojIFNvbWUgZm9yayBhd2FyZSB0eXBlcwojCgpjbGFzcyBGb3JrQXdhcmVUaHJlYWRMb2NrKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5fbG9jayA9IHRocmVhZGluZy5Mb2NrKCkKICAgICAgICBzZWxmLmFjcXVpcmUgPSBzZWxmLl9sb2NrLmFjcXVpcmUKICAgICAgICBzZWxmLnJlbGVhc2UgPSBzZWxmLl9sb2NrLnJlbGVhc2UKICAgICAgICByZWdpc3Rlcl9hZnRlcl9mb3JrKHNlbGYsIEZvcmtBd2FyZVRocmVhZExvY2suX2F0X2ZvcmtfcmVpbml0KQoKICAgIGRlZiBfYXRfZm9ya19yZWluaXQoc2VsZik6CiAgICAgICAgc2VsZi5fbG9jay5fYXRfZm9ya19yZWluaXQoKQoKICAgIGRlZiBfX2VudGVyX18oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuX2xvY2suX19lbnRlcl9fKCkKCiAgICBkZWYgX19leGl0X18oc2VsZiwgKmFyZ3MpOgogICAgICAgIHJldHVybiBzZWxmLl9sb2NrLl9fZXhpdF9fKCphcmdzKQoKCmNsYXNzIEZvcmtBd2FyZUxvY2FsKHRocmVhZGluZy5sb2NhbCk6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgcmVnaXN0ZXJfYWZ0ZXJfZm9yayhzZWxmLCBsYW1iZGEgb2JqIDogb2JqLl9fZGljdF9fLmNsZWFyKCkpCiAgICBkZWYgX19yZWR1Y2VfXyhzZWxmKToKICAgICAgICByZXR1cm4gdHlwZShzZWxmKSwgKCkKCiMKIyBDbG9zZSBmZHMgZXhjZXB0IHRob3NlIHNwZWNpZmllZAojCgp0cnk6CiAgICBNQVhGRCA9IG9zLnN5c2NvbmYoIlNDX09QRU5fTUFYIikKZXhjZXB0IEV4Y2VwdGlvbjoKICAgIE1BWEZEID0gMjU2CgpkZWYgY2xvc2VfYWxsX2Zkc19leGNlcHQoZmRzKToKICAgIGZkcyA9IGxpc3QoZmRzKSArIFstMSwgTUFYRkRdCiAgICBmZHMuc29ydCgpCiAgICBhc3NlcnQgZmRzWy0xXSA9PSBNQVhGRCwgJ2ZkIHRvbyBsYXJnZScKICAgIGZvciBpIGluIHJhbmdlKGxlbihmZHMpIC0gMSk6CiAgICAgICAgb3MuY2xvc2VyYW5nZShmZHNbaV0rMSwgZmRzW2krMV0pCiMKIyBDbG9zZSBzeXMuc3RkaW4gYW5kIHJlcGxhY2Ugc3RkaW4gd2l0aCBvcy5kZXZudWxsCiMKCmRlZiBfY2xvc2Vfc3RkaW4oKToKICAgIGlmIHN5cy5zdGRpbiBpcyBOb25lOgogICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICBzeXMuc3RkaW4uY2xvc2UoKQogICAgZXhjZXB0IChPU0Vycm9yLCBWYWx1ZUVycm9yKToKICAgICAgICBwYXNzCgogICAgdHJ5OgogICAgICAgIGZkID0gb3Mub3Blbihvcy5kZXZudWxsLCBvcy5PX1JET05MWSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN5cy5zdGRpbiA9IG9wZW4oZmQsIGVuYmFzZU9uRGVsZXRlKCJTRVQgTlVMTCIsICJEQl9TRVRfTlVMTCIpCgpTS0lQX0NPTExFQ1RJT04gPSBmcm96ZW5zZXQoW0RPX05PVEhJTkcsIERCX0NBU0NBREUsIERCX1NFVF9ERUZBVUxULCBEQl9TRVRfTlVMTF0pCgoKZGVmIGdldF9jYW5kaWRhdGVfcmVsYXRpb25zX3RvX2RlbGV0ZShvcHRzKToKICAgICMgVGhlIGNhbmRpZGF0ZSByZWxhdGlvbnMgYXJlIHRoZSBvbmVzIHRoYXQgY29tZSBmcm9tIE4tMSBhbmQgMS0xCiAgICAjIHJlbGF0aW9ucy4gTi1OICAoaS5lLiwgbWFueS10by1tYW55KSByZWxhdGlvbnMgYXJlbid0IGNhbmRpZGF0ZXMgZm9yCiAgICAjIGRlbGV0aW9uLgogICAgcmV0dXJuICgKICAgICAgICBmCiAgICAgICAgZm9yIGYgaW4gb3B0cy5nZXRfZmllbGRzKGluY2x1ZGVfaGlkZGVuPVRydWUpCiAgICAgICAgaWYgZi5hdXRvX2NyZWF0ZWQgYW5kIG5vdCBmLmNvbmNyZXRlIGFuZCAoZi5vbmVfdG9fb25lIG9yIGYub25lX3RvX21hbnkpCiAgICApCgoKY2xhc3MgQ29sbGVjdG9yOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHVzaW5nLCBvcmlnaW49Tm9uZSwgZm9yY2VfY29sbGVjdGlvbj1GYWxzZSk6CiAgICAgICAgc2VsZi51c2luZyA9IHVzaW5nCiAgICAgICAgIyBBIE1vZGVsIG9yIFF1ZXJ5U2V0IG9iamVjdC4KICAgICAgICBzZWxmLm9yaWdpbiA9IG9yaWdpbgogICAgICAgICMgRm9yY2UgY29sbGVjdGluZyBvYmplY3RzIGZvciBkZWxldGlvbiBvbiB0aGUgUHl0aG9uLWxldmVsLgogICAgICAgIHNlbGYuZm9yY2VfY29sbGVjdGlvbiA9IGZvcmNlX2NvbGxlY3Rpb24KICAgICAgICAjIEluaXRpYWxseSwge21vZGVsOiB7aW5zdGFuY2VzfX0sIGxhdGVyIHZhbHVlcyBiZWNvbWUgbGlzdHMuCiAgICAgICAgc2VsZi5kYXRhID0gZGVmYXVsdGRpY3Qoc2V0KQogICAgICAgICMgeyhmaWVsZCwgdmFsdWUpOiBbaW5zdGFuY2VzLCDigKZdfQogICAgICAgIHNlbGYuZmllbGRfdXBkYXRlcyA9IGRlZmF1bHRkaWN0KGxpc3QpCiAgICAgICAgIyB7bW9kZWw6IHtmaWVsZDoge2luc3RhbmNlc319fQogICAgICAgIHNlbGYucmVzdHJpY3RlZF9vYmplY3RzID0gZGVmYXVsdGRpY3QocGFydGlhbChkZWZhdWx0ZGljdCwgc2V0KSkKICAgICAgICAjIGZhc3RfZGVsZXRlcyBpcyBhIGxpc3Qgb2YgcXVlcnlzZXQtbGlrZXMgdGhhdCBjYW4gYmUgZGVsZXRlZCB3aXRob3V0CiAgICAgICAgIyBmZXRjaGluZyB0aGUgb2JqZWN0cyBpbnRvIG1lbW9yeS4KICAgICAgICBzZWxmLmZhc3RfZGVsZXRlcyA9IFtdCgogICAgICAgICMgVHJhY2tzIGRlbGV0aW9uLW9yZGVyIGRlcGVuZGVuY3kgZm9yIGRhdGFiYXNlcyB3aXRob3V0IHRyYW5zYWN0aW9ucwogICAgICAgICMgb3IgYWJpbGl0eSB0byBkZWZlciBjb25zdHJhaW50IGNoZWNrcy4gT25seSBjb25jcmV0ZSBtb2RlbCBjbGFzc2VzCiAgICAgICAgIyBzaG91bGQgYmUgaW5jbHVkZWQsIGFzIHRoZSBkZXBlbmRlbmNpZXMgZXhpc3Qgb25seSBiZXR3ZWVuIGFjdHVhbAogd2FpdF8gPSBhd2FpdAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGJhcigpLnNlbmQoTm9uZSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBTdG9wSXRlcmF0aW9uIGFzIGV4OgogICAgICAgICAgICAgICAgICAgIHJldHVybiBleC5hcmdzWzBdICsgMQogICAgICAgICAgICAnJycKICAgICAgICBdCgogICAgICAgIGZvciBjb2RlIGluIHNhbXBsZXM6CiAgICAgICAgICAgIHdpdGggc2VsZi5zdWJUZXN0KGNvZGU9Y29kZSksIHNlbGYuYXNzZXJ0UmFpc2VzKFN5bnRheEVycm9yKToKICAgICAgICAgICAgICAgIGNvbXBpbGUoY29kZSwgIjx0ZXN0PiIsICJleGVjIikKCgpjbGFzcyBUb2tlbml6ZXJSZWdyVGVzdCh1bml0dGVzdC5UZXN0Q2FzZSk6CgogICAgZGVmIHRlc3Rfb25lbGluZV9kZWZzKHNlbGYpOgogICAgICAgIGJ1ZiA9IFtdCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoNTAwKToKICAgICAgICAgICAgYnVmLmFwcGVuZCgnZGVmIGl7aX0oKTogcmV0dXJuIHtpfScuZm9ybWF0KGk9aSkpCiAgICAgICAgYnVmID0gJ1xuJy5qb2luKGJ1ZikKCiAgICAgICAgIyBUZXN0IHRoYXQgNTAwIGNvbnNlcXVlbnQsIG9uZS1saW5lIGRlZnMgaXMgT0sKICAgICAgICBucyA9IHt9CiAgICAgICAgZXhlYyhidWYsIG5zLCBucykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKG5zWydpNDk5J10oKSwgNDk5KQoKICAgICAgICAjIFRlc3QgdGhhdCA1MDAgY29uc2VxdWVudCwgb25lLWxpbmUgZGVmcyAqYW5kKgogICAgICAgICMgb25lICdhc3luYyBkZWYnIGZvbGxvd2luZyB0aGVtIGlzIE9LCiAgICAgICAgYnVmICs9ICdcbmFzeW5jIGRlZiBmb28oKTpcbiAgICByZXR1cm4nCiAgICAgICAgbnMgPSB7fQogICAgICAgIGV4ZWMoYnVmLCBucywgbnMpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChuc1snaTQ5OSddKCksIDQ5OSkKICAgICAgICBzZWxmLmFzc2VydFRydWUoaW5zcGVjdC5pc2Nvcm91dGluZWZ1bmN0aW9uKG5zWydmb28nXSkpCgoKY2xhc3MgQ29yb3V0aW5lVGVzdCh1bml0dGVzdC5UZXN0Q2FzZSk6CgogICAgZGVmIHRlc3RfZ2VuXzEoc2VsZik6CiAgICAgICAgZGVmIGdlbigpOiB5aWVsZAogICAgICAgIHNlbGYuYXNzZXJ0Tm90SGFzQXR0cihnZW4sICdfX2F3YWl0X18nKQoKICAgIGRlZiB0ZXN0X2Z1bmNfMShzZWxmKToKICAgICAgICBhc3luYyBkZWYgZm9vKCk6CiAgICAgICAgICAgIHJldHVybiAxMAoKICAgICAgICBmID0gZm9vKCkKICAgICAgICBzZWxmLmFzc2VydElzSW5zdGFuY2UoZiwgdHlwZXMuQ29yb3V0aW5lVHlwZSkKICAgICAgICBzZWxmLmFzc2VydFRydWUoYm9vbChmb28uX19jb2RlX18uY29fZmxhZ3MgJiBpbnNwZWN0LkNPX0NPUk9VVElORSkpCiAgICAgICAgc2VsZi5hc3NlcnRGYWxzZShib29sKGZvby5fX2NvZGVfXy5jb19mbGFncyAmIGluc3BlY3QuQ09fR0VORVJBVE9SKSkKICAgICAgICBzZWxmLmFzc2VydFRydWUoYm9vbChmLmNyX2NvZGUuYXRlKCJwYXJ0aWFsX2NvbnRhaW5zX2Zha2VfZW5kX2luc2lkZV92ZXJiYXRpbSIpCiAgICAgICAgcGFydGlhbF90ZW1wbGF0ZSA9IHRlbXBsYXRlLmV4dHJhX2RhdGFbInBhcnRpYWxzIl1bInRlc3RpbmctbmFtZSJdCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgKICAgICAgICAgICAgcGFydGlhbF90ZW1wbGF0ZS5zb3VyY2UsCiAgICAgICAgICAgICJ7JSBwYXJ0aWFsZGVmIHRlc3RpbmctbmFtZSAlfVxuIgogICAgICAgICAgICAieyUgdmVyYmF0aW0gJX17JSBlbmRwYXJ0aWFsZGVmICV9eyUgZW5kdmVyYmF0aW0gJX1cbiIKICAgICAgICAgICAgIjxwPkJvZHk8L3A+XG4iCiAgICAgICAgICAgICJ7JSBlbmRwYXJ0aWFsZGVmICV9IiwKICAgICAgICApCiIiIgpUaW1lem9uZS1yZWxhdGVkIGNsYXNzZXMgYW5kIGZ1bmN0aW9ucy4KIiIiCgppbXBvcnQgZnVuY3Rvb2xzCmltcG9ydCB6b25laW5mbwpmcm9tIGNvbnRleHRsaWIgaW1wb3J0IENvbnRleHREZWNvcmF0b3IKZnJvbSBkYXRldGltZSBpbXBvcnQgVVRDLCBkYXRldGltZSwgdGltZWRlbHRhLCB0aW1lem9uZSwgdHppbmZvCgpmcm9tIGFzZ2lyZWYubG9jYWwgaW1wb3J0IExvY2FsCgpmcm9tIGRqYW5nby5jb25mIGltcG9ydCBzZXR0aW5ncwoKX19hbGxfXyA9IFsKICAgICJnZXRfZml4ZWRfdGltZXpvbmUiLAogICAgImdldF9kZWZhdWx0X3RpbWV6b25lIiwKICAgICJnZXRfZGVmYXVsdF90aW1lem9uZV9uYW1lIiwKICAgICJnZXRfY3VycmVudF90aW1lem9uZSIsCiAgICAiZ2V0X2N1cnJlbnRfdGltZXpvbmVfbmFtZSIsCiAgICAiYWN0aXZhdGUiLAogICAgImRlYWN0aXZhdGUiLAogICAgIm92ZXJyaWRlIiwKICAgICJsb2NhbHRpbWUiLAogICAgImxvY2FsZGF0ZSIsCiAgICAibm93IiwKICAgICJpc19hd2FyZSIsCiAgICAiaXNfbmFpdmUiLAogICAgIm1ha2VfYXdhcmUiLAogICAgIm1ha2VfbmFpdmUiLApdCgoKZGVmIGdldF9maXhlZF90aW1lem9uZShvZmZzZXQpOgogICAgIiIiUmV0dXJuIGEgdHppbmZvIGluc3RhbmNlIHdpdGggYSBmaXhlZCBvZmZzZXQgZnJvbSBVVEMuIiIiCiAgICBpZiBpc2luc3RhbmNlKG9mZnNldCwgdGltZWRlbHRhKToKICAgICAgICBvZmZzZXQgPSBvZmZzZXQudG90YWxfc2Vjb25kcygpIC8vIDYwCiAgICBzaWduID0gIi0iIGlmIG9mZnNldCA8IDAgZWxzZSAiKyIKICAgIGhobW0gPSAiJTAyZCUwMmQiICUgZGl2bW9kKGFicyhvZmZzZXQpLCA2MCkKICAgIG5hbWUgPSBzaWduICsgaGhtbQogICAgcmV0dXJuIHRpbWV6b25lKHRpbWVkZWx0YShtaW51dGVzPW9mZnNldCksIG5hbWUpCgoKIyBJbiBvcmRlciB0byBhdm9pZCBhY2Nlc3Npbmcgc2V0dGluZ3MgYXQgY29tcGlsZSB0aW1lLAojIHdyYXAgdGhlIGxvZ2ljIGluIGEgZnVuY3Rpb24gYW5kIGNhY2hlIHRoZSByZXN1bHQuCkBmdW5jdG9vbHMubHJ1X2NhY2hlCmRlZiBnZXRfZGVmYXVsdF90aW1lem9uZSgpOgp0ICoKZnJvbSAuc3VwcG9ydC5waXAgaW1wb3J0ICoKZnJvbSAuc3VwcG9ydC5wcm9wcyBpbXBvcnQgKgpmcm9tIC5zdXBwb3J0LnB5bWFuYWdlciBpbXBvcnQgKgpmcm9tIC5zdXBwb3J0Lm51c3BlYyBpbXBvcnQgKgoKVEVTVF9QWURTX09OTFkgPSBGaWxlU3RlbVNldCgieHhsaW1pdGVkIiwgInh4bGltaXRlZF8zNSIsICJfY3R5cGVzX3Rlc3QiLCAiX3Rlc3QqIikKVEVTVF9ETExTX09OTFkgPSBzZXQoKQpURVNUX0RJUlNfT05MWSA9IEZpbGVOYW1lU2V0KCJ0ZXN0IiwgInRlc3RzIikKCklETEVfRElSU19PTkxZID0gRmlsZU5hbWVTZXQoImlkbGVsaWIiKQoKVENMVEtfUFlEU19PTkxZID0gRmlsZVN0ZW1TZXQoIl90a2ludGVyIikKVENMVEtfRExMU19PTkxZID0gRmlsZVN0ZW1TZXQoInRjbCoiLCAidGsqIiwgInpsaWIxIikKVENMVEtfRElSU19PTkxZID0gRmlsZU5hbWVTZXQoInRraW50ZXIiLCAidHVydGxlZGVtbyIpClRDTFRLX0ZJTEVTX09OTFkgPSBGaWxlTmFtZVNldCgidHVydGxlLnB5IikKClZFTlZfRElSU19PTkxZID0gRmlsZU5hbWVTZXQoInZlbnYiLCAiZW5zdXJlcGlwIikKCkVYQ0xVREVfRlJPTV9ETExTID0gRmlsZVN0ZW1TZXQoInB5dGhvbioiLCAicHlzaGVsbGV4dCIsICJ2Y3J1bnRpbWUqIikKRVhDTFVERV9GUk9NX0xJQiA9IEZpbGVOYW1lU2V0KCIqLnB5YyIsICJfX3B5Y2FjaGVfXyIsICIqLnBpY2tsZSIpCkVYQ0xVREVfRlJPTV9QQUNLQUdFRF9MSUIgPSBGaWxlTmFtZVNldCgicmVhZG1lLnR4dCIpCkVYQ0xVREVfRlJPTV9DT01QSUxFID0gRmlsZU5hbWVTZXQoImJhZHN5bnRheF8qIiwgImJhZF8qIikKRVhDTFVERV9GUk9NX0NBVEFMT0cgPSBGaWxlU3VmZml4U2V0KCIuZXhlIiwgIi5weWQiLCAiLmRsbCIpCgpSRVFVSVJFRF9ETExTID0gRmlsZVN0ZW1TZXQoImxpYmNyeXB0byoiLCAibGlic3NsKiIsICJsaWJmZmkqIikKClBZX0ZJTEVTID0gRmlsZVN1ZmZpeFNldCgiLnB5IikKUFlDX0ZJTEVTID0gRmlsZVN1ZmZpeFNldCgiLnB5YyIpCkNBVF9GSUxFUyA9IEZpbGVTdWZmaXhTZXQoIi5jYXQiKQpDREZfRklMRVMgPSBGaWxlU3VmZml4U2V0KCIuY2RmIikKCkRBVEFfRElSUyA9IEZpbGVOYW1lU2V0KCJkYXRhIikKClRPT0xTX0RJUlMgPSBGaWxlTmFtZVNldCgic2NyaXB0cyIsICJpMThuIiwgInBhcnNlciIpClRPT0xTX0ZJTEVTID0gRmlsZVN1ZmZpeFNldCgiLnB5IiwgIi5weXciLCAiLnR4dCIpCgoKZGVmIGNvcHlfaWZfbW9kaWZpZWQoc3JjLCBkZXN0KToKICAgIHRyeToKICAgICAgICBkZXN0X3N0YXQgPSBvcy5zdGF0KGRlc3QpCiAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgZG9fY29weSA9IFRydWUKICAgIGVsc2U6CiAgICAgICAgc3JjX3N0YXQgPSBvcy5zdGF0KHNyYykKICAgICAgICBkb19jb3B5ID0gKAogICAgICAgICAgICBzcmNfc3RhdC5zdF9tdGltZSAhPSBkZXN0X3N0YXQuc3RfbXRpbWUKICAgICAgICAgICAgb3Igc3JjX3N0YXQuc3Rfc2l6ZSAgICAgIkBkZXByZWNhdGVkIGRlY29yYXRvciB3aXRoIG5vbi1Ob25lIGNhdGVnb3J5IG11c3QgYmUgYXBwbGllZCB0byAiCiAgICAgICAgICAgICAgICBmImEgY2xhc3Mgb3IgY2FsbGFibGUsIG5vdCB7YXJnIXJ9IgogICAgICAgICAgICApCgoKX0RFUFJFQ0FURURfTVNHID0gIntuYW1lIXJ9IGlzIGRlcHJlY2F0ZWQgYW5kIHNsYXRlZCBmb3IgcmVtb3ZhbCBpbiBQeXRob24ge3JlbW92ZX0iCgoKZGVmIF9kZXByZWNhdGVkKG5hbWUsIG1lc3NhZ2U9X0RFUFJFQ0FURURfTVNHLCAqLCByZW1vdmUsIF92ZXJzaW9uPXN5cy52ZXJzaW9uX2luZm8pOgogICAgIiIiV2FybiB0aGF0ICpuYW1lKiBpcyBkZXByZWNhdGVkIG9yIHNob3VsZCBiZSByZW1vdmVkLgoKICAgIFJ1bnRpbWVFcnJvciBpcyByYWlzZWQgaWYgKnJlbW92ZSogc3BlY2lmaWVzIGEgbWFqb3IvbWlub3IgdHVwbGUgb2xkZXIgdGhhbgogICAgdGhlIGN1cnJlbnQgUHl0aG9uIHZlcnNpb24gb3IgdGhlIHNhbWUgdmVyc2lvbiBidXQgcGFzdCB0aGUgYWxwaGEuCgogICAgVGhlICptZXNzYWdlKiBhcmd1bWVudCBpcyBmb3JtYXR0ZWQgd2l0aCAqbmFtZSogYW5kICpyZW1vdmUqIGFzIGEgUHl0aG9uCiAgICB2ZXJzaW9uIHR1cGxlIChlLmcuICgzLCAxMSkpLgoKICAgICIiIgogICAgcmVtb3ZlX2Zvcm1hdHRlZCA9IGYie3JlbW92ZVswXX0ue3JlbW92ZVsxXX0iCiAgICBpZiAoX3ZlcnNpb25bOjJdID4gcmVtb3ZlKSBvciAoX3ZlcnNpb25bOjJdID09IHJlbW92ZSBhbmQgX3ZlcnNpb25bM10gIT0gImFscGhhIik6CiAgICAgICAgbXNnID0gZiJ7bmFtZSFyfSB3YXMgc2xhdGVkIGZvciByZW1vdmFsIGFmdGVyIFB5dGhvbiB7cmVtb3ZlX2Zvcm1hdHRlZH0gYWxwaGEiCiAgICAgICAgcmFpc2UgUnVudGltZUVycm9yKG1zZykKICAgIGVsc2U6CiAgICAgICAgbXNnID0gbWVzc2FnZS5mb3JtYXQobmFtZT1uYW1lLCByZW1vdmU9cmVtb3ZlX2Zvcm1hdHRlZCkKICAgICAgICBfd20ud2Fybihtc2csIERlcHJlY2F0aW9uV2FybmluZywgc3RhY2tsZXZlbD0zKQoKCiMgUHJpdmF0ZSB1dGlsaXR5IGZ1bmN0aW9uIGNhbGxlZCBieSBfUHlFcnJfV2FyblVuYXdhaXRlZENvcm91dGluZQpkZWYgX3dhcm5fdW5hd2FpdGVkX2Nvcm91dGluZShjb3JvKToKICAgIG1zZ19saW5lcyA9IFsKICAgICAgICBmImNvcm91dGluZSAne2Nvcm8uX19xdWFsbmFtZV9ffScgd2FzIG5ldmVyIGF3YWl0ZWRcbiIKICAgIF0KICAgIGlmIGNvcm8uY3Jfb3JpZ2luIGlzIG5vdCBOb25lOgogICAgICAgIGltcG9ydCBsaW5lY2FjaGUsIHRyYWNlYmFjawogICAgICAgIGRlZiBleHRyYWN0KCk6CiAgICAgICAgICAgIGZvciBmaWxlbmFtZSwgbGluZW5vLCBmdW5jbmFtZSBpbiByZXZlcnNlZChjb3JvLmNyX29yaWdpbik6CiAgICAgICAgICAgICAgICBsaW5lID0gbGluZWNhY2hlLmdldGxpbmUoZmlsZW5hbWUsIGxpbmVubykKICAgICAgICAgICAgICAgIHlpZWxkIChmaWxheWVkKG9iaiwgMCkKCiAgICBkZWYgdGVzdF9vbmx5X3dpdGhfc2VsZWN0X3JlbGF0ZWQoc2VsZik6CiAgICAgICAgb2JqID0gUHJpbWFyeS5vYmplY3RzLnNlbGVjdF9yZWxhdGVkKCkub25seSgicmVsYXRlZF9fZmlyc3QiKVswXQogICAgICAgIHNlbGYuYXNzZXJ0X2RlbGF5ZWQob2JqLCAyKQogICAgICAgIHNlbGYuYXNzZXJ0X2RlbGF5ZWQob2JqLnJlbGF0ZWQsIDEpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChvYmoucmVsYXRlZF9pZCwgc2VsZi5zMS5waykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKG9iai5uYW1lLCAicDEiKQoKICAgIGRlZiB0ZXN0X2RlZmVyX2ZvcmVpZ25fa2V5c19hcmVfZGVmZXJyZWRfYW5kX25vdF90cmF2ZXJzZWQoc2VsZik6CiAgICAgICAgIyBzZWxlY3RfcmVsYXRlZCgpIG92ZXJyaWRlcyBkZWZlcigpLgogICAgICAgIHdpdGggc2VsZi5hc3NlcnROdW1RdWVyaWVzKDEpOgogICAgICAgICAgICBvYmogPSBQcmltYXJ5Lm9iamVjdHMuZGVmZXIoInJlbGF0ZWQiKS5zZWxlY3RfcmVsYXRlZCgpWzBdCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0X2RlbGF5ZWQob2JqLCAxKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKG9iai5yZWxhdGVkLmlkLCBzZWxmLnMxLnBrKQoKICAgIGRlZiB0ZXN0X3NhdmluZ19vYmplY3Rfd2l0aF9kZWZlcnJlZF9maWVsZChzZWxmKToKICAgICAgICAjIFNhdmluZyBtb2RlbHMgd2l0aCBkZWZlcnJlZCBmaWVsZHMgaXMgcG9zc2libGUgKGJ1dCBpbmVmZmljaWVudCwKICAgICAgICAjIHNpbmNlIGV2ZXJ5IGZpZWxkIGhhcyB0byBiZSByZXRyaWV2ZWQgZmlyc3QpLgogICAgICAgIG9iaiA9IFByaW1hcnkub2JqZWN0cy5kZWZlcigidmFsdWUiKS5nZXQobmFtZT0icDIiKQogICAgICAgIG9iai5uYW1lID0gImEgbmV3IG5hbWUiCiAgICAgICAgb2JqLnNhdmUoKQogICAgICAgIHNlbGYuYXNzZXJ0UXVlcnlTZXRFcXVhbCgKICAgICAgICAgICAgUHJpbWFyeS5vYmplY3RzLmFsbCgpLAogICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAicDEiLAogICAgICAgICAgICAgICAgImEgbmV3IG5hbWUiLAogICAgICAgICAgICBdLAogICAgICAgICAgICBsYW1iZGEgcDogcC5uYW1lLAogICAgICAgICAgICBvcmRlcmVkPUZhbHNlLAogICAgICAgICkKCiAgICBkZWYgdGVzdF9kZWZlcl9iYXNlY2xhc3Nfd2hlbl9zdWJjbGFzc19oYXNfbm9fYWRkZWRfZmllbGRzKHNlbGYpOgogICAgICAgICMgUmVncmVzc2lvbiBmb3IgIzEwNTcyIC0gQSBzdWJjbGFzcyB3aXRoIG5vIGV4dHJhIGZpZWxkcyBjYW4gZGVmZXIKICAgICAgICAjIGZpZWxkcyBmcm9tIHRoZSBiYXNlIGNsYXNzCiAgICAgICAgQ2hpbGQub2JqZWN0cy5jcmVhdGUobmFtZT0iYzEiLCB2YWx1ZT0iZm9vIiwgcmVsYXRlZD1zZWxmLnMxKQogICAgICAgICMgWW91IGNhbiBkZWZlciBhIGZpZWxkIG9uIGEgYmFzZWNsYXNzIHdoZW4gdGhlIHN1YmNsYXNzIGhhcyBubyBmaWVsZHMKICAgICAgICBvYmogPSBDaC5mdXQgPSBhc3luY2lvLkZ1dHVyZShsb29wPWxvb3ApCgogICAgICAgICAgICBkZWYgY29ubmVjdGlvbl9sb3N0KHNlbGYsIGV4Yyk6CiAgICAgICAgICAgICAgICBzZWxmLmZ1dC5zZXRfcmVzdWx0KE5vbmUpCgogICAgICAgIGFzeW5jIGRlZiBjbGllbnQoYWRkciwgY3R4KToKICAgICAgICAgICAgdHIsIHByID0gYXdhaXQgbG9vcC5jcmVhdGVfY29ubmVjdGlvbihQcm90b2NvbCwgKmFkZHIsIHNzbD1jdHgpCiAgICAgICAgICAgIHRyLmNsb3NlKCkKICAgICAgICAgICAgYXdhaXQgcHIuZnV0CgogICAgICAgIHdpdGggc2VsZi50Y3Bfc2VydmVyKHNlcnZlcikgYXMgc3J2OgogICAgICAgICAgICBjdHggPSBzZWxmLl9jcmVhdGVfY2xpZW50X3NzbF9jb250ZXh0KCkKICAgICAgICAgICAgbG9vcC5ydW5fdW50aWxfY29tcGxldGUoY2xpZW50KHNydi5hZGRyLCBjdHgpKQogICAgICAgICAgICBjdHggPSB3ZWFrcmVmLnJlZihjdHgpCgogICAgICAgICMgYXN5bmNpbyBoYXMgbm8gc2h1dGRvd24gdGltZW91dCwgYnV0IGl0IGVuZHMgdXAgd2l0aCBhIGNpcmN1bGFyCiAgICAgICAgIyByZWZlcmVuY2UgbG9vcCAtIG5vdCBpZGVhbCAoaW50cm9kdWNlcyBnYyBnbGl0Y2hlcyksIGJ1dCBhdCBsZWFzdAogICAgICAgICMgbm90IGxlYWtpbmcKICAgICAgICBnYy5jb2xsZWN0KCkKICAgICAgICBnYy5jb2xsZWN0KCkKICAgICAgICBnYy5jb2xsZWN0KCkKCiAgICAgICAgIyBTU0xQcm90b2NvbCBzaG91bGQgYmUgREVDUkVGIHRvIDAKICAgICAgICBzZWxmLmFzc2VydElzTm9uZShjdHgoKSkKCiAgICBkZWYgdGVzdF9zaHV0ZG93bl90aW1lb3V0X2hhbmRsZXJfbm90X3NldChzZWxmKToKICAgICAgICBsb29wID0gc2VsZi5sb29wCiAgICAgICAgZW9mID0gYXN5bmNpby5FdmVudCgpCiAgICAgICAgZXh0cmEgPSBOb25lCgogICAgICAgIGRlZiBzZXJ2ZXIoc29jayk6CiAgICAgICAgICAgIHNzbGN0eCA9IHNlbGYuX2NyZWF0ZV9zZXJ2ZXJfc3NsX2NvbnRleHQoCiAgICAgICAgICAgICAgICB0ZXN0X3V0aWxzLk9OTFlDRVJULAogICAgICAgICAgICAgICAgdGVzdF91dGlscy5PTkxZS0VZCiAgICAgICAgICAgICkKICAgICAgICAgICAgc29jayA9IHNzbGN0eC53cmFwX3NvY2tldChzb2NrLCBzZXJ2ZXJfc2lkZT1UcnVlKQogICAgICAgICAgICBzb2NrLnNlbmQoYidoZWxsbycpCiAgICAgICAgICAgIGFzc2VydCBzb2NrLnJlY3YoMTAyNCkgPT0gYid3b3JsZCcKICAgICAgICAgICAgc29jay5zZW5kKGInZXh0cmEgYnl0ZXMnKQogICAgICAgICAgICAjIHNlbmRpbmcgRU9GIGhlcmUKICAgICAgICAgICAgc29jay5zaHV0ZG93bihzb2NrZXQuU0hVVF9XUikKICAgICAgICAgICAgbG9vcC5jYWxsX3Nvb25fdGhyZWFkc2FmZShlb2Yuc2V0KQogICAgICAgICAgICAjIG1ha2Ugc3VyZSB3ZSBoYXZlIGVub3VnaCB0aW1lIHRvIHJlcHJvZHVjZSB0aGUgaXNzdWUKICAgICAgICAgICAgYXNzZXJ0IHNvY2sucmVjdigxMDI0KSA9PSBiJycKIENoYXJzZXQuQ2hhcnNldCgidXRmLTgiKQp1dGY4X2NoYXJzZXRfcXAuYm9keV9lbmNvZGluZyA9IENoYXJzZXQuUVAKCiMgRGVmYXVsdCBNSU1FIHR5cGUgdG8gdXNlIG9uIGF0dGFjaG1lbnRzIChpZiBpdCBpcyBub3QgZXhwbGljaXRseSBnaXZlbgojIGFuZCBjYW5ub3QgYmUgZ3Vlc3NlZCkuCkRFRkFVTFRfQVRUQUNITUVOVF9NSU1FX1RZUEUgPSAiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtIgoKIyBSZW1vdmVkSW5EamFuZ283MFdhcm5pbmcuClJGQzUzMjJfRU1BSUxfTElORV9MRU5HVEhfTElNSVQgPSA5OTgKCgojIFJlbW92ZWRJbkRqYW5nbzcwV2FybmluZy4KIyBCYWRIZWFkZXJFcnJvciBtdXN0IGJlIFZhbHVlRXJyb3IgKG5vdCBzdWJjbGFzcyBpdCksIHNvIHRoYXQgZXhpc3RpbmcgY29kZQojIHdpdGggYGV4Y2VwdCBCYWRIZWFkZXJFcnJvcmAgd2lsbCBjYXRjaCB0aGUgVmFsdWVFcnJvciB0aGF0IFB5dGhvbidzIG1vZGVybgojIGVtYWlsIEFQSSByYWlzZXMgZm9yIGhlYWRlcnMgY29udGFpbmluZyBDUiBvciBOTC4KQmFkSGVhZGVyRXJyb3IgPSBWYWx1ZUVycm9yCgojIFJlbW92ZWRJbkRqYW5nbzcwV2FybmluZy4KIyBIZWFkZXIgbmFtZXMgdGhhdCBjb250YWluIHN0cnVjdHVyZWQgYWRkcmVzcyBkYXRhIChSRkMgNTMyMikuCkFERFJFU1NfSEVBREVSUyA9IHsKICAgICJmcm9tIiwKICAgICJzZW5kZXIiLAogICAgInJlcGx5LXRvIiwKICAgICJ0byIsCiAgICAiY2MiLAogICAgImJjYyIsCiAgICAicmVzZW50LWZyb20iLAogICAgInJlc2VudC1zZW5kZXIiLAogICAgInJlc2VudC10byIsCiAgICAicmVzZW50LWNjIiwKICAgICJyZXNlbnQtYmNjIiwKfQoKCiMgUmVtb3ZlZEluRGphbmdvNzBXYXJuaW5nLgpkZWYgZm9yYmlkX211bHRpX2xpbmVfaGVhZGVycyhuYW1lLCB2YWwsIGVuY29kaW5nKToKICAgICIiIkZvcmJpZCBtdWx0aS1saW5lIGhlYWRlcnMgdG8gcHJldmVudCBoZWFkZXIgaW5qZWN0aW9uLiIiIgogICAgd2FybmluZ3Mud2FybigKICAgICAgICAiVGhlIGludGVybmFsIEFQSSBmb3JiaWRfbXVsdGlfbGluZV9oZWFkZXJzKCkgaXMgZGVwcmVjYXRlZC4iCiAgICAgICAgIiBQeXRob24ncyBtb2Rlcm4gZW1haWwgQVBJICh3aXRoIGVtYWlsLm1lc3NhZ2UuRW1haWxNZXNzYWdlIG9yIgogICAgICAgICIgZW1haWwucG9saWN5LmRlZmF1bHQpIHdpbGwgcmVqZWN0IG11bHRpLWxpbmUgaGVhZGVycy4iLAogICAgICAgIFJlbW92ZWRJbkRqYW5nbzcwV2FybmluZywKICAgICkKCiAgICBlbmNvZGluZyA9IGVuY29kaW5nIG9yIHNldHRpbmdzLkRFRkFVTFRfQ0hBUlNFVAogICAgdmFsID0gc3RyKHZhbCkgICMgdmFsIG1heSBiZSBsYXp5CiAgICBpZiAiXG4iIGluIHZhbCBvciAiXHIiIGluIHZhbDoKICAgICAgICByYWlzZSBCYWRIZWFkZXJFcnJvcigKICAgICAgICAgICAgIkhlYWRlciB2YWx1ZXMgY2FuJ3QgY29udGFpbiBuZXdsaW5lcyAoZ290ICVyIGZvciBoZWFkZXIgJXIpIiAlICh2YWwsIG5hbW5kZXggPSBwb3MgPSAtMQogICAgICAgIGNoYXIgPSBvcmQoYykKICAgICAgICBjdXJsZW4gPSBzZWxlY3RpdmVfbGVuKHN0ciwgY2hhcikKICAgICAgICBkZWx0YSA9IChjdXJsZW4rMSkgKiAoY2hhciAtIG9sZGNoYXIpCiAgICAgICAgd2hpbGUgMToKICAgICAgICAgICAgaW5kZXgscG9zID0gc2VsZWN0aXZlX2ZpbmQoc3RyLGMsaW5kZXgscG9zKQogICAgICAgICAgICBpZiBpbmRleCA9PSAtMToKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGRlbHRhICs9IGluZGV4IC0gb2xkaW5kZXgKICAgICAgICAgICAgcmVzdWx0LmFwcGVuZChkZWx0YS0xKQogICAgICAgICAgICBvbGRpbmRleCA9IGluZGV4CiAgICAgICAgICAgIGRlbHRhID0gMAogICAgICAgIG9sZGNoYXIgPSBjaGFyCgogICAgcmV0dXJuIHJlc3VsdAoKZGVmIFQoaiwgYmlhcyk6CiAgICAjIFB1bnljb2RlIHBhcmFtZXRlcnM6IHRtaW4gPSAxLCB0bWF4ID0gMjYsIGJhc2UgPSAzNgogICAgcmVzID0gMzYgKiAoaiArIDEpIC0gYmlhcwogICAgaWYgcmVzIDwgMTogcmV0dXJuIDEKICAgIGlmIHJlcyA+IDI2OiByZXR1cm4gMjYKICAgIHJldHVybiByZXMKCmRpZ2l0cyA9IGIiYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5IgpkZWYgZ2VuZXJhdGVfZ2VuZXJhbGl6ZWRfaW50ZWdlcihOLCBiaWFzKToKICAgICIiIjMuMyBHZW5lcmFsaXplZCB2YXJpYWJsZS1sZW5ndGggaW50ZWdlcnMiIiIKICAgIHJlc3VsdCA9IGJ5dGVhcnJheSgpCiAgICBqID0gMAogICAgd2hpbGUgMToKICAgICAgICB0ID0gVChqLCBiaWFzKQogICAgICAgIGlmIE4gPCB0OgogICAgICAgICAgICByZXN1bHQuYXBwZW5kKGRpZ2l0c1tOXSkKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC50YWtlX2J5dGVzKCkKICAgICAgICByZXN1bHQuYXBwZW5kKGRpZ2l0c1t0ICsgKChOIC0gdCkgJSAoMzYgLSB0KSldKQogICAgICAgIE4gPSAoTiAtIHQpIC8vICgzNiAtIHQpCiAgICAgICAgaiArPSAxCgpkZWYgYWRhcHQoZGVsdGEsIGZpcnN0LCBudW1jaGFycyk6CiAgICBpZiBmaXJzdDoKICAgICAgICBkZWx0YSAvLz0gNzAwCiAgICBlbHNlOgogICAgICAgIGRlbHRhIC8vPSAyCiAgICBkZWx0YSArPSBkZWx0YSAvLyBudW1jaGFycwogICAgIyAoKGJhc2UgLSB0bWluKSAqIHRtYXgpIC8vIDIgPT0gNDU1CiAgICBkaXZpc2lvbnMgPSAwCiAgICB3aGlsZSBkZWx0YSA+IDQ1NToKICAgICAgICBkZWx0YSA9IGRlbHRhIC8vIDM1ICMgYmFzZSAtIHRtaW4KICAgICAgICBkaXZpc2lvbnMgKz0gMzYKICAgIGJpYXMgPSBkaXZpc2lvbnMgKyAoMzYgKiBkZWx0YSAvLyAoZGVsdGEgKyAzOCkpCiAgICByZXR1cm4gYmlhcwoKCmRlZiBnZW5lcmF0ZV9pbnRlZ2VycyhiYXNlbGVuLCBkZWx0YXMpOgogICAgIiIiMy40IEJpYXMgYWRhcHRhdGlvbiIiIgogICAgIyBQdW55Y29kZSBwYXJhbWV0ZXJzOiBpbml0aWFsIGJpYXMgPSA3MiwgZGFtcCA9IDcwMCwgc2tldyA9IDM4CiAgIGt1cCBjbGF1c2VzIHdoZW4KICAgICMgdGhlIHJpZ2h0LWhhbmQgc2lkZSBvZiB0aGUgbG9va3VwIGlzbid0IGEgcmF3IHN0cmluZyAoaXQgbWlnaHQgYmUgYW4KICAgICMgZXhwcmVzc2lvbiBvciB0aGUgcmVzdWx0IG9mIGEgYmlsYXRlcmFsIHRyYW5zZm9ybWF0aW9uKS4gSW4gdGhvc2UgY2FzZXMsCiAgICAjIHNwZWNpYWwgY2hhcmFjdGVycyBmb3IgTElLRSBvcGVyYXRvcnMgKGUuZy4gXCwgKiwgXykgc2hvdWxkIGJlIGVzY2FwZWQgb24KICAgICMgZGF0YWJhc2Ugc2lkZS4KICAgICMKICAgICMgTm90ZTogd2UgdXNlIHN0ci5mb3JtYXQoKSBoZXJlIGZvciByZWFkYWJpbGl0eSBhcyAnJScgaXMgdXNlZCBhcyBhCiAgICAjIHdpbGRjYXJkIGZvciB0aGUgTElLRSBvcGVyYXRvci4KICAgIHBhdHRlcm5fZXNjID0gciJSRVBMQUNFKFJFUExBQ0UoUkVQTEFDRSh7fSwgJ1wnLCAnXFwnKSwgJyUlJywgJ1wlJScpLCAnXycsICdcXycpIgogICAgcGF0dGVybl9vcHMgPSB7CiAgICAgICAgImNvbnRhaW5zIjogciJMSUtFICclJScgfHwge30gfHwgJyUlJyBFU0NBUEUgJ1wnIiwKICAgICAgICAiaWNvbnRhaW5zIjogciJMSUtFICclJScgfHwgVVBQRVIoe30pIHx8ICclJScgRVNDQVBFICdcJyIsCiAgICAgICAgInN0YXJ0c3dpdGgiOiByIkxJS0Uge30gfHwgJyUlJyBFU0NBUEUgJ1wnIiwKICAgICAgICAiaXN0YXJ0c3dpdGgiOiByIkxJS0UgVVBQRVIoe30pIHx8ICclJScgRVNDQVBFICdcJyIsCiAgICAgICAgImVuZHN3aXRoIjogciJMSUtFICclJScgfHwge30gRVNDQVBFICdcJyIsCiAgICAgICAgImllbmRzd2l0aCI6IHIiTElLRSAnJSUnIHx8IFVQUEVSKHt9KSBFU0NBUEUgJ1wnIiwKICAgIH0KCiAgICB0cmFuc2FjdGlvbl9tb2RlcyA9IGZyb3plbnNldChbIkRFRkVSUkVEIiwgIkVYQ0xVU0lWRSIsICJJTU1FRElBVEUiXSkKCiAgICBEYXRhYmFzZSA9IERhdGFiYXNlCiAgICBTY2hlbWFFZGl0b3JDbGFzcyA9IERhdGFiYXNlU2NoZW1hRWRpdG9yCiAgICAjIENsYXNzZXMgaW5zdGFudGlhdGVkIGluIF9faW5pdF9fKCkuCiAgICBjbGllbnRfY2xhc3MgPSBEYXRhYmFzZUNsaWVudAogICAgY3JlYXRpb25fY2xhc3MgPSBEYXRhYmFzZUNyZWF0aW9uCiAgICBmZWF0dXJlc19jbGFzcyA9IERhdGFiYXNlRmVhdHVyZXMKICAgIGludHJvc3BlY3Rpb25fY2xhc3MgPSBEYXRhYmFzZUludHJvc3BlY3Rpb24KICAgIG9wc19jbGFzcyA9IERhdGFiYXNlT3BlcmF0aW9ucwoKICAgIGRlZiBnZXRfY29ubmVjdGlvbl9wYXJhbXMoc2VsZik6CiAgICAgICAgc2V0dGluZ3NfZGljdCA9IHNlbGYuc2V0dGluZ3NfZGljdAogICAgICAgIGlmIG5vdCBzZXR0aW5nc19kaWN0WyJOQU1FIl06CiAgICAgICAgICAgIHJhaXNlIEltcHJvcGVybHlDb25maWd1cmVkKAogICAgICAgICAgICAgICAgInNldHRpbmdzLkRBVEFCQVNFUyBpcyBpbXByb3Blcmx5IGNvbmZpZ3VyZWQuICIKICAgICAgICAgICAgICAgICJQbGVhc2Ugc3VwcGx5IHRoZSBOQU1FICAgIDB4MjU4ODogMHgwMGRiLCAgICAgIyAgRlVMTCBCTE9DSwogICAgMHgyNThjOiAweDAwZGQsICAgICAjICBMRUZUIEhBTEYgQkxPQ0sKICAgIDB4MjU5MDogMHgwMGRlLCAgICAgIyAgUklHSFQgSEFMRiBCTE9DSwogICAgMHgyNTkxOiAweDAwYjAsICAgICAjICBMSUdIVCBTSEFERQogICAgMHgyNTkyOiAweDAwYjEsICAgICAjICBNRURJVU0gU0hBREUKICAgIDB4MjU5MzogMHgwMGIyLCAgICAgIyAgREFSSyBTSEFERQogICAgMHgyNWEwOiAweDAwZmUsICAgICAjICBCTEFDSyBTUVVBUkUKfQoiIiJSZWFkL3dyaXRlIHN1cHBvcnQgZm9yIE1haWxkaXIsIG1ib3gsIE1ILCBCYWJ5bCwgYW5kIE1NREYgbWFpbGJveGVzLiIiIgoKIyBOb3RlcyBmb3IgYXV0aG9ycyBvZiBuZXcgbWFpbGJveCBzdWJjbGFzc2VzOgojCiMgUmVtZW1iZXIgdG8gZnN5bmMoKSBjaGFuZ2VzIHRvIGRpc2sgYmVmb3JlIGNsb3NpbmcgYSBtb2RpZmllZCBmaWxlCiMgb3IgcmV0dXJuaW5nIGZyb20gYSBmbHVzaCgpIG1ldGhvZC4gIFNlZSBmdW5jdGlvbnMgX3N5bmNfZmx1c2goKSBhbmQKIyBfc3luY19jbG9zZSgpLgoKaW1wb3J0IG9zCmltcG9ydCB0aW1lCmltcG9ydCBjYWxlbmRhcgppbXBvcnQgc29ja2V0CmltcG9ydCBlcnJubwppbXBvcnQgY29weQppbXBvcnQgd2FybmluZ3MKaW1wb3J0IGVtYWlsCmltcG9ydCBlbWFpbC5tZXNzYWdlCmltcG9ydCBlbWFpbC5nZW5lcmF0b3IKaW1wb3J0IGlvCmltcG9ydCBjb250ZXh0bGliCmZyb20gdHlwZXMgaW1wb3J0IEdlbmVyaWNBbGlhcwp0cnk6CiAgICBpbXBvcnQgZmNudGwKZXhjZXB0IEltcG9ydEVycm9yOgogICAgZmNudGwgPSBOb25lCgpfX2FsbF9fID0gWydNYWlsYm94JywgJ01haWxkaXInLCAnbWJveCcsICdNSCcsICdCYWJ5bCcsICdNTURGJywKICAgICAgICAgICAnTWVzc2FnZScsICdNYWlsZGlyTWVzc2FnZScsICdtYm94TWVzc2FnZScsICdNSE1lc3NhZ2UnLAogICAgICAgICAgICdCYWJ5bE1lc3NhZ2UnLCAnTU1ERk1lc3NhZ2UnLCAnRXJyb3InLCAnTm9TdWNoTWFpbGJveEVycm9yJywKICAgICAgICAgICAnTm90RW1wdHlFcnJvcicsICdFeHRlcm5hbENsYXNoRXJyb3InLCAnRm9ybWF0RXJyb3InXQoKbGluZXNlcCA9IG9zLmxpbmVzZXAuZW5jb2RlKCdhc2NpaScpCgpjbGFzcyBNYWlsYm94OgogICAgIiIiQSBncm91cCBvZiBtZXNzYWdlcyBpbiBhIHBhcnRpY3VsYXIgcGxhY2UuIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHBhdGgsIGZhY3Rvcnk9Tm9uZSwgY3JlYXRlPVRydWUpOgogICAgICAgICIiIkluaXRpYWxpemUgYSBNYWlsYm94IGluc3RhbmNlLiIiIgogICAgICAgIHNlbGYuX3BhdGggPSBvcy5wYXRoLmFic3BhdGgob3MucGF0aC5leHBhbmR1c2VyKHBhdGgpKQogICAgICAgIHNlbGYuX2ZhY3RvcnkgPSBmYWN0b3J5CgogICAgZGVmIGFkZChzZWxmLCBtZXNzYWdlKToKICAgICAgICAiIiJBZGQgbWVzc2FnZSBhbmQgcmV0dXJuIGFzc2lnbmVkIGtleS4iIiIKdHlwZT1OQU1FLCBzdHJpbmc9IkUiLCBzdGFydD0oMSwgNiksIGVuZD0oMSwgNyksIGxpbmU9IkIgQyBBIEUiCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICBdLAogICAgICAgICkKCiAgICBkZWYgdGVzdF9uYXN0eV9tdXR1YWxseV9sZWZ0X3JlY3Vyc2l2ZShzZWxmKSAtPiBOb25lOgogICAgICAgICMgVGhpcyBncmFtbWFyIGRvZXMgbm90IHJlY29nbml6ZSAneCAtICsgPScsIG11Y2ggdG8gbXkgY2hhZ3Jpbi4KICAgICAgICAjIEJ1dCB0aGF0J3MgdGhlIHdheSBQRUcgd29ya3MuCiAgICAgICAgIyBbQnJlYXRobGVzc2x5XQogICAgICAgICMgVGhlIHByb2JsZW0gaXMgdGhhdCB0aGUgdG9wbGV2ZWwgdGFyZ2V0IGNhbGwKICAgICAgICAjIHJlY3Vyc2VzIGludG8gbWF5YmUsIHdoaWNoIHJlY29nbml6ZXMgJ3ggLSArJywKICAgICAgICAjIGFuZCB0aGVuIHRoZSB0b3BsZXZlbCB0YXJnZXQgbG9va3MgZm9yIGFub3RoZXIgJysnLAogICAgICAgICMgd2hpY2ggZmFpbHMsIHNvIGl0IHJldHJlYXRzIHRvIE5BTUUsCiAgICAgICAgIyB3aGljaCBzdWNjZWVkcywgc28gd2UgZW5kIHVwIGp1c3QgcmVjb2duaXppbmcgJ3gnLAogICAgICAgICMgYW5kIHRoZW4gc3RhcnQgZmFpbHMgYmVjYXVzZSB0aGVyZSdzIG5vICc9JyBhZnRlciB0aGF0LgogICAgICAgIGdyYW1tYXJfc291cmNlID0gIiIiCiAgICAgICAgc3RhcnQ6IHRhcmdldCAnPScKICAgICAgICB0YXJnZXQ6IG1heWJlICcrJyB8IE5BTUUKICAgICAgICBtYXliZTogbWF5YmUgJy0nIHwgdGFyZ2V0CiAgICAgICAgIiIiCiAgICAgICAgZ3JhbW1hcjogR3JhbW1hciA9IHBhcnNlX3N0cmluZyhncmFtbWFyX3NvdXJjZSwgR3JhbW1hclBhcnNlcikKICAgICAgICBvdXQgPSBpby5TdHJpbmdJTygpCiAgICAgICAgZ2VuciA9IFB5dGhvblBhcnNlckdlbmVyYXRvcihncmFtbWFyLCBvdXQpCiAgICAgICAgZ2Vuci5nZW5lcmF0ZSgiPHN0cmluZz4iKQogICAgICAgIG5zOiBEaWN0W3N0ciwgQW55XSA9IHt9CiAgICAgICAgZXhlYyhvdXQuZ2V0dmFsdWUoKSwgbnMpCiAgICAgICAgcGFyc2VyX2NsYXNzID0gbnNbIkdlbmVyYXRlZFBhcnNlciJdCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFJhaXNlcyhTeW50YXhFcnJvcik6CiAgICAgICAgICAgIHBhcnNlX3N0cmluZygieCAtICsgPSIsIHBhcnNlcl9jbGFzcykKCiAgICBkZWYgdGVzdF9sb29rYWhlYWQoc2VsZikgLT4gTm9uZToKICAgICAgICBncmFtbWFyID0gIiIiCiAgICAgICAgc3RhcnQ6IChleHByX3N0bXQgfCBhc3NpZ25fc3RtdCkgJicuJwogICAgICAgIGV4cHJfc3RtdDogISh0YXJnZXQgJz0nKSBleHByCiAgICAgICAgYXNzaWduX3N0bXQ6IHRhcmdldCAnPScgZXhwcgogICAgICAgIGV4cHI6IHRlcm0gKCcrJyB0ZXJtKSoKICAgICAgICB0YXJnZXQ6IE5BTUUKICAgICAgICB0ZXJtOiBOVU1CRVIKICAgICAgICAiIiIKICAgICAgICBwYXJzZXJfY2xhc3MgPSBtYWtlX3BhcnNlcihncmFtbWFyKQogYW1lKS5zdF9tdGltZSA+PSBvcy5zdGF0KGZpbGVfcHkpLnN0X210aW1lKToKICAgICAgICAgICAgICAgIGlmIG5vdCBfY29tcGlsZShmaWxlX3B5LCBvcHRpbWl6ZT1zZWxmLl9vcHRpbWl6ZSk6CiAgICAgICAgICAgICAgICAgICAgZm5hbWUgPSBhcmNuYW1lID0gZmlsZV9weQogICAgICAgIGFyY2hpdmVuYW1lID0gb3MucGF0aC5zcGxpdChhcmNuYW1lKVsxXQogICAgICAgIGlmIGJhc2VuYW1lOgogICAgICAgICAgICBhcmNoaXZlbmFtZSA9ICIlcy8lcyIgJSAoYmFzZW5hbWUsIGFyY2hpdmVuYW1lKQogICAgICAgIHJldHVybiAoZm5hbWUsIGFyY2hpdmVuYW1lKQoKCmRlZiBtYWluKGFyZ3M9Tm9uZSk6CiAgICBpbXBvcnQgYXJncGFyc2UKCiAgICBkZXNjcmlwdGlvbiA9ICdBIHNpbXBsZSBjb21tYW5kLWxpbmUgaW50ZXJmYWNlIGZvciB6aXBmaWxlIG1vZHVsZS4nCiAgICBwYXJzZXIgPSBhcmdwYXJzZS5Bcmd1bWVudFBhcnNlcihkZXNjcmlwdGlvbj1kZXNjcmlwdGlvbiwgY29sb3I9VHJ1ZSkKICAgIGdyb3VwID0gcGFyc2VyLmFkZF9tdXR1YWxseV9leGNsdXNpdmVfZ3JvdXAocmVxdWlyZWQ9VHJ1ZSkKICAgIGdyb3VwLmFkZF9hcmd1bWVudCgnLWwnLCAnLS1saXN0JywgbWV0YXZhcj0nPHppcGZpbGU+JywKICAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdTaG93IGxpc3Rpbmcgb2YgYSB6aXBmaWxlJykKICAgIGdyb3VwLmFkZF9hcmd1bWVudCgnLWUnLCAnLS1leHRyYWN0JywgbmFyZ3M9MiwKICAgICAgICAgICAgICAgICAgICAgICBtZXRhdmFyPSgnPHppcGZpbGU+JywgJzxvdXRwdXRfZGlyPicpLAogICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J0V4dHJhY3QgemlwZmlsZSBpbnRvIHRhcmdldCBkaXInKQogICAgZ3JvdXAuYWRkX2FyZ3VtZW50KCctYycsICctLWNyZWF0ZScsIG5hcmdzPScrJywKICAgICAgICAgICAgICAgICAgICAgICBtZXRhdmFyPSgnPG5hbWU+JywgJzxmaWxlPicpLAogICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J0NyZWF0ZSB6aXBmaWxlIGZyb20gc291cmNlcycpCiAgICBncm91cC5hZGRfYXJndW1lbnQoJy10JywgJy0tdGVzdCcsIG1ldGF2YXI9Jzx6aXBmaWxlPicsCiAgICAgICAgICAgICAgICAgICAgICAgaGVscD0nVGVzdCBpZiBhIHppcGZpbGUgaXMgdmFsaWQnKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1tZXRhZGF0YS1lbmNvZGluZycsIG1ldGF2YXI9JzxlbmNvZGluZz4nLAogICAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdTcGVjaWZ5IGVuY29kaW5nIG9mIG1lbWJlciBuYW1lcyBmb3IgLWwsIC1lIGFuZCAtdCcpCiAgICBhcmdzID0gcGFyc2VyLnBhcnNlX2FyZ3MoYXJncykKCiAgICBlbmNvZGluZyA9IGFyZ3MubWV0YWRhdGFfZW5jb2RpbmcKCiAgICBpZiBhcmdzLnRlc3QgaXMgbm90IE5vbmU6CiAgICAgICAgc3JjID0gYXJncy50ZXN0CiAgICAgICAgd2l0aCBaaXBGaWxlKHNyYywgJ3InLCBtZXRhZGF0YV9lbmNvZGluZz1lbmNvZGluZykgYXMgbGUociJQeUFQSV9GVU5DKC4rKSAoXHcrKVwoIikKU0lNUExFX01BQ1JPX1JFR0VYID0gcmUuY29tcGlsZShyIiMgKmRlZmluZSAqKFx3KykoXCguK1wpKT8gIikKU0lNUExFX0lOTElORV9SRUdFWCA9IHJlLmNvbXBpbGUociJzdGF0aWMgaW5saW5lIC4rKCB8XG4pKFx3KykiKQpTSU1QTEVfREFUQV9SRUdFWCA9IHJlLmNvbXBpbGUociJQeUFQSV9EQVRBXCguK1wpIChcdyspIikKQVBJX05BTUVfUkVHRVggPSByZS5jb21waWxlKHInXGJQW3lZXVthLXpBLVowLTlfXSsnKQoKQ1BZVEhPTiA9IFBhdGgoX19maWxlX18pLnBhcmVudC5wYXJlbnQucGFyZW50CklOQ0xVREUgPSBDUFlUSE9OIC8gIkluY2x1ZGUiCkNfQVBJX0RPQ1MgPSBDUFlUSE9OIC8gIkRvYyIgLyAiYy1hcGkiCklHTk9SRUQgPSAoCiAgICAoQ1BZVEhPTiAvICJUb29scyIgLyAiY2hlY2stYy1hcGktZG9jcyIgLyAiaWdub3JlZF9jX2FwaS50eHQiKQogICAgLnJlYWRfdGV4dCgpCiAgICAuc3BsaXQoIlxuIikKKQoKZm9yIGluZGV4LCBsaW5lIGluIGVudW1lcmF0ZShJR05PUkVEKToKICAgIGlmIGxpbmUuc3RhcnRzd2l0aCgiIyIpOgogICAgICAgIElHTk9SRUQucG9wKGluZGV4KQoKTUlTVEFLRSA9ICIiIgpJZiB0aGlzIGlzIGEgbWlzdGFrZSBhbmQgdGhpcyBzY3JpcHQgc2hvdWxkIG5vdCBiZSBmYWlsaW5nLCBjcmVhdGUgYW4KaXNzdWUgYW5kIHRhZyBQZXRlciAoQFplcm9JbnRlbnNpdHkpIG9uIGl0LlwKIiIiCgoKZGVmIGZvdW5kX3VuZG9jdW1lbnRlZChzaW5ndWxhcjogYm9vbCkgLT4gc3RyOgogICAgc29tZSA9ICJhbiIgaWYgc2luZ3VsYXIgZWxzZSAic29tZSIKICAgIHMgPSAiIiBpZiBzaW5ndWxhciBlbHNlICJzIgogICAgdGhlc2UgPSAidGhpcyIgaWYgc2luZ3VsYXIgZWxzZSAidGhlc2UiCiAgICB0aGVtID0gIml0IiBpZiBzaW5ndWxhciBlbHNlICJ0aGVtIgogICAgd2VyZSA9ICJ3YXMiIGlmIHNpbmd1bGFyIGVsc2UgIndlcmUiCgogICAgcmV0dXJuICgKICAgICAgICB0ZXh0d3JhcC5kZWRlbnQoCiAgICAgICAgICAgIGYiIiIKICAgIEZvdW5kIHtzb21lfSB1bmRvY3VtZW50ZWQgQyBBUEl7c30hCgogICAgUHl0aG9uIHJlcXVpcmVzIGRvY3VtZW50YXRpb24gb24gYWxsIHB1YmxpYyBDIEFQSSBzeW1ib2xzLCBtYWNyb3MsIGFuZCB0eXBlcy4KICAgIElmIHt0aGVzZX0gQVBJe3N9IHt3ZXJlfSBub3QgbWVhbnQgdG8gYmUgcHVibGljLCBwcmVmaXgge3RoZW19IHdpdGggYQogICAgbGVhZGluZyB1bmRlcnNjb3JlIChfUHlTb21ldGhpbmdfQVBJKSBvciBtb3ZlIHt0aGVtfSB0byB0aGUgaW50ZXJuYWwgQyBBUEkKICAgIChweWNvcmVfKi5oIGZpbGVzKS4KCiAgICBJbiBleGNlcHRpb25hbCBjYXNlcywgY2VydGFpbiBBUElzIGNhbiBiZSBpZ25vcmVkIGJ5IGFkZGluZyB0aGVtIHRvCiAgICBUb29scy9jaGVjay1jLWFwaS1kb2NzL2lnbm9yZWRfY19hcGkudHh0CiAgICAiIiIKICAgICAgICApCiAgICAgICAgKyBNSVNUQUtFCiAgICAgIGNoIGZvciBjaCBpbiBtYXAoY2hyLCByYW5nZSgwLCAxMjgpKQogICAgICAgIGlmIG5vdCBjaC5pc3ByaW50YWJsZSgpCiAgICBdKQogICAgZGVmIHRlc3RfcmVqZWN0X25vbl9wcmludGFibGVfY2hhcmFjdGVycyhzZWxmLCBlY2hvX2NoYXIpOgogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFZhbHVlRXJyb3IsIGdldHBhc3MuZ2V0cGFzcywgZWNob19jaGFyPWVjaG9fY2hhcikKCiAgICAjIFR5cGVFcnJvciBSZWplY3Rpb24KICAgIEBzdXBwb3J0LnN1YlRlc3RzKCdlY2hvX2NoYXInLCBbYiIqIiwgMCwgMC4wLCBbXSwge31dKQogICAgZGVmIHRlc3RfcmVqZWN0X25vbl9zdHJpbmcoc2VsZiwgZWNob19jaGFyKToKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhUeXBlRXJyb3IsIGdldHBhc3MuZ2V0cGFzcywgZWNob19jaGFyPWVjaG9fY2hhcikKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgdW5pdHRlc3QubWFpbigpCmltcG9ydCB0aHJlYWRpbmcKCmZyb20gZGphbmdvLmNvbnRyaWIuZ2lzLmdlb3MuYmFzZSBpbXBvcnQgR0VPU0Jhc2UKZnJvbSBkamFuZ28uY29udHJpYi5naXMuZ2Vvcy5saWJnZW9zIGltcG9ydCBDT05URVhUX1BUUiwgZXJyb3JfaCwgbGdlb3MsIG5vdGljZV9oCgoKY2xhc3MgR0VPU0NvbnRleHRIYW5kbGUoR0VPU0Jhc2UpOgogICAgIiIiUmVwcmVzZW50IGEgR0VPUyBjb250ZXh0IGhhbmRsZS4iIiIKCiAgICBwdHJfdHlwZSA9IENPTlRFWFRfUFRSCiAgICBkZXN0cnVjdG9yID0gbGdlb3MuZmluaXNoR0VPU19yCgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgICMgSW5pdGlhbGl6aW5nIHRoZSBjb250ZXh0IGhhbmRsZXIgZm9yIHRoaXMgdGhyZWFkIHdpdGgKICAgICAgICAjIHRoZSBub3RpY2UgYW5kIGVycm9yIGhhbmRsZXIuCiAgICAgICAgc2VsZi5wdHIgPSBsZ2Vvcy5pbml0R0VPU19yKG5vdGljZV9oLCBlcnJvcl9oKQoKCiMgRGVmaW5pbmcgYSB0aHJlYWQtbG9jYWwgb2JqZWN0IGFuZCBjcmVhdGluZyBhbiBpbnN0YW5jZQojIHRvIGhvbGQgYSByZWZlcmVuY2UgdG8gR0VPU0NvbnRleHRIYW5kbGUgZm9yIHRoaXMgdGhyZWFkLgpjbGFzcyBHRU9TQ29udGV4dCh0aHJlYWRpbmcubG9jYWwpOgogICAgaGFuZGxlID0gTm9uZQoKCnRocmVhZF9jb250ZXh0ID0gR0VPU0NvbnRleHQoKQoKCmNsYXNzIEdFT1NGdW5jOgogICAgIiIiCiAgICBTZXJ2ZSBhcyBhIHdyYXBwZXIgZm9yIEdFT1MgQyBGdW5jdGlvbnMuIFVzZSB0aHJlYWQtc2FmZSBmdW5jdGlvbgogICAgdmFyaWFudHMgd2hlbiBhdmFpbGFibGUuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgZnVuY19uYW1lKToKICAgICAgICAjIEdFT1MgdGhyZWFkLXNhZmUgZnVuY3Rpb24gc2lnbmF0dXJlcyBlbmQgd2l0aCAnX3InIGFuZCB0YWtlIGFuCiAgICAgICAgIyBhZGRpdGlvbmFsIGNvbnRleHQgaGFuZGxlIHBhcmFtZXRlci4KICAgICAgICBzZWxmLmNmdW5jID0gZ2V0YXR0cihsZ2VvcywgZm4pOiAiIiJFcnJvciByYWlzZWQgYnkgdGhlIEJkYiBpbnN0YW5jZS4iIiIKY2xhc3MgQmRiU3ludGF4RXJyb3IoQmRiRXhjZXB0aW9uKTogIiIiU3ludGF4IGVycm9yIGluIHRoZSB0ZXN0IGNhc2UuIiIiCmNsYXNzIEJkYk5vdEV4cGVjdGVkRXJyb3IoQmRiRXhjZXB0aW9uKTogIiIiVW5leHBlY3RlZCByZXN1bHQuIiIiCgojIFdoZW4gJ2RyeV9ydW4nIGlzIHNldCB0byB0cnVlLCBleHBlY3QgdHVwbGVzIGFyZSBpZ25vcmVkIGFuZCB0aGUgYWN0dWFsCiMgc3RhdGUgb2YgdGhlIHRyYWNlciBpcyBwcmludGVkIGFmdGVyIHJ1bm5pbmcgZWFjaCBzZXRfKigpIG1ldGhvZCBvZiB0aGUgdGVzdAojIGNhc2UuIFRoZSBmdWxsIGxpc3Qgb2YgYnJlYWtwb2ludHMgYW5kIHRoZWlyIGF0dHJpYnV0ZXMgaXMgYWxzbyBwcmludGVkCiMgYWZ0ZXIgZWFjaCAnbGluZScgZXZlbnQgd2hlcmUgYSBicmVha3BvaW50IGhhcyBiZWVuIGhpdC4KZHJ5X3J1biA9IDAKCmRlZiByZXNldF9CcmVha3BvaW50KCk6CiAgICBfYmRiLkJyZWFrcG9pbnQuY2xlYXJCcmVha3BvaW50cygpCgpkZWYgaW5mb19icmVha3BvaW50cygpOgogICAgYnBfbGlzdCA9IFticCBmb3IgIGJwIGluIF9iZGIuQnJlYWtwb2ludC5icGJ5bnVtYmVyIGlmIGJwXQogICAgaWYgbm90IGJwX2xpc3Q6CiAgICAgICAgcmV0dXJuICcnCgogICAgaGVhZGVyX2FkZGVkID0gRmFsc2UKICAgIGZvciBicCBpbiBicF9saXN0OgogICAgICAgIGlmIG5vdCBoZWFkZXJfYWRkZWQ6CiAgICAgICAgICAgIGluZm8gPSAnQnBOdW0gVGVtcCBFbmIgSGl0cyBJZ25vcmUgV2hlcmVcbicKICAgICAgICAgICAgaGVhZGVyX2FkZGVkID0gVHJ1ZQoKICAgICAgICBkaXNwID0gJ3llcyAnIGlmIGJwLnRlbXBvcmFyeSBlbHNlICdubyAgJwogICAgICAgIGVuYWIgPSAneWVzJyBpZiBicC5lbmFibGVkIGVsc2UgJ25vICcKICAgICAgICBpbmZvICs9ICgnJS01ZCAlcyAlcyAlLTRkICUtNmQgYXQgJXM6JWQnICUKICAgICAgICAgICAgICAgICAgICAoYnAubnVtYmVyLCBkaXNwLCBlbmFiLCBicC5oaXRzLCBicC5pZ25vcmUsCiAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguYmFzZW5hbWUoYnAuZmlsZSksIGJwLmxpbmUpKQogICAgICAgIGlmIGJwLmNvbmQ6CiAgICAgICAgICAgIGluZm8gKz0gJ1xuXHRzdG9wIG9ubHkgaWYgJXMnICUgKGJwLmNvbmQsKQogICAgICAgIGluZm8gKz0gJ1xuJwogICAgcmV0dXJuIGluZm8KCmNsYXNzIEJkYihfYmRiLkJkYik6CiAgICAiIiJFeHRlbmQgQmRiIHRvIGVuaGFuY2UgdGVzdCBjb3ZlcmFnZS4iIiIKCiAgICBkZWYgdHJhY2VfZGlzcGF0Y2goc2VsZiwgZnJhbWUsIGV2ZW50LCBhcmcpOgogICAgICAgIHNlbGYuY3VycmVudGJwID0gTm9uZQogICAgICAgIHJldHVybiBzdXBlcigpLnRyYWNlX2Rpc3BhdGNoKGZyYW1lLCBldmVudCwgYXJnKQoKICAgIGRlZiBzZXRfYnJlYWsoc2VsZiwgZmlsZW5hbWUsIGxpbmVubywgdGVtcG9yYXJ5PUZhbHNlLCBjb25kPU5vbm9uCiMgQ29udGFjdDogZW1haWwtc2lnQHB5dGhvbi5vcmcKCiIiIkVtYWlsIGFkZHJlc3MgcGFyc2luZyBjb2RlLgoKTGlmdGVkIGRpcmVjdGx5IGZyb20gcmZjODIyLnB5LiAgVGhpcyBzaG91bGQgZXZlbnR1YWxseSBiZSByZXdyaXR0ZW4uCiIiIgoKX19hbGxfXyA9IFsKICAgICdta3RpbWVfdHonLAogICAgJ3BhcnNlZGF0ZScsCiAgICAncGFyc2VkYXRlX3R6JywKICAgICdxdW90ZScsCiAgICBdCgppbXBvcnQgdGltZQoKU1BBQ0UgPSAnICcKRU1QVFlTVFJJTkcgPSAnJwpDT01NQVNQQUNFID0gJywgJwoKIyBQYXJzZSBhIGRhdGUgZmllbGQKX21vbnRobmFtZXMgPSBbJ2phbicsICdmZWInLCAnbWFyJywgJ2FwcicsICdtYXknLCAnanVuJywgJ2p1bCcsCiAgICAgICAgICAgICAgICdhdWcnLCAnc2VwJywgJ29jdCcsICdub3YnLCAnZGVjJywKICAgICAgICAgICAgICAgJ2phbnVhcnknLCAnZmVicnVhcnknLCAnbWFyY2gnLCAnYXByaWwnLCAnbWF5JywgJ2p1bmUnLCAnanVseScsCiAgICAgICAgICAgICAgICdhdWd1c3QnLCAnc2VwdGVtYmVyJywgJ29jdG9iZXInLCAnbm92ZW1iZXInLCAnZGVjZW1iZXInXQoKX2RheW5hbWVzID0gWydtb24nLCAndHVlJywgJ3dlZCcsICd0aHUnLCAnZnJpJywgJ3NhdCcsICdzdW4nXQoKIyBUaGUgdGltZXpvbmUgdGFibGUgZG9lcyBub3QgaW5jbHVkZSB0aGUgbWlsaXRhcnkgdGltZSB6b25lcyBkZWZpbmVkCiMgaW4gUkZDODIyLCBvdGhlciB0aGFuIFouICBBY2NvcmRpbmcgdG8gUkZDMTEyMywgdGhlIGRlc2NyaXB0aW9uIGluCiMgUkZDODIyIGdldHMgdGhlIHNpZ25zIHdyb25nLCBzbyB3ZSBjYW4ndCByZWx5IG9uIGFueSBzdWNoIHRpbWUKIyB6b25lcy4gIFJGQzExMjMgcmVjb21tZW5kcyB0aGF0IG51bWVyaWMgdGltZXpvbmUgaW5kaWNhdG9ycyBiZSB1c2VkCiMgaW5zdGVhZCBvZiB0aW1lem9uZSBuYW1lcy4KCl90aW1lem9uZXMgPSB7J1VUJzowLCAnVVRDJzowLCAnR01UJzowLCAnWic6MCwKICAgICAgICAgICAgICAnQVNUJzogLTQwMCwgJ0FEVCc6IC0zMDAsICAjIEF0bGFudGljICh1c2VkIGluIENhbmFkYSkKICAgICAgICAgICAgICAnRVNUJzogLTUwMCwgJ0VEVCc6IC00MDAsICAjIEVhc3Rlcm4KICAgICAgICAgICAgICAnQ1NUJzogLTYwMCwgJ0NEVCc6IC01MDAsICAjIENlbnRyYWwKICAgICAgICAgICAgICAnTVNUJzogLTcwMCwgJ01EVCc6IC02MDAsICAjIE1vdW50YWluCiAgICAgICAgICAgICAgJ1BTVCc6IC04MDAsICdQRFQnOiAtNzAwICAgIyBQYWNpZmljCiAgICAgICAgICAgICAgfQoKCmRlZiBwYXJzZWRhdGVfdHooZGF0YSk6CiAgICAiIiJDb252ZXJ0IGEgZGF0ZSBzdHJpbmcgdG8gYSB0aW1lIHR1cGxlLgoKICAgIEFjY291bnRzIGZvciBtaWxpdGFyeSB0aW1lem9uZXMuCiAgICAiIiIKICAgIHJlcyA9IF9wYXJzZWRhdGVfdHooZGF0YSkKICAgIGlmIG5vdCByZXM6CiAgICAgICAgcmV0dXJuCiAgICBpZiByZXNbOV0gaXMgTmUgb3IgKEZhbHNlIGFuZCBGYWxzZSkgPT0gVHJ1ZSAgIDwtIHdlIHdhbnQgdGhpcyBvbmUsIGxpa2UgUHl0aG9uCiAgICAgICAgIyAoVHJ1ZSBvciBGYWxzZSkgYW5kIEZhbHNlID09IEZhbHNlCiAgICAgICAgc2VsZi5hc3NlcnRDYWxjRXF1YWwoVHJ1ZSwgW1RydWUsICJvciIsIEZhbHNlLCAiYW5kIiwgRmFsc2VdKQoKICAgICAgICAjICgxIG9yIDEpID09IDIgIC0+IEZhbHNlCiAgICAgICAgIyAxIG9yICgxID09IDIpICAtPiBUcnVlICAgPC0gd2Ugd2FudCB0aGlzIG9uZQogICAgICAgIHNlbGYuYXNzZXJ0Q2FsY0VxdWFsKFRydWUsIFsxLCAib3IiLCAxLCAiPT0iLCAyXSkKCiAgICAgICAgc2VsZi5hc3NlcnRDYWxjRXF1YWwoVHJ1ZSwgW1RydWUsICI9PSIsIFRydWUsICJvciIsIFRydWUsICI9PSIsIEZhbHNlXSkKCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgKICAgICAgICAgICAgIihvciAoYW5kICg9PSAobGl0ZXJhbCAxKSAobGl0ZXJhbCAyKSkgKGxpdGVyYWwgMykpIChsaXRlcmFsIDQpKSIsCiAgICAgICAgICAgIHJlcHIoSWZQYXJzZXIoWzEsICI9PSIsIDIsICJhbmQiLCAzLCAib3IiLCA0XSkucGFyc2UoKSksCiAgICAgICAgKQoiVGVzdCBzZWFyY2hlbmdpbmUsIGNvdmVyYWdlIDk5JS4iCgpmcm9tIGlkbGVsaWIgaW1wb3J0IHNlYXJjaGVuZ2luZSBhcyBzZQppbXBvcnQgdW5pdHRlc3QKIyBmcm9tIHRlc3Quc3VwcG9ydCBpbXBvcnQgcmVxdWlyZXMKZnJvbSB0a2ludGVyIGltcG9ydCAgQm9vbGVhblZhciwgU3RyaW5nVmFyLCBUY2xFcnJvciAgIyAsVGssIFRleHQKZnJvbSB0a2ludGVyIGltcG9ydCBtZXNzYWdlYm94CmZyb20gaWRsZWxpYi5pZGxlX3Rlc3QubW9ja190ayBpbXBvcnQgVmFyLCBNYm94CmZyb20gaWRsZWxpYi5pZGxlX3Rlc3QubW9ja190ayBpbXBvcnQgVGV4dCBhcyBtb2NrVGV4dAppbXBvcnQgcmUKCiMgV2l0aCBtb2NrIHJlcGxhY2VtZW50cywgdGhlIG1vZHVsZSBkb2VzIG5vdCB1c2UgYW55IGd1aSB3aWRnZXRzLgojIFRoZSB1c2Ugb2YgdGsuVGV4dCBpcyBhdm9pZGVkIChmb3Igbm93LCB1bnRpbCBtb2NrIFRleHQgaXMgaW1wcm92ZWQpCiMgYnkgcGF0Y2hpbmcgaW5zdGFuY2VzIHdpdGggYW4gaW5kZXggZnVuY3Rpb24gcmV0dXJuaW5nIHdoYXQgaXMgbmVlZGVkLgojIFRoaXMgd29ya3MgYmVjYXVzZSBtb2NrIFRleHQuZ2V0IGRvZXMgbm90IHVzZSAuaW5kZXguCiMgVGhlIHRraW50ZXIgaW1wb3J0cyBhcmUgdXNlZCB0byByZXN0b3JlIHNlYXJjaGVuZ2luZS4KCmRlZiBzZXRVcE1vZHVsZSgpOgogICAgIyBSZXBsYWNlIHMtZSBtb2R1bGUgdGtpbnRlciBpbXBvcnRzIG90aGVyIHRoYW4gbm9uLWd1aSBUY2xFcnJvci4KICAgIHNlLkJvb2xlYW5WYXIgPSBWYXIKICAgIHNlLlN0cmluZ1ZhciA9IFZhcgogICAgc2UubWVzc2FnZWJveCA9IE1ib3gKCmRlZiB0ZWFyRG93bk1vZHVsZSgpOgogICAgIyBSZXN0b3JlICdqdXN0IGluIGNhc2UnLCB0aG91Z2ggb3RoZXIgdGVzdHMgc2hzID0geyoqQmFzZURhdGFiYXNlT3BlcmF0aW9ucy5zZXRfb3BlcmF0b3JzLCAiZGlmZmVyZW5jZSI6ICJNSU5VUyJ9CgogICAgIyBUT0RPOiBjb2xvcml6ZSB0aGlzIFNRTCBjb2RlIHdpdGggc3R5bGUuU1FMX0tFWVdPUkQoKSwgZXRjLgogICAgX3NlcXVlbmNlX3Jlc2V0X3NxbCA9ICIiIgpERUNMQVJFCiAgICB0YWJsZV92YWx1ZSBpbnRlZ2VyOwogICAgc2VxX3ZhbHVlIGludGVnZXI7CiAgICBzZXFfbmFtZSB1c2VyX3RhYl9pZGVudGl0eV9jb2xzLnNlcXVlbmNlX25hbWUlJVRZUEU7CkJFR0lOCiAgICBCRUdJTgogICAgICAgIFNFTEVDVCBzZXF1ZW5jZV9uYW1lIElOVE8gc2VxX25hbWUgRlJPTSB1c2VyX3RhYl9pZGVudGl0eV9jb2xzCiAgICAgICAgV0hFUkUgIHRhYmxlX25hbWUgPSAnJSh0YWJsZV9uYW1lKXMnIEFORAogICAgICAgICAgICAgICBjb2x1bW5fbmFtZSA9ICclKGNvbHVtbl9uYW1lKXMnOwogICAgICAgIEVYQ0VQVElPTiBXSEVOIE5PX0RBVEFfRk9VTkQgVEhFTgogICAgICAgICAgICBzZXFfbmFtZSA6PSAnJShub19hdXRvZmllbGRfc2VxdWVuY2VfbmFtZSlzJzsKICAgIEVORDsKCiAgICBTRUxFQ1QgTlZMKE1BWCglKGNvbHVtbilzKSwgMCkgSU5UTyB0YWJsZV92YWx1ZSBGUk9NICUodGFibGUpczsKICAgIFNFTEVDVCBOVkwobGFzdF9udW1iZXIgLSBjYWNoZV9zaXplLCAwKSBJTlRPIHNlcV92YWx1ZSBGUk9NIHVzZXJfc2VxdWVuY2VzCiAgICAgICAgICAgV0hFUkUgc2VxdWVuY2VfbmFtZSA9IHNlcV9uYW1lOwogICAgV0hJTEUgdGFibGVfdmFsdWUgPiBzZXFfdmFsdWUgTE9PUAogICAgICAgIEVYRUNVVEUgSU1NRURJQVRFICdTRUxFQ1QgIid8fHNlcV9uYW1lfHwnIi5uZXh0dmFsJShzdWZmaXgpcycKICAgICAgICBJTlRPIHNlcV92YWx1ZTsKICAgIEVORCBMT09QOwpFTkQ7Ci8iIiIKCiAgICAjIE9yYWNsZSBkb2Vzbid0IHN1cHBvcnQgc3RyaW5nIHdpdGhvdXQgcHJlY2lzaW9uOyB1c2UgdGhlIG1heCBzdHJpbmcgc2l6ZS4KICAgIGNhc3RfY2hhcl9maWVsZF93aXRob3V0X21heF9sZW5ndGggPSAiTlZBUkNIQVIyKDIwMDApIgogICAgY2FzdF9kYXRhX3R5cGVzID0gewogICAgICAgICJBdXRvRmllbGQiOiAiTlVNQkVSKDExKSIsCiAgICAgICAgIkJpZ0F1dG9GaWVsZCI6ICJOVU1CRVIoMTkpIiwKICAgICAgICAiU21hbGxBdXRvRmllbGQiOiAiTlVNQkVSKDUpIiwKICAgICAgICAiVGV4dEZpZWxkIjogY2FzdF9jaGFyX2ZpZWxkX3dpdGhvdXRfbWF4X2xlbmd0aCwKICAgIH0KCiAgICBkZWYgY2FjaGVfa2V5X2N1bGxpbmdfc3FsKHNlbGYpOgogICAgICAgIGNhY2hlX2tleSA9IHNlbGYucXVvdGVfbmFtZSgiY2FjaGVfa2V5IikKICAgICAgICByZXR1cm4gKAogICAgICAgICAgICBmIlNFTEVDVCB7Y2FjaGVfa2V5fSAiCiAgICAgICAgICAgIGYiRlJPTSAlcyAiCiAgICAgICAgICAgIGYiT1JERVIgQlkge2NhY2hlX2tleX0gT0ZGU0VUICUlcyBST1dTIEZFVENIIEZJUlNUIDEgUk9XU3VmOGZmJyAgICMgIDB4RjAgLT4gQXBwbGUgbG9nbwogICAgJ1x4ZDInICAgICAjICAweEYxIC0+IExBVElOIENBUElUQUwgTEVUVEVSIE8gV0lUSCBHUkFWRQogICAgJ1x4ZGEnICAgICAjICAweEYyIC0+IExBVElOIENBUElUQUwgTEVUVEVSIFUgV0lUSCBBQ1VURQogICAgJ1x4ZGInICAgICAjICAweEYzIC0+IExBVElOIENBUElUQUwgTEVUVEVSIFUgV0lUSCBDSVJDVU1GTEVYCiAgICAnXHhkOScgICAgICMgIDB4RjQgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgVSBXSVRIIEdSQVZFCiAgICAnXHVmOGEwJyAgICMgIDB4RjUgLT4gdW5kZWZpbmVkMQogICAgJ1x1MDJjNicgICAjICAweEY2IC0+IE1PRElGSUVSIExFVFRFUiBDSVJDVU1GTEVYIEFDQ0VOVAogICAgJ1x1MDJkYycgICAjICAweEY3IC0+IFNNQUxMIFRJTERFCiAgICAnXHhhZicgICAgICMgIDB4RjggLT4gTUFDUk9OCiAgICAnXHUwMmQ4JyAgICMgIDB4RjkgLT4gQlJFVkUKICAgICdcdTAyZDknICAgIyAgMHhGQSAtPiBET1QgQUJPVkUKICAgICdcdTAyZGEnICAgIyAgMHhGQiAtPiBSSU5HIEFCT1ZFCiAgICAnXHhiOCcgICAgICMgIDB4RkMgLT4gQ0VESUxMQQogICAgJ1x1MDJkZCcgICAjICAweEZEIC0+IERPVUJMRSBBQ1VURSBBQ0NFTlQKICAgICdcdTAyZGInICAgIyAgMHhGRSAtPiBPR09ORUsKICAgICdcdTAyYzcnICAgIyAgMHhGRiAtPiBDQVJPTgopCgojIyMgRW5jb2RpbmcgdGFibGUKZW5jb2RpbmdfdGFibGU9Y29kZWNzLmNoYXJtYXBfYnVpbGQoZGVjb2RpbmdfdGFibGUpCmltcG9ydCBpdGVydG9vbHMKaW1wb3J0IHRpbWUKaW1wb3J0IHVuaXR0ZXN0CmltcG9ydCB3ZWFrcmVmCmZyb20gY29uY3VycmVudCBpbXBvcnQgZnV0dXJlcwpmcm9tIGNvbmN1cnJlbnQuZnV0dXJlcy5fYmFzZSBpbXBvcnQgKAogICAgQ0FOQ0VMTEVEX0FORF9OT1RJRklFRCwgRklOSVNIRUQsIEZ1dHVyZSkKCmZyb20gdGVzdCBpbXBvcnQgc3VwcG9ydApmcm9tIHRlc3Quc3VwcG9ydCBpbXBvcnQgd2FybmluZ3NfaGVscGVyCgpmcm9tIC51dGlsIGltcG9ydCAoCiAgICBQRU5ESU5HX0ZVVFVSRSwgUlVOTklOR19GVVRVUkUsCiAgICBDQU5DRUxMRURfQU5EX05PVElGSUVEX0ZVVFVSRSwgRVhDRVBUSU9OX0ZVVFVSRSwgU1VDQ0VTU0ZVTF9GVVRVUkUsCiAgICBjcmVhdGVfZnV0dXJlLCBjcmVhdGVfZXhlY3V0b3JfdGVzdHMsIHNldHVwX21vZHVsZSkKCgpkZWYgbXVsKHgsIHkpOgogICAgcmV0dXJuIHggKiB5CgoKY2xhc3MgQXNDb21wbGV0ZWRUZXN0czoKICAgIEB3YXJuaW5nc19oZWxwZXIuaWdub3JlX2ZvcmtfaW5fdGhyZWFkX2RlcHJlY2F0aW9uX3dhcm5pbmdzKCkKICAgIGRlZiB0ZXN0X25vX3RpbWVvdXQoc2VsZik6CiAgICAgICAgZnV0dXJlMSA9IHNlbGYuZXhlY3V0b3Iuc3VibWl0KG11bCwgMiwgMjEpCiAgICAgICAgZnV0dXJlMiA9IHNlbGYuZXhlY3V0b3Iuc3VibWl0KG11bCwgNywgNikKCiAgICAgICAgY29tcGxldGVkID0gc2V0KGZ1dHVyZXMuYXNfY29tcCAgICBmJzxsaT5UaXRsZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImZvcm0tMC10aXRsZSI+PC9saT4nCiAgICAgICAgICAgICAgICAgICAgICAgIGYnPGxpPlB1YiBkYXRlOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0iZm9ybS0wLXB1Yl9kYXRlIj4nCiAgICAgICAgICAgICAgICAgICAgICAgIGYie2RlbGV0ZV9odG1sfTwvbGk+IgogICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICApCgogICAgZGVmIHRlc3RfZm9ybXNldHNfd2l0aF9vcmRlcmluZyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBmb3Jtc2V0X2ZhY3RvcnkncyBjYW5fb3JkZXIgYXJndW1lbnQgYWRkcyBhbiBpbnRlZ2VyIGZpZWxkIHRvIGVhY2gKICAgICAgICBmb3JtLiBXaGVuIGZvcm0gdmFsaWRhdGlvbiBzdWNjZWVkcywKICAgICAgICAgICAgW2Zvcm0uY2xlYW5lZF9kYXRhIGZvciBmb3JtIGluIGZvcm1zZXQuZm9ybXNdCiAgICAgICAgd2lsbCBoYXZlIHRoZSBkYXRhIGluIHRoZSBjb3JyZWN0IG9yZGVyIHNwZWNpZmllZCBieSB0aGUgb3JkZXJpbmcKICAgICAgICBmaWVsZHMuIElmIGEgbnVtYmVyIGlzIGR1cGxpY2F0ZWQgaW4gdGhlIHNldCBvZiBvcmRlcmluZyBmaWVsZHMsIGZvcgogICAgICAgIGluc3RhbmNlIGZvcm0gMCBhbmQgZm9ybSAzIGFyZSBib3RoIG1hcmtlZCBhcyAxLCB0aGVuIHRoZSBmb3JtIGluZGV4CiAgICAgICAgdXNlZCBhcyBhIHNlY29uZGFyeSBvcmRlcmluZyBjcml0ZXJpYS4gSW4gb3JkZXIgdG8gcHV0IHNvbWV0aGluZyBhdCB0aGUKICAgICAgICBmcm9udCBvZiB0aGUgbGlzdCwgeW91J2QgbmVlZCB0byBzZXQgaXRzIG9yZGVyIHRvIDAuCiAgICAgICAgIiIiCiAgICAgICAgQ2hvaWNlRm9ybVNldCA9IGZvcm1zZXRfZmFjdG9yeShDaG9pY2UsIGNhbl9vcmRlcj1UcnVlKQogICAgICAgIGluaXRpYWwgPSBbCiAgICAgICAgICAgIHsiY2hvaWNlIjogIkNhbGV4aWNvIiwgInZvdGVzIjogMTAwfSwKICAgICAgICAgICAgeyJjaG9pY2UiOiAiRmVyZ2llIiwgInZvdGVzIjogOTAwfSwKICAgICAgICBdCiAgICAgICAgZm9ybXNldCA9IENob2ljZUZvcm1TZXQoaW5pdGlhbD1pbml0aWFsLCBhdXRvX2lkPUZhbHNlLCBwcmVmaXg9ImNob2ljZXMiKQogICAgICAgIHNlbGYuYXNzZXJ0SFRNTEVxdWFsKAogICAgICAgICAgICAiXG4iLmpvaW4oZm9ybS5hc191bCgpIGZvciBmb3JtIGluIGZvcm1zZXQuZm9ybXMpLAogICAgICAgICAgICAnPGxpPkNob2ljZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImNob2ljZXMtMC1jaG9pY2UiIHZhbHVlPSJDYWxleGljbyI+JwogICAgICAgICAgICAiPC9saT4iCiAgICAgICAgICAgICc8bGk+Vm90ZXM6IDxpbnB1dCB0eXBlPSJudW1iZXIiIG5hbWU9ImNob2ljZXMtMC12b3RlcyIgdmFsdWU9IjEwMCI+PC9saT4nCiAgICAgICAgICAgICc8bGk+T3JkZXI6IDxpbnB1dCB0eXBlPSJudW1iZXIiIG5hbWU9ImNob2ljZXMtMC1PUkRFUiIgdmFsdWU9IjEiPjwvbG9ydCBqaW5qYTJfdGVzdHMKCgpjbGFzcyBDaG9pY2UoRm9ybSk6CiAgICBjaG9pY2UgPSBDaGFyRmllbGQoKQogICAgdm90ZXMgPSBJbnRlZ2VyRmllbGQoKQoKCkNob2ljZUZvcm1TZXQgPSBmb3Jtc2V0X2ZhY3RvcnkoQ2hvaWNlKQoKCmNsYXNzIENob2ljZUZvcm1zZXRXaXRoTm9uRm9ybUVycm9yKENob2ljZUZvcm1TZXQpOgogICAgZGVmIGNsZWFuKHNlbGYpOgogICAgICAgIHN1cGVyKCkuY2xlYW4oKQogICAgICAgIHJhaXNlIFZhbGlkYXRpb25FcnJvcigibm9uLWZvcm0gZXJyb3IiKQoKCmNsYXNzIEZhdm9yaXRlRHJpbmtGb3JtKEZvcm0pOgogICAgbmFtZSA9IENoYXJGaWVsZCgpCgoKY2xhc3MgQmFzZUZhdm9yaXRlRHJpbmtzRm9ybVNldChCYXNlRm9ybVNldCk6CiAgICBkZWYgY2xlYW4oc2VsZik6CiAgICAgICAgc2Vlbl9kcmlua3MgPSBbXQoKICAgICAgICBmb3IgZHJpbmsgaW4gc2VsZi5jbGVhbmVkX2RhdGE6CiAgICAgICAgICAgIGlmIGRyaW5rWyJuYW1lIl0gaW4gc2Vlbl9kcmlua3M6CiAgICAgICAgICAgICAgICByYWlzZSBWYWxpZGF0aW9uRXJyb3IoIllvdSBtYXkgb25seSBzcGVjaWZ5IGEgZHJpbmsgb25jZS4iKQoKICAgICAgICAgICAgc2Vlbl9kcmlua3MuYXBwZW5kKGRyaW5rWyJuYW1lIl0pCgoKIyBBIEZvcm1TZXQgdGhhdCB0YWtlcyBhIGxpc3Qgb2YgZmF2b3JpdGUgZHJpbmtzIGFuZCByYWlzZXMgYW4gZXJyb3IgaWYKIyB0aGVyZSBhcmUgYW55IGR1cGxpY2F0ZXMuCkZhdm9yaXRlRHJpbmtzRm9ybVNldCA9IGZvcm1zZXRfZmFjdG9yeSgKICAgIEZhdm9yaXRlRHJpbmtGb3JtLCBmb3Jtc2V0PUJhc2VGYXZvcml0ZURyaW5rc0Zvcm1TZXQsIGV4dHJhPTMKKQoKCmNsYXNzIEN1c3RvbUt3YXJnRm9ybShGb3JtKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqYXJncywgY3VzdG9tX2t3YXJnLCAqKmt3YXJncyk6CiAgICAgICAgc2VsZi5jdXN0b21fa3dhcmcgPSBjdXN0b21fa3dhcmcKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCphcmdzLCAqKmt3YXJncykKCgpjbGFzcyBGb3Jtc0Zvcm1zZXRUZXN0Q2FzZShTaW1wbGVUZXN0Q2FzZSk6CiAgICBkZWYgbWFrZV9jaG9pY2Vmb3Jtc2V0KAogICAgICAgIHNlbGYsCiAgICAgICAgZm9ybXNldF9kYXRhPU5vbmUsCiAgICAgICAgZm9ybXNldF9jbGFzcz1DaG9pY2VGb3JtU2V0LAogICAgICAgIHRvdGFsX2Zvcm1zPU5vbmUsCiAgICAgICAgaW5pdGlhbF9mb3Jtcz0wLAogICAgICAgIG1heF9udW1fZm9ybXM9MCwKICAgICAgICBtaW5fbnVtX2Zvcm1zPTAsCiAgICAgICAgKiprd2FyZ3MsCiAgICApOgogICAgICAgICIiIgogICAgICAgIE1ha2UgYSBDaG9pY2VGb3Jtc2V0IGZyb20gdGhlIGdpdmVuIGZvcm1zZXRfZGF0YS4KICAgICAgICBUaGUgZGF0YSBzaG91bGQgYmUgZ2l2ZW4gYXMgYSBsaXN0IG9mIChjaG9pY2UsIHZvdGVzKSB0dXBsZXMuCiAgICAgICAgIiIiCiAgICAgICAga3dhcmdzLnNldGRlZmF1bHQoInByZWZpeCIsICJjaG9pY2VzIiB1c2Ugc3lzLm1heGludCBhcyB0aGlzIGRvZXNuJ3QgZXhpc3QgaW4gUHl0aG9uIDMKICAgICAgICBzeXMuc2V0cmVjdXJzaW9ubGltaXQoaW50KDEwZTgpKQogICAgICAgICMgdGhpcyBzZWdmYXVsdHMgd2l0aG91dCB0aGUgZml4IGluIHBsYWNlCiAgICAgICAgY29weS5jb3B5KE1vY2soKSkKCgogICAgZGVmIHRlc3Rfc3ViY2xhc3Nfd2l0aF9wcm9wZXJ0aWVzKHNlbGYpOgogICAgICAgIGNsYXNzIFN1YkNsYXNzKE1vY2spOgogICAgICAgICAgICBkZWYgX2dldChzZWxmKToKICAgICAgICAgICAgICAgIHJldHVybiAzCiAgICAgICAgICAgIGRlZiBfc2V0KHNlbGYsIHZhbHVlKToKICAgICAgICAgICAgICAgIHJhaXNlIE5hbWVFcnJvcignc3RyYW5nZSBlcnJvcicpCiAgICAgICAgICAgIHNvbWVfYXR0cmlidXRlID0gcHJvcGVydHkoX2dldCwgX3NldCkKCiAgICAgICAgcyA9IFN1YkNsYXNzKHNwZWNfc2V0PVN1YkNsYXNzKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocy5zb21lX2F0dHJpYnV0ZSwgMykKCiAgICAgICAgZGVmIHRlc3QoKToKICAgICAgICAgICAgcy5zb21lX2F0dHJpYnV0ZSA9IDMKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhOYW1lRXJyb3IsIHRlc3QpCgogICAgICAgIGRlZiB0ZXN0KCk6CiAgICAgICAgICAgIHMuZm9vID0gJ2JhcicKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhBdHRyaWJ1dGVFcnJvciwgdGVzdCkKCgogICAgZGVmIHRlc3Rfc2V0dGluZ19jYWxsKHNlbGYpOgogICAgICAgIG1vY2sgPSBNb2NrKCkKICAgICAgICBkZWYgX19jYWxsX18oc2VsZiwgYSk6CiAgICAgICAgICAgIHNlbGYuX2luY3JlbWVudF9tb2NrX2NhbGwoYSkKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX21vY2tfY2FsbChhKQoKICAgICAgICB0eXBlKG1vY2spLl9fY2FsbF9fID0gX19jYWxsX18KICAgICAgICBtb2NrKCdvbmUnKQogICAgICAgIG1vY2suYXNzZXJ0X2NhbGxlZF93aXRoKCdvbmUnKQoKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhUeXBlRXJyb3IsIG1vY2ssICdvbmUnLCAndHdvJykKCgogICAgZGVmIHRlc3RfZGlyKHNlbGYpOgogICAgICAgIG1vY2sgPSBNb2NrKCkKICAgICAgICBhdHRycyA9IHNldChkaXIobW9jaykpCiAgICAgICAgdHlwZV9hdHRycyA9IHNldChbbSBmb3IgbSBpbiBkaXIoTW9jaykgaWYgbm90IG0uc3RhcnRzd2l0aCgnXycpXSkKCiAgICAgICAgIyBhbGwgcHVibGljIGF0dHJpYnV0ZXMgZnJvbSB0aGUgdHlwZSBhcmUgaW5jbHVkZWQKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHNldCgpLCB0eXBlX2F0dHJzIC0gYXR0cnMpCgogICAgICAgICMgY3JlYXRlcyB0aGVzZSBhdHRyaWJ1dGVzCiAgICAgICAgbW9jay5hLCBtb2NrLmIKICAgICAgICBzZWxmLmFzc2VydEluKCdhJywgZGlyKG1vY2spKQogICAgICAgIHNlbGYuYXNzZXJ0SW4oJ2InLCBkaXIobW9jaykpCgogICAgICAgICMgaW5zdGFuY2UgYXR0cmlidXRlcwogICAgICAgIG1vY2suYyA9IG1vY2suZCA9IE4gaWYgZXhwZWN0ZWRfZmFpbHM6CiAgICAgICAgICAgIGluZm9zLmFwcGVuZChmInt0Lndhcm59ZXhwZWN0ZWQgZmFpbHVyZXM9e2V4cGVjdGVkX2ZhaWxzfXt0LnJlc2V0fSIpCiAgICAgICAgaWYgdW5leHBlY3RlZF9zdWNjZXNzZXM6CiAgICAgICAgICAgIGluZm9zLmFwcGVuZCgKICAgICAgICAgICAgICAgIGYie3QuZmFpbH11bmV4cGVjdGVkIHN1Y2Nlc3Nlcz17dW5leHBlY3RlZF9zdWNjZXNzZXN9e3QucmVzZXR9IgogICAgICAgICAgICApCiAgICAgICAgaWYgaW5mb3M6CiAgICAgICAgICAgIHNlbGYuc3RyZWFtLndyaXRlbG4oIiAoJXMpIiAlICgiLCAiLmpvaW4oaW5mb3MpLCkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5zdHJlYW0ud3JpdGUoIlxuIikKICAgICAgICBzZWxmLnN0cmVhbS5mbHVzaCgpCiAgICAgICAgcmV0dXJuIHJlc3VsdAppbXBvcnQgb3MKCkVOVl9ERUZBVUxUU19GSUxFID0gJy4uLy4uLy5lbnYuZGVmYXVsdHMnCkVOVl9ERUZBVUxUU19MT0NBTF9GSUxFID0gJy4uLy4uLy5lbnYuZGVmYXVsdHMubG9jYWwnClNXSUZUX0ZJTEVfUEFUSFMgPSBbJ2lvcy9XaWRnZXRzQ29yZS9FbnYuc3dpZnQnLCAnaW9zL09uZVNpZ25hbE5vdGlmaWNhdGlvblNlcnZpY2VFeHRlbnNpb24vRW52LnN3aWZ0J10KU1dJRlRfRU5WX1ZBUklBQkxFUyA9IFsnVU5JU1dBUF9BUElfS0VZJywgJ1NUQVRTSUdfQVBJX0tFWSddCgpkZWYgdG9fc3dpZnRfY29uc3RhbnRfbGluZShrZXksIHZhbHVlKToKICByZXR1cm4gZicgIHN0YXRpYyBsZXQge2tleS51cHBlcigpfSA9ICJ7dmFsdWV9IicKCmRlZiBwcm9jZXNzX2xpbmVzKGxpbmVzLCBzZWFyY2hfdmFycyk6CiAgZW52X3Zhcl9kZWNsYXJhdGlvbnMgPSBbXQogIGZvciBsaW5lIGluIGxpbmVzOgogICAgbGluZSA9IGxpbmUuc3RyaXAoKQogICAgaWYgbGluZSBhbmQgbm90IGxpbmUuc3RhcnRzd2l0aCgnIycpOgogICAgICAjIFNwbGl0IHZhcmlhYmxlIG5hbWUgYW5kIHZhbHVlCiAgICAgIGtleSwgdmFsdWUgPSBsaW5lLnNwbGl0KCc9JywgMSkKICAgICAgaWYga2V5IGluIHNlYXJjaF92YXJzOgogICAgICAgIGVudl92YXJfZGVjbGFyYXRpb25zLmFwcGVuZCh0b19zd2lmdF9jb25zdGFudF9saW5lKGtleS51cHBlcigpLCB2YWx1ZSkpCiAgICAgICAgc2VhcmNoX3ZhcnMucmVtb3ZlKGtleSkKCiAgcmV0dXJuIGVudl92YXJfZGVjbGFyYXRpb25zCgojIGNvbnZlcnQgZW52IHZhcmlhYmxlcyB0byBzd2lmdCBjb25zdGFudHMgYW5kIHdyaXRlcyB0byBhIHN3aWZ0IGZpbGUuCmRlZiBjb3B5X2Vudl92YXJzX3RvX3N3aWZ0KGVudl9kZWZhdWx0c19maWxlLCBlbnZfZGVmYXVsdHNfbG9jYWxfZmlsZSwgc3dpZnRfZmlsZXMsIGVudl92YXJpYWJsZXMpOgogIGVudnNfbGVmdF90b19maW5kID0gZW52X3ZhcmlhYmxlcy5jb3B5KCkKICBlbnZfdmFyX2RlY2xhcmF0aW9ucyA9IFtdCgogICMgU2VhcmNoIGZvciBlbnYgdmFycyBpbiB0aGUgc3lzdGVtIGZpcnN0CiAgZm8tLXZlcnNpb24nKQogICAgZXhjZXB0IE9TRXJyb3IgYXMgZXhjOgogICAgICAgICMgVGhpcyBpcyB3aGF0ICJubyBnZGIiIGxvb2tzIGxpa2UuICBUaGVyZSBtYXksIGhvd2V2ZXIsIGJlIG90aGVyCiAgICAgICAgIyBlcnJvcnMgdGhhdCBtYW5pZmVzdCB0aGlzIHdheSB0b28uCiAgICAgICAgcmFpc2UgdW5pdHRlc3QuU2tpcFRlc3QoZiJDb3VsZG4ndCBmaW5kIGdkYiBwcm9ncmFtIG9uIHRoZSBwYXRoOiB7ZXhjfSIpCgogICAgIyBSZWdleCB0byBwYXJzZToKICAgICMgJ0dOVSBnZGIgKEdEQjsgU1VTRSBMaW51eCBFbnRlcnByaXNlIDEyKSA3LjdcbicgLT4gNy43CiAgICAjICdHTlUgZ2RiIChHREIpIEZlZG9yYSA3LjkuMS0xNy5mYzIyXG4nIC0+IDcuOQogICAgIyAnR05VIGdkYiA2LjEuMSBbRnJlZUJTRF1cbicgLT4gNi4xCiAgICAjICdHTlUgZ2RiIChHREIpIEZlZG9yYSAoNy41LjEtMzcuZmMxOClcbicgLT4gNy41CiAgICAjICdIUCBnZGIgNi43IGZvciBIUCBJdGFuaXVtICgzMiBvciA2NCBiaXQpIGFuZCB0YXJnZXQgSFAtVVggMTFpdjIgYW5kIDExaXYzLlxuJyAtPiA2LjcKICAgIG1hdGNoID0gcmUuc2VhcmNoKHIiXig/OkdOVXxIUCkgZ2RiLio/XGIoXGQrKVwuKFxkKykiLCBzdGRvdXQpCiAgICBpZiBtYXRjaCBpcyBOb25lOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbigidW5hYmxlIHRvIHBhcnNlIGdkYiB2ZXJzaW9uOiAlciIgJSBzdGRvdXQpCiAgICB2ZXJzaW9uX3RleHQgPSBzdGRvdXQKICAgIG1ham9yID0gaW50KG1hdGNoLmdyb3VwKDEpKQogICAgbWlub3IgPSBpbnQobWF0Y2guZ3JvdXAoMikpCiAgICB2ZXJzaW9uID0gKG1ham9yLCBtaW5vcikKICAgIHJldHVybiAodmVyc2lvbl90ZXh0LCB2ZXJzaW9uKQoKR0RCX1ZFUlNJT05fVEVYVCwgR0RCX1ZFUlNJT04gPSBnZXRfZ2RiX3ZlcnNpb24oKQppZiBHREJfVkVSU0lPTiA8ICg3LCAwKToKICAgIHJhaXNlIHVuaXR0ZXN0LlNraXBUZXN0KAogICAgICAgIGYiZ2RiIHZlcnNpb25zIGJlZm9yZSA3LjAgZGlkbid0IHN1cHBvcnQgcHl0aG9uIGVtYmVkZGluZy4gIgogICAgICAgIGYiU2F3IGdkYiB2ZXJzaW9uIHtHREJfVkVSU0lPTlswXX0ue0dEQl9WRVJTSU9OWzFdfTpcbiIKICAgICAgICBmIntHREJfVkVSU0lPTl9URVhUfSIpCgoKZGVmIGNoZWNrX3VzYWJsZV9nZGIoKToKICAgICMgVmVyaWZ5IHRoYXQgImdkYiIgd2FzIGJ1aWx0IHdpdGggdGhlIGVtYmVkZGVkIFB5dGhvbiBzdXBwb3J0IGVuYWJsZWQgYW5kCiAgICAjIHZlcmlmeSB0aGF0ICJnZGIiIGNhbiBsb2FkIG91ciBjdXN0b20gaG9va3MsIGFzIE9TIHNlY3VyaXR5IHNldHRpbmdzIG1heQogICAgIyBkaXNhbGxvdyB0aGlzIHdpdGhvdXQgYSBjdXN0b21pemVkIC5nZGJpbml0LgogICAgc3Rkb3V0LCBzdGRlcnIgPSBydW5fZ2RiKAogICAgICAgICctLWV2YWwtY29tbWFuZD1weXRob24gaW1wb3J0IHN5czsgcHJpbnQoc3lzLnZlcnNpb25faW5mbyknLAogICAgICAgICctLWFyZ3MnLCBlc3Rfd2VpcmRfY2hhcnNfaW5fdW5xdW90ZWRfYXR0cmlidXRlX3ZhbHVlcyhzZWxmKToKICAgICAgICBzZWxmLl9ydW5fY2hlY2soJzxmb3JtIGFjdGlvbj1ib2d1c3wmIygpdmFsdWU+JywgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKCdzdGFydHRhZycsICdmb3JtJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbKCdhY3Rpb24nLCAnYm9ndXN8JiMoKXZhbHVlJyldKV0pCgoKY2xhc3MgVGVzdEluaGVyaXRhbmNlKHVuaXR0ZXN0LlRlc3RDYXNlKToKCiAgICBAcGF0Y2goIl9tYXJrdXBiYXNlLlBhcnNlckJhc2UuX19pbml0X18iKQogICAgQHBhdGNoKCJfbWFya3VwYmFzZS5QYXJzZXJCYXNlLnJlc2V0IikKICAgIGRlZiB0ZXN0X2Jhc2VfY2xhc3NfbWV0aG9kc19jYWxsZWQoc2VsZiwgc3VwZXJfcmVzZXRfbWV0aG9kLCBzdXBlcl9pbml0X21ldGhvZCk6CiAgICAgICAgd2l0aCBwYXRjaCgnX21hcmt1cGJhc2UuUGFyc2VyQmFzZScpIGFzIHBhcnNlcl9iYXNlOgogICAgICAgICAgICBFdmVudENvbGxlY3RvcigpCiAgICAgICAgICAgIHN1cGVyX2luaXRfbWV0aG9kLmFzc2VydF9jYWxsZWRfb25jZSgpCiAgICAgICAgICAgIHN1cGVyX3Jlc2V0X21ldGhvZC5hc3NlcnRfY2FsbGVkX29uY2UoKQoKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICB1bml0dGVzdC5tYWluKCkKZnJvbSB1cmxsaWIucGFyc2UgaW1wb3J0IHBhcnNlX3FzbCwgdW5xdW90ZSwgdXJsc3BsaXQsIHVybHVuc3BsaXQKCmZyb20gZGphbmdvIGltcG9ydCB0ZW1wbGF0ZQpmcm9tIGRqYW5nby5jb250cmliLmFkbWluLnV0aWxzIGltcG9ydCBxdW90ZQpmcm9tIGRqYW5nby51cmxzIGltcG9ydCBSZXNvbHZlcjQwNCwgZ2V0X3NjcmlwdF9wcmVmaXgsIHJlc29sdmUKZnJvbSBkamFuZ28udXRpbHMuaHR0cCBpbXBvcnQgdXJsZW5jb2RlCgpyZWdpc3RlciA9IHRlbXBsYXRlLkxpYnJhcnkoKQoKCkByZWdpc3Rlci5maWx0ZXIKZGVmIGFkbWluX3VybG5hbWUodmFsdWUsIGFyZyk6CiAgICByZXR1cm4gImFkbWluOiVzXyVzXyVzIiAlICh2YWx1ZS5hcHBfbGFiZWwsIHZhbHVlLm1vZGVsX25hbWUsIGFyZykKCgpAcmVnaXN0ZXIuZmlsdGVyCmRlZiBhZG1pbl91cmxxdW90ZSh2YWx1ZSk6CiAgICByZXR1cm4gcXVvdGUodmFsdWUpCgoKQHJlZ2lzdGVyLnNpbXBsZV90YWcodGFrZXNfY29udGV4dD1UcnVlKQpkZWYgYWRkX3ByZXNlcnZlZF9maWx0ZXJzKGNvbnRleHQsIHVybCwgcG9wdXA9RmFsc2UsIHRvX2ZpZWxkPU5vbmUpOgogICAgb3B0cyA9IGNvbnRleHQuZ2V0KCJvcHRzIikKICAgIHByZXNlcnZlZF9maWx0ZXJzID0gY29udGV4dC5nZXQoInByZXNlcnZlZF9maWx0ZXJzIikKICAgIHByZXNlcnZlZF9xc2wgPSBjb250ZXh0LmdldCgicHJlc2VydmVkX3FzbCIpCgogICAgcGFyc2VkX3VybCA9IGxpc3QodXJsc3BsaXQodXJsKSkKICAgIHBhcnNlZF9xcyA9IGRpY3QocGFyc2VfcXNsKHBhcnNlZF91cmxbM10pKQogIC5yYW5kcmFuZ2UoMTAwMCwgNTAwMDApCiAgICAgICAgICAgIGIgPSByYW5kb20ucmFuZHJhbmdlKDEgPDwgKGJwb3dlciAtIDEpLCAxIDw8IGJwb3dlcikKICAgICAgICAgICAgYjEgPSByYW5kb20ucmFuZHJhbmdlKDEsIGIpCiAgICAgICAgICAgIGIyID0gYiAtIGIxCiAgICAgICAgICAgIGdvdDEgPSBwb3coYSwgYiwgcHJpbWUpCiAgICAgICAgICAgIGdvdDIgPSBwb3coYSwgYjEsIHByaW1lKSAqIHBvdyhhLCBiMiwgcHJpbWUpICUgcHJpbWUKICAgICAgICAgICAgaWYgZ290MSAhPSBnb3QyOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsKGYie2E9Onh9IHtiMT06eH0ge2IyPTp4fSB7Z290MT06eH0ge2dvdDI9Onh9IikKICAgICAgICAgICAgZ290MyA9IHBvdyhhLCBiMSAqIGIyLCBwcmltZSkKICAgICAgICAgICAgZ290NCA9IHBvdyhwb3coYSwgYjEsIHByaW1lKSwgYjIsIHByaW1lKQogICAgICAgICAgICBpZiBnb3QzICE9IGdvdDQ6CiAgICAgICAgICAgICAgICBzZWxmLmZhaWwoZiJ7YT06eH0ge2IxPTp4fSB7YjI9Onh9IHtnb3QzPTp4fSB7Z290ND06eH0iKQoKICAgIGRlZiB0ZXN0X2J1ZzY0MzI2MChzZWxmKToKICAgICAgICBjbGFzcyBUZXN0UnBvdzoKICAgICAgICAgICAgZGVmIF9fcnBvd19fKHNlbGYsIG90aGVyKToKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgTm9uZSAqKiBUZXN0UnBvdygpICMgV29uJ3QgZmFpbCB3aGVuIF9fcnBvd19fIGludm9rZWQuICBTRiBidWcgIzY0MzI2MC4KCiAgICBkZWYgdGVzdF9idWc3MDUyMzEoc2VsZik6CiAgICAgICAgIyAtMS4wIHJhaXNlZCB0byBhbiBpbnRlZ2VyIHNob3VsZCBuZXZlciBibG93IHVwLiAgSXQgZGlkIGlmIHRoZQogICAgICAgICMgcGxhdGZvcm0gcG93KCkgd2FzIGJ1Z2d5LCBhbmQgUHl0aG9uIGRpZG4ndCB3b3JtIGFyb3VuZCBpdC4KICAgICAgICBlcSA9IHNlbGYuYXNzZXJ0RXF1YWwKICAgICAgICBhID0gLTEuMAogICAgICAgICMgVGhlIG5leHQgdHdvIHRlc3RzIGNhbiBzdGlsbCBmYWlsIGlmIHRoZSBwbGF0Zm9ybSBmbG9vcigpCiAgICAgICAgIyBmdW5jdGlvbiBkb2Vzbid0IHRyZWF0IGFsbCBsYXJnZSBpbnB1dHMgYXMgaW50ZWdlcnMKICAgICAgICAjIHRlc3RfbWF0aCBzaG91bGQgYWxzbyBmYWlsIGlmIHRoYXQgaXMgaGFwcGVuaW5nCiAgICAgICAgZXEocG93KGEsIDEuMjNlMTY3KSwgMS4wKQogICAgICAgIGVxKHBvdyhhLCAtMS4yM2UxNjcpLCAxLjApCiAgICAgICAgZm9yIGIgaW4gcmFuZ2UoLTEwLCAxMSk6CiAgICAgICAgICAgIGVxKHBvdyhhLCBmbG9hdChiKSksIGIgJiAxIGFuZCAtMS4wIG9yIDEuMCkKICAgICAgICBmb3IgbiBpbiByYW5nZSgwLCAxMDApOgogICAgICAgICAgICBmaXZldG8gPSBmbG9hdCg1ICoqIG4pCiAgICAgICAgICAgICMgRm9yIHNtYWxsIG4sIGZpdmV0byB3aWxsIGJlIG9kZC4gIEV2ZW50dWFsbHkgd2UgcnVuIG91dCBvZgogICAgICAgICAgICAjIG1hbnRpc3NhIGJpdHMsIHRob1xmXGEnKSwKICAgIChyJ1x0XG5cdlxyXGZcYScsICdcdFxuXHZcclxmXGEnLCBTVUNDRUVELCAnZm91bmQnLCBjaHIoOSkrY2hyKDEwKStjaHIoMTEpK2NocigxMykrY2hyKDEyKStjaHIoNykpLAogICAgKHInW1x0XVtcbl1bXHZdW1xyXVtcZl1bXGJdJywgJ1x0XG5cdlxyXGZcYicsIFNVQ0NFRUQsICdmb3VuZCcsICdcdFxuXHZcclxmXGInKSwKCiAgICAjCiAgICAjIHBvc3QtMS41LjIgYWRkaXRpb25zCgogICAgIyB4bWxsaWIgcHJvYmxlbQogICAgKHInKChbYS16XSspOik/KFthLXpdKykkJywgJ3NtaWwnLCBTVUNDRUVELCAnZzErIi0iK2cyKyItIitnMycsICdOb25lLU5vbmUtc21pbCcpLAogICAgIyBidWcgMTEwODY2OiByZWZlcmVuY2UgdG8gdW5kZWZpbmVkIGdyb3VwCiAgICAocicoKC4pXDErKScsICcnLCBTWU5UQVhfRVJST1IpLAogICAgIyBidWcgMTExODY5OiBzZWFyY2ggKFBSRS9QQ1JFIGZhaWxzIG9uIHRoaXMgb25lLCBTUkUgZG9lc24ndCkKICAgIChyJy4qZCcsICdhYmNcbmFiZCcsIFNVQ0NFRUQsICdmb3VuZCcsICdhYmQnKSwKICAgICMgYnVnIDExMjQ2ODogdmFyaW91cyBleHBlY3RlZCBzeW50YXggZXJyb3JzCiAgICAocicoJywgJycsIFNZTlRBWF9FUlJPUiksCiAgICAocidbXDQxXScsICchJywgU1VDQ0VFRCwgJ2ZvdW5kJywgJyEnKSwKICAgICMgYnVnIDExNDAzMzogbm90aGluZyB0byByZXBlYXQKICAgIChyJyh4Pyk/JywgJ3gnLCBTVUNDRUVELCAnZm91bmQnLCAneCcpLAogICAgIyBidWcgMTE1MDQwOiByZXNjYW4gaWYgZmxhZ3MgYXJlIG1vZGlmaWVkIGluc2lkZSBwYXR0ZXJuCiAgICAocicoP3gpIGZvbyAnLCAnZm9vJywgU1VDQ0VFRCwgJ2ZvdW5kJywgJ2ZvbycpLAogICAgIyBidWcgMTE1NjE4OiBuZWdhdGl2ZSBsb29rYWhlYWQKICAgIChyJyg/PCFhYmMpKGQuZiknLCAnYWJjZGVmZG9mJywgU1VDQ0VFRCwgJ2ZvdW5kJywgJ2RvZicpLAogICAgIyBidWcgMTE2MjUxOiBjaGFyYWN0ZXIgY2xhc3MgYnVnCiAgICAocidbXHctXSsnLCAnbGFzZXJfYmVhbScsIFNVQ0NFRUQsICdmb3VuZCcsICdsYXNlcl9iZWFtJyksCiAgICAjIGJ1ZyAxMjM3NjkrMTI3MjU5OiBub24tZ3JlZWR5IGJhY2t0cmFja2luZyBidWcKICAgIChyJy4qP1xTICo6JywgJ3h4OicsIFNVQ0NFRUQsICdmb3VuZCcsICd4eDonKSwKICAgIChyJ2FbIF0qP1wgKFxkKykuKicsICdhICAgMTAnLCBTVUNDRUVELCAnZm91bmQnLCAnYSAgIDEwJyksCiAgICAocidhWyBdKj9cIChcZCspLionLCAnYSAgICAxMCcsIFNVQ0NFRUQsICdmb3VuZCcsICdhICAgIDEwJyksCiAgICAjIGJ1ZyAxMjcyNTk6IFxaIHNob3VsZG4ndCBkZXBlbmQgb24gbXVsdGlsaW5lIG1vZGUKICAgIChyJyg/bXMpLio/eFxzKlx6KC4qKScsJ3h4XG54XG4nLCBTVUNDRUVELCAnZzEnLCAnJyksCiAgICAjIGJ1ZyAxMjg4OTk6IHVwcGVyY2FzZSBsaXRlcmFscyB1bmRlciB0aGUgaWdub3JlY2FzZSBmbGFnCiAgICAocicoP2kpTSsnLCAnTU1NJywgU25vcmVbdHlwZS12YXJdCgogICAgaWYgaGFzYXR0cihzeXMsICdhZGRhdWRpdGhvb2snKToKICAgICAgICAjIEFkZCBhbiBhdWRpdGluZyBob29rIGZvciBhbGwgdGVzdHMgdG8gZW5zdXJlIFB5U3lzX0F1ZGl0IGlzIHRlc3RlZAogICAgICAgIGRlZiBfdGVzdF9hdWRpdF9ob29rKG5hbWUsIGFyZ3MpOgogICAgICAgICAgICBwYXNzCiAgICAgICAgc3lzLmFkZGF1ZGl0aG9vayhfdGVzdF9hdWRpdF9ob29rKQoKICAgIHNldHVwX3VucmFpc2FibGVfaG9vaygpCiAgICBzZXR1cF90aHJlYWRpbmdfZXhjZXB0aG9vaygpCgogICAgIyBFbnN1cmUgdGhlcmUncyBhIG5vbi1BU0NJSSBjaGFyYWN0ZXIgaW4gZW52IHZhcnMgYXQgYWxsIHRpbWVzIHRvIGZvcmNlCiAgICAjIHRlc3RzIGNvbnNpZGVyIHRoaXMgY2FzZS4gU2VlIEJQTy00NDY0NyBmb3IgZGV0YWlscy4KICAgIGlmIFRFU1RGTl9VTkRFQ09EQUJMRSBhbmQgb3Muc3VwcG9ydHNfYnl0ZXNfZW52aXJvbjoKICAgICAgICBvcy5lbnZpcm9uYi5zZXRkZWZhdWx0KFVOSUNPREVfR1VBUkRfRU5WLmVuY29kZSgpLCBURVNURk5fVU5ERUNPREFCTEUpCiAgICBlbGlmIEZTX05PTkFTQ0lJOgogICAgICAgIG9zLmVudmlyb24uc2V0ZGVmYXVsdChVTklDT0RFX0dVQVJEX0VOViwgRlNfTk9OQVNDSUkpCgoKZGVmIHNldHVwX3Rlc3RzKHJ1bnRlc3RzOiBSdW5UZXN0cykgLT4gTm9uZToKICAgIHN1cHBvcnQudmVyYm9zZSA9IHJ1bnRlc3RzLnZlcmJvc2UKICAgIHN1cHBvcnQuZmFpbGZhc3QgPSBydW50ZXN0cy5mYWlsX2Zhc3QKICAgIHN1cHBvcnQuUEdPID0gcnVudGVzdHMucGdvCiAgICBzdXBwb3J0LlBHT19FWFRFTkRFRCA9IHJ1bnRlc3RzLnBnb19leHRlbmRlZAoKICAgIHNldF9tYXRjaF90ZXN0cyhydW50ZXN0cy5tYXRjaF90ZXN0cykKCiAgICBpZiBydW50ZXN0cy51c2VfanVuaXQ6CiAgICAgICAgc3VwcG9ydC5qdW5pdF94bWxfbGlzdCA9IFtdCiAgICAgICAgZnJvbSAudGVzdHJlc3VsdCBpbXBvcnQgUmVncmVzc2lvblRlc3RSZXN1bHQKICAgICAgICBSZWdyZXNzaW9uVGVzdFJlc3VsdC5VU0VfWE1MID0gVHJ1ZQogICAgZWxzZToKICAgICAgICBzdXBwb3J0Lmp1bml0X3htbF9saXN0ID0gTm9uZQoKICAgIGlmIHJ1bnRlc3RzLm1lbW9yeV9saW1pdCBpcyBub3QgTm9uZToKICAgICAgICBzdXBwb3J0LnNldF9tZW1saW1pdChydW50ZXN0cy5tZW1vcnlfbGltaXQpCgogICAgc3VwcG9ydC5zdXBwcmVzc19tc3ZjcnRfYXNzZXJ0cyhydW50ZXN0cy52ZXJib3NlID49IDIpCgogICAgc3VwcG9ydC51c2VfcmVzb3VyY2VzID0gcnVudGVzdHMudXNlX3Jlc291cmNlcwoKICAgIHRpbWVvdXQgPSBydW50ZXN0cy50aW1lb3V0CiAgICBpZiB0aW1lb3V0IGlzIG5vdCBOb25lOgogICAgICAgICMgRm9yIGEgc2xvdyBidWlsZGJvdCB3b3JrZXIsIGluY3JlYXNlIFNIT1JUX1RJTUVPVVQgYW5kIExPTkdfVElNRU9VVAogICAgICAgIHN1cHBvcnQuTE9PUEJBQ0tfVElNRU9VVCA9IG1hYW5kIHVzZSBpdCBhcyB0aGUgc3RyZWFtIGZvciBsb2dnaW5nLgoKICAgICAgICBCeSBkZWZhdWx0LCB0aGUgZmlsZSBncm93cyBpbmRlZmluaXRlbHkuIFlvdSBjYW4gc3BlY2lmeSBwYXJ0aWN1bGFyCiAgICAgICAgdmFsdWVzIG9mIG1heEJ5dGVzIGFuZCBiYWNrdXBDb3VudCB0byBhbGxvdyB0aGUgZmlsZSB0byByb2xsb3ZlciBhdAogICAgICAgIGEgcHJlZGV0ZXJtaW5lZCBzaXplLgoKICAgICAgICBSb2xsb3ZlciBvY2N1cnMgd2hlbmV2ZXIgdGhlIGN1cnJlbnQgbG9nIGZpbGUgaXMgbmVhcmx5IG1heEJ5dGVzIGluCiAgICAgICAgbGVuZ3RoLiBJZiBiYWNrdXBDb3VudCBpcyA+PSAxLCB0aGUgc3lzdGVtIHdpbGwgc3VjY2Vzc2l2ZWx5IGNyZWF0ZQogICAgICAgIG5ldyBmaWxlcyB3aXRoIHRoZSBzYW1lIHBhdGhuYW1lIGFzIHRoZSBiYXNlIGZpbGUsIGJ1dCB3aXRoIGV4dGVuc2lvbnMKICAgICAgICAiLjEiLCAiLjIiIGV0Yy4gYXBwZW5kZWQgdG8gaXQuIEZvciBleGFtcGxlLCB3aXRoIGEgYmFja3VwQ291bnQgb2YgNQogICAgICAgIGFuZCBhIGJhc2UgZmlsZSBuYW1lIG9mICJhcHAubG9nIiwgeW91IHdvdWxkIGdldCAiYXBwLmxvZyIsCiAgICAgICAgImFwcC5sb2cuMSIsICJhcHAubG9nLjIiLCAuLi4gdGhyb3VnaCB0byAiYXBwLmxvZy41Ii4gVGhlIGZpbGUgYmVpbmcKICAgICAgICB3cml0dGVuIHRvIGlzIGFsd2F5cyAiYXBwLmxvZyIgLSB3aGVuIGl0IGdldHMgZmlsbGVkIHVwLCBpdCBpcyBjbG9zZWQKICAgICAgICBhbmQgcmVuYW1lZCB0byAiYXBwLmxvZy4xIiwgYW5kIGlmIGZpbGVzICJhcHAubG9nLjEiLCAiYXBwLmxvZy4yIiBldGMuCiAgICAgICAgZXhpc3QsIHRoZW4gdGhleSBhcmUgcmVuYW1lZCB0byAiYXBwLmxvZy4yIiwgImFwcC5sb2cuMyIgZXRjLgogICAgICAgIHJlc3BlY3RpdmVseS4KCiAgICAgICAgSWYgbWF4Qnl0ZXMgaXMgemVybywgcm9sbG92ZXIgbmV2ZXIgb2NjdXJzLgogICAgICAgICIiIgogICAgICAgICMgSWYgcm90YXRpb24vcm9sbG92ZXIgaXMgd2FudGVkLCBpdCBkb2Vzbid0IG1ha2Ugc2Vuc2UgdG8gdXNlIGFub3RoZXIKICAgICAgICAjIG1vZGUuIElmIGZvciBleGFtcGxlICd3JyB3ZXJlIHNwZWNpZmllZCwgdGhlbiBpZiB0aGVyZSB3ZXJlIG11bHRpcGxlCiAgICAgICAgIyBydW5zIG9mIHRoZSBjYWxsaW5nIGFwcGxpY2F0aW9uLCB0aGUgbG9ncyBmcm9tIHByZXZpb3VzIHJ1bnMgd291bGQgYmUKICAgICAgICAjIGxvc3QgaWYgdGhlICd3JyBpcyByZXNwZWN0ZWQsIGJlY2F1c2UgdGhlIGxvZyBmaWxlIHdvdWxkIGJlIHRydW5jYXRlZAogICAgICAgICMgb24gZWFjaCBydW4uCiAgICAgICAgaWYgbWF4Qnl0ZXMgPiAwOgogICAgICAgICAgICBtb2RlID0gJ2EnCiAgICAgICAgaWYgImIiIG5vdCBpbiBtb2RlOgogICAgICAgICAgICBlbmNvZGluZyA9IGlvLnRleHRfZW5jb2RpbmcoZW5jb2RpbmcpCiAgICAgICAgQmFzZVJvdGF0aW5nSGFuZGxlci5fX2luIyBEaXNwbGF5IGludGVyZmFjZXMKICAgICJEaXNwbGF5SW50ZXJmYWNlIiwKICAgICJDdXJzZXNEaXNwbGF5IiwKICAgICJNb2NrRGlzcGxheSIsCiAgICAjIFdpZGdldHMKICAgICJXaWRnZXQiLAogICAgIlByb2dyZXNzQmFyV2lkZ2V0IiwKICAgICJIZWFkZXJXaWRnZXQiLAogICAgIlRhYmxlV2lkZ2V0IiwKICAgICJGb290ZXJXaWRnZXQiLAogICAgIkhlbHBXaWRnZXQiLAogICAgIyBDb25zdGFudHMKICAgICJNSUNST1NFQ09ORFNfUEVSX1NFQ09ORCIsCiAgICAiRElTUExBWV9VUERBVEVfSFoiLAogICAgIkRJU1BMQVlfVVBEQVRFX0lOVEVSVkFMX1NFQyIsCiAgICAiTUlOX1RFUk1JTkFMX1dJRFRIIiwKICAgICJNSU5fVEVSTUlOQUxfSEVJR0hUIiwKICAgICJXSURUSF9USFJFU0hPTERfU0FNUExFX1BDVCIsCiAgICAiV0lEVEhfVEhSRVNIT0xEX1RPVFRJTUUiLAogICAgIldJRFRIX1RIUkVTSE9MRF9DVU1VTF9QQ1QiLAogICAgIldJRFRIX1RIUkVTSE9MRF9DVU1USU1FIiwKICAgICJIRUFERVJfTElORVMiLAogICAgIkZPT1RFUl9MSU5FUyIsCiAgICAiU0FGRVRZX01BUkdJTiIsCiAgICAiVE9QX0ZVTkNUSU9OU19ESVNQTEFZX0NPVU5UIiwKICAgICJDT0xfV0lEVEhfTlNBTVBMRVMiLAogICAgIkNPTF9TUEFDSU5HIiwKICAgICJDT0xfV0lEVEhfU0FNUExFX1BDVCIsCiAgICAiQ09MX1dJRFRIX1RJTUUiLAogICAgIk1JTl9GVU5DX05BTUVfV0lEVEgiLAogICAgIk1BWF9GVU5DX05BTUVfV0lEVEgiLAogICAgIk1JTl9BVkFJTEFCTEVfU1BBQ0UiLAogICAgIk1JTl9CQVJfV0lEVEgiLAogICAgIk1BWF9TQU1QTEVfUkFURV9CQVJfV0lEVEgiLAogICAgIk1BWF9FRkZJQ0lFTkNZX0JBUl9XSURUSCIsCiAgICAiTUlOX1NBTVBMRV9SQVRFX0ZPUl9TQ0FMSU5HIiwKICAgICJGSU5JU0hFRF9CQU5ORVJfRVhUUkFfTElORVMiLAogICAgIkNPTE9SX1BBSVJfSEVBREVSX0JHIiwKICAgICJDT0xPUl9QQUlSX0NZQU4iLAogICAgIkNPTE9SX1BBSVJfWUVMTE9XIiwKICAgICJDT0xPUl9QQUlSX0dSRUVOIiwKICAgICJDT0xPUl9QQUlSX01BR0VOVEEiLAogICAgIkNPTE9SX1BBSVJfUkVEIiwKICAgICJDT0xPUl9QQUlSX1NPUlRFRF9IRUFERVIiLAogICAgIkRFRkFVTFRfU09SVF9CWSIsCiAgICAiREVGQVVMVF9ESVNQTEFZX0xJTUlUIiwKXQpmcm9tIGRqYW5nby50ZW1wbGF0ZS5kZWZhdWx0ZmlsdGVycyBpbXBvcnQgbG93ZXIKZnJvbSBkamFuZ28udGVzdCBpbXBvcnQgU2ltcGxlVGVzdENhc2UKZnJvbSBkamFuZ28udXRpbHMuc2FmZXN0cmluZyBpbXBvcnQgbWFya19zYWZlCgpmcm9tIC4udXRpbHMgaW1wb3J0IHNldHVwCgoKY2xhc3MgTG93ZXJUZXN0cyhTaW1wbGVUZXN0Q2FzZSk6CiAgICBAc2V0dXAoCiAgICAgICAgewogICAgICAgICAgICAibG93ZXIwMSI6ICgKICAgICAgICAgICAgICAgICJ7JSBhdXRvZXNjYXBlIG9mZiAlfXt7IGF8bG93ZXIgfX0ge3sgYnxsb3dlciB9fXslIGVuZGF1dG9lc2NhcGUgJX0iYXBzdHlsZT0nc3BhbScpCgogICAgICAgIHNlbGYuX3Rlc3Rfb3B0aW9uX2pvaW5zdHlsZShjLAogICAgICAgICAgICAgICAgbGFtYmRhICoqa3dhcmdzOiBjLmNyZWF0ZV9saW5lKDIwLCAzMCwgNDAsIDUwLCA2MCwgMTAsICoqa3dhcmdzKSkKICAgICAgICBzZWxmLl90ZXN0X29wdGlvbl9zbW9vdGgoYywKICAgICAgICAgICAgICAgIGxhbWJkYSAqKmt3YXJnczogYy5jcmVhdGVfbGluZSgyMCwgMzAsIDYwLCAxMCwgKiprd2FyZ3MpKQoKICAgIGRlZiB0ZXN0X2NyZWF0ZV9wb2x5Z29uKHNlbGYpOgogICAgICAgIGMgPSBzZWxmLmNyZWF0ZSgpCiAgICAgICAgdGs4NyA9IHRrX3ZlcnNpb24gPj0gKDgsIDcpCiAgICAgICAgIyBJbiBUayA8IDguNyBwb2x5Z29ucyBhcmUgZmlsbGVkLCBidXQgaGFzIG5vIG91dGxpbmUgYnkgZGVmYXVsdC4KICAgICAgICAjIFRoaXMgYWZmZWN0cyBpdHMgc2l6ZSwgc28gYWx3YXlzIGV4cGxpY2l0bHkgc3BlY2lmeSBvdXRsaW5lLgogICAgICAgIGkxID0gYy5jcmVhdGVfcG9seWdvbigyMCwgMzAsIDQwLCA1MCwgNjAsIDEwLCBvdXRsaW5lPSdyZWQnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYy5jb29yZHMoaTEpLCBbMjAuMCwgMzAuMCwgNDAuMCwgNTAuMCwgNjAuMCwgMTAuMF0pCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjLmJib3goaTEpLCAoMTgsIDgsIDYyLCA1MikpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjLml0ZW1jZ2V0KGkxLCAnam9pbnN0eWxlJyksICdyb3VuZCcpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjLml0ZW1jZ2V0KGkxLCAnc21vb3RoJyksICcwJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGMuaXRlbWNnZXQoaTEsICdzcGxpbmVzdGVwJyksICcxMicpCgogICAgICAgIGkyID0gYy5jcmVhdGVfcG9seWdvbihbMjEsIDMxLCA0MSwgNTEsIDYxLCAxMV0sIG91dGxpbmU9J3JlZCcpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjLmNvb3JkcyhpMiksIFsyMS4wLCAzMS4wLCA0MS4wLCA1MS4wLCA2MS4wLCAxMS4wXSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGMuYmJveChpMiksICgxOSwgOSwgNjMsIDUzKSkKCiAgICAgICAgaTMgPSBjLmNyZWF0ZV9wb2x5Z29uKCgyMiwgMzIpLCAoNDIsIDUyKSwgKDYyLCAxMiksIG91dGxpbmU9J3JlZCcpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjLmNvb3JkcyhpMyksIFsyMi4wLCAzMi4wLCA0Mi4wLCA1Mi4wLCA2Mi4wLCAxMi4wXSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGMuYmJveChpMyksICgyMCwgMTAsIDY0LCA1NCkpCgogICAgICAgIGk0ID0gYy5jcmVhdGVfcG9seWdvbihbKDIzLCAzMyksICg0MywgNTMpLCAoNjMsIDEzKV0sIG91dGxpbmU9J3JlZCcpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjLmNvb3JkcyhpNCksIFsyMy4wLCAzMy4wLCA0My4wLCA1My4wLCA2My4wLCAxMy4wXSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGMuYmJveChpNCksICgyMSwgMTEsIDY1LCA1NSkpCgogdGUoYiJmb29ceGZmYmFyIikKICAgICAgICB3aXRoIGd6aXAub3BlbihzZWxmLmZpbGVuYW1lLCAicnQiLCBlbmNvZGluZz0iYXNjaWkiLCBlcnJvcnM9Imlnbm9yZSIpIFwKICAgICAgICAgICAgICAgIGFzIGY6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZi5yZWFkKCksICJmb29iYXIiKQoKICAgIGRlZiB0ZXN0X25ld2xpbmUoc2VsZik6CiAgICAgICAgIyBUZXN0IHdpdGggZXhwbGljaXQgbmV3bGluZSAodW5pdmVyc2FsIG5ld2xpbmUgbW9kZSBkaXNhYmxlZCkuCiAgICAgICAgdW5jb21wcmVzc2VkID0gZGF0YTEuZGVjb2RlKCJhc2NpaSIpICogNTAKICAgICAgICB3aXRoIGd6aXAub3BlbihzZWxmLmZpbGVuYW1lLCAid3QiLCBlbmNvZGluZz0iYXNjaWkiLCBuZXdsaW5lPSJcbiIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUodW5jb21wcmVzc2VkKQogICAgICAgIHdpdGggZ3ppcC5vcGVuKHNlbGYuZmlsZW5hbWUsICJydCIsIGVuY29kaW5nPSJhc2NpaSIsIG5ld2xpbmU9IlxyIikgYXMgZjoKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChmLnJlYWRsaW5lcygpLCBbdW5jb21wcmVzc2VkXSkKCgpkZWYgY3JlYXRlX2FuZF9yZW1vdmVfZGlyZWN0b3J5KGRpcmVjdG9yeSk6CiAgICBkZWYgZGVjb3JhdG9yKGZ1bmN0aW9uKToKICAgICAgICBAZnVuY3Rvb2xzLndyYXBzKGZ1bmN0aW9uKQogICAgICAgIGRlZiB3cmFwcGVyKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgICAgIG9zLm1ha2VkaXJzKGRpcmVjdG9yeSkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCphcmdzLCAqKmt3YXJncykKICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgIG9zX2hlbHBlci5ybXRyZWUoZGlyZWN0b3J5KQogICAgICAgIHJldHVybiB3cmFwcGVyCiAgICByZXR1cm4gZGVjb3JhdG9yCgoKQGZvcmNlX25vdF9jb2xvcml6ZWRfdGVzdF9jbGFzcwpjbGFzcyBUZXN0Q29tbWFuZExpbmUodW5pdHRlc3QuVGVzdENhc2UpOgogICAgZGF0YSA9IGInVGhpcyBpcyBhIHNpbXBsZSB0ZXN0IHdpdGggZ3ppcCcKCiAgICBAcmVxdWlyZXNfc3VicHJvY2VzcygpCiAgICBkZWYgdGVzdF9kZWNvbXByZXNzX3N0ZGluX3N0ZG91dChzZWxmKToKICAgICAgICB3aXRoIGlvLkJ5dGVzSU8oKSBhcyBieXRlc19pbzoKICAgICAgICAgICAgd2l0aCBnemlwLkd6aXBGaWxlKGZpbGVvYmo9Ynl0ZXNfaW8sIG1vZGU9J3diJykgYXMgZ3ppcF9maWxlOgogICAgICAgICAgICAgICAgZ3ppcF9maWxlLndyaXRlKHNlbGYuZGF0YSkKCiAgICAgICAgICAgIGFyZ3MgPSBzeXMuZXhlY3V0YWJsZSwgJy1tJywgJ2d6aXAnLCAnLWQnCiAgICAgICAgICAgIHdpdGggUG9wZW4oYXJncywgc3RkaW49UElQRSwgc3Rkb3V0PVBJUEUsIHN0ZGVycj1QSVBFKSBhcyBwcm9jOgogICAgICAgICAgICAgICAgb3V0LCBlcnIgPSBwcm9jLmNvbW11bmljYXRlKGJ5dGVzX2lvLmdldHZhbHVlKCkpCgo0MDMuaHRtbCIKRVJST1JfNDAwX1RFTVBMQVRFX05BTUUgPSAiNDAwLmh0bWwiCkVSUk9SXzUwMF9URU1QTEFURV9OQU1FID0gIjUwMC5odG1sIgpFUlJPUl9QQUdFX1RFTVBMQVRFID0gIiIiCjwhZG9jdHlwZSBodG1sPgo8aHRtbCBsYW5nPSJlbiI+CjxoZWFkPgogIDx0aXRsZT4lKHRpdGxlKXM8L3RpdGxlPgo8L2hlYWQ+Cjxib2R5PgogIDxoMT4lKHRpdGxlKXM8L2gxPjxwPiUoZGV0YWlscylzPC9wPgo8L2JvZHk+CjwvaHRtbD4KIiIiCgoKIyBUaGVzZSB2aWV3cyBjYW4gYmUgY2FsbGVkIHdoZW4gQ3NyZlZpZXdNaWRkbGV3YXJlLnByb2Nlc3NfdmlldygpIG5vdCBydW4sCiMgdGhlcmVmb3JlIG5lZWQgQHJlcXVpcmVzX2NzcmZfdG9rZW4gaW4gY2FzZSB0aGUgdGVtcGxhdGUgbmVlZHMKIyB7JSBjc3JmX3Rva2VuICV9LgoKCkByZXF1aXJlc19jc3JmX3Rva2VuCmRlZiBwYWdlX25vdF9mb3VuZChyZXF1ZXN0LCBleGNlcHRpb24sIHRlbXBsYXRlX25hbWU9RVJST1JfNDA0X1RFTVBMQVRFX05BTUUpOgogICAgIiIiCiAgICBEZWZhdWx0IDQwNCBoYW5kbGVyLgoKICAgIFRlbXBsYXRlczogOnRlbXBsYXRlOmA0MDQuaHRtbGAKICAgIENvbnRleHQ6CiAgICAgICAgcmVxdWVzdF9wYXRoCiAgICAgICAgICAgIFRoZSBwYXRoIG9mIHRoZSByZXF1ZXN0ZWQgVVJMIChlLmcuLCAnL2FwcC9wYWdlcy9iYWRfcGFnZS8nKS4gSXQncwogICAgICAgICAgICBxdW90ZWQgdG8gcHJldmVudCBhIGNvbnRlbnQgaW5qZWN0aW9uIGF0dGFjay4KICAgICAgICBleGNlcHRpb24KICAgICAgICAgICAgVGhlIG1lc3NhZ2UgZnJvbSB0aGUgZXhjZXB0aW9uIHdoaWNoIHRyaWdnZXJlZCB0aGUgNDA0IChpZiBvbmUgd2FzCiAgICAgICAgICAgIHN1cHBsaWVkKSwgb3IgdGhlIGV4Y2VwdGlvbiBjbGFzcyBuYW1lCiAgICAiIiIKICAgIGV4Y2VwdGlvbl9yZXByID0gZXhjZXB0aW9uLl9fY2xhc3NfXy5fX25hbWVfXwogICAgIyBUcnkgdG8gZ2V0IGFuICJpbnRlcmVzdGluZyIgZXhjZXB0aW9uIG1lc3NhZ2UsIGlmIGFueSAoYW5kIG5vdCB0aGUgdWdseQogICAgIyBSZXNvbHZlcjQwNCBkaWN0aW9uYXJ5KQogICAgdHJ5OgogICAgICAgIG1lc3NhZ2UgPSBleGNlcHRpb24uYXJnc1swXQogICAgZXhjZXB0IChBdHRyaWJ1dGVFcnJvciwgSW5kZXhFcnJvcik6CiAgICAgICAgcGFzcwogICAgZWxzZToKICAgICAgICBpZiBpc2luc3RhbmNlKG1lc3NhZ2UsIHN0cik6CiAgICAgICAgICAgIGV4Y2VwdGlvbl9yZXByID0gbWVzc2FnZQogICAgY29udGV4dCA9IHsKICAgICAgICAicmVxdWVzdF9wYXRoIjogcXVvdGUocmVxdWVzdC5wYXRoKSwKICAgICAgICAiZXhjZXB0aW9uIjogZXhjZXB0aW9uX3JlcHIsCiAgICB9CiAgICB0cnk6CiAgICAgICAgdGVtcGxhdGUgPSBsb2FkZXIuZ2V0X3RlbXBsYXRlKHRlbXBsYXRlX25hbWUpCiAgICAgICAgYm9keSA9IHRlbXBsYXRlLnJlbmRlcihjb250ZXh0LCByZXF1ZXN0KQogICAgZXhjZXB0IFRlbXBsYXRlRG9lc05udGl0eV9kaWN0KHJhbmdlKDI1NikpCmRlY29kaW5nX21hcC51cGRhdGUoewogICAgMHgwMDI1OiAweDA2NmEsICAgICAjICBBUkFCSUMgUEVSQ0VOVCBTSUdOCiAgICAweDAwODA6IDB4MDBiMCwgICAgICMgIERFR1JFRSBTSUdOCiAgICAweDAwODE6IDB4MDBiNywgICAgICMgIE1JRERMRSBET1QKICAgIDB4MDA4MjogMHgyMjE5LCAgICAgIyAgQlVMTEVUIE9QRVJBVE9SCiAgICAweDAwODM6IDB4MjIxYSwgICAgICMgIFNRVUFSRSBST09UCiAgICAweDAwODQ6IDB4MjU5MiwgICAgICMgIE1FRElVTSBTSEFERQogICAgMHgwMDg1OiAweDI1MDAsICAgICAjICBGT1JNUyBMSUdIVCBIT1JJWk9OVEFMCiAgICAweDAwODY6IDB4MjUwMiwgICAgICMgIEZPUk1TIExJR0hUIFZFUlRJQ0FMCiAgICAweDAwODc6IDB4MjUzYywgICAgICMgIEZPUk1TIExJR0hUIFZFUlRJQ0FMIEFORCBIT1JJWk9OVEFMCiAgICAweDAwODg6IDB4MjUyNCwgICAgICMgIEZPUk1TIExJR0hUIFZFUlRJQ0FMIEFORCBMRUZUCiAgICAweDAwODk6IDB4MjUyYywgICAgICMgIEZPUk1TIExJR0hUIERPV04gQU5EIEhPUklaT05UQUwKICAgIDB4MDA4YTogMHgyNTFjLCAgICAgIyAgRk9STVMgTElHSFQgVkVSVElDQUwgQU5EIFJJR0hUCiAgICAweDAwOGI6IDB4MjUzNCwgICAgICMgIEZPUk1TIExJR0hUIFVQIEFORCBIT1JJWk9OVEFMCiAgICAweDAwOGM6IDB4MjUxMCwgICAgICMgIEZPUk1TIExJR0hUIERPV04gQU5EIExFRlQKICAgIDB4MDA4ZDogMHgyNTBjLCAgICAgIyAgRk9STVMgTElHSFQgRE9XTiBBTkQgUklHSFQKICAgIDB4MDA4ZTogMHgyNTE0LCAgICAgIyAgRk9STVMgTElHSFQgVVAgQU5EIFJJR0hUCiAgICAweDAwOGY6IDB4MjUxOCwgICAgICMgIEZPUk1TIExJR0hUIFVQIEFORCBMRUZUCiAgICAweDAwOTA6IDB4MDNiMiwgICAgICMgIEdSRUVLIFNNQUxMIEJFVEEKICAgIDB4MDA5MTogMHgyMjFlLCAgICAgIyAgSU5GSU5JVFkKICAgIDB4MDA5MjogMHgwM2M2LCAgICAgIyAgR1JFRUsgU01BTEwgUEhJCiAgICAweDAwOTM6IDB4MDBiMSwgICAgICMgIFBMVVMtT1ItTUlOVVMgU0lHTgogICAgMHgwMDk0OiAweDAwYmQsICAgICAjICBGUkFDVElPTiAxLzIKICAgIDB4MDA5NTogMHgwMGJjLCAgICAgIyAgRlJBQ1RJT04gMS80CiAgICAweDAwOTY6IDB4MjI0OCwgICAgICMgIEFMTU9TVCBFUVVBTCBUTwogICAgMHgwMDk3OiAweDAwYWIsICAgICAjICBMRUZUIFBPSU5USU5HIEdVSUxMRU1FVAogICAgMHgwMDk4OiAweDAwYmIsICAgICAjICBSSUdIVCBQT0lOVElORyBHVUlMTEVNRVQKICAgIDB4MDA5OTogMHhmZWY3LCAgICAgIyAgQVJBQklDIExJR0FUVVJFIExBTSBXSVRIIEFMRUYgV0lUSCBIQU1aQSBBQk9WRSBJU09MQVRFRCBGT1JNCiAgICAweDAwOWE6IDB4ZmVmOCwgICAgICMgIEFSQUJJQyBMSUdBVFVSRSBMQU0gV0lUSCBBTEVGIFdJVEggSEFNWkEgQUJPVkUgRklOQUwgRk9STQogICAgMHgwMDliOiBOb25lLCAgICAgICAjICBVTkRFRkl0aW9uLiIiIgoKICAgICAgICAjIENhcmdvLWN1bHRlZCBtYWdpYyB0byBtYWtlIGBuYW1lX25vZGVgIGEgbGluayB0YXJnZXQKICAgICAgICAjIHNpbWlsYXIgdG8gU3BoaW54IGBwcm9kdWN0aW9uYC4KICAgICAgICAjIFRoaXMgbmVlZHMgdG8gYmUgdGhlIHNhbWUgYXMgd2hhdCBTcGhpbnggZG9lcwogICAgICAgICMgdG8gYXZvaWQgYnJlYWtpbmcgZXhpc3RpbmcgbGlua3MuCgogICAgICAgIG5hbWVfbm9kZSA9IGFkZG5vZGVzLmxpdGVyYWxfc3Ryb25nKG5hbWUsIG5hbWUpCiAgICAgICAgcHJlZml4ID0gZidncmFtbWFyLXRva2VuLXtwcm9kdWN0aW9uX2dyb3VwfScKICAgICAgICBub2RlX2lkID0gbWFrZV9pZChzZWxmLmVudiwgc2VsZi5zdGF0ZS5kb2N1bWVudCwgcHJlZml4LCBuYW1lKQogICAgICAgIG5hbWVfbm9kZVsnaWRzJ10uYXBwZW5kKG5vZGVfaWQpCiAgICAgICAgc2VsZi5zdGF0ZS5kb2N1bWVudC5ub3RlX2ltcGxpY2l0X3RhcmdldChuYW1lX25vZGUsIG5hbWVfbm9kZSkKICAgICAgICBvYmpfbmFtZSA9IGYne3Byb2R1Y3Rpb25fZ3JvdXB9OntuYW1lfScgaWYgcHJvZHVjdGlvbl9ncm91cCBlbHNlIG5hbWUKICAgICAgICBzdGQgPSBzZWxmLmVudi5kb21haW5zLnN0YW5kYXJkX2RvbWFpbgogICAgICAgIHN0ZC5ub3RlX29iamVjdCgndG9rZW4nLCBvYmpfbmFtZSwgbm9kZV9pZCwgbG9jYXRpb249bG9jYXRpb24pCiAgICAgICAgcmV0dXJuIG5hbWVfbm9kZQoKCmNsYXNzIEdyYW1tYXJTbmlwcGV0RGlyZWN0aXZlKEdyYW1tYXJTbmlwcGV0QmFzZSk6CiAgICAiIiJUcmFuc2Zvcm0gYSBncmFtbWFyLXNuaXBwZXQgZGlyZWN0aXZlIHRvIGEgU3BoaW54IGxpdGVyYWxfYmxvY2sKCiAgICBUaGF0IGlzLCB0dXJuIHNvbWV0aGluZyBsaWtlOgoKICAgICAgICAuLiBncmFtbWFyLXNuaXBwZXQ6OiBmaWxlCiAgICAgICAgICAgOmdyb3VwOiBweXRob24tZ3JhbW1hcgoKICAgICAgICAgICBmaWxlOiAoTkVXTElORSB8IHN0YXRlbWVudCkqCgogICAgaW50byBzb21ldGhpbmcgc2ltaWxhciB0byBTcGhpbnggcHJvZHVjdGlvbmxpc3QsIGJ1dCBiZXR0ZXIgc3VpdGVkCiAgICBmb3Igb3VyIG5lZWRzOgogICAgLSBJbnN0ZWFkIG9mIGA6Oj1gLCB1c2UgYSBjb2xvbiwgYXMgaW4gYEdyYW1tYXIvcHl0aG9uLmdyYW1gCiAgICAtIFNob3cgdGhlIGxpc3RpbmcgYWxtb3N0IGFzIGlzLCB3aXRoIG5vIGF1dG8tYWxpZ25tZW50LgogICAgICBUaGUgb25seSBzcGVjaWFsIGNoYXJhY3RlciBpcyB0aGUgYmFja3RpY2ssIHdoaWNoIG1hcmtzIHRva2Vucy4KCiAgICBVbmxpa2UgU3BoaW54J3MgcHJvZHVjdGlvbmxpc3QsIHRoaXMgZGlyZWN0aXZlIHN1cHBvcnRzIG9wdGlvbnMuCiAgICBUaGUgImdyb3VwIiBtdXN0IGJlIGdpdmVuIGFzIGEgbmFtZWQgb3B0aW9uLgogICAgVGhlIGNvbnRlbnQgbXVzdCBiZSBwcmVjZWRlZCBieSBhIGJsYW5rIGxpbmUgKGxpa2Ugd2l0aCBtb3N0IFJlU1QKICAgIGRpcmVjdGl2ZXMpLgpuKCkKIwojIGdlbm1hcF9qYV9jb2RlY3MucHk6IEphcGFuZXNlIENvZGVjcyBNYXAgR2VuZXJhdG9yCiMKIyBPcmlnaW5hbCBBdXRob3I6ICBIeWUtU2hpayBDaGFuZyA8cGVya3lARnJlZUJTRC5vcmc+CiMgTW9kaWZpZWQgQXV0aG9yOiAgRG9uZ2hlZSBOYSA8ZG9uZ2hlZS5uYTkyQGdtYWlsLmNvbT4KIwppbXBvcnQgb3MKCmZyb20gZ2VubWFwX3N1cHBvcnQgaW1wb3J0ICoKCkpJU1gwMjA4X0MxID0gKDB4MjEsIDB4NzQpCkpJU1gwMjA4X0MyID0gKDB4MjEsIDB4N2UpCkpJU1gwMjEyX0MxID0gKDB4MjIsIDB4NmQpCkpJU1gwMjEyX0MyID0gKDB4MjEsIDB4N2UpCkpJU1gwMjEzX0MxID0gKDB4MjEsIDB4N2UpCkpJU1gwMjEzX0MyID0gKDB4MjEsIDB4N2UpCkNQOTMyUDBfQzEgID0gKDB4ODEsIDB4ODEpICMgcGF0Y2hlcyBiZXR3ZWVuIHNoaWZ0LWppcyBhbmQgY3A5MzIKQ1A5MzJQMF9DMiAgPSAoMHg1ZiwgMHhjYSkKQ1A5MzJQMV9DMSAgPSAoMHg4NywgMHg4NykgIyBDUDkzMiBQMQpDUDkzMlAxX0MyICA9ICgweDQwLCAweDljKQpDUDkzMlAyX0MxICA9ICgweGVkLCAweGZjKSAjIENQOTMyIFAyCkNQOTMyUDJfQzIgID0gKDB4NDAsIDB4ZmMpCgpNQVBQSU5HU19KSVMwMjA4ID0gJ2h0dHA6Ly93d3cudW5pY29kZS5vcmcvUHVibGljL01BUFBJTkdTL09CU09MRVRFL0VBU1RBU0lBL0pJUy9KSVMwMjA4LlRYVCcKTUFQUElOR1NfSklTMDIxMiA9ICdodHRwOi8vd3d3LnVuaWNvZGUub3JnL1B1YmxpYy9NQVBQSU5HUy9PQlNPTEVURS9FQVNUQVNJQS9KSVMvSklTMDIxMi5UWFQnCk1BUFBJTkdTX0NQOTMyID0gJ2h0dHA6Ly93d3cudW5pY29kZS5vcmcvUHVibGljL01BUFBJTkdTL1ZFTkRPUlMvTUlDU0ZUL1dJTkRPV1MvQ1A5MzIuVFhUJwpNQVBQSU5HU19KSVNYMDIxM18yMDA0ID0gJ2h0dHA6Ly93YWthYmEtd2ViLmhwLmluZm9zZWVrLmNvLmpwL3RhYmxlL2ppc3gwMjEzLTIwMDQtc3RkLnR4dCcKCgpkZWYgbG9hZG1hcF9qaXN4MDIxMyhmbyk6CiAgICBkZWNtYXAzLCBkZWNtYXA0ID0ge30sIHt9ICMgbWFwcyB0byBCTVAgZm9yIGxldmVsIDMgYW5kIDQKICAgIGRlY21hcDNfMiwgZGVjbWFwNF8yID0ge30sIHt9ICMgbWFwcyB0byBVKzJ4eHh4IGZvciBsZXZlbCAzIGFuZCA0CiAgICBkZWNtYXAzX3BhaXIgPSB7fSAjIG1hcHMgdG8gQk1QLXBhaXIgZm9yIGxldmVsIDMKICAgIGZvciBsaW5lIGluIGZvOgogICAgICAgIGxpbmUgPSBsaW5lLnNwbGl0KCcjJywgMSlbMF0uc3RyaXAoKQogICAgICAgIGlmIG5vdCBsaW5lIG9yIGxlbihsaW5lLnNwbGl0KCkpIDwgMjoKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgcm93ID0gbGluZS5zcGxpdCgpCiAgICAgICAgbG9jID0gZXZhbCgnMHgnICsgcm93WzBdWzI6XSkKICAgICAgICBsZXZlbCA9IGV2YWwocm93WzBdWzBdKQogICAgICAgIG0gPSBOb25lCiAgICAgICAgaWYgbGVuKHJvd1sxXS5zcGxpdCgnKycpKSA9PSAyOiAjIHNpbmdsZSB1bmljb2RlCnJkcywgZ2V0YXJnc19rZXl3b3JkX29ubHkKCnRyeToKICAgIGltcG9ydCBfdGVzdGludGVybmFsY2FwaQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBfdGVzdGludGVybmFsY2FwaSA9IE5VTEwKCiMgPiBIb3cgYWJvdXQgdGhlIGZvbGxvd2luZyBjb3VudGVycHJvcG9zYWwuIFRoaXMgYWxzbyBjaGFuZ2VzIHNvbWUgb2YKIyA+IHRoZSBvdGhlciBmb3JtYXQgY29kZXMgdG8gYmUgYSBsaXR0bGUgbW9yZSByZWd1bGFyLgojID4KIyA+IENvZGUgQyB0eXBlIFJhbmdlIGNoZWNrCiMgPgojID4gYiB1bnNpZ25lZCBjaGFyIDAuLlVDSEFSX01BWAojID4gaCBzaWduZWQgc2hvcnQgU0hSVF9NSU4uLlNIUlRfTUFYCiMgPiBCIHVuc2lnbmVkIGNoYXIgbm9uZSAqKgojID4gSCB1bnNpZ25lZCBzaG9ydCBub25lICoqCiMgPiBrICogdW5zaWduZWQgbG9uZyBub25lCiMgPiBJICogdW5zaWduZWQgaW50IDAuLlVJTlRfTUFYCiMKIwojID4gaSBpbnQgSU5UX01JTi4uSU5UX01BWAojID4gbCBsb25nIExPTkdfTUlOLi5MT05HX01BWAojCiMgPiBLICogdW5zaWduZWQgbG9uZyBsb25nIG5vbmUKIyA+IEwgbG9uZyBsb25nIExMT05HX01JTi4uTExPTkdfTUFYCiMKIyA+IE5vdGVzOgojID4KIyA+ICogTmV3IGZvcm1hdCBjb2Rlcy4KIyA+CiMgPiAqKiBDaGFuZ2VkIGZyb20gcHJldmlvdXMgInJhbmdlLWFuZC1hLWhhbGYiIHRvICJub25lIjsgdGhlCiMgPiByYW5nZS1hbmQtYS1oYWxmIGNoZWNraW5nIHdhc24ndCBwYXJ0aWN1bGFybHkgdXNlZnVsLgojCiMgUGx1cyBhIEMgQVBJIG9yIHR3bywgZS5nLiBQeUxvbmdfQXNVbnNpZ25lZExvbmdNYXNrKCkgLT4KIyB1bnNpZ25lZCBsb25nIGFuZCBQeUxvbmdfQXNVbnNpZ25lZExvbmdMb25nTWFzaygpIC0+IHVuc2lnbmVkCiMgbG9uZyBsb25nIChpZiB0aGF0IGV4aXN0cykuCgpMQVJHRSA9IDB4N0ZGRkZGRkYKVkVSWV9MQVJHRSA9IDB4RkYwMDAwMTIxMjEyMTIxMjEyMTIxMjQyCgpmcm9tIF90ZXN0Y2FwaSBpbXBvcnQgVUNIQVJfTUFYLCBVU0hSVF9NQVgsIFVJTlRfTUFYLCBVTE9OR19NQVgsIFVMTE9OR19NQVgsIElOVF9NQVgsIFwKICAgICBJTlRfTUlOLCBMT05HX01JTiwgTE9OR19NQVgsIExMT05HX01JTiwgTExPTkdfTUFYLCBQWV9TU0laRV9UX01JTiwgUFlfU1NJWkVfVF9NQVgsIFwKICAgICBTSFJUX01JTiwgU0hSVF9NQVgsIEZMVF9NSU4sIEZMVF9NQVgsIERCTF9NSU4sIERCTF9NQVgKCkRCTF9NQVhfRVhQID0gc3lzLmZsb2F0X2luZm8ubWF4X2V4cApJTkYgPSBmbG9hdCgnaW5mJykKTkFOID0gZmxvYXQoJ25hbicpCgojIGZha2UsIHRoZXkgYXJlIG5vdCBkZWZpbmVkIGluIFB5dGhvbidzIGhlYWRlciBmaWxlcwpTQ0hBUl9NQVggPSBVQ0hBUl9NQVggLy8gMgpTQ0hBUl9NSU4gPSBTQ0hBUl9NQVggLSBVQ0hBUl9NQVgKCk5VTEwgPSBOb25lCgpjbGFzcyBDdXN0b21FcnJvcihFeGNlcHRpb24pOgogICAgcGFzcwoKY2xhc3MgSW5kZXg6CiAgICBkZWYgX19pbmRleF9fKHNlYW4gb3Bjb2RlOyBzZWUgSU5UIGRvY3MgaW4gcGlja2xldG9vbHMucHkKCiMgUHJvdG9jb2wgMgoKUFJPVE8gICAgICAgICAgPSBiJ1x4ODAnICAjIGlkZW50aWZ5IHBpY2tsZSBwcm90b2NvbApORVdPQkogICAgICAgICA9IGInXHg4MScgICMgYnVpbGQgb2JqZWN0IGJ5IGFwcGx5aW5nIGNscy5fX25ld19fIHRvIGFyZ3R1cGxlCkVYVDEgICAgICAgICAgID0gYidceDgyJyAgIyBwdXNoIG9iamVjdCBmcm9tIGV4dGVuc2lvbiByZWdpc3RyeTsgMS1ieXRlIGluZGV4CkVYVDIgICAgICAgICAgID0gYidceDgzJyAgIyBkaXR0bywgYnV0IDItYnl0ZSBpbmRleApFWFQ0ICAgICAgICAgICA9IGInXHg4NCcgICMgZGl0dG8sIGJ1dCA0LWJ5dGUgaW5kZXgKVFVQTEUxICAgICAgICAgPSBiJ1x4ODUnICAjIGJ1aWxkIDEtdHVwbGUgZnJvbSBzdGFjayB0b3AKVFVQTEUyICAgICAgICAgPSBiJ1x4ODYnICAjIGJ1aWxkIDItdHVwbGUgZnJvbSB0d28gdG9wbW9zdCBzdGFjayBpdGVtcwpUVVBMRTMgICAgICAgICA9IGInXHg4NycgICMgYnVpbGQgMy10dXBsZSBmcm9tIHRocmVlIHRvcG1vc3Qgc3RhY2sgaXRlbXMKTkVXVFJVRSAgICAgICAgPSBiJ1x4ODgnICAjIHB1c2ggVHJ1ZQpORVdGQUxTRSAgICAgICA9IGInXHg4OScgICMgcHVzaCBGYWxzZQpMT05HMSAgICAgICAgICA9IGInXHg4YScgICMgcHVzaCBsb25nIGZyb20gPCAyNTYgYnl0ZXMKTE9ORzQgICAgICAgICAgPSBiJ1x4OGInICAjIHB1c2ggcmVhbGx5IGJpZyBsb25nCgpfdHVwbGVzaXplMmNvZGUgPSBbRU1QVFlfVFVQTEUsIFRVUExFMSwgVFVQTEUyLCBUVVBMRTNdCgojIFByb3RvY29sIDMgKFB5dGhvbiAzLngpCgpCSU5CWVRFUyAgICAgICA9IGInQicgICAjIHB1c2ggYnl0ZXM7IGNvdW50ZWQgYmluYXJ5IHN0cmluZyBhcmd1bWVudApTSE9SVF9CSU5CWVRFUyA9IGInQycgICAjICAiICAgICAiICAgOyAgICAiICAgICAgIiAgICAgICAiICAgICAgIiA8IDI1NiBieXRlcwoKIyBQcm90b2NvbCA0CgpTSE9SVF9CSU5VTklDT0RFID0gYidceDhjJyAgIyBwdXNoIHNob3J0IHN0cmluZzsgVVRGLTggbGVuZ3RoIDwgMjU2IGJ5dGVzCkJJTlVOSUNPREU4ICAgICAgPSBiJ1x4OGQnICAjIHB1c2ggdmVyeSBsb25nIHN0cmluZwpCSU5CWVRFUzggICAgICAgID0gYidceDhlJyAgIyBwdXNoIHZlcnkgbG9uZyBieXRlcyBzdHJpbmcKRU1QVFlfU0VUICAgICAgICA9IGInXHg4ZicgICMgcHVzaCBlbXB0eSBzZXQgb24gdGhlIHN0YWNrCkFERElURU1TICAgICAgICAgPSBiJ1x4OTAnICAjIG1vZGlmeSBzZXQgYnkgYWRkaW5nIHRvcG1vc3Qgc3RhY2sgaXRlbXMKRlJPWkVOU0VUICAgICAgICA9IGInXHg5MScgICMgYnVpbGQgZnJvemVuc2V0IGZyb20gdG9wbW9zdCBzdGFjayBpdGVtcwpORVdPQkpfRVggICAgICAgID0gYidceDkyJyAgIyBsaWtlIE5FV09CSiBidXQgd29yayB3aXRoIGtleXdvcmQgb25seSBhcmd1bWVudHMKU1RBQ0tfR0xPQkFMICAgICA9IGInXHg5MycgICMgc2FtLmRlZmVjdHMsIFtlcnJvcnMuT2Jzb2xldGVIZWFkZXJEZWZlY3RdKQoKCkBwYXJhbWV0ZXJpemUKY2xhc3MgVGVzdFVuc3RydWN0dXJlZEhlYWRlcihUZXN0SGVhZGVyQmFzZSk6CgogICAgZGVmIHN0cmluZ19hc192YWx1ZShzZWxmLAogICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGRlY29kZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICphcmdzKToKICAgICAgICBsID0gbGVuKGFyZ3MpCiAgICAgICAgZGVmZWN0cyA9IGFyZ3NbMF0gaWYgbD4wIGVsc2UgW10KICAgICAgICBoZWFkZXIgPSAnU3ViamVjdDonICsgKCcgJyBpZiBzb3VyY2UgZWxzZSAnJykKICAgICAgICBmb2xkZWQgPSBoZWFkZXIgKyAoYXJnc1sxXSBpZiBsPjEgZWxzZSBzb3VyY2UpICsgJ1xuJwogICAgICAgIGggPSBzZWxmLm1ha2VfaGVhZGVyKCdTdWJqZWN0Jywgc291cmNlKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoaCwgZGVjb2RlZCkKICAgICAgICBzZWxmLmFzc2VydERlZmVjdHNFcXVhbChoLmRlZmVjdHMsIGRlZmVjdHMpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChoLmZvbGQocG9saWN5PXBvbGljeS5kZWZhdWx0KSwgZm9sZGVkKQoKICAgIHN0cmluZ19wYXJhbXMgPSB7CgogICAgICAgICdyZmMyMDQ3X3NpbXBsZV9xdW9wcmknOiAoCiAgICAgICAgICAgICc9P3V0Zi04P3E/dGhpc19pc19hX3Rlc3Q/PScsCiAgICAgICAgICAgICd0aGlzIGlzIGEgdGVzdCcsCiAgICAgICAgICAgIFtdLAogICAgICAgICAgICAndGhpcyBpcyBhIHRlc3QnKSwKCiAgICAgICAgJ3JmYzIwNDdfZ2IyMzEyX2Jhc2U2NCc6ICgKICAgICAgICAgICAgJz0/Z2IyMzEyP2I/MWVMS3g5YlF6c1N5NHNyVW82RT0/PScsCiAgICAgICAgICAgICdcdThmZDlcdTY2MmZcdTRlMmRcdTY1ODdcdTZkNGJcdThiZDVcdWZmMDEnLAogICAgICAgICAgICBbXSwKICAgICAgICAgICAgJz0/dXRmLTg/Yj82TCtaNXBpdjVMaXQ1cGFINXJXTDZLK1Y3N3lCPz0nKSwKCiAgICAgICAgJ3JmYzIwNDdfc2ltcGxlX25vbmFzY2lpX3F1b3ByaSc6ICgKICAgICAgICAgICAgJz0/dXRmLTg/cT89QzM9ODlyaWM/PScsCiAgICAgICAgICAgICfDiXJpYycpLAoKICAgICAgICAncmZjMjA0N19xdW9wcmlfd2l0aF9yZWd1bGFyX3RleHQnOiAoCiAgICAgICAgICAgICdUaGUgPT91dGYtOD9xPz1DMz04OXJpYz0yQz89IEhpbXNlbGYnLAogICAgICAgICAgICAnVGhlIMOJcmljLCBIaW1zZWxmJyksCgogICAgfQoKCkBwYXJhbWV0ZXJpemUKY2xhc3MgVGVzdERhdGVIZWFkZXIoVGVzdEhlYWRlckJhc2UpOgoKICAgIGRhdGVzdHJpbmcgPSAnU3VuLCAyMyBTZXAgMjAwMSAyMDoxMDo1NSAtMDcwMCcKICAgIHV0Y29mZnNldCA9IGRhdGV0aW1lLnRpbWVkZWx0YShob3Vycz0tNykKICAgIHR6ID0gZGF0ZXRpbWUudGltZXpvbmUodXRjb2Zmc2V0KQogICAgZHQgPSBkYXRldGltZS5kYXRldGltZSgyMDAxLCA5LCAyMywgMjAsIDEwLCA1NSwgdHppc3RyICs9IDE7CiAgICAgICAgICAgIElOU1RSVUNUSU9OX1NUQVRTKE9QKTsKICAgICAgICAgICAgSlVNUF9UT19MQUJFTChzb21ld2hlcmUpOwogICAgICAgIH0KCiAgICAgICAgTEFCRUwoc29tZXdoZXJlKQogICAgICAgIHsKICAgICAgICB9CiAgICAiIiIKICAgICAgICBzZWxmLnJ1bl9jYXNlc190ZXN0KGlucHV0LCBvdXRwdXQpCgogICAgZGVmIHRlc3RfbWFjcm9faW5zdHJ1Y3Rpb24oc2VsZik6CiAgICAgICAgaW5wdXQgPSAiIiIKICAgICAgICBpbnN0KE9QMSwgKGNvdW50ZXIvMSwgbGVmdCwgcmlnaHQgLS0gbGVmdCwgcmlnaHQpKSB7CiAgICAgICAgICAgIG9wMShsZWZ0LCByaWdodCk7CiAgICAgICAgfQogICAgICAgIG9wKE9QMiwgKGV4dHJhLzIsIGFyZzIsIGxlZnQsIHJpZ2h0IC0tIHJlcykpIHsKICAgICAgICAgICAgcmVzID0gb3AyKGFyZzIsIGxlZnQsIHJpZ2h0KTsKICAgICAgICAgICAgSU5QVVRTX0RFQUQoKTsKICAgICAgICB9CiAgICAgICAgbWFjcm8oT1ApID0gT1AxICsgY2FjaGUvMiArIE9QMjsKICAgICAgICBpbnN0KE9QMywgKHVudXNlZC81LCBhcmcyLCBsZWZ0LCByaWdodCAtLSByZXMpKSB7CiAgICAgICAgICAgIHJlcyA9IG9wMyhhcmcyLCBsZWZ0LCByaWdodCk7CiAgICAgICAgICAgIElOUFVUU19ERUFEKCk7CiAgICAgICAgfQogICAgICAgIGZhbWlseShPUCwgSU5MSU5FX0NBQ0hFX0VOVFJJRVNfT1ApID0geyBPUDMgfTsKICAgICIiIgogICAgICAgIG91dHB1dCA9ICIiIgogICAgICAgIFRBUkdFVChPUCkgewogICAgICAgICAgICAjaWYgX1B5X1RBSUxfQ0FMTF9JTlRFUlAKICAgICAgICAgICAgaW50IG9wY29kZSA9IE9QOwogICAgICAgICAgICAodm9pZCkob3Bjb2RlKTsKICAgICAgICAgICAgI2VuZGlmCiAgICAgICAgICAgIGZyYW1lLT5pbnN0cl9wdHIgPSBuZXh0X2luc3RyOwogICAgICAgICAgICBuZXh0X2luc3RyICs9IDY7CiAgICAgICAgICAgIElOU1RSVUNUSU9OX1NUQVRTKE9QKTsKICAgICAgICAgICAgUFJFRElDVEVEX09QOjsKICAgICAgICAgICAgX1B5X0NPREVVTklUKiBjb25zdCB0aGlzX2luc3RyID0gbmV4dF9pbnN0ciAtIDY7CiAgICAgICAgICAgICh2b2lkKXRoaXNfaW5zdHI7CiAgICAgICAgICAgIF9QeVN0YWNrUmVmIGxlZnQ7CiAgICAgICAgICAgIF9QeVN0YWNrUmVmIHJpZ2h0OwogICAgICAgICAgICBfUHlTdGFja1JlZiBhcmcyOwogICAgICAgICAgICBfUHlTdGFja1JlZiByZXM7CiAgICAgICAgICAgIC8vIF9PUDEKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmlnaHQgPSBzdGFja19wb2ludGVyWy0xXTsKICAgICAgICAgICAgICAgIGxlZnQgPSBzdGFja19wb2ludGVyWy0yXTsKICAgICAgICAgICAgICAgIHVpbnQxNl90IGNvdW50ZXIgPSByZWFkX3UxNigmdGhpc19pbnN0clsxXS5jYWNoZSk7CiAgICAgICAgICAgICAgICAodm9pZCljb3VudGVyOwogICAgICAgICAgICAgICAgX1B5RnJhbWVfU2V0U3RhY2tQb2ludGVyKGZyYW1lLCBzdGFjYm9vayA9ICgKICAgICAgICAgICAgQm9vay5vYmplY3RzLnVzaW5nKCJvdGhlciIpCiAgICAgICAgICAgIC5zZWxlY3RfcmVsYXRlZCgiZWRpdG9yIikKICAgICAgICAgICAgLmdldCh0aXRsZT0iRGl2ZSBpbnRvIFB5dGhvbiIpCiAgICAgICAgKQoKICAgICAgICAjIFRoZSBlZGl0b3IgaW5zdGFuY2Ugc2hvdWxkIGhhdmUgYSBkYiBzdGF0ZQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYm9vay5lZGl0b3IuX3N0YXRlLmRiLCAib3RoZXIiKQoKICAgIGRlZiB0ZXN0X3N1YnF1ZXJ5KHNlbGYpOgogICAgICAgICIiIk1ha2Ugc3VyZSBhc19zcWwgd29ya3Mgd2l0aCBzdWJxdWVyaWVzIGFuZCBwcmltYXJ5L3JlcGxpY2EuIiIiCiAgICAgICAgc3ViID0gUGVyc29uLm9iamVjdHMudXNpbmcoIm90aGVyIikuZmlsdGVyKG5hbWU9ImZmZiIpCiAgICAgICAgcXMgPSBCb29rLm9iamVjdHMuZmlsdGVyKGVkaXRvcl9faW49c3ViKQoKICAgICAgICAjIFdoZW4geW91IGNhbGwgX19zdHJfXyBvbiB0aGUgcXVlcnkgb2JqZWN0LCBpdCBkb2Vzbid0IGtub3cgYWJvdXQKICAgICAgICAjIHVzaW5nIHNvIGl0IGZhbGxzIGJhY2sgdG8gdGhlIGRlZmF1bHQuIElmIHRoZSBzdWJxdWVyeSBleHBsaWNpdGx5CiAgICAgICAgIyB1c2VzIGEgZGlmZmVyZW50IGRhdGFiYXNlLCBhbiBlcnJvciBzaG91bGQgYmUgcmFpc2VkLgogICAgICAgIG1zZyA9ICgKICAgICAgICAgICAgIlN1YnF1ZXJpZXMgYXJlbid0IGFsbG93ZWQgYWNyb3NzIGRpZmZlcmVudCBkYXRhYmFzZXMuIEZvcmNlIHRoZSAiCiAgICAgICAgICAgICJpbm5lciBxdWVyeSB0byBiZSBldmFsdWF0ZWQgdXNpbmcgYGxpc3QoaW5uZXJfcXVlcnkpYC4iCiAgICAgICAgKQogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXNNZXNzYWdlKFZhbHVlRXJyb3IsIG1zZyk6CiAgICAgICAgICAgIHN0cihxcy5xdWVyeSkKCiAgICAgICAgIyBFdmFsdWF0aW5nIHRoZSBxdWVyeSBzaG91bGRuJ3Qgd29yaywgZWl0aGVyCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFJhaXNlc01lc3NhZ2UoVmFsdWVFcnJvciwgbXNnKToKICAgICAgICAgICAgZm9yIG9iaiBpbiBxczoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgdGVzdF9yZWxhdGVkX21hbmFnZXIoc2VsZik6CiAgICAgICAgIlJlbGF0ZWQgbWFuYWdlcnMgcmV0dXJuIG1hbmFnZXJzLCBub3QgcXVlcnlzZXRzIgogICAgICAgIG1hcmsgPSBQZXJzb24ub2JqZWN0cy51c2luZygib3RoZXIiKS5jcmVhdGUobmFtZT0iTWFyayBQaWxncmltIikKCiAgICAgICAgIyBleHRyYV9hcmcgaXMgcmVtb3ZlZCBieSB0aGUgQm9va01hbmFnZXIncyBpbXBsZW1lbnRhdGlvbiBvZgogICAgICAgICMgY3JlYXRlKCk7IGJ1dCB0aGUgQm9va01hbmFnZXIncyBpbXBsZW1lbnRhdGlvbiB3b24ndCBnZXQgY2FsbGVkCiAgICAgICAgIyB1bmxlc3MgZWRpdGVkIHJldHVybnMgYSBNYW5hZ2VyLCBub3QgYSBxdWVyeXNldAogICAgICAgIG1hcmsuYm9va19zZXQuY3JlYXRlZF9maWVsZF9saXN0X2Rpc3BsYXlfd3JvbmdfZmllbGQoc2VsZik6CiAgICAgICAgY2xhc3MgU29uZ0FkbWluKGFkbWluLk1vZGVsQWRtaW4pOgogICAgICAgICAgICBsaXN0X2Rpc3BsYXkgPSBbInBrIiwgIm9yaWdpbmFsX3JlbGVhc2UiLCAiYWxidW1fX2hlbGxvIl0KCiAgICAgICAgZXJyb3JzID0gU29uZ0FkbWluKFNvbmcsIEFkbWluU2l0ZSgpKS5jaGVjaygpCiAgICAgICAgZXhwZWN0ZWQgPSBbCiAgICAgICAgICAgIGNoZWNrcy5FcnJvcigKICAgICAgICAgICAgICAgICJUaGUgdmFsdWUgb2YgJ2xpc3RfZGlzcGxheVsyXScgcmVmZXJzIHRvICdhbGJ1bV9faGVsbG8nLCB3aGljaCBpcyBub3QgIgogICAgICAgICAgICAgICAgImEgY2FsbGFibGUgb3IgYXR0cmlidXRlIG9mICdTb25nQWRtaW4nLCBvciBhbiBhdHRyaWJ1dGUsIG1ldGhvZCwgb3IgIgogICAgICAgICAgICAgICAgImZpZWxkIG9uICdhZG1pbl9jaGVja3MuU29uZycuIiwKICAgICAgICAgICAgICAgIG9iaj1Tb25nQWRtaW4sCiAgICAgICAgICAgICAgICBpZD0iYWRtaW4uRTEwOCIsCiAgICAgICAgICAgICkKICAgICAgICBdCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChlcnJvcnMsIGV4cGVjdGVkKQppbXBvcnQgYXN0CmltcG9ydCBzeXMKaW1wb3J0IHVuaXR0ZXN0CgoKZnVuY2RlZiA9ICIiIlwKZGVmIGZvbygpOgogICAgIyB0eXBlOiAoKSAtPiBpbnQKICAgIHBhc3MKCmRlZiBiYXIoKTogICMgdHlwZTogKCkgLT4gTm9uZQogICAgcGFzcwoiIiIKCmFzeW5jZGVmID0gIiIiXAphc3luYyBkZWYgZm9vKCk6CiAgICAjIHR5cGU6ICgpIC0+IGludAogICAgcmV0dXJuIGF3YWl0IGJhcigpCgphc3luYyBkZWYgYmFyKCk6ICAjIHR5cGU6ICgpIC0+IGludAogICAgcmV0dXJuIGF3YWl0IGJhcigpCiIiIgoKYXN5bmN2YXIgPSAiIiJcCmFzeW5jID0gMTIKYXdhaXQgPSAxMwoiIiIKCmFzeW5jY29tcCA9ICIiIlwKYXN5bmMgZGVmIGZvbyh4cyk6CiAgICBbeCBhc3luYyBmb3IgeCBpbiB4c10KIiIiCgptYXRtdWwgPSAiIiJcCmEgPSBiIEAgYwoiIiIKCmZzdHJpbmcgPSAiIiJcCmEgPSA0MgpmInthfSIKIiIiCgp1bmRlcnNjb3JlZG51bWJlciA9ICIiIlwKYSA9IDQyXzQyXzQyCiIiIgoKcmVkdW5kYW50ZGVmID0gIiIiXApkZWYgZm9vKCk6ICAjIHR5cGU6ICgpIC0+IGludAogICAgIyB0eXBlOiAoKSAtPiBzdHIKICAgIHJldHVybiAnJwoiIiIKCm5vbmFzY2lpZGVmID0gIiIiXApkZWYgZm9vKCk6CiAgICAjIHR5cGU6ICgpIC0+IMOgw6fEjcOpw7F0CiAgICBwYXNzCiIiIgoKZm9yc3RtdCA9ICIiIlwKZm9yIGEgaW4gW106ICAjIHR5cGU6IGludAogICAgcGFzcwoiIiIKCndpdGhzdG10ID0gIiIiXAp3aXRoIGNvbnRleHQoKSBhcyBhOiAgIyB0eXBlOiBpbnQKICAgIHBhc3MKIiIiCgpwYXJlbnRoZXNpemVkX3dpdGhzdG10ID0gIiIiXAp3aXRoIChhIGFzIGIpOiAgIyB0eXBlOiBpbnQKICAgIHBhc3MKCndpdGggKGEsIGJDaGVja3MgaWYgdGhlIHF1ZXVlIGlzIGVtcHR5LgogICAgICAgICIiIgogICAgICAgIHJldHVybiBub3Qgc2VsZi5ldmVudHMKCiAgICBkZWYgZmx1c2hfYnVmKHNlbGYpIC0+IGJ5dGVhcnJheToKICAgICAgICAiIiIKICAgICAgICBGbHVzaGVzIHRoZSBidWZmZXIgYW5kIHJldHVybnMgaXRzIGNvbnRlbnRzLgogICAgICAgICIiIgogICAgICAgIG9sZCA9IHNlbGYuYnVmCiAgICAgICAgc2VsZi5idWYgPSBieXRlYXJyYXkoKQogICAgICAgIHJldHVybiBvbGQKCiAgICBkZWYgaW5zZXJ0KHNlbGYsIGV2ZW50OiBFdmVudCkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICBJbnNlcnRzIGFuIGV2ZW50IGludG8gdGhlIHF1ZXVlLgogICAgICAgICIiIgogICAgICAgIHRyYWNlKCdhZGRlZCBldmVudCB7ZXZlbnR9JywgZXZlbnQ9ZXZlbnQpCiAgICAgICAgc2VsZi5ldmVudHMuYXBwZW5kKGV2ZW50KQoKICAgIGRlZiBwdXNoKHNlbGYsIGNoYXI6IGludCB8IGJ5dGVzKSAtPiBOb25lOgogICAgICAgICIiIgogICAgICAgIFByb2Nlc3NlcyBhIGNoYXJhY3RlciBieSB1cGRhdGluZyB0aGUgYnVmZmVyIGFuZCBoYW5kbGluZyBzcGVjaWFsIGtleSBtYXBwaW5ncy4KICAgICAgICAiIiIKICAgICAgICBhc3NlcnQgaXNpbnN0YW5jZShjaGFyLCAoaW50LCBieXRlcykpCiAgICAgICAgb3JkX2NoYXIgPSBjaGFyIGlmIGlzaW5zdGFuY2UoY2hhciwgaW50KSBlbHNlIG9yZChjaGFyKQogICAgICAgIGNoYXIgPSBvcmRfY2hhci50b19ieXRlcygpCiAgICAgICAgc2VsZi5idWYuYXBwZW5kKG9yZF9jaGFyKQoKICAgICAgICBpZiBjaGFyIGluIHNlbGYua2V5bWFwOgogICAgICAgICAgICBpZiBzZWxmLmtleW1hcCBpcyBzZWxmLmNvbXBpbGVkX2tleW1hcDoKICAgICAgICAgICAgICAgICMgc2FuaXR5IGNoZWNrLCBidWZmZXIgaXMgZW1wdHkgd2hlbiBhIHNwZWNpYWwga2V5IGNvbWVzCiAgICAgICAgICAgICAgICBhc3NlcnQgbGVuKHNlbGYuYnVmKSA9PSAxCiAgICAgICAgICAgIGsgPSBzZWxmLmtleW1hcFtjaGFyXQogICAgICAgICAgICB0cmFjZSgnZm91bmQgbWFwIHtrIXJ9Jywgaz1rKQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGssIGRpY3QpOgogICAgICAgICAgICAgICAgc2VsZi5rZXltYXAgPSBrCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmluc2VydChFdmVudCgna2V5JywgaywgYnl0ZXMoc2VsZi5mbHVzaF9idWYoKSkpKQogICAgICAgICAgICAgICAgc2VsZi5rZXltYXAgPSBzZWxmLmNvbXBpbGVkX2tleW1hcAoKICAgICAgICBlbGlmIHNlbGYuYnVmIGFuZCBzZWxmLmJ1ZlswXSA9PSAyNzogICMgZXNjYXBlCiAgICAgICAgICAgICMgZXNjYXBlIHNlcXVlbmNlIG5vdCByZWNvZ25pemVkIGJ5IG91ciBrZXltYXA6IHByb3BhZ2F0ZSBpdAogICAgICAgICAgICAjIG91dHNpZGUgc28gdGhhdCBpIGNhbiBiZSByZWNvZ25pemVkIGFzIGFuIE0tLi4uIGtleSAoc2VlIGFsc28KICB1bGUuX0dMT0JBTF9ERUZBVUxUX1RJTUVPVVQKQUZfSU5FVCA9IHNvY2tldF9tb2R1bGUuQUZfSU5FVApBRl9JTkVUNiA9IHNvY2tldF9tb2R1bGUuQUZfSU5FVDYKU09DS19TVFJFQU0gPSBzb2NrZXRfbW9kdWxlLlNPQ0tfU1RSRUFNClNPTF9TT0NLRVQgPSBOb25lClNPX1JFVVNFQUREUiA9IE5vbmUKCmlmIGhhc2F0dHIoc29ja2V0X21vZHVsZSwgJ0FGX1VOSVgnKToKICAgIEFGX1VOSVggPSBzb2NrZXRfbW9kdWxlLkFGX1VOSVgKIiIiVGVybWluYWwgdXRpbGl0aWVzLiIiIgoKIyBBdXRob3I6IFN0ZWVuIEx1bWhvbHQuCgpmcm9tIHRlcm1pb3MgaW1wb3J0ICoKCl9fYWxsX18gPSBbImNmbWFrZXJhdyIsICJjZm1ha2VjYnJlYWsiLCAic2V0cmF3IiwgInNldGNicmVhayJdCgojIEluZGljZXMgZm9yIHRlcm1pb3MgbGlzdC4KSUZMQUcgPSAwCk9GTEFHID0gMQpDRkxBRyA9IDIKTEZMQUcgPSAzCklTUEVFRCA9IDQKT1NQRUVEID0gNQpDQyA9IDYKCmRlZiBjZm1ha2VyYXcobW9kZSk6CiAgICAiIiJNYWtlIHRlcm1pb3MgbW9kZSByYXcuIiIiCiAgICAjIENsZWFyIGFsbCBQT1NJWC4xLTIwMTcgaW5wdXQgbW9kZSBmbGFncy4KICAgICMgU2VlIGNoYXB0ZXIgMTEgIkdlbmVyYWwgVGVybWluYWwgSW50ZXJmYWNlIgogICAgIyBvZiBQT1NJWC4xLTIwMTcgQmFzZSBEZWZpbml0aW9ucy4KICAgIG1vZGVbSUZMQUddICY9IH4oSUdOQlJLIHwgQlJLSU5UIHwgSUdOUEFSIHwgUEFSTVJLIHwgSU5QQ0sgfCBJU1RSSVAgfAogICAgICAgICAgICAgICAgICAgICBJTkxDUiB8IElHTkNSIHwgSUNSTkwgfCBJWE9OIHwgSVhBTlkgfCBJWE9GRikKCiAgICAjIERvIG5vdCBwb3N0LXByb2Nlc3Mgb3V0cHV0LgogICAgbW9kZVtPRkxBR10gJj0gfk9QT1NUCgogICAgIyBEaXNhYmxlIHBhcml0eSBnZW5lcmF0aW9uIGFuZCBkZXRlY3Rpb247IGNsZWFyIGNoYXJhY3RlciBzaXplIG1hc2s7CiAgICAjIGxldCBjaGFyYWN0ZXIgc2l6ZSBiZSA4IGJpdHMuCiAgICBtb2RlW0NGTEFHXSAmPSB+KFBBUkVOQiB8IENTSVpFKQogICAgbW9kZVtDRkxBR10gfD0gQ1M4CgogICAgIyBDbGVhciBhbGwgUE9TSVguMS0yMDE3IGxvY2FsIG1vZGUgZmxhZ3MuCiAgICBtb2RlW0xGTEFHXSAmPSB+KEVDSE8gfCBFQ0hPRSB8IEVDSE9LIHwgRUNIT05MIHwgSUNBTk9OIHwKICAgICAgICAgICAgICAgICAgICAgSUVYVEVOIHwgSVNJRyB8IE5PRkxTSCB8IFRPU1RPUCkKCiAgICAjIFBPU0lYLjEtMjAxNywgMTEuMS43IE5vbi1DYW5vbmljYWwgTW9kZSBJbnB1dCBQcm9jZXNzaW5nLAogICAgIyBDYXNlIEI6IE1JTj4wLCBUSU1FPTAKICAgICMgQSBwZW5kaW5nIHJlYWQgc2hhbGwgYmxvY2sgdW50aWwgTUlOIChoZXJlIDEpIGJ5dGVzIGFyZSByZWNlaXZlZCwKICAgICMgb3IgYSBzaWduYWwgaXMgcmVjZWl2ZWQuCiAgICBtb2RlW0NDXSA9IGxpc3QobW9kZVtDQ10pCiAgICBtb2RlW0NDXVtWTUlOXSA9IDEKICAgIG1vZGVbQ0NdW1ZUSU1FXSA9IDAKCmRlZi50ZXh0LCAnbWFpbicsICdFZGl0b3JXaW5kb3cnKQogICAgICAgIHRrX2ZvbnQgPSBGb250KHNlbGYudGV4dCwgZm9udD1mb250KQogICAgICAgIGNoYXJfd2lkdGggPSBtYXgodGtfZm9udC5tZWFzdXJlKGNoYXIpIGZvciBjaGFyIGluIFsnPicsICcuJ10pCiAgICAgICAgc2VsZi5jYW52YXMuY29uZmlndXJlKHdpZHRoPWNoYXJfd2lkdGggKiAzICsgNCkKICAgICAgICBzZWxmLmZvbnQgPSBmb250CiAgICAgICAgc2VsZi5jaGFuZ2VfY2FsbGJhY2soKQoKICAgIGRlZiB1cGRhdGVfY29sb3JzKHNlbGYpOgogICAgICAgICIiIlVwZGF0ZSB0aGUgc2lkZWJhciB0ZXh0IGNvbG9ycywgdXN1YWxseSBhZnRlciBjb25maWcgY2hhbmdlcy4iIiIKICAgICAgICBsaW5lbnVtYmVyc19jb2xvcnMgPSBpZGxlQ29uZi5HZXRIaWdobGlnaHQoaWRsZUNvbmYuQ3VycmVudFRoZW1lKCksICdsaW5lbnVtYmVyJykKICAgICAgICBwcm9tcHRfY29sb3JzID0gaWRsZUNvbmYuR2V0SGlnaGxpZ2h0KGlkbGVDb25mLkN1cnJlbnRUaGVtZSgpLCAnY29uc29sZScpCiAgICAgICAgZm9yZWdyb3VuZCA9IHByb21wdF9jb2xvcnNbJ2ZvcmVncm91bmQnXQogICAgICAgIGJhY2tncm91bmQgPSBsaW5lbnVtYmVyc19jb2xvcnNbJ2JhY2tncm91bmQnXQogICAgICAgIHNlbGYuY29sb3JzID0gKGZvcmVncm91bmQsIGJhY2tncm91bmQpCiAgICAgICAgc2VsZi5jYW52YXMuY29uZmlndXJlKGJhY2tncm91bmQ9YmFja2dyb3VuZCkKICAgICAgICBzZWxmLmNoYW5nZV9jYWxsYmFjaygpCgoKZGVmIF9zaWRlYmFyX251bWJlcl9zY3JvbGxpbmcocGFyZW50KTogICMgaHRlc3QgIwogICAgZnJvbSBpZGxlbGliLmlkbGVfdGVzdC50ZXN0X3NpZGViYXIgaW1wb3J0IER1bW15X2VkaXR3aW4KCiAgICB0b3AgPSB0ay5Ub3BsZXZlbChwYXJlbnQpCiAgICB0ZXh0X2ZyYW1lID0gdGsuRnJhbWUodG9wKQogICAgdGV4dF9mcmFtZS5wYWNrKHNpZGU9dGsuTEVGVCwgZmlsbD10ay5CT1RILCBleHBhbmQ9VHJ1ZSkKICAgIHRleHRfZnJhbWUucm93Y29uZmlndXJlKDEsIHdlaWdodD0xKQogICAgdGV4dF9mcmFtZS5jb2x1bW5jb25maWd1cmUoMSwgd2VpZ2h0PTEpCgogICAgZm9udCA9IGlkbGVDb25mLkdldEZvbnQodG9wLCAnbWFpbicsICdFZGl0b3JXaW5kb3cnKQogICAgdGV4dCA9IHRrLlRleHQodGV4dF9mcmFtZSwgd2lkdGg9ODAsIGhlaWdodD0yNCwgd3JhcD10ay5OT05FLCBmb250PWZvbnQpCiAgICB0ZXh0LmdyaWQocm93PTEsIGNvbHVtbj0xLCBzdGlja3k9dGsuTlNFVykKCiAgICBlZGl0d2luID0gRHVtbXlfZWRpdHdpbih0ZXh0KQogICAgZWRpdHdpbi52YmFyID0gdGsuU2Nyb2xsYmFyKHRleHRfZnJhbWUpCgogICAgbGluZW51bWJlcnMgPSBMaW5lTnVtYmVycyhlZGl0d2luKQogICAgbGluZW51bWJlcnMuc2hvd19zaWRlYmFyKCkKCiAgICB0ZXh0Lmluc2VydCgnMS4wJywgJ1xuJy5qb2luKCdhJyppIGZvciBpIGluIHJhbmdlKDEsIDEwMSkpKQoKCmlsaW5rcycsCiAgICApCiAgICBjb3B5X2F0dHJpYnV0ZXMoaW5mb19hZGQsIG9zLCAnb3MuJXMnLCBhdHRyaWJ1dGVzLCBmb3JtYXR0ZXI9Zm9ybWF0X2F0dHIpCgogICAgZm9yIGZ1bmMgaW4gKAogICAgICAgICdjcHVfY291bnQnLAogICAgICAgICdnZXRjd2QnLAogICAgICAgICdnZXRlZ2lkJywKICAgICAgICAnZ2V0ZXVpZCcsCiAgICAgICAgJ2dldGdpZCcsCiAgICAgICAgJ2dldGxvYWRhdmcnLAogICAgICAgICdnZXRyZXNnaWQnLAogICAgICAgICdnZXRyZXN1aWQnLAogICAgICAgICdnZXR1aWQnLAogICAgICAgICdwcm9jZXNzX2NwdV9jb3VudCcsCiAgICAgICAgJ3VuYW1lJywKICAgICk6CiAgICAgICAgY2FsbF9mdW5jKGluZm9fYWRkLCAnb3MuJXMnICUgZnVuYywgb3MsIGZ1bmMpCgogICAgZGVmIGZvcm1hdF9ncm91cHMoZ3JvdXBzKToKICAgICAgICByZXR1cm4gJywgJy5qb2luKG1hcChzdHIsIGdyb3VwcykpCgogICAgY2FsbF9mdW5jKGluZm9fYWRkLCAnb3MuZ2V0Z3JvdXBzJywgb3MsICdnZXRncm91cHMnLCBmb3JtYXR0ZXI9Zm9ybWF0X2dyb3VwcykKCiAgICBpZiBoYXNhdHRyKG9zLCAnZ2V0bG9naW4nKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2luID0gb3MuZ2V0bG9naW4oKQogICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAjIGdldGxvZ2luKCkgZmFpbHMgd2l0aCAiT1NFcnJvcjogW0Vycm5vIDI1XSBJbmFwcHJvcHJpYXRlIGlvY3RsCiAgICAgICAgICAgICMgZm9yIGRldmljZSIgb24gVHJhdmlzIENJCiAgICAgICAgICAgIHBhc3MKICAgICAgICBlbHNlOgogICAgICAgICAgICBpbmZvX2FkZCgib3MubG9naW4iLCBsb2dpbikKCiAgICAjIEVudmlyb25tZW50IHZhcmlhYmxlcyB1c2VkIGJ5IHRoZSBzdGRsaWIgYW5kIHRlc3RzLiBEb24ndCBsb2cgdGhlIGZ1bGwKICAgICMgZW52aXJvbm1lbnQ6IGZpbHRlciB0byBsaXN0IHRvIG5vdCBsZWFrIHNlbnNpdGl2ZSBpbmZvcm1hdGlvbi4KICAgICMKICAgICMgSFRUUF9QUk9YWSBpcyBub3QgbG9nZ2VkIGJlY2F1c2UgaXQgY2FuIGNvbnRhaW4gYSBwYXNzd29yZC4KICAgIEVOVl9WQVJTID0gZnJvemVuc2V0KCgKICAgICAgICAiQVBQREFUQSIsCiAgICAgICAgIkFSIiwKICAgICAgICAiQVJDSEZMQUdTIiwKICAgICAgICAiQVJGTEFHUyIsCiAgICAgICAgIkFVRElPREVWIiwKICAgICAgICAiQlVJTERQWVRIT04iLAogICAgICAgICJDQyIsCiAgICAgICAgIkNGTEFHUyIsCiAgICAgICAgIkNPTFVNTlMiLAogICAgICAgICJDT01QVVRFUk5BTUUiLAogICAgICAgICJDT01TUEVDIiwKICAgICAgICAiQ1BQIiwKICAgICAgICAiQ1BQRkxBR1MiLAogICAgICAgICJESVNQTEFZIiwKICAgICAgICAiRElTVFVUSUxTX0RFQlVHIiwKICAgICAgICAiRElTVFVUSUxTX1VTRV9TREsiLAogICAgICAgICJEWUxEX0xJQlJBUllfUEFUSCIsCiAgICAgICAgIkVOU1VSRVBJUF9PUFRJT05TIiwKICAgICAgICAiRk9SQ0VfQ09MT1IiLAogdmlyb246CiAgICAgICAgdGVzdF9lbnZbIlRFU1RfUlVOTkVSX0dJVEhVQl9BQ1RJT05TIl0gPSBvcy5lbnZpcm9uWyJHSVRIVUJfQUNUSU9OUyJdCgogICAgcHJpbnQoIlJ1bm5pbmcgdGVzdCBwcm9qZWN0Li4uIikKICAgICMgVGVzdCBleGVjdXRpb24gKmNhbid0KiBiZSBydW4gLXF1aWV0OyB2ZXJib3NlIG1vZGUKICAgICMgaXMgaG93IHdlIHNlZSB0aGUgb3V0cHV0IG9mIHRoZSB0ZXN0IG91dHB1dC4KICAgIHByb2Nlc3MgPSBzdWJwcm9jZXNzLlBvcGVuKAogICAgICAgIFsieGNvZGVidWlsZCIsICJ0ZXN0LXdpdGhvdXQtYnVpbGRpbmciXSArIGFyZ3MsCiAgICAgICAgc3Rkb3V0PXN1YnByb2Nlc3MuUElQRSwKICAgICAgICBzdGRlcnI9c3VicHJvY2Vzcy5TVERPVVQsCiAgICAgICAgZW52PXRlc3RfZW52LAogICAgKQogICAgd2hpbGUgbGluZSA6PSAocHJvY2Vzcy5zdGRvdXQucmVhZGxpbmUoKSkuZGVjb2RlKCpERUNPREVfQVJHUyk6CiAgICAgICAgIyBTdHJpcCB0aGUgdGltZXN0YW1wL3Byb2Nlc3MgcHJlZml4IGZyb20gZWFjaCBsb2cgbGluZQogICAgICAgIGxpbmUgPSBMT0dfUFJFRklYX1JFR0VYLnN1YigiIiwgbGluZSkKICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKGxpbmUpCiAgICAgICAgc3lzLnN0ZG91dC5mbHVzaCgpCgogICAgc3RhdHVzID0gcHJvY2Vzcy53YWl0KHRpbWVvdXQ9NSkKICAgIGV4aXQoc3RhdHVzKQoKCmRlZiBjb3B5KHNyYywgdGd0KToKICAgICIiIkFuIGFsbC1wdXJwb3NlIGNvcHkuCgogICAgSWYgc3JjIGlzIGEgZmlsZSwgaXQgaXMgY29waWVkLiBJZiBzcmMgaXMgYSBzeW1saW5rLCBpdCBpcyBjb3BpZWQgKmFzIGEKICAgIHN5bWxpbmsqLiBJZiBzcmMgaXMgYSBkaXJlY3RvcnksIHRoZSBmdWxsIHRyZWUgaXMgZHVwbGljYXRlZCwgd2l0aCBzeW1saW5rcwogICAgYmVpbmcgcHJlc2VydmVkLgogICAgIiIiCiAgICBpZiBzcmMuaXNfZmlsZSgpIG9yIHNyYy5pc19zeW1saW5rKCk6CiAgICAgICAgc2h1dGlsLmNvcHlmaWxlKHNyYywgdGd0LCBmb2xsb3dfc3ltbGlua3M9RmFsc2UpCiAgICBlbHNlOgogICAgICAgIHNodXRpbC5jb3B5dHJlZShzcmMsIHRndCwgc3ltbGlua3M9VHJ1ZSkKCgpkZWYgY2xvbmVfdGVzdGJlZCgKICAgIHNvdXJjZTogUGF0aCwKICAgIHRhcmdldDogUGF0aCwKICAgIGZyYW1ld29yazogUGF0aCwKICAgIHBsYXRmb3JtOiBzdHIsCiAgICBhcHBzOiBsaXN0W1BhdGhdLAopIC0+IE5vbmU6CiAgICBpZiB0YXJnZXQuZXhpc3RzKCk6CiAgICAgICAgcHJpbnQoZiJ7dGFyZ2V0fSBhbHJlYWR5IGV4aXN0czsgYWJvcnRpbmcgd2l0aG91dCBjcmVhdGluZyBwcm9qZWN0LiIpCiAgICAgICAgc3lzLmV4aXQoMTApCgogICAgaWYgZnJhbWV3b3JrIGlzIE5vbmU6CiAgICAgICAgaWYgbm90ICgKICAgICAgICAgICAgc291cmNlIC8gIlB5dGhvbi54Y2ZyYW1ld29yayIgLyBURVNUX1NMSUNFU1twbGF0Zm9ybV0gLyAiYmluIgogICAgICAgICkuaXNfZGlyKCk6CiBvbGRfZ3JvdXAgPSBvbGRfc25hcHNob3QuX2dyb3VwX2J5KGtleV90eXBlLCBjdW11bGF0aXZlKQogICAgICAgIHN0YXRpc3RpY3MgPSBfY29tcGFyZV9ncm91cGVkX3N0YXRzKG9sZF9ncm91cCwgbmV3X2dyb3VwKQogICAgICAgIHN0YXRpc3RpY3Muc29ydChyZXZlcnNlPVRydWUsIGtleT1TdGF0aXN0aWNEaWZmLl9zb3J0X2tleSkKICAgICAgICByZXR1cm4gc3RhdGlzdGljcwoKCmRlZiB0YWtlX3NuYXBzaG90KCk6CiAgICAiIiIKICAgIFRha2UgYSBzbmFwc2hvdCBvZiB0cmFjZXMgb2YgbWVtb3J5IGJsb2NrcyBhbGxvY2F0ZWQgYnkgUHl0aG9uLgogICAgIiIiCiAgICBpZiBub3QgaXNfdHJhY2luZygpOgogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcigidGhlIHRyYWNlbWFsbG9jIG1vZHVsZSBtdXN0IGJlIHRyYWNpbmcgbWVtb3J5ICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgImFsbG9jYXRpb25zIHRvIHRha2UgYSBzbmFwc2hvdCIpCiAgICB0cmFjZXMgPSBfZ2V0X3RyYWNlcygpCiAgICB0cmFjZWJhY2tfbGltaXQgPSBnZXRfdHJhY2ViYWNrX2xpbWl0KCkKICAgIHJldHVybiBTbmFwc2hvdCh0cmFjZXMsIHRyYWNlYmFja19saW1pdCkKIyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwojCiMgJElkOiBuY3Vyc2VzLnB5IDM2NTU5IDIwMDQtMDctMTggMDU6NTY6MDlaIHRpbV9vbmUgJAojCiMgSW50ZXJhY3RpdmUgdGVzdCBzdWl0ZSBmb3IgdGhlIGN1cnNlcyBtb2R1bGUuCiMgVGhpcyBzY3JpcHQgZGlzcGxheXMgdmFyaW91cyB0aGluZ3MgYW5kIHRoZSB1c2VyIHNob3VsZCB2ZXJpZnkgd2hldGhlcgojIHRoZXkgZGlzcGxheSBjb3JyZWN0bHkuCiMKCmltcG9ydCBjdXJzZXMKZnJvbSBjdXJzZXMgaW1wb3J0IHRleHRwYWQKCmRlZiB0ZXN0X3RleHRwYWQoc3Rkc2NyLCBpbnNlcnRfbW9kZT1GYWxzZSk6CiAgICBuY29scywgbmxpbmVzID0gOCwgMwogICAgdWx5LCB1bHggPSAzLCAyCiAgICBpZiBpbnNlcnRfbW9kZToKICAgICAgICBtb2RlID0gJ2luc2VydCBtb2RlJwogICAgZWxzZToKICAgICAgICBtb2RlID0gJ292ZXJ3cml0ZSBtb2RlJwoKICAgIHN0ZHNjci5hZGRzdHIodWx5LTMsIHVseCwgIlVzZSBDdHJsLUcgdG8gZW5kIGVkaXRpbmcgKCVzKS4iICUgbW9kZSkKICAgIHN0ZHNjci5hZGRzdHIodWx5LTIsIHVseCwgIkJlIHN1cmUgdG8gdHJ5IHR5cGluZyBpbiB0aGUgbG93ZXItcmlnaHQgY29ybmVyLiIpCiAgICB3aW4gPSBjdXJzZXMubmV3d2luKG5saW5lcywgbmNvbHMsIHVseSwgdWx4KQogICAgdGV4dHBhZC5yZWN0YW5nbGUoc3Rkc2NyLCB1bHktMSwgdWx4LTEsIHVseSArIG5saW5lcywgdWx4ICsgbmNvbHMpCiAgICBzdGRzY3IucmVmcmVzaCgpCgogICAgYm94ID0gdGV4dHBhZC5UZXh0Ym94KHdpbiwgaW5zZXJ0X21vZGUpCiAgICBjb250ZW50cyA9IGJveC5lZGl0KCkKICAgIHN0ZHNjci5hZGRzdHIodWx5K25jb2xzKzIsIDAsICJUZXh0IGVudGVyZWQgaW4gdGhlIGJveFxuIikKICAjIGhhdmluZyBhIChwb3NzaWJseSBlbXB0eSkgaW50ZWdlciBwYXJ0CiAgICAoPzpcLig/UDxmcmFjPlxkKikpPyAgICAgIyBmb2xsb3dlZCBieSBhbiBvcHRpb25hbCBmcmFjdGlvbmFsIHBhcnQKICAgICg/OkUoP1A8ZXhwPlstK10/XGQrKSk/ICAjIGFuZCBhbiBvcHRpb25hbCBleHBvbmVudAogICAgXHoKIiIiLCByZS5WRVJCT1NFIHwgcmUuSUdOT1JFQ0FTRSkubWF0Y2gKCiMgUHVyZSBQeXRob24gdmVyc2lvbiBvZiBjb3JyZWN0bHkgcm91bmRlZCBzdHJpbmctPmZsb2F0IGNvbnZlcnNpb24uCiMgQXZvaWRzIGFueSB1c2Ugb2YgZmxvYXRpbmctcG9pbnQgYnkgcmV0dXJuaW5nIHRoZSByZXN1bHQgYXMgYSBoZXggc3RyaW5nLgpkZWYgc3RydG9kKHMsIG1hbnRfZGlnPTUzLCBtaW5fZXhwID0gLTEwMjEsIG1heF9leHAgPSAxMDI0KToKICAgICIiIkNvbnZlcnQgYSBmaW5pdGUgZGVjaW1hbCBzdHJpbmcgdG8gYSBoZXggc3RyaW5nIHJlcHJlc2VudGluZyBhbgogICAgSUVFRSA3NTQgYmluYXJ5NjQgZmxvYXQuICBSZXR1cm4gJ2luZicgb3IgJy1pbmYnIG9uIG92ZXJmbG93LgogICAgVGhpcyBmdW5jdGlvbiBtYWtlcyBubyB1c2Ugb2YgZmxvYXRpbmctcG9pbnQgYXJpdGhtZXRpYyBhdCBhbnkKICAgIHN0YWdlLiIiIgoKICAgICMgcGFyc2Ugc3RyaW5nIGludG8gYSBwYWlyIG9mIGludGVnZXJzICdhJyBhbmQgJ2InIHN1Y2ggdGhhdAogICAgIyBhYnMoZGVjaW1hbCB2YWx1ZSkgPSBhL2IsIGFsb25nIHdpdGggYSBib29sZWFuICduZWdhdGl2ZScuCiAgICBtID0gc3RydG9kX3BhcnNlcihzKQogICAgaWYgbSBpcyBOb25lOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ2ludmFsaWQgbnVtZXJpYyBzdHJpbmcnKQogICAgZnJhY3Rpb24gPSBtLmdyb3VwKCdmcmFjJykgb3IgJycKICAgIGludHBhcnQgPSBpbnQobS5ncm91cCgnaW50JykgKyBmcmFjdGlvbikKICAgIGV4cCA9IGludChtLmdyb3VwKCdleHAnKSBvciAnMCcpIC0gbGVuKGZyYWN0aW9uKQogICAgbmVnYXRpdmUgPSBtLmdyb3VwKCdzaWduJykgPT0gJy0nCiAgICBhLCBiID0gaW50cGFydCoxMCoqbWF4KGV4cCwgMCksIDEwKiptYXgoMCwgLWV4cCkKCiAgICAjIHF1aWNrIHJldHVybiBmb3IgemVyb3MKICAgIGlmIG5vdCBhOgogICAgICAgIHJldHVybiAnLTB4MC4wcCswJyBpZiBuZWdhdGl2ZSBlbHNlICcweDAuMHArMCcKCiAgICAjIGNvbXB1dGUgZXhwb25lbnQgZSBmb3IgcmVzdWx0OyBtYXkgYmUgb25lIHRvbyBzbWFsbCBpbiB0aGUgY2FzZQogICAgIyB0aGF0IHRoZSByb3VuZGVkIHZhbHVlIG9mIGEvYiBsaWVzIGluIGEgZGlmZmVyZW50IGJpbmFkZSBmcm9tIGEvYgogICAgZCA9IGEuYml0X2xlbmd0aCgpIC0gYi5iaXRfbGVuZ3RoKCkKICAgIGQgKz0gKGEgPj4gZCBpZiBkID49IDAgZWxzZSBhIDw8IC1kKSA+PSBiCiAgICBlID0gbWF4KGQsIG1pbl9leHApIC0gbWFudF9kaWcKCiAgICAjIGFwcHJveGltYXRlIGEvYiBieSBudW1iaW9uIGNoYWluIGRldGVjdGVkOiBleGNlcHRpb24gJ2lubmVyJyAiCiAgICAgICAgICAgICJlbmNvdW50ZXJlZCBhZ2Fpbi4iCiAgICAgICAgKQogICAgICAgIHdpdGggc2VsZi5hc3NlcnRXYXJuc01lc3NhZ2UoRXhjZXB0aW9uQ3ljbGVXYXJuaW5nLCBtc2cpOgogICAgICAgICAgICB0Yl9nZW5lcmF0b3Iuc3RhcnQoKQogICAgICAgIHRiX2dlbmVyYXRvci5qb2luKHRpbWVvdXQ9NSkKICAgICAgICBpZiB0Yl9nZW5lcmF0b3IuaXNfYWxpdmUoKToKICAgICAgICAgICAgIyB0Yl9nZW5lcmF0b3IgaXMgYSBkYWVtb24gdGhhdCBydW5zIHVudGlsIHRoZSBtYWluIHRocmVhZC9wcm9jZXNzCiAgICAgICAgICAgICMgZXhpdHMuIFRoaXMgaXMgcmVzb3VyY2UgaGVhdnkgd2hlbiBydW5uaW5nIHRoZSBmdWxsIHRlc3Qgc3VpdGUuCiAgICAgICAgICAgICMgU2V0dGluZyB0aGUgZm9sbG93aW5nIHZhbHVlcyB0byBOb25lIG1ha2VzCiAgICAgICAgICAgICMgcmVwb3J0ZXIuZ2V0X3RyYWNlYmFja19mcmFtZXMoKSBleGl0IGVhcmx5LgogICAgICAgICAgICBleGNfdmFsdWUuX190cmFjZWJhY2tfXyA9IGV4Y192YWx1ZS5fX2NvbnRleHRfXyA9IGV4Y192YWx1ZS5fX2NhdXNlX18gPSBOb25lCiAgICAgICAgICAgIHRiX2dlbmVyYXRvci5qb2luKCkKICAgICAgICAgICAgc2VsZi5mYWlsKCJDeWNsaWMgcmVmZXJlbmNlIGluIEV4Y2VwdGlvbiBSZXBvcnRlci5nZXRfdHJhY2ViYWNrX2ZyYW1lcygpIikKICAgICAgICBpZiB0Yl9mcmFtZXMgaXMgTm9uZToKICAgICAgICAgICAgIyBjYW4gaGFwcGVuIGlmIHRoZSB0aHJlYWQgZ2VuZXJhdGluZyB0cmFjZWJhY2sgZ290IGtpbGxlZAogICAgICAgICAgICAjIG9yIGV4Y2VwdGlvbiB3aGlsZSBnZW5lcmF0aW5nIHRoZSB0cmFjZWJhY2sKICAgICAgICAgICAgc2VsZi5mYWlsKCJUcmFjZWJhY2sgZ2VuZXJhdGlvbiBmYWlsZWQiKQogICAgICAgIGxhc3RfZnJhbWUgPSB0Yl9mcmFtZXNbLTFdCiAgICAgICAgc2VsZi5hc3NlcnRJbigicmFpc2UgZXhjLl9fY2F1c2VfXyIsIGxhc3RfZnJhbWVbImNvbnRleHRfbGluZSJdKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwobGFzdF9mcmFtZVsiZmlsZW5hbWUiXSwgX19maWxlX18pCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChsYXN0X2ZyYW1lWyJmdW5jdGlvbiJdLCAidGVzdF9mdW5jIikKCiAgICBkZWYgdGVzdF9yZXF1ZXN0X2FuZF9tZXNzYWdlKHNlbGYpOgogICAgICAgICJBIG1lc3NhZ2UgY2FuIGJlIHByb3ZpZGVkIGluIGFkZGl0aW9uIHRvIGEgcmVxdWVzdCIKICAgICAgICByZXF1ZXN0ID0gc2VsZi5yZi5nZXQoIi90ZXN0X3ZpZXcvIikKICAgICAgICByZXBvcnRlciA9IEV4Y2VwdGlvblJlcG9ydGVyKHJlcXVlc3QsIE5vbmUsICJJJ20gYSBsaXR0bGUgdGVhcG90IiwgTm9uZSkKICAgICAgICBodG1sID0gcmVwb3J0ZXIuZ2V0X3RyYWNlYmFja19odG1sKCkKICAgICAgICBzZWxmLmFzc2VydEluSFRNTCgiPGgxPlJlcG9ydCBhdCAvdGVzdGF0dHIsIG9zLnBhdGgsICdpc2RpcicsIG9zLnBhdGguaXNkaXIpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHN5cy5wYXRoLl9fc2V0aXRlbV9fLCBzbGljZShOb25lKSwgbGlzdChzeXMucGF0aCkpCiAgICAgICAgZGVmIGxpc3RfZGlyKHBhdGgpOgogICAgICAgICAgICByZXR1cm4gbGlzdCh2ZnNbcGF0aF0pCiAgICAgICAgb3MubGlzdGRpciA9IGxpc3RfZGlyCiAgICAgICAgb3MucGF0aC5pc2RpciA9IGxhbWJkYSBwYXRoOiBub3QgcGF0aC5lbmRzd2l0aCgnLnB5JykKICAgICAgICBvcy5wYXRoLmlzZmlsZSA9IGxhbWJkYSBwYXRoOiBwYXRoLmVuZHN3aXRoKCcucHknKQoKICAgIGRlZiB0ZXN0X2Rpc2NvdmVyX3dpdGhfbW9kdWxlc190aGF0X2ZhaWxfdG9faW1wb3J0KHNlbGYpOgogICAgICAgIGxvYWRlciA9IHVuaXR0ZXN0LlRlc3RMb2FkZXIoKQoKICAgICAgICBzZWxmLnNldHVwX2ltcG9ydF9pc3N1ZV90ZXN0cygndGVzdF90aGlzX2RvZXNfbm90X2V4aXN0LnB5JykKCiAgICAgICAgc3VpdGUgPSBsb2FkZXIuZGlzY292ZXIoJy4nKQogICAgICAgIHNlbGYuYXNzZXJ0SW4ob3MuZ2V0Y3dkKCksIHN5cy5wYXRoKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoc3VpdGUuY291bnRUZXN0Q2FzZXMoKSwgMSkKICAgICAgICAjIEVycm9ycyBsb2FkaW5nIHRoZSBzdWl0ZSBhcmUgYWxzbyBjYXB0dXJlZCBmb3IgaW50cm9zcGVjdGlvbi4KICAgICAgICBzZWxmLmFzc2VydE5vdEVxdWFsKFtdLCBsb2FkZXIuZXJyb3JzKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoMSwgbGVuKGxvYWRlci5lcnJvcnMpKQogICAgICAgIGVycm9yID0gbG9hZGVyLmVycm9yc1swXQogICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZSgKICAgICAgICAgICAgJ0ZhaWxlZCB0byBpbXBvcnQgdGVzdCBtb2R1bGU6IHRlc3RfdGhpc19kb2VzX25vdF9leGlzdCcgaW4gZXJyb3IsCiAgICAgICAgICAgICdtaXNzaW5nIGVycm9yIHN0cmluZyBpbiAlcicgJSBlcnJvcikKICAgICAgICB0ZXN0ID0gbGlzdChsaXN0KHN1aXRlKVswXSlbMF0gIyBleHRyYWN0IHRlc3QgZnJvbSBzdWl0ZQoKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzKEltcG9ydEVycm9yKToKICAgICAgICAgICAgdGVzdC50ZXN0X3RoaXNfZG9lc19ub3RfZXhpc3QoKQoKICAgIGRlZiB0ZXN0X2Rpc2NvdmVyX3dpdGhfaW5pdF9tb2R1bGVzX3RoYXRfZmFpbF90b19pbXBvcnQoc2VsZik6CiAgICAgICAgdmZzID0ge2Fic3BhdGgoJy9mb28nKTogWydteV9wYWNrYWdlJ10sCiAgICAgICAgICAgICAgIGFic3BhdGgoJy9mb28vbXlfcGFja2FnZScpOiBbJ19faW5pdF9fLnB5JywgJ3Rlc3RfbW9kdWxlLnB5J119CiAgICAgICAgc2VsZi5zZXR1cF9pbXBvcnRfaXNzdWVfcGFja2FnZV90ZXN0cyh2ZnMpCiAgICAgICAgaW1wb3J0X2NhbGxzID0gW10KICAgICAgICBkZWYgX2dldF9tb2R1bGVfZnJvbV9uYW1lKG5hbWUpOgogICAgICAgICAgICBpbXBvcnRfY2FsbHMuYXBwZW5kKG5hbWVlbGRzPXJlc3VsdF9maWVsZHMsCiAgICAgICAgc2l6ZT1hbGlnbmVkX3NpemUsCiAgICAgICAgYWxpZ249YWxpZ24sCiAgICAgICAgZm9ybWF0X3NwZWM9IiIuam9pbihmb3JtYXRfc3BlY19wYXJ0cyksCiAgICApCgoKZGVmIHBhZGRpbmdfc3BlYyhwYWRkaW5nKToKICAgIGlmIHBhZGRpbmcgPD0gMDoKICAgICAgICByZXR1cm4gIiIKICAgIGlmIHBhZGRpbmcgPT0gMToKICAgICAgICByZXR1cm4gIngiCiAgICByZXR1cm4gZiJ7cGFkZGluZ314IgojIS91c3IvYmluL2VudiBweXRob24KIwojIFRoaXMgUHl0aG9uIGZpbGUgY29udGFpbnMgdXRpbGl0eSBzY3JpcHRzIHRvIG1hbmFnZSBEamFuZ28gdHJhbnNsYXRpb25zLgojIEl0IGhhcyB0byBiZSBydW4gaW5zaWRlIHRoZSBkamFuZ28gZ2l0IHJvb3QgZGlyZWN0b3J5LgojCiMgVGhlIGZvbGxvd2luZyBjb21tYW5kcyBhcmUgYXZhaWxhYmxlOgojCiMgKiB1cGRhdGVfY2F0YWxvZ3M6IGNoZWNrIGZvciBuZXcgc3RyaW5ncyBpbiBjb3JlIGFuZCBjb250cmliIGNhdGFsb2dzLCBhbmQKIyAgICAgICAgICAgICAgICAgICAgb3V0cHV0IGhvdyBtdWNoIHN0cmluZ3MgYXJlIG5ldy9jaGFuZ2VkLgojCiMgKiBsYW5nX3N0YXRzOiBvdXRwdXQgc3RhdGlzdGljcyBmb3IgZWFjaCBjYXRhbG9nL2xhbmd1YWdlIGNvbWJpbmF0aW9uCiMKIyAqIGZldGNoOiBmZXRjaCB0cmFuc2xhdGlvbnMgZnJvbSB0cmFuc2lmZXguY29tCiMKIyBFYWNoIGNvbW1hbmQgc3VwcG9ydCB0aGUgLS1sYW5ndWFnZXMgYW5kIC0tcmVzb3VyY2VzIG9wdGlvbnMgdG8gbGltaXQgdGhlaXIKIyBvcGVyYXRpb24gdG8gdGhlIHNwZWNpZmllZCBsYW5ndWFnZSBvciByZXNvdXJjZS4gRm9yIGV4YW1wbGUsIHRvIGdldCBzdGF0cwojIGZvciBTcGFuaXNoIGluIGNvbnRyaWIuYWRtaW4sIHJ1bjoKIwojICAkIHB5dGhvbiBzY3JpcHRzL21hbmFnZV90cmFuc2xhdGlvbnMucHkgbGFuZ19zdGF0cyAtbCBlcyAtciBhZG1pbgojCiMgQWxzbyBlYWNoIGNvbW1hbmQgc3VwcG9ydHMgYSAtLXZlcmJvc2l0eSBvcHRpb24gdG8gZ2V0IHByb2dyZXNzIGZlZWRiYWNrLgoKaW1wb3J0IGpzb24KaW1wb3J0IG9zCmltcG9ydCBzdWJwcm9jZXNzCmZyb20gYXJncGFyc2UgaW1wb3J0IEFyZ3VtZW50UGFyc2VyCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IGRlZmF1bHRkaWN0CmZyb20gY29uZmlncGFyc2VyIGltcG9ydCBDb25maWdQYXJzZXIKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKZnJvbSBpdGVydG9vbHMgaW1wb3J0IHByb2R1Y3QKCmltcG9ydCByZXF1ZXN0cwoKaW1wb3J0IGRqYW5nbwpmcm9tIGRqYW5nby5jb25mIGltcG9ydCBzZXR0aW5ncwpmcm9tIGRqYW5nby5jb3JlLm1hbmFnZW1lbnQgaW1wb3J0IGNhbGxfY29tbWFuZAoKSEFWRV9KUyA9IFsiYWRtaW4iXQpMQU5HX09WRVJSSURFUyA9IHsKICAgICJ6aF9DTiI6ICJ6aF9IYW5zIiwKICAgICJ6aF9UVyI6ICJ6aF9IYW50IiwKfQoKCmRlZiBydW4oKmFyZ3MsIHZpb25zLmJhY2tlbmRzLmNhY2hlIGltcG9ydCBTZXNzaW9uU3RvcmUKZnJvbSBkamFuZ28uY29yZS5leGNlcHRpb25zIGltcG9ydCBJbXByb3Blcmx5Q29uZmlndXJlZApmcm9tIGRqYW5nby5odHRwIGltcG9ydCBIdHRwUmVxdWVzdCwgSHR0cFJlc3BvbnNlLCBVbnJlYWRhYmxlUG9zdEVycm9yCmZyb20gZGphbmdvLm1pZGRsZXdhcmUuY3NyZiBpbXBvcnQgKAogICAgQ1NSRl9BTExPV0VEX0NIQVJTLAogICAgQ1NSRl9TRUNSRVRfTEVOR1RILAogICAgQ1NSRl9TRVNTSU9OX0tFWSwKICAgIENTUkZfVE9LRU5fTEVOR1RILAogICAgUkVBU09OX0JBRF9PUklHSU4sCiAgICBSRUFTT05fQ1NSRl9UT0tFTl9NSVNTSU5HLAogICAgUkVBU09OX05PX0NTUkZfQ09PS0lFLAogICAgQ3NyZlZpZXdNaWRkbGV3YXJlLAogICAgSW52YWxpZFRva2VuRm9ybWF0LAogICAgUmVqZWN0UmVxdWVzdCwKICAgIF9jaGVja190b2tlbl9mb3JtYXQsCiAgICBfZG9lc190b2tlbl9tYXRjaCwKICAgIF9tYXNrX2NpcGhlcl9zZWNyZXQsCiAgICBfdW5tYXNrX2NpcGhlcl90b2tlbiwKICAgIGdldF90b2tlbiwKICAgIHJvdGF0ZV90b2tlbiwKKQpmcm9tIGRqYW5nby50ZXN0IGltcG9ydCBTaW1wbGVUZXN0Q2FzZSwgb3ZlcnJpZGVfc2V0dGluZ3MKZnJvbSBkamFuZ28udmlld3MuZGVjb3JhdG9ycy5jc3JmIGltcG9ydCBjc3JmX2V4ZW1wdCwgcmVxdWlyZXNfY3NyZl90b2tlbgoKZnJvbSAudmlld3MgaW1wb3J0ICgKICAgIGVuc3VyZV9jc3JmX2Nvb2tpZV92aWV3LAogICAgZW5zdXJlZF9hbmRfcHJvdGVjdGVkX3ZpZXcsCiAgICBub25fdG9rZW5fdmlld191c2luZ19yZXF1ZXN0X3Byb2Nlc3NvciwKICAgIHBvc3RfZm9ybV92aWV3LAogICAgcHJvdGVjdGVkX3ZpZXcsCiAgICBzYW5kd2ljaGVkX3JvdGF0ZV90b2tlbl92aWV3LAogICAgdG9rZW5fdmlldywKKQoKIyBUaGlzIGlzIGEgdGVzdCAodW5tYXNrZWQpIENTUkYgY29va2llIC8gc2VjcmV0LgpURVNUX1NFQ1JFVCA9ICJsY2NjY2NjY1gya2NjY2NjY2NZMmpjY2NjY2Njc3NJQyIKIyBUd28gbWFza2VkIHZlcnNpb25zIG9mIFRFU1RfU0VDUkVUIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgpNQVNLRURfVEVTVF9TRUNSRVQxID0gIjFiY2RlZmdoaWoyYmNkZWZnaGlqM2JjZGVmZ2hpajRiY2RlZmdoaWo1YmNkZWZnaGlqNmJjZGVmZ2hpakFCQ0QiCk1BU0tFRF9URVNUX1NFQ1JFVDIgPSAiMkpnY2hXdk0xdHB4VDJsZno5YXlkb1hXOXlUMUROM05kTGllall4T09senpWNG5oQmJZcW1xWlliQVYzVjVCZiIKCgpjbGFzcyBDc3JmRnVuY3Rpb25UZXN0TWl4aW46CiAgICAjIFRoaXMgbWV0aG9kIGRlcGVuZHMgb24gX3VubWFza19jaXBoZXJfdG9rZW4oKSBiZWluZyBjb3JyZWN0LgogICAgZGVmIGFzc2VydE1hc2tlZFNlY3JldENvcnJlY3Qoc2VsZiwgbWFza2VkX3NlY3JldCwgc2VjcmV0KToKICAgICAgICAiIiJUZXN0IHRoYXQgYSBzdHJpbmcgaXMgYSB2YWxpZCBtYXNrZWQgdmVyc2lvbiBvZiBhIHNlY3IgMCA8PSBYIDw9IG4KCiAgICAgICAgVGhlIGludGVnZXIgaXMgY2hvc2VuIHdpdGggdGhlIHByb2JhYmlsaXR5OgoKICAgICAgICAgICAgUChYID09IGspID0gbWF0aC5jb21iKG4sIGspICogcCAqKiBrICogKDEgLSBwKSAqKiAobiAtIGspCgogICAgICAgIFRoZSBtZWFuIChleHBlY3RlZCB2YWx1ZSkgYW5kIHZhcmlhbmNlIG9mIHRoZSByYW5kb20gdmFyaWFibGUgYXJlOgoKICAgICAgICAgICAgRVtYXSA9IG4gKiBwCiAgICAgICAgICAgIFZhcltYXSA9IG4gKiBwICogKDEgLSBwKQoKICAgICAgICAiIiIKICAgICAgICAjIEVycm9yIGNoZWNrIGlucHV0cyBhbmQgaGFuZGxlIGVkZ2UgY2FzZXMKICAgICAgICBpZiBuIDwgMDoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigibiBtdXN0IGJlIG5vbi1uZWdhdGl2ZSIpCiAgICAgICAgaWYgcCA8PSAwLjAgb3IgcCA+PSAxLjA6CiAgICAgICAgICAgIGlmIHAgPT0gMC4wOgogICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgaWYgcCA9PSAxLjA6CiAgICAgICAgICAgICAgICByZXR1cm4gbgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJwIG11c3QgYmUgaW4gdGhlIHJhbmdlIDAuMCA8PSBwIDw9IDEuMCIpCgogICAgICAgIHJhbmRvbSA9IHNlbGYucmFuZG9tCgogICAgICAgICMgRmFzdCBwYXRoIGZvciBhIGNvbW1vbiBjYXNlCiAgICAgICAgaWYgbiA9PSAxOgogICAgICAgICAgICByZXR1cm4gX2luZGV4KHJhbmRvbSgpIDwgcCkKCiAgICAgICAgIyBFeHBsb2l0IHN5bW1ldHJ5IHRvIGVzdGFibGlzaDogIHAgPD0gMC41CiAgICAgICAgaWYgcCA+IDAuNToKICAgICAgICAgICAgcmV0dXJuIG4gLSBzZWxmLmJpbm9taWFsdmFyaWF0ZShuLCAxLjAgLSBwKQoKICAgICAgICBpZiBuICogcCA8IDEwLjA6CiAgICAgICAgICAgICMgQkc6IEdlb21ldHJpYyBtZXRob2QgYnkgRGV2cm95ZSB3aXRoIHJ1bm5pbmcgdGltZSBvZiBPKG5wKS4KICAgICAgICAgICAgIyBodHRwczovL2RsLmFjbS5vcmcvZG9pL3BkZi8xMC4xMTQ1LzQyMzcyLjQyMzgxCiAgICAgICAgICAgIHggPSB5ID0gMAogICAgICAgICAgICBjID0gX2xvZzIoMS4wIC0gcCkKICAgICAgICAgICAgaWYgbm90IGM6CiAgICAgICAgICAgICAgICByZXR1cm4geAogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgeSArPSBfZmxvb3IoX2xvZzIocmFuZG9tKCkpIC8gYykgKyAxCiAgICAgICAgICAgICAgICBpZiB5ID4gbjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4geAogICAgICAgICAgICAgICAgeCArPSAxCgogICAgICAgICMgQlRSUzogVHJhbnNmb3JtZWQgcmVqZWN0aW9uIHdpdGggc3F1ZWV6ZSBtZXRob2QgYnkgV29sZmdhbmcgSMO2cm1hbm4KICAgICAgICAjIGh0dHBzOi8vY2l0ZXNlZXJ4LmlzdC5wc3UuZWR1L3ZpZXdkb2MvZG93bmxvYWQ/ZG9pPTEwLjEuMS40Ny44NDA3JnJlcD1yZXAxJnR5cGU9cGRmCiAgICAgICAgYXNzZXJ0IG4qcCA+PSAxMC4wIGFuZCB1YWwobS5zaXplKCksIDB4MTgwMDAwMDAwKQoKICAgICMgSXNzdWUgMTEyNzc6IG1tYXAoKSB3aXRoIGxhcmdlICh+NCBHaUIpIHNwYXJzZSBmaWxlcyBjcmFzaGVzIG9uIE9TIFguCgogICAgZGVmIF90ZXN0X2Fyb3VuZF9ib3VuZGFyeShzZWxmLCBib3VuZGFyeSk6CiAgICAgICAgdGFpbCA9IGInICBERUFSZGVhciAgJwogICAgICAgIHN0YXJ0ID0gYm91bmRhcnkgLSBsZW4odGFpbCkgLy8gMgogICAgICAgIGVuZCA9IHN0YXJ0ICsgbGVuKHRhaWwpCiAgICAgICAgd2l0aCBzZWxmLl9tYWtlX3Rlc3RfZmlsZShzdGFydCwgdGFpbCkgYXMgZjoKICAgICAgICAgICAgd2l0aCBtbWFwLm1tYXAoZi5maWxlbm8oKSwgMCwgYWNjZXNzPW1tYXAuQUNDRVNTX1JFQUQpIGFzIG06CiAgICAgICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKG1bc3RhcnQ6ZW5kXSwgdGFpbCkKCiAgICBAdW5pdHRlc3Quc2tpcFVubGVzcyhzeXMubWF4c2l6ZSA+IF80RywgInRlc3QgY2Fubm90IHJ1biBvbiAzMi1iaXQgc3lzdGVtcyIpCiAgICBkZWYgdGVzdF9hcm91bmRfMkdCKHNlbGYpOgogICAgICAgIHNlbGYuX3Rlc3RfYXJvdW5kX2JvdW5kYXJ5KF8yRykKCiAgICBAdW5pdHRlc3Quc2tpcFVubGVzcyhzeXMubWF4c2l6ZSA+IF80RywgInRlc3QgY2Fubm90IHJ1biBvbiAzMi1iaXQgc3lzdGVtcyIpCiAgICBkZWYgdGVzdF9hcm91bmRfNEdCKHNlbGYpOgogICAgICAgIHNlbGYuX3Rlc3RfYXJvdW5kX2JvdW5kYXJ5KF80RykKCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAgdW5pdHRlc3QubWFpbigpCmZyb20gcHlnbWVudHMubGV4ZXIgaW1wb3J0IFJlZ2V4TGV4ZXIsIGJ5Z3JvdXBzLCBpbmNsdWRlCmZyb20gcHlnbWVudHMudG9rZW4gaW1wb3J0IENvbW1lbnQsIEtleXdvcmQsIE5hbWUsIE9wZXJhdG9yLCBQdW5jdHVhdGlvbiwgVGV4dAoKCmNsYXNzIFBFR0xleGVyKFJlZ2V4TGV4ZXIpOgogICAgIiIiUHlnbWVudHMgTGV4ZXIgZm9yIFBFRyBncmFtbWFyICguZ3JhbSkgZmlsZXMKCiAgICBUaGlzIGxleGVyIHN0cmlwcyB0aGUgZm9sbG93aW5nIGVsZW1lbnRzIGZyb20gdGhlIGdyYW1tYXI6CgogICAgICAgIC0gTWV0YS10YWdzCiAgICAgICAgLSBWYXJpYWJsZSBhc3NpZ25tZW50cwogICAgICAgIC0gQWN0aW9ucwogICAgICAgIC0gTG9va2FoZWFkcwogICAgICAgIC0gUnVsZSB0eXBlcwogICAgICAgIC0gUnVsZSBvcHRpb25zCiAgICAgICAgLSBSdWxlcyBuYW1lZCBgaW52YWxpZF8qYCBvciBgaW5jb3JyZWN0XypgCiAgICAiIiIKCiAgICBuYW1lID0gIlBFRyIKICAgIGFsaWFzZXMgPSBbInBlZyJdCiAgICBmaWxlbmFtZXMgPSBbIiouZ3JhbSJdCiAgICBfbmFtZSA9IHIiKFteXFdcZF1cdyopIgogICAgX3RleHRfd3MgPSByIihccyopIgoKICAgIHRva2VucyA9IHsKICAgICAgICAid3MiOiBbKHIiXG4iLCBUZXh0KSwgKHIiXHMrIiwgVGV4dCksIChyIiMuKiQiLCBDb21tZW50LlNpbmdsZWxpbmUpLF0sCiAgICAgICAgImxvb2tmZmVyLnJhdy5jbG9zZWZkLCBUcnVlKQogICAgICAgICAgICBmaWxlID0gc2VsZi5vcGVuKGYuZmlsZW5vKCksICJyIiwgZW5jb2Rpbmc9InV0Zi04IiwgY2xvc2VmZD1GYWxzZSkKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChmaWxlLmJ1ZmZlci5yYXcuY2xvc2VmZCwgRmFsc2UpCgogICAgZGVmIHRlc3RfZ2FyYmFnZV9jb2xsZWN0aW9uKHNlbGYpOgogICAgICAgICMgRmlsZUlPIG9iamVjdHMgYXJlIGNvbGxlY3RlZCwgYW5kIGNvbGxlY3RpbmcgdGhlbSBmbHVzaGVzCiAgICAgICAgIyBhbGwgZGF0YSB0byBkaXNrLgogICAgICAgICMKICAgICAgICAjIE5vdGUgdGhhdCB1c2luZyB3YXJuaW5nc19oZWxwZXIuY2hlY2tfd2FybmluZ3MoKSB3aWxsIGtlZXAgdGhlCiAgICAgICAgIyBmaWxlIGFsaXZlIGR1ZSB0byB0aGUgYHNvdXJjZWAgYXJndW1lbnQgdG8gd2FybigpLiAgU28sIHVzZQogICAgICAgICMgY2F0Y2hfd2FybmluZ3MoKSBpbnN0ZWFkLgogICAgICAgIHdpdGggd2FybmluZ3MuY2F0Y2hfd2FybmluZ3MoKToKICAgICAgICAgICAgd2FybmluZ3Muc2ltcGxlZmlsdGVyKCJpZ25vcmUiLCBSZXNvdXJjZVdhcm5pbmcpCiAgICAgICAgICAgIGYgPSBzZWxmLkZpbGVJTyhvc19oZWxwZXIuVEVTVEZOLCAid2IiKQogICAgICAgICAgICBmLndyaXRlKGIiYWJjeHh4IikKICAgICAgICAgICAgZi5mID0gZgogICAgICAgICAgICB3ciA9IHdlYWtyZWYucmVmKGYpCiAgICAgICAgICAgIGRlbCBmCiAgICAgICAgICAgIHN1cHBvcnQuZ2NfY29sbGVjdCgpCiAgICAgICAgc2VsZi5hc3NlcnRJc05vbmUod3IoKSwgd3IpCiAgICAgICAgd2l0aCBzZWxmLm9wZW4ob3NfaGVscGVyLlRFU1RGTiwgInJiIikgYXMgZjoKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChmLnJlYWQoKSwgYiJhYmN4eHgiKQoKICAgIGRlZiB0ZXN0X3VuYm91bmRlZF9maWxlKHNlbGYpOgogICAgICAgICMgSXNzdWUgIzExNzQ2MDY6IHJlYWRpbmcgZnJvbSBhbiB1bmJvdW5kZWQgc3RyZWFtIHN1Y2ggYXMgL2Rldi96ZXJvLgogICAgICAgIHplcm8gPSAiL2Rldi96ZXJvIgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyh6ZXJvKToKICAgICAgICAgICAgc2VsZi5za2lwVGVzdCgiezB9IGRvZXMgbm90IGV4aXN0Ii5mb3JtYXQoemVybykpCiAgICAgICAgaWYgc3lzLm1heHNpemUgPiAweDdGRkZGRkZGOgogICAgICAgICAgICBzZWxmLnNraXBUZXN0KCJ0ZXN0IGNhbiBvbmx5IHJ1biBpbiBhIDMyLWJpdCBhZGRyZXNzIHNwYWNlIikKICAgICAgICBpZiBzdXBwb3J0LnJlYWxfbWF4X21lbXVzZSA8IHN1cHBvcnQuXzJHOgogICAgICAgICAgICBzZWxmLnNraXBUZXN0KCJ0ZXN0IHJlcXVpcmVzIGF0IGxlYXN0IDIgR2lCIG9mIG1lbW9yeSIpCiAgICAgICAgd2l0aCBzZWxmLm9wZW4oemVybywgInJiIiwgYnVmZmVyaW5nPTApIGFzIGY6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKE92ZXJmbG93RXJyb3IsIGYucmVhZCkKICB0YW50cy5TRU5ERklMRV9GQUxMQkFDS19SRUFEQlVGRkVSX1NJWkUgPSBjbHMuX19vbGRfYnVmc2l6ZQogICAgICAgIHN1cGVyKCkudGVhckRvd25DbGFzcygpCgogICAgZGVmIG1ha2Vfc29ja2V0KHNlbGYsIGNsZWFudXA9VHJ1ZSk6CiAgICAgICAgc29jayA9IHNvY2tldC5zb2NrZXQoc29ja2V0LkFGX0lORVQsIHNvY2tldC5TT0NLX1NUUkVBTSkKICAgICAgICBzb2NrLnNldGJsb2NraW5nKEZhbHNlKQogICAgICAgIGlmIGNsZWFudXA6CiAgICAgICAgICAgIHNlbGYuYWRkQ2xlYW51cChzb2NrLmNsb3NlKQogICAgICAgIHJldHVybiBzb2NrCgogICAgZGVmIHJlZHVjZV9yZWNlaXZlX2J1ZmZlcl9zaXplKHNlbGYsIHNvY2spOgogICAgICAgICMgUmVkdWNlIHJlY2VpdmUgc29ja2V0IGJ1ZmZlciBzaXplIHRvIHRlc3Qgb24gcmVsYXRpdmUKICAgICAgICAjIHNtYWxsIGRhdGEgc2V0cy4KICAgICAgICBzb2NrLnNldHNvY2tvcHQoc29ja2V0LlNPTF9TT0NLRVQsIHNvY2tldC5TT19SQ1ZCVUYsIHNlbGYuQlVGX1NJWkUpCgogICAgZGVmIHJlZHVjZV9zZW5kX2J1ZmZlcl9zaXplKHNlbGYsIHNvY2ssIHRyYW5zcG9ydD1Ob25lKToKICAgICAgICAjIFJlZHVjZSBzZW5kIHNvY2tldCBidWZmZXIgc2l6ZSB0byB0ZXN0IG9uIHJlbGF0aXZlIHNtYWxsIGRhdGEgc2V0cy4KCiAgICAgICAgIyBPbiBtYWNPUywgU09fU05EQlVGIGlzIHJlc2V0IGJ5IGNvbm5lY3QoKS4gU28gdGhpcyBtZXRob2QKICAgICAgICAjIHNob3VsZCBiZSBjYWxsZWQgYWZ0ZXIgdGhlIHNvY2tldCBpcyBjb25uZWN0ZWQuCiAgICAgICAgc29jay5zZXRzb2Nrb3B0KHNvY2tldC5TT0xfU09DS0VULCBzb2NrZXQuU09fU05EQlVGLCBzZWxmLkJVRl9TSVpFKQoKICAgICAgICBpZiB0cmFuc3BvcnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHRyYW5zcG9ydC5zZXRfd3JpdGVfYnVmZmVyX2xpbWl0cyhoaWdoPXNlbGYuQlVGX1NJWkUpCgogICAgZGVmIHByZXBhcmVfc29ja3NlbmRmaWxlKHNlbGYpOgogICAgICAgIHByb3RvID0gTXlQcm90byhzZWxmLmxvb3ApCiAgICAgICAgcG9ydCA9IHNvY2tldF9oZWxwZXIuZmluZF91bnVzZWRfcG9ydCgpCiAgICAgICAgc3J2X3NvY2sgPSBzZWxmLm1ha2Vfc29ja2V0KGNsZWFudXA9RmFsc2UpCiAgICAgICAgc3J2X3NvY2suYmluZCgoc29ja2V0X2hlbHBlci5IT1NULCBwb3J0KSkKICAgICAgICBzZXJ2ZXIgPSBzZWxmLnJ1bl9sb29wKHNlbGYubG9vcC5jcmVhdGVfc2VydmVyKAogICAgICAgICAgICBsYW1iZGE6IHByb3RvLCBzb2NrPXNydl9zb2NrKSkKICAgICAgICBzZWxmLnJlZHVjZV9yZWNlaXZlX2J1ZmZlcl9zaXplKHNydl9zb2NrKQoKICAgICAgICBzb2NrID0gc2VsZi5tYWtlX3NvY2tldCgpCiAgICAgICAgc2VsZi5ydW5fbG9vcChzZWxmLmxvb3Auc29ja19jb25uZWN0KHNvY2ssICgnMTI3LjAuMC4xJywgcG9ydCkpKQogICAgICAgIHNlbGYucmVkdWNlX3NlbmRfYnVmZmVyX3NpemUoc29jaylleHRbImNzcmZfdG9rZW4iXSA9IGNzcmZfdG9rZW5fbGF6eShyZXF1ZXN0KQogICAgICAgIHJldHVybiBzZWxmLnNhZmVfc3Vic3RpdHV0ZShjb250ZXh0KQojIFRlc3QgdGhlIFVuaWNvZGUgdmVyc2lvbnMgb2Ygbm9ybWFsIGZpbGUgZnVuY3Rpb25zCiMgb3Blbiwgb3Mub3Blbiwgb3Muc3RhdC4gb3MubGlzdGRpciwgb3MucmVuYW1lLCBvcy5yZW1vdmUsIG9zLm1rZGlyLCBvcy5jaGRpciwgb3Mucm1kaXIKaW1wb3J0IG9zCmltcG9ydCBzeXMKaW1wb3J0IHVuaXR0ZXN0CmltcG9ydCB3YXJuaW5ncwpmcm9tIHVuaWNvZGVkYXRhIGltcG9ydCBub3JtYWxpemUKZnJvbSB0ZXN0LnN1cHBvcnQgaW1wb3J0IGlzX2FwcGxlLCBvc19oZWxwZXIKZnJvbSB0ZXN0IGltcG9ydCBzdXBwb3J0CgoKZmlsZW5hbWVzID0gWwogICAgJzFfYWJjJywKICAgICcyX2FzY2lpJywKICAgICczX0dyXHhmY1x4ZGYtR290dCcsCiAgICAnNF9cdTAzOTNcdTAzYjVcdTAzYjlcdTAzYWMtXHUwM2MzXHUwM2IxXHUwM2MyJywKICAgICc1X1x1MDQxN1x1MDQzNFx1MDQ0MFx1MDQzMFx1MDQzMlx1MDQ0MVx1MDQ0Mlx1MDQzMlx1MDQ0M1x1MDQzOVx1MDQ0Mlx1MDQzNScsCiAgICAnNl9cdTMwNmJcdTMwN2RcdTMwOTMnLAogICAgJzdfXHUwNWQ0XHUwNWU5XHUwNWU3XHUwNWU2XHUwNWU1XHUwNWUxJywKICAgICc4X1x1NjZlOFx1NjZlOVx1NjZlYicsCiAgICAnOV9cdTY2ZThcdTA1ZTlcdTMwOTNcdTA0MzRcdTAzOTNceGRmJywKICAgICMgU3BlY2lmaWMgY29kZSBwb2ludHM6IGZuLCBORkMoZm4pIGFuZCBORktDKGZuKSBhbGwgZGlmZmVyZW50CiAgICAnMTBfXHUxZmVlXHUxZmZkJywKICAgIF0KCiMgQXBwbGUgcGxhdGZvcm1zIGRlY29tcG9zZSBVbmljb2RlIG5hbWVzLCB1c2luZyBOb3JtYWwgRm9ybSBELgojIGh0dHA6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL21hYy9saWJyYXJ5L3FhL3FhMjAwMS9xYTExNzMuaHRtbAojICJIb3dldmVyLCBtb3N0IHZvbHVtZSBmb3JtYXRzIGRvIG5vdCBmb2xsb3cgdGhlIGV4YWN0IHNwZWNpZmljYXRpb24gZm9yCiMgdGhlc2Ugbm9ybWFsIGZvcm1zLiAgRm9yIGV4YW1wbGUsIEhGUyBQbHVzIHVzZXMgYSB2YXJpYW50IG9mIE5vcm1hbCBGb3JtIEQKIyBpbiB3aGljaCBVKzIwMDAgdGhyb3VnaCBVKzJGRkYsIFUrRjkwMCB0aHJvdWdoIFUrRkFGRiwgYW5kIFUrMkY4MDAgdGhyb3VnaAojIFUrMkZBRkYgYXJlIG5vdCBkZWNvbXBvc2VkLiIKaWYgbm90IGlzX2FwcGxlOgogICAgZmlsZW5hbWVzLmV4dGVuZChbCiAgICAgICAgIyBTcGVjaWZpYyBjb2RlIHBvaW50czogTkZDKGZuKSwgTkZEKGZuKSwgTkZLQyhmbikgYW5kIE5GS0QoZm4pIGFsbCBkaWZmZXJlbnQKICAgICAgICAnMTFfXHUwMzg1XHUwM2QzXHUwM2Q0JywKICAgICAgICAnMTJfXHUwMGE4XHUwMzAxXHUwM2QyXHUwMzAxXHUwM2QyXHUwMzA4JywgIyA9PSBORkQoJ1x1MDM4NVx1MDNkM1x1MDNkNCcpCiAgICAgICAgJzEzX1x1MDAyMFx1MDMwOFx1MDNpZWxkKG1heF9sZW5ndGg9MjU1KQogICAgICAgICAgICBwYXJlbnQgPSBtb2RlbHMuRm9yZWlnbk9iamVjdCgKICAgICAgICAgICAgICAgIFBhcmVudCwKICAgICAgICAgICAgICAgIG9uX2RlbGV0ZT1tb2RlbHMuU0VUX05VTEwsCiAgICAgICAgICAgICAgICBmcm9tX2ZpZWxkcz0oImEiLCAiYiIsICJkIiksCiAgICAgICAgICAgICAgICB0b19maWVsZHM9KCJhIiwgImIiLCAiZCIpLAogICAgICAgICAgICAgICAgcmVsYXRlZF9uYW1lPSJjaGlsZHJlbiIsCiAgICAgICAgICAgICkKCiAgICAgICAgZmllbGQgPSBDaGlsZC5fbWV0YS5nZXRfZmllbGQoInBhcmVudCIpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgKICAgICAgICAgICAgZmllbGQuY2hlY2soZnJvbV9tb2RlbD1DaGlsZCksCiAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgIEVycm9yKAogICAgICAgICAgICAgICAgICAgICJObyBzdWJzZXQgb2YgdGhlIGZpZWxkcyAnYScsICdiJywgJ2QnIG9uIG1vZGVsICdQYXJlbnQnIGlzICIKICAgICAgICAgICAgICAgICAgICAidW5pcXVlLiIsCiAgICAgICAgICAgICAgICAgICAgaGludD0oCiAgICAgICAgICAgICAgICAgICAgICAgICJNYXJrIGEgc2luZ2xlIGZpZWxkIGFzIHVuaXF1ZT1UcnVlIG9yIGFkZCBhIHNldCBvZiAiCiAgICAgICAgICAgICAgICAgICAgICAgICJmaWVsZHMgdG8gYSB1bmlxdWUgY29uc3RyYWludCAodmlhIHVuaXF1ZV90b2dldGhlciBvciBhICIKICAgICAgICAgICAgICAgICAgICAgICAgIlVuaXF1ZUNvbnN0cmFpbnQgKHdpdGhvdXQgY29uZGl0aW9uKSBpbiB0aGUgbW9kZWwgIgogICAgICAgICAgICAgICAgICAgICAgICAiTWV0YS5jb25zdHJhaW50cykuIgogICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgb2JqPWZpZWxkLAogICAgICAgICAgICAgICAgICAgIGlkPSJmaWVsZHMuRTMxMCIsCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICBdLAogICAgICAgICkKCiAgICBkZWYgdGVzdF9pbnZhbGlkX3RvX2FyZ3VtZW50X3dpdGhfdGhyb3VnaChzZWxmKToKICAgICAgICBjbGFzcyBGb28obW9kZWxzLk1vZGVsKToKICAgICAgICAgICAgcGFzcwoKICAgICAgICBjbGFzcyBCYXIobW9kZWxzLk1vZGVsKToKICAgICAgICAgICAgZm9vcyA9IG1vZGVscy5NYW55VG9NYW55RmllbGQoCiAgICAgICAgICAgICAgICB0bz0iRm8iLAogICAgICAgICAgICAgICAgdGhyb3VnaD0iRm9vQmFyIiwKICAgICAgICAgICAgICAgIHRocm91Z2hfZmllbGRzPSgiYmFyIiwgImZvbyIpLAogICAgICAgICAgICApCgogICAgICAgIGNsYXNzIEZvb0Jhcihtb2RlbHMuTW9kZWwpOgogICAgICAgICAgICBmb28gPSBtb2RlbHMuRm9yZWlnbktleSgiRm9vIiwgb25fZGVsZXRlPW1vZGVscy5DQVNDQURFKQogICAgICAgICAgICBiYXIgPSBtb2RlbHMuRm9yZWlnbktleSgiQmFyIiwgb25fZGVsZXRlPW1vZGVscy5DQVNDQURFKQoKICAgICAgICBmaWVsZCA9IEJhci5fbWV0c2UgYSAyLXR1cGxlIG9mIGNvb3JkaW5hdGVzIGZvciB0aGUgYm94LgogICAgICAgIHJldHVybiAoKC0xMjMuMzAsIC00MS4zMiksICgxNzQuNzgsIDQ4LjQ2KSkKCgpjbGFzcyBUZXN0VzNDR2VvMShUZXN0R2VvUlNTMSk6CiAgICBmZWVkX3R5cGUgPSBmZWVkcy5XM0NHZW9GZWVkCgoKIyBUaGUgZm9sbG93aW5nIGZlZWRzIGFyZSBpbnZhbGlkLCBhbmQgd2lsbCByYWlzZSBleGNlcHRpb25zLgpjbGFzcyBUZXN0VzNDR2VvMihUZXN0R2VvUlNTMik6CiAgICBmZWVkX3R5cGUgPSBmZWVkcy5XM0NHZW9GZWVkCgoKY2xhc3MgVGVzdFczQ0dlbzMoVGVzdEdlb1JTUzEpOgogICAgZmVlZF90eXBlID0gZmVlZHMuVzNDR2VvRmVlZAoKICAgIGRlZiBpdGVtX2dlb21ldHJ5KHNlbGYsIGl0ZW0pOgogICAgICAgIGZyb20gZGphbmdvLmNvbnRyaWIuZ2lzLmdlb3MgaW1wb3J0IFBvbHlnb24KCiAgICAgICAgcmV0dXJuIFBvbHlnb24oKCgwLCAwKSwgKDAsIDEpLCAoMSwgMSksICgxLCAwKSwgKDAsIDApKSkKCgojIFRoZSBmZWVkIGRpY3Rpb25hcnkgdG8gdXNlIGZvciBVUkxzLgpmZWVkX2RpY3QgPSB7CiAgICAicnNzMSI6IFRlc3RHZW9SU1MxLAogICAgInJzczIiOiBUZXN0R2VvUlNTMiwKICAgICJhdG9tMSI6IFRlc3RHZW9BdG9tMSwKICAgICJhdG9tMiI6IFRlc3RHZW9BdG9tMiwKICAgICJ3M2NnZW8xIjogVGVzdFczQ0dlbzEsCiAgICAidzNjZ2VvMiI6IFRlc3RXM0NHZW8yLAogICAgInczY2dlbzMiOiBUZXN0VzNDR2VvMywKfQppbXBvcnQgbG9nZ2luZwppbXBvcnQgc3lzCmZyb20gZnVuY3Rvb2xzIGltcG9ydCB3cmFwcwpmcm9tIGluc3BlY3QgaW1wb3J0IGlzY29yb3V0aW5lZnVuY3Rpb24KCmZyb20gYXNnaXJlZi5zeW5jIGltcG9ydCBzeW5jX3RvX2FzeW5jCgpmcm9tIGRqYW5nby5jb25mIGltcG9ydCBzZXR0aW5ncwpmcm9tIGRqYW5nby5jb3JlIGltcG9ydCBzaWduYWxzCmZyb20gZGphbmdvLmNvcmUuZXhjZXB0aW9ucyBpbXBvcnQgKAogICAgQmFkUmVxdWVzdCwKICAgIFBlcm1pc3Npb25EZW5pZWQsCiAgICBSZXF1ZXN0RGF0YVRvb0JpZywKICAgIFN1c3BpY2lvdXNPcGVyYXRpb24sCiAgICBUb29NYW55RmllbGRzU2VudCwKICAgIFRvb01hbnlGaWxlc1NlbnQsCikKZnJvbSBkamFuZ28uaHR0cCBpbXBvcnQgSHR0cDQwNApmcm9tIGRqYW5nby5odHRwLm11bHRpcGFydHBhcnNlciBpbXBvcnQgTXVsdGlQYXJ0UGFyc2VyRXJyb3IKZnJvbSBkamFuZ28udXJscyBpbXBvcnQgZ2V0X3Jlc29sdmVyLCBnZXRfdXJsY29uZgpmcm9tIGRqYW5nby51dGlscy5sb2cgaW1wb3J0IGxvZ19yZXNwb25zZQpmcm9tIGRqYW5nby52aWV3cyBpbXBvcnQgZGVidWcKCgpkZWYgY29udmVydF9leGNlcHRpb25fdG9fcmVzcG9uc2UoZ2V0X3Jlc3BvbnNlKToKICAgICIiIgogICAgV3JhcCB0aGUgZ2l2ZW4gZ2V0X3Jlc3BvbnNlIGNhbGxhYmxlIGluIGV4Y2VwdGlvbi10by1yZXNwb25zZSBjb252ZXJzaW9uLgoKICAgIEFsbCBleGNlb3J0IGZpbmRfbGlicmFyeQoKCkZPT19DID0gciIiIgojaW5jbHVkZSA8dW5pc3RkLmg+CgovKiBUaGlzIGlzIGEgJ0dOVSBpbmRpcmVjdCBmdW5jdGlvbicgKElGVU5DKSB0aGF0IHdpbGwgYmUgY2FsbGVkIGJ5CiAgIGRsc3ltKCkgdG8gcmVzb2x2ZSB0aGUgc3ltYm9sICJmb28iIHRvIGFuIGFkZHJlc3MuIFR5cGljYWxseSwgc3VjaAogICBhIGZ1bmN0aW9uIHdvdWxkIHJldHVybiB0aGUgYWRkcmVzcyBvZiBhbiBhY3R1YWwgZnVuY3Rpb24sIGJ1dCBpdAogICBjYW4gYWxzbyBqdXN0IHJldHVybiBOVUxMLiAgRm9yIHNvbWUgYmFja2dyb3VuZCBvbiBJRlVOQ3MsIHNlZQogICBodHRwczovL3dpbGxuZXd0b24ubmFtZS91bmNhdGVnb3JpemVkL3VzaW5nLWdudS1pbmRpcmVjdC1mdW5jdGlvbnMuCgogICBBZGFwdGVkIGZyb20gTWljaGFlbCBLZXJyaXNrJ3MgYW5zd2VyOiBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL2EvNTM1OTAwMTQuCiovCgphc20gKCIudHlwZSBmb28gU1RUX0dOVV9JRlVOQyIpOwoKdm9pZCAqZm9vKHZvaWQpCnsKICAgIHdyaXRlKCRERVNDUklQVE9SLCAiT0siLCAyKTsKICAgIHJldHVybiBOVUxMOwp9CiIiIgoKCkB1bml0dGVzdC5za2lwSWYobm90IHN5cy5wbGF0Zm9ybS5zdGFydHN3aXRoKCdsaW51eCcpCiAgICAgICAgICAgICAgICAgb3IgcGxhdGZvcm0ubWFjaGluZSgpLnN0YXJ0c3dpdGgoJ3BhcmlzYycpLAogICAgICAgICAgICAgICAgICd0ZXN0IHJlcXVpcmVzIEdOVSBJRlVOQyBzdXBwb3J0JykKQHVuaXR0ZXN0LnNraXBJZih0ZXN0LnN1cHBvcnQubGlua2VkX3RvX211c2woKSwgIlJlcXVpcmVzIGdsaWJjIikKY2xhc3MgVGVzdE51bGxEbHN5bSh1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICAiIiJHSC0xMjY1NTQ6IEVuc3VyZSB0aGF0IHdlIGNhdGNoIE5VTEwgZGxzeW0gcmV0dXJuIHZhbHVlcwoKICAgIEluIHJhcmUgY2FzZXMsIHN1Y2ggYXMgd2hlbiB1c2luZyBHTlUgSUZVTkNzLCBkbHN5bSgpLAogICAgdGhlIEMgZnVuY3Rpb24gdGhhdCBjdHlwZXMnIENETEwgdXNlcyB0byBnZXQgdGhlIGFkZHJlc3MKICAgIG9mIHN5bWJvbHMsIGNhbiByZXR1cm4gTlVMTC4KCiAgICBUaGUgb2JqZWN0aXZlIHdheSBvZiB0ZWxsaW5nIGlmIGFuIGVycm9yIGR1cmluZyBzeW1ib2wKICAgIGxvb2t1cCBoYXBwZW5lZCBpcyB0byBjYWxsIGdsaWJjJ3MgZGxlcnJvcigpIGFuZCBjaGVjawogICAgZm9yIGEgbm9uLU5VTEwgcmV0dXJuIHZhbHVlLgoKICAgIEhvd2V2ZXIsIHRoZXJlIGNhbiBiZSBjYXNlcyB3aGVyZSBkbHN5bSgpIHJldHVybnMgTlVMTAogICAgYW5kIGRsZXJyb3IoKSBpcyBhbHNvIE5VTEwsIG1lYW5pbmcgdGhhdCBnbGliYyBkaWQgbm90CiAgICBlbmNvdW50ZXIgYW55IGVycm9yLgoKICAgIEluIHRoZSBjYXNlIG9mIGN0eXBlcywgd2Ugc3ViamVjdGl2ZWx5IHRyZWF0IHRoYXQgYXMKICAgIGFuIGVycm9yLCBhbmQgdGhyb3cgYSByZWxldmFudCBleGNlbGYuZ2V0X3Jlc3BvbnNlKHJlcXVlc3QpCgogICAgICAgIHJlc3BvbnNlLl9oYW5kbGVyX2NsYXNzID0gc2VsZi5fX2NsYXNzX18KCiAgICAgICAgc3RhdHVzID0gIiVkICVzIiAlIChyZXNwb25zZS5zdGF0dXNfY29kZSwgcmVzcG9uc2UucmVhc29uX3BocmFzZSkKICAgICAgICByZXNwb25zZV9oZWFkZXJzID0gWwogICAgICAgICAgICAqcmVzcG9uc2UuaXRlbXMoKSwKICAgICAgICAgICAgKigoIlNldC1Db29raWUiLCBjLk91dHB1dFN0cmluZygpKSBmb3IgYyBpbiByZXNwb25zZS5jb29raWVzLnZhbHVlcygpKSwKICAgICAgICBdCiAgICAgICAgc3RhcnRfcmVzcG9uc2Uoc3RhdHVzLCByZXNwb25zZV9oZWFkZXJzKQogICAgICAgIGlmIGdldGF0dHIocmVzcG9uc2UsICJmaWxlX3RvX3N0cmVhbSIsIE5vbmUpIGlzIG5vdCBOb25lIGFuZCBlbnZpcm9uLmdldCgKICAgICAgICAgICAgIndzZ2kuZmlsZV93cmFwcGVyIgogICAgICAgICk6CiAgICAgICAgICAgICMgSWYgYHdzZ2kuZmlsZV93cmFwcGVyYCBpcyB1c2VkIHRoZSBXU0dJIHNlcnZlciBkb2VzIG5vdCBjYWxsCiAgICAgICAgICAgICMgLmNsb3NlIG9uIHRoZSByZXNwb25zZSwgYnV0IG9uIHRoZSBmaWxlIHdyYXBwZXIuIFBhdGNoIGl0IHRvIHVzZQogICAgICAgICAgICAjIHJlc3BvbnNlLmNsb3NlIGluc3RlYWQgd2hpY2ggdGFrZXMgY2FyZSBvZiBjbG9zaW5nIGFsbCBmaWxlcy4KICAgICAgICAgICAgcmVzcG9uc2UuZmlsZV90b19zdHJlYW0uY2xvc2UgPSByZXNwb25zZS5jbG9zZQogICAgICAgICAgICByZXNwb25zZSA9IGVudmlyb25bIndzZ2kuZmlsZV93cmFwcGVyIl0oCiAgICAgICAgICAgICAgICByZXNwb25zZS5maWxlX3RvX3N0cmVhbSwgcmVzcG9uc2UuYmxvY2tfc2l6ZQogICAgICAgICAgICApCiAgICAgICAgcmV0dXJuIHJlc3BvbnNlCgoKZGVmIGdldF9wYXRoX2luZm8oZW52aXJvbik6CiAgICAiIiJSZXR1cm4gdGhlIEhUVFAgcmVxdWVzdCdzIFBBVEhfSU5GTyBhcyBhIHN0cmluZy4iIiIKICAgIHBhdGhfaW5mbyA9IGdldF9ieXRlc19mcm9tX3dzZ2koZW52aXJvbiwgIlBBVEhfSU5GTyIsICIvIikKCiAgICByZXR1cm4gcmVwZXJjZW50X2Jyb2tlbl91bmljb2RlKHBhdGhfaW5mbykuZGVjb2RlKCkKCgpkZWYgZ2V0X3NjcmlwdF9uYW1lKGVudmlyb24pOgogICAgIiIiCiAgICBSZXR1cm4gdGhlIGVxdWl2YWxlbnQgb2YgdGhlIEhUVFAgcmVxdWVzdCdzIFNDUklQVF9OQU1FIGVudmlyb25tZW50CiAgICB2YXJpYWJsZS4gSWYgQXBhY2hlIG1vZF9yZXdyaXRlIGlzIHVzZWQsIHJldHVybiB3aGF0IHdvdWxkIGhhdmUgYmVlbgogICAgdGhlIHNjcmlwdCBuYW1lIHByaW9yIHRvIGFueSByZXdyaXRpbmcgKHNvIGl0J3MgdGhlIHNjcmlwdCBuYW1lIGFzIHNlZW4KICAgIGZyb20gdGhlIGNsaWVudCdzIHBlcnNwZWN0aXZlKSwgdW5sZXNzIHRoZSBGT1JDRV9TQ1JJUFRfTkFNRSBzZXR0aW5nIGlzCiAgICBzZXQgKHRvIGFueXRoaW5nKS4KICBwdHkgc2VxdWVuY2VzLCBldGMuCiMgMTk5OS0wMi0xMCBmbCAgRml4ZWQgcHJvYmxlbSB3aXRoIGVtcHR5IHJlc3BvbnNlcyAoZnJvbSBTa2lwIE1vbnRhbmFybykKIyAxOTk5LTA2LTIwIGZsICBTcGVlZCBpbXByb3ZlbWVudHMsIHBsdWdnYWJsZSBwYXJzZXJzL3RyYW5zcG9ydHMgKDAuOS44KQojIDIwMDAtMTEtMjggZmwgIENoYW5nZWQgYm9vbGVhbiB0byBjaGVjayB0aGUgdHJ1dGggdmFsdWUgb2YgaXRzIGFyZ3VtZW50CiMgMjAwMS0wMi0yNCBmbCAgQWRkZWQgZW5jb2RpbmcvVW5pY29kZS9TYWZlVHJhbnNwb3J0IHBhdGNoZXMKIyAyMDAxLTAyLTI2IGZsICBBZGRlZCBjb21wYXJlIHN1cHBvcnQgdG8gd3JhcHBlcnMgKDAuOS45LzEuMGIxKQojIDIwMDEtMDMtMjggZmwgIE1ha2Ugc3VyZSByZXNwb25zZSB0dXBsZSBpcyBhIHNpbmdsZXRvbgojIDIwMDEtMDMtMjkgZmwgIERvbid0IHJlcXVpcmUgZW1wdHkgcGFyYW1zIGVsZW1lbnQgKGZyb20gTmljaG9sYXMgUmlsZXkpCiMgMjAwMS0wNi0xMCBmbCAgRm9sZGVkIGluIF94bWxycGNsaWIgYWNjZWxlcmF0b3Igc3VwcG9ydCAoMS4wYjIpCiMgMjAwMS0wOC0yMCBmbCAgQmFzZSB4bWxycGNsaWIuRXJyb3Igb24gYnVpbHQtaW4gRXhjZXB0aW9uIChmcm9tIFBhdWwgUHJlc2NvZCkKIyAyMDAxLTA5LTAzIGZsICBBbGxvdyBUcmFuc3BvcnQgc3ViY2xhc3MgdG8gb3ZlcnJpZGUgZ2V0cGFyc2VyCiMgMjAwMS0wOS0xMCBmbCAgTGF6eSBpbXBvcnQgb2YgdXJsbGliLCBjZ2ksIHhtbGxpYiAoMjB4IGltcG9ydCBzcGVlZHVwKQojIDIwMDEtMTAtMDEgZmwgIFJlbW92ZSBjb250YWluZXJzIGZyb20gbWVtbyBjYWNoZSB3aGVuIGRvbmUgd2l0aCB0aGVtCiMgMjAwMS0xMC0wMSBmbCAgVXNlIGZhc3RlciBlc2NhcGUgbWV0aG9kICg4MCUgZHVtcHMgc3BlZWR1cCkKIyAyMDAxLTEwLTAyIGZsICBNb3JlIGR1bXBzIG1pY3JvdHVuaW5nCiMgMjAwMS0xMC0wNCBmbCAgTWFrZSBzdXJlIGltcG9ydCBleHBhdCBnZXRzIGEgcGFyc2VyIChmcm9tIEd1aWRvIHZhbiBSb3NzdW0pCiMgMjAwMS0xMC0xMCBzbSAgQWxsb3cgbG9uZyBpbnRzIHRvIGJlIHBhc3NlZCBhcyBpbnRzIGlmIHRoZXkgZG9uJ3Qgb3ZlcmZsb3cKIyAyMDAxLTEwLTE3IHNtICBUZXN0IGZvciBpbnQgYW5kIGxvbmcgb3ZlcmZsb3cgKGFsbG93cyB1c2Ugb24gNjQtYml0IHN5c3RlbXMpCiMgMjAwMS0xMS0xMiBmbCAgVXNlIHJlcHIoKSB0byBtYXJzaGFsIGRvdWJsZXMgKGZyb20gUGF1bCBGZWxpeCkKIyAyMDAyLTAzLTE3IGZsICBBdm9pZCBidWZmZXJlZCByZWFkIHdoZW4gcG9zc2libGUgKGZyb20gSmFtZXMgUnVja2VyKQojIDIwMDItMDQtMDcgZmwgIEFkZGVkIHB5dGhvbmRvYyBjb21tZW50cwojIDIwMDItMDQtMTYgZmwgIEFkZGVkIF9fc3RyX18gbWV0aG9kcyB0byBkYXRldGltZS9iaW5hcnkgd3JhcHBlcnMKIyAyMDAyLTA1LTE1IGZsICBBZGRlZCBlcnJvciBjb25zdGFudHMgKGZyb20gQW5kcmV3IEt1Y2hsaW5ldCA9IE51bWJlcklucHV0KGF0dHJzPXsibWF4IjogMTIzNDUsICJtaW4iOiAxMjM0LCAic3RlcCI6IDk5OTl9KQoKICAgIEBvdmVycmlkZV9zZXR0aW5ncyhVU0VfVEhPVVNBTkRfU0VQQVJBVE9SPVRydWUpCiAgICBkZWYgdGVzdF9hdHRyc19ub3RfbG9jYWxpemVkKHNlbGYpOgogICAgICAgIHNlbGYuY2hlY2tfaHRtbCgKICAgICAgICAgICAgc2VsZi53aWRnZXQsCiAgICAgICAgICAgICJuYW1lIiwKICAgICAgICAgICAgInZhbHVlIiwKICAgICAgICAgICAgJzxpbnB1dCB0eXBlPSJudW1iZXIiIG5hbWU9Im5hbWUiIHZhbHVlPSJ2YWx1ZSIgbWF4PSIxMjM0NSIgbWluPSIxMjM0IiAnCiAgICAgICAgICAgICdzdGVwPSI5OTk5Ij4nLAogICAgICAgICkKCiAgICBkZWYgdGVzdF9maWVsZHNldChzZWxmKToKICAgICAgICBjbGFzcyBUZXN0Rm9ybShGb3JtKToKICAgICAgICAgICAgdGVtcGxhdGVfbmFtZSA9ICJmb3Jtc190ZXN0cy91c2VfZmllbGRzZXQuaHRtbCIKICAgICAgICAgICAgZmllbGQgPSBDaGFyRmllbGQod2lkZ2V0PXNlbGYud2lkZ2V0KQoKICAgICAgICBmb3JtID0gVGVzdEZvcm0oKQogICAgICAgIHNlbGYuYXNzZXJ0SXMoc2VsZi53aWRnZXQudXNlX2ZpZWxkc2V0LCBGYWxzZSkKICAgICAgICBzZWxmLmFzc2VydEhUTUxFcXVhbCgKICAgICAgICAgICAgJzxkaXY+PGxhYmVsIGZvcj0iaWRfZmllbGQiPkZpZWxkOjwvbGFiZWw+JwogICAgICAgICAgICAnPGlucHV0IGlkPSJpZF9maWVsZCIgbWF4PSIxMjM0NSIgbWluPSIxMjM0IiAnCiAgICAgICAgICAgICduYW1lPSJmaWVsZCIgcmVxdWlyZWQgc3RlcD0iOTk5OSIgdHlwZT0ibnVtYmVyIj48L2Rpdj4nLAogICAgICAgICAgICBmb3JtLnJlbmRlcigpLAogICAgICAgICkKIwojIHRlc3RfbXVsdGlieXRlY29kZWMucHkKIyAgIFVuaXQgdGVzdCBmb3IgbXVsdGlieXRlY29kZWMgaXRzZWxmCiMKCmltcG9ydCBfbXVsdGlieXRlY29kZWMKaW1wb3J0IGNvZGVjcwppbXBvcnQgaW8KaW1wb3J0IHN5cwppbXBvcnQgdGV4dHdyYXAKaW1wb3J0IHVuaXR0ZXN0CmZyb20gdGVzdCBpbXBvcnQgc3VwcG9ydApmcm9tIHRlc3Quc3VwcG9ydCBpbXBvcnQgb3NfaGVscGVyCmZyb20gdGVzdC5zdXBwb3J0Lm9zX2hlbHBlciBpbXBvcnQgVEVTVEZOCmZyb20gdGVzdC5zdXBwb3J0LmltcG9ydF9oZWxwZXIgaW1wb3J0IGltcG9ydF9tb2R1bGUKCkFMTF9DSktFTkNPRElOR1MgPSBbCiMgX2NvZGVjc19jbgogICAgJ2diMjMxMicsICdnYmsnLCAnZ2IxODAzMCcsICdoeicsCiMgX2NvZGVjc19oawogICAgJ2JpZzVoa3NjcycsCiMgX2NvZGVjc19qcAogICAgJ2NwOTMyJywgJ3NoaWZ0X2ppcycsICdldWNfanAnLCAnZXVjX2ppc3gwMjEzJywgJ3NoaWZ0X2ppc3gwMjEzJywKICAgICdldWNfamlzXzIwMDQnLCAnc2hpZnRfamlzXzIwMDQnLAojIF9jb2RlY3Nfa3IKICAgICdjcDk0OScsICdldWNfa3InLCAnam9oYWInLAojIF9jb2RlY3NfdHcKICAgICdiaWc1JywgJ2NwOTUwJyxnbG9uZykKICAgICAgICBAY2FsbGJhY2tfZnVuY1R5cGUKICAgICAgICBkZWYgY2FsbGJhY2soYSwgYik6CiAgICAgICAgICAgIGMgPSBhICsgYgogICAgICAgICAgICBwcmludChmImE9e2F9LCBiPXtifSwgYz17Y30iKQogICAgICAgICAgICByZXR1cm4gYwogICAgICAgIGRsbCA9IGNkbGxbX2N0eXBlc190ZXN0Ll9fZmlsZV9fXQogICAgICAgIHdpdGggc3VwcG9ydC5jYXB0dXJlZF9zdGRvdXQoKSBhcyBvdXQ6CiAgICAgICAgICAgICMgV2l0aCBubyBmaXggZm9yIGkzODc0OCwgdGhlIG5leHQgbGluZSB3aWxsIHJhaXNlIE9TRXJyb3IgYW5kIGNhdXNlIHRoZSB0ZXN0IHRvIGZhaWwuCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGxsLl90ZXN0X2kzODc0OF9ydW5DYWxsYmFjayhjYWxsYmFjaywgNSwgMTApLCAxNSkKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChvdXQuZ2V0dmFsdWUoKSwgImE9NSwgYj0xMCwgYz0xNVxuIikKCmlmIGhhc2F0dHIoY3R5cGVzLCAnV0lORlVOQ1RZUEUnKToKICAgIGNsYXNzIFN0ZGNhbGxDYWxsYmFja3MoQ2FsbGJhY2tzKToKICAgICAgICBmdW5jdHlwZSA9IGN0eXBlcy5XSU5GVU5DVFlQRQoKCmNsYXNzIFNhbXBsZUNhbGxiYWNrc1Rlc3RDYXNlKHVuaXR0ZXN0LlRlc3RDYXNlKToKCiAgICBkZWYgdGVzdF9pbnRlZ3JhdGUoc2VsZik6CiAgICAgICAgIyBEZXJpdmVkIGZyb20gc29tZSB0aGVuIG5vbi13b3JraW5nIGNvZGUsIHBvc3RlZCBieSBEYXZpZCBGb3N0ZXIKICAgICAgICBkbGwgPSBDRExMKF9jdHlwZXNfdGVzdC5fX2ZpbGVfXykKCiAgICAgICAgIyBUaGUgZnVuY3Rpb24gcHJvdG90eXBlIGNhbGxlZCBieSAnaW50ZWdyYXRlJzogZG91YmxlIGZ1bmMoZG91YmxlKTsKICAgICAgICBDQUxMQkFDSyA9IENGVU5DVFlQRShjX2RvdWJsZSwgY19kb3VibGUpCgogICAgICAgICMgVGhlIGludGVncmF0ZSBmdW5jdGlvbiBpdHNlbGYsIGV4cG9zZWQgZnJvbSB0aGUgX2N0eXBlc190ZXN0IGRsbAogICAgICAgIGludGVncmF0ZSA9IGRsbC5pbnRlZ3JhdGUKICAgICAgICBpbnRlZ3JhdGUuYXJndHlwZXMgPSAoY19kb3VibGUsIGNfZG91YmxlLCBDQUxMQkFDSywgY19sb25nKQogICAgICAgIGludGVncmF0ZS5yZXN0eXBlID0gY19kb3VibGUKCiAgICAgICAgZGVmIGZ1bmMoeCk6CiAgICAgICAgICAgIHJldHVybiB4KioyCgogICAgICAgIHJlc3VsdCA9IGludGVncmF0ZSgwLjAsIDEuMCwgQ0FMTEJBQ0soZnVuYyksIDEwKQogICAgICAgIGRpZmYgPSBhYnMocmVzdWx0IC0gMS4vMy4pCgogICAgICAgIHNlbGYuYXNzZXJ0TGVzcyhkaWZmLCAwLjAxLCAiJXMgbm90IGxlc3MgdGhhbiAwLjAxIiAlIGRpZmYpCgogICAgZGVmIHRlc3RfaXNzdWVfODk1OV9hKHNlbGYpOgogICAgICAgIGxpYmNfcGF0aCA9IGZpbmRfbGlicmFyeSgiYyIpCiAgICAgICAgaWYgbm90IGxpYmNfcGF0aDoKICAgICAgICAgICAgc2VsZi5za2lwVGVzdCgnY291bGQgbm90IGZpbmQgbGliYycpCiBkZXgwMihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBGYWlsIHNpbGVudGx5IHdoZW4gdGhlIGFycmF5IGluZGV4IGlzIG91dCBvZiByYW5nZS4KICAgICAgICAiIiIKICAgICAgICBvdXRwdXQgPSBzZWxmLmVuZ2luZS5yZW5kZXJfdG9fc3RyaW5nKAogICAgICAgICAgICAibnVtcHktYXJyYXktaW5kZXgwMiIsCiAgICAgICAgICAgIHsidmFyIjogbnVtcHkuYXJyYXkoWyJmaXJzdCBpdGVtIiwgInNlY29uZCBpdGVtIl0pfSwKICAgICAgICApCiAgICAgICAgaWYgc2VsZi5lbmdpbmUuc3RyaW5nX2lmX2ludmFsaWQ6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwob3V0cHV0LCAiSU5WQUxJRCIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChvdXRwdXQsICIiKQppbXBvcnQgdW5pdHRlc3QKCmltcG9ydCBzeXMsIGlvLCBzdWJwcm9jZXNzCmltcG9ydCBxdW9wcmkKCmZyb20gdGVzdCBpbXBvcnQgc3VwcG9ydAoKCkVOQ1NBTVBMRSA9IGIiIiJcCkhlcmUncyBhIGJ1bmNoIG9mIHNwZWNpYWw9MjAKCj1BMT1BMj1BMz1BND1BNT1BNj1BNz1BOD1BOQo9QUE9QUI9QUM9QUQ9QUU9QUY9QjA9QjE9QjI9QjMKPUI0PUI1PUI2PUI3PUI4PUI5PUJBPUJCPUJDPUJEPUJFCj1CRj1DMD1DMT1DMj1DMz1DND1DNT1DNgo9Qzc9Qzg9Qzk9Q0E9Q0I9Q0M9Q0Q9Q0U9Q0YKPUQwPUQxPUQyPUQzPUQ0PUQ1PUQ2PUQ3Cj1EOD1EOT1EQT1EQj1EQz1ERD1ERT1ERgo9RTA9RTE9RTI9RTM9RTQ9RTU9RTY9RTcKPUU4PUU5PUVBPUVCPUVDPUVEPUVFPUVGCj1GMD1GMT1GMj1GMz1GND1GNT1GNj1GNwo9Rjg9Rjk9RkE9RkI9RkM9RkQ9RkU9RkYKCmNoYXJhY3RlcnMuLi4gaGF2ZSBmdW4hCiIiIgoKIyBGaXJzdCBsaW5lIGVuZHMgd2l0aCBhIHNwYWNlCkRFQ1NBTVBMRSA9IGIiSGVyZSdzIGEgYnVuY2ggb2Ygc3BlY2lhbCBcbiIgKyBcCmIiIiJcCgpceGExXHhhMlx4YTNceGE0XHhhNVx4YTZceGE3XHhhOFx4YTkKXHhhYVx4YWJceGFjXHhhZFx4YWVceGFmXHhiMFx4YjFceGIyXHhiMwpceGI0XHhiNVx4YjZceGI3XHhiOFx4YjlceGJhXHhiYlx4YmNceGJkXHhiZQpceGJmXHhjMFx4YzFceGMyXHhjM1x4YzRceGM1XHhjNgpceGM3XHhjOFx4YzlceGNhXHhjYlx4Y2NceGNkXHhjZVx4Y2YKXHhkMFx4ZDFceGQyXHhkM1x4ZDRceGQ1XHhkNlx4ZDcKXHhkOFx4ZDlceGRhXHhkYlx4ZGNceGRkXHhkZVx4ZGYKXHhlMFx4ZTFceGUyXHhlM1x4ZTRceGU1XHhlNlx4ZTcKXHhlOFx4ZTlceGVhXHhlYlx4ZWNceGVkXHhlZVx4ZWYKXHhmMFx4ZjFceGYyXHhmM1x4ZjRceGY1XHhmNlx4ZjcKXHhmOFx4ZjlceGZhXHhmYlx4ZmNceGZkXHhmZVx4ZmYKCmNoYXJhY3RlcnMuLi4gaGF2ZSBmdW4hCiIiIgoKCmRlZiB3aXRocHl0aG9uaW1wbGVtZW50YXRpb24odGVzdGZ1bmMpOgogICAgZGVmIG5ld3Rlc3Qoc2VsZik6CiAgICAgICAgIyBUZXN0IGRlZmF1bHQgaW1wbGVtZW50YXRpb24KICAgICAgICB0ZXN0ZnVuYyhzZWxmKQogICBzLiAoU2VlIGV4YW1wbGUgd2lraXBlZGlhMSBmb3IgVVJMcykKCkZpcnN0IHdlIGNyZWF0ZSAobmUtMSkgKGkuZS4gMzUgaW4gdGhpcwpleGFtcGxlKSBjb3BpZXMgb2Ygb3VyIGZpcnN0IHR1cnRsZSBwLgpUaGVuIHdlIGxldCB0aGVtIHBlcmZvcm0gdGhlaXIgc3RlcHMgaW4KcGFyYWxsZWwuCgpGb2xsb3dlZCBieSBhIGNvbXBsZXRlIHVuZG8oKS4KIiIiCmZyb20gdHVydGxlIGltcG9ydCBTY3JlZW4sIFR1cnRsZSwgbWFpbmxvb3AKZnJvbSB0aW1lIGltcG9ydCBwZXJmX2NvdW50ZXIgYXMgY2xvY2ssIHNsZWVwCgpkZWYgbW5fZWNrKHAsIG5lLHN6KToKICAgIHR1cnRsZWxpc3QgPSBbcF0KICAgICNjcmVhdGUgbmUtMSBhZGRpdGlvbmFsIHR1cnRsZXMKICAgIGZvciBpIGluIHJhbmdlKDEsbmUpOgogICAgICAgIHEgPSBwLmNsb25lKCkKICAgICAgICBxLnJ0KDM2MC4wL25lKQogICAgICAgIHR1cnRsZWxpc3QuYXBwZW5kKHEpCiAgICAgICAgcCA9IHEKICAgIGZvciBpIGluIHJhbmdlKG5lKToKICAgICAgICBjID0gYWJzKG5lLzIuMC1pKS8obmUqLjcpCiAgICAgICAgIyBsZXQgdGhvc2UgbmUgdHVydGxlcyBtYWtlIGEgc3RlcAogICAgICAgICMgaW4gcGFyYWxsZWw6CiAgICAgICAgZm9yIHQgaW4gdHVydGxlbGlzdDoKICAgICAgICAgICAgdC5ydCgzNjAuL25lKQogICAgICAgICAgICB0LnBlbmNvbG9yKDEtYywwLGMpCiAgICAgICAgICAgIHQuZmQoc3opCgpkZWYgbWFpbigpOgogICAgcyA9IFNjcmVlbigpCiAgICBzLmJnY29sb3IoImJsYWNrIikKICAgIHA9VHVydGxlKCkKICAgIHAuc3BlZWQoMCkKICAgIHAuaGlkZXR1cnRsZSgpCiAgICBwLnBlbmNvbG9yKCJyZWQiKQogICAgcC5wZW5zaXplKDMpCgogICAgcy50cmFjZXIoMzYsMCkKCiAgICBhdCA9IGNsb2NrKCkKICAgIG1uX2VjayhwLCAzNiwgMTkpCiAgICBldCA9IGNsb2NrKCkKICAgIHoxID0gZXQtYXQKCiAgICBzbGVlcCgxKQoKICAgIGF0ID0gY2xvY2soKQogICAgd2hpbGUgYW55KHQudW5kb2J1ZmZlcmVudHJpZXMoKSBmb3IgdCBpbiBzLnR1cnRsZXMoKSk6CiAgICAgICAgZm9yIHQgaW4gcy50dXJ0bGVzKCk6CiAgICAgICAgICAgIHQudW5kbygpCiAgICBldCA9IGNsb2NrKCkKICAgIHJldHVybiAicnVudGltZTogJS4zZiBzZWMiICUgKHoxK2V0LWF0KQoKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICBtc2cgPSBtYWluKCkKICAgIHByaW50KG1zZykKICAgIG1haW5sb29wKCkKZnJvbSBkamFuZ28uZGIgaW1wb3J0IHRyYW5zYWN0aW9uCmZyb20gZGphbmdvLnRlc3QgaW1wb3J0IFRlc3RDYXNlCgpmcm9tIC5tb2RlbHMgaW1wb3J0IEZsb2F0TW9kZWwKCgpjbGFzcyBUZXN0RmxvYXRGaWVsZChUZXN0Q2FzZSk6CiAgICBkZWYgdGVzdF9mbG9hdF92YWxpZGF0ZXNfb2JqZWN0KHNlbGYpOgogICAgICAgIGluc3RhbmNlID0gRmxvYXRNb2RlbChzaXplPTIuNSkKICAgICAgICAjIFRyeSBzZXR0aW5nIGZsb2F0IGZpZWxkIHRvIHVuc2F2ZWQgb2IgICAgIkhUVFBFeGNlcHRpb24iLCAiTm90Q29ubmVjdGVkIiwgIlVua25vd25Qcm90b2NvbCIsCiAgICAgICAgICAgIlVua25vd25UcmFuc2ZlckVuY29kaW5nIiwgIlVuaW1wbGVtZW50ZWRGaWxlTW9kZSIsCiAgICAgICAgICAgIkluY29tcGxldGVSZWFkIiwgIkludmFsaWRVUkwiLCAiSW1wcm9wZXJDb25uZWN0aW9uU3RhdGUiLAogICAgICAgICAgICJDYW5ub3RTZW5kUmVxdWVzdCIsICJDYW5ub3RTZW5kSGVhZGVyIiwgIlJlc3BvbnNlTm90UmVhZHkiLAogICAgICAgICAgICJCYWRTdGF0dXNMaW5lIiwgIkxpbmVUb29Mb25nIiwgIlJlbW90ZURpc2Nvbm5lY3RlZCIsICJlcnJvciIsCiAgICAgICAgICAgInJlc3BvbnNlcyJdCgpIVFRQX1BPUlQgPSA4MApIVFRQU19QT1JUID0gNDQzCgpfVU5LTk9XTiA9ICdVTktOT1dOJwoKIyBjb25uZWN0aW9uIHN0YXRlcwpfQ1NfSURMRSA9ICdJZGxlJwpfQ1NfUkVRX1NUQVJURUQgPSAnUmVxdWVzdC1zdGFydGVkJwpfQ1NfUkVRX1NFTlQgPSAnUmVxdWVzdC1zZW50JwoKCiMgaGFjayB0byBtYWludGFpbiBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQpnbG9iYWxzKCkudXBkYXRlKGh0dHAuSFRUUFN0YXR1cy5fX21lbWJlcnNfXykKCiMgYW5vdGhlciBoYWNrIHRvIG1haW50YWluIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CiMgTWFwcGluZyBzdGF0dXMgY29kZXMgdG8gb2ZmaWNpYWwgVzNDIG5hbWVzCnJlc3BvbnNlcyA9IHt2OiB2LnBocmFzZSBmb3IgdiBpbiBodHRwLkhUVFBTdGF0dXMuX19tZW1iZXJzX18udmFsdWVzKCl9CgojIG1heGltYWwgbGluZSBsZW5ndGggd2hlbiBjYWxsaW5nIHJlYWRsaW5lKCkuCl9NQVhMSU5FID0gNjU1MzYKX01BWEhFQURFUlMgPSAxMDAKCiMgRGF0YSBsYXJnZXIgdGhhbiB0aGlzIHdpbGwgYmUgcmVhZCBpbiBjaHVua3MsIHRvIHByZXZlbnQgZXh0cmVtZQojIG92ZXJhbGxvY2F0aW9uLgpfTUlOX1JFQURfQlVGX1NJWkUgPSAxIDw8IDIwCgoKIyBIZWFkZXIgbmFtZS92YWx1ZSBBQk5GIChodHRwOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmM3MjMwI3NlY3Rpb24tMy4yKQojCiMgVkNIQVIgICAgICAgICAgPSAleDIxLTdFCiMgb2JzLXRleHQgICAgICAgPSAleDgwLUZGCiMgaGVhZGVyLWZpZWxkICAgPSBmaWVsZC1uYW1lICI6IiBPV1MgZmllbGQtdmFsdWUgT1dTCiMgZmllbGQtbmFtZSAgICAgPSB0b2tlbgojIGZpZWxkLXZhbHVlICAgID0gKiggZmllbGQtY29udGVudCAvIG9icy1mb2xkICkKIyBmaWVsZC1jb250ZW50ICA9IGZpZWxkLXZjaGFyIFsgMSooIFNQIC8gSFRBQiApIGZpZWxkLXZjaGFyIF0KIyBmaWVsZC12Y2hhciAgICA9IFZDSEFSIC8gb2JzLXRleHQKIwojIG9icy1mb2xkICAgICAgID0gQ1JMRiAxKiggU1AgLyBIVEFCICkKIyAgICAgICAgICAgICAgICA7IG9ic29sZXRlIGxpbmUgZm9sZGluZwojICAgICAgICAgICAgICAgIDsgc2VlIFNlY3Rpb24gMy4yLjQKCiMgdG9rZW4gICAgICAgICAgPSAxKnRjaGFyCiMKIyB0Y2hhciBnZXRfb2JqZWN0KHF1ZXJ5c2V0PXFzKQoKCmNsYXNzIERhdGVEZXRhaWxWaWV3KFNpbmdsZU9iamVjdFRlbXBsYXRlUmVzcG9uc2VNaXhpbiwgQmFzZURhdGVEZXRhaWxWaWV3KToKICAgICIiIgogICAgRGV0YWlsIHZpZXcgb2YgYSBzaW5nbGUgb2JqZWN0IG9uIGEgc2luZ2xlIGRhdGU7IHRoaXMgZGlmZmVycyBmcm9tIHRoZQogICAgc3RhbmRhcmQgRGV0YWlsVmlldyBieSBhY2NlcHRpbmcgYSB5ZWFyL21vbnRoL2RheSBpbiB0aGUgVVJMLgogICAgIiIiCgogICAgdGVtcGxhdGVfbmFtZV9zdWZmaXggPSAiX2RldGFpbCIKCgpkZWYgX2RhdGVfZnJvbV9zdHJpbmcoCiAgICB5ZWFyLCB5ZWFyX2Zvcm1hdCwgbW9udGg9IiIsIG1vbnRoX2Zvcm1hdD0iIiwgZGF5PSIiLCBkYXlfZm9ybWF0PSIiLCBkZWxpbT0iX18iCik6CiAgICAiIiIKICAgIEdldCBhIGRhdGV0aW1lLmRhdGUgb2JqZWN0IGdpdmVuIGEgZm9ybWF0IHN0cmluZyBhbmQgYSB5ZWFyLCBtb250aCwgYW5kIGRheQogICAgKG9ubHkgeWVhciBpcyBtYW5kYXRvcnkpLiBSYWlzZSBhIDQwNCBmb3IgYW4gaW52YWxpZCBkYXRlLgogICAgIiIiCiAgICBmb3JtYXQgPSB5ZWFyX2Zvcm1hdCArIGRlbGltICsgbW9udGhfZm9ybWF0ICsgZGVsaW0gKyBkYXlfZm9ybWF0CiAgICBkYXRlc3RyID0gc3RyKHllYXIpICsgZGVsaW0gKyBzdHIobW9udGgpICsgZGVsaW0gKyBzdHIoZGF5KQogICAgdHJ5OgogICAgICAgIHJldHVybiBkYXRldGltZS5kYXRldGltZS5zdHJwdGltZShkYXRlc3RyLCBmb3JtYXQpLmRhdGUoKQogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgcmFpc2UgSHR0cDQwNCgKICAgICAgICAgICAgXygiSW52YWxpZCBkYXRlIHN0cmluZyDigJwlKGRhdGVzdHIpc+KAnSBnaXZlbiBmb3JtYXQg4oCcJShmb3JtYXQpc+KAnSIpCiAgICAgICAgICAgICUgewogICAgICAgICAgICAgICAgImRhdGVzdHIiOiBkYXRlc3RyLAogICAgICAgICAgICAgICAgImZvcm1hdCI6IGZvcm1hdCwKICAgICAgICAgICAgfQogICAgICAgICkKCgpkZWYgX2dldF9uZXh0X3ByZXYoZ2VuZXJpY192aWV3LCBkYXRlLCBpc19wcmV2aW91cywgcGVyaW9kKToKICAgICIiIgogICAgR2V0IHRoZSBuZXh0IG9yIHRoZSBwcmV2aW91cyB2YWxpZCBkYXRlLiBUaGUgaWRlYSBpcyB0byBhbGxvdyBsaW5rcyBvbgogICAgbW9udGgvZGF5IHZpZXdzIHRvIG5ldmVyIGJlIDQwNHMgYnkgbmV2ZXIgcHJvdmlkaW5nIGEgZGF0ZSB0aGF0J2xsIGJlCiAgICBpbnZhbGlkIGZvciB0aGUgZ2l2ZW4gdmlldy4KCiAgICBUaGlzIGlzIGEgYml0IGNvbXBsaWNhdGVkIHNpbmNlIGl0IGhhbmRsZXMgZGlmZmVyZW50IGludGVydmFscyBvZiB0aW1lLAogICAgaGVuY2UgdGhlIGNvdXBsaW5nIHRvIGdlbmVyaWNfdmlldy4KCiAgICBIb3dldmVyIGluIGVzc2VuY2UgdGhlIGxvZ2ljIGNvbWVzIGRvd24gdG86CgogICAgICAgICogSWYgYWxsb3dfZW1wdHkgYW5kIGFsbG93X2Z1dHVyZSBhcmUgYm90aCB0cnVlYWJsZWQsICI8W0NEQVRBWyIgc3RhcnRzIGEgYm9ndXMgY29tbWVudHMgd2hpY2ggZW5kcyB3aXRoICI+Ii4KCiAgICAgICAgVGhpcyBtZXRob2QgaXMgbm90IGNhbGxlZCBieSBkZWZhdWx0LiBJdHMgcHVycG9zZSBpcyB0byBiZSBjYWxsZWQKICAgICAgICBpbiBjdXN0b20gaGFuZGxlX3N0YXJ0dGFnKCkgYW5kIGhhbmRsZV9lbmR0YWcoKSBtZXRob2RzLCB3aXRoCiAgICAgICAgdmFsdWUgdGhhdCBkZXBlbmRzIG9uIHRoZSBhZGp1c3RlZCBjdXJyZW50IG5vZGUuCiAgICAgICAgU2VlIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3BhcnNpbmcuaHRtbCNtYXJrdXAtZGVjbGFyYXRpb24tb3Blbi1zdGF0ZQogICAgICAgIGZvciBkZXRhaWxzLgogICAgICAgICIiIgogICAgICAgIHNlbGYuX3N1cHBvcnRfY2RhdGEgPSBmbGFnCgogICAgIyBJbnRlcm5hbCAtLSBoYW5kbGUgZGF0YSBhcyBmYXIgYXMgcmVhc29uYWJsZS4gIE1heSBsZWF2ZSBzdGF0ZQogICAgIyBhbmQgZGF0YSB0byBiZSBwcm9jZXNzZWQgYnkgYSBzdWJzZXF1ZW50IGNhbGwuICBJZiAnZW5kJyBpcwogICAgIyB0cnVlLCBmb3JjZSBoYW5kbGluZyBhbGwgZGF0YSBhcyBpZiBmb2xsb3dlZCBieSBFT0YgbWFya2VyLgogICAgZGVmIGdvYWhlYWQoc2VsZiwgZW5kKToKICAgICAgICByYXdkYXRhID0gc2VsZi5yYXdkYXRhCiAgICAgICAgaSA9IDAKICAgICAgICBuID0gbGVuKHJhd2RhdGEpCiAgICAgICAgd2hpbGUgaSA8IG46CiAgICAgICAgICAgIGlmIHNlbGYuY29udmVydF9jaGFycmVmcyBhbmQgbm90IHNlbGYuY2RhdGFfZWxlbToKICAgICAgICAgICAgICAgIGogPSByYXdkYXRhLmZpbmQoJzwnLCBpKQogICAgICAgICAgICAgICAgaWYgaiA8IDA6CiAgICAgICAgICAgICAgICAgICAgIyBpZiB3ZSBjYW4ndCBmaW5kIHRoZSBuZXh0IDwsIGVpdGhlciB3ZSBhcmUgYXQgdGhlIGVuZAogICAgICAgICAgICAgICAgICAgICMgb3IgdGhlcmUncyBtb3JlIHRleHQgaW5jb21pbmcuICBJZiB0aGUgbGF0dGVyIGlzIFRydWUsCiAgICAgICAgICAgICAgICAgICAgIyB3ZSBjYW4ndCBwYXNzIHRoZSB0ZXh0IHRvIGhhbmRsZV9kYXRhIGluIGNhc2Ugd2UgaGF2ZQogICAgICAgICAgICAgICAgICAgICMgYSBjaGFycmVmIGN1dCBpbiBoYWxmIGF0IGVuZC4gIFRyeSB0byBkZXRlcm1pbmUgaWYKICAgICAgICAgICAgICAgICAgICAjIHRoaXMgaXMgdGhlIGNhc2UgYmVmb3JlIHByb2NlZWRpbmcgYnkgbG9va2luZyBmb3IgYW4KICAgICAgICAgICAgICAgICAgICAjICYgbmVhciB0aGUgZW5kIGFuZCBzZWUgaWYgaXQncyBmb2xsb3dlZCBieSBhIHNwYWNlIG9yIDsuCiAgICAgICAgICAgICAgICAgICAgYW1wcG9zID0gcmF3ZGF0YS5yZmluZCgnJicsIG1heChpLCBuLTM0KSkKICAgICAgICAgICAgICAgICAgICBpZiAoYW1wcG9zID49IDAgYW5kCiAgICAgICAgICAgICAgICAgICAgICAgIG5vdCByZS5jb21waWxlKHInW1x0XG5cclxmIDtdJykuc2VhICBvcy53cml0ZSh7OmR9LCBiIlRoZSB0ZXN0IGhhcyBwYXNzZWQhIikKICAgICAgICAgICAgYXRleGl0LnJlZ2lzdGVyKGNhbGxiYWNrKQogICAgICAgICIiIi5mb3JtYXQodykpCiAgICAgICAgcmV0ID0gc3VwcG9ydC5ydW5faW5fc3ViaW50ZXJwKGNvZGUpCiAgICAgICAgb3MuY2xvc2UodykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKG9zLnJlYWQociwgbGVuKGV4cGVjdGVkKSksIGV4cGVjdGVkKQogICAgICAgIG9zLmNsb3NlKHIpCgogICAgIyBQeXRob24gYnVpbHQgd2l0aCBQeV9UUkFDRV9SRUZTIGZhaWwgd2l0aCBhIGZhdGFsIGVycm9yIGluCiAgICAjIF9QeVJlZmNoYWluX1RyYWNlKCkgb24gbWVtb3J5IGFsbG9jYXRpb24gZXJyb3IuCiAgICBAdW5pdHRlc3Quc2tpcElmKHN1cHBvcnQuUHlfVFJBQ0VfUkVGUywgJ2Nhbm5vdCB0ZXN0IFB5X1RSQUNFX1JFRlMgYnVpbGQnKQogICAgZGVmIHRlc3RfYXRleGl0X3dpdGhfbG93X21lbW9yeShzZWxmKToKICAgICAgICAjIGdoLTE0MDA4MDogVGVzdCB0aGF0IHNldHRpbmcgbG93IG1lbW9yeSBhZnRlciByZWdpc3RlcmluZyBhbiBhdGV4aXQKICAgICAgICAjIGNhbGxiYWNrIGRvZXNuJ3QgY2F1c2UgYW4gaW5maW5pdGUgbG9vcCBkdXJpbmcgZmluYWxpemF0aW9uLgogICAgICAgIGNvZGUgPSB0ZXh0d3JhcC5kZWRlbnQoIiIiCiAgICAgICAgICAgIGltcG9ydCBhdGV4aXQKICAgICAgICAgICAgaW1wb3J0IF90ZXN0Y2FwaQoKICAgICAgICAgICAgZGVmIGNhbGxiYWNrKCk6CiAgICAgICAgICAgICAgICBwcmludCgiaGVsbG8iKQoKICAgICAgICAgICAgYXRleGl0LnJlZ2lzdGVyKGNhbGxiYWNrKQogICAgICAgICAgICAjIFNpbXVsYXRlIGxvdyBtZW1vcnkgY29uZGl0aW9uCiAgICAgICAgICAgIF90ZXN0Y2FwaS5zZXRfbm9tZW1vcnkoMCkKICAgICAgICAiIiIpCgogICAgICAgIHdpdGggb3NfaGVscGVyLnRlbXBfZGlyKCkgYXMgdGVtcF9kaXI6CiAgICAgICAgICAgIHNjcmlwdCA9IHNjcmlwdF9oZWxwZXIubWFrZV9zY3JpcHQodGVtcF9kaXIsICd0ZXN0X2F0ZXhpdF9zY3JpcHQnLCBjb2RlKQogICAgICAgICAgICB3aXRoIFN1cHByZXNzQ3Jhc2hSZXBvcnQoKToKICAgICAgICAgICAgICAgIHdpdGggc2NyaXB0X2hlbHBlci5zcGF3bl9weXRob24oc2NyaXB0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRlcnI9c3VicHJvY2Vzcy5QSVBFKSBhcyBwcm9jOgogICAgICAgICAgICAgICAgICAgIHByb2Mud2FpdCgpCiAgICAgICAgICAgICAgICAgICAgc3Rkb3V0ID0gcHJvYy5zdGRvdXQucmVhZCgpCiAgICAgICAgICAgICAgICAgICAgc3RkZXJyID0gcHJvYy5zdGRlcnIucmVhZCgpCgogICAgICAgIHNlbGYuYXNzZXJ0SW4ocHJvYy5yZXR1cm5jb2RlLCAoMCwgMSkpCiAgICAgICAgc2VsZi5hc3NlcnROb3RJbihiImhlbGxvIiwgc3Rkb3V0KQogICAgICAgIHNlbGYuYXNzZXJ0SW4oYiJNZW1vcnlFcnJvciIsIHN0bGYuY3UubGFzdHJvd2lkKSkKICAgICAgICBleHBlY3RlZCA9IFsKICAgICAgICAgICAgKCdGQUlMJywgMiksICgnRkFJTCcsIDIpLAogICAgICAgICAgICAoJ0FCT1JUJywgMyksICgnQUJPUlQnLCAzKSwKICAgICAgICAgICAgKCdST0xMQkFDSycsIDQpLCAoJ1JPTExCQUNLJywgNCksCiAgICAgICAgXQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzdWx0cywgZXhwZWN0ZWQpCgogICAgZGVmIHRlc3RfY29sdW1uX2NvdW50KHNlbGYpOgogICAgICAgICMgQ2hlY2sgdGhhdCBjb2x1bW4gY291bnQgaXMgdXBkYXRlZCBjb3JyZWN0bHkgZm9yIGNhY2hlZCBzdGF0ZW1lbnRzCiAgICAgICAgc2VsZWN0ID0gInNlbGVjdCAqIGZyb20gdGVzdCIKICAgICAgICByZXMgPSBzZWxmLmN1LmV4ZWN1dGUoc2VsZWN0KQogICAgICAgIG9sZF9jb3VudCA9IGxlbihyZXMuZGVzY3JpcHRpb24pCiAgICAgICAgIyBBZGQgYSBuZXcgY29sdW1uIGFuZCBleGVjdXRlIHRoZSBjYWNoZWQgc2VsZWN0IHF1ZXJ5IGFnYWluCiAgICAgICAgc2VsZi5jdS5leGVjdXRlKCJhbHRlciB0YWJsZSB0ZXN0IGFkZCBuZXdjb2wiKQogICAgICAgIHJlcyA9IHNlbGYuY3UuZXhlY3V0ZShzZWxlY3QpCiAgICAgICAgbmV3X2NvdW50ID0gbGVuKHJlcy5kZXNjcmlwdGlvbikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKG5ld19jb3VudCAtIG9sZF9jb3VudCwgMSkKCiAgICBkZWYgdGVzdF9zYW1lX3F1ZXJ5X2luX211bHRpcGxlX2N1cnNvcnMoc2VsZik6CiAgICAgICAgY3Vyc29ycyA9IFtzZWxmLmN4LmV4ZWN1dGUoInNlbGVjdCAxIikgZm9yIF8gaW4gcmFuZ2UoMyldCiAgICAgICAgZm9yIGN1IGluIGN1cnNvcnM6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoY3UuZmV0Y2hhbGwoKSwgWygxLCldKQoKCmNsYXNzIEJsb2JUZXN0cyh1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgc2VsZi5jeCA9IHNxbGl0ZS5jb25uZWN0KCI6bWVtb3J5OiIpCiAgICAgICAgc2VsZi5jeC5leGVjdXRlKCJjcmVhdGUgdGFibGUgdGVzdChiIGJsb2IpIikKICAgICAgICBzZWxmLmRhdGEgPSBiInRoaXMgYmxvYiBkYXRhIHN0cmluZyBpcyBleGFjdGx5IGZpZnR5IGJ5dGVzIGxvbmchIgogICAgICAgIHNlbGYuY3guZXhlY3V0ZSgiaW5zZXJ0IGludG8gdGVzdChiKSB2YWx1ZXMgKD8pIiwgKHNlbGYuZGF0YSwpKQogICAgICAgIHNlbGYuYmxvYiA9IHNlbGYuY3guYmxvYm9wZW4oInRlc3QiLCAiYiIsIDEpCgogICAgZGVmIHRlYXJEb3duKHNlbGYpOgogICAgICAgIHNlbGYuYmxvYi5jbG9zZSgpCiAgICAgICAgc2VsZi5jeC5jbG9zZSgpCgogICAgZGVmIHRlc3RfYmxvYl9pc19hX2Jsb2Ioc2VsZik6CiAgICAgICAgc2VsZi5hc3NlcnRJc0luc3RhbmNlKHNlbGYuYmxvYiwgc3FsaXRlLkJsb2IpCgogICAgZGVmIHRlc3RfYmxvYl9zZWVrX2FuZF90ZWxsKHNlbGYpOgogICAgICAgIHNlbGYuYmxvYi5zZWVrKDEwKQogICAgICAuLi4KCiAgICAgICAgVGhlICJmcmVlemVfc3VwcG9ydCgpIiBsaW5lIGNhbiBiZSBvbWl0dGVkIGlmIHRoZSBwcm9ncmFtCiAgICAgICAgaXMgbm90IGdvaW5nIHRvIGJlIGZyb3plbiB0byBwcm9kdWNlIGFuIGV4ZWN1dGFibGUuCgogICAgICAgIFRvIGZpeCB0aGlzIGlzc3VlLCByZWZlciB0byB0aGUgIlNhZmUgaW1wb3J0aW5nIG9mIG1haW4gbW9kdWxlIgogICAgICAgIHNlY3Rpb24gaW4gaHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMy9saWJyYXJ5L211bHRpcHJvY2Vzc2luZy5odG1sCiAgICAgICAgJycnKQoKCmRlZiBnZXRfcHJlcGFyYXRpb25fZGF0YShuYW1lKToKICAgICcnJwogICAgUmV0dXJuIGluZm8gYWJvdXQgcGFyZW50IG5lZWRlZCBieSBjaGlsZCB0byB1bnBpY2tsZSBwcm9jZXNzIG9iamVjdAogICAgJycnCiAgICBfY2hlY2tfbm90X2ltcG9ydGluZ19tYWluKCkKICAgIGQgPSBkaWN0KAogICAgICAgIGxvZ190b19zdGRlcnI9dXRpbC5fbG9nX3RvX3N0ZGVyciwKICAgICAgICBhdXRoa2V5PXByb2Nlc3MuY3VycmVudF9wcm9jZXNzKCkuYXV0aGtleSwKICAgICAgICApCgogICAgaWYgdXRpbC5fbG9nZ2VyIGlzIG5vdCBOb25lOgogICAgICAgIGRbJ2xvZ19sZXZlbCddID0gdXRpbC5fbG9nZ2VyLmdldEVmZmVjdGl2ZUxldmVsKCkKCiAgICBzeXNfcGF0aD1zeXMucGF0aC5jb3B5KCkKICAgIHRyeToKICAgICAgICBpID0gc3lzX3BhdGguaW5kZXgoJycpCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBwYXNzCiAgICBlbHNlOgogICAgICAgIHN5c19wYXRoW2ldID0gcHJvY2Vzcy5PUklHSU5BTF9ESVIKCiAgICBkLnVwZGF0ZSgKICAgICAgICBuYW1lPW5hbWUsCiAgICAgICAgc3lzX3BhdGg9c3lzX3BhdGgsCiAgICAgICAgc3lzX2FyZ3Y9c3lzLmFyZ3YsCiAgICAgICAgb3JpZ19kaXI9cHJvY2Vzcy5PUklHSU5BTF9ESVIsCiAgICAgICAgZGlyPW9zLmdldGN3ZCgpLAogICAgICAgIHN0YXJ0X21ldGhvZD1nZXRfc3RhcnRfbWV0aG9kKGFsbG93X25vbmU9VHJ1ZSksCiAgICAgICAgKQoKICAgICMgRmlndXJlIG91dCB3aGV0aGVyIHRvIGluaXRpYWxpc2UgbWFpbiBpbiB0aGUgc3VicHJvY2VzcyBhcyBhIG1vZHVsZQogICAgIyBvciB0aHJvdWdoIGRpcmVjdCBleGVjdXRpb24gKG9yIHRvIGxlYXZlIGl0IGFsb25lIGVudGlyZWx5KQogICAgbWFpbl9tb2R1bGUgPSBzeXMubW9kdWxlc1snX19tYWluX18nXQogICAgbWFpbl9tb2RfbmFtZSA9IGdldGF0dHIobWFpbl9tb2R1bGUuX19zcGVjX18sICJuYW1lIiwgTm9uZSkKICAgIGlmIG1haW5fbW9kX25hbWUgaXMgbm90IE5vbmU6CiAgICAgICAgZFsnaW5pdF9tYWluX2Zyb21fbmFtZSddID0gbWFpbl9tb2RfbmFtZQogICAgZWxpZiBzeXMucGxhdGZvcm0gIT0gJ3dpbjMyJyBvciAobm90IFdJTkVYRSBhbmQgbm90IFdJTlNFUlZJQ0UpOgogICAgICAgIG1haW5fcGF0aCA9IGdldGF0dHIobWFpbl9tb2R1bGUsICdfX2ZpbGVfXycsIE5vdGVudCB0eXBlIG9mIHRoZSBjb25jcmV0ZSBtb2RlbC4KICAgICAgICAiIiIKICAgICAgICBvcHRzID0gVXNlclByb3h5Ll9tZXRhCiAgICAgICAgY29kZW5hbWUgPSBnZXRfcGVybWlzc2lvbl9jb2RlbmFtZSgiYWRkIiwgb3B0cykKICAgICAgICBzZWxmLmFzc2VydFRydWUoCiAgICAgICAgICAgIFBlcm1pc3Npb24ub2JqZWN0cy5maWx0ZXIoCiAgICAgICAgICAgICAgICBjb250ZW50X3R5cGVfX21vZGVsPW9wdHMubW9kZWxfbmFtZSwKICAgICAgICAgICAgICAgIGNvbnRlbnRfdHlwZV9fYXBwX2xhYmVsPW9wdHMuYXBwX2xhYmVsLAogICAgICAgICAgICAgICAgY29kZW5hbWU9Y29kZW5hbWUsCiAgICAgICAgICAgICkuZXhpc3RzKCkKICAgICAgICApCgoKY2xhc3MgRGVmYXVsdERCUm91dGVyOgogICAgIiIiUm91dGUgYWxsIHdyaXRlcyB0byBkZWZhdWx0LiIiIgoKICAgIGRlZiBkYl9mb3Jfd3JpdGUoc2VsZiwgbW9kZWwsICoqaGludHMpOgogICAgICAgIHJldHVybiAiZGVmYXVsdCIKCgpAb3ZlcnJpZGVfc2V0dGluZ3MoREFUQUJBU0VfUk9VVEVSUz1bRGVmYXVsdERCUm91dGVyKCldKQpjbGFzcyBDcmVhdGVQZXJtaXNzaW9uc011bHRpcGxlRGF0YWJhc2VzVGVzdHMoVGVzdENhc2UpOgogICAgZGF0YWJhc2VzID0geyJkZWZhdWx0IiwgIm90aGVyIn0KCiAgICBkZWYgdGVzdF9zZXRfcGVybWlzc2lvbnNfZmtfdG9fdXNpbmdfcGFyYW1ldGVyKHNlbGYpOgogICAgICAgIFBlcm1pc3Npb24ub2JqZWN0cy51c2luZygib3RoZXIiKS5kZWxldGUoKQogICAgICAgIHdpdGggc2VsZi5hc3NlcnROdW1RdWVyaWVzKDQsIHVzaW5nPSJvdGhlciIpIGFzIGNhcHR1cmVkX3F1ZXJpZXM6CiAgICAgICAgICAgIGNyZWF0ZV9wZXJtaXNzaW9ucyhhcHBzLmdldF9hcHBfY29uZmlnKCJhdXRoIiksIHZlcmJvc2l0eT0wLCB1c2luZz0ib3RoZXIiKQogICAgICAgIHNlbGYuYXNzZXJ0SW4oIklOU0VSVCBJTlRPIiwgY2FwdHVyZWRfcXVlcmllc1stMV1bInNxbCJdLnVwcGVyKCkpCiAgICAgICAgc2VsZi5hc3NlcnRHcmVhdGVyKFBlcm1pc3Npb24ub2JqZWN0cy51c2luZygib3RoZXIiKS5jb3VudCgpLCAwKQoiIiIgUHl0aG9uIENoYXJhY3RlciBNYXBwaW5nIENvZGVjIGdlbmVyYXRlZCBmcm9tICdocF9yb21hbjgudHh0JyB3aXRoIGdlbmNvZGVjLnB5LgoKICAgIEJhc2VkIG9uIGRhdGEgZnJvbSBmdHA6Ly9ka3V1Zy5kay9pMThuL2NoYXJtYXBzL0hQLVJPTUFOOCAoS2VsZCBTaW1vbnNlbikKCiAgICBPcmlnaW5hbCBzb3VyY2U6IExhc2VySmV0IElJUCBQcmludGVyIFVzZXIncyBNYW51YWwgSFAgcGFydCBubwogICAgMzM0NzEtOTA5MDEsIEhld2xldC1QYWNrYXJkLCBKdW5lIDE5ODkuCgogICAgKFVzZWQgd2l0aCBwZXJtaXNzaW9uKQoKIiIiIyIKCmltcG9ydCBjb2RlY3MKCiMjIyBDb2RlYyBBUElzCgpjbGFzcyBDb2RlYyhjb2RlY3MuQ29kZWMpOgoKICAgIGRlZiBlbmNvZGUoc2VsZixpbnB1dCxlcnJvcnM9J3N0cmljdCcpOgogd28gbWFrZSBpdCBwb3NzaWJsZSB0byB2aWV3IHRoZSBoZWFwIGFzIGEgcmVndWxhciBQeXRob24gbGlzdAp3aXRob3V0IHN1cnByaXNlczogaGVhcFswXSBpcyB0aGUgc21hbGxlc3QgaXRlbSwgYW5kIGhlYXAuc29ydCgpCm1haW50YWlucyB0aGUgaGVhcCBpbnZhcmlhbnQhCiIiIgoKIyBPcmlnaW5hbCBjb2RlIGJ5IEtldmluIE8nQ29ubm9yLCBhdWdtZW50ZWQgYnkgVGltIFBldGVycyBhbmQgUmF5bW9uZCBIZXR0aW5nZXIKCl9fYWJvdXRfXyA9ICIiIkhlYXAgcXVldWVzCgpbZXhwbGFuYXRpb24gYnkgRnJhbsOnb2lzIFBpbmFyZF0KCkhlYXBzIGFyZSBhcnJheXMgZm9yIHdoaWNoIGFba10gPD0gYVsyKmsrMV0gYW5kIGFba10gPD0gYVsyKmsrMl0gZm9yCmFsbCBrLCBjb3VudGluZyBlbGVtZW50cyBmcm9tIDAuICBGb3IgdGhlIHNha2Ugb2YgY29tcGFyaXNvbiwKbm9uLWV4aXN0aW5nIGVsZW1lbnRzIGFyZSBjb25zaWRlcmVkIHRvIGJlIGluZmluaXRlLiAgVGhlIGludGVyZXN0aW5nCnByb3BlcnR5IG9mIGEgaGVhcCBpcyB0aGF0IGFbMF0gaXMgYWx3YXlzIGl0cyBzbWFsbGVzdCBlbGVtZW50LgoKVGhlIHN0cmFuZ2UgaW52YXJpYW50IGFib3ZlIGlzIG1lYW50IHRvIGJlIGFuIGVmZmljaWVudCBtZW1vcnkKcmVwcmVzZW50YXRpb24gZm9yIGEgdG91cm5hbWVudC4gIFRoZSBudW1iZXJzIGJlbG93IGFyZSAnaycsIG5vdCBhW2tdOgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwCgogICAgICAgICAgICAgICAgICAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMgoKICAgICAgICAgIDMgICAgICAgICAgICAgICA0ICAgICAgICAgICAgICAgIDUgICAgICAgICAgICAgICA2CgogICAgICA3ICAgICAgIDggICAgICAgOSAgICAgICAxMCAgICAgIDExICAgICAgMTIgICAgICAxMyAgICAgIDE0CgogICAgMTUgMTYgICAxNyAxOCAgIDE5IDIwICAgMjEgMjIgICAyMyAyNCAgIDI1IDI2ICAgMjcgMjggICAyOSAzMAoKCkluIHRoZSB0cmVlIGFib3ZlLCBlYWNoIGNlbGwgJ2snIGlzIHRvcHBpbmcgJzIqaysxJyBhbmQgJzIqaysyJy4gIEluCmEgdXN1YWwgYmluYXJ5IHRvdXJuYW1lbnQgd2Ugc2VlIGluIHNwb3J0cywgZWFjaCBjZWxsIGlzIHRoZSB3aW5uZXIKb3ZlciB0aGUgdHdvIGNlbGxzIGl0IHRvcHMsIGFuZCB3ZSBjYW4gdHJhY2UgdGhlIHdpbm5lciBkb3duIHRoZSB0cmVlCnRvIHNlZSBhbGwgb3Bwb25lbnRzIHMvaGUgaGFkLiAgSG93ZXZlciwgaW4gbWFueSBjb21wdXRlciBhcHBsaWNhdGlvbnMKb2Ygc3VjaCB0b3VybmFtZW50cywgd2UgZG8gbm90IG5lZWQgdG8gdHJhY2UgdGhlIGhpc3Rvcnkgb2YgYSB3aW5uZXIuClRvIGJlIG1vcmUgbWVtb3J5IGVmZmljaWVudCwgd2hlbiBhIHdpbm5lciBpcyBwcm9tb3RlZCwgd2UgdHJ5IHRvCnJlcGxhY2UgaXQgYnkgc29tZXRoaW5nIGVsc2UgYXQgYSBsb3dlciBsZXZlbCwgYW5kIHRoZSBydWxlIGJlY29tZXMKdGhhdCBhIGNlbGwgYW5kIChpZiBhcHBsaWNhYmxlKQogICAgcG9zdGdpcyA9IEZhbHNlCiAgICBzcGF0aWFsaXRlID0gRmFsc2UKICAgIG1hcmlhZGIgPSBGYWxzZQogICAgbXlzcWwgPSBGYWxzZQogICAgb3JhY2xlID0gRmFsc2UKICAgIHNwYXRpYWxfdmVyc2lvbiA9IE5vbmUKCiAgICAjIEhvdyB0aGUgZ2VvbWV0cnkgY29sdW1uIHNob3VsZCBiZSBzZWxlY3RlZC4KICAgIHNlbGVjdCA9ICIlcyIKCiAgICBAY2FjaGVkX3Byb3BlcnR5CiAgICBkZWYgc2VsZWN0X2V4dGVudChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5zZWxlY3QKCiAgICAjIEFnZ3JlZ2F0ZXMKICAgIGRpc2FsbG93ZWRfYWdncmVnYXRlcyA9ICgpCgogICAgZ2VvbV9mdW5jX3ByZWZpeCA9ICIiCgogICAgIyBNYXBwaW5nIGJldHdlZW4gRGphbmdvIGZ1bmN0aW9uIG5hbWVzIGFuZCBiYWNrZW5kIG5hbWVzLCB3aGVuIG5hbWVzIGRvCiAgICAjIG5vdCBtYXRjaDsgdXNlZCBpbiBzcGF0aWFsX2Z1bmN0aW9uX25hbWUoKS4KICAgIGZ1bmN0aW9uX25hbWVzID0ge30KCiAgICAjIFNldCBvZiBrbm93biB1bnN1cHBvcnRlZCBmdW5jdGlvbnMgb2YgdGhlIGJhY2tlbmQKICAgIHVuc3VwcG9ydGVkX2Z1bmN0aW9ucyA9IHsKICAgICAgICAiQXJlYSIsCiAgICAgICAgIkFzR2VvSlNPTiIsCiAgICAgICAgIkFzR01MIiwKICAgICAgICAiQXNLTUwiLAogICAgICAgICJBc1NWRyIsCiAgICAgICAgIkFzV0tCIiwKICAgICAgICAiQXNXS1QiLAogICAgICAgICJBemltdXRoIiwKICAgICAgICAiQm91bmRpbmdDaXJjbGUiLAogICAgICAgICJDZW50cm9pZCIsCiAgICAgICAgIkNsb3Nlc3RQb2ludCIsCiAgICAgICAgIkRpZmZlcmVuY2UiLAogICAgICAgICJEaXN0YW5jZSIsCiAgICAgICAgIkRpc3RhbmNlU3BoZXJvaWQiLAogICAgICAgICJFbnZlbG9wZSIsCiAgICAgICAgIkZvcmNlUG9seWdvbkNXIiwKICAgICAgICAiRnJvbVdLQiIsCiAgICAgICAgIkZyb21XS1QiLAogICAgICAgICJHZW9IYXNoIiwKICAgICAgICAiR2VvbWV0cnlEaXN0YW5jZSIsCiAgICAgICAgIkdlb21ldHJ5VHlwZSIsCiAgICAgICAgIkludGVyc2VjdGlvbiIsCiAgICAgICAgIklzRW1wdHkiLAogICAgICAgICJJc1ZhbGlkIiwKICAgICAgICAiTGVuZ3RoIiwKICAgICAgICAiTGluZUxvY2F0ZVBvaW50IiwKICAgICAgICAiTWFrZVZhbGlkIiwKICAgICAgICAiTWVtU2l6ZSIsCiAgICAgICAgIk51bURpbWVuc2lvbnMiLAogICAgICAgICJOdW1HZW9tZXRyaWVzIiwKICAgICAgICAiTnVtUG9pbnRzIiwKICAgICAgICAiUGVyaW1ldGVyIiwKICAgICAgICAiUG9pbnRPblN1cmZhY2UiLAogICAgICAgICJSZXZlcnNlIiwKICAgICAgICAiUm90YXRlIiwKICAgICAgICAiU2NhbGUiLAogICAgICAgICJTbmFwVG9HcmlkIiwKICAgICAgICAiU3ltRGlmZmVyZW5jZSIsCiAgICAgICAgIlRyYW5zZm9ybSIsCiAgICAgICAgIlRyYW5zbGF0ZSIsCiAgICAgICAgIlVuaW9uIiwKICAgIH0KCiAgICAjIENvbnN0cnVjdG9ycwogYWl0IHNlbGYuc2Vzc2lvbi5hZ2V0X2V4cGlyeV9hZ2UoKSwgc2VsZi5jdXN0b21fc2Vzc2lvbl9jb29raWVfYWdlCiAgICAgICAgKQoKCmNsYXNzIENhY2hlREJTZXNzaW9uVGVzdHMoU2Vzc2lvblRlc3RzTWl4aW4sIFRlc3RDYXNlKToKICAgIGJhY2tlbmQgPSBDYWNoZURCU2Vzc2lvbgoKICAgIGRlZiB0ZXN0X2V4aXN0c19zZWFyY2hlc19jYWNoZV9maXJzdChzZWxmKToKICAgICAgICBzZWxmLnNlc3Npb24uc2F2ZSgpCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydE51bVF1ZXJpZXMoMCk6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0SXMoc2VsZi5zZXNzaW9uLmV4aXN0cyhzZWxmLnNlc3Npb24uc2Vzc2lvbl9rZXkpLCBUcnVlKQoKICAgICMgU29tZSBiYWNrZW5kcyBtaWdodCBpc3N1ZSBhIHdhcm5pbmcKICAgIEBpZ25vcmVfd2FybmluZ3MobW9kdWxlPSJkamFuZ28uY29yZS5jYWNoZS5iYWNrZW5kcy5iYXNlIikKICAgIGRlZiB0ZXN0X2xvYWRfb3Zlcmxvbmdfa2V5KHNlbGYpOgogICAgICAgIHNlbGYuc2Vzc2lvbi5fc2Vzc2lvbl9rZXkgPSAoc3RyaW5nLmFzY2lpX2xldHRlcnMgKyBzdHJpbmcuZGlnaXRzKSAqIDIwCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzZWxmLnNlc3Npb24ubG9hZCgpLCB7fSkKCiAgICBAb3ZlcnJpZGVfc2V0dGluZ3MoU0VTU0lPTl9DQUNIRV9BTElBUz0ic2Vzc2lvbnMiKQogICAgZGVmIHRlc3Rfbm9uX2RlZmF1bHRfY2FjaGUoc2VsZik6CiAgICAgICAgIyAyMTAwMCAtIENhY2hlREIgYmFja2VuZCBzaG91bGQgcmVzcGVjdCBTRVNTSU9OX0NBQ0hFX0FMSUFTLgogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXMoSW52YWxpZENhY2hlQmFja2VuZEVycm9yKToKICAgICAgICAgICAgc2VsZi5iYWNrZW5kKCkKCiAgICBAb3ZlcnJpZGVfc2V0dGluZ3MoCiAgICAgICAgQ0FDSEVTPXsiZGVmYXVsdCI6IHsiQkFDS0VORCI6ICJjYWNoZS5mYWlsaW5nX2NhY2hlLkNhY2hlQ2xhc3MifX0KICAgICkKICAgIGRlZiB0ZXN0X2NhY2hlX3NldF9mYWlsdXJlX25vbl9mYXRhbChzZWxmKToKICAgICAgICAiIiJGYWlsaW5nIHRvIHdyaXRlIHRvIHRoZSBjYWNoZSBkb2VzIG5vdCByYWlzZSBlcnJvcnMuIiIiCiAgICAgICAgc2Vzc2lvbiA9IHNlbGYuYmFja2VuZCgpCiAgICAgICAgc2Vzc2lvblsia2V5Il0gPSAidmFsIgoKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0TG9ncygiZGphbmdvLmNvbnRyaWIuc2Vzc2lvbnMiLCAiRVJST1IiKSBhcyBjbToKICAgICAgICAgICAgc2Vzc2lvbi5zYXZlKCkKCiAgICAgICAgIyBBIHByb3BlciBFUlJPUiBsb2cgbWVzc2FnZSB3YXMgcmVjb3JkZWQuCiAgICAgICAgbG9nID0gY20ucmVjb3Jkc1stMV0KICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGxvZy5tZXNzYWdlLCBmIkVycm9yIHNhdmluZyB0byBjYWNoZSAoe3Nlc3Npb24uX2NhY2hlfSkiKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoc3RyKGxvZy5leGNfaW5mb1sxXSksICJGYWtlZCBleGNlYXNjaWkiLCB7Imdyb3VwIjogZ3JvdXB9KQogICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShvdXRwdXQuc3RhcnRzd2l0aCgieyYjeDI3O2dyb3VwJiN4Mjc7OiAmbHQ7R3JvdXA6IOa4hemiqCZndDt9IikpCgogICAgQHNldHVwKHsic2NyaXB0IjogInslIGRlYnVnICV9In0pCiAgICBkZWYgdGVzdF9zY3JpcHQoc2VsZik6CiAgICAgICAgb3V0cHV0ID0gc2VsZi5lbmdpbmUucmVuZGVyX3RvX3N0cmluZygic2NyaXB0IiwgeyJmcmFnIjogIjxzY3JpcHQ+In0pCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKAogICAgICAgICAgICBvdXRwdXQuc3RhcnRzd2l0aCgieyYjeDI3O2ZyYWcmI3gyNzs6ICYjeDI3OyZsdDtzY3JpcHQmZ3Q7JiN4Mjc7fSIpCiAgICAgICAgKQppbXBvcnQgaW5zcGVjdAppbXBvcnQgcmUKCmZyb20gZGphbmdvLmFwcHMgaW1wb3J0IGFwcHMgYXMgZGphbmdvX2FwcHMKZnJvbSBkamFuZ28uY29uZiBpbXBvcnQgc2V0dGluZ3MKZnJvbSBkamFuZ28uY29yZS5leGNlcHRpb25zIGltcG9ydCBJbXByb3Blcmx5Q29uZmlndXJlZCwgUGVybWlzc2lvbkRlbmllZApmcm9tIGRqYW5nby5taWRkbGV3YXJlLmNzcmYgaW1wb3J0IHJvdGF0ZV90b2tlbgpmcm9tIGRqYW5nby51dGlscy5jcnlwdG8gaW1wb3J0IGNvbnN0YW50X3RpbWVfY29tcGFyZQpmcm9tIGRqYW5nby51dGlscy5tb2R1bGVfbG9hZGluZyBpbXBvcnQgaW1wb3J0X3N0cmluZwpmcm9tIGRqYW5nby52aWV3cy5kZWNvcmF0b3JzLmRlYnVnIGltcG9ydCBzZW5zaXRpdmVfdmFyaWFibGVzCgpmcm9tIC5zaWduYWxzIGltcG9ydCB1c2VyX2xvZ2dlZF9pbiwgdXNlcl9sb2dnZWRfb3V0LCB1c2VyX2xvZ2luX2ZhaWxlZAoKU0VTU0lPTl9LRVkgPSAiX2F1dGhfdXNlcl9pZCIKQkFDS0VORF9TRVNTSU9OX0tFWSA9ICJfYXV0aF91c2VyX2JhY2tlbmQiCkhBU0hfU0VTU0lPTl9LRVkgPSAiX2F1dGhfdXNlcl9oYXNoIgpSRURJUkVDVF9GSUVMRF9OQU1FID0gIm5leHQiCgoKZGVmIGxvYWRfYmFja2VuZChwYXRoKToKICAgIHJldHVybiBpbXBvcnRfc3RyaW5nKHBhdGgpKCkKCgpkZWYgX2dldF9iYWNrZW5kcyhyZXR1cm5fdHVwbGVzPUZhbHNlKToKICAgIGJhY2tlbmRzID0gW10KICAgIGZvciBiYWNrZW5kX3BhdGggaW4gc2V0dGluZ3MuQVVUSEVOVElDQVRJT05fQkFDS0VORFM6CiAgICAgICAgYmFja2VuZCA9IGxvYWRfYmFja2VuZChiYWNrZW5kX3BhdGgpCiAgICAgICAgYmFja2VuZHMuYXBwZW5kKChiYWNrZW5kLCBiYWNrZW5kX3BhdGgpIGlmIHJldHVybl90dXBsZXMgZWxzZSBiYWNrZW5kKQogICAgaWYgbm90IGJhY2tlbmRzOgogICAgICAgIHJhaXNlIEltcHJvcGVybHlDb25maWd1cmVkKAogICAgICAgICAgICAiTm8gYXV0aGVudGljYXRpb24gYmFja2VuZHMgaGF2ZSBiZWVuIGRlZmluZWQuIERvZXMgIgogICAgICAgICAgICAiQVVUSEVOVElDQVRJT05fQkFDS0VORFMgY29udGFpbiBhbnl0aGluZz8iCiAgICAgICAgKQogICAgcmV0dXJuIGJhY2tlbmRzCgoKc3RlcihWaWRlb1N0cmVhbSwgYXV0b2NvbXBsZXRlX2ZpZWxkcz1bInJlbGVhc2VfZXZlbnQiXSkKCnNpdGUucmVnaXN0ZXIoSW52ZW50b3J5KQoKc2l0ZS5yZWdpc3RlcihCZWUpCgpzaXRlLnJlZ2lzdGVyKEFkdmlzb3IpCgpzaXRlLnJlZ2lzdGVyKFNjaG9vbCwgU2Nob29sQWRtaW4pCnNpdGUucmVnaXN0ZXIoU3R1ZGVudCkKCnNpdGUucmVnaXN0ZXIoUHJvZmlsZSkKIiIiCkxpYi9jdHlwZXMudXRpbC5maW5kX2xpYnJhcnkoKSBzdXBwb3J0IGZvciBBSVgKU2ltaWxhciBhcHByb2FjaCBhcyBkb25lIGZvciBEYXJ3aW4gc3VwcG9ydCBieSB1c2luZyBzZXBhcmF0ZSBmaWxlcwpidXQgdW5saWtlIERhcndpbiAtIG5vIGV4dGVuc2lvbiBzdWNoIGFzIGN0eXBlcy5tYWNob2xpYi4qCgpkbG9wZW4oKSBpcyBhbiBpbnRlcmZhY2UgdG8gQUlYIGluaXRBbmRMb2FkKCkgLSBwcmltYXJ5IGRvY3VtZW50YXRpb24gYXQ6Cmh0dHBzOi8vd3d3LmlibS5jb20vc3VwcG9ydC9rbm93bGVkZ2VjZW50ZXIvZW4vc3N3X2FpeF82MS9jb20uaWJtLmFpeC5iYXNldHJmMS9kbG9wZW4uaHRtCmh0dHBzOi8vd3d3LmlibS5jb20vc3VwcG9ydC9rbm93bGVkZ2VjZW50ZXIvZW4vc3N3X2FpeF82MS9jb20uaWJtLmFpeC5iYXNldHJmMS9sb2FkLmh0bQoKQUlYIHN1cHBvcnRzIHR3byBzdHlsZXMgZm9yIGRsb3BlbigpOiBzdnI0IChTeXN0ZW0gViBSZWxlYXNlIDQpIHdoaWNoIGlzIGNvbW1vbiBvbiBwb3NpeApwbGF0Zm9ybXMsIGJ1dCBhbHNvIGEgQlNEIHN0eWxlIC0gYWthIFNWUjMuCgpGcm9tIEFJWCA1LjMgRGlmZmVyZW5jZSBBZGRlbmR1bSAoRGVjZW1iZXIgMjAwNCkKMi45IFNWUjQgbGlua2luZyBhZmZpbml0eQpOb3dhZGF5cywgdGhlcmUgYXJlIHR3byBtYWpvciBvYmplY3QgZmlsZSBmb3JtYXRzIHVzZWQgYnkgdGhlIG9wZXJhdGluZyBzeXN0ZW1zOgpYQ09GRjogVGhlIENPRkYgZW5oYW5jZWQgYnkgSUJNIGFuZCBvdGhlcnMuIFRoZSBvcmlnaW5hbCBDT0ZGIChDb21tb24KT2JqZWN0IEZpbGUgRm9ybWF0KSB3YXMgdGhlIGJhc2Ugb2YgU1ZSMyBhbmQgQlNEIDQuMiBzeXN0ZW1zLgpFTEY6ICAgRXhlY3V0YWJsZSBhbmQgTGlua2luZyBGb3JtYXQgdGhhdCB3YXMgZGV2ZWxvcGVkIGJ5IEFUJlQgYW5kIGlzIGEKYmFzZSBmb3IgU1ZSNCBVTklYLgoKV2hpbGUgdGhlIHNoYXJlZCBsaWJyYXJ5IGNvbnRlbnQgaXMgaWRlbnRpY2FsIG9uIEFJWCAtIG9uZSBpcyBsb2NhdGVkIGFzIGEgZmlsZXBhdGggbmFtZQooc3ZyNCBzdHlsZSkgYW5kIHRoZSBvdGhlciBpcyBsb2NhdGVkIGFzIGEgbWVtYmVyIG9mIGFuIGFyY2hpdmUgKGFuZCB0aGUgYXJjaGl2ZQppcyBsb2NhdGVkIGFzIGEgZmlsZXBhdGggbmFtZSkuCgpUaGUga2V5IGRpZmZlcmVuY2UgYXJpc2VzIHdoZW4gc3VwcG9ydGluZyBtdWx0aXBsZSBhYmkgZm9ybWF0cyAoaS5lLiwgMzIgYW5kIDY0IGJpdCkuCkZvciBzdnI0IGVpdGhlciBvbmx5IG9uZSBBQkkgaXMgc3VwcG9ydGVkLCBvciB0cnRJcyhib29sLl9fbmV3X18oYm9vbCwgVHJ1ZSksIFRydWUpCgoKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIHVuaXR0ZXN0Lm1haW4oKQonJydUaGlzIG1vZHVsZSBpbXBsZW1lbnRzIHNwZWNpYWxpemVkIGNvbnRhaW5lciBkYXRhdHlwZXMgcHJvdmlkaW5nCmFsdGVybmF0aXZlcyB0byBQeXRob24ncyBnZW5lcmFsIHB1cnBvc2UgYnVpbHQtaW4gY29udGFpbmVycywgZGljdCwKbGlzdCwgc2V0LCBhbmQgdHVwbGUuCgoqIG5hbWVkdHVwbGUgICBmYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyB0dXBsZSBzdWJjbGFzc2VzIHdpdGggbmFtZWQgZmllbGRzCiogZGVxdWUgICAgICAgIGxpc3QtbGlrZSBjb250YWluZXIgd2l0aCBmYXN0IGFwcGVuZHMgYW5kIHBvcHMgb24gZWl0aGVyIGVuZAoqIENoYWluTWFwICAgICBkaWN0LWxpa2UgY2xhc3MgZm9yIGNyZWF0aW5nIGEgc2luZ2xlIHZpZXcgb2YgbXVsdGlwbGUgbWFwcGluZ3MKKiBDb3VudGVyICAgICAgZGljdCBzdWJjbGFzcyBmb3IgY291bnRpbmcgaGFzaGFibGUgb2JqZWN0cwoqIE9yZGVyZWREaWN0ICBkaWN0IHN1YmNsYXNzIHRoYXQgcmVtZW1iZXJzIHRoZSBvcmRlciBlbnRyaWVzIHdlcmUgYWRkZWQKKiBkZWZhdWx0ZGljdCAgZGljdCBzdWJjbGFzcyB0aGF0IGNhbGxzIGEgZmFjdG9yeSBmdW5jdGlvbiB0byBzdXBwbHkgbWlzc2luZyB2YWx1ZXMKKiBVc2VyRGljdCAgICAgd3JhcHBlciBhcm91bmQgZGljdGlvbmFyeSBvYmplY3RzIGZvciBlYXNpZXIgZGljdCBzdWJjbGFzc2luZwoqIFVzZXJMaXN0ICAgICB3cmFwcGVyIGFyb3VuZCBsaXN0IG9iamVjdHMgZm9yIGVhc2llciBsaXN0IHN1YmNsYXNzaW5nCiogVXNlclN0cmluZyAgIHdyYXBwZXIgYXJvdW5kIHN0cmluZyBvYmplY3RzIGZvciBlYXNpZXIgc3RyaW5nIHN1YmNsYXNzaW5nCgonJycKCl9fYWxsX18gPSBbCiAgICAnQ2hhaW5NYXAnLAogICAgJ0NvdW50ZXInLAogICAgJ09yZGVyZWREaWN0JywKICAgICdVc2VyRGljdCcsCiAgICAnVXNlckxpc3QnLAogICAgJ1VzZXJTdHJpbmcnLAogICAgJ2RlZmF1bHRkaWN0JywKICAgICdkZXF1ZScsCiAgICAnbmFtZWR0dXBsZScsCl0KCmltcG9ydCBfY29sbGVjdGlvbnNfYWJjCmltcG9ydCBzeXMgYXMgX3N5cwoKX3N5cy5tb2R1bGVzWydjb2xsZWN0aW9ucy5hYmMnXSA9IF9jb2xsZWN0aW9uc19hYmMKYWJjID0gX2NvbGxlY3Rpb25zX2FiYwoKZnJvbSBpdGVydG9vbHMgaW1wb3J0IGNoYWluIGFzIF9jaGFpbgpmcm9tIGl0ZXJ0b29scyBpbXBvcnQgcmVwZWF0IGFzIF9yZXBlYXQKZnJvbSBpdGVydG9vbHMgaW1wb3J0IHN0YXJtYXAgYXMgX3N0YXJtYXAKZnJvbSBrZXl3b3JkIGltcG9ydCBpc2tleXdvcmQgYXMgX2lza2V5d29yZApmcm9tIG9wZXJhdG9yIGltcG9ydCBlcSBhcyBfZXEKZnJvbSBvcGVyYXRvciBpbXBvcnQgaXRlbWdldHRlciBhcyBfaXRlbWdldHRlcgpmcm9tIHJlcHJsaWIgaW1wb3J0IHJlY3Vyc2l2ZV9yZXByIGFzIF9yZWN1bmllbnQsIHNlbGRvbSB1c2VkIGVuY29kaW5nCiAgICAgICAgICAgIGYud3JpdGUoYidBXG5CXHJcbkNcckQrSUt3LScpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHNhZmVfdW5saW5rLCBURVNURk4pCgogICAgICAgIGRlZiBjaGVjayhtb2RlLCBleHBlY3RlZF9saW5lcyk6CiAgICAgICAgICAgIHdpdGggRmlsZUlucHV0KGZpbGVzPVRFU1RGTiwgbW9kZT1tb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICBvcGVuaG9vaz1ob29rX2VuY29kZWQoJ3V0Zi03JykpIGFzIGZpOgogICAgICAgICAgICAgICAgbGluZXMgPSBsaXN0KGZpKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGxpbmVzLCBleHBlY3RlZF9saW5lcykKCiAgICAgICAgY2hlY2soJ3InLCBbJ0FcbicsICdCXG4nLCAnQ1xuJywgJ0RcdTIwYWMnXSkKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzKFZhbHVlRXJyb3IpOgogICAgICAgICAgICBjaGVjaygncmInLCBbJ0FcbicsICdCXHJcbicsICdDXHInLCAnRFx1MjBhYyddKQoKCmNsYXNzIE1pc2NUZXN0KHVuaXR0ZXN0LlRlc3RDYXNlKToKCiAgICBkZWYgdGVzdF9hbGwoc2VsZik6CiAgICAgICAgc3VwcG9ydC5jaGVja19fYWxsX18oc2VsZiwgZmlsZWlucHV0KQoKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICB1bml0dGVzdC5tYWluKCkKIiIidHVydGxlZGVtby9saW5kZW5tYXllci5weQoKRWFjaCBtb3JuaW5nIHdvbWVuIGluIFRhbWlsIE5hZHUsIGluIHNvdXRoZXJuCkluZGlhLCBwbGFjZSBkZXNpZ25zLCBjcmVhdGVkIGJ5IHVzaW5nIHJpY2UKZmxvdXIgYW5kIGtub3duIGFzIGtvbGFtIG9uIHRoZSB0aHJlc2hvbGRzIG9mCnRoZWlyIGhvbWVzLgoKVGhlc2UgY2FuIGJlIGRlc2NyaWJlZCBieSBMaW5kZW5tYXllciBzeXN0ZW1zLAp3aGljaCBjYW4gZWFzaWx5IGJlIGltcGxlbWVudGVkIHdpdGggdHVydGxlCmdyYXBoaWNzIGFuZCBQeXRob24uCgpUd28gZXhhbXBsZXMgYXJlIHNob3duIGhlcmU6CigxKSB0aGUgc25ha2Uga29sYW0KKDIpIGFua2xldHMgb2YgS3Jpc2huYQoKVGFrZW4gZnJvbSBNYXJjaWEgQXNjaGVyOiBNYXRoZW1hdGljcwpFbHNld2hlcmUsIEFuIEV4cGxvcmF0aW9uIG9mIElkZWFzIEFjcm9zcwpDdWx0dXJlcwoKIiIiCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMgTWluaSBMaW5kZW5tYXllciB0b29sCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCmZyb20gdHVydGxlIGltcG9ydCAqCgpkZWYgcmVwbGFjZSggc2VxLCByZXBsYWNlbWVudFJ1bGVzLCBuICk6CiAgICBmb3IgaSBpbiByYW5nZShuKToKICAgICAgICBuZXdzZXEgPSAiIgogICAgICAgIGZvciBlbGVtZW50IGluIHNlcToKICAgICAgICAgICAgbmV3c2VxID0gbmV3c2VxICsgcmVwbGFjZW1lbnRSdWxlcy5nZXQoZWxlbWVudCxlbGVtZW50KQogICAgICAgIHNlcSA9IG5ld3NlcQogICAgcmV0dXJuIHNlcQoKZGVmIGRyYXcoIGNvbW1hbmRzLCBydWxlcyApOgogY2FuX3JvbGxiYWNrX2RkbCA9IFRydWUKICAgIGNhbl9jcmVhdGVfaW5saW5lX2ZrID0gRmFsc2UKICAgIHJlcXVpcmVzX2xpdGVyYWxfZGVmYXVsdHMgPSBUcnVlCiAgICBjYW5fY2xvbmVfZGF0YWJhc2VzID0gVHJ1ZQogICAgc3VwcG9ydHNfdGVtcG9yYWxfc3VidHJhY3Rpb24gPSBUcnVlCiAgICBpZ25vcmVzX3RhYmxlX25hbWVfY2FzZSA9IFRydWUKICAgIHN1cHBvcnRzX2Nhc3Rfd2l0aF9wcmVjaXNpb24gPSBGYWxzZQogICAgdGltZV9jYXN0X3ByZWNpc2lvbiA9IDMKICAgIGNhbl9yZWxlYXNlX3NhdmVwb2ludHMgPSBUcnVlCiAgICBoYXNfY2FzZV9pbnNlbnNpdGl2ZV9saWtlID0gVHJ1ZQogICAgc3VwcG9ydHNfcGFyZW50aGVzZXNfaW5fY29tcG91bmQgPSBGYWxzZQogICAgY2FuX2RlZmVyX2NvbnN0cmFpbnRfY2hlY2tzID0gVHJ1ZQogICAgc3VwcG9ydHNfb3Zlcl9jbGF1c2UgPSBUcnVlCiAgICBzdXBwb3J0c19mcmFtZV9yYW5nZV9maXhlZF9kaXN0YW5jZSA9IFRydWUKICAgIHN1cHBvcnRzX2ZyYW1lX2V4Y2x1c2lvbiA9IFRydWUKICAgIHN1cHBvcnRzX2FnZ3JlZ2F0ZV9maWx0ZXJfY2xhdXNlID0gVHJ1ZQogICAgc3VwcG9ydHNfYWdncmVnYXRlX29yZGVyX2J5X2NsYXVzZSA9IERhdGFiYXNlLnNxbGl0ZV92ZXJzaW9uX2luZm8gPj0gKDMsIDQ0LCAwKQogICAgc3VwcG9ydHNfYWdncmVnYXRlX2Rpc3RpbmN0X211bHRpcGxlX2FyZ3VtZW50ID0gRmFsc2UKICAgIHN1cHBvcnRzX2FueV92YWx1ZSA9IFRydWUKICAgIG9yZGVyX2J5X251bGxzX2ZpcnN0ID0gVHJ1ZQogICAgc3VwcG9ydHNfanNvbl9maWVsZF9jb250YWlucyA9IEZhbHNlCiAgICBzdXBwb3J0c191cGRhdGVfY29uZmxpY3RzID0gVHJ1ZQogICAgc3VwcG9ydHNfdXBkYXRlX2NvbmZsaWN0c193aXRoX3RhcmdldCA9IFRydWUKICAgIHN1cHBvcnRzX3N0b3JlZF9nZW5lcmF0ZWRfY29sdW1ucyA9IFRydWUKICAgIHN1cHBvcnRzX3ZpcnR1YWxfZ2VuZXJhdGVkX2NvbHVtbnMgPSBUcnVlCiAgICB0ZXN0X2NvbGxhdGlvbnMgPSB7CiAgICAgICAgImNpIjogIm5vY2FzZSIsCiAgICAgICAgImNzIjogImJpbmFyeSIsCiAgICAgICAgIm5vbl9kZWZhdWx0IjogIm5vY2FzZSIsCiAgICAgICAgInZpcnR1YWwiOiAibm9jYXNlIiwKICAgIH0KICAgIGRqYW5nb190ZXN0X2V4cGVjdGVkX2ZhaWx1cmVzID0gewogICAgICAgICMgVGhlIGRqYW5nb19mb3JtYXRfZHRkZWx0YSgpIGZ1bmN0aW9uIGRvZXNuJ3QgcHJvcGVybHkgaGFuZGxlIG1peGVkCiAgICAgICAgIyBEYXRlL0RhdGVUaW1lIGZpZWxkcyBhbmQgdGltZWRlbHRhcy4KICAgICAgICAiZXhwcmVzc2lvbnMudGVzdHMuRlRpbWVEZWx0YVRlc3RzLnRlc3RfbWl4ZWRfY29tcGFyaXNvbnMxIiwKICAgIH0KICAgIGluc2VydF90ZXN0X3RhYmxlX3dpdGhfZGVmYXVsdHMgPSAnSU5TRVJUIElOVE8ge30gKCJudWxsIikgVkFMVUVTICgxKScKICAgIHN1cHBvcnRzX2RlZmF1bHRfa2V5d29yZF9pbl9pbnNldHogPSB0aW1lem9uZS51dGMKICAgIGVsc2U6ICAjIGxvY2FsIGRhdGUtdGltZQogICAgICAgIHR6ID0gTm9uZQogICAgcmV0dXJuIGRhdGV0aW1lKHllYXIsIG1vbnRoLCBkYXksIGhvdXIsIG1pbnV0ZSwgc2VjLCBtaWNyb3MsIHR6aW5mbz10eikKCgojIE5vIG5lZWQgdG8gbGltaXQgY2FjaGUgc2l6ZS4gVGhpcyBpcyBvbmx5IGV2ZXIgY2FsbGVkIG9uIGlucHV0CiMgdGhhdCBtYXRjaGVkIFJFX0RBVEVUSU1FLCBzbyB0aGVyZSBpcyBhbiBpbXBsaWNpdCBib3VuZCBvZgojIDI0IChob3VycykgKiA2MCAobWludXRlcykgKiAyIChvZmZzZXQgZGlyZWN0aW9uKSA9IDI4ODAuCkBscnVfY2FjaGUobWF4c2l6ZT1Ob25lKQpkZWYgY2FjaGVkX3R6KGhvdXJfc3RyOiBzdHIsIG1pbnV0ZV9zdHI6IHN0ciwgc2lnbl9zdHI6IHN0cikgLT4gdGltZXpvbmU6CiAgICBzaWduID0gMSBpZiBzaWduX3N0ciA9PSAiKyIgZWxzZSAtMQogICAgcmV0dXJuIHRpbWV6b25lKAogICAgICAgIHRpbWVkZWx0YSgKICAgICAgICAgICAgaG91cnM9c2lnbiAqIGludChob3VyX3N0ciksCiAgICAgICAgICAgIG1pbnV0ZXM9c2lnbiAqIGludChtaW51dGVfc3RyKSwKICAgICAgICApCiAgICApCgoKZGVmIG1hdGNoX3RvX2xvY2FsdGltZShtYXRjaDogcmUuTWF0Y2hbc3RyXSkgLT4gdGltZToKICAgIGhvdXJfc3RyLCBtaW51dGVfc3RyLCBzZWNfc3RyLCBtaWNyb3Nfc3RyID0gbWF0Y2guZ3JvdXBzKCkKICAgIG1pY3JvcyA9IGludChtaWNyb3Nfc3RyLmxqdXN0KDYsICIwIikpIGlmIG1pY3Jvc19zdHIgZWxzZSAwCiAgICByZXR1cm4gdGltZShpbnQoaG91cl9zdHIpLCBpbnQobWludXRlX3N0ciksIGludChzZWNfc3RyKSwgbWljcm9zKQoKCmRlZiBtYXRjaF90b19udW1iZXIobWF0Y2g6IHJlLk1hdGNoW3N0cl0sIHBhcnNlX2Zsb2F0OiBQYXJzZUZsb2F0KSAtPiBBbnk6CiAgICBpZiBtYXRjaC5ncm91cCgiZmxvYXRwYXJ0Iik6CiAgICAgICAgcmV0dXJuIHBhcnNlX2Zsb2F0KG1hdGNoLmdyb3VwKCkpCiAgICByZXR1cm4gaW50KG1hdGNoLmdyb3VwKCksIDApCmltcG9ydCBkYXRhY2xhc3NlcwppbXBvcnQganNvbgpmcm9tIF9jb2xvcml6ZSBpbXBvcnQgZ2V0X2NvbG9ycyAgIyB0eXBlOiBpZ25vcmVbaW1wb3J0LW5vdC1mb3VuZF0KZnJvbSB0eXBpbmcgaW1wb3J0IEFueQoKZnJvbSAudXRpbHMgaW1wb3J0ICgKICAgIFN0ckpTT04sIFRlc3ROYW1lLCBGaWx0ZXJUdXBsZSwKICAgIGZvcm1hdF9kdXJhdGlvbiwgbm9ybWFsaXplX3Rlc3RfbmFtZSwgcHJpbnRfd2FybmluZykKCgpAZGF0YWNsYXNzZXMuZGF0YWNsYXNzKHNsb3RzPVRydWUpCmNsYXNzIFRlc3RTdGF0czoKICAgIHRlc3RzX3J1bjogaW50ID0gMAogICAgZmFpbHVyZXM6IGludCA9IDAKICAgIHNraXBwZWQ6IGludCA9IDAKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZnJvbV91bml0dGVzdChyZXN1bHQpOgogICAgICAgIHJldHVybiBUZXN0U3RhdHMocmVzdWx0LnRlc3RzUnVuLAogICAgIlN0cmljdCBjaGVjaywgZmFpbCB3aGVuIGEgbW9kdWxlIGlzIG1pc3Npbmcgb3IgZmFpbHMgdG8gaW1wb3J0IgogICAgICAgICIoZGVmYXVsdDogbm8sIHVubGVzcyBlbnYgdmFyIFBZVEhPTlNUUklDVEVYVEVOU0lPTkJVSUxEIGlzIHNldCkiCiAgICApLAogICAgZGVmYXVsdD1ib29sKG9zLmVudmlyb24uZ2V0KCJQWVRIT05TVFJJQ1RFWFRFTlNJT05CVUlMRCIpKSwKKQoKcGFyc2VyLmFkZF9hcmd1bWVudCgKICAgICItLWNyb3NzLWNvbXBpbGluZyIsCiAgICBhY3Rpb249YXJncGFyc2UuQm9vbGVhbk9wdGlvbmFsQWN0aW9uLAogICAgaGVscD0oCiAgICAgICAgIlVzZSBjcm9zcy1jb21waWxpbmcgY2hlY2tzICIKICAgICAgICAiKGRlZmF1bHQ6IG5vLCB1bmxlc3MgZW52IHZhciBfUFlUSE9OX0hPU1RfUExBVEZPUk0gaXMgc2V0KS4iCiAgICApLAogICAgZGVmYXVsdD0iX1BZVEhPTl9IT1NUX1BMQVRGT1JNIiBpbiBvcy5lbnZpcm9uLAopCgpwYXJzZXIuYWRkX2FyZ3VtZW50KAogICAgIi0tbGlzdC1tb2R1bGUtbmFtZXMiLAogICAgYWN0aW9uPSJzdG9yZV90cnVlIiwKICAgIGhlbHA9IlByaW50IGEgbGlzdCBvZiBtb2R1bGUgbmFtZXMgdG8gc3Rkb3V0IGFuZCBleGl0IiwKKQoKcGFyc2VyLmFkZF9hcmd1bWVudCgKICAgICItLWdlbmVyYXRlLW1pc3Npbmctc3RkbGliLWluZm8iLAogICAgYWN0aW9uPSJzdG9yZV90cnVlIiwKICAgIGhlbHA9IkdlbmVyYXRlIGZpbGUgd2l0aCBzdGRsaWIgbW9kdWxlIGluZm8iLAopCgpwYXJzZXIuYWRkX2FyZ3VtZW50KAogICAgIi0td2l0aC1taXNzaW5nLXN0ZGxpYi1jb25maWciLAogICAgbWV0YXZhcj0iQ09ORklHX0ZJTEUiLAogICAgaGVscD0iUGF0aCB0byBKU09OIGNvbmZpZyBmaWxlIHdpdGggY3VzdG9tIG1pc3NpbmcgbW9kdWxlIG1lc3NhZ2VzIiwKKQoKCkBlbnVtLnVuaXF1ZQpjbGFzcyBNb2R1bGVTdGF0ZShlbnVtLkVudW0pOgogICAgIyBNYWtlZmlsZSBzdGF0ZSAieWVzIgogICAgQlVJTFRJTiA9ICJidWlsdGluIgogICAgU0hBUkVEID0gInNoYXJlZCIKCiAgICBESVNBQkxFRCA9ICJkaXNhYmxlZCIKICAgIE1JU1NJTkcgPSAibWlzc2luZyIKICAgIE5BID0gIm4vYSIKICAgICMgZGlzYWJsZWQgYnkgU2V0dXAgLyBtYWtlc2V0dXAgcnVsZQogICAgRElTQUJMRURfU0VUVVAgPSAiZGlzYWJsZWRfc2V0dXAiCgogICAgZGVmIF9fYm9vbF9fKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgcmV0dXJuIHNlbGYudmFsdWUgaW4geyJidWlsdGluIiwgInNoYXJlZCJ9CgoKY2xhc3MgTW9kdWxlSW5mbyhOYW1lZFR1cGxlKToKICAgIG5hbWU6IHN0cgogICAgc3RhdGU6IE1vZHVsZVN0YXRlCgoKY2xhc3MgTW9kdWxlQ2hlY2tlcjoKICAgIHB5YnVpbGRkaXJfdHh0ID0gInB5YnVpbGRkaXIudHh0IgoKICAgIHNldHVwX2ZpbGVzID0gKAogICAgICAgICMgc2VlIGVuZCBvZiBjb25maWd1cmUuYWMKICAgICAgICBwYXRobGliLlBhdGgoIk1vZHVsZXMvU2V0dXAubG9jYWwiKSwKb3JtcyByZW5kZXJlZAogICAgICAgICAgICAiYm9va19zZXQtSU5JVElBTF9GT1JNUyI6ICIwIiwgICMgdGhlIG51bWJlciBvZiBmb3JtcyB3aXRoIGluaXRpYWwgZGF0YQogICAgICAgICAgICAiYm9va19zZXQtTUFYX05VTV9GT1JNUyI6ICIiLCAgIyB0aGUgbWF4IG51bWJlciBvZiBmb3JtcwogICAgICAgICAgICAiYm9va19zZXQtMC10aXRsZSI6ICJMZXMgRmxldXJzIGR1IE1hbCIsCiAgICAgICAgICAgICJib29rX3NldC0xLXRpdGxlIjogIiIsCiAgICAgICAgICAgICJib29rX3NldC0yLXRpdGxlIjogIiIsCiAgICAgICAgfQoKICAgICAgICBmb3Jtc2V0ID0gQXV0aG9yQm9va3NGb3JtU2V0KGRhdGEsIGluc3RhbmNlPWF1dGhvcikKICAgICAgICBzZWxmLmFzc2VydFRydWUoZm9ybXNldC5pc192YWxpZCgpKQoKICAgICAgICBzYXZlZCA9IGZvcm1zZXQuc2F2ZSgpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChsZW4oc2F2ZWQpLCAxKQogICAgICAgIChib29rMSwpID0gc2F2ZWQKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGJvb2sxLCBCb29rLm9iamVjdHMuZ2V0KHRpdGxlPSJMZXMgRmxldXJzIGR1IE1hbCIpKQogICAgICAgIHNlbGYuYXNzZXJ0U2VxdWVuY2VFcXVhbChhdXRob3IuYm9va19zZXQuYWxsKCksIFtib29rMV0pCgogICAgICAgICMgTm93IHRoYXQgd2UndmUgYWRkZWQgYSBib29rIHRvIENoYXJsZXMgQmF1ZGVsYWlyZSwgbGV0J3MgdHJ5IGFkZGluZwogICAgICAgICMgYW5vdGhlciBvbmUuIFRoaXMgdGltZSB0aG91Z2gsIGFuIGVkaXQgZm9ybSB3aWxsIGJlIGF2YWlsYWJsZSBmb3IKICAgICAgICAjIGV2ZXJ5IGV4aXN0aW5nIGJvb2suCgogICAgICAgIEF1dGhvckJvb2tzRm9ybVNldCA9IGlubGluZWZvcm1zZXRfZmFjdG9yeSgKICAgICAgICAgICAgQXV0aG9yLCBCb29rLCBjYW5fZGVsZXRlPUZhbHNlLCBleHRyYT0yLCBmaWVsZHM9Il9fYWxsX18iCiAgICAgICAgKQogICAgICAgIGF1dGhvciA9IEF1dGhvci5vYmplY3RzLmdldChuYW1lPSJDaGFybGVzIEJhdWRlbGFpcmUiKQoKICAgICAgICBmb3Jtc2V0ID0gQXV0aG9yQm9va3NGb3JtU2V0KGluc3RhbmNlPWF1dGhvcikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGxlbihmb3Jtc2V0LmZvcm1zKSwgMykKICAgICAgICBzZWxmLmFzc2VydEhUTUxFcXVhbCgKICAgICAgICAgICAgZm9ybXNldC5mb3Jtc1swXS5hc19wKCksCiAgICAgICAgICAgICc8cD48bGFiZWwgZm9yPSJpZF9ib29rX3NldC0wLXRpdGxlIj5UaXRsZTo8L2xhYmVsPicKICAgICAgICAgICAgJzxpbnB1dCBpZD0iaWRfYm9va19zZXQtMC10aXRsZSIgdHlwZT0idGV4dCIgbmFtZT0iYm9va19zZXQtMC10aXRsZSIgJwogICAgICAgICAgICAndmFsdWU9IkxlcyBGbGV1cnMgZHUgTWFsIiBtYXhsZW5ndGg9IjEwMCI+JwogICAgICAgICAgICAnPGlucHV0IHR5cGU9ImhpZGRlbiIgbmFtZT0iYm9va19zZXQtMC1hdXRob3IiIHZhbHVlPSIlZCIgJwogICAgICAgICAgICAnaWQ9ImkgICAgQXR0ZW1wdCB0byBjb3B5IGBgcGF0aGBgIHdpdGggc3RvcmFnZQogICAgICAgICIiIgogICAgICAgICMgU2tpcCB0aGlzIGZpbGUgaWYgaXQgd2FzIGFscmVhZHkgY29waWVkIGVhcmxpZXIKICAgICAgICBpZiBwcmVmaXhlZF9wYXRoIGluIHNlbGYuY29waWVkX2ZpbGVzOgogICAgICAgICAgICByZXR1cm4gc2VsZi5sb2coIlNraXBwaW5nICclcycgKGFscmVhZHkgY29waWVkIGVhcmxpZXIpIiAlIHBhdGgpCiAgICAgICAgIyBEZWxldGUgdGhlIHRhcmdldCBmaWxlIGlmIG5lZWRlZCBvciBicmVhawogICAgICAgIGlmIG5vdCBzZWxmLmRlbGV0ZV9maWxlKHBhdGgsIHByZWZpeGVkX3BhdGgsIHNvdXJjZV9zdG9yYWdlKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgIyBUaGUgZnVsbCBwYXRoIG9mIHRoZSBzb3VyY2UgZmlsZQogICAgICAgIHNvdXJjZV9wYXRoID0gc291cmNlX3N0b3JhZ2UucGF0aChwYXRoKQogICAgICAgICMgRmluYWxseSBzdGFydCBjb3B5aW5nCiAgICAgICAgaWYgc2VsZi5kcnlfcnVuOgogICAgICAgICAgICBzZWxmLmxvZygiUHJldGVuZGluZyB0byBjb3B5ICclcyciICUgc291cmNlX3BhdGgsIGxldmVsPTEpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5sb2coIkNvcHlpbmcgJyVzJyIgJSBzb3VyY2VfcGF0aCwgbGV2ZWw9MikKICAgICAgICAgICAgd2l0aCBzb3VyY2Vfc3RvcmFnZS5vcGVuKHBhdGgpIGFzIHNvdXJjZV9maWxlOgogICAgICAgICAgICAgICAgc2VsZi5zdG9yYWdlLnNhdmUocHJlZml4ZWRfcGF0aCwgc291cmNlX2ZpbGUpCiAgICAgICAgc2VsZi5jb3BpZWRfZmlsZXMuYXBwZW5kKHByZWZpeGVkX3BhdGgpCiIiIkludGVyZmFjZSB0byB0aGUgY29tcGlsZXIncyBpbnRlcm5hbCBzeW1ib2wgdGFibGVzIiIiCgppbXBvcnQgX3N5bXRhYmxlCmZyb20gX3N5bXRhYmxlIGltcG9ydCAoCiAgICBVU0UsCiAgICBERUZfR0xPQkFMLCAgIyBub3FhOiBGNDAxCiAgICBERUZfTk9OTE9DQUwsIERFRl9MT0NBTCwKICAgIERFRl9QQVJBTSwgREVGX1RZUEVfUEFSQU0sIERFRl9GUkVFX0NMQVNTLAogICAgREVGX0lNUE9SVCwgREVGX0JPVU5ELCBERUZfQU5OT1QsCiAgICBERUZfQ09NUF9JVEVSLCBERUZfQ09NUF9DRUxMLAogICAgU0NPUEVfT0ZGLCBTQ09QRV9NQVNLLAogICAgRlJFRSwgTE9DQUwsIEdMT0JBTF9JTVBMSUNJVCwgR0xPQkFMX0VYUExJQ0lULCBDRUxMCikKCmltcG9ydCB3ZWFrcmVmCmZyb20gZW51bSBpbXBvcnQgU3RyRW51bQoKX19hbGxfXyA9IFsic3ltdGFibGUiLCAiU3ltYm9sVGFibGVUeXBlIiwgIlN5bWJvbFRhYmxlIiwgIkNsYXNzIiwgIkZ1bmN0aW9uIiwgIlN5bWJvbCJdCgpkZWYgc3ltdGFibGUoY29kZSwgZmlsZW5hbWUsIGNvbXBpbGVfdHlwZSwgKiwgbW9kdWxlPU5vbmUpOgogICAgIiIiIFJldHVybiB0aGUgdG9wbGV2ZWwgKlN5bWJvbFRhYmxlKiBmb3IgdGhlIHNvdXJjZSBjb2RlLgoKICAgICpmaWxlbmFtZSogaXMgdGxlci5zZXRGb3JtYXR0ZXIoZm9ybWF0dGVyKQogICAgbG9nZ2VyLmFkZEhhbmRsZXIoaGFuZGxlcikKCiAgICBpZiBsZXZlbDoKICAgICAgICBsb2dnZXIuc2V0TGV2ZWwobGV2ZWwpCiAgICBfbG9nX3RvX3N0ZGVyciA9IFRydWUKICAgIHJldHVybiBfbG9nZ2VyCgoKIyBBYnN0cmFjdCBzb2NrZXQgc3VwcG9ydAoKZGVmIF9wbGF0Zm9ybV9zdXBwb3J0c19hYnN0cmFjdF9zb2NrZXRzKCk6CiAgICByZXR1cm4gc3lzLnBsYXRmb3JtIGluICgibGludXgiLCAiYW5kcm9pZCIpCgoKZGVmIGlzX2Fic3RyYWN0X3NvY2tldF9uYW1lc3BhY2UoYWRkcmVzcyk6CiAgICBpZiBub3QgYWRkcmVzczoKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGlmIGlzaW5zdGFuY2UoYWRkcmVzcywgYnl0ZXMpOgogICAgICAgIHJldHVybiBhZGRyZXNzWzBdID09IDAKICAgIGVsaWYgaXNpbnN0YW5jZShhZGRyZXNzLCBzdHIpOgogICAgICAgIHJldHVybiBhZGRyZXNzWzBdID09ICJcMCIKICAgIHJhaXNlIFR5cGVFcnJvcihmJ2FkZHJlc3MgdHlwZSBvZiB7YWRkcmVzcyFyfSB1bnJlY29nbml6ZWQnKQoKCmFic3RyYWN0X3NvY2tldHNfc3VwcG9ydGVkID0gX3BsYXRmb3JtX3N1cHBvcnRzX2Fic3RyYWN0X3NvY2tldHMoKQoKIwojIEZ1bmN0aW9uIHJldHVybmluZyBhIHRlbXAgZGlyZWN0b3J5IHdoaWNoIHdpbGwgYmUgcmVtb3ZlZCBvbiBleGl0CiMKCiMgTWF4aW11bSBsZW5ndGggb2YgYSBOVUxMLXRlcm1pbmF0ZWQgWzFdIHNvY2tldCBmaWxlIHBhdGggaXMgdXN1YWxseQojIGJldHdlZW4gOTIgYW5kIDEwOCBbMl0sIGJ1dCBMaW51eCBpcyBrbm93biB0byB1c2UgYSBzaXplIG9mIDEwOCBbM10uCiMgQlNELWJhc2VkIHN5c3RlbXMgdXN1YWxseSB1c2UgYSBzaXplIG9mIDEwNCBvciAxMDggYW5kIFdpbmRvd3MgZG9lcwojIG5vdCBjcmVhdGUgQUZfVU5JWCBzb2NrZXRzLgojCiMgWzFdOiBodHRwczovL2dpdGh1Yi5jb20vcHl0aG9uL2NweXRob24vaXNzdWVzLzE0MDczNAojIFsyXTogaHR0cHM6Ly9wdWJzLm9wZW5ncm91cC5vcmcvb25saW5lcHVicy85Nzk5OTE5Nzk5L2Jhc2VkZWZzL3N5c191bi5oLmh0bWwKIyBbM106IGh0dHBzOi8vbWFuNy5vcmcvbGludXgvbWFuLXBhZ2VzL21hbjcvdW5peC43Lmh0bWwKCmlmIHN5cy5wbGF0Zm9ybSA9PSAnbGludXgnOgogICAgX1NVTl9QQVRIX01BWCA9IDEwOAplbGlmIHN5cy5wbGF0Zm9ybS5zdGFydHN3aXRoKCgnb3BlbmJzZCcsICdmcmVlYnNkJykpOgogICAgX1NVTl9QQVRIX01BWCA9IDEwNAplbHNlOgogICAgIyBPbiBXaW5kb3dzIHBsYXRmb3Jtcywgd2UgZG8gbm90IGNyZWF0ZSBBRl9VTklYIHNvY2tldHMuCiAgICBfU1VOX1BBVEhfTUFYID0gTm9uZSBpZiBvcy5uYW1lID09ICdudCcgZWxzZSA5MgoKZGVmIF9yZW1vdmVfdGVtcF9kaXIocm10cmVlLCB0ZW1wZGlyKToKICAgIHJtdHJlZSh0ZW1wZGlyKQoKICAgIGN1cnJlbnRfcHJvY2VzcyA9IHByb2Nlc3MuY3VycmVudF9wcm9jZXNzKCkKICAgIGF3ID0gY29yby5fX2F3YWl0X18oKQogICAgICAgIHRyeToKICAgICAgICAgICAgZm9yIHByb3RvIGluIHJhbmdlKHBpY2tsZS5ISUdIRVNUX1BST1RPQ09MICsgMSk6CiAgICAgICAgICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzKChUeXBlRXJyb3IsIHBpY2tsZS5QaWNrbGluZ0Vycm9yKSk6CiAgICAgICAgICAgICAgICAgICAgcGlja2xlLmR1bXBzKGF3LCBwcm90bykKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBhdy5jbG9zZSgpCgogICAgZGVmIHRlc3RfZmF0YWxfY29yb193YXJuaW5nKHNlbGYpOgogICAgICAgICMgSXNzdWUgMjc4MTEKICAgICAgICBhc3luYyBkZWYgZnVuYygpOiBwYXNzCiAgICAgICAgd2l0aCB3YXJuaW5ncy5jYXRjaF93YXJuaW5ncygpLCBcCiAgICAgICAgICAgICBzdXBwb3J0LmNhdGNoX3VucmFpc2FibGVfZXhjZXB0aW9uKCkgYXMgY206CiAgICAgICAgICAgIHdhcm5pbmdzLmZpbHRlcndhcm5pbmdzKCJlcnJvciIpCiAgICAgICAgICAgIGNvcm8gPSBmdW5jKCkKICAgICAgICAgICAgIyBvbmx5IHN0b3JlIHJlcHIoKSB0byBhdm9pZCBrZWVwaW5nIHRoZSBjb3JvdXRpbmUgYWxpdmUKICAgICAgICAgICAgY29yb19yZXByID0gcmVwcihjb3JvKQogICAgICAgICAgICBjb3JvID0gTm9uZQogICAgICAgICAgICBzdXBwb3J0LmdjX2NvbGxlY3QoKQoKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjbS51bnJhaXNhYmxlLmVycl9tc2csCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiJFeGNlcHRpb24gaWdub3JlZCB3aGlsZSBmaW5hbGl6aW5nICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmImNvcm91dGluZSB7Y29yb19yZXByfSIpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0SW4oIndhcyBuZXZlciBhd2FpdGVkIiwgc3RyKGNtLnVucmFpc2FibGUuZXhjX3ZhbHVlKSkKCiAgICBkZWYgdGVzdF9mb3JfYXNzaWduX3JhaXNpbmdfc3RvcF9hc3luY19pdGVyYXRpb24oc2VsZik6CiAgICAgICAgY2xhc3MgQmFkVGFyZ2V0OgogICAgICAgICAgICBkZWYgX19zZXRpdGVtX18oc2VsZiwga2V5LCB2YWx1ZSk6CiAgICAgICAgICAgICAgICByYWlzZSBTdG9wQXN5bmNJdGVyYXRpb24oNDIpCiAgICAgICAgdGd0ID0gQmFkVGFyZ2V0KCkKICAgICAgICBhc3luYyBkZWYgc291cmNlKCk6CiAgICAgICAgICAgIHlpZWxkIDEwCgogICAgICAgIGFzeW5jIGRlZiBydW5fZm9yKCk6CiAgICAgICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXMoU3RvcEFzeW5jSXRlcmF0aW9uKSBhcyBjbToKICAgICAgICAgICAgICAgIGFzeW5jIGZvciB0Z3RbMF0gaW4gc291cmNlKCk6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGNtLmV4Y2VwdGlvbi5hcmdzLCAoNDIsKSkKICAgICAgICAgICAgcmV0dXJuICdlbmQnCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChydW5fYXN5bmMocnVuX2ZvcigpKSwgKFtdLCAnZW5kJykpCgogbnMuemlwKS5yZXNvbHZlKCkKICAgIGlmIG5zLmNhdGFsb2cgYW5kIG5vdCBucy5jYXRhbG9nLmlzX2Fic29sdXRlKCk6CiAgICAgICAgbnMuY2F0YWxvZyA9IChQYXRoLmN3ZCgpIC8gbnMuY2F0YWxvZykucmVzb2x2ZSgpCgogICAgY29uZmlndXJlX2xvZ2dlcihucykKCiAgICBpZiBub3QgbnMuYXJjaDoKICAgICAgICBmcm9tIC5zdXBwb3J0LmFyY2ggaW1wb3J0IGNhbGN1bGF0ZV9mcm9tX2J1aWxkX2RpcgogICAgICAgIG5zLmFyY2ggPSBjYWxjdWxhdGVfZnJvbV9idWlsZF9kaXIobnMuYnVpbGQpCgogICAgZXhwZWN0ID0gZiJ7VkVSX01BSk9SfS57VkVSX01JTk9SfS57VkVSX01JQ1JPfXtWRVJfU1VGRklYfSIKICAgIGFjdHVhbCA9IGNoZWNrX3BhdGNobGV2ZWxfdmVyc2lvbihucy5zb3VyY2UpCiAgICBpZiBhY3R1YWwgYW5kIGFjdHVhbCAhPSBleHBlY3Q6CiAgICAgICAgbG9nX2Vycm9yKGYiSW5mZXJyZWQgdmVyc2lvbiB7ZXhwZWN0fSBkb2VzIG5vdCBtYXRjaCB7YWN0dWFsfSBmcm9tIHBhdGNobGV2ZWwuaC4gIgogICAgICAgICAgICAgICAgICAgIllvdSBzaG91bGQgc2V0ICVQWVRIT05JTkNMVURFJSBvciAlUFlUSE9OX0hFWFZFUlNJT04lIGJlZm9yZSBsYXVuY2hpbmcuIikKICAgICAgICByZXR1cm4gNQoKICAgIGxvZ19pbmZvKAogICAgICAgICIiIk9QVElPTlMKU291cmNlOiB7bnMuc291cmNlfQpCdWlsZDogIHtucy5idWlsZH0KVGVtcDogICB7bnMudGVtcH0KQXJjaDogICB7bnMuYXJjaH0KCkNvcHkgdG86IHtucy5jb3B5fQpaaXAgdG86ICB7bnMuemlwfQpDYXRhbG9nOiB7bnMuY2F0YWxvZ30iIiIsCiAgICAgICAgbnM9bnMsCiAgICApCgogICAgaWYgbnMuYXJjaCBub3QgaW4gKCJ3aW4zMiIsICJhbWQ2NCIsICJhcm0zMiIsICJhcm02NCIpOgogICAgICAgIGxvZ19lcnJvcigiLS1hcmNoIGlzIG5vdCBhIHZhbGlkIHZhbHVlICh3aW4zMiwgYW1kNjQsIGFybTMyLCBhcm02NCkiKQogICAgICAgIHJldHVybiA0CiAgICBpZiBucy5hcmNoID09ICJhcm0zMiI6CiAgICAgICAgZm9yIG4gaW4gKCJpbmNsdWRlX2lkbGUiLCAiaW5jbHVkZV90Y2x0ayIpOgogICAgICAgICAgICBpZiBnZXRhdHRyKG5zLCBuKToKICAgICAgICAgICAgICAgIGxvZ193YXJuaW5nKGYiRGlzYWJsaW5nIC0te24ucmVwbGFjZSgnXycsICctJyl9IG9uIHVuc3VwcG9ydGVkIHBsYXRmb3JtIikKICAgICAgICAgICAgICAgIHNldGF0dHIobnMsIG4sIEZhbHNlKQoKICAgIGlmIG5zLmluY2x1ZGVfaWRsZSBhbmQgbm90IG5zLmluY2x1ZGVfdGNsdGs6CiAgICAgICAgbG9nX3dhcm5pbmcoIkFzc3VtaW5nIC0taW5jbHVkZS10Y2x0ayB0byBzdXBwb3J0IC0taW5jbHVkZS1pZGxlIikKICAgICAgICBucy5pbmNsdWRlX3RjbHRrID0gVHJ1ZQoKICAgIGlmIG5vdCAobnMuaW5jbHVkZV9hbGlhcyBvciBucy5pbmNsdWRlX2FsaWFzMyBvciBucy5pbmNsdWRlX2FsaWFzM3gpOgogICAgICAgIGlmIG5zLmluY2x1ZGVfZnJlZXRocmVhZGVkOgogYiBmb3IgYSwgYiBpbiB6aXAoc2VsZi5kYXRhLCBzZWxmLl9fY2FzdChvdGhlcikpXSkKCiAgICBkZWYgX19jYXN0KHNlbGYsIG90aGVyKToKICAgICAgICBpZiBpc2luc3RhbmNlKG90aGVyLCBWZWN0b3IpOgogICAgICAgICAgICBvdGhlciA9IG90aGVyLmRhdGEKICAgICAgICBpZiBsZW4oc2VsZi5kYXRhKSAhPSBsZW4ob3RoZXIpOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJDYW5ub3QgY29tcGFyZSB2ZWN0b3JzIG9mIGRpZmZlcmVudCBsZW5ndGgiKQogICAgICAgIHJldHVybiBvdGhlcgoKb3BtYXAgPSB7CiAgICAibHQiOiAobGFtYmRhIGEsYjogYTwgYiwgb3BlcmF0b3IubHQsIG9wZXJhdG9yLl9fbHRfXyksCiAgICAibGUiOiAobGFtYmRhIGEsYjogYTw9Yiwgb3BlcmF0b3IubGUsIG9wZXJhdG9yLl9fbGVfXyksCiAgICAiZXEiOiAobGFtYmRhIGEsYjogYT09Yiwgb3BlcmF0b3IuZXEsIG9wZXJhdG9yLl9fZXFfXyksCiAgICAibmUiOiAobGFtYmRhIGEsYjogYSE9Yiwgb3BlcmF0b3IubmUsIG9wZXJhdG9yLl9fbmVfXyksCiAgICAiZ3QiOiAobGFtYmRhIGEsYjogYT4gYiwgb3BlcmF0b3IuZ3QsIG9wZXJhdG9yLl9fZ3RfXyksCiAgICAiZ2UiOiAobGFtYmRhIGEsYjogYT49Yiwgb3BlcmF0b3IuZ2UsIG9wZXJhdG9yLl9fZ2VfXykKfQoKY2xhc3MgVmVjdG9yVGVzdCh1bml0dGVzdC5UZXN0Q2FzZSk6CgogICAgZGVmIGNoZWNrZmFpbChzZWxmLCBlcnJvciwgb3BuYW1lLCAqYXJncyk6CiAgICAgICAgZm9yIG9wIGluIG9wbWFwW29wbmFtZV06CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKGVycm9yLCBvcCwgKmFyZ3MpCgogICAgZGVmIGNoZWNrZXF1YWwoc2VsZiwgb3BuYW1lLCBhLCBiLCBleHByZXMpOgogICAgICAgIGZvciBvcCBpbiBvcG1hcFtvcG5hbWVdOgogICAgICAgICAgICByZWFscmVzID0gb3AoYSwgYikKICAgICAgICAgICAgIyBjYW4ndCB1c2UgYXNzZXJ0RXF1YWwocmVhbHJlcywgZXhwcmVzKSBoZXJlCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwobGVuKHJlYWxyZXMpLCBsZW4oZXhwcmVzKSkKICAgICAgICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKHJlYWxyZXMpKToKICAgICAgICAgICAgICAgICMgcmVzdWx0cyBhcmUgYm9vbCwgc28gd2UgY2FuIHVzZSAiaXMiIGhlcmUKICAgICAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShyZWFscmVzW2ldIGlzIGV4cHJlc1tpXSkKCiAgICBkZWYgdGVzdF9taXhlZChzZWxmKToKICAgICAgICAjIGNoZWNrIHRoYXQgY29tcGFyaXNvbnMgaW52b2x2aW5nIFZlY3RvciBvYmplY3RzCiAgICAgICAgIyB3aGljaCByZXR1cm4gcmljaCByZXN1bHRzIChpLmUuIFZlY3RvcnMgd2l0aCBpdGVtd2lzZQogICAgICAgICMgY29tcGFyaXNvbiByZXN1bHRzKSB3b3JrCiAgICAgICAgYSA9IFZlY3RvcihyYW5nZSgyKSkKICAgICAgICBiID0gVmVjdG9yKHJhbmdlKDMpKQogICAgICAgICMgYWxsIGNvbXBhcmlzb25zIHNob3VsZCBmYWlsIGZvdGF0aWNmaWxlc190ZXN0cy5hcHBzLm5vX2xhYmVsIiwKICAgIF0sCiAgICAjIEluIHBhcnRpY3VsYXIsIEF1dGhlbnRpY2F0aW9uTWlkZGxld2FyZSBjYW4ndCBiZSB1c2VkIGJlY2F1c2UKICAgICMgY29udHJpYi5hdXRoIGlzbid0IGluIElOU1RBTExFRF9BUFBTLgogICAgIk1JRERMRVdBUkUiOiBbXSwKfQoiIiIKVGhlIE9HUkdlb21ldHJ5IGlzIGEgd3JhcHBlciBmb3IgdXNpbmcgdGhlIE9HUiBHZW9tZXRyeSBjbGFzcwooc2VlIGh0dHBzOi8vZ2RhbC5vcmcvYXBpL29ncmdlb21ldHJ5X2NwcC5odG1sI19DUFB2NDExT0dSR2VvbWV0cnkpLgpPR1JHZW9tZXRyeSBtYXkgYmUgaW5zdGFudGlhdGVkIHdoZW4gcmVhZGluZyBnZW9tZXRyaWVzIGZyb20gT0dSIERhdGEgU291cmNlcwooZS5nLiBTSFAgZmlsZXMpLCBvciB3aGVuIGdpdmVuIE9HQyBXS1QgKGEgc3RyaW5nKS4KCldoaWxlIHRoZSAnZnVsbCcgQVBJIGlzIG5vdCBwcmVzZW50IHlldCwgdGhlIEFQSSBpcyAicHl0aG9uaWMiIHVubGlrZQp0aGUgdHJhZGl0aW9uYWwgYW5kICJuZXh0LWdlbmVyYXRpb24iIE9HUiBQeXRob24gYmluZGluZ3MuIE9uZSBtYWpvcgphZHZhbnRhZ2UgT0dSIEdlb21ldHJpZXMgaGF2ZSBvdmVyIHRoZWlyIEdFT1MgY291bnRlcnBhcnRzIGlzIHN1cHBvcnQKZm9yIHNwYXRpYWwgcmVmZXJlbmNlIHN5c3RlbXMgYW5kIHRoZWlyIHRyYW5zZm9ybWF0aW9uLgoKRXhhbXBsZToKID4+PiBmcm9tIGRqYW5nby5jb250cmliLmdpcy5nZGFsIGltcG9ydCAoCiAuLi4gICAgIE9HUkdlb21ldHJ5LCBPR1JHZW9tVHlwZSwgU3BhdGlhbFJlZmVyZW5jZQogLi4uICkKID4+PiB3a3QxLCB3a3QyID0gJ1BPSU5UKC05MCAzMCknLCAnUE9MWUdPTigoMCAwLCA1IDAsIDUgNSwgMCA1KScKID4+PiBwbnQgPSBPR1JHZW9tZXRyeSh3a3QxKQogPj4+IHByaW50KHBudCkKIFBPSU5UICgtOTAgMzApCiA+Pj4gbXBudCA9IE9HUkdlb21ldHJ5KE9HUkdlb21UeXBlKCdNdWx0aVBvaW50JyksIFNwYXRpYWxSZWZlcmVuY2UoJ1dHUzg0JykpCiA+Pj4gbXBudC5hZGQod2t0MSkKID4+PiBtcG50LmFkZCh3a3QxKQogPj4+IHByaW50KG1wbnQpCiBNVUxUSVBPSU5UICgtOTAgMzAsLTkwIDMwKQogPj4+IHByaW50KG1wbnQuc3JzLm5hbWUpCiBXR1MgODQKID4+PiBwcmludChtcG50LnNycy5wcm9qKQogK3Byb2o9bG9uZ2xhdCArZWxscHM9V0dTODQgK2RhdHVtPVdHUzg0ICtub19kZWZzCiA+Pj4gbXBudC50cmFuc2Zvcm0oU3BhdGlhbFJlZmVyZW5jZSgnTkFEMjcnKSkKID4+PiBwcmludChtcG50LnByb2opCiArcHJvaj1sb25nbGF0ICtlbGxwcz1jbHJrNjYgK2RhdHVtPU5BRDI3ICtub19kZWZzCiA+Pj4gcHJpbnQobXBudCkKIE1VTFRJUE9JTlQgKC04OS45OTk5MzAzNzg2MDI0OCAyOS45OTk3OTc4ODY1NTc2NCwtODkuOTk5OTMwMzc4NjAyNDgKIDI5Ljk5OTc5Nzg4NjU1NzY0KQoKIFRoZSBPR1JHZW9tVHlwZSBjbGFzcyBpcyB0byBtYWtlIGl0IGVhc3kgdG8gc3BlcXVhbChULl9fbmFtZV9fLCAiVCIpCiAgICAgICAgZ2V0dGVyLCBpbm5lciA9IG91dGVyKCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGdldHRlcigpLCAib3V0ZXIiKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoaW5uZXIoKSwgImlubmVyIikKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGdldHRlcigpLCAiaW5uZXIiKQoKICAgIGRlZiB0ZXN0X3JlZmVyZW5jZV9wcmV2aW91c190eXBldmFyKHNlbGYpOgogICAgICAgIGRlZiBmdW5jW1MsIFQ6IFNlcXVlbmNlW1NdXSgpOgogICAgICAgICAgICBwYXNzCgogICAgICAgIFMsIFQgPSBmdW5jLl9fdHlwZV9wYXJhbXNfXwogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoVC5fX2JvdW5kX18sIFNlcXVlbmNlW1NdKQoKICAgIGRlZiB0ZXN0X3N1cGVyKHNlbGYpOgogICAgICAgIGNsYXNzIEJhc2U6CiAgICAgICAgICAgIGRlZiBtZXRoKHNlbGYpOgogICAgICAgICAgICAgICAgcmV0dXJuICJiYXNlIgoKICAgICAgICBjbGFzcyBDaGlsZChCYXNlKToKICAgICAgICAgICAgIyBIYXZpbmcgaW50IGluIHRoZSBhbm5vdGF0aW9uIGVuc3VyZXMgdGhlIGNsYXNzIGdldHMgY2VsbHMgZm9yIGJvdGgKICAgICAgICAgICAgIyBfX2NsYXNzX18gYW5kIF9fY2xhc3NkaWN0X18KICAgICAgICAgICAgZGVmIG1ldGhbVF0oc2VsZiwgYXJnOiBpbnQpIC0+IFQ6CiAgICAgICAgICAgICAgICByZXR1cm4gc3VwZXIoKS5tZXRoKCkgKyAiY2hpbGQiCgogICAgICAgIGMgPSBDaGlsZCgpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjLm1ldGgoMSksICJiYXNlY2hpbGQiKQoKICAgIGRlZiB0ZXN0X3R5cGVfYWxpYXNfY29udGFpbmluZ19sYW1iZGEoc2VsZik6CiAgICAgICAgdHlwZSBBbGlhc1tUXSA9IGxhbWJkYTogVAogICAgICAgIFQsID0gQWxpYXMuX190eXBlX3BhcmFtc19fCiAgICAgICAgc2VsZi5hc3NlcnRJcyhBbGlhcy5fX3ZhbHVlX18oKSwgVCkKCiAgICBkZWYgdGVzdF9jbGFzc19iYXNlX2NvbnRhaW5pbmdfbGFtYmRhKHNlbGYpOgogICAgICAgICMgVGVzdCB0aGF0IHNjb3BlcyBuZXN0ZWQgaW5zaWRlIGhpZGRlbiBmdW5jdGlvbnMgd29yayBjb3JyZWN0bHkKICAgICAgICBvdXRlcl92YXIgPSAib3V0ZXIiCiAgICAgICAgY2xhc3MgQmFzZVtUXTogLi4uCiAgICAgICAgY2xhc3MgQ2hpbGRbVF0oQmFzZVtsYW1iZGE6IChpbnQsIG91dGVyX3ZhciwgVCldKTogLi4uCiAgICAgICAgYmFzZSwgXyA9IHR5cGVzLmdldF9vcmlnaW5hbF9iYXNlcyhDaGlsZCkKICAgICAgICBmdW5jLCA9IGdldF9hcmdzKGJhc2UpCiAgICAgICAgVCwgPSBDaGlsZC5fX3R5cGVfcGFyYW1zX18KICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGZ1bmMoKSwgKGludCwgIm91dGVyIiwgVCkpCgogICAgZGVmIHRlc3RfY29tcHJlaGVuc2lvbl8wMShzZWxmKToKICAgICAgICB0eXBlIEFsaWFzW1Q6IChbVCBmb3IgVCBpbiAoVCwgWzFdKVsxXV0sIFQpXSA9IFtUIGZvciBUIGluIFQuX19uYW1lX19dCiAgIGVyID0gRXhjZXB0aW9uUmVwb3J0ZXIoTm9uZSwgY20uZXhjZXB0aW9uLl9fY2xhc3NfXywgY20uZXhjZXB0aW9uLCBOb25lKQogICAgICAgIHRyYWNlYmFja19kYXRhID0gcmVwb3J0ZXIuZ2V0X3RyYWNlYmFja19kYXRhKCkKCiAgICAgICAgZXhjZXB0aW9uX3ZhbHVlID0gc3RyKHRyYWNlYmFja19kYXRhLmdldCgiZXhjZXB0aW9uX3ZhbHVlIiwgIiIpKQogICAgICAgIHNlbGYuYXNzZXJ0SW4oIkludmFsaWQgYmxvY2sgdGFnIiwgZXhjZXB0aW9uX3ZhbHVlKQogICAgICAgIHNlbGYuYXNzZXJ0SW4oIidlbmRwYXJ0aWFsZGVmIG91dGVyJyIsIHN0cihjbS5leGNlcHRpb24pKQoiIiJNYW5hZ2Ugc2hlbHZlcyBvZiBwaWNrbGVkIG9iamVjdHMuCgpBICJzaGVsZiIgaXMgYSBwZXJzaXN0ZW50LCBkaWN0aW9uYXJ5LWxpa2Ugb2JqZWN0LiAgVGhlIGRpZmZlcmVuY2UKd2l0aCBkYm0gZGF0YWJhc2VzIGlzIHRoYXQgdGhlIHZhbHVlcyAobm90IHRoZSBrZXlzISkgaW4gYSBzaGVsZiBjYW4KYmUgZXNzZW50aWFsbHkgYXJiaXRyYXJ5IFB5dGhvbiBvYmplY3RzIC0tIGFueXRoaW5nIHRoYXQgdGhlICJwaWNrbGUiCm1vZHVsZSBjYW4gaGFuZGxlLiAgVGhpcyBpbmNsdWRlcyBtb3N0IGNsYXNzIGluc3RhbmNlcywgcmVjdXJzaXZlIGRhdGEKdHlwZXMsIGFuZCBvYmplY3RzIGNvbnRhaW5pbmcgbG90cyBvZiBzaGFyZWQgc3ViLW9iamVjdHMuICBUaGUga2V5cwphcmUgb3JkaW5hcnkgc3RyaW5ncy4KClRvIHN1bW1hcml6ZSB0aGUgaW50ZXJmYWNlIChrZXkgaXMgYSBzdHJpbmcsIGRhdGEgaXMgYW4gYXJiaXRyYXJ5Cm9iamVjdCk6CgogICAgICAgIGltcG9ydCBzaGVsdmUKICAgICAgICBkID0gc2hlbHZlLm9wZW4oZmlsZW5hbWUpICMgb3Blbiwgd2l0aCAoZylkYm0gZmlsZW5hbWUgLS0gbm8gc3VmZml4CgogICAgICAgIGRba2V5XSA9IGRhdGEgICAjIHN0b3JlIGRhdGEgYXQga2V5IChvdmVyd3JpdGVzIG9sZCBkYXRhIGlmCiAgICAgICAgICAgICAgICAgICAgICAgICMgdXNpbmcgYW4gZXhpc3Rpbmcga2V5KQogICAgICAgIGRhdGEgPSBkW2tleV0gICAjIHJldHJpZXZlIGEgQ09QWSBvZiB0aGUgZGF0YSBhdCBrZXkgKHJhaXNlCiAgICAgICAgICAgICAgICAgICAgICAgICMgS2V5RXJyb3IgaWYgbm8gc3VjaCBrZXkpIC0tIE5PVEUgdGhhdCB0aGlzCiAgICAgICAgICAgICAgICAgICAgICAgICMgYWNjZXNzIHJldHVybnMgYSAqY29weSogb2YgdGhlIGVudHJ5IQogICAgICAgIGRlbCBkW2tleV0gICAgICAjIGRlbGV0ZSBkYXRhIHN0b3JlZCBhdCBrZXkgKHJhaXNlcyBLZXlFcnJvcgogICAgICAgICAgICAgICAgICAgICAgICAjIGlmIG5vIHN1Y2gga2V5KQogICAgICAgIGZsYWcgPSBrZXkgaW4gZCAjIHRydWUgaWYgdGhlIGtleSBleGlzdHMKICAgICAgICBsaXN0ID0gZC5rZXlzKCkgIyBhIGxpc3Qgb2YgYWxsIGV4aXN0aW5nIGtleXMgKHNsb3chKQoKICAgICAgICBkLmNsb3NlKCkgICAgICAgIyBjbG9zZSBpdAoKRGVwZW5kdHV0aWxzRXJyb3IpOgogICAgIiIiV2UgZG9uJ3Qga25vdyBob3cgdG8gZG8gc29tZXRoaW5nIG9uIHRoZSBjdXJyZW50IHBsYXRmb3JtIChidXQKICAgIHdlIGRvIGtub3cgaG93IHRvIGRvIGl0IG9uIHNvbWUgcGxhdGZvcm0pIC0tIGVnLiB0cnlpbmcgdG8gY29tcGlsZQogICAgQyBmaWxlcyBvbiBhIHBsYXRmb3JtIG5vdCBzdXBwb3J0ZWQgYnkgYSBDQ29tcGlsZXIgc3ViY2xhc3MuIiIiCiAgICBwYXNzCgpjbGFzcyBEaXN0dXRpbHNFeGVjRXJyb3IgKERpc3R1dGlsc0Vycm9yKToKICAgICIiIkFueSBwcm9ibGVtcyBleGVjdXRpbmcgYW4gZXh0ZXJuYWwgcHJvZ3JhbSAoc3VjaCBhcyB0aGUgQwogICAgY29tcGlsZXIsIHdoZW4gY29tcGlsaW5nIEMgZmlsZXMpLiIiIgogICAgcGFzcwoKIyBFeGNlcHRpb24gY2xhc3NlcyB1c2VkIGJ5IHRoZSBDQ29tcGlsZXIgaW1wbGVtZW50YXRpb24gY2xhc3NlcwpjbGFzcyBDQ29tcGlsZXJFcnJvciAoRXhjZXB0aW9uKToKICAgICIiIlNvbWUgY29tcGlsZS9saW5rIG9wZXJhdGlvbiBmYWlsZWQuIiIiCgpjbGFzcyBQcmVwcm9jZXNzRXJyb3IgKENDb21waWxlckVycm9yKToKICAgICIiIkZhaWx1cmUgdG8gcHJlcHJvY2VzcyBvbmUgb3IgbW9yZSBDL0MrKyBmaWxlcy4iIiIKCmNsYXNzIENvbXBpbGVFcnJvciAoQ0NvbXBpbGVyRXJyb3IpOgogICAgIiIiRmFpbHVyZSB0byBjb21waWxlIG9uZSBvciBtb3JlIEMvQysrIHNvdXJjZSBmaWxlcy4iIiIKCmNsYXNzIFVua25vd25GaWxlRXJyb3IgKENDb21waWxlckVycm9yKToKICAgICIiIkF0dGVtcHQgdG8gcHJvY2VzcyBhbiB1bmtub3duIGZpbGUgdHlwZS4iIiIKIyBDb250YWlucyBjb2RlIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL01hZ2ljU3RhY2svdXZsb29wL3RyZWUvdjAuMTYuMAojIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBQU0YtMi4wIEFORCAoTUlUIE9SIEFwYWNoZS0yLjApCiMgU1BEWC1GaWxlQ29weXJpZ2h0VGV4dDogQ29weXJpZ2h0IChjKSAyMDE1LTIwMjEgTWFnaWNTdGFjayBJbmMuICBodHRwOi8vbWFnaWMuaW8KCmltcG9ydCBhc3luY2lvCmltcG9ydCBjb250ZXh0bGliCmltcG9ydCBnYwppbXBvcnQgbG9nZ2luZwppbXBvcnQgc2VsZWN0CmltcG9ydCBzb2NrZXQKaW1wb3J0IHN5cwppbXBvcnQgdGVtcGZpbGUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgdGltZQppbXBvcnQgdW5pdHRlc3QubW9jawppbXBvcnQgd2Vha3JlZgppbXBvcnQgdW5pdHRlc3QKCnRyeToKICAgIGltcG9ydCBzc2wKZXhjZXB0IEltcG9ydEVycm9yOgogICAgc3NsID0gTm9uZQoKZnJvbSB0ZXN0IGltcG9ydCBzdXBwb3J0CmZyb20gdGVzdC50ZXN0X2FzeW5jaW8gaW1wb3J0IHV0aWxzIGFzIHRlc3RfdXRpbHMKCgpNQUNPUyA9IChzeXMucGxhdGZvcm0gPT0gJ2RhcndpbicpCkJVRl9NVUxUSVBMSUVSID0gMTAyNCBpZiBub3QgTUFDT1MgZWxzZSA2NApIQU5EU0hBS0VfVElNRU9VVCA9IHN1cHBvcnQuTE9OR19USU1FT1VUCgoKZGVjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICBzZWxmLnNraXBUZXN0KCJUZXN0IHJlcXVpcmVzIG11bHRpcHJvY2Vzc2luZyIpCiAgICAgICAgZnJvbSB0aHJlYWRpbmcgaW1wb3J0IFRocmVhZCwgRXZlbnQKCiAgICAgICAgc3RhcnQgPSBFdmVudCgpCiAgICAgICAgd2l0aCBTaGFyZWRNZW1vcnlNYW5hZ2VyKCkgYXMgc21tOgogICAgICAgICAgICBvYmogPSBzbW0uU2hhcmVhYmxlTGlzdChyYW5nZSgxMDApKQogICAgICAgICAgICBkZWYgdGVzdCgpOgogICAgICAgICAgICAgICAgIyBJc3N1ZSBnaC0xMjcwODUsIHRoZSBgU2hhcmVhYmxlTGlzdC5jb3VudGAgaXMganVzdCBhCiAgICAgICAgICAgICAgICAjIGNvbnZlbmllbnQgd2F5IHRvIG1lc3MgdGhlIGBleHBvcnRzYCBjb3VudGVyIG9mIGBtZW1vcnl2aWV3YCwKICAgICAgICAgICAgICAgICMgdGhpcyBpc3N1ZSBoYXMgbm8gZGlyZWN0IHJlbGF0aW9uIHdpdGggYFNoYXJlYWJsZUxpc3RgLgogICAgICAgICAgICAgICAgc3RhcnQud2FpdChzdXBwb3J0LlNIT1JUX1RJTUVPVVQpCiAgICAgICAgICAgICAgICBmb3IgaSBpbiByYW5nZSgxMCk6CiAgICAgICAgICAgICAgICAgICAgb2JqLmNvdW50KDEpCiAgICAgICAgICAgIHRocmVhZHMgPSBbVGhyZWFkKHRhcmdldD10ZXN0KSBmb3IgXyBpbiByYW5nZSgxMCldCiAgICAgICAgICAgIHdpdGggdGhyZWFkaW5nX2hlbHBlci5zdGFydF90aHJlYWRzKHRocmVhZHMpOgogICAgICAgICAgICAgICAgc3RhcnQuc2V0KCkKCiAgICAgICAgICAgIGRlbCBvYmoKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgdW5pdHRlc3QubWFpbigpCiMhIC91c3IvYmluL2VudiBweXRob24zCiMgU2NyaXB0IGZvciBwcmVwYXJpbmcgT3BlblNTTCBmb3IgYnVpbGRpbmcgb24gV2luZG93cy4KIyBVc2VzIFBlcmwgdG8gY3JlYXRlIG5tYWtlIG1ha2VmaWxlcyBhbmQgb3RoZXJ3aXNlIHByZXBhcmUgdGhlIHdheQojIGZvciBidWlsZGluZyBvbiAzMiBvciA2NCBiaXQgcGxhdGZvcm1zLgoKIyBTY3JpcHQgb3JpZ2luYWxseSBhdXRob3JlZCBieSBNYXJrIEhhbW1vbmQuCiMgTWFqb3IgcmV2aXNpb25zIGJ5OgojICAgTWFydGluIHYuIEzDtndpcwojICAgQ2hyaXN0aWFuIEhlaW1lcwojICAgWmFjaGFyeSBXYXJlCgojIFRIRU9SRVRJQ0FMTFksIHlvdSBjYW46CiMgKiBVbnBhY2sgdGhlIGxhdGVzdCBPcGVuU1NMIHJlbGVhc2Ugd2hlcmUgJChvcGVuc3NsRGlyKSBpbgojICAgUENidWlsZFxweXByb2plY3QucHJvcHMgZXhwZWN0cyBpdCB0byBiZS4KIyAqIEluc3RhbGwgQWN0aXZlUGVybCBhbmQgZW5zdXJlIGl0IGlzIHNvbWV3aGVyZSBvbiB5b3VyIHBhdGguCiMgKiBSdW4gdGhpcyBzY3JpcHQgd2l0aCB0aGUgT3BlblNTTCBzb3VyY2UgZGlyIGFzIHRoZSBvbmx5IGFyZ3VtZW50LgojCiMgaXQgc2hvdWxkIGNvbmZpZ3VyZSBPcGVuU1NMIHN1Y2ggdGhhdCBpdCBpcyByZWFkeSB0byBiZSBidWlsdCBieQojIHNzbC52Y3hwcm9qIG9yc29yKGZhY3Rvcnk9U1FMaXRlQ3Vyc29yV3JhcHBlcikKCiAgICBAYXN5bmNfdW5zYWZlCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgc2VsZi52YWxpZGF0ZV90aHJlYWRfc2hhcmluZygpCiAgICAgICAgIyBJZiBkYXRhYmFzZSBpcyBpbiBtZW1vcnksIGNsb3NpbmcgdGhlIGNvbm5lY3Rpb24gZGVzdHJveXMgdGhlCiAgICAgICAgIyBkYXRhYmFzZS4gVG8gcHJldmVudCBhY2NpZGVudGFsIGRhdGEgbG9zcywgaWdub3JlIGNsb3NlIHJlcXVlc3RzIG9uCiAgICAgICAgIyBhbiBpbi1tZW1vcnkgZGIuCiAgICAgICAgaWYgbm90IHNlbGYuaXNfaW5fbWVtb3J5X2RiKCk6CiAgICAgICAgICAgIEJhc2VEYXRhYmFzZVdyYXBwZXIuY2xvc2Uoc2VsZikKCiAgICBkZWYgX3NhdmVwb2ludF9hbGxvd2VkKHNlbGYpOgogICAgICAgICMgV2hlbiAnaXNvbGF0aW9uX2xldmVsJyBpcyBub3QgTm9uZSwgc3FsaXRlMyBjb21taXRzIGJlZm9yZSBlYWNoCiAgICAgICAgIyBzYXZlcG9pbnQ7IGl0J3MgYSBidWcuIFdoZW4gaXQgaXMgTm9uZSwgc2F2ZXBvaW50cyBkb24ndCBtYWtlIHNlbnNlCiAgICAgICAgIyBiZWNhdXNlIGF1dG9jb21taXQgaXMgZW5hYmxlZC4gVGhlIG9ubHkgZXhjZXB0aW9uIGlzIGluc2lkZSAnYXRvbWljJwogICAgICAgICMgYmxvY2tzLiBUbyB3b3JrIGFyb3VuZCB0aGF0IGJ1Zywgb24gU1FMaXRlLCAnYXRvbWljJyBzdGFydHMgYQogICAgICAgICMgdHJhbnNhY3Rpb24gZXhwbGljaXRseSByYXRoZXIgdGhhbiBzaW1wbHkgZGlzYWJsZSBhdXRvY29tbWl0LgogICAgICAgIHJldHVybiBzZWxmLmluX2F0b21pY19ibG9jawoKICAgIGRlZiBfc2V0X2F1dG9jb21taXQoc2VsZiwgYXV0b2NvbW1pdCk6CiAgICAgICAgaWYgYXV0b2NvbW1pdDoKICAgICAgICAgICAgbGV2ZWwgPSBOb25lCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBzcWxpdGUzJ3MgaW50ZXJuYWwgZGVmYXVsdCBpcyAnJy4gSXQncyBkaWZmZXJlbnQgZnJvbSBOb25lLgogICAgICAgICAgICAjIFNlZSBNb2R1bGVzL19zcWxpdGUvY29ubmVjdGlvbi5jLgogICAgICAgICAgICBsZXZlbCA9ICIiCiAgICAgICAgIyAnaXNvbGF0aW9uX2xldmVsJyBpcyBhIG1pc2xlYWRpbmcgQVBJLgogICAgICAgICMgU1FMaXRlIGFsd2F5cyBydW5zIGF0IHRoZSBTRVJJQUxJWkFCTEUgaXNvbGF0aW9uIGxldmVsLgogICAgICAgIHdpdGggc2VsZi53cmFwX2RhdGFiYXNlX2Vycm9yczoKICAgICAgICAgICAgc2VsZi5jb25uZWN0aW9uLmlzb2xhdGlvbl9sZXZlbCA9IGxldmVsCgogICAgZGVmIGRpc2FibGVfY29uc3RyYWludF9jaGVja2luZyhzZWxmKToKICAgICAgICB3aXRoIHNlbGYuY3Vyc29yKCkgYXMgY3Vyc29yOgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiUFJBR01BIGZvcmVpZ25fa2V5cyA9IE9GRiIpCiAgICAgICAgICAgICMgRm9yZWlnbiBrZXkgY29uc3RyYWludHMgY2Fubm90IGJlIHR1cm5lZCBvZmYgd2hpbGUgaW4gYSBtdWx0aS0KICB1cm4gX2NyZWF0ZV9jYXJlZnVsbHkocGF0aCkKICAgICAgICAgICAgZXhjZXB0IEZpbGVFeGlzdHNFcnJvcjoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgIyBGYWxsIHRocm91Z2ggdG8gaGVyZSBpZiBzdGF0IHN1Y2NlZWRlZCBvciBvcGVuIHJhaXNlZCBFRVhJU1QuCiAgICAgICAgcmFpc2UgRXh0ZXJuYWxDbGFzaEVycm9yKCdOYW1lIGNsYXNoIHByZXZlbnRlZCBmaWxlIGNyZWF0aW9uOiAlcycgJQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoKQoKICAgIGRlZiBfcmVmcmVzaChzZWxmKToKICAgICAgICAiIiJVcGRhdGUgdGFibGUgb2YgY29udGVudHMgbWFwcGluZy4iIiIKICAgICAgICAjIElmIGl0IGhhcyBiZWVuIGxlc3MgdGhhbiB0d28gc2Vjb25kcyBzaW5jZSB0aGUgbGFzdCBfcmVmcmVzaCgpIGNhbGwsCiAgICAgICAgIyB3ZSBoYXZlIHRvIHVuY29uZGl0aW9uYWxseSByZS1yZWFkIHRoZSBtYWlsYm94IGp1c3QgaW4gY2FzZSBpdCBoYXMKICAgICAgICAjIGJlZW4gbW9kaWZpZWQsIGJlY2F1c2Ugb3MucGF0aC5tdGltZSgpIGhhcyBhIDIgc2VjIHJlc29sdXRpb24gaW4gdGhlCiAgICAgICAgIyBtb3N0IGNvbW1vbiB3b3JzdCBjYXNlIChGQVQpIGFuZCBhIDEgc2VjIHJlc29sdXRpb24gdHlwaWNhbGx5LiAgVGhpcwogICAgICAgICMgcmVzdWx0cyBpbiBhIGZldyB1bm5lY2Vzc2FyeSByZS1yZWFkcyB3aGVuIF9yZWZyZXNoKCkgaXMgY2FsbGVkCiAgICAgICAgIyBtdWx0aXBsZSB0aW1lcyBpbiB0aGF0IGludGVydmFsLCBidXQgb25jZSB0aGUgY2xvY2sgdGlja3Mgb3Zlciwgd2UKICAgICAgICAjIHdpbGwgb25seSByZS1yZWFkIGFzIG5lZWRlZC4gIEJlY2F1c2UgdGhlIGZpbGVzeXN0ZW0gbWlnaHQgYmUgYmVpbmcKICAgICAgICAjIHNlcnZlZCBieSBhbiBpbmRlcGVuZGVudCBzeXN0ZW0gd2l0aCBpdHMgb3duIGNsb2NrLCB3ZSByZWNvcmQgYW5kCiAgICAgICAgIyBjb21wYXJlIHdpdGggdGhlIG10aW1lcyBmcm9tIHRoZSBmaWxlc3lzdGVtLiAgQmVjYXVzZSB0aGUgb3RoZXIKICAgICAgICAjIHN5c3RlbSdzIGNsb2NrIG1pZ2h0IGJlIHNrZXdpbmcgcmVsYXRpdmUgdG8gb3VyIGNsb2NrLCB3ZSBhZGQgYW4KICAgICAgICAjIGV4dHJhIGRlbHRhIHRvIG91ciB3YWl0LiAgVGhlIGRlZmF1bHQgaXMgb25lIHRlbnRoIHNlY29uZCwgYnV0IGlzIGFuCiAgICAgICAgIyBpbnN0YW5jZSB2YXJpYWJsZSBhbmQgc28gY2FuIGJlIGFkanVzdGVkIGlmIGRlYWxpbmcgd2l0aCBhCiAgICAgICAgIyBwYXJ0aWN1bGFybHkgc2tld2VkIG9yIGlycmVndWxhciBzeXN0ZW0uCiAgICAgICAgaWYgdGltZS50aW1lKCkgLSBzZWxmLl9sYXN0X3JlYWQgPiAyICsgc2VsZi5fc2tld2ZhY3RvcjoKICAgICAgICAgICAgcmVmcmVzaCA9IEZhbHNlCiAgICAgICAgICAgIGZvciBzdWJkaXIgaW4gc2VsZi5fdG9jX210aW1lczoKICAgICAgICAgICAgICAgIG10aW1lID0gb3MucGF0aC5nZXRtdGltZWggKyBhLnNwbGl0KG9zLnBhdGhzZXApCiAgICAgICAgaWYgbyA9PSAnLXEnOgogICAgICAgICAgICBkZWJ1ZyA9IDAKICAgICAgICBpZiBvID09ICcteCc6CiAgICAgICAgICAgIGV4Y2x1ZGUuYXBwZW5kKGEpCgogICAgIyBQcm92aWRlIGRlZmF1bHQgYXJndW1lbnRzCiAgICBpZiBub3QgYXJnczoKICAgICAgICBzY3JpcHQgPSAiaGVsbG8ucHkiCiAgICBlbHNlOgogICAgICAgIHNjcmlwdCA9IGFyZ3NbMF0KCiAgICAjIFNldCB0aGUgcGF0aCBiYXNlZCBvbiBzeXMucGF0aCBhbmQgdGhlIHNjcmlwdCBkaXJlY3RvcnkKICAgIHBhdGggPSBzeXMucGF0aFs6XQogICAgcGF0aFswXSA9IG9zLnBhdGguZGlybmFtZShzY3JpcHQpCiAgICBwYXRoID0gYWRkcGF0aCArIHBhdGgKICAgIGlmIGRlYnVnID4gMToKICAgICAgICBwcmludCgicGF0aDoiKQogICAgICAgIGZvciBpdGVtIGluIHBhdGg6CiAgICAgICAgICAgIHByaW50KCIgICAiLCByZXByKGl0ZW0pKQoKICAgICMgQ3JlYXRlIHRoZSBtb2R1bGUgZmluZGVyIGFuZCB0dXJuIGl0cyBjcmFuawogICAgbWYgPSBNb2R1bGVGaW5kZXIocGF0aCwgZGVidWcsIGV4Y2x1ZGUpCiAgICBmb3IgYXJnIGluIGFyZ3NbMTpdOgogICAgICAgIGlmIGFyZyA9PSAnLW0nOgogICAgICAgICAgICBkb21vZHMgPSAxCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgaWYgZG9tb2RzOgogICAgICAgICAgICBpZiBhcmdbLTI6XSA9PSAnLionOgogICAgICAgICAgICAgICAgbWYuaW1wb3J0X2hvb2soYXJnWzotMl0sIE5vbmUsIFsiKiJdKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbWYuaW1wb3J0X2hvb2soYXJnKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1mLmxvYWRfZmlsZShhcmcpCiAgICBtZi5ydW5fc2NyaXB0KHNjcmlwdCkKICAgIG1mLnJlcG9ydCgpCiAgICByZXR1cm4gbWYgICMgZm9yIC1pIGRlYnVnZ2luZwoKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICB0cnk6CiAgICAgICAgbWYgPSB0ZXN0KCkKICAgIGV4Y2VwdCBLZXlib2FyZEludGVycnVwdDoKICAgICAgICBwcmludCgiXG5baW50ZXJydXB0ZWRdIikKaW1wb3J0IGFzdAppbXBvcnQgZGlmZmxpYgppbXBvcnQgaW8KaW1wb3J0IHRleHR3cmFwCmltcG9ydCB1bml0dGVzdAoKZnJvbSB0ZXN0IGltcG9ydCB0ZXN0X3Rvb2xzCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnkKZnJvbSB0b2tlbml6ZSBpbXBvcnQgVG9rZW5JbmZvLCBOQU1FLCBORVdMSU5FLCBOVU1CRVIsIE9QCgp0ZXN0X3Rvb2xzLnNraXBfaWZfbWlzc2luZygicGVnX2dlbmVyYXRvciIpCndpdGggdGVzdF90b29scy5pbXBvcnRzX3VuZGVyX3Rvb2woInBlZ19nZW5lcmF0b3IiKToKICAgIGZyb20gcGVnZW4uZ3JhbW1hcl9wYXJzZXIgaW1wb3J0IEdlbmVyYXRlZFBhcnNlciBhcyBHcmFtbWFyUGFyc2VyCiAgICBmcm9tIHBlZ2VuLnRlc3R1dGlsIGltcG9ydCBwYXJzZV9zdHJpbmcsIGdlbmVyYXRlX3BhcnNlciwgbWFrZVJST1IgPSAwCl9QWV9TT1VSQ0UgPSAxCl9QWV9DT01QSUxFRCA9IDIKX0NfRVhURU5TSU9OID0gMwpfUEtHX0RJUkVDVE9SWSA9IDUKX0NfQlVJTFRJTiA9IDYKX1BZX0ZST1pFTiA9IDcKCiMgTW9kdWxlZmluZGVyIGRvZXMgYSBnb29kIGpvYiBhdCBzaW11bGF0aW5nIFB5dGhvbidzLCBidXQgaXQgY2FuIG5vdAojIGhhbmRsZSBfX3BhdGhfXyBtb2RpZmljYXRpb25zIHBhY2thZ2VzIG1ha2UgYXQgcnVudGltZS4gIFRoZXJlZm9yZSB0aGVyZQojIGlzIGEgbWVjaGFuaXNtIHdoZXJlYnkgeW91IGNhbiByZWdpc3RlciBleHRyYSBwYXRocyBpbiB0aGlzIG1hcCBmb3IgYQojIHBhY2thZ2UsIGFuZCBpdCB3aWxsIGJlIGhvbm9yZWQuCgojIE5vdGUgdGhpcyBpcyBhIG1hcHBpbmcgaXMgbGlzdHMgb2YgcGF0aHMuCnBhY2thZ2VQYXRoTWFwID0ge30KCiMgQSBQdWJsaWMgaW50ZXJmYWNlCmRlZiBBZGRQYWNrYWdlUGF0aChwYWNrYWdlbmFtZSwgcGF0aCk6CiAgICBwYWNrYWdlUGF0aE1hcC5zZXRkZWZhdWx0KHBhY2thZ2VuYW1lLCBbXSkuYXBwZW5kKHBhdGgpCgpyZXBsYWNlUGFja2FnZU1hcCA9IHt9CgojIFRoaXMgUmVwbGFjZVBhY2thZ2UgbWVjaGFuaXNtIGFsbG93cyBtb2R1bGVmaW5kZXIgdG8gd29yayBhcm91bmQKIyBzaXR1YXRpb25zIGluIHdoaWNoIGEgcGFja2FnZSBpbmplY3RzIGl0c2VsZiB1bmRlciB0aGUgbmFtZQojIG9mIGFub3RoZXIgcGFja2FnZSBpbnRvIHN5cy5tb2R1bGVzIGF0IHJ1bnRpbWUgYnkgY2FsbGluZwojIFJlcGxhY2VQYWNrYWdlKCJyZWFsX3BhY2thZ2VfbmFtZSIsICJmYWtlZF9wYWNrYWdlX25hbWUiKQojIGJlZm9yZSBydW5uaW5nIE1vZHVsZUZpbmRlci4KCmRlZiBSZXBsYWNlUGFja2FnZShvbGRuYW1lLCBuZXduYW1lKToKICAgIHJlcGxhY2VQYWNrYWdlTWFwW29sZG5hbWVdID0gbmV3bmFtZQoKCmRlZiBfZmluZF9tb2R1bGUobmFtZSwgcGF0aD1Ob25lKToKICAgICIiIkFuIGltcG9ydGxpYiByZWltcGxlbWVudGF0aW9uIG9mIGltcC5maW5kX21vZHVsZSAoZm9yIG91ciBwdXJwb3NlcykuIiIiCgogICAgIyBJdCdzIG5lY2Vzc2FyeSB0byBjbGVhciB0aGUgY2FjaGVzIGZvciBvdXIgRmluZGVyIGZpcnN0LCBpbiBjYXNlIGFueQogICAgIyBtb2R1bGVzIGFyZSBiZWluZyBhZGRlZC9kZWxldGVkL21vZGlmaWVkIGF0IHJ1bnRpbWUuIEluIHBhcnRpY3VsYXIsCiAgICAjIHRlc3RfbW9kdWxlZmluZGVyLnB5IGNoYW5nZXMgZmlsZSB0cmVlIGNvbnRlbnRzIGluIGEgY2FjaGUtYnJlYWtpbmcgd2F5OgoKICAgIGltcG9ydGxpYi5tYWNoaW5lcnkuUGF0aEZpbmRlci5pbnZhbGlkYXRlX2NhY2hlcygpCgogICAgc3BlYyA9IGltcG9ydGxpYi5tYWNoaW5lcnkuUGF0aEZpbmRlci5maW5kX3NwZWMobmFtZSwgcGF0aCkKCiAgICBpZiBzcGVjIGlzIE5vbmU6CiAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoIk5vIG1vZHVsZSBuYW1lZCB7bmFtZSFyfSIuZm9ybWF0KG5hbWU9bmFtZSksIG5hbSAgICBSYWlzZWQgd2hlbiB3cml0aW5nIGEgemlwZmlsZSwgdGhlIHppcGZpbGUgcmVxdWlyZXMgWklQNjQgZXh0ZW5zaW9ucwogICAgYW5kIHRob3NlIGV4dGVuc2lvbnMgYXJlIGRpc2FibGVkLgogICAgIiIiCgplcnJvciA9IEJhZFppcGZpbGUgPSBCYWRaaXBGaWxlICAgICAgIyBQcmUtMy4yIGNvbXBhdGliaWxpdHkgbmFtZXMKCgpaSVA2NF9MSU1JVCA9ICgxIDw8IDMxKSAtIDEKWklQX0ZJTEVDT1VOVF9MSU1JVCA9ICgxIDw8IDE2KSAtIDEKWklQX01BWF9DT01NRU5UID0gKDEgPDwgMTYpIC0gMQoKIyBjb25zdGFudHMgZm9yIFppcCBmaWxlIGNvbXByZXNzaW9uIG1ldGhvZHMKWklQX1NUT1JFRCA9IDAKWklQX0RFRkxBVEVEID0gOApaSVBfQlpJUDIgPSAxMgpaSVBfTFpNQSA9IDE0ClpJUF9aU1RBTkRBUkQgPSA5MwojIE90aGVyIFpJUCBjb21wcmVzc2lvbiBtZXRob2RzIG5vdCBzdXBwb3J0ZWQKCkRFRkFVTFRfVkVSU0lPTiA9IDIwClpJUDY0X1ZFUlNJT04gPSA0NQpCWklQMl9WRVJTSU9OID0gNDYKTFpNQV9WRVJTSU9OID0gNjMKWlNUQU5EQVJEX1ZFUlNJT04gPSA2MwojIHdlIHJlY29nbml6ZSAoYnV0IG5vdCBuZWNlc3NhcmlseSBzdXBwb3J0KSBhbGwgZmVhdHVyZXMgdXAgdG8gdGhhdCB2ZXJzaW9uCk1BWF9FWFRSQUNUX1ZFUlNJT04gPSA2MwoKIyBCZWxvdyBhcmUgc29tZSBmb3JtYXRzIGFuZCBhc3NvY2lhdGVkIGRhdGEgZm9yIHJlYWRpbmcvd3JpdGluZyBoZWFkZXJzIHVzaW5nCiMgdGhlIHN0cnVjdCBtb2R1bGUuICBUaGUgbmFtZXMgYW5kIHN0cnVjdHVyZXMgb2YgaGVhZGVycy9yZWNvcmRzIGFyZSB0aG9zZSB1c2VkCiMgaW4gdGhlIFBLV0FSRSBkZXNjcmlwdGlvbiBvZiB0aGUgWklQIGZpbGUgZm9ybWF0OgojICAgICBodHRwOi8vd3d3LnBrd2FyZS5jb20vZG9jdW1lbnRzL2Nhc2VzdHVkaWVzL0FQUE5PVEUuVFhUCiMgKFVSTCB2YWxpZCBhcyBvZiBKYW51YXJ5IDIwMDgpCgojIFRoZSAiZW5kIG9mIGNlbnRyYWwgZGlyZWN0b3J5IiBzdHJ1Y3R1cmUsIG1hZ2ljIG51bWJlciwgc2l6ZSwgYW5kIGluZGljZXMKIyAoc2VjdGlvbiBWLkkgaW4gdGhlIGZvcm1hdCBkb2N1bWVudCkKc3RydWN0RW5kQXJjaGl2ZSA9IGIiPDRzNEgyTEgiCnN0cmluZ0VuZEFyY2hpdmUgPSBiIlBLXDAwNVwwMDYiCnNpemVFbmRDZW50RGlyID0gc3RydWN0LmNhbGNzaXplKHN0cnVjdEVuZEFyY2hpdmUpCgpfRUNEX1NJR05BVFVSRSA9IDAKX0VDRF9ESVNLX05VTUJFUiA9IDEKX0VDRF9ESVNLX1NUQVJUID0gMgpfRUNEX0VOVFJJRVNfVEhJU19ESVNLID0gMwpfRUNEX0VOVFJJRVNfVE9UQUwgPSA0Cl9FQ0RfU0laRSA9IDUKX0VDRF9PRkZTRVQgPSA2Cl9FQ0RfQ09NTUVOVF9TSVpFID0gNwojIFRoZXNlIGxhc3QgdHdvIGluZGljZXMgYXJlIG5vdCBwYXJ0IG9mIHRoZSBzdHJ1Y3R1cmUgYXMgZGVmaW5lZCBpbiB0aGUKIyBzcGVjLCBidXQgdGhleSBhcmUgdXNlZCBpbnRlcm5hbGx5IGJ5IHRoaXMgbW9kdWxlIGFzIGEgYwpTRVRURVI6IEZpbmFsID0gRnVuY3Rpb25LaW5kLlNFVFRFUgoKCkBkYy5kYXRhY2xhc3MocmVwcj1GYWxzZSkKY2xhc3MgRnVuY3Rpb246CiAgICAiIiIKICAgIE11dGFibGUgZHVjayB0eXBlIGZvciBpbnNwZWN0LkZ1bmN0aW9uLgoKICAgIGRvY3N0cmluZyAtIGEgc3RyIGNvbnRhaW5pbmcKICAgICAgICAqIGVtYmVkZGVkIGxpbmUgYnJlYWtzCiAgICAgICAgKiB0ZXh0IG91dGRlbnRlZCB0byB0aGUgbGVmdCBtYXJnaW4KICAgICAgICAqIG5vIHRyYWlsaW5nIHdoaXRlc3BhY2UuCiAgICAgICAgSXQgd2lsbCBhbHdheXMgYmUgdHJ1ZSB0aGF0CiAgICAgICAgICAgIChub3QgZG9jc3RyaW5nKSBvciAoKG5vdCBkb2NzdHJpbmdbMF0uaXNzcGFjZSgpKSBhbmQgKGRvY3N0cmluZy5yc3RyaXAoKSA9PSBkb2NzdHJpbmcpKQogICAgIiIiCiAgICBwYXJhbWV0ZXJzOiBQYXJhbURpY3QgPSBkYy5maWVsZChkZWZhdWx0X2ZhY3Rvcnk9ZGljdCkKICAgIF86IGRjLktXX09OTFkKICAgIG5hbWU6IHN0cgogICAgbW9kdWxlOiBNb2R1bGUgfCBDbGluaWMKICAgIGNsczogQ2xhc3MgfCBOb25lCiAgICBjX2Jhc2VuYW1lOiBzdHIKICAgIGZ1bGxfbmFtZTogc3RyCiAgICByZXR1cm5fY29udmVydGVyOiBDUmV0dXJuQ29udmVydGVyCiAgICBraW5kOiBGdW5jdGlvbktpbmQKICAgIGNvZXhpc3Q6IGJvb2wKICAgIHJldHVybl9hbm5vdGF0aW9uOiBvYmplY3QgPSBpbnNwZWN0LlNpZ25hdHVyZS5lbXB0eQogICAgZG9jc3RyaW5nOiBzdHIgPSAnJwogICAgIyBkb2NzdHJpbmdfb25seSBtZWFucyAiZG9uJ3QgZ2VuZXJhdGUgYSBtYWNoaW5lLXJlYWRhYmxlCiAgICAjIHNpZ25hdHVyZSwganVzdCBhIG5vcm1hbCBkb2NzdHJpbmciLiAgaXQncyBUcnVlIGZvcgogICAgIyBmdW5jdGlvbnMgd2l0aCBvcHRpb25hbCBncm91cHMgYmVjYXVzZSB3ZSBjYW4ndCByZXByZXNlbnQKICAgICMgdGhvc2UgYWNjdXJhdGVseSB3aXRoIGluc3BlY3QuU2lnbmF0dXJlIGluIDMuNC4KICAgIGRvY3N0cmluZ19vbmx5OiBib29sID0gRmFsc2UKICAgIGZvcmNlZF90ZXh0X3NpZ25hdHVyZTogc3RyIHwgTm9uZSA9IE5vbmUKICAgIGNyaXRpY2FsX3NlY3Rpb246IGJvb2wgPSBGYWxzZQogICAgZGlzYWJsZV9mYXN0Y2FsbDogYm9vbCA9IEZhbHNlCiAgICB0YXJnZXRfY3JpdGljYWxfc2VjdGlvbjogbGlzdFtzdHJdID0gZGMuZmllbGQoZGVmYXVsdF9mYWN0b3J5PWxpc3QpCgogICAgZGVmIF9fcG9zdF9pbml0X18oc2VsZikgLT4gTm9uZToKICAgICAgICBzZWxmLnBhcmVudCA9IHNlbGYuY2xzIG9yIHNlbGYubW9kdWxlCiAgICAgICAgc2VsZi5zZWxmX2NvbnZlcnRlcjogc2VsZl9jb252ZXJ0ZXIgfCBOb25lID0gTm9uZQogICAgICAgIHNlbGYuX19yZW5kZXJfcGFyYW1ldGVyc19fOiBsaXN0W1BhcmFtZXRlcl0gfCBOb25lID0gTm9uZQoKICAgIEBmdW5jdG9vbHMuY2FjaGVkX3Byb3BlcnR5CiAgICBkZWYgZGlzcGxheW5hbWUoc2VsZikgLT4gc3RyOgogIHNlLCBTa2lwVGVzdCwgc2tpcCwKICAgICAgICAgICAgICAgICAgIHNraXBJZiwgc2tpcFVubGVzcywgZXhwZWN0ZWRGYWlsdXJlLCBkb01vZHVsZUNsZWFudXBzLAogICAgICAgICAgICAgICAgICAgZW50ZXJNb2R1bGVDb250ZXh0KQpmcm9tIC5zdWl0ZSBpbXBvcnQgQmFzZVRlc3RTdWl0ZSwgVGVzdFN1aXRlICAjIG5vcWE6IEY0MDEKZnJvbSAubG9hZGVyIGltcG9ydCBUZXN0TG9hZGVyLCBkZWZhdWx0VGVzdExvYWRlcgpmcm9tIC5tYWluIGltcG9ydCBUZXN0UHJvZ3JhbSwgbWFpbiAgIyBub3FhOiBGNDAxCmZyb20gLnJ1bm5lciBpbXBvcnQgVGV4dFRlc3RSdW5uZXIsIFRleHRUZXN0UmVzdWx0CmZyb20gLnNpZ25hbHMgaW1wb3J0IGluc3RhbGxIYW5kbGVyLCByZWdpc3RlclJlc3VsdCwgcmVtb3ZlUmVzdWx0LCByZW1vdmVIYW5kbGVyCiMgSXNvbGF0ZWRBc3luY2lvVGVzdENhc2Ugd2lsbCBiZSBpbXBvcnRlZCBsYXppbHkuCgoKIyBMYXp5IGltcG9ydCBvZiBJc29sYXRlZEFzeW5jaW9UZXN0Q2FzZSBmcm9tIC5hc3luY19jYXNlCiMgSXQgaW1wb3J0cyBhc3luY2lvLCB3aGljaCBpcyByZWxhdGl2ZWx5IGhlYXZ5LCBidXQgbW9zdCB0ZXN0cwojIGRvIG5vdCBuZWVkIGl0LgoKZGVmIF9fZGlyX18oKToKICAgIHJldHVybiBnbG9iYWxzKCkua2V5cygpIHwgeydJc29sYXRlZEFzeW5jaW9UZXN0Q2FzZSd9CgpkZWYgX19nZXRhdHRyX18obmFtZSk6CiAgICBpZiBuYW1lID09ICdJc29sYXRlZEFzeW5jaW9UZXN0Q2FzZSc6CiAgICAgICAgZ2xvYmFsIElzb2xhdGVkQXN5bmNpb1Rlc3RDYXNlCiAgICAgICAgZnJvbSAuYXN5bmNfY2FzZSBpbXBvcnQgSXNvbGF0ZWRBc3luY2lvVGVzdENhc2UKICAgICAgICByZXR1cm4gSXNvbGF0ZWRBc3luY2lvVGVzdENhc2UKICAgIHJhaXNlIEF0dHJpYnV0ZUVycm9yKGYibW9kdWxlIHtfX25hbWVfXyFyfSBoYXMgbm8gYXR0cmlidXRlIHtuYW1lIXJ9IikKaW1wb3J0IHVuaXR0ZXN0CmZyb20gdGVzdC5zdXBwb3J0IGltcG9ydCBNU19XSU5ET1dTCmltcG9ydCBjdHlwZXMKZnJvbSBjdHlwZXMgaW1wb3J0IFBPSU5URVIsIFN0cnVjdHVyZSwgY192b2lkX3AKCmZyb20gLl9zdXBwb3J0IGltcG9ydCBQeUNTaW1wbGVUeXBlLCBQeUNQb2ludGVyVHlwZSwgUHlDU3RydWN0VHlwZQoKCmRlZiBzZXRfbm9uX2N0eXBlc19wb2ludGVyX3R5cGUoY2xzLCBwb2ludGVyX3R5cGUpOgogICAgY2xzLl9fcG9pbnRlcl90eXBlX18gPSBwb2ludGVyX3R5cGUKCmNsYXNzIFB5Q1NpbXBsZVR5cGVBc01ldGFjbGFzc1Rlc3QodW5pdHRlc3QuVGVzdENhc2UpOgogICAgZGVmIHRlc3RfY3JlYXRpbmdfcG9pbnRlcl9pbl9kdW5kZXJfbmV3XzEoc2VsZik6CiAgICAgICAgIyBUZXN0IG1ldGFjbGFzcyB3aG9zZSBpbnN0YW5jZXMgYXJlIEMgdHlwZXM7IHdoZW4gdGhlIHR5cGUgaXMKICAgICAgICAjIGNyZWF0ZWQgaXQgYXV0b21hdGljYWxseSBjcmVhdGVzIGEgcG9pbnRlciB0eXBlIGZvciBpdHNlbGYuCiAgIHBhZ2Vfcm9vdC9zb21lLnZlcnlfc3BlY2lhbH5jaGFycy1oZXJlLyIsIHN0YXR1c19jb2RlPTMwMQogICAgICAgICkKIiIiUHlVbml0IHRlc3RpbmcgdGhhdCB0aHJlYWRzIGhvbm9yIG91ciBzaWduYWwgc2VtYW50aWNzIiIiCgppbXBvcnQgdW5pdHRlc3QKaW1wb3J0IHNpZ25hbAppbXBvcnQgb3MKaW1wb3J0IHN5cwpmcm9tIHRlc3Quc3VwcG9ydCBpbXBvcnQgdGhyZWFkaW5nX2hlbHBlcgppbXBvcnQgX3RocmVhZCBhcyB0aHJlYWQKaW1wb3J0IHRpbWUKCmlmIChzeXMucGxhdGZvcm1bOjNdID09ICd3aW4nKToKICAgIHJhaXNlIHVuaXR0ZXN0LlNraXBUZXN0KCJDYW4ndCB0ZXN0IHNpZ25hbCBvbiAlcyIgJSBzeXMucGxhdGZvcm0pCgpwcm9jZXNzX3BpZCA9IG9zLmdldHBpZCgpCnNpZ25hbGxlZF9hbGw9dGhyZWFkLmFsbG9jYXRlX2xvY2soKQoKVVNJTkdfUFRIUkVBRF9DT05EID0gKHN5cy50aHJlYWRfaW5mby5uYW1lID09ICdwdGhyZWFkJwogICAgICAgICAgICAgICAgICAgICAgYW5kIHN5cy50aHJlYWRfaW5mby5sb2NrID09ICdtdXRleCtjb25kJykKCmRlZiByZWdpc3RlclNpZ25hbHMoZm9yX3VzcjEsIGZvcl91c3IyLCBmb3JfYWxybSk6CiAgICB1c3IxID0gc2lnbmFsLnNpZ25hbChzaWduYWwuU0lHVVNSMSwgZm9yX3VzcjEpCiAgICB1c3IyID0gc2lnbmFsLnNpZ25hbChzaWduYWwuU0lHVVNSMiwgZm9yX3VzcjIpCiAgICBhbHJtID0gc2lnbmFsLnNpZ25hbChzaWduYWwuU0lHQUxSTSwgZm9yX2Fscm0pCiAgICByZXR1cm4gdXNyMSwgdXNyMiwgYWxybQoKCiMgVGhlIHNpZ25hbCBoYW5kbGVyLiBKdXN0IG5vdGUgdGhhdCB0aGUgc2lnbmFsIG9jY3VycmVkIGFuZAojIGZyb20gd2hvLgpkZWYgaGFuZGxlX3NpZ25hbHMoc2lnLGZyYW1lKToKICAgIHNpZ25hbF9ibGFja2JvYXJkW3NpZ11bJ3RyaXBwZWQnXSArPSAxCiAgICBzaWduYWxfYmxhY2tib2FyZFtzaWddWyd0cmlwcGVkX2J5J10gPSB0aHJlYWQuZ2V0X2lkZW50KCkKCiMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgc3Bhd25lZCBhcyBhIHNlcGFyYXRlIHRocmVhZC4KZGVmIHNlbmRfc2lnbmFscygpOgogICAgIyBXZSB1c2UgYHJhaXNlX3NpZ25hbGAgcmF0aGVyIHRoYW4gYGtpbGxgIGJlY2F1c2U6CiAgICAjICAgKiBJdCB2ZXJpZmllcyB0aGF0IGEgc2lnbmFsIGRlbGl2ZXJlZCB0byBhIGJhY2tncm91bmQgdGhyZWFkIHN0aWxsIGhhcwogICAgIyAgICAgaXRzIFB5dGhvbi1sZXZlbCBoYW5kbGVyIGNhbGxlZCBvbiB0aGUgbWFpbiB0aHJlYWQuCiAgICAjICAgKiBJdCBlbnN1cmVzIHRoZSBzaWduYWwgaXMgaGFuZGxlZCBiZWZvcmUgdGhlIHRocmVhZCBleGl0cy4KICAgIHNpZ25hbC5yYWlzZV9zaWduYWwoc2lnbmFsLlNJR1VTUjEpCiAgICBzaWduYWwucmFpc2Vfc2lnbmFsKHNpZ25hbC5TSUdVU1IyKQogICAgc2lnbmFsbGVkX2FsbC5yZWxlYXNlKCkKCgpAdGhyZWFkaW5nX2hlbHBlci5yZXF1aXJlc193b3JraW5nX3RocmVhZGluZygpCmNsYSAgICJDb3VsZCBub3QgZmluZCBiYWNrZW5kICdkamFuZ28ubm9uZXhpc3RlbnQuTm9uZXhpc3RlbnRCYWNrZW5kJzogIgogICAgICAgICAgICAiTm8gbW9kdWxlIG5hbWVkICdkamFuZ28ubm9uZXhpc3RlbnQnIgogICAgICAgICkKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzTWVzc2FnZShJbnZhbGlkU3RvcmFnZUVycm9yLCBtc2cpOgogICAgICAgICAgICB0ZXN0X3N0b3JhZ2VzWyJpbnZhbGlkX2JhY2tlbmQiXQoKCmNsYXNzIFN0b3JhZ2VMYXp5T2JqZWN0VGVzdHMoU2ltcGxlVGVzdENhc2UpOgogICAgZGVmIHRlc3RfbGF6eV9vYmplY3RfaXNfbm90X2V2YWx1YXRlZF9iZWZvcmVfbWFudWFsX2FjY2VzcyhzZWxmKToKICAgICAgICBvYmogPSBTdG9yYWdlKCkKICAgICAgICBzZWxmLmFzc2VydElzKG9iai5sYXp5X3N0b3JhZ2Uuc3RvcmFnZS5fd3JhcHBlZCwgZW1wdHkpCiAgICAgICAgIyBhc3NlcnRFcXVhbCB0cmlnZ2VycyByZXNvbHV0aW9uLgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwob2JqLmxhenlfc3RvcmFnZS5zdG9yYWdlLCB0ZW1wX3N0b3JhZ2UpCiMhL3Vzci9iaW4vZW52IHB5dGhvbjMuOAoKaW1wb3J0IGFyZ3BhcnNlCmltcG9ydCBwcHJpbnQKaW1wb3J0IHN5cwoKZnJvbSBwZWdlbi5idWlsZCBpbXBvcnQgYnVpbGRfcGFyc2VyCmZyb20gcGVnZW4uZ3JhbW1hciBpbXBvcnQgKAogICAgQWx0LAogICAgQ3V0LAogICAgR2F0aGVyLAogICAgR3JhbW1hclZpc2l0b3IsCiAgICBHcm91cCwKICAgIExvb2thaGVhZCwKICAgIE5hbWVkSXRlbSwKICAgIE5hbWVMZWFmLAogICAgTmVnYXRpdmVMb29rYWhlYWQsCiAgICBPcHQsCiAgICBSZXBlYXQwLAogICAgUmVwZWF0MSwKICAgIFJocywKICAgIFJ1bGUsCiAgICBTdHJpbmdMZWFmLAopCmZyb20gcGVnZW4ucGFyc2VyX2dlbmVyYXRvciBpbXBvcnQgY29tcHV0ZV9udWxsYWJsZXMKCmFyZ3BhcnNlciA9IGFyZ3BhcnNlLkFyZ3VtZW50UGFyc2VyKAogICAgcHJvZz0iY2FsY3VsYXRlX2ZpcnN0X3NldHMiLAogICAgZGVzY3JpcHRpb249IkNhbGN1bGF0ZSB0aGUgZmlyc3Qgc2V0cyBvZiBhIGdyYW1tYXIiLAopCmFyZ3BhcnNlci5hZGRfYXJndW1lbnQoImdyYW1tYXJfZmlsZSIsIGhlbHA9IlRoZSBncmFtbWFyIGZpbGUiKQoKCmNsYXNzIEZpcnN0U2V0Q2FsY3VsYXRvcihHcmFtbWFyVmlzaXRvcik6CiAgICBkZWYgX19pbml0X18oc2VsZiwgcnVsZXM6IGRpY3Rbc3RyLCBSdWxlXSkgLT4gTm9uZToKICAgICAgICBzZWxmLnJ1bGVzID0gcnVsZXMKICAgICAgICBzZWxmLm51bGxhYmxlcyA9IGNvbXB1dGVfbnVsbGFibGVzKHJ1bGVzKQogICAgICAgIHNlbGYuZmlyc3Rfc2V0czogZGljdFtzdHIsIHNldFtzdHJdXSA9IGRpY3QoKQogICAgICAgIHNlbGYuaW5fcHJvY2Vzczogc2V0W3N0cl0gPSBzZXQoKQoKICAgIGRlZiBjYWxjdWxhdGUoc2VsZikgLT4gZGljdFtzdHIsIHNldFtzdHJdXToKICAgICAgICBmb3IgbmFtZSwgcnVsZSBpbiBzZWxmLnJ1bGVzLiAgICAiLCAiLmpvaW4oZmllbGRfbmFtZXMpLAogICAgICAgICAgICAiLCAiLmpvaW4oWyIlcyJdICogbGVuKHBhcmFtcykpLAogICAgICAgICksIHR1cGxlKHBhcmFtcykKCiAgICBkZWYgZmV0Y2hfcmV0dXJuZWRfcm93cyhzZWxmLCBjdXJzb3IsIHJldHVybmluZ19wYXJhbXMpOgogICAgICAgIHJldHVybiBsaXN0KHppcCgqKHBhcmFtLmdldF92YWx1ZSgpIGZvciBwYXJhbSBpbiByZXR1cm5pbmdfcGFyYW1zKSkpCgogICAgZGVmIG5vX2xpbWl0X3ZhbHVlKHNlbGYpOgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIGxpbWl0X29mZnNldF9zcWwoc2VsZiwgbG93X21hcmssIGhpZ2hfbWFyayk6CiAgICAgICAgZmV0Y2gsIG9mZnNldCA9IHNlbGYuX2dldF9saW1pdF9vZmZzZXRfcGFyYW1zKGxvd19tYXJrLCBoaWdoX21hcmspCiAgICAgICAgcmV0dXJuICIgIi5qb2luKAogICAgICAgICAgICBzcWwKICAgICAgICAgICAgZm9yIHNxbCBpbiAoCiAgICAgICAgICAgICAgICAoIk9GRlNFVCAlZCBST1dTIiAlIG9mZnNldCkgaWYgb2Zmc2V0IGVsc2UgTm9uZSwKICAgICAgICAgICAgICAgICgiRkVUQ0ggRklSU1QgJWQgUk9XUyBPTkxZIiAlIGZldGNoKSBpZiBmZXRjaCBlbHNlIE5vbmUsCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgc3FsCiAgICAgICAgKQoKICAgIGRlZiBsYXN0X2V4ZWN1dGVkX3F1ZXJ5KHNlbGYsIGN1cnNvciwgc3FsLCBwYXJhbXMpOgogICAgICAgICMgaHR0cHM6Ly9weXRob24tb3JhY2xlZGIucmVhZHRoZWRvY3MuaW8vZW4vbGF0ZXN0L2FwaV9tYW51YWwvY3Vyc29yLmh0bWwjQ3Vyc29yLnN0YXRlbWVudAogICAgICAgICMgVGhlIERCIEFQSSBkZWZpbml0aW9uIGRvZXMgbm90IGRlZmluZSB0aGlzIGF0dHJpYnV0ZS4KICAgICAgICBzdGF0ZW1lbnQgPSBjdXJzb3Iuc3RhdGVtZW50CiAgICAgICAgIyBVbmxpa2UgUHN5Y29wZydzIGBxdWVyeWAgYW5kIE15U1FMZGJgJ3MgYF9leGVjdXRlZGAsIG9yYWNsZWRiJ3MKICAgICAgICAjIGBzdGF0ZW1lbnRgIGRvZXNuJ3QgY29udGFpbiB0aGUgcXVlcnkgcGFyYW1ldGVycy4gU3Vic3RpdHV0ZQogICAgICAgICMgcGFyYW1ldGVycyBtYW51YWxseS4KICAgICAgICBpZiBzdGF0ZW1lbnQgYW5kIHBhcmFtczoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShwYXJhbXMsICh0dXBsZSwgbGlzdCkpOgogICAgICAgICAgICAgICAgcGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgIGYiOmFyZ3tpfSI6IHBhcmFtIGZvciBpLCBwYXJhbSBpbiBlbnVtZXJhdGUoZGljdC5mcm9ta2V5cyhwYXJhbXMpKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UocGFyYW1zLCBkaWN0KToKICAgICAgICAgICAgICAgIHBhcmFtcyA9IHtmIjp7a2V5fSI6IHZhbCBmb3IgKGtleSwgdmFsKSBpbiBwYXJhbXMuaXRlbXMoKX0KICAgICAgICAgICAgZm9yIGtleSBpbiBzb3J0ZWQocGFyYW1zLCBrZXk9bGVuLCByZXZlcnNlPVRydXRpbHMuZm9ybWF0X2RhdGV0aW1lKGRhdGUpCgoKZGVmIHJmYzMzMzlfZGF0ZShkYXRlKToKICAgIGlmIG5vdCBpc2luc3RhbmNlKGRhdGUsIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICBkYXRlID0gZGF0ZXRpbWUuZGF0ZXRpbWUuY29tYmluZShkYXRlLCBkYXRldGltZS50aW1lKCkpCiAgICByZXR1cm4gZGF0ZS5pc29mb3JtYXQoKSArICgiWiIgaWYgZGF0ZS51dGNvZmZzZXQoKSBpcyBOb25lIGVsc2UgIiIpCgoKZGVmIGdldF90YWdfdXJpKHVybCwgZGF0ZSk6CiAgICAiIiIKICAgIENyZWF0ZSBhIFRhZ1VSSS4KCiAgICBTZWUKICAgIGh0dHBzOi8vd2ViLmFyY2hpdmUub3JnL3dlYi8yMDExMDUxNDExMzgzMC9odHRwOi8vZGl2ZWludG9tYXJrLm9yZy9hcmNoaXZlcy8yMDA0LzA1LzI4L2hvd3RvLWF0b20taWQKICAgICIiIgogICAgYml0cyA9IHVybHBhcnNlKHVybCkKICAgIGQgPSAiIgogICAgaWYgZGF0ZSBpcyBub3QgTm9uZToKICAgICAgICBkID0gIiwlcyIgJSBkYXRlLnN0cmZ0aW1lKCIlWS0lbS0lZCIpCiAgICByZXR1cm4gInRhZzolcyVzOiVzLyVzIiAlIChiaXRzLmhvc3RuYW1lLCBkLCBiaXRzLnBhdGgsIGJpdHMuZnJhZ21lbnQpCgoKZGVmIF9ndWVzc19zdHlsZXNoZWV0X21pbWV0eXBlKHVybCk6CiAgICAiIiIKICAgIFJldHVybiB0aGUgZ2l2ZW4gc3R5bGVzaGVldCdzIG1pbWV0eXBlIHR1cGxlLCB1c2luZyBhIHNsaWdodGx5IGN1c3RvbQogICAgdmVyc2lvbiBvZiBQeXRob24ncyBtaW1ldHlwZXMuZ3Vlc3NfdHlwZSgpLgogICAgIiIiCiAgICBtaW1ldHlwZWRiID0gbWltZXR5cGVzLk1pbWVUeXBlcygpCgogICAgIyBUaGUgb2ZmaWNpYWwgbWltZXR5cGUgZm9yIFhTTFQgZmlsZXMgaXMgdGVjaG5pY2FsbHkKICAgICMgYGFwcGxpY2F0aW9uL3hzbHQreG1sYCBidXQgYXMgb2YgMjAyNCBhbG1vc3Qgbm8gYnJvd3NlciBzdXBwb3J0cyB0aGF0CiAgICAjICh0aGV5IGFsbCBleHBlY3QgdGV4dC94c2wpLiBPbiB0b3Agb2YgdGhhdCwgd2luZG93cyBzZWVtcyB0byBhc3N1bWUgdGhhdAogICAgIyB0aGUgdHlwZSBmb3IgeHNsIGlzIHRleHQveG1sLgogICAgbWltZXR5cGVkYi5yZWFkZnAoU3RyaW5nSU8oInRleHQveHNsXHR4c2xcbnRleHQveHNsXHR4c2x0IikpCgogICAgcmV0dXJuIG1pbWV0eXBlZGIuZ3Vlc3NfdHlwZSh1cmwpCgoKY2xhc3MgU3R5bGVzaGVldDoKICAgICIiIkFuIFJTUyBzdHlsZXNoZWV0IiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHVybCwgbWltZXR5cGU9IiIsIG1lZGlhPSJzY3JlZW4iKToKICAgICAgICBzZWxmLl91cmwgPSB1cmwKICAgICAgICBzZWxmLl9taW1ldHlwZSA9IG1pbWV0eXBlCiAgICAgICAgc2VsZi5tZWRpYSA9IG1lZGlhCgogICAgIyBVc2luZyBhIHByb3BlcnR5IHRvIGRlbGF5IHRoZSBldmFsdWF0aW9uIG9mIHNlbGYuX3VybCBhcyBsYXRlIGFzIHBvc3NpYmxlCiAgICAjIGluIGNhc2Ugb2YgYSBsYXp5IG9iamVjdCAobGlrZSByZXZlcnNlX2xhenkoLiMgIDB4NkQgLT4gTEFUSU4gU01BTEwgTEVUVEVSIE0KICAgICduJyAgICAgICAgIyAgMHg2RSAtPiBMQVRJTiBTTUFMTCBMRVRURVIgTgogICAgJ28nICAgICAgICAjICAweDZGIC0+IExBVElOIFNNQUxMIExFVFRFUiBPCiAgICAncCcgICAgICAgICMgIDB4NzAgLT4gTEFUSU4gU01BTEwgTEVUVEVSIFAKICAgICdxJyAgICAgICAgIyAgMHg3MSAtPiBMQVRJTiBTTUFMTCBMRVRURVIgUQogICAgJ3InICAgICAgICAjICAweDcyIC0+IExBVElOIFNNQUxMIExFVFRFUiBSCiAgICAncycgICAgICAgICMgIDB4NzMgLT4gTEFUSU4gU01BTEwgTEVUVEVSIFMKICAgICd0JyAgICAgICAgIyAgMHg3NCAtPiBMQVRJTiBTTUFMTCBMRVRURVIgVAogICAgJ3UnICAgICAgICAjICAweDc1IC0+IExBVElOIFNNQUxMIExFVFRFUiBVCiAgICAndicgICAgICAgICMgIDB4NzYgLT4gTEFUSU4gU01BTEwgTEVUVEVSIFYKICAgICd3JyAgICAgICAgIyAgMHg3NyAtPiBMQVRJTiBTTUFMTCBMRVRURVIgVwogICAgJ3gnICAgICAgICAjICAweDc4IC0+IExBVElOIFNNQUxMIExFVFRFUiBYCiAgICAneScgICAgICAgICMgIDB4NzkgLT4gTEFUSU4gU01BTEwgTEVUVEVSIFkKICAgICd6JyAgICAgICAgIyAgMHg3QSAtPiBMQVRJTiBTTUFMTCBMRVRURVIgWgogICAgJ3snICAgICAgICAjICAweDdCIC0+IExFRlQgQ1VSTFkgQlJBQ0tFVAogICAgJ3wnICAgICAgICAjICAweDdDIC0+IFZFUlRJQ0FMIExJTkUKICAgICd9JyAgICAgICAgIyAgMHg3RCAtPiBSSUdIVCBDVVJMWSBCUkFDS0VUCiAgICAnficgICAgICAgICMgIDB4N0UgLT4gVElMREUKICAgICdceDdmJyAgICAgIyAgMHg3RiAtPiBDT05UUk9MIENIQVJBQ1RFUgogICAgJ1x4YzQnICAgICAjICAweDgwIC0+IExBVElOIENBUElUQUwgTEVUVEVSIEEgV0lUSCBESUFFUkVTSVMKICAgICdceGM1JyAgICAgIyAgMHg4MSAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBBIFdJVEggUklORyBBQk9WRQogICAgJ1x4YzcnICAgICAjICAweDgyIC0+IExBVElOIENBUElUQUwgTEVUVEVSIEMgV0lUSCBDRURJTExBCiAgICAnXHhjOScgICAgICMgIDB4ODMgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgRSBXSVRIIEFDVVRFCiAgICAnXHhkMScgICAgICMgIDB4ODQgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgTiBXSVRIIFRJTERFCiAgICAnXHhkNicgICAgICMgIDB4ODUgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgTyBXSVRIIERJQUVSRVNJUwogICAgJ1x4ZGMnICAgICAjICAweDg2IC0+IExBVElOIENBUElUQUwgTEVUVEVSIFUgV0lUSCBESUFFUkVTSVMKICAgICdceGUxJyAgICAgIyAgMHg4NyAtPiBMQVRJTiBTTUFMTCBMRVRURVIgQSBXSVRIIEFDVVRFCiAgICAnXHhlMCcgICAgICMgIDB4ODggLT4gTEFUSU4gU01BTEwgTEVUVEVSIEEgV0lUSCBHUkFWRQogICAgJ1x4ZTInICAgICAjICAweDg5IC0+IExBVElOIFNNQUxMIExFVFRFUiBBIFdJVEggQ0lSQ1VNRkxFWAogICAgJ1x4ZTQnICAgICAjICAweDhBIC0+ICBFUVVBTFMgU0lHTgogICAgJz4nICAgICAgICAjICAweDNFIC0+IEdSRUFURVItVEhBTiBTSUdOCiAgICAnPycgICAgICAgICMgIDB4M0YgLT4gUVVFU1RJT04gTUFSSwogICAgJ0AnICAgICAgICAjICAweDQwIC0+IENPTU1FUkNJQUwgQVQKICAgICdBJyAgICAgICAgIyAgMHg0MSAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBBCiAgICAnQicgICAgICAgICMgIDB4NDIgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgQgogICAgJ0MnICAgICAgICAjICAweDQzIC0+IExBVElOIENBUElUQUwgTEVUVEVSIEMKICAgICdEJyAgICAgICAgIyAgMHg0NCAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBECiAgICAnRScgICAgICAgICMgIDB4NDUgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgRQogICAgJ0YnICAgICAgICAjICAweDQ2IC0+IExBVElOIENBUElUQUwgTEVUVEVSIEYKICAgICdHJyAgICAgICAgIyAgMHg0NyAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBHCiAgICAnSCcgICAgICAgICMgIDB4NDggLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgSAogICAgJ0knICAgICAgICAjICAweDQ5IC0+IExBVElOIENBUElUQUwgTEVUVEVSIEkKICAgICdKJyAgICAgICAgIyAgMHg0QSAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBKCiAgICAnSycgICAgICAgICMgIDB4NEIgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgSwogICAgJ0wnICAgICAgICAjICAweDRDIC0+IExBVElOIENBUElUQUwgTEVUVEVSIEwKICAgICdNJyAgICAgICAgIyAgMHg0RCAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBNCiAgICAnTicgICAgICAgICMgIDB4NEUgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgTgogICAgJ08nICAgICAgICAjICAweDRGIC0+IExBVElOIENBUElUQUwgTEVUVEVSIE8KICAgICdQJyAgICAgICAgIyAgMHg1MCAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBQCiAgICAnUScgICAgICAgICMgIDB4NTEgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgUQogICAgJ1InICAgICAgICAjICAweDUyIC0+IExBVElOIENBUElUQUwgTEVUVEVSIFIKICAgICdTJyAgICAgICAgIyAgMHg1MyAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBTCiAgICAnVCcgICAgICAgICMgIDB4NTQgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgVAogICAgJ1UnICAgICAgICAjICAweDU1IC0+IExBVElOIENBUElUQUwgTEVUVEVSIFUKICAgICdWJyAgICAgICAgIyAgMHg1NiAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBWCiAgICAnVycgICAgICAgICMgIDB4NTcgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgVwogICAgJ1gnICAgICAgICAjICAweDU4IC0+IExBVElOIENBUElUQUwgTEVUVEVSIFgKICAgICdZJyAgICAgICAgIyAgMHg1OSAtPiBMQVRJTiBDQVBJVEFMIExFVFRFUiBZCiAgICAnWicgICAgICAgICMgIDB4NUEgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgWgogICAgJ1snICAgICAgICAjICAweDVCIC0+IExFRlQgU1FVQVJFIEJSQUNLRVQKICAgICdcXCcgICAgICAgIyAgMHg1QyAtPiBSRVZFUlNFIFNPTHN0X3BhcmVudF9wcm9wYWdhdGlvbl93aXRoX2F1dG9zcGVjX2F0dGFjaF9tb2NrKHNlbGYpOgoKICAgICAgICBkZWYgZm9vKGEsIGIpOiBwYXNzCgogICAgICAgIHBhcmVudCA9IE1vY2soKQogICAgICAgIHBhcmVudC5hdHRhY2hfbW9jayhjcmVhdGVfYXV0b3NwZWMoZm9vLCBuYW1lPSdiYXInKSwgJ2NoaWxkJykKICAgICAgICBwYXJlbnQuY2hpbGQoMSwgMikKCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoVHlwZUVycm9yLCBwYXJlbnQuY2hpbGQsIDEpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChwYXJlbnQuY2hpbGQubW9ja19jYWxscywgW2NhbGwuY2hpbGQoMSwgMildKQogICAgICAgIHNlbGYuYXNzZXJ0SW4oJ21vY2suY2hpbGQnLCByZXByKHBhcmVudC5jaGlsZC5tb2NrKSkKCgogICAgZGVmIHRlc3RfaXNpbnN0YW5jZV91bmRlcl9zZXR0cmFjZShzZWxmKToKICAgICAgICAjIGJwby0zNjU5MyA6IF9fY2xhc3NfXyBpcyBub3Qgc2V0IGZvciBhIGNsYXNzIHRoYXQgaGFzIF9fY2xhc3NfXwogICAgICAgICMgcHJvcGVydHkgZGVmaW5lZCB3aGVuIGl0J3MgdXNlZCB3aXRoIHN5cy5zZXR0cmFjZSh0cmFjZSkgc2V0LgogICAgICAgICMgRGVsZXRlIHRoZSBtb2R1bGUgdG8gZm9yY2UgcmVpbXBvcnQgd2l0aCB0cmFjaW5nIGZ1bmN0aW9uIHNldAogICAgICAgICMgcmVzdG9yZSB0aGUgb2xkIHJlZmVyZW5jZSBsYXRlciBzaW5jZSB0aGVyZSBhcmUgb3RoZXIgdGVzdHMgdGhhdCBhcmUKICAgICAgICAjIGRlcGVuZGVudCBvbiB1bml0dGVzdC5tb2NrLnBhdGNoLiBJbiB0ZXN0cGF0Y2guUGF0Y2hUZXN0CiAgICAgICAgIyB0ZXN0X3BhdGNoX2RpY3RfdGVzdF9wcmVmaXggYW5kIHRlc3RfcGF0Y2hfdGVzdF9wcmVmaXggbm90IHJlc3RvcmluZwogICAgICAgICMgY2F1c2VzIHRoZSBvYmplY3RzIHBhdGNoZWQgdG8gZ28gb3V0IG9mIHN5bmMKCiAgICAgICAgb2xkX3BhdGNoID0gdW5pdHRlc3QubW9jay5wYXRjaAoKICAgICAgICAjIERpcmVjdGx5IHVzaW5nIF9fc2V0YXR0cl9fIG9uIHVuaXR0ZXN0Lm1vY2sgY2F1c2VzIGN1cnJlbnQgaW1wb3J0ZWQKICAgICAgICAjIHJlZmVyZW5jZSB0byBiZSB1cGRhdGVkLiBVc2UgYSBsYW1iZGEgc28gdGhhdCBkdXJpbmcgY2xlYW51cCB0aGUKICAgICAgICAjIHJlLWltcG9ydGVkIG5ldyByZWZlcmVuY2UgaXMgdXBkYXRlZC4KICAgICAgICBzZWxmLmFkZENsZWFudXAobGFtYmRhIHBhdGNoOiBzZXRhdHRyKHVuaXR0ZXN0Lm1vY2ssICdwYXRjaCcsIHBhdGNoKSwKICAgICAgICAgICAgICAgICAgICAgICAgb2xkX3BhdGNoKQoKICAgICAgICB3aXRoIHBhdGNoLmRpY3QoJ3N5cy5tb2R1bGVzJyk6CiAgICAgICAgICAgIGRlbCBzeXMubW9kdWxlc1sndW5pdHRlc3QubW9jayddCgogICAgICAgICAgICAjIFRoaXMgdHJhY2Ugd2lsbCBzdG9wIGNvdmVyYWdlIGJlaW5nIG1lYXN1cmVkIDstKQogICAgICAgICAgICBkZWYgdHJhY2UoZnJhbWUsIGV2ZW50LCBhcmcpOiAgIyBwcmFnbW1haW4odmVyYm9zaXR5PTIpCiIiIgpQb3J0YWJsZSBmaWxlIGxvY2tpbmcgdXRpbGl0aWVzLgoKQmFzZWQgcGFydGlhbGx5IG9uIGFuIGV4YW1wbGUgYnkgSm9uYXRoYW4gRmVpZ25iZXJnIGluIHRoZSBQeXRob24KQ29va2Jvb2sgWzFdIChsaWNlbnNlZCB1bmRlciB0aGUgUHl0aG9uIFNvZnR3YXJlIExpY2Vuc2UpIGFuZCBhIGN0eXBlcyBwb3J0IGJ5CkFuYXRvbHkgVGVjaHRvbmlrIGZvciBSb3VuZHVwIFsyXSAobGljZW5zZSBbM10pLgoKWzFdIGh0dHBzOi8vY29kZS5hY3RpdmVzdGF0ZS5jb20vcmVjaXBlcy82NTIwMy8KWzJdIGh0dHBzOi8vc291cmNlZm9yZ2UubmV0L3Avcm91bmR1cC9jb2RlL2NpL2RlZmF1bHQvdHJlZS9yb3VuZHVwL2JhY2tlbmRzL3BvcnRhbG9ja2VyLnB5ICAjIE5PUUEKWzNdIGh0dHBzOi8vc291cmNlZm9yZ2UubmV0L3Avcm91bmR1cC9jb2RlL2NpL2RlZmF1bHQvdHJlZS9DT1BZSU5HLnR4dAoKRXhhbXBsZSBVc2FnZTo6CgogICAgPj4+IGZyb20gZGphbmdvLmNvcmUuZmlsZXMgaW1wb3J0IGxvY2tzCiAgICA+Pj4gd2l0aCBvcGVuKCcuL2ZpbGUnLCAnd2InKSBhcyBmOgogICAgLi4uICAgICBsb2Nrcy5sb2NrKGYsIGxvY2tzLkxPQ0tfRVgpCiAgICAuLi4gICAgIGYud3JpdGUoJ0RqYW5nbycpCiIiIgoKaW1wb3J0IG9zCgpfX2FsbF9fID0gKCJMT0NLX0VYIiwgIkxPQ0tfU0giLCAiTE9DS19OQiIsICJsb2NrIiwgInVubG9jayIpCgoKZGVmIF9mZChmKToKICAgICIiIkdldCBhIGZpbGVkZXNjcmlwdG9yIGZyb20gc29tZXRoaW5nIHdoaWNoIGNvdWxkIGJlIGEgZmlsZSBvciBhbiBmZC4iIiIKICAgIHJldHVybiBmLmZpbGVubygpIGlmIGhhc2F0dHIoZiwgImZpbGVubyIpIGVsc2UgZgoKCmlmIG9zLm5hbWUgPT0gIm50IjoKICAgIGltcG9ydCBtc3ZjcnQKICAgIGZyb20gY3R5cGVzIGltcG9ydCAoCiAgICAgICAgUE9JTlRFUiwKICAgICAgICBTdHJ1Y3R1cmUsCiAgICAgICAgVW5pb24sCiAgICAgICAgV2luRExMLAogICAgICAgIGJ5cmVmLAogICAgICAgIGNfaW50NjQsCiAgICAgICAgY191bG9uZywKICAgICAgICBjX3ZvaWRfcCwKICAgICAgICBzaXplb2YsCiAgICApCiAgICBmcm9tIGN0eXBlcy53aW50eXBlcyBpbXBvcnQgQk9PTCwgRFdPUkQsIEhBTkRMRQoKICAgIExPQ0tfU0ggPSAwICAjIHRoZSBkZWZhdWx0CiAgICBMT0NLX05CID0gMHgxICAjIExPQ0tGSUxFX0ZBSUxfSU1NRURJQVRFTFkKICAgIExPQ0tfRVggPSAweDIgICMgTE9DS0ZJTEVfRVhDTFVTSVZFX0xPQ0sKCiAgICAjIC0tLSBBZGFwdGVkIGZyb20gdGhlIHB5c2VyaWFsIHByb2plY3QgLS0tCiAgICAjIGRldGVjdCBzaXplIG9mIFVMT05HX1BUUgogICAgaWYgc2l6ZW9mKGNfdWxvbmcpICE9IHNpemVvZihjX3ZvaWRfcCk6CiAgICAgICAgVUxPTkdfUFRSID0gY19pbnQ2NAogICAgZWxzZToKICAgICAgICBVTE9OR19QVFIgPSBjX3Vsb25nCiAgICBQVk9JRCA9IGNfdm9pZF9wCgogICAgIyAtLS0gVW5pb24gaW5zaWVsZi50b3AgPSByb290CiAgICAgICAgc2VsZi50ZXh0X2ZyYW1lID0gZnJhbWUKICAgICAgICBzZWxmLnRleHQgPSB0ZXh0CiAgICAgICAgc2VsZi5sYWJlbCA9ICcnCgogICAgZGVmIGdldGxpbmVubyhzZWxmLCBpbmRleCk6CiAgICAgICAgcmV0dXJuIGludChmbG9hdChzZWxmLnRleHQuaW5kZXgoaW5kZXgpKSkKCiAgICBkZWYgdXBkYXRlX21lbnVfbGFiZWwoc2VsZiwgKiprd2FyZ3MpOgogICAgICAgIHNlbGYubGFiZWwgPSBrd2FyZ3NbJ2xhYmVsJ10KCgpjbGFzcyBDb2RlQ29udGV4dFRlc3QodW5pdHRlc3QuVGVzdENhc2UpOgoKICAgIEBjbGFzc21ldGhvZAogICAgZGVmIHNldFVwQ2xhc3MoY2xzKToKICAgICAgICByZXF1aXJlcygnZ3VpJykKICAgICAgICByb290ID0gY2xzLnJvb3QgPSBUaygpCiAgICAgICAgcm9vdC53aXRoZHJhdygpCiAgICAgICAgZnJhbWUgPSBjbHMuZnJhbWUgPSBGcmFtZShyb290KQogICAgICAgIHRleHQgPSBjbHMudGV4dCA9IFRleHQoZnJhbWUpCiAgICAgICAgdGV4dC5pbnNlcnQoJzEuMCcsIGNvZGVfc2FtcGxlKQogICAgICAgICMgTmVlZCB0byBwYWNrIGZvciBjcmVhdGlvbiBvZiBjb2RlIGNvbnRleHQgdGV4dCB3aWRnZXQuCiAgICAgICAgZnJhbWUucGFjayhzaWRlPSdsZWZ0JywgZmlsbD0nYm90aCcsIGV4cGFuZD0xKQogICAgICAgIHRleHQuZ3JpZChyb3c9MSwgY29sdW1uPTEsIHN0aWNreT1OU0VXKQogICAgICAgIGNscy5lZGl0b3IgPSBEdW1teUVkaXR3aW4ocm9vdCwgZnJhbWUsIHRleHQpCiAgICAgICAgY29kZWNvbnRleHQuaWRsZUNvbmYudXNlckNmZyA9IHRlc3RjZmcKCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiB0ZWFyRG93bkNsYXNzKGNscyk6CiAgICAgICAgY29kZWNvbnRleHQuaWRsZUNvbmYudXNlckNmZyA9IHVzZXJjZmcKICAgICAgICBjbHMuZWRpdG9yLnRleHQuZGVsZXRlKCcxLjAnLCAnZW5kJykKICAgICAgICBkZWwgY2xzLmVkaXRvciwgY2xzLmZyYW1lLCBjbHMudGV4dAogICAgICAgIGNscy5yb290LnVwZGF0ZV9pZGxldGFza3MoKQogICAgICAgIGNscy5yb290LmRlc3Ryb3koKQogICAgICAgIGRlbCBjbHMucm9vdAoKICAgIGRlZiBzZXRVcChzZWxmKToKICAgICAgICBzZWxmLnRleHQueXZpZXcoMCkKICAgICAgICBzZWxmLnRleHRbJ2ZvbnQnXSA9ICdUa0ZpeGVkRm9udCcKICAgICAgICBzZWxmLmNjID0gY29kZWNvbnRleHQuQ29kZUNvbnRleHQoc2VsZi5lZGl0b3IpCgogICAgICAgIHNlbGYuaGlnaGxpZ2h0X2NmZyA9IHsiYmFja2dyb3VuZCI6ICcjYWJjZGVmJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImZvcmVncm91bmQiOiAnIzEyMzQ1Nid9CiAgICAgICAgb3JpZ19pZGxlQ29uZl9HZXRIaWdobGlnaHQgPSBjb2RlY29udGV4dC5pZGxlQ29uZi5HZXRIaWdobGlnaHQKICAgICAgICBkZWYgbW9ja19pZGxlY29uZl9HZXRIaWdobGlnaHQodGhlbWUsIGVsZW1lbnQpOgogICAgICAgICAgICBpZiBlbGVtZW50ID09ICdjb250ZSAgcmVkd29vZC5yb29tcy5hbGwoKVswXS5mbGVhcy5hbGwoKVswXS5wZXRzX3Zpc2l0ZWQuYWxsKClbMF0ubmFtZSwKICAgICAgICAgICAgKQoiIiJ0dXJ0bGVkZW1vL3JvdW5kX2RhbmNlLnB5CgpEYW5jaW5nIHR1cnRsZXMgaGF2ZSBhIGNvbXBvdW5kIHNoYXBlCmNvbnNpc3Rpbmcgb2YgYSBzZXJpZXMgb2YgdHJpYW5nbGVzIG9mCmRlY3JlYXNpbmcgc2l6ZS4KClR1cnRsZXMgbWFyY2ggYWxvbmcgYSBjaXJjbGUgd2hpbGUgcm90YXRpbmcKcGFpcndpc2UgaW4gb3Bwb3NpdGUgZGlyZWN0aW9uLCB3aXRoIG9uZQpleGNlcHRpb24uIERvZXMgdGhhdCBicmVha2luZyBvZiBzeW1tZXRyeQplbmhhbmNlIHRoZSBhdHRyYWN0aXZlbmVzcyBvZiB0aGUgZXhhbXBsZT8KClByZXNzIGFueSBrZXkgdG8gc3RvcCB0aGUgYW5pbWF0aW9uLgoKVGVjaG5pY2FsbHk6IGRlbW9uc3RyYXRlcyB1c2Ugb2YgY29tcG91bmQKc2hhcGVzLCB0cmFuc2Zvcm1hdGlvbiBvZiBzaGFwZXMgYXMgd2VsbCBhcwpjbG9uaW5nIHR1cnRsZXMuIFRoZSBhbmltYXRpb24gaXMKY29udHJvbGxlZCB0aHJvdWdoIHVwZGF0ZSgpLgoiIiIKCmZyb20gdHVydGxlIGltcG9ydCAqCgpkZWYgc3RvcCgpOgogICAgZ2xvYmFsIHJ1bm5pbmcKICAgIHJ1bm5pbmcgPSBGYWxzZQoKZGVmIG1haW4oKToKICAgIGdsb2JhbCBydW5uaW5nCiAgICBjbGVhcnNjcmVlbigpCiAgICBiZ2NvbG9yKCJncmF5MTAiKQogICAgdHJhY2VyKEZhbHNlKQogICAgc2hhcGUoInRyaWFuZ2xlIikKICAgIGYgPSAgIDAuNzkzNDAyCiAgICBwaGkgPSA5LjA2NDY3OAogICAgcyA9IDUKICAgIGMgPSAxCiAgICAjIGNyZWF0ZSBjb21wb3VuZCBzaGFwZQogICAgc2ggPSBTaGFwZSgiY29tcG91bmQiKQogICAgZm9yIGkgaW4gcmFuZ2UoMTApOgogICAgICAgIHNoYXBlc2l6ZShzKQogICAgICAgIHAgPWdldF9zaGFwZXBvbHkoKQogICAgICAgIHMgKj0gZgogICAgICAgIGMgKj0gZgogICAgICAgIHRpbHQoLXBoaSkKICAgICAgICBzaC5hZGRjb21wb25lbnQocCwgKGMsIDAuMjUsIDEtYyksICJibGFjayIpCiAgICByZWdpc3Rlcl9zaGFwZSgibXVsdGl0cmkiLCBzaCkKICAgICMgY3JlYXRlIGRhbmNlcnMKICAgIHNoYXBlc2l6ZSgxKQogICAgc2hhcGUoIm11bHRpdHJpIikKICAgIHB1KCkKICAgIHNldHBvcygwLCAtMjAwKQogICAgZGFuY2VycyA9IFtdCiAgICBmb3IgaSBpbiByYW5nZSgxODApOgogICAgICAgIGZkKDcpCiAgICAgICAgdGlsdCgtNCkKICAgICAgICBsdCgyKQogICAgICAgIHVwZGF0ZSgpCiAgICAgICAgaWYgaSAlIDEyID09IDA6CiAgICAgICAgICAgIGRhbmNlcnMuYXBwZW5kKGNsb25lKCkpCiAgICBob21lKCkKICAgICMgZGFuY2UKICAgIHJ1bm5pbmcgPSBUcnVlCiAgICBvbmtleXByZXNzKHN0b3ApCiAgICBsaXN0ZW4oKQogICAgY3MgPSAxCiAgICB3aGlsZSBydW5uaW5nOgogICAgICAgIHRhID0gLTQKICAgICAgICBmb3IgZGFuY2VyIGluIGRhbmNlcnM6CnMgYW4gYWx0ZXJuYXRpdmUgdGhhdCBjb250YWlucyAiCiAgICAgICAgICAgICAgICBmIlJBSVNFX1NZTlRBWF9FUlJPUjsgdGhpcyBpcyBvbmx5IGFsbG93ZWQgaW4gaW52YWxpZF8gcnVsZXMiCiAgICAgICAgICAgICkKCgpjbGFzcyBDdXRWYWxpZGF0b3IoR3JhbW1hclZhbGlkYXRvcik6CiAgICAiIiJGYWlsIGlmIEN1dCBpcyBub3QgZGlyZWN0bHkgaW4gYSBydWxlLgoKICAgIEZvciBzaW1wbGljaXR5LCB3ZSBjdXJyZW50bHkgZG9jdW1lbnQgdGhhdCBhIEN1dCBhZmZlY3RzIGFsdGVybmF0aXZlcwogICAgb2YgdGhlICpydWxlKiBpdCBpcyBpbi4KICAgIEhvd2V2ZXIsIHRoZSBpbXBsZW1lbnRhdGlvbiBtYWtlcyBjdXRzIGxvY2FsIHRvIGVuY2xvc2luZyBSaHMKICAgIChlLmcuIHBhcmVudGhlc2l6ZWQgbGlzdCBvZiBjaG9pY2VzKS4KICAgIEFkZGl0aW9uYWxseSwgaW4gYWNhZGVtaWMgcGFwZXJzIGFib3V0IFBFRywgcmVwZWF0cyBhbmQgb3B0aW9uYWwgaXRlbXMKICAgIGFyZSAiZGVzdWdhcmVkIiB0byBjaG9pY2VzIHdpdGggYW4gZW1wdHkgYWx0ZXJuYXRpdmUsIGFuZCB0aHVzIGNvbnRhaW4KICAgIGEgQ3V0J3MgZWZmZWN0LgoKICAgIFBsZWFzZSB1cGRhdGUgZG9jdW1lbnRhdGlvbiBhbmQgdGVzdHMgd2hlbiBhZGRpbmcgdGhpcyBjdXQsCiAgICB0aGVuIGdldCByaWQgb2YgdGhpcyB2YWxpZGF0b3IuCgogICAgU2VlIGdoLTE0MzA1NC4KICAgICIiIgoKICAgIGRlZiB2aXNpdChzZWxmLCBub2RlOiBBbnksIHBhcmVudHM6IHR1cGxlW0FueSwgLi4uXSA9ICgpKSAtPiBOb25lOgogICAgICAgIHN1cGVyKCkudmlzaXQobm9kZSwgcGFyZW50cz0oKnBhcmVudHMsIG5vZGUpKQoKICAgIGRlZiB2aXNpdF9DdXQoc2VsZiwgbm9kZTogQWx0LCBwYXJlbnRzOiB0dXBsZVtBbnksIC4uLl0gPSAoKSkgLT4gTm9uZToKICAgICAgICBwYXJlbnRfdHlwZXMgPSBbdHlwZShwKS5fX25hbWVfXyBmb3IgcCBpbiBwYXJlbnRzXQogICAgICAgIGlmIHBhcmVudF90eXBlcyAhPSBbJ1J1bGUnLCAnUmhzJywgJ0FsdCcsICdOYW1lZEl0ZW0nLCAnQ3V0J106CiAgICAgICAgICAgIHJhaXNlIFZhbGlkYXRpb25FcnJvcigKICAgICAgICAgICAgICAgIGYiUnVsZSB7c2VsZi5ydWxlbmFtZSFyfSBjb250YWlucyBjdXQgdGhhdCdzIG5vdCBvbiB0aGUgIgogICAgICAgICAgICAgICAgInRvcCBsZXZlbC4gIgogICAgICAgICAgICAgICAgIlRoZSBpbnRlbmRlZCBzZW1hbnRpY3Mgb2Ygc3VjaCBjYXNlcyBuZWVkICIKICAgICAgICAgICAgICAgICJ0byBiZSBjbGFyaWZpZWQ7IHNlZSB0aGUgQ3V0VmFsaWRhdG9yIGRvY3N0cmluZy4iCiAgICAgICAgICAgICAgICBmIlxuVGhlIGN1dCBpcyBpbnNpZGU6IHtwYXJlbnRfdHlwZXN9IgogICAgICAgICAgICApCgpkZWYgdmFsaWRhdGVfZ3JhbW1hcih0aGVfZ3JhbW1hcjogZ3JhbW1hci5HcmFtbWFyKSAtPiBOb25lOgogICAgZm9yIHZhbGlkYXRvcl9jbHMgaW4gR3JhbW1hclZhbGlkYXRvci5fX2RpdCB3aW5kb3cKCk9uY2UgY29kZSBoYXMgc2Nyb2xsZWQgb2ZmIHRoZSB0b3Agb2YgYSB3aW5kb3csIGl0IGNhbiBiZSBkaWZmaWN1bHQgdG8KZGV0ZXJtaW5lIHdoaWNoIGJsb2NrIHlvdSBhcmUgaW4uICBUaGlzIGV4dGVuc2lvbiBpbXBsZW1lbnRzIGEgcGFuZSBhdCB0aGUgdG9wCm9mIGVhY2ggSURMRSBlZGl0IHdpbmRvdyB3aGljaCBwcm92aWRlcyBibG9jayBzdHJ1Y3R1cmUgaGludHMuICBUaGVzZSBoaW50cyBhcmUKdGhlIGxpbmVzIHdoaWNoIGNvbnRhaW4gdGhlIGJsb2NrIG9wZW5pbmcga2V5d29yZHMsIGUuZy4gJ2lmJywgZm9yIHRoZQplbmNsb3NpbmcgYmxvY2suICBUaGUgbnVtYmVyIG9mIGhpbnQgbGluZXMgaXMgZGV0ZXJtaW5lZCBieSB0aGUgbWF4bGluZXMKdmFyaWFibGUgaW4gdGhlIGNvZGVjb250ZXh0IHNlY3Rpb24gb2YgY29uZmlnLWV4dGVuc2lvbnMuZGVmLiBMaW5lcyB3aGljaCBkbwpub3Qgb3BlbiBibG9ja3MgYXJlIG5vdCBzaG93biBpbiB0aGUgY29udGV4dCBoaW50cyBwYW5lLgoKRm9yIEVkaXRvcldpbmRvd3MsIDw8dG9nZ2xlLWNvZGUtY29udGV4dD4+IGlzIGJvdW5kIHRvIENvZGVDb250ZXh0KHNlbGYpLgp0b2dnbGVfY29kZV9jb250ZXh0X2V2ZW50LgoiIiIKaW1wb3J0IHJlCmZyb20gc3lzIGltcG9ydCBtYXhzaXplIGFzIElORklOSVRZCgpmcm9tIHRraW50ZXIgaW1wb3J0IEZyYW1lLCBUZXh0LCBUY2xFcnJvcgpmcm9tIHRraW50ZXIuY29uc3RhbnRzIGltcG9ydCBOU0VXLCBTVU5LRU4KCmZyb20gaWRsZWxpYi5jb25maWcgaW1wb3J0IGlkbGVDb25mCgpCTE9DS09QRU5FUlMgPSB7J2NsYXNzJywgJ2RlZicsICdpZicsICdlbGlmJywgJ2Vsc2UnLCAnd2hpbGUnLCAnZm9yJywKICAgICAgICAgICAgICAgICAndHJ5JywgJ2V4Y2VwdCcsICdmaW5hbGx5JywgJ3dpdGgnLCAnYXN5bmMnfQoKCmRlZiBnZXRfc3BhY2VzX2ZpcnN0d29yZChjb2RlbGluZSwgYz1yZS5jb21waWxlKHIiXihccyopKFx3KikiKSk6CiAgICAiRXh0cmFjdCB0aGUgYmVnaW5uaW5nIHdoaXRlc3BhY2UgYW5kIGZpcnN0IHdvcmQgZnJvbSBjb2RlbGluZS4iCiAgICByZXR1cm4gYy5tYXRjaChjb2RlbGluZSkuZ3JvdXBzKCkKCgpkZWYgZ2V0X2xpbmVfaW5mbyhjb2RlbGluZSk6CiAgICAiIiJSZXR1cm4gdHVwbGUgb2YgKGxpbmUgaW5kZW50IHZhbHVlLCBjb2RlbGluZSwgYmxvY2sgc3RhcnQga2V5d29yZCkuCgogICAgVGhlIGluZGVudGF0aW9uIG9mIGVtcHR5IGxpbmVzIChvciBjb21tZW50IGxpbmVzKSBpcyBJTkZJTklUWS4KICAgIElmIHRoZSBsaW5lIGRvZXMgbm90IHN0YXJ0IGEgYmxvY2ssIHRoZSBrZXl3b3JkIHZhbHVlIGlzIEZhbHNlLgogICAgIiIiCiAgICBzcGFjZXMsIGZpcnN0d29yZCA9IGdldF9zcGFjZXNfZmlyc3R3b3JkKGNvZGVsaW5lKQogICAgaW5kZW50ID0gbGVuKHNwYWNlcykKICAgIGlmIGxlbihjb2RlbGluZSkgPT0gaW5kZW50IG9yIGNvZGVsaW5lW2luZGVudF0gPT0gJyMnOgogIG9ja2V0KCkKICAgICAgICAjc2VsZi5zb2NrIGNhbiBiZSBOb25lIGVpdGhlciBiZWNhdXNlIHdlIGhhdmVuJ3QgcmVhY2hlZCB0aGUgcmV0cnkKICAgICAgICAjdGltZSB5ZXQsIG9yIGJlY2F1c2Ugd2UgaGF2ZSByZWFjaGVkIHRoZSByZXRyeSB0aW1lIGFuZCByZXRyaWVkLAogICAgICAgICNidXQgYXJlIHN0aWxsIHVuYWJsZSB0byBjb25uZWN0LgogICAgICAgIGlmIHNlbGYuc29jazoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5zb2NrLnNlbmRhbGwocykKICAgICAgICAgICAgZXhjZXB0IE9TRXJyb3I6ICNwcmFnbWE6IG5vIGNvdmVyCiAgICAgICAgICAgICAgICBzZWxmLnNvY2suY2xvc2UoKQogICAgICAgICAgICAgICAgc2VsZi5zb2NrID0gTm9uZSAgIyBzbyB3ZSBjYW4gY2FsbCBjcmVhdGVTb2NrZXQgbmV4dCB0aW1lCgogICAgZGVmIG1ha2VQaWNrbGUoc2VsZiwgcmVjb3JkKToKICAgICAgICAiIiIKICAgICAgICBQaWNrbGVzIHRoZSByZWNvcmQgaW4gYmluYXJ5IGZvcm1hdCB3aXRoIGEgbGVuZ3RoIHByZWZpeCwgYW5kCiAgICAgICAgcmV0dXJucyBpdCByZWFkeSBmb3IgdHJhbnNtaXNzaW9uIGFjcm9zcyB0aGUgc29ja2V0LgogICAgICAgICIiIgogICAgICAgIGVpID0gcmVjb3JkLmV4Y19pbmZvCiAgICAgICAgaWYgZWk6CiAgICAgICAgICAgICMganVzdCB0byBnZXQgdHJhY2ViYWNrIHRleHQgaW50byByZWNvcmQuZXhjX3RleHQgLi4uCiAgICAgICAgICAgIGR1bW15ID0gc2VsZi5mb3JtYXQocmVjb3JkKQogICAgICAgICMgU2VlIGlzc3VlICMxNDQzNjogSWYgbXNnIG9yIGFyZ3MgYXJlIG9iamVjdHMsIHRoZXkgbWF5IG5vdCBiZQogICAgICAgICMgYXZhaWxhYmxlIG9uIHRoZSByZWNlaXZpbmcgZW5kLiBTbyB3ZSBjb252ZXJ0IHRoZSBtc2cgJSBhcmdzCiAgICAgICAgIyB0byBhIHN0cmluZywgc2F2ZSBpdCBhcyBtc2cgYW5kIHphcCB0aGUgYXJncy4KICAgICAgICBkID0gZGljdChyZWNvcmQuX19kaWN0X18pCiAgICAgICAgZFsnbXNnJ10gPSByZWNvcmQuZ2V0TWVzc2FnZSgpCiAgICAgICAgZFsnYXJncyddID0gTm9uZQogICAgICAgIGRbJ2V4Y19pbmZvJ10gPSBOb25lCiAgICAgICAgIyBJc3N1ZSAjMjU2ODU6IGRlbGV0ZSAnbWVzc2FnZScgaWYgcHJlc2VudDogcmVkdW5kYW50IHdpdGggJ21zZycKICAgICAgICBkLnBvcCgnbWVzc2FnZScsIE5vbmUpCiAgICAgICAgcyA9IHBpY2tsZS5kdW1wcyhkLCAxKQogICAgICAgIHNsZW4gPSBzdHJ1Y3QucGFjaygiPkwiLCBsZW4ocykpCiAgICAgICAgcmV0dXJuIHNsZW4gKyBzCgogICAgZGVmIGhhbmRsZUVycm9yKHNlbGYsIHJlY29yZCk6CiAgICAgICAgIiIiCiAgICAgICAgSGFuZGxlIGFuIGVycm9yIGR1cmluZyBsb2dnaW5nLgoKICAgICAgICBBbiBlcnJvciBoYXMgb2NjdXJyZWQgZHVyaW5nIGxvZ2dpbmcuIE1vc3QgbGlrZWx5IGNhdXNlIC0KICAgICAgICBjb25uZWN0aW9uIGxvc3QuIENsb3NlIHRoZSBzb2NrZXQgc21lcmF0ZV9yZXN1bHRfZ2Moc2VsZik6CiAgICAgICAgIyBicG8tNDI1MzY6IGVudW1lcmF0ZSdzIHR1cGxlLXJldXNlIHNwZWVkIHRyaWNrIGJyZWFrcyB0aGUgR0MncwogICAgICAgICMgYXNzdW1wdGlvbnMgYWJvdXQgd2hhdCBjYW4gYmUgdW50cmFja2VkLiBNYWtlIHN1cmUgd2UgcmUtdHJhY2sgcmVzdWx0CiAgICAgICAgIyB0dXBsZXMgd2hlbmV2ZXIgd2UgcmV1c2UgdGhlbS4KICAgICAgICBpdCA9IHNlbGYuZW51bShbW11dKQogICAgICAgIGdjLmNvbGxlY3QoKQogICAgICAgICMgVGhhdCBHQyBjb2xsZWN0aW9uIHByb2JhYmx5IHVudHJhY2tlZCB0aGUgcmVjeWNsZWQgaW50ZXJuYWwgcmVzdWx0CiAgICAgICAgIyB0dXBsZSwgd2hpY2ggaXMgaW5pdGlhbGl6ZWQgdG8gKE5vbmUsIE5vbmUpLiBNYWtlIHN1cmUgaXQncyByZS10cmFja2VkCiAgICAgICAgIyB3aGVuIGl0J3MgbXV0YXRlZCBhbmQgcmV0dXJuZWQgZnJvbSBfX25leHRfXzoKICAgICAgICBzZWxmLmFzc2VydFRydWUoZ2MuaXNfdHJhY2tlZChuZXh0KGl0KSkpCgpjbGFzcyBNeUVudW0oZW51bWVyYXRlKToKICAgIHBhc3MKCmNsYXNzIFN1YmNsYXNzVGVzdENhc2UoRW51bWVyYXRlVGVzdENhc2UpOgoKICAgIGVudW0gPSBNeUVudW0KCmNsYXNzIFRlc3RFbXB0eShFbnVtZXJhdGVUZXN0Q2FzZSk6CgogICAgc2VxLCByZXMgPSAnJywgW10KCmNsYXNzIFRlc3RCaWcoRW51bWVyYXRlVGVzdENhc2UpOgoKICAgIHNlcSA9IHJhbmdlKDEwLDIwMDAwLDIpCiAgICByZXMgPSBsaXN0KHppcChyYW5nZSgyMDAwMCksIHNlcSkpCgpjbGFzcyBUZXN0UmV2ZXJzZWQodW5pdHRlc3QuVGVzdENhc2UsIFBpY2tsZVRlc3QpOgoKICAgIGRlZiB0ZXN0X3NpbXBsZShzZWxmKToKICAgICAgICBjbGFzcyBBOgogICAgICAgICAgICBkZWYgX19nZXRpdGVtX18oc2VsZiwgaSk6CiAgICAgICAgICAgICAgICBpZiBpIDwgNToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RyKGkpCiAgICAgICAgICAgICAgICByYWlzZSBTdG9wSXRlcmF0aW9uCiAgICAgICAgICAgIGRlZiBfX2xlbl9fKHNlbGYpOgogICAgICAgICAgICAgICAgcmV0dXJuIDUKICAgICAgICBmb3IgZGF0YSBpbiAoJ2FiYycsIHJhbmdlKDUpLCB0dXBsZShlbnVtZXJhdGUoJ2FiYycpKSwgQSgpLAogICAgICAgICAgICAgICAgICAgIHJhbmdlKDEsMTcsNSksIGRpY3QuZnJvbWtleXMoJ2FiY2RlJykpOgogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGxpc3QoZGF0YSlbOjotMV0sIGxpc3QocmV2ZXJzZWQoZGF0YSkpKQogICAgICAgICMgZG9uJ3QgYWxsb3cga2V5d29yZCBhcmd1bWVudHMKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhUeXBlRXJyb3IsIHJldmVyc2VkLCBbXSwgYT0xKQoKICAgIGRlZiB0ZXN0X3JhbmdlX29wdGltaXphdGlvbihzZWxmKToKICAgICAgICB4ID0gcmFuZ2UoMSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHR5cGUocmV2ZXJzZWQoeCkpLCB0eXBlKGl0ZXIoeCkpKQoKIGxwV2lkZ2V0LCBQcm9ncmVzc0JhcldpZGdldCkgZW5jYXBzdWxhdGVzIGluZGl2aWR1YWwgVUkgY29tcG9uZW50cwp3aXRoIHRoZWlyIG93biByZW5kZXJpbmcgbG9naWMsIHByb21vdGluZyBtb2R1bGFyaXR5IGFuZCByZXVzYWJpbGl0eS4gVGhlCnByZXNlbnRhdGlvbiBsYXllciAoQ3Vyc2VzRGlzcGxheS9Nb2NrRGlzcGxheSkgaW1wbGVtZW50cyB0aGUgYWN0dWFsIHJlbmRlcmluZyBmb3IKdGVybWluYWwgb3V0cHV0IGFuZCB0ZXN0aW5nLgoKVGhlIHN5c3RlbSBydW5zIHR3byBpbmRlcGVuZGVudCB1cGRhdGUgbG9vcHMuIFRoZSBzYW1wbGluZyBsb29wIGlzIGRyaXZlbiBieSB0aGUKcHJvZmlsZXIgYXQgdGhlIGNvbmZpZ3VyZWQgaW50ZXJ2YWwgKGUuZy4sIDEwMDAwwrVzKSBhbmQgY29udGludW91c2x5IGNvbGxlY3RzCnN0YWNrIGZyYW1lcyBhbmQgdXBkYXRlcyBzdGF0aXN0aWNzLiBUaGUgZGlzcGxheSBsb29wIHJ1bnMgYXQgYSBmaXhlZCByZWZyZXNoIHJhdGUKKGRlZmF1bHQgMTBIeikgYW5kIHVwZGF0ZXMgdGhlIHRlcm1pbmFsIGluZGVwZW5kZW50bHkgb2Ygc2FtcGxpbmcgZnJlcXVlbmN5LiBUaGlzCnNlcGFyYXRpb24gYWxsb3dzIGhpZ2gtZnJlcXVlbmN5IHNhbXBsaW5nIHdpdGhvdXQgb3ZlcndoZWxtaW5nIHRoZSB0ZXJtaW5hbCB3aXRoCmNvbnN0YW50IHJlZHJhd3MuCgpTdGF0aXN0aWNzIGFyZSBjb21wdXRlZCBpbmNyZW1lbnRhbGx5IGFzIHNhbXBsZXMgYXJyaXZlLiBUaGUgY29sbGVjdG9yIG1haW50YWlucwpydW5uaW5nIGNvdW50ZXJzIChkaXJlY3QgY2FsbHMgYW5kIGN1bXVsYXRpdmUgY2FsbHMpIGluIGEgZGljdGlvbmFyeSBrZXllZCBieQpmdW5jdGlvbiBsb2NhdGlvbi4gRGVyaXZlZCBtZXRyaWNzIGxpa2UgdGltZSBlc3RpbWF0ZXMgYW5kIHBlcmNlbnRhZ2VzIGFyZSBjb21wdXRlZApvbi1kZW1hbmQgZHVyaW5nIGRpc3BsYXkgdXBkYXRlcyByYXRoZXIgdGhhbiBiZWluZyBzdG9yZWQsIHdoaWNoIG1pbmltaXplcyBtZW1vcnkKb3ZlcmhlYWQgYXMgdGhlIG51bWJlciBvZiB0cmFja2VkIGZ1bmN0aW9ucyBncm93cy4KClVzZXIgaW5wdXQgaXMgcHJvY2Vzc2VkIGFzeW5jaHJvbm91c2x5IGR1cmluZyBkaXNwbGF5IHVwZGF0ZXMgdXNpbmcgbm9uLWJsb2NraW5nIEkvTy4KVGhpcyBhbGxvd3MgaW50ZXJhY3RpdmUgY29udHJvbHMgKHNvcnRpbmcsIGZpbHRlcmluZywgcGF1c2luZykgd2l0aG91dCBpbnRlcnJ1cHRpbmcKdGhlIGRhdGEgY29sbGVjdGlvbiBwaXBlbGluZS4gVGhlIGNvbGxlY3RvciBtYWludGFpbnMgbW9kZSBmbGFncyAocGF1c2VkLApmaWx0ZXJfaW5wdXRfbW9kZSkgdGhhdCBhZmZlY3Qgd2hhdCBnZXRzIGRpc3BsYXllZCBidXQgbm90IHdoYXQgZ2V0cyBjb2xsZWN0ZWQuCgoiIiIKCiMgUmUtZXhwb3J0IGFsbCBwdWJsaWMgY2xhc3NlcyBhbmQgY29uc3RhbnRzIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5CmZyb20gLmNvbGxlY3RvciBpbXBvcnQgTGl2ZVN0YXRzQ29sbHJvciwgbGIuZ2V0KQogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFRjbEVycm9yLCBsYi5nZXQsICdlbmQnLCAnbm9pbmRleCcpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoVHlwZUVycm9yLCBsYi5nZXQsIDEsIDIsIDMpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoVGNsRXJyb3IsIGxiLmdldCwgMi40KQoKCkBhZGRfY29uZmlndXJlX3Rlc3RzKFBpeGVsU2l6ZVRlc3RzLCBTdGFuZGFyZE9wdGlvbnNUZXN0cykKY2xhc3MgU2NhbGVUZXN0KEFic3RyYWN0V2lkZ2V0VGVzdCwgdW5pdHRlc3QuVGVzdENhc2UpOgogICAgT1BUSU9OUyA9ICgKICAgICAgICAnYWN0aXZlYmFja2dyb3VuZCcsICdiYWNrZ3JvdW5kJywgJ2JpZ2luY3JlbWVudCcsICdib3JkZXJ3aWR0aCcsCiAgICAgICAgJ2NvbW1hbmQnLCAnY3Vyc29yJywgJ2RpZ2l0cycsICdmb250JywgJ2ZvcmVncm91bmQnLCAnZnJvbScsCiAgICAgICAgJ2hpZ2hsaWdodGJhY2tncm91bmQnLCAnaGlnaGxpZ2h0Y29sb3InLCAnaGlnaGxpZ2h0dGhpY2tuZXNzJywKICAgICAgICAnbGFiZWwnLCAnbGVuZ3RoJywgJ29yaWVudCcsICdyZWxpZWYnLAogICAgICAgICdyZXBlYXRkZWxheScsICdyZXBlYXRpbnRlcnZhbCcsCiAgICAgICAgJ3Jlc29sdXRpb24nLCAnc2hvd3ZhbHVlJywgJ3NsaWRlcmxlbmd0aCcsICdzbGlkZXJyZWxpZWYnLCAnc3RhdGUnLAogICAgICAgICd0YWtlZm9jdXMnLCAndGlja2ludGVydmFsJywgJ3RvJywgJ3Ryb3VnaGNvbG9yJywgJ3ZhcmlhYmxlJywgJ3dpZHRoJywKICAgICkKICAgIF9yb3VuZHNfcGl4ZWxzID0gKHRrX3ZlcnNpb24gPCAoOSwgMCkpCiAgICBfY2xpcHBlZCA9IHsnaGlnaGxpZ2h0dGhpY2tuZXNzJ30KICAgIGRlZmF1bHRfb3JpZW50ID0gJ3ZlcnRpY2FsJwoKICAgIGRlZiBjcmVhdGUoc2VsZiwgKiprd2FyZ3MpOgogICAgICAgIHJldHVybiB0a2ludGVyLlNjYWxlKHNlbGYucm9vdCwgKiprd2FyZ3MpCgogICAgZGVmIHRlc3RfY29uZmlndXJlX2JpZ2luY3JlbWVudChzZWxmKToKICAgICAgICB3aWRnZXQgPSBzZWxmLmNyZWF0ZSgpCiAgICAgICAgc2VsZi5jaGVja0Zsb2F0UGFyYW0od2lkZ2V0LCAnYmlnaW5jcmVtZW50JywgMTIuNCwgMjMuNiwgLTUpCgogICAgZGVmIHRlc3RfY29uZmlndXJlX2RpZ2l0cyhzZWxmKToKICAgICAgICB3aWRnZXQgPSBzZWxmLmNyZWF0ZSgpCiAgICAgICAgc2VsZi5jaGVja0ludGVnZXJQYXJhbSh3aWRnZXQsICdkaWdpdHMnLCA1LCAwKQoKICAgIGRlZiB0ZXN0X2NvbmZpZ3VyZV9mcm9tKHNlbGYpOgogICAgICAgIHdpZGdldCA9IHNlbGYuY3JlYXRlKCkKICAgICAgICBjb252ID0gZmxvYXQgaWYgZ2V0X3RrX3BhdGNobGV2ZWwoc2VsZi5yb290KSA+PSAoOCwgNiwgMTApIGVsc2UgZmxvYXRfcm91bmQKICAgICAgICBzZWxmLmNoZWNrRmxvYXRQYXJhbSh3aWRnZXQsICdmcm9tJywgMTAwLCAxNC45LCAxNS4xLCBjb252PWNvbnYpCgogICAgZGVmIHRlc3RfY29uZmlndXJlX2xhYmVsKHNlaC5hYnNwYXRoKHRtcGRpcikKICAgICAgICAgICAgdGFyZmlsZV9oYW5kbGUgPSB0ZW1wZmlsZS5OYW1lZFRlbXBvcmFyeUZpbGUoc3VmZml4PSIuemlwIiwgZGVsZXRlPUZhbHNlKQogICAgICAgICAgICB0YXJfcGF0aCA9IHRhcmZpbGVfaGFuZGxlLm5hbWUKICAgICAgICAgICAgdGFyZmlsZV9oYW5kbGUuY2xvc2UoKQogICAgICAgICAgICBzZWxmLmFkZENsZWFudXAob3MucmVtb3ZlLCB0YXJfcGF0aCkKCiAgICAgICAgICAgIG1hbGljaW91c19tZW1iZXIgPSBvcy5wYXRoLmpvaW4oYmFzZSArICJhYmMiLCAiZXZpbC50eHQiKQogICAgICAgICAgICB3aXRoIHppcGZpbGUuWmlwRmlsZSh0YXJfcGF0aCwgInciKSBhcyB6ZjoKICAgICAgICAgICAgICAgIHpmLndyaXRlc3RyKG1hbGljaW91c19tZW1iZXIsICJldmlsXG4iKQogICAgICAgICAgICAgICAgemYud3JpdGVzdHIoInRlc3QudHh0IiwgImRhdGFcbiIpCgogICAgICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzTWVzc2FnZSgKICAgICAgICAgICAgICAgIFN1c3BpY2lvdXNPcGVyYXRpb24sICJBcmNoaXZlIGNvbnRhaW5zIGludmFsaWQgcGF0aCIKICAgICAgICAgICAgKToKICAgICAgICAgICAgICAgIGFyY2hpdmUuZXh0cmFjdCh0YXJfcGF0aCwgYmFzZSkKaW1wb3J0IGlvCmltcG9ydCBpdGVydG9vbHMKaW1wb3J0IG1hdGgKaW1wb3J0IHJlCmltcG9ydCBzdHJpbmcKaW1wb3J0IHVuaXR0ZXN0CmltcG9ydCB6aXBmaWxlCgpmcm9tIC5fZnVuY3Rvb2xzIGltcG9ydCBjb21wb3NlCmZyb20gLl9pdGVydG9vbHMgaW1wb3J0IGNvbnN1bWUKZnJvbSAuX3N1cHBvcnQgaW1wb3J0IGltcG9ydF9vcl9za2lwCgpiaWdfbyA9IGltcG9ydF9vcl9za2lwKCdiaWdfbycpCnB5dGVzdCA9IGltcG9ydF9vcl9za2lwKCdweXRlc3QnKQoKCmNsYXNzIFRlc3RDb21wbGV4aXR5KHVuaXR0ZXN0LlRlc3RDYXNlKToKICAgIEBweXRlc3QubWFyay5mbGFreQogICAgZGVmIHRlc3RfaW1wbGllZF9kaXJzX3BlcmZvcm1hbmNlKHNlbGYpOgogICAgICAgIGJlc3QsIG90aGVycyA9IGJpZ19vLmJpZ19vKAogICAgICAgICAgICBjb21wb3NlKGNvbnN1bWUsIHppcGZpbGUuX3BhdGguQ29tcGxldGVEaXJzLl9pbXBsaWVkX2RpcnMpLAogICAgICAgICAgICBsYW1iZGEgc2l6ZTogWwogICAgICAgICAgICAgICAgJy8nLmpvaW4oc3RyaW5nLmFzY2lpX2xvd2VyY2FzZSArIHN0cihuKSkgZm9yIG4gaW4gcmFuZ2Uoc2l6ZSkKICAgICAgICAgICAgXSwKICAgICAgICAgICAgbWF4X249MTAwMCwKICAgICAgICAgICAgbWluX249MSwKICAgICAgICApCiAgICAgICAgYXNzZXJ0IGJlc3QgPD0gYmlnX28uY29tcGxleGl0aWVzLkxpbmVhcgoKICAgIGRlZiBtYWtlX3ppcF9wYXRoKHNlbGYsIGRlcHRoPTEsIHdpZHRoPTEpIC0+IHppcGZpbGUuUGF0aDoKICAgICAgICAiIiIKICAgICAgICBDb25zdHJ1Y3QgYSBQYXRoIHdpdGggd2lkdGggZmlsZXMgYXQgZXZlcnkgbGV2ZWwgb2YgZGVwdGguCiAgICAgMHg5NSAtPiBCVUxMRVQKICAgICdcdTIwMTMnICAgIyAgMHg5NiAtPiBFTiBEQVNICiAgICAnXHUyMDE0JyAgICMgIDB4OTcgLT4gRU0gREFTSAogICAgJ1x1MDJkYycgICAjICAweDk4IC0+IFNNQUxMIFRJTERFCiAgICAnXHUyMTIyJyAgICMgIDB4OTkgLT4gVFJBREUgTUFSSyBTSUdOCiAgICAnXHUwMTYxJyAgICMgIDB4OUEgLT4gTEFUSU4gU01BTEwgTEVUVEVSIFMgV0lUSCBDQVJPTgogICAgJ1x1MjAzYScgICAjICAweDlCIC0+IFNJTkdMRSBSSUdIVC1QT0lOVElORyBBTkdMRSBRVU9UQVRJT04gTUFSSwogICAgJ1x1MDE1MycgICAjICAweDlDIC0+IExBVElOIFNNQUxMIExJR0FUVVJFIE9FCiAgICAnXHg5ZCcgICAgICMgIDB4OUQgLT4gPGNvbnRyb2w+CiAgICAnXHg5ZScgICAgICMgIDB4OUUgLT4gPGNvbnRyb2w+CiAgICAnXHUwMTc4JyAgICMgIDB4OUYgLT4gTEFUSU4gQ0FQSVRBTCBMRVRURVIgWSBXSVRIIERJQUVSRVNJUwogICAgJ1x4YTAnICAgICAjICAweEEwIC0+IE5PLUJSRUFLIFNQQUNFCiAgICAnXHhhMScgICAgICMgIDB4QTEgLT4gSU5WRVJURUQgRVhDTEFNQVRJT04gTUFSSwogICAgJ1x4YTInICAgICAjICAweEEyIC0+IENFTlQgU0lHTgogICAgJ1x4YTMnICAgICAjICAweEEzIC0+IFBPVU5EIFNJR04KICAgICdceGE0JyAgICAgIyAgMHhBNCAtPiBDVVJSRU5DWSBTSUdOCiAgICAnXHhhNScgICAgICMgIDB4QTUgLT4gWUVOIFNJR04KICAgICdceGE2JyAgICAgIyAgMHhBNiAtPiBCUk9LRU4gQkFSCiAgICAnXHhhNycgICAgICMgIDB4QTcgLT4gU0VDVElPTiBTSUdOCiAgICAnXHhhOCcgICAgICMgIDB4QTggLT4gRElBRVJFU0lTCiAgICAnXHhhOScgICAgICMgIDB4QTkgLT4gQ09QWVJJR0hUIFNJR04KICAgICdceGFhJyAgICAgIyAgMHhBQSAtPiBGRU1JTklORSBPUkRJTkFMIElORElDQVRPUgogICAgJ1x4YWInICAgICAjICAweEFCIC0+IExFRlQtUE9JTlRJTkcgRE9VQkxFIEFOR0xFIFFVT1RBVElPTiBNQVJLCiAgICAnXHhhYycgICAgICMgIDB4QUMgLT4gTk9UIFNJR04KICAgICdceGFkJyAgICAgIyAgMHhBRCAtPiBTT0ZUIEhZUEhFTgogICAgJ1x4YWUnICAgICAjICAweEFFIC0+IFJFR0lTVEVSRUQgU0lHTgogICAgJ1x4YWYnICAgICAjICAweEFGIC0+IE1BQ1JPTgogICAgJ1x4YjAnICAgICAjICAweEIwIC0+IERFR1JFRSBTSUdOCiAgICAnXHhiMScgICAgICMgIDB4QjEgLT4gUExVUy1NSU5VUyBTSUdOCiAgICAnXHhiMicgICAgICMgIDB4QjIgLT4gU1VQRVJTQ1JJUFQgVFdPCiAgICAnXHhiMycgICAgICMgIDB4QjMgLT4gU1VQRVJTQ1JJUFQgVEhSRUUKICAgICdceGI0JyAgICAgIyAgMHhCNCAtPiBBQ1VURSBBQ0NFTlQKICAgICdceGI1JyAgICAgIyAgMHhCNSAtPiBNSUNSTyBTSUdOCiAgICAnXHhiNicgICAgICMgIDB4QjYgLT4gUElMQ1JPVyBTSUdOCiAgICAnXHhiNycgICAgICMgIDB4QjcgLT4gTUlERExFIERPVAogICAgJ1x4YjgnICAgICAjICAweEI4IC0+IENFRElMTEEKIDp4OjEwMzoxMDQ6Oi92YXIvd3d3Oi9iaW4vZmFsc2VcbicsCiAgICAgICAgXQogICAgVEVYVCA9IGInJy5qb2luKFRFWFRfTElORVMpCiAgICBEQVRBID0gYidCWmg5MUFZJlNZLlx4YzhOXHgxOFx4MDBceDAxPl9ceDgwXHgwMFx4MTBAXHgwMlx4ZmZceGYwXHgwMVx4MDduXHgwMD9ceGU3XHhmZlx4ZTAwXHgwMVx4OTlceGFhXHgwMFx4YzBceDAzRlx4ODZceDhjIyZceDgzRlx4OWFceDAzXHgwNlx4YTZceGQwXHhhNlx4OTNNXHgwZlFceGE3XHhhOFx4MDZceDgwNGhoXHgxMiRceDExXHhhNGk0XHhmMTRTXHhkMjxRXHhiNVx4MGZIXHhkM1x4ZDRceGRkXHhkNVx4ODdceGJiXHhmOFx4OTRcclx4OGZceGFmSVx4MTJceGUxXHhjOVx4ZjgvRVx4MDBwdVx4ODlceDEyXVx4YzlceGJiRExcblFceDBlXHQxXHgxMlx4ZGZceGEwXHhjMFx4OTdceGFjMk85XHg4OVx4MTNceDk0XHgwZVx4MWM3XHgwZWRceDk1SVx4MGNceGFhSlx4YTRceDE4TFx4MTBceDA1I1x4OWNceGFmXHhiYVx4YmMvXHg5N1x4OGEjQ1x4YzhceGUxXHg4Y1dceGY5XHhlMlx4ZDBceGQ2TVx4YTdceDhiWGE8ZVx4ODR0XHhjYkxceGIzXHhhN1x4ZDlceGNkXHhkMVx4Y2JceDg0Llx4YWZceGIzXHhhYlx4YWJceGFkYG59XHhhMGxoXHRFLFx4OGVaXHgxNVx4MTdWSD5ceDg4XHhlNVx4Y2Q5Z2Q2XHgwYlxuXHhlOVx4OWJceGQ1XHg4YVx4OTlceGY3XHgwOC5LXHg4ZXZceGZiXHhmN3h3XHhiYlx4ZGZceGExXHg5Mlx4ZjFceGRkfC8iO1x4YTJceGJhXHg5Zlx4ZDVceGIxI0FceGI2XHhmNlx4YjNvXHhjOVx4YzV5XFxceGViT1x4ZTdceDg1XHg5YVx4YmNceGI2ZjhceDk1Mlx4ZDVceGQ3IiVceDg5PlYsXHhmN1x4YTZ6XHhlMlx4OWZceGEzXHhkZlx4MTFceDExIlx4ZDZFKUlceGE5XHgxM15ceGNhXHhmM3JceGQwXHgwM1VceDkyMlx4ZjI2XHhlY1x4YjZceGVkXHg4Ylx4YzNVXHgxM1x4OWRceGM1XHgxNzBceGE0XHhmYV5ceDkyXHhhY0RGXHg4YVx4OTdceGQ2XHgxOVx4ZmVceGRkXHhiOFx4YmRceDFhXHg5YVx4MTlceGEzXHg4MGFua1JceDhiXHhlNVx4ZDgzXVx4YTlceGM2XHgwOFx4ODJmXHhmNlx4YjkiNmwkXHhiOGpAXHhjMFx4OGFceGIwbDEuLlx4YmFrXHg4M2xzXHgxNVx4YmNceGY0XHhjMVx4MTNceGJlXHhmOEVceGI4XHg5ZFxyXHhhOFx4OWRrXHg4NFx4ZDNuXHhmYVx4YWNRXHgwN1x4YjEleVx4YWF2XHhiNFx4MDhceGUwelx4MWJceDE2XHhmNVx4MDRceGU5XHhjY1x4YjlceDA4elx4MWVuNy5HXHhmY11ceGM5XHgxNFx4ZTFCQFx4YmIhOGAnCiAgICBFTVBUWV9EQVRBID0gYidCWmg5XHgxN3JFOFBceDkwXHgwMFx4MDBceDAwXHgwMCcKICAgIEJBRF9EQVRBID0gYid0aGlzIGlzIG5vdCBhIHZhbGlkIGJ6aXAyIGZpbGUnCgogICAgIyBTb21lIHRlc3RzIG5lZWQgbW9yZSB0aGFuIG9uZSBibG9jayBvZiB1bmNvbXByZXNzZWQgZGF0YS4gU2luY2Ugb25lIGJsb2NrCiAgICAjIGlzIGF0IGxlYXN0IDEwMCwwMDAgYnl0ZXMsIHdlIGdhdGhlciBzb21lIGRhdGYgcnVuKHNlbGYpIC0+IGxpc3RbYWRkbm9kZXMucHJvZHVjdGlvbmxpc3RdOgogICAgICAgICMgVGhlICJjb250ZW50IiBvZiBhIHByb2R1Y3Rpb25saXN0IGlzIGFjdHVhbGx5IHRoZSBmaXJzdCBhbmQgb25seQogICAgICAgICMgYXJndW1lbnQuIFRoZSBmaXJzdCBsaW5lIGlzIHRoZSBncm91cDsgdGhlIHJlc3QgaXMgdGhlIGNvbnRlbnQgbGluZXMuCiAgICAgICAgbGluZXMgPSBzZWxmLmFyZ3VtZW50c1swXS5zcGxpdGxpbmVzKCkKICAgICAgICBncm91cCA9IGxpbmVzWzBdLnN0cmlwKCkKICAgICAgICBvcHRpb25zID0geydncm91cCc6IGdyb3VwfQogICAgICAgICMgV2UgYXNzdW1lIHRoZXJlJ3MgYSBjb2xvbiBpbiBlYWNoIGxpbmU7IGFsaWduIG9uIGl0LgogICAgICAgIGFsaWduX2NvbHVtbiA9IG1heChsaW5lLmluZGV4KCc6JykgZm9yIGxpbmUgaW4gbGluZXNbMTpdKSArIDEKICAgICAgICBjb250ZW50ID0gW10KICAgICAgICBmb3IgbGluZSBpbiBsaW5lc1sxOl06CiAgICAgICAgICAgIHJ1bGVfbmFtZSwgX2NvbG9uLCB0ZXh0ID0gbGluZS5wYXJ0aXRpb24oJzonKQogICAgICAgICAgICBydWxlX25hbWUgPSBydWxlX25hbWUuc3RyaXAoKQogICAgICAgICAgICBpZiBydWxlX25hbWU6CiAgICAgICAgICAgICAgICBuYW1lX3BhcnQgPSBydWxlX25hbWUgKyAnOicKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG5hbWVfcGFydCA9ICcnCiAgICAgICAgICAgIGNvbnRlbnQuYXBwZW5kKGYne25hbWVfcGFydDo8e2FsaWduX2NvbHVtbn19e3RleHR9JykKICAgICAgICByZXR1cm4gc2VsZi5tYWtlX2dyYW1tYXJfc25pcHBldChvcHRpb25zLCBjb250ZW50KQoKCmRlZiBzZXR1cChhcHA6IFNwaGlueCkgLT4gRXh0ZW5zaW9uTWV0YWRhdGE6CiAgICBhcHAuYWRkX2RpcmVjdGl2ZSgnZ3JhbW1hci1zbmlwcGV0JywgR3JhbW1hclNuaXBwZXREaXJlY3RpdmUpCiAgICBhcHAuYWRkX2RpcmVjdGl2ZV90b19kb21haW4oCiAgICAgICAgJ3N0ZCcsICdwcm9kdWN0aW9ubGlzdCcsIENvbXBhdFByb2R1Y3Rpb25MaXN0LCBvdmVycmlkZT1UcnVlCiAgICApCiAgICByZXR1cm4gewogICAgICAgICd2ZXJzaW9uJzogJzEuMCcsCiAgICAgICAgJ3BhcmFsbGVsX3JlYWRfc2FmZSc6IFRydWUsCiAgICAgICAgJ3BhcmFsbGVsX3dyaXRlX3NhZmUnOiBUcnVlLAogICAgfQoiIiJhc3luY2lvIGV4Y2VwdGlvbnMuIiIiCgoKX19hbGxfXyA9ICgnQnJva2VuQmFycmllckVycm9yJywKICAgICAgICAgICAnQ2FuY2VsbGVkRXJyb3InLCAnSW52YWxpZFN0YXRlRXJyb3InLCAnVGltZW91dEVycm9yJywKICAgICAgICAgICAnSW5jb21wbGV0ZVJlYWRFcnJvcicsICdMaW1pdE92ZXJydW5FcnJvcicsCiAgICAgICAgICAgJ1NlbmRmaWxlTm90QXZhaWxhYmxlRXJyb3InKQoKCmNsYXNzIENhbmNlbGxlZEVycm9yKEJhc2VFeGNlcHRpb24pOgogICAgIiIiVGhlIEZ1dHVyZSBvciBUYXNrIHdhcyBjYW5jZWxsZWQuIiIiCgoKVGltZWFsaWQgdmFsdWUuIgogICAgICAgICk6CiAgICAgICAgICAgIGYuY2xlYW4oWyJpbnZhbGlkX3V1aWQiXSkKCiAgICBkZWYgdGVzdF9tb2RlbF9jaG9pY2VfaW52YWxpZF9wa192YWx1ZV9lcnJvcl9tZXNzYWdlcyhzZWxmKToKICAgICAgICBmID0gZm9ybXMuTW9kZWxDaG9pY2VGaWVsZChVVUlEUEsub2JqZWN0cy5hbGwoKSkKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzTWVzc2FnZSgKICAgICAgICAgICAgVmFsaWRhdGlvbkVycm9yLAogICAgICAgICAgICAiWydTZWxlY3QgYSB2YWxpZCBjaG9pY2UuICIKICAgICAgICAgICAgIlRoYXQgY2hvaWNlIGlzIG5vdCBvbmUgb2YgdGhlIGF2YWlsYWJsZSBjaG9pY2VzLiddIiwKICAgICAgICApOgogICAgICAgICAgICBmLmNsZWFuKCJpbnZhbGlkIikKIiIiQSBtaW5pbWFsIGhvb2sgZm9yIGdhdGhlcmluZyBsaW5lIGNvdmVyYWdlIG9mIHRoZSBzdGFuZGFyZCBsaWJyYXJ5LgoKRGVzaWduZWQgdG8gYmUgdXNlZCB3aXRoIC1YcHJlc2l0ZT0gd2hpY2ggbWVhbnM6CiogaXQgaW5zdGFsbHMgaXRzZWxmIG9uIGltcG9ydAoqIGl0J3Mgbm90IGltcG9ydGVkIGFzIGBfX21haW5fX2Agc28gY2FuJ3QgdXNlIHRoZSBpZm1haW4gaWRpb20KKiBpdCBjYW4ndCBpbXBvcnQgYW55dGhpbmcgYmVzaWRlcyBgc3lzYCB0byBhdm9pZCB0YWludGluZyBnYXRoZXJlZCBjb3ZlcmFnZQoqIGZpbGVuYW1lcyBhcmUgbm90IG5vcm1hbGl6ZWQKClRvIGdldCBnYXRoZXJlZCBjb3ZlcmFnZSBiYWNrLCBsb29rIGZvciAndGVzdC5jb3YnIGluIGBzeXMubW9kdWxlc2AKaW5zdGVhZCBvZiBpbXBvcnRpbmcgZGlyZWN0bHkuIFRoYXQgd2F5IHlvdSBjYW4gZGV0ZXJtaW5lIGlmIHRoZSBtb2R1bGUKd2FzIGFscmVhZHkgaW4gdXNlLgoKSWYgeW91IG5lZWQgdG8gZGlzYWJsZSB0aGUgaG9vaywgY2FsbCB0aGUgYGRpc2FibGUoKWAgZnVuY3Rpb24uCiIiIgoKaW1wb3J0IHN5cwoKbW9uID0gc3lzLm1vbml0b3JpbmcKCkZpbGVOYW1lID0gc3RyCkxpbmVObyA9IGludApMb2NhdGlvbiA9IHR1cGxlW0ZpbGVOYW1lLCBMaW5lTm9dCgpjb3ZlcmFnZTogc2V0W0xvY2F0aW9uXSA9IHNldCgpCgoKIyBgdHlwZXNgIGFuZCBgdHlwaW5nYCBhcmVuJ3QgaW1wb3J0ZWQgdG8gYXZvaWQgaW52YWxpZCBjb3ZlcmFnZQpkZWYgYWRkX2xpbmUoCiAgICBjb2RlOiAidHlwZXMuQ29kZVR5cGUiLAogICAgbGluZW5vOiBpbnQsCikgLT4gInR5cGluZy5MaXRlcmFsW3N5cy5tb25pdG9yaW5nLkRJU0FCTEVdIjoKICAgIGNvdmVyYWdlLmFkZCgoY29kZS5jb19maWxlbmFtZSwgbGluZW5vKSkKICAgIHJldHVybiBtb24uRElTQUJMRQoKCmRlZiBlbmFibGUoKToKICAgIG1vbi51c2VfdG9vbF9pZChtb24uQ09WRVJBR0VfSUQsICJyZWdydGVzdCBjb3ZlcmFnZSIpCiAgICBtb24ucmVnaXN0ZXJfY2FsbGJhY2sobW9uLkNPVkVSQUdFX0lELCBtb24uZXZlbnRzLkxJTkUsIGFkZF9saW5lKQogICAgbW9uLnNldF9ldmVudHMobW9uLjAiKQogICAgLTEyOAogICAgPj4+IGRlY29kZV9sb25nKGIiXHg3ZiIpCiAgICAxMjcKICAgICIiIgogICAgcmV0dXJuIGludC5mcm9tX2J5dGVzKGRhdGEsIGJ5dGVvcmRlcj0nbGl0dGxlJywgc2lnbmVkPVRydWUpCgpkZWYgX1Qob2JqKToKICAgIGNscyA9IHR5cGUob2JqKQogICAgbW9kdWxlID0gY2xzLl9fbW9kdWxlX18KICAgIGlmIG1vZHVsZSBpbiAoTm9uZSwgJ2J1aWx0aW5zJywgJ19fbWFpbl9fJyk6CiAgICAgICAgcmV0dXJuIGNscy5fX3F1YWxuYW1lX18KICAgIHJldHVybiBmJ3ttb2R1bGV9LntjbHMuX19xdWFsbmFtZV9ffScKCgpfTm9WYWx1ZSA9IG9iamVjdCgpCgojIFBpY2tsaW5nIG1hY2hpbmVyeQoKY2xhc3MgX1BpY2tsZXI6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGZpbGUsIHByb3RvY29sPU5vbmUsICosIGZpeF9pbXBvcnRzPVRydWUsCiAgICAgICAgICAgICAgICAgYnVmZmVyX2NhbGxiYWNrPU5vbmUpOgogICAgICAgICIiIlRoaXMgdGFrZXMgYSBiaW5hcnkgZmlsZSBmb3Igd3JpdGluZyBhIHBpY2tsZSBkYXRhIHN0cmVhbS4KCiAgICAgICAgVGhlIG9wdGlvbmFsICpwcm90b2NvbCogYXJndW1lbnQgdGVsbHMgdGhlIHBpY2tsZXIgdG8gdXNlIHRoZQogICAgICAgIGdpdmVuIHByb3RvY29sOyBzdXBwb3J0ZWQgcHJvdG9jb2xzIGFyZSAwLCAxLCAyLCAzLCA0IGFuZCA1LgogICAgICAgIFRoZSBkZWZhdWx0IHByb3RvY29sIGlzIDUuIEl0IHdhcyBpbnRyb2R1Y2VkIGluIFB5dGhvbiAzLjgsIGFuZAogICAgICAgIGlzIGluY29tcGF0aWJsZSB3aXRoIHByZXZpb3VzIHZlcnNpb25zLgoKICAgICAgICBTcGVjaWZ5aW5nIGEgbmVnYXRpdmUgcHJvdG9jb2wgdmVyc2lvbiBzZWxlY3RzIHRoZSBoaWdoZXN0CiAgICAgICAgcHJvdG9jb2wgdmVyc2lvbiBzdXBwb3J0ZWQuICBUaGUgaGlnaGVyIHRoZSBwcm90b2NvbCB1c2VkLCB0aGUKICAgICAgICBtb3JlIHJlY2VudCB0aGUgdmVyc2lvbiBvZiBQeXRob24gbmVlZGVkIHRvIHJlYWQgdGhlIHBpY2tsZQogICAgICAgIHByb2R1Y2VkLgoKICAgICAgICBUaGUgKmZpbGUqIGFyZ3VtZW50IG11c3QgaGF2ZSBhIHdyaXRlKCkgbWV0aG9kIHRoYXQgYWNjZXB0cyBhCiAgICAgICAgc2luZ2xlIGJ5dGVzIGFyZ3VtZW50LiBJdCBjYW4gdGh1cyBiZSBhIGZpbGUgb2JqZWN0IG9wZW5lZCBmb3IKICAgICAgICBiaW5hcnkgd3JpdGluZywgYW4gaW8uQnl0ZXNJTyBpbnN0YW5jZSwgb3IgYW55IG90aGVyIGN1c3RvbQogICAgICAgIG9iamVjdCB0aGF0IG1lZXRzIHRoaXMgaW50ZXJmYWNlLgoKICAgICAgICBJZiAqZml4X2ltcG9ydHMqIGlzIFRydWUgYW5kICpwcm90b2NvbCogaXMgbGVzcyB0aGFuIDMsIHBpY2tsZQogICAgICAgIHdpbGwgdHJ5IHRvIG1hcCB0aGUgbmV3IFB5dGhvbiAzIG5hbWVzIHRvIHRoZSBvbGQgbW9kdWxlIG5hbWVzCiAgICAgICAgdXNlZCBpbiBQeXRob24gMiwgc28gdGhhdCB0aGUgcGlja2xlIGRhdGEgc3RyZWFtIGlzIHJlYWRhYmxlCmYuX3JlYWRlci5jbG9zZSgpCgogICAgZGVmIHdha2V1cChzZWxmKToKICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9jbG9zZWQ6CiAgICAgICAgICAgICAgICBzZWxmLl93cml0ZXIuc2VuZF9ieXRlcyhiIiIpCgogICAgZGVmIGNsZWFyKHNlbGYpOgogICAgICAgIGlmIHNlbGYuX2Nsb3NlZDoKICAgICAgICAgICAgcmFpc2UgUnVudGltZUVycm9yKCdvcGVyYXRpb24gb24gY2xvc2VkIF9UaHJlYWRXYWtldXAnKQogICAgICAgIHdoaWxlIHNlbGYuX3JlYWRlci5wb2xsKCk6CiAgICAgICAgICAgIHNlbGYuX3JlYWRlci5yZWN2X2J5dGVzKCkKCgpkZWYgX3B5dGhvbl9leGl0KCk6CiAgICBnbG9iYWwgX2dsb2JhbF9zaHV0ZG93bgogICAgX2dsb2JhbF9zaHV0ZG93biA9IFRydWUKICAgIGl0ZW1zID0gbGlzdChfdGhyZWFkc193YWtldXBzLml0ZW1zKCkpCiAgICBmb3IgXywgdGhyZWFkX3dha2V1cCBpbiBpdGVtczoKICAgICAgICAjIGNhbGwgbm90IHByb3RlY3RlZCBieSBQcm9jZXNzUG9vbEV4ZWN1dG9yLl9zaHV0ZG93bl9sb2NrCiAgICAgICAgdGhyZWFkX3dha2V1cC53YWtldXAoKQogICAgZm9yIHQsIF8gaW4gaXRlbXM6CiAgICAgICAgdC5qb2luKCkKCiMgUmVnaXN0ZXIgZm9yIGBfcHl0aG9uX2V4aXQoKWAgdG8gYmUgY2FsbGVkIGp1c3QgYmVmb3JlIGpvaW5pbmcgYWxsCiMgbm9uLWRhZW1vbiB0aHJlYWRzLiBUaGlzIGlzIHVzZWQgaW5zdGVhZCBvZiBgYXRleGl0LnJlZ2lzdGVyKClgIGZvcgojIGNvbXBhdGliaWxpdHkgd2l0aCBzdWJpbnRlcnByZXRlcnMsIHdoaWNoIG5vIGxvbmdlciBzdXBwb3J0IGRhZW1vbiB0aHJlYWRzLgojIFNlZSBicG8tMzk4MTIgZm9yIGNvbnRleHQuCnRocmVhZGluZy5fcmVnaXN0ZXJfYXRleGl0KF9weXRob25fZXhpdCkKCiMgQ29udHJvbHMgaG93IG1hbnkgbW9yZSBjYWxscyB0aGFuIHByb2Nlc3NlcyB3aWxsIGJlIHF1ZXVlZCBpbiB0aGUgY2FsbCBxdWV1ZS4KIyBBIHNtYWxsZXIgbnVtYmVyIHdpbGwgbWVhbiB0aGF0IHByb2Nlc3NlcyBzcGVuZCBtb3JlIHRpbWUgaWRsZSB3YWl0aW5nIGZvcgojIHdvcmsgd2hpbGUgYSBsYXJnZXIgbnVtYmVyIHdpbGwgbWFrZSBGdXR1cmUuY2FuY2VsKCkgc3VjY2VlZCBsZXNzIGZyZXF1ZW50bHkKIyAoRnV0dXJlcyBpbiB0aGUgY2FsbCBxdWV1ZSBjYW5ub3QgYmUgY2FuY2VsbGVkKS4KRVhUUkFfUVVFVUVEX0NBTExTID0gMQoKCiMgT24gV2luZG93cywgV2FpdEZvck11bHRpcGxlT2JqZWN0cyBpcyB1c2VkIHRvIHdhaXQgZm9yIHByb2Nlc3NlcyB0byBmaW5pc2guCiMgSXQgY2FuIHdhaXQgb24sIGF0IG1vc3QsIDYzIG9iamVjdHMuIFRoZXJlIGlzIGFuIG92ZXJoZWFkIG9mIHR3byBvYmplY3RzOgojIC0gdGhlIHJlc3VsdCBxdWV1ZSByZWFkZXIKIyAtIHRoZSB0aHJlYWQgd2FrZXVwIHJlYWRlcgpfTUFYX1dJTkRPV1NfV09SS0VSUyA9IDYzIC0gMgoKIyBIYWdlL2pwZWc7IG5hbWU9IkppbSBcIkJvYlwiIEppbGwiJyksCgogICAgICAgICdub25fYXNjaWlfaW5fcGFyYW1zJzogKAogICAgICAgICAgICAoJ2Zvb1x4YTcvYmFyOyBiXHhhN3I9dHdvOyAnCiAgICAgICAgICAgICAgICAnYmF6PXRoclx4YTdlJy5lbmNvZGUoJ2xhdGluLTEnKS5kZWNvZGUoJ3VzLWFzY2lpJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3Vycm9nYXRlZXNjYXBlJykpLAogICAgICAgICAgICAnZm9vXHVGRkZEL2JhcicsCiAgICAgICAgICAgICdmb29cdUZGRkQnLAogICAgICAgICAgICAnYmFyJywKICAgICAgICAgICAgeydiXHVGRkZEcic6ICd0d28nLCAnYmF6JzogJ3Roclx1RkZGRGUnfSwKICAgICAgICAgICAgW2Vycm9ycy5VbmRlY29kYWJsZUJ5dGVzRGVmZWN0XSozLAogICAgICAgICAgICAnZm9v77+9L2JhcjsgYu+/vXI9InR3byI7IGJhej0idGhy77+9ZSInLAogICAgICAgICAgICAjIFhYWCBUd28gYnVncyBoZXJlOiB0aGUgbWltZSB0eXBlIGlzIG5vdCBhbGxvd2VkIHRvIGJlIGFuIGVuY29kZWQKICAgICAgICAgICAgIyB3b3JkLCBhbmQgd2Ugc2hvdWxkbid0IGJlIGVtaXR0aW5nIHN1cnJvZ2F0ZXMgaW4gdGhlIHBhcmFtZXRlcgogICAgICAgICAgICAjIG5hbWVzLiAgQnV0IEkgZG9uJ3Qga25vdyB3aGF0IHRoZSBiZWhhdmlvciBzaG91bGQgYmUgaGVyZSwgc28gSSdtCiAgICAgICAgICAgICMgcHVudGluZyBmb3Igbm93LiAgSW4gcHJhY3RpY2UgdGhpcyBpcyB1bmxpa2VseSB0byBiZSBlbmNvdW50ZXJlZAogICAgICAgICAgICAjIHNpbmNlIGhlYWRlcnMgd2l0aCBiaW5hcnkgaW4gdGhlbSBvbmx5IGNvbWUgZnJvbSBhIGJpbmFyeSBzb3VyY2UKICAgICAgICAgICAgIyBhbmQgYXJlIGFsbW9zdCBjZXJ0YWluIHRvIGJlIHJlLWVtaXR0ZWQgd2l0aG91dCByZWZvbGRpbmcuCiAgICAgICAgICAgICdDb250ZW50LVR5cGU6ID0/dW5rbm93bi04Yml0P3E/Zm9vPUE3Pz0vYmFyOyBiXHVkY2E3cj0idHdvIjtcbicKICAgICAgICAgICAgIiBiYXoqPXVua25vd24tOGJpdCcndGhyJUE3ZVxuIiwKICAgICAgICAgICAgKSwKCiAgICAgICAgIyBSRkMgMjIzMSBwYXJhbWV0ZXIgdGVzdHMuCgogICAgICAgICdyZmMyMjMxX3NlZ21lbnRlZF9ub3JtYWxfdmFsdWVzJzogKAogICAgICAgICAgICAnaW1hZ2UvanBlZzsgbmFtZSowPSJhYmMiOyBuYW1lKjE9Ii5odG1sIicsCiAgICAgICAgICAgICdpbWFnZS9qcGVnJywKICAgICAgICAgICAgJ2ltYWdlJywKICAgICAgICAgICAgJ2pwZWcnLAogICAgICAgICAgICB7J25hbWUnOiAiYWJjLmh0bWwifSwKICAgICAgICAgICAgW10sCiAgICAgICAgICAgICdpbWFnZS9qcGVnOyBuYW1lPSJhYmMuaHRtbCInKSwKCiAgICAgICAgJ3F1b3Rlc19pbnNpZGVfcmZjMjIzMV92YWx1ZSc6ICgKICAgICAgICAgICAgcidpbWFnZS9qcGVnOyBiYXIqMD0iYmF6XCJmb29iYXIiOyBiYXIqMT0iXCJiYXoiJywKIHQub3duZXIgPSBwZXJzb24KCiAgICBkZWYgdGVzdF9yZXZlcnNlX29uZV90b19vbmVfcmVsYXRpb24oc2VsZik6CiAgICAgICAgdXNlciA9IFVzZXIodXNlcm5hbWU9IlNvbWVvbmUiLCBwYXNzd29yZD0iZmFrZV9oYXNoIikKICAgICAgICBwcm9maWxlID0gVXNlclByb2ZpbGUoKQogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXNNZXNzYWdlKFZhbHVlRXJyb3IsIHNlbGYucm91dGVyX3ByZXZlbnRzX21zZyk6CiAgICAgICAgICAgIHVzZXIudXNlcnByb2ZpbGUgPSBwcm9maWxlCiIiIgpnYy5nZXRfcmVmZXJyZXJzKCkgY2FuIGJlIHVzZWQgdG8gc2VlIG9iamVjdHMgYmVmb3JlIHRoZXkgYXJlIGZ1bGx5IGJ1aWx0LgoKTm90ZSB0aGF0IHRoaXMgaXMgb25seSBhbiBleGFtcGxlLiAgVGhlcmUgYXJlIG1hbnkgd2F5cyB0byBjcmFzaCBQeXRob24KYnkgdXNpbmcgZ2MuZ2V0X3JlZmVycmVycygpLCBhcyB3ZWxsIGFzIG1hbnkgZXh0ZW5zaW9uIG1vZHVsZXMgKGV2ZW4Kd2hlbiB0aGV5IGFyZSB1c2luZyBwZXJmZWN0bHkgZG9jdW1lbnRlZCBwYXR0ZXJucyB0byBidWlsZCBvYmplY3RzKS4KCklkZW50aWZ5aW5nIGFuZCByZW1vdmluZyBhbGwgcGxhY2VzIHRoYXQgZXhwb3NlIHRvIHRoZSBHQyBhCnBhcnRpYWxseS1idWlsdCBvYmplY3QgaXMgYSBsb25nLXRlcm0gcHJvamVjdC4gIEEgcGF0Y2ggd2FzIHByb3Bvc2VkIG9uClNGIHNwZWNpZmljYWxseSBmb3IgdGhpcyBleGFtcGxlIGJ1dCBJIGNvbnNpZGVyIGZpeGluZyBqdXN0IHRoaXMgc2luZ2xlCmV4YW1wbGUgYSBiaXQgcG9pbnRsZXNzICgjMTUxNzA0MikuCgpBIGZpeCB3b3VsZCBpbmNsdWRlIGEgd2hvbGUtc2NhbGUgY29kZSByZXZpZXcsIHBvc3NpYmx5IHdpdGggYW4gQVBJCmNoYW5nZSB0byBkZWNvdXBsZSBvYmplY3QgY3JlYXRpb24gYW5kIEdDIHJlZ2lzdHJhdGlvbiwgYW5kIGFjY29yZGluZwpmaXhlcyB0byB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgZXh0ZW5zaW9uIG1vZHVsZSB3cml0ZXJzLiAgSXQncyB1bmxpa2VseQp0byBoYXBwZW4sIHRob3VnaC4gIFNvIHRoaXMgaXMgY3VycmVudGx5IGNsYXNzaWZpZWQgYXMKImdjLmdldF9yZWZlcnJlcnMoKSBpcyBkYW5nZXJvdXMsIHVzZSBvbmx5IGZvciBkZWJ1Z2dpbmciLgoiIiIKCmltcG9ydCBnYwoKCmRlZiBnKCk6CiAgICBtYXJrZXIgPSBvYmplY3QoKQogICAgeWllbGQgbWFya2VyCiAgICAjIG5vdyB0aGUgbWFya2VyIGlzIGluIHRoZSB0dXBsZSBiZWluZyBjb25zdHJ1Y3RlZAogICAgW3R1cF0gPSBbeCBmb3IgeCBpbiBnYy5nZXRfcmVmZXJyZXJzKG1hcmtlcikgaWYgdHlwZSh4KSBpcyB0dXBsZV0KICAgIHByaW50KHR1cCkKICAgIHByaW50KHR1cFsxXSkKCgp0dXBsZShnKCkpCmZyb20gZGphbmdvLmZvcm1zIGltcG9ydCBDaGFyRmllbGQsIEZvcm0sIFBhc3N3b3JkSW5wdXQKCmZyb20gLmJhc2UgaW1wb3J0IFdpZGdldFRlc3QKCgpjbGFzcyBQYXNzd29yZElucHV0VGVzdChXaWRnZXRUZXN0KToKIGVjdHMudXNpbmcoImRlZmF1bHQiKS5nZXQodGl0bGU9IlRoZSBEZWZpbml0aXZlIEd1aWRlIHRvIERqYW5nbyIpCiAgICAgICAgQm9vay5vYmplY3RzLnVzaW5nKCJvdGhlciIpLmdldCh0aXRsZT0iVGhlIERlZmluaXRpdmUgR3VpZGUgdG8gRGphbmdvIikKCiAgICBAb3ZlcnJpZGVfc2V0dGluZ3MoREFUQUJBU0VfUk9VVEVSUz1bQW50aVBldFJvdXRlcigpXSkKICAgIGRlZiB0ZXN0X3BzZXVkb19lbXB0eV9maXh0dXJlcyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBIGZpeHR1cmUgY2FuIGNvbnRhaW4gZW50cmllcywgYnV0IGxlYWQgdG8gbm90aGluZyBpbiB0aGUgZGF0YWJhc2U7CiAgICAgICAgdGhpcyBzaG91bGRuJ3QgcmFpc2UgYW4gZXJyb3IgKCMxNDA2OCkuCiAgICAgICAgIiIiCiAgICAgICAgbmV3X2lvID0gU3RyaW5nSU8oKQogICAgICAgIG1hbmFnZW1lbnQuY2FsbF9jb21tYW5kKCJsb2FkZGF0YSIsICJwZXRzIiwgc3Rkb3V0PW5ld19pbywgc3RkZXJyPW5ld19pbykKICAgICAgICBjb21tYW5kX291dHB1dCA9IG5ld19pby5nZXR2YWx1ZSgpLnN0cmlwKCkKICAgICAgICAjIE5vIG9iamVjdHMgd2lsbCBhY3R1YWxseSBiZSBsb2FkZWQKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKAogICAgICAgICAgICBjb21tYW5kX291dHB1dCwgIkluc3RhbGxlZCAwIG9iamVjdChzKSAob2YgMikgZnJvbSAxIGZpeHR1cmUocykiCiAgICAgICAgKQoKCmNsYXNzIFBpY2tsZVF1ZXJ5U2V0VGVzdENhc2UoVGVzdENhc2UpOgogICAgZGF0YWJhc2VzID0geyJkZWZhdWx0IiwgIm90aGVyIn0KCiAgICBkZWYgdGVzdF9waWNrbGluZyhzZWxmKToKICAgICAgICBmb3IgZGIgaW4gc2VsZi5kYXRhYmFzZXM6CiAgICAgICAgICAgIEJvb2sub2JqZWN0cy51c2luZyhkYikuY3JlYXRlKAogICAgICAgICAgICAgICAgdGl0bGU9IkRpdmUgaW50byBQeXRob24iLCBwdWJsaXNoZWQ9ZGF0ZXRpbWUuZGF0ZSgyMDA5LCA1LCA0KQogICAgICAgICAgICApCiAgICAgICAgICAgIHFzID0gQm9vay5vYmplY3RzLmFsbCgpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocXMuZGIsIHBpY2tsZS5sb2FkcyhwaWNrbGUuZHVtcHMocXMpKS5kYikKCgpjbGFzcyBEYXRhYmFzZVJlY2VpdmVyOgogICAgIiIiCiAgICBVc2VkIGluIHRoZSB0ZXN0cyBmb3IgdGhlIGRhdGFiYXNlIGFyZ3VtZW50IGluIHNpZ25hbHMgKCMxMzU1MikKICAgICIiIgoKICAgIGRlZiBfX2NhbGxfXyhzZWxmLCBzaWduYWwsIHNlbmRlciwgKiprd2FyZ3MpOgogICAgICAgIHNlbGYuX2RhdGFiYXNlID0ga3dhcmdzWyJ1c2luZyJdCgoKY2xhc3MgV3JpdGVUb090aGVyUm91dGVyOgogICAgIiIiCiAgICBBIHJvdXRlciB0aGF0IHNlbmRzIGFsbCB3cml0ZXMgdG8gdGhlIG90aGVyIGRhdGFiYXNlLgogICAgIiIiCgogICAgZGVmIGRiX2Zvcl93cml0ZShzZWxmLCBtb2RlbCwgKipoaW50cyk6CiAgICAgICAgcmV0dXJuICJvdGhlciIKCgpjbGFzcyBTaWduYWxUZXN0c2ljaCBjYW4gb25seSBiZSBpbXBsaWNpdGx5IGV4dGVybiBoZXJlLgogICAgICAgIHJldHVybiBkZWNsLnN0b3JhZ2UgIT0gJ2V4dGVybicKCgpkZWYgaGFzX2ludGVybmFsX3N5bWJvbChkZWNsKToKICAgIGlmIG5vdCBjYW5faGF2ZV9zeW1ib2woZGVjbCk6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICByZXR1cm4gX2luZm8uZ2V0X2FjdHVhbF9zdG9yYWdlKGRlY2wpID09ICdzdGF0aWMnCgoKZGVmIGlzX2V4dGVybmFsX3JlZmVyZW5jZShkZWNsKToKICAgIGlmIG5vdCBjYW5faGF2ZV9zeW1ib2woZGVjbCk6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAjIFdlIGhhdmUgdG8gY2hlY2sgdGhlIGRlY2xhcmVkIHN0b3JhZ2UgcmF0aGVyIHRuYW4gdGhlIGVmZmVjdGl2ZS4KICAgIGlmIGRlY2wuc3RvcmFnZSAhPSAnZXh0ZXJuJzoKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGlmIGRlY2wua2luZCBpcyBfS0lORC5GVU5DVElPTjoKICAgICAgICByZXR1cm4gZGVjbC5zaWduYXR1cmUuaXNmb3J3YXJkCiAgICAjIE90aGVyd2lzZSBpdCdzIGEgdmFyaWFibGUuCiAgICByZXR1cm4gVHJ1ZQoKCmRlZiBpc19sb2NhbF92YXIoZGVjbCk6CiAgICBpZiBub3QgZGVjbC5raW5kIGlzIF9LSU5ELlZBUklBQkxFOgogICAgICAgIHJldHVybiBGYWxzZQogICAgcmV0dXJuIFRydWUgaWYgZGVjbC5wYXJlbnQgZWxzZSBGYWxzZQoKCmRlZiBpc19nbG9iYWxfdmFyKGRlY2wpOgogICAgaWYgbm90IGRlY2wua2luZCBpcyBfS0lORC5WQVJJQUJMRToKICAgICAgICByZXR1cm4gRmFsc2UKICAgIHJldHVybiBGYWxzZSBpZiBkZWNsLnBhcmVudCBlbHNlIFRydWUKCgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMgZmlsdGVyaW5nIHdpdGggbWF0Y2hlcnMKCmRlZiBmaWx0ZXJfYnlfa2luZChpdGVtcywga2luZCk6CiAgICBpZiBraW5kID09ICd0eXBlJzoKICAgICAgICBraW5kcyA9IF9LSU5ELl9UWVBFX0RFQ0xTCiAgICBlbGlmIGtpbmQgPT0gJ2RlY2wnOgogICAgICAgIGtpbmRzID0gX0tJTkQuX1RZUEVfREVDTFMKICAgIHRyeToKICAgICAgICBva2F5ID0ga2luZCBpbiBfS0lORAogICAgZXhjZXB0IFR5cGVFcnJvcjoKICAgICAgICBraW5kcyA9IHNldChraW5kKQogICAgZWxzZToKICAgICAgICBraW5kcyA9IHtraW5kfSBpZiBva2F5IGVsc2Ugc2V0KGtpbmQpCiAgICBmb3IgaXRlbSBpbiBpdGVtczoKICAgICAgICBpZiBpdGVtLmtpbmQgaW4ga2luZHM6CiAgICAgICAgICAgIHlpZWxkIGl0ZW0KCgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMgZ3JvdXBpbmcgd2l0aCBtYXRjaGVycwoKZGVmIGdyb3VwX2J5X2NhdGVnb3J5KGRlY2xzLCBjYXRlZ29yaWVzLCAqLCBpZ25vcmVfbm9uX21hdGNoPVRydWUpOgogICAgY29sbGF0ZWQgPSB7fQogICAgZm9yIGRlY2wgaW4gZGVjbHM6CiAgICAgICAgIyBNYXRjaGVycyBzaG91bGQgYmUgbXV0dWFsbHkgZXhjbHVzaXZlLiAgKEZpcnN0IG1hdGNoIHdpbnMuKS5lcnJvcnMsZW5jb2RpbmdfdGFibGUpWzBdCgpjbGFzcyBJbmNyZW1lbnRhbERlY29kZXIoY29kZWNzLkluY3JlbWVudGFsRGVjb2Rlcik6CiAgICBkZWYgZGVjb2RlKHNlbGYsIGlucHV0LCBmaW5hbD1GYWxzZSk6CiAgICAgICAgcmV0dXJuIGNvZGVjcy5jaGFybWFwX2RlY29kZShpbnB1dCxzZWxmLmVycm9ycyxkZWNvZGluZ190YWJsZSlbMF0KCmNsYXNzIFN0cmVhbVdyaXRlcihDb2RlYyxjb2RlY3MuU3RyZWFtV3JpdGVyKToKICAgIHBhc3MKCmNsYXNzIFN0cmVhbVJlYWRlcihDb2RlYyxjb2RlY3MuU3RyZWFtUmVhZGVyKToKICAgIHBhc3MKCiMjIyBlbmNvZGluZ3MgbW9kdWxlIEFQSQoKZGVmIGdldHJlZ2VudHJ5KCk6CiAgICByZXR1cm4gY29kZWNzLkNvZGVjSW5mbygKICAgICAgICBuYW1lPSdpc284ODU5LTEnLAogICAgICAgIGVuY29kZT1Db2RlYygpLmVuY29kZSwKICAgICAgICBkZWNvZGU9Q29kZWMoKS5kZWNvZGUsCiAgICAgICAgaW5jcmVtZW50YWxlbmNvZGVyPUluY3JlbWVudGFsRW5jb2RlciwKICAgICAgICBpbmNyZW1lbnRhbGRlY29kZXI9SW5jcmVtZW50YWxEZWNvZGVyLAogICAgICAgIHN0cmVhbXJlYWRlcj1TdHJlYW1SZWFkZXIsCiAgICAgICAgc3RyZWFtd3JpdGVyPVN0cmVhbVdyaXRlciwKICAgICkKCgojIyMgRGVjb2RpbmcgVGFibGUKCmRlY29kaW5nX3RhYmxlID0gKAogICAgJ1x4MDAnICAgICAjICAweDAwIC0+IE5VTEwKICAgICdceDAxJyAgICAgIyAgMHgwMSAtPiBTVEFSVCBPRiBIRUFESU5HCiAgICAnXHgwMicgICAgICMgIDB4MDIgLT4gU1RBUlQgT0YgVEVYVAogICAgJ1x4MDMnICAgICAjICAweDAzIC0+IEVORCBPRiBURVhUCiAgICAnXHgwNCcgICAgICMgIDB4MDQgLT4gRU5EIE9GIFRSQU5TTUlTU0lPTgogICAgJ1x4MDUnICAgICAjICAweDA1IC0+IEVOUVVJUlkKICAgICdceDA2JyAgICAgIyAgMHgwNiAtPiBBQ0tOT1dMRURHRQogICAgJ1x4MDcnICAgICAjICAweDA3IC0+IEJFTEwKICAgICdceDA4JyAgICAgIyAgMHgwOCAtPiBCQUNLU1BBQ0UKICAgICdcdCcgICAgICAgIyAgMHgwOSAtPiBIT1JJWk9OVEFMIFRBQlVMQVRJT04KICAgICdcbicgICAgICAgIyAgMHgwQSAtPiBMSU5FIEZFRUQKICAgICdceDBiJyAgICAgIyAgMHgwQiAtPiBWRVJUSUNBTCBUQUJVTEFUSU9OCiAgICAnXHgwYycgICAgICMgIDB4MEMgLT4gRk9STSBGRUVECiAgICAnXHInICAgICAgICMgIDB4MEQgLT4gQ0FSUklBR0UgUkVUVVJOCiAgICAnXHgwZScgICAgICMgIDB4MEUgLT4gU0hJRlQgT1VUCiAgICAnXHgwZicgICAgICMgIDB4MEYgLT4gU0hJRlQgSU4KICAgICdceDEwJyAgICAgIyAgMHgxMCAtPiBEQVRBIExJTksgRVNDQVBFCiAgICAnXHgxMScgICAgICMgIDB4MTEgLT4gREVWSUNFIENPTlRST0wgT05FCiAgICAnXHgxMicgICAgICMgIDB4MTIgLT4gREVWSUNFIENPTlRST0wgVFdPCiAgICAnXHgxMycgICAgICMgIDB4MTMgLT4gREVWSUNFIENPTlRST0wgVEhSRUUKICAgICdceDE0JyAgIHN0b24iLCBmZWF0c1swXS5nZXQoIk5hbWUiKSkKCiAgICAgICAgIyBDbGVhcmluZyB0aGUgc3BhdGlhbCBmaWx0ZXIgYnkgc2V0dGluZyBpdCB0byBOb25lLiBOb3cKICAgICAgICAjIHNob3VsZCBpbmRpY2F0ZSB0aGF0IHRoZXJlIGFyZSAzIGZlYXR1cmVzIGluIHRoZSBMYXllci4KICAgICAgICBseXIuc3BhdGlhbF9maWx0ZXIgPSBOb25lCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgzLCBsZW4obHlyKSkKCiAgICBkZWYgdGVzdDA3X2ludGVnZXJfb3ZlcmZsb3coc2VsZik6CiAgICAgICAgIlRlc3RpbmcgdGhhdCBPRlRSZWFsIGZpZWxkcywgdHJlYXRlZCBhcyBPRlRJbnRlZ2VyLCBkbyBub3Qgb3ZlcmZsb3cuIgogICAgICAgICMgVXNpbmcgKi5kYmYgZnJvbSBDZW5zdXMgMjAxMCBUSUdFUiBTaGFwZWZpbGUgZm9yIFRleGFzLAogICAgICAgICMgd2hpY2ggaGFzIGxhbmQgYXJlYSAoJ0FMQU5EMTAnKSBzdG9yZWQgaW4gYSBSZWFsIGZpZWxkCiAgICAgICAgIyB3aXRoIG5vIHByZWNpc2lvbi4KICAgICAgICBkcyA9IERhdGFTb3VyY2Uob3MucGF0aC5qb2luKFRFU1RfREFUQSwgInRleGFzLmRiZiIpKQogICAgICAgIGZlYXQgPSBkc1swXVswXQogICAgICAgICMgUmVmZXJlbmNlIHZhbHVlIG9idGFpbmVkIHVzaW5nIGBvZ3JpbmZvYC4KICAgICAgICBzZWxmLmFzc2VydEVxdWFsKDY3NjU4Njk5Nzk3OCwgZmVhdC5nZXQoIkFMQU5EMTAiKSkKCiAgICBkZWYgdGVzdF9ub25leGlzdGVudF9maWVsZChzZWxmKToKICAgICAgICBzb3VyY2UgPSBkc19saXN0WzBdCiAgICAgICAgZHMgPSBEYXRhU291cmNlKHNvdXJjZS5kcykKICAgICAgICBtc2cgPSAiaW52YWxpZCBmaWVsZCBuYW1lOiBub25leGlzdGVudCIKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzTWVzc2FnZShHREFMRXhjZXB0aW9uLCBtc2cpOgogICAgICAgICAgICBkc1swXS5nZXRfZmllbGRzKCJub25leGlzdGVudCIpCmZyb20gZGphbmdvLmNvbnRyaWIuc2l0ZXMubW9kZWxzIGltcG9ydCBTaXRlCmZyb20gZGphbmdvLmRiIGltcG9ydCBtb2RlbHMKZnJvbSBkamFuZ28udXJscyBpbXBvcnQgTm9SZXZlcnNlTWF0Y2gsIGdldF9zY3JpcHRfcHJlZml4LCByZXZlcnNlCmZyb20gZGphbmdvLnV0aWxzLmVuY29kaW5nIGltcG9ydCBpcmlfdG9fdXJpCmZyb20gZGphbmdvLnV0aWxzLnRyYW5zbGF0aW9uIGltcG9ydCBnZXR0ZXh0X2xhenkgYXMgXwoKCmNsYXNzIEZsYXRQYWdlKG1vZGVscy5Nb2RlbCk6CiAgICB1cmwgPSBtb2RlbHMuQ2hhckZpZWxkKF8oIlVSTCIpLCBtYXhfbGVuZ3RoPTEwMCwgZGJfaW5kZXg9VHJ1ZSkKICAgIHRpdGxlID0gbW9kZWxzLkNoYXJGaWVsZChfKCJ0aXRsZSIpLCBtYXhfbGVuZ3RoPTIwMCkKICAgIGNvbnRlbnQgPSBtb2RlbHMuVGV4dEZpZWxkKF8oImNvbnRlbnQiKSwgYmxhbms9VHJ1ZSkKICAgIGVuYWJsZV9jb21tZW50cyA9IG1vZGVscy5Cb29sZWFuRmllbGQoXygiZW5hYmxlIGNvbW1lbnRzIiksIGRlZmF1bHQ9RmFscyAgIGNyZWF0ZWQKIyAyMDAzLTExLTE0IGZsICAgZml4ZWQgZGVmYXVsdCBsb2FkZXIKIwojIENvcHlyaWdodCAoYykgMjAwMy0yMDA0IGJ5IEZyZWRyaWsgTHVuZGguICBBbGwgcmlnaHRzIHJlc2VydmVkLgojCiMgZnJlZHJpa0BweXRob253YXJlLmNvbQojIGh0dHA6Ly93d3cucHl0aG9ud2FyZS5jb20KIwojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgVGhlIEVsZW1lbnRUcmVlIHRvb2xraXQgaXMKIwojIENvcHlyaWdodCAoYykgMTk5OS0yMDA4IGJ5IEZyZWRyaWsgTHVuZGgKIwojIEJ5IG9idGFpbmluZywgdXNpbmcsIGFuZC9vciBjb3B5aW5nIHRoaXMgc29mdHdhcmUgYW5kL29yIGl0cwojIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiwgeW91IGFncmVlIHRoYXQgeW91IGhhdmUgcmVhZCwgdW5kZXJzdG9vZCwKIyBhbmQgd2lsbCBjb21wbHkgd2l0aCB0aGUgZm9sbG93aW5nIHRlcm1zIGFuZCBjb25kaXRpb25zOgojCiMgUGVybWlzc2lvbiB0byB1c2UsIGNvcHksIG1vZGlmeSwgYW5kIGRpc3RyaWJ1dGUgdGhpcyBzb2Z0d2FyZSBhbmQKIyBpdHMgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZvciBhbnkgcHVycG9zZSBhbmQgd2l0aG91dCBmZWUgaXMKIyBoZXJlYnkgZ3JhbnRlZCwgcHJvdmlkZWQgdGhhdCB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhcHBlYXJzIGluCiMgYWxsIGNvcGllcywgYW5kIHRoYXQgYm90aCB0aGF0IGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbgojIG5vdGljZSBhcHBlYXIgaW4gc3VwcG9ydGluZyBkb2N1bWVudGF0aW9uLCBhbmQgdGhhdCB0aGUgbmFtZSBvZgojIFNlY3JldCBMYWJzIEFCIG9yIHRoZSBhdXRob3Igbm90IGJlIHVzZWQgaW4gYWR2ZXJ0aXNpbmcgb3IgcHVibGljaXR5CiMgcGVydGFpbmluZyB0byBkaXN0cmlidXRpb24gb2YgdGhlIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMsIHdyaXR0ZW4KIyBwcmlvciBwZXJtaXNzaW9uLgojCiMgU0VDUkVUIExBQlMgQUIgQU5EIFRIRSBBVVRIT1IgRElTQ0xBSU1TIEFMTCBXQVJSQU5USUVTIFdJVEggUkVHQVJECiMgVE8gVEhJUyBTT0ZUV0FSRSwgSU5DTFVESU5HIEFMTCBJTVBMSUVEIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlQtCiMgQUJJTElUWSBBTkQgRklUTkVTUy4gIElOIE5PIEVWRU5UIFNIQUxMIFNFQ1JFVCBMQUJTIEFCIE9SIFRIRSBBVVRIT1IKIyBCRSBMSUFCTEUgRk9SIEFOWSBTUEVDSUFMLCBJTkRJUkVDVCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgT1IgQU5ZCiMgREFNQUdFUyBXSEFUU09FVkVSIFJFU1VMVElORyBGUk9NIExPU1MgT0YgVVNFLCBEQVRBIE9SIFBST0ZJVFMsCiMgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIE5FR0xJR0VOQ0UgT1IgT1RIRVIgVE9SVElPVVMKIyBBQ1RJT04sIEFSSVNJTkcgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgVVNFIE9SIFBFUkZPUk1BTmJ1ZyBpbmZvcm1hdGlvbiIKICAgIHByaW50KHRpdGxlKQogICAgcHJpbnQoIj0iICogbGVuKHRpdGxlKSkKICAgIHByaW50KCkKCiAgICBpbmZvcyA9IGluZm8uZ2V0X2luZm9zKCkKICAgIGluZm9zID0gc29ydGVkKGluZm9zLml0ZW1zKCkpCiAgICBmb3Iga2V5LCB2YWx1ZSBpbiBpbmZvczoKICAgICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoIlxuIiwgIiAiKQogICAgICAgIHByaW50KCIlczogJXMiICUgKGtleSwgdmFsdWUpKQoKCmRlZiBtYWluKCk6CiAgICBpbmZvID0gUHl0aG9uSW5mbygpCiAgICBlcnJvciA9IGNvbGxlY3RfaW5mbyhpbmZvKQogICAgZHVtcF9pbmZvKGluZm8pCgogICAgaWYgZXJyb3I6CiAgICAgICAgcHJpbnQoKQogICAgICAgIHByaW50KCJDb2xsZWN0aW9uIGZhaWxlZDogZXhpdCB3aXRoIGVycm9yIiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIHN5cy5leGl0KDEpCgoKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIG1haW4oKQojIENvcHlyaWdodCAoQykgMjAwMiBQeXRob24gU29mdHdhcmUgRm91bmRhdGlvbgojCiMgQSB0b3J0dXJlIHRlc3Qgb2YgdGhlIGVtYWlsIHBhY2thZ2UuICBUaGlzIHNob3VsZCBub3QgYmUgcnVuIGFzIHBhcnQgb2YgdGhlCiMgc3RhbmRhcmQgUHl0aG9uIHRlc3Qgc3VpdGUgc2luY2UgaXQgcmVxdWlyZXMgc2V2ZXJhbCBtZWcgb2YgZW1haWwgbWVzc2FnZXMKIyBjb2xsZWN0ZWQgaW4gdGhlIHdpbGQuICBUaGVzZSBzb3VyY2UgbWVzc2FnZXMgYXJlIG5vdCBjaGVja2VkIGludG8gdGhlCiMgUHl0aG9uIGRpc3RybywgYnV0IGFyZSBhdmFpbGFibGUgYXMgcGFydCBvZiB0aGUgc3RhbmRhbG9uZSBlbWFpbCBwYWNrYWdlIGF0CiMgaHR0cDovL3NmLm5ldC9wcm9qZWN0cy9taW1lbGliCgppbXBvcnQgc3lzCmltcG9ydCBvcwppbXBvcnQgdW5pdHRlc3QKZnJvbSBpbyBpbXBvcnQgU3RyaW5nSU8KCmZyb20gdGVzdC50ZXN0X2VtYWlsIGltcG9ydCBUZXN0RW1haWxCYXNlCgppbXBvcnQgZW1haWwKZnJvbSBlbWFpbCBpbXBvcnQgX19maWxlX18gYXMgdGVzdGZpbGUKZnJvbSBlbWFpbC5pdGVyYXRvcnMgaW1wb3J0IF9zdHJ1Y3R1cmUKCmRlZiBvcGVuZmlsZShmaWxlbmFtZSk6CiAgICBmcm9tIG9zLnBhdGggaW1wb3J0IGpvaW4sIGRpcm5hbWUsIGFic3BhdGgKICAgIHBhdGggPSBhYnNwYXRoKGpvaW4oZGlybmFtZSh0ZXN0ZmlsZSksIG9zLnBhcmRpciwgJ21vcmVkYXRhJywgZmlsZW5hbWUpKQogICAgcmV0dXJuIG9wZW4ocGF0aCwgJ3InKQoKIyBQcmV2ZW50IHRoaXMgdGVzdCBmcm9tIHJ1bm5pbmcgaW4gdGhlIFB5dGhvbiBkaXN0cm8KZGVmIHNldFVwTW9kdWxlKCk6CiAgICB0cnk6CiAgICAgICAgb3BlbmZpbGUoJ2NyaXNwaW4tdG9ydHVyZS50eHQnKQogICAgZXhjZXB0IE9TRXJyb3I6CiAgICAgICAgcmFpc2UgdW5pdHRlc3QuU2tpcFRlc3QKCgoKY2xhc3MgVG9ydHVyZUJhc2UoVGVzdEVtYWlsQmFzZSk6CiAgICBkZWYgX21zZ29iaihzZWxmLCBmaXJ0IHNobGV4CmltcG9ydCBzaHV0aWwKaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHN5cwpmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKClRFU1RfU0xJQ0VTID0gewogICAgImlPUyI6ICJpb3MtYXJtNjRfeDg2XzY0LXNpbXVsYXRvciIsCn0KCkRFQ09ERV9BUkdTID0gKCJVVEYtOCIsICJiYWNrc2xhc2hyZXBsYWNlIikKCiMgVGhlIHN5c3RlbSBsb2cgcHJlZml4ZXMgZWFjaCBsaW5lOgojICAgMjAyNS0wMS0xNyAxNjoxNDoyOS4wOTM3NDIrMDgwMCBpT1NUZXN0YmVkWzIzOTg3OjFmZDM5M2I0XSAuLi4KIyAgIDIwMjUtMDEtMTcgMTY6MTQ6MjkuMDkzNzQyKzA4MDAgaU9TVGVzdGJlZFsyMzk4NzoxZmQzOTNiNF0gLi4uCgpMT0dfUFJFRklYX1JFR0VYID0gcmUuY29tcGlsZSgKICAgIHIiXlxkezR9LVxkezJ9LVxkezJ9IiAgIyBZWVlZLU1NLURECiAgICByIlxzK1xkKzpcZHsyfTpcZHsyfVwuXGQrXCtcZHs0fSIgICMgSEg6TU06U1Muc3Nzc3NzK1paWloKICAgIHIiXHMraU9TVGVzdGJlZFxbXGQrOlx3K1xdIiAgIyBQcm9jZXNzL3RocmVhZCBJRAopCgoKIyBTZWxlY3QgYSBzaW11bGF0b3IgZGV2aWNlIHRvIHVzZS4KZGVmIHNlbGVjdF9zaW11bGF0b3JfZGV2aWNlKHBsYXRmb3JtKToKICAgICMgTGlzdCB0aGUgdGVzdGluZyBzaW11bGF0b3JzLCBpbiBKU09OIGZvcm1hdAogICAgcmF3X2pzb24gPSBzdWJwcm9jZXNzLmNoZWNrX291dHB1dChbInhjcnVuIiwgInNpbWN0bCIsICJsaXN0IiwgIi1qIl0pCiAgICBqc29uX2RhdGEgPSBqc29uLmxvYWRzKHJhd19qc29uKQoKICAgIGlmIHBsYXRmb3JtID09ICJpT1MiOgogICAgICAgICMgQW55IGlPUyBkZXZpY2Ugd2lsbCBkbzsgd2UnbGwgbG9vayBmb3IgIlNFIiBkZXZpY2VzIC0gYnV0IHRoZSBuYW1lCiAgICAgICAgIyBpc24ndCBjb25zaXN0ZW50IG92ZXIgdGltZS4gT2xkZXIgWGNvZGUgdmVyc2lvbnMgd2lsbCB1c2UgImlQaG9uZSBTRQogICAgICAgICMgKE50aCBnZW5lcmF0aW9uKSI7IEFzIG9mIDIwMjUsIHRoZXkndmUgc3RhcnRlZCB1c2luZyAiaVBob25lIDE2ZSIuCiAgICAgICAgIwogICAgICAgICMgV2hlbiBYY29kZSBpcyB1cGRhdGVkIGFmdGVyIGEgbmV3IHJlbGVhc2UsIG5ldyBkZXZpY2VzIHdpbGwgYmUKICAgICAgICAjIGF2YWlsYWJsZSBhbmQgb2xkIG9uZXMgd2lsbCBiZSBkcm9wcGVkIGZyb20gdGhlIHNldCBhdmFpbGFibGUgb24gdGhlCiAgICAgICAgIyBsYXRlc3QgaU9TIHZlcnNpb24uIFNlbGVjdCB0aGUgb25lIHdpdGggdGhlIGhpZ2hlc3QgbWluaW11bSBydW50aW1lCiAgICAgICAgIyB2ZXJzaW9uIC0gdGhpcyBpcyBhbiBpbmRpY2F0b3Igb2YgdGhlICJuZXdlc3QiIHJlbGVhc2VkIGRldmljZSwgd2hpY2gKICAgICAgICAjIHNob3VsZCBhbHdheXMgYmUgc3VwcG9ydGVkIG9uIHRoZSAibW9zdCByZWNlbnQiIGlPUyB2ZXJzaW9uLgogICAgICAgIHNlX3NpbXVsYXRvcnMgPSBzb3J0ZWQoCiAgICAgICAgICAgIChkZXZpY2V0eXBlWyJtaW5SdXRlIGluIHN0dWR5MS4KICAgIEFueXRoaW5nIG5vdCBzcGVjaWZpY2FsbHkgbWFwcGVkIG90aGVyd2lzZSBiZWNvbWVzICd4Jy4KICAgIEV4YW1wbGU6IHJlcGxhY2UgZXZlcnl0aGluZyBleGNlcHQgd2hpdGVzcGFjZSB3aXRoICd4Jy4KCiAgICA+Pj4ga2VlcHdoaXRlID0gUGFyc2VNYXAoKG9yZChjKSwgb3JkKGMpKSBmb3IgYyBpbiAnIFx0XG5ccicpCiAgICA+Pj4gImEgKyBiXHRjXG5kIi50cmFuc2xhdGUoa2VlcHdoaXRlKQogICAgJ3ggeCB4XHR4XG54JwogICAgIiIiCiAgICAjIENhbGxpbmcgdGhpcyB0cmlwbGVzIGFjY2VzcyB0aW1lOyBzZWUgYnBvLTMyOTQwCiAgICBkZWYgX19taXNzaW5nX18oc2VsZiwga2V5KToKICAgICAgICByZXR1cm4gMTIwICAjIG9yZCgneCcpCgoKIyBNYXAgYWxsIGFzY2lpIHRvIDEyMCB0byBhdm9pZCBfX21pc3NpbmdfXyBjYWxsLCB0aGVuIHJlcGxhY2Ugc29tZS4KdHJhbnMgPSBQYXJzZU1hcC5mcm9ta2V5cyhyYW5nZSgxMjgpLCAxMjApCnRyYW5zLnVwZGF0ZSgob3JkKGMpLCBvcmQoJygnKSkgZm9yIGMgaW4gIih7WyIpICAjIG9wZW4gYnJhY2tldHMgPT4gJygnOwp0cmFucy51cGRhdGUoKG9yZChjKSwgb3JkKCcpJykpIGZvciBjIGluICIpfV0iKSAgIyBjbG9zZSBicmFja2V0cyA9PiAnKScuCnRyYW5zLnVwZGF0ZSgob3JkKGMpLCBvcmQoYykpIGZvciBjIGluICJcIidcXFxuIyIpICAjIEtlZXAgdGhlc2UuCgoKY2xhc3MgUGFyc2VyOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBpbmRlbnR3aWR0aCwgdGFid2lkdGgpOgogICAgICAgIHNlbGYuaW5kZW50d2lkdGggPSBpbmRlbnR3aWR0aAogICAgICAgIHNlbGYudGFid2lkdGggPSB0YWJ3aWR0aAoKICAgIGRlZiBzZXRfY29kZShzZWxmLCBzKToKICAgICAgICBhc3NlcnQgbGVuKHMpID09IDAgb3Igc1stMV0gPT0gJ1xuJwogICAgICAgIHNlbGYuY29kZSA9IHMKICAgICAgICBzZWxmLnN0dWR5X2xldmVsID0gMAoKICAgIGRlZiBmaW5kX2dvb2RfcGFyc2Vfc3RhcnQoc2VsZiwgaXNfY2hhcl9pbl9zdHJpbmcpOgogICAgICAgICIiIgogICAgICAgIFJldHVybiBpbmRleCBvZiBhIGdvb2QgcGxhY2UgdG8gYmVnaW4gcGFyc2luZywgYXMgY2xvc2UgdG8gdGhlCiAgICAgICAgZW5kIG9mIHRoZSBzdHJpbmcgYXMgcG9zc2libGUuICBUaGlzIHdpbGwgYmUgdGhlIHN0YXJ0IG9mIHNvbWUKICAgICAgICBwb3B1bGFyIHN0bXQgbGlrZSAiaWYiIG9yICJkZWYiLiAgUmV0dXJuIE5vbmUgaWYgbm9uZSBmb3VuZDoKICAgICAgICB0aGUgY2FsbGVyIHNob3VsZCBwYXNzIG1vcmUgcHJpb3IgY29udGV4dCB0aGVuLCBpZiBwb3NzaWJsZSwgb3IKICAgICAgICBpZiBub3QgKHRoZSBlbnRpcmUgcHJvZ3JhbSB0ZXh0IHVwIHVudGlsIHRoZSBwb2ludCBvZiBpbnRlcmVzdAogICAgICAgIGhhcyBhbHJlYWR5IGJlZW4gdHJpZWQpIHBhc3MgMCB0byBzZXRfbG8oKS4KCiAgICAgICAgVGhpcyB3aWxsIGJlIHJlbGlhYmxlIGlmZiBnaXZlbiBhIHJlIHJlcHIoKSBvZiBlYWNoIG9iamVjdCB3aGlsZSB0aGUgaW50ZXJwcmV0ZXIgaXMgc3RpbGwgZnVsbHkgaW50YWN0LgpBZnRlciBjbGVhbmluZyB1cCBldmVyeXRoaW5nIGl0IGNhbiwgaXQgcHJpbnRzIGFsbCByZW1haW5pbmcgbGl2ZSBvYmplY3RzCmFnYWluLCBidXQgdGhlIHNlY29uZCB0aW1lIGp1c3QgcHJpbnRzIHRoZWlyIGFkZHJlc3NlcywgcmVmY291bnRzLCBhbmQgdHlwZQpuYW1lcyAoYmVjYXVzZSB0aGUgaW50ZXJwcmV0ZXIgaGFzIGJlZW4gdG9ybiBkb3duLCBjYWxsaW5nIHJlcHIgbWV0aG9kcyBhdAp0aGlzIHBvaW50IGNhbiBnZXQgaW50byBpbmZpbml0ZSBsb29wcyBvciBibG93IHVwKS4KClNhdmUgYWxsIHRoaXMgb3V0cHV0IGludG8gYSBmaWxlLCB0aGVuIHJ1biB0aGlzIHNjcmlwdCBwYXNzaW5nIHRoZSBwYXRoIHRvCnRoYXQgZmlsZS4gIFRoZSBzY3JpcHQgZmluZHMgYm90aCBvdXRwdXQgY2h1bmtzLCBjb21iaW5lcyB0aGVtLCB0aGVuIHByaW50cwphIGxpbmUgb2Ygb3V0cHV0IGZvciBlYWNoIG9iamVjdCBzdGlsbCBhbGl2ZSBhdCB0aGUgZW5kOgoKICAgIGFkZHJlc3MgcmVmY250IHR5cGVuYW1lIHJlcHIKCmFkZHJlc3MgaXMgdGhlIGFkZHJlc3Mgb2YgdGhlIG9iamVjdCwgaW4gd2hhdGV2ZXIgZm9ybWF0IHRoZSBwbGF0Zm9ybSBDCnByb2R1Y2VzIGZvciBhICVwIGZvcm1hdCBjb2RlLgoKcmVmY250IGlzIG9mIHRoZSBmb3JtCgogICAgIlsiIHJlZiAiXSIKCndoZW4gdGhlIG9iamVjdCdzIHJlZmNvdW50IGlzIHRoZSBzYW1lIGluIGJvdGggUFlUSE9ORFVNUFJFRlMgb3V0cHV0IGJsb2NrcywKb3IKCiAgICAiWyIgcmVmX2JlZm9yZSAiLT4iIHJlZl9hZnRlciAiXSIKCmlmIHRoZSByZWZjb3VudCBjaGFuZ2VkLgoKdHlwZW5hbWUgaXMgUHlfVFlQRShvYmplY3QpLT50cF9uYW1lLCBleHRyYWN0ZWQgZnJvbSB0aGUgc2Vjb25kIFBZVEhPTkRVTVBSRUZTCm91dHB1dCBibG9jay4KCnJlcHIgaXMgcmVwcihvYmplY3QpLCBleHRyYWN0ZWQgZnJvbSB0aGUgZmlyc3QgUFlUSE9ORFVNUFJFRlMgb3V0cHV0IGJsb2NrLgpDQVVUSU9OOiAgSWYgb2JqZWN0IGlzIGEgY29udGFpbmVyIHR5cGUsIGl0IG1heSBub3QgYWN0dWFsbHkgY29udGFpbiBhbGwgdGhlCm9iamVjdHMgc2hvd24gaW4gdGhlIHJlcHI6ICB0aGUgcmVwciB3YXMgY2FwdHVyZWQgZnJvbSB0aGUgZmlyc3Qgb3V0cHV0IGJsb2NrLAphbmQgc29tZSBvZiB0aGUgY29udGFpbmVlcyBtYXkgaGF2ZSBiZWVuIHJlbGVhc2VkIHNpbmNlIHRoZW4uICBGb3IgZXhhbXBsZSwKaXQncyBjb21tb24gZm9yIHRoZSBsaW5lIHNob3dpbmcgdGhlIGRpY3Qgb2YgaW50ZXJuZWQgc3RyaW5ncyB0byBkaXNwbGF5CnN0cmluZ3MgdGhhdCBubyBsb25nZXIgZXhpc3QgYXQgdGhlIGVuZCBvZiBQeV9GaW5hbGl6ZUV4OyB0aGlzIGNhbiBiZSByZWNvZ25pemVkCihhbGJlaXQgcGFpbmZ1bGx5KSBiZWNhdXNlIHN1Y2ggY29udGFpbmVlcyBkb24ndCBoYXZlIGEgbGluYmFjb24tdmFsdWUiLCBib2R5X2h0bWwpCgogICAgZGVmIHZlcmlmeV9wYXJhbm9pZF9lbWFpbChzZWxmLCB2aWV3KToKICAgICAgICAiIiIKICAgICAgICBBc3NlcnRzIHRoYXQgbm8gdmFyaWFibGVzIG9yIFBPU1QgcGFyYW1ldGVycyBhcmUgZGlzcGxheWVkIGluIHRoZSBlbWFpbAogICAgICAgIHJlcG9ydC4KICAgICAgICAiIiIKICAgICAgICB3aXRoIHNlbGYuc2V0dGluZ3MoQURNSU5TPVsiYWRtaW5AZXhhbXBsZS5jb20iXSk6CiAgICAgICAgICAgIG1haWwub3V0Ym94ID0gW10gICMgRW1wdHkgb3V0Ym94CiAgICAgICAgICAgIHJlcXVlc3QgPSBzZWxmLnJmLnBvc3QoIi9zb21lX3VybC8iLCBzZWxmLmJyZWFrZmFzdF9kYXRhKQogICAgICAgICAgICB2aWV3KHJlcXVlc3QpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwobGVuKG1haWwub3V0Ym94KSwgMSkKICAgICAgICAgICAgZW1haWwgPSBtYWlsLm91dGJveFswXQogICAgICAgICAgICAjIEZyYW1lcyB2YXJzIGFyZSBuZXZlciBzaG93biBpbiBwbGFpbiB0ZXh0IGVtYWlsIHJlcG9ydHMuCiAgICAgICAgICAgIGJvZHkgPSBzdHIoZW1haWwuYm9keSkKICAgICAgICAgICAgc2VsZi5hc3NlcnROb3RJbigiY29va2VkX2VnZ3MiLCBib2R5KQogICAgICAgICAgICBzZWxmLmFzc2VydE5vdEluKCJzY3JhbWJsZWQiLCBib2R5KQogICAgICAgICAgICBzZWxmLmFzc2VydE5vdEluKCJzYXVjZSIsIGJvZHkpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0Tm90SW4oIndvcmNlc3RlcnNoaXJlIiwgYm9keSkKICAgICAgICAgICAgZm9yIGssIHYgaW4gc2VsZi5icmVha2Zhc3RfZGF0YS5pdGVtcygpOgogICAgICAgICAgICAgICAgIyBBbGwgUE9TVCBwYXJhbWV0ZXJzJyBuYW1lcyBhcmUgc2hvd24uCiAgICAgICAgICAgICAgICBzZWxmLmFzc2VydEluKGssIGJvZHkpCiAgICAgICAgICAgICAgICAjIE5vIFBPU1QgcGFyYW1ldGVycycgdmFsdWVzIGFyZSBzaG93bi4KICAgICAgICAgICAgICAgIHNlbGYuYXNzZXJ0Tm90SW4odiwgYm9keSkKCgpAb3ZlcnJpZGVfc2V0dGluZ3MoUk9PVF9VUkxDT05GPSJ2aWV3X3Rlc3RzLnVybHMiKQpjbGFzcyBFeGNlcHRpb25SZXBvcnRlckZpbHRlclRlc3RzKAogICAgRXhjZXB0aW9uUmVwb3J0VGVzdE1peGluLCBMb2dnaW5nQ2FwdHVyZU1peGluLCBTaW1wbGVUZXN0Q2FzZQopOgogICAgIiIiCiAgICBTZW5zaXRpdmUgaW5mb3JtYXRpb24gY2FuIGJlIGZpbHRlcmVkIG91dCBvZiBlcnJvciByZXBvcnRzICgjMTQ2MTQpLgogICAgIiIiCgogICAgcmYgPSBSZXF1ZXN0RmFjdG9yeSgpCiAgICBzZW5zaXRpdmVfc2V0dGluZ3MgPSBbCiAgICAgICAgIlNFQ1JFVF9LRVkiLAogICAgICAgICJTRUNSRVRfS0VZX0ZBTExCQUNLUyIsCiAgICAgICAgIlBBU1NXT1JEIiwKICAgICAgICAiQVBJX0tFWSIsCiAgICAgICAgIlNPTUVfVE9LRU4iLAogICAgICAgICJNWV9BVVRIIiwKICAgIF0KCiAgICBkZWYgdGVzdF9ub25fc2Vuc2l0aXZlX3JlcXVlcmliIGFwcHMuLi4iKQogICAgY2FsbF9jb21tYW5kKCJtYWtlbWVzc2FnZXMiLCBsb2NhbGU9WyJlbiJdLCBkb21haW49ImRqYW5nb2pzIiwgdmVyYm9zaXR5PXZlcmJvc2l0eSkKCiAgICAjIE91dHB1dCBjaGFuZ2VkIHN0YXRzCiAgICBfY2hlY2tfZGlmZigiY29yZSIsIG9zLnBhdGguam9pbihvcy5nZXRjd2QoKSwgImNvbmYiLCAibG9jYWxlIikpCiAgICBmb3IgbmFtZSwgZGlyXyBpbiBjb250cmliX2RpcnM6CiAgICAgICAgX2NoZWNrX2RpZmYobmFtZSwgZGlyXykKCgpkZWYgbGFuZ19zdGF0cyhyZXNvdXJjZXM9Tm9uZSwgbGFuZ3VhZ2VzPU5vbmUsIHZlcmJvc2l0eT0wKToKICAgICIiIgogICAgT3V0cHV0IGxhbmd1YWdlIHN0YXRpc3RpY3Mgb2YgY29tbWl0dGVkIHRyYW5zbGF0aW9uIGZpbGVzIGZvciBlYWNoCiAgICBEamFuZ28gY2F0YWxvZy4KICAgIElmIHJlc291cmNlcyBpcyBwcm92aWRlZCwgaXQgc2hvdWxkIGJlIGEgbGlzdCBvZiB0cmFuc2xhdGlvbiByZXNvdXJjZSB0bwogICAgbGltaXQgdGhlIG91dHB1dCAoZS5nLiBbJ2NvcmUnLCAnZ2lzJ10pLgogICAgIiIiCiAgICBsb2NhbGVfZGlycyA9IF9nZXRfbG9jYWxlX2RpcnMocmVzb3VyY2VzKQoKICAgIGZvciBuYW1lLCBkaXJfIGluIGxvY2FsZV9kaXJzOgogICAgICAgIHByaW50KCJcblNob3dpbmcgdHJhbnNsYXRpb25zIHN0YXRzIGZvciAnJXMnOiIgJSBuYW1lKQogICAgICAgIGxhbmdzID0gc29ydGVkKGQgZm9yIGQgaW4gb3MubGlzdGRpcihkaXJfKSBpZiBub3QgZC5zdGFydHN3aXRoKCJfIikpCiAgICAgICAgZm9yIGxhbmcgaW4gbGFuZ3M6CiAgICAgICAgICAgIGlmIGxhbmd1YWdlcyBhbmQgbGFuZyBub3QgaW4gbGFuZ3VhZ2VzOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgIyBUT0RPOiBtZXJnZSBmaXJzdCB3aXRoIHRoZSBsYXRlc3QgZW4gY2F0YWxvZwogICAgICAgICAgICBwb19wYXRoID0gIntwYXRofS97bGFuZ30vTENfTUVTU0FHRVMvZGphbmdve2V4dH0ucG8iLmZvcm1hdCgKICAgICAgICAgICAgICAgIHBhdGg9ZGlyXywgbGFuZz1sYW5nLCBleHQ9ImpzIiBpZiBuYW1lLmVuZHN3aXRoKCItanMiKSBlbHNlICIiCiAgICAgICAgICAgICkKICAgICAgICAgICAgcCA9IHJ1bigKICAgICAgICAgICAgICAgIFsibXNnZm10IiwgIi12YyIsICItbyIsICIvZGV2L251bGwiLCBwb19wYXRoXSwKICAgICAgICAgICAgICAgIGNhcHR1cmVfb3V0cHV0PVRydWUsCiAgICAgICAgICAgICAgICBlbnY9eyJMQU5HIjogIkMifSwKICAgICAgICAgICAgICAgIGVuY29kaW5nPSJ1dGYtOCIsCiAgICAgICAgICAgICAgICB2ZXJib3NpdHk9dmVyYm9zaXR5LAogICAgICAgICAgICApCiAgICAgICAgICAgIGlmIHAucmV0dXJuY29kZSA9PSAwOgogICAgICAgICAgICAgICAgIyBtc2dmbXQgb3V0cHV0IHN0YXRzIG9uIHN0ZGVycgogICAgICAgICAgICAgICAgcHJpbnQoIiVzOiAlcyIgJSAobGFuZywgcC5zdGRlcnIuc3RyaXAoKSkpCiAgc2l6ZSBvZiB0aGUgYWdncmVnYXRlIChyb3VuZGVkIHVwIHRvIGFsaWdubWVudCkKICAgICAgICBzZWxmLnNpemUgPSBzaXplCgogICAgICAgICMgdG90YWwgYWxpZ25tZW50IHJlcXVpcmVtZW50IG9mIHRoZSBhZ2dyZWdhdGUKICAgICAgICBzZWxmLmFsaWduID0gYWxpZ24KCiAgICAgICAgIyBidWZmZXIgZm9ybWF0IHNwZWNpZmljYXRpb24gKGFzIGEgc3RyaW5nLCBVVEYtOCBidXQgYmVzCiAgICAgICAgIyBrZXB0IEFTQ0lJLW9ubHkpCiAgICAgICAgc2VsZi5mb3JtYXRfc3BlYyA9IGZvcm1hdF9zcGVjCgoKZGVmIGdldF9sYXlvdXQoY2xzLCBpbnB1dF9maWVsZHMsIGlzX3N0cnVjdCwgYmFzZSk6CiAgICAiIiJSZXR1cm4gYSBTdHJ1Y3RVbmlvbkxheW91dCBmb3IgdGhlIGdpdmVuIGNsYXNzLgoKICAgIENhbGxlZCBieSBQeUNTdHJ1Y3RVbmlvblR5cGVfdXBkYXRlX3N0Z2luZm8gd2hlbiBfZmllbGRzXyBpcyBhc3NpZ25lZAogICAgdG8gYSBjbGFzcy4KICAgICIiIgogICAgIyBDdXJyZW50bHkgdGhlcmUgYXJlIHR3byBtb2Rlcywgc2VsZWN0YWJsZSB1c2luZyB0aGUgJ19sYXlvdXRfJyBhdHRyaWJ1dGU6CiAgICAjCiAgICAjICdnY2Mtc3lzdicgbW9kZSBwbGFjZXMgZmllbGRzIG9uZSBhZnRlciBhbm90aGVyLCBiaXQgYnkgYml0LgogICAgIyAgIEJ1dCAiZWFjaCBiaXQgZmllbGQgbXVzdCBmaXQgd2l0aGluIGEgc2luZ2xlIG9iamVjdCBvZiBpdHMgc3BlY2lmaWVkCiAgICAjICAgdHlwZSIgKEdDQyBtYW51YWwsIHNlY3Rpb24gMTUuOCAiQml0IEZpZWxkIFBhY2tpbmciKS4gV2hlbiBpdCBkb2Vzbid0LAogICAgIyAgIHdlIGluc2VydCBhIGZldyBiaXRzIG9mIHBhZGRpbmcgdG8gYXZvaWQgdGhhdC4KICAgICMKICAgICMgJ21zJyBtb2RlIHdvcmtzIHNpbWlsYXIgZXhjZXB0IGZvciBiaXRmaWVsZCBwYWNraW5nLiAgQWRqYWNlbnQKICAgICMgICBiaXQtZmllbGRzIGFyZSBwYWNrZWQgaW50byB0aGUgc2FtZSAxLSwgMi0sIG9yIDQtYnl0ZSBhbGxvY2F0aW9uIHVuaXQKICAgICMgICBpZiB0aGUgaW50ZWdyYWwgdHlwZXMgYXJlIHRoZSBzYW1lIHNpemUgYW5kIGlmIHRoZSBuZXh0IGJpdC1maWVsZCBmaXRzCiAgICAjICAgaW50byB0aGUgY3VycmVudCBhbGxvY2F0aW9uIHVuaXQgd2l0aG91dCBjcm9zc2luZyB0aGUgYm91bmRhcnkgaW1wb3NlZAogICAgIyAgIGJ5IHRoZSBjb21tb24gYWxpZ25tZW50IHJlcXVpcmVtZW50cyBvZiB0aGUgYml0LWZpZWxkcy4KICAgICMKICAgICMgICBTZWUgaHR0cHM6Ly9nY2MuZ251Lm9yZy9vbmxpbmVkb2NzL2djYy94ODYtT3B0aW9ucy5odG1sI2luZGV4LW1tcy1iaXRmaWVsZHMKICAgICMgICBmb3IgZGV0YWlscy4KCiAgICAjIFdlIGRvIG5vdCBzdXBwb3J0IHplcm8gbGVuZ3RoIGJpdGZpZWxkcyAod2UgdXNlIGJpdHNpemUgIT0gMAogICAgIyBlbHNld2hlcmUgdG8gaW5kaWNhdGUgYSBiaXRmaWVsZCkuIEhlcmUsIG5vbi1iaXRmaWVsZHMgaGF2ZSBiaXRfc2l6ZQogICBlY3RzLmZpbHRlcihkZXBhcnRtZW50X19ndGU9MCkKCiAgICBkZWYgdGVzdF9yZWxhdGVkX2x0ZV9sb29rdXAoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmVncmVzc2lvbiB0ZXN0IGZvciAjMTAxNTM6IGZvcmVpZ24ga2V5IF9fbHRlIGxvb2t1cHMuCiAgICAgICAgIiIiCiAgICAgICAgV29ya2VyLm9iamVjdHMuZmlsdGVyKGRlcGFydG1lbnRfX2x0ZT0wKQoKICAgIGRlZiB0ZXN0X3NxbF9pbnNlcnRfY29tcGlsZXJfcmV0dXJuX2lkX2F0dHJpYnV0ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBSZWdyZXNzaW9uIHRlc3QgZm9yICMxNDAxOTogU1FMSW5zZXJ0Q29tcGlsZXIuYXNfc3FsKCkgZmFpbHVyZQogICAgICAgICIiIgogICAgICAgIGRiID0gcm91dGVyLmRiX2Zvcl93cml0ZShQYXJ0eSkKICAgICAgICBxdWVyeSA9IEluc2VydFF1ZXJ5KFBhcnR5KQogICAgICAgIHF1ZXJ5Lmluc2VydF92YWx1ZXMoW1BhcnR5Ll9tZXRhLmZpZWxkc1swXV0sIFtdLCByYXc9RmFsc2UpCiAgICAgICAgIyB0aGlzIGxpbmUgd2lsbCByYWlzZSBhbiBBdHRyaWJ1dGVFcnJvciB3aXRob3V0IHRoZSBhY2NvbXBhbnlpbmcgZml4CiAgICAgICAgcXVlcnkuZ2V0X2NvbXBpbGVyKHVzaW5nPWRiKS5hc19zcWwoKQoKICAgIGRlZiB0ZXN0X2VtcHR5X2Nob2ljZShzZWxmKToKICAgICAgICAjIE5PVEU6IFBhcnQgb2YgdGhlIHJlZ3Jlc3Npb24gdGVzdCBoZXJlIGlzIG1lcmVseSBwYXJzaW5nIHRoZSBtb2RlbAogICAgICAgICMgZGVjbGFyYXRpb24uIFRoZSB2ZXJib3NlX25hbWUsIGluIHBhcnRpY3VsYXIsIGRpZCBub3QgYWx3YXlzIHdvcmsuCiAgICAgICAgYSA9IEFydGljbGUub2JqZWN0cy5jcmVhdGUoCiAgICAgICAgICAgIGhlYWRsaW5lPSJMb29rIGF0IG1lISIsIHB1Yl9kYXRlPWRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgKQogICAgICAgICMgQW4gZW1wdHkgY2hvaWNlIGZpZWxkIHNob3VsZCByZXR1cm4gTm9uZSBmb3IgdGhlIGRpc3BsYXkgbmFtZS4KICAgICAgICBzZWxmLmFzc2VydElzKGEuZ2V0X3N0YXR1c19kaXNwbGF5KCksIE5vbmUpCgogICAgICAgICMgRW1wdHkgc3RyaW5ncyBzaG91bGQgYmUgcmV0dXJuZWQgYXMgc3RyaW5nCiAgICAgICAgYSA9IEFydGljbGUub2JqZWN0cy5nZXQocGs9YS5waykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGEubWlzY19kYXRhLCAiIikKCiAgICBkZWYgdGVzdF9sb25nX3RleHRmaWVsZChzZWxmKToKICAgICAgICAjIFRleHRGaWVsZHMgY2FuIGhvbGQgbW9yZSB0aGFuIDQwMDAgY2hhcmFjdGVycyAodGhpcyB3YXMgYnJva2VuIGluCiAgICAgICAgIyBPcmFjbGUpLgogICAgICAgIGEgPSBBcnRpY2xlLm9iamVjdHMuY3JlYXRlKAogICAgICAgICAgICBoZWFkbGluZT0iUmVhbGx5LCByZWFsbHkgYmlnIiwKICAgICAgICAgICAgcHViX2RhdGU9ZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCksCiAgICAgICAgICAgIGFydGljbGVfdGV4dD0iQUJDREUiICogMTAwMCwKICBuZG9tIiwKICAgICJyYW5kcmFuZ2UiLAogICAgInNhbXBsZSIsCiAgICAic2VlZCIsCiAgICAic2V0c3RhdGUiLAogICAgInNodWZmbGUiLAogICAgInRyaWFuZ3VsYXIiLAogICAgInVuaWZvcm0iLAogICAgInZvbm1pc2VzdmFyaWF0ZSIsCiAgICAid2VpYnVsbHZhcmlhdGUiLApdCgpOVl9NQUdJQ0NPTlNUID0gNCAqIF9leHAoLTAuNSkgLyBfc3FydCgyLjApCkxPRzQgPSBfbG9nKDQuMCkKU0dfTUFHSUNDT05TVCA9IDEuMCArIF9sb2coNC41KQpCUEYgPSA1MyAgICAgICAgIyBOdW1iZXIgb2YgYml0cyBpbiBhIGZsb2F0ClJFQ0lQX0JQRiA9IDIgKiogLUJQRgpfT05FID0gMQpfc2hhNTEyID0gTm9uZQoKCmNsYXNzIFJhbmRvbShfcmFuZG9tLlJhbmRvbSk6CiAgICAiIiJSYW5kb20gbnVtYmVyIGdlbmVyYXRvciBiYXNlIGNsYXNzIHVzZWQgYnkgYm91bmQgbW9kdWxlIGZ1bmN0aW9ucy4KCiAgICBVc2VkIHRvIGluc3RhbnRpYXRlIGluc3RhbmNlcyBvZiBSYW5kb20gdG8gZ2V0IGdlbmVyYXRvcnMgdGhhdCBkb24ndAogICAgc2hhcmUgc3RhdGUuCgogICAgQ2xhc3MgUmFuZG9tIGNhbiBhbHNvIGJlIHN1YmNsYXNzZWQgaWYgeW91IHdhbnQgdG8gdXNlIGEgZGlmZmVyZW50IGJhc2ljCiAgICBnZW5lcmF0b3Igb2YgeW91ciBvd24gZGV2aXNpbmc6IGluIHRoYXQgY2FzZSwgb3ZlcnJpZGUgdGhlIGZvbGxvd2luZwogICAgbWV0aG9kczogIHJhbmRvbSgpLCBzZWVkKCksIGdldHN0YXRlKCksIGFuZCBzZXRzdGF0ZSgpLgogICAgT3B0aW9uYWxseSwgaW1wbGVtZW50IGEgZ2V0cmFuZGJpdHMoKSBtZXRob2Qgc28gdGhhdCByYW5kcmFuZ2UoKQogICAgY2FuIGNvdmVyIGFyYml0cmFyaWx5IGxhcmdlIHJhbmdlcy4KCiAgICAiIiIKCiAgICBWRVJTSU9OID0gMyAgICAgIyB1c2VkIGJ5IGdldHN0YXRlL3NldHN0YXRlCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHg9Tm9uZSk6CiAgICAgICAgIiIiSW5pdGlhbGl6ZSBhbiBpbnN0YW5jZS4KCiAgICAgICAgT3B0aW9uYWwgYXJndW1lbnQgeCBjb250cm9scyBzZWVkaW5nLCBhcyBmb3IgUmFuZG9tLnNlZWQoKS4KICAgICAgICAiIiIKCiAgICAgICAgc2VsZi5zZWVkKHgpCiAgICAgICAgc2VsZi5nYXVzc19uZXh0ID0gTm9uZQoKICAgIGRlZiBzZWVkKHNlbGYsIGE9Tm9uZSwgdmVyc2lvbj0yKToKICAgICAgICAiIiJJbml0aWFsaXplIGludGVybmFsIHN0YXRlIGZyb20gYSBzZWVkLgoKICAgICAgICBUaGUgb25seSBzdXBwb3J0ZWQgc2VlZCB0eXBlcyBhcmUgTm9uZSwgaW50LCBmbG9hdCwKICAgICAgICBzdHIsIGJ5dGVzLCBhbmQgYnl0ZWFycmF5LgoKICAgICAgICBOb25lIG9yIG5vIGFyZ3VtZW50IHNlZWRzIGZyb20gY3VycmVudCB0aW1lIG9yIGZyb20gYW4gb3BlcmF0aW5nCiAgICAgICAgc3lzdGVtIHNwZWNpZmljIHJhbmRvbW5lc3Mgc291cmNlIGlmIGF2YWlsYWJsZS4KCiAgICAgICAgSWYgKmEqIGlzIGFuIGludCwgYWxsIGJpdHMgYXJlIHVzZWQuCgogICAgICAgIEZ0ZXN0X2xlbmd0aF8wX2xhcmdlX29mZnNldChzZWxmKToKICAgICAgICAjIElzc3VlICMxMDk1OTogdGVzdCBtYXBwaW5nIG9mIGEgZmlsZSBieSBwYXNzaW5nIDAgZm9yCiAgICAgICAgIyBtYXAgbGVuZ3RoIHdpdGggYSBsYXJnZSBvZmZzZXQgZG9lc24ndCBjYXVzZSBhIHNlZ2ZhdWx0LgogICAgICAgIHdpdGggb3BlbihURVNURk4sICJ3YiIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoMTE1Njk5ICogYidtJykgIyBBcmJpdHJhcnkgY2hhcmFjdGVyCgogICAgICAgIHdpdGggb3BlbihURVNURk4sICJ3K2IiKSBhcyBmOgogICAgICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhWYWx1ZUVycm9yLCBtbWFwLm1tYXAsIGYuZmlsZW5vKCksIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldD0yMTQ3NDE4MTEyKQoKICAgIGRlZiB0ZXN0X21vdmUoc2VsZik6CiAgICAgICAgIyBtYWtlIG1vdmUgd29ya3MgZXZlcnl3aGVyZSAoNjQtYml0IGZvcm1hdCBwcm9ibGVtIGVhcmxpZXIpCiAgICAgICAgd2l0aCBvcGVuKFRFU1RGTiwgJ3diKycpIGFzIGY6CgogICAgICAgICAgICBmLndyaXRlKGIiQUJDREVhYmNkZSIpICMgQXJiaXRyYXJ5IGNoYXJhY3RlcgogICAgICAgICAgICBmLmZsdXNoKCkKCiAgICAgICAgICAgIG1mID0gbW1hcC5tbWFwKGYuZmlsZW5vKCksIDEwKQogICAgICAgICAgICBtZi5tb3ZlKDUsIDAsIDUpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwobWZbOl0sIGIiQUJDREVBQkNERSIsICJNYXAgbW92ZSBzaG91bGQgaGF2ZSBkdXBsaWNhdGVkIGZyb250IDUiKQogICAgICAgICAgICBtZi5jbG9zZSgpCgogICAgICAgICMgbW9yZSBleGNlc3NpdmUgdGVzdAogICAgICAgIGRhdGEgPSBiIjAxMjM0NTY3ODkiCiAgICAgICAgZm9yIGRlc3QgaW4gcmFuZ2UobGVuKGRhdGEpKToKICAgICAgICAgICAgZm9yIHNyYyBpbiByYW5nZShsZW4oZGF0YSkpOgogICAgICAgICAgICAgICAgZm9yIGNvdW50IGluIHJhbmdlKGxlbihkYXRhKSAtIG1heChkZXN0LCBzcmMpKToKICAgICAgICAgICAgICAgICAgICBleHBlY3RlZCA9IGRhdGFbOmRlc3RdICsgZGF0YVtzcmM6c3JjK2NvdW50XSArIGRhdGFbZGVzdCtjb3VudDpdCiAgICAgICAgICAgICAgICAgICAgbSA9IG1tYXAubW1hcCgtMSwgbGVuKGRhdGEpKQogICAgICAgICAgICAgICAgICAgIG1bOl0gPSBkYXRhCiAgICAgICAgICAgICAgICAgICAgbS5tb3ZlKGRlc3QsIHNyYywgY291bnQpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChtWzpdLCBleHBlY3RlZCkKICAgICAgICAgICAgICAgICAgICBtLmNsb3NlKCkKCiAgICAgICAgIyBzZWdmYXVsdCB0ZXN0IChJc3N1ZSA1Mzg3KQogICAgICAgIG0gPSBtbWFwLm1tYXAoLTEsIDEwMCkKICAgICAgICBvZmZzZXRzID0gWy0xMDAsIC0xLCAwLCAxLCAxMDBdCiAgICAgICAgZm9yIHNvdXJjZSwgZGVzdCwgc2l6ZSBpbiBpdGVydG9vbHMucHJvZHVjdChvZmZzZXRzLCBvZmZ0byBhIHJlcGVhdGFibGUgbWFuZ2xlZCB2ZXJzaW9uIHdpdGggdGhlIGdpdmVuCiAgICBsZW5ndGguCgogICAgSWYgYSBxdW90ZSBzdHJpcHBlZCBuYW1lIGNvbnRhaW5zIGEgbmFtZXNwYWNlLCBlLmcuIFVTRVJOQU1FIi4iVEFCTEUsCiAgICB0cnVuY2F0ZSB0aGUgdGFibGUgcG9ydGlvbiBvbmx5LgogICAgIiIiCiAgICBuYW1lc3BhY2UsIG5hbWUgPSBzcGxpdF9pZGVudGlmaWVyKGlkZW50aWZpZXIpCgogICAgaWYgbGVuZ3RoIGlzIE5vbmUgb3IgbGVuKG5hbWUpIDw9IGxlbmd0aDoKICAgICAgICByZXR1cm4gaWRlbnRpZmllcgoKICAgIGRpZ2VzdCA9IG5hbWVzX2RpZ2VzdChuYW1lLCBsZW5ndGg9aGFzaF9sZW4pCiAgICByZXR1cm4gIiVzJXMlcyIgJSAoCiAgICAgICAgJyVzIi4iJyAlIG5hbWVzcGFjZSBpZiBuYW1lc3BhY2UgZWxzZSAiIiwKICAgICAgICBuYW1lWzogbGVuZ3RoIC0gaGFzaF9sZW5dLAogICAgICAgIGRpZ2VzdCwKICAgICkKCgpkZWYgbmFtZXNfZGlnZXN0KCphcmdzLCBsZW5ndGgpOgogICAgIiIiCiAgICBHZW5lcmF0ZSBhIDMyLWJpdCBkaWdlc3Qgb2YgYSBzZXQgb2YgYXJndW1lbnRzIHRoYXQgY2FuIGJlIHVzZWQgdG8gc2hvcnRlbgogICAgaWRlbnRpZnlpbmcgbmFtZXMuCiAgICAiIiIKICAgIGggPSBtZDUodXNlZGZvcnNlY3VyaXR5PUZhbHNlKQogICAgZm9yIGFyZyBpbiBhcmdzOgogICAgICAgIGgudXBkYXRlKGFyZy5lbmNvZGUoKSkKICAgIHJldHVybiBoLmhleGRpZ2VzdCgpWzpsZW5ndGhdCgoKZGVmIGZvcm1hdF9udW1iZXIodmFsdWUsIG1heF9kaWdpdHMsIGRlY2ltYWxfcGxhY2VzKToKICAgICIiIgogICAgRm9ybWF0IGEgbnVtYmVyIGludG8gYSBzdHJpbmcgd2l0aCB0aGUgcmVxdWlzaXRlIG51bWJlciBvZiBkaWdpdHMgYW5kCiAgICBkZWNpbWFsIHBsYWNlcy4KICAgICIiIgogICAgaWYgdmFsdWUgaXMgTm9uZToKICAgICAgICByZXR1cm4gTm9uZQogICAgY29udGV4dCA9IGRlY2ltYWwuZ2V0Y29udGV4dCgpLmNvcHkoKQogICAgaWYgbWF4X2RpZ2l0cyBpcyBub3QgTm9uZToKICAgICAgICBjb250ZXh0LnByZWMgPSBtYXhfZGlnaXRzCiAgICBpZiBkZWNpbWFsX3BsYWNlcyBpcyBub3QgTm9uZToKICAgICAgICB2YWx1ZSA9IHZhbHVlLnF1YW50aXplKAogICAgICAgICAgICBkZWNpbWFsLkRlY2ltYWwoMSkuc2NhbGViKC1kZWNpbWFsX3BsYWNlcyksIGNvbnRleHQ9Y29udGV4dAogICAgICAgICkKICAgIGVsc2U6CiAgICAgICAgY29udGV4dC50cmFwc1tkZWNpbWFsLlJvdW5kZWRdID0gMQogICAgICAgIHZhbHVlID0gY29udGV4dC5jcmVhdGVfZGVjaW1hbCh2YWx1ZSkKICAgIHJldHVybiAiezpmfSIuZm9ybWF0KHZhbHVlKQoKCmRlZiBzdHJpcF9xdW90ZXModGFibGVfbmFtZSk6CiAgICAiIiIKICAgIFN0cmlwIHF1b3RlcyBvZmYgb2YgcXVvdGVkIHRhYmxlIG5hbWVzIHRvIG1ha2UgdGhlbSBzYWZlIGZvciB1c2UgaW4gaW5kZXgKICAgIG5hbWVzLCBzZXF1ZW5jZSBuYW1mLlNFRUtfRU5EKQoKICAgIEBzdXBwb3J0LmNweXRob25fb25seQogICAgZGVmIHRlc3Rfc3RhcnR1cF9vcHRpbWl6YXRpb24oc2VsZik6CiAgICAgICAgIyBnaC0xMzI5NTI6IFRlc3QgdGhhdCBgaW9gIGlzIG5vdCBpbXBvcnRlZCBhdCBzdGFydHVwIGFuZCB0aGF0IHRoZQogICAgICAgICMgX19tb2R1bGVfXyBvZiBVbnN1cHBvcnRlZE9wZXJhdGlvbiBpcyBzZXQgdG8gImlvIi4KICAgICAgICBhc3NlcnRfcHl0aG9uX29rKCItUyIsICItYyIsIHRleHR3cmFwLmRlZGVudCgKICAgICAgICAgICAgIiIiCiAgICAgICAgICAgIGltcG9ydCBzeXMKICAgICAgICAgICAgYXNzZXJ0ICJpbyIgbm90IGluIHN5cy5tb2R1bGVzCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHN5cy5zdGRpbi50cnVuY2F0ZSgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHR5cCA9IHR5cGUoZSkKICAgICAgICAgICAgICAgIGFzc2VydCB0eXAuX19tb2R1bGVfXyA9PSAiaW8iLCAodHlwLCB0eXAuX19tb2R1bGVfXykKICAgICAgICAgICAgICAgIGFzc2VydCB0eXAuX19uYW1lX18gPT0gIlVuc3VwcG9ydGVkT3BlcmF0aW9uIiwgKHR5cCwgdHlwLl9fbmFtZV9fKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgQXNzZXJ0aW9uRXJyb3IoIkV4cGVjdGVkIFVuc3VwcG9ydGVkT3BlcmF0aW9uIikKICAgICAgICAgICAgIiIiCiAgICAgICAgKSkKCiAgICBAdW5pdHRlc3Quc2tpcFVubGVzcyhoYXNhdHRyKG9zLCAicGlwZSIpLCAicmVxdWlyZXMgb3MucGlwZSgpIikKICAgIGRlZiB0ZXN0X29wdGlvbmFsX2FiaWxpdGllcyhzZWxmKToKICAgICAgICAjIFRlc3QgZm9yIE9TRXJyb3Igd2hlbiBvcHRpb25hbCBBUElzIGFyZSBub3Qgc3VwcG9ydGVkCiAgICAgICAgIyBUaGUgcHVycG9zZSBvZiB0aGlzIHRlc3QgaXMgdG8gdHJ5IGZpbGVubygpLCByZWFkaW5nLCB3cml0aW5nIGFuZAogICAgICAgICMgc2Vla2luZyBvcGVyYXRpb25zIHdpdGggdmFyaW91cyBvYmplY3RzIHRoYXQgaW5kaWNhdGUgdGhleSBkbyBub3QKICAgICAgICAjIHN1cHBvcnQgdGhlc2Ugb3BlcmF0aW9ucy4KCiAgICAgICAgZGVmIHBpcGVfcmVhZGVyKCk6CiAgICAgICAgICAgIFtyLCB3XSA9IG9zLnBpcGUoKQogICAgICAgICAgICBvcy5jbG9zZSh3KSAgIyBTbyB0aGF0IHJlYWQoKSBpcyBoYXJtbGVzcwogICAgICAgICAgICByZXR1cm4gc2VsZi5GaWxlSU8ociwgInIiKQoKICAgICAgICBkZWYgcGlwZV93cml0ZXIoKToKICAgICAgICAgICAgW3IsIHddID0gb3MucGlwZSgpCiAgICAgICAgICAgIHNlbGYuYWRkQ2xlYW51cChvcy5jbG9zZSwgcikKICAgICAgICAgICAgIyBHdWFyYW50ZWUgdGhhdCB3ZSBjYW4gd3JpdGUgaW50byB0aGUgcGlwZSB3aXRob3V0IGJsb2NraW5nCiAgICAgICAgICAgIHRocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PW9zLnJlYWQsIGFyZ3M9KHIsIDEwMCkpCiBubG9vcAoKZnJvbSBmdW5jdG9vbHMgaW1wb3J0IHBhcnRpYWwKaW1wb3J0IHRleHR3cmFwCmZyb20gdGtpbnRlciBpbXBvcnQgVGssIFRleHQKZnJvbSBpZGxlbGliIGltcG9ydCBjb25maWcKZnJvbSBpZGxlbGliLnBlcmNvbGF0b3IgaW1wb3J0IFBlcmNvbGF0b3IKCgp1c2VyY2ZnID0gY29sb3JpemVyLmlkbGVDb25mLnVzZXJDZmcKdGVzdGNmZyA9IHsKICAgICdtYWluJzogY29uZmlnLklkbGVVc2VyQ29uZlBhcnNlcignJyksCiAgICAnaGlnaGxpZ2h0JzogY29uZmlnLklkbGVVc2VyQ29uZlBhcnNlcignJyksCiAgICAna2V5cyc6IGNvbmZpZy5JZGxlVXNlckNvbmZQYXJzZXIoJycpLAogICAgJ2V4dGVuc2lvbnMnOiBjb25maWcuSWRsZVVzZXJDb25mUGFyc2VyKCcnKSwKfQoKc291cmNlID0gdGV4dHdyYXAuZGVkZW50KCIiIlwKICAgIGlmIFRydWU6IGludCAoJzEnKSAjIGtleXdvcmQsIGJ1aWx0aW4sIHN0cmluZywgY29tbWVudAogICAgZWxpZiBGYWxzZTogcHJpbnQoMCkgICMgJ3N0cmluZycgaW4gY29tbWVudAogICAgZWxzZTogZmxvYXQoTm9uZSkgICMgaWYgaW4gY29tbWVudAogICAgaWYgaUYgKyBJZiArIElGOiAna2V5d29yZCBtYXRjaGluZyBtdXN0IHJlc3BlY3QgY2FzZScKICAgIGlmJyc6IHggb3InJyAgIyB2YWxpZCBrZXl3b3JkLXN0cmluZyBuby1zcGFjZSBjb21iaW5hdGlvbnMKICAgIGFzeW5jIGRlZiBmKCk6IGF3YWl0IGcoKQogICAgIyBTdHJpbmdzIHNob3VsZCBiZSBlbnRpcmVseSBjb2xvcmVkLCBpbmNsdWRpbmcgcXVvdGVzLgogICAgJ3gnLCAnJyd4JycnLCAieCIsIFwiIiJ4XCIiIgogICAgJ2FiY1xcCiAgICBkZWYnCiAgICAnJydhYmNcXAogICAgZGVmJycnCiAgICAjIEFsbCB2YWxpZCBwcmVmaXhlcyBmb3IgdW5pY29kZSBhbmQgYnl0ZSBzdHJpbmdzIHNob3VsZCBiZSBjb2xvcmVkLgogICAgcid4JywgdSd4JywgUid4JywgVSd4JywgZid4JywgRid4JwogICAgZnIneCcsIEZyJ3gnLCBmUid4JywgRlIneCcsIHJmJ3gnLCByRid4JywgUmYneCcsIFJGJ3gnCiAgICB0cid4JywgVHIneCcsIHRSJ3gnLCBUUid4JywgcnQneCcsIHJUJ3gnLCBSdCd4JywgUlQneCcKICAgIGIneCcsQid4JywgYnIneCcsQnIneCcsYlIneCcsQlIneCcsIHJiJ3gnLCByQid4JyxSYid4JyxSQid4JwogICAgIyBJbnZhbGlkIGNvbWJpbmF0aW9ucyBvZiBsZWdhbCBjaGFyYWN0ZXJzIHNob3VsZCBiZSBoYWxmIGNvbG9yZWQuCiAgICB1cid4JywgcnUneCcsIHVmJ3gnLCBmdSd4JywgVVIneCcsIHVmcid4JywgcmZ1J3gnLCB4Zid4JywgZngneCcKICAgIG1hdGNoIHBvaW50OgogICAgICAgIGNhc2UgKHgsIDApIGFzIF86CiAgICAgICAgICAgIHByaW50KGYiWD17eH0iKQogICAgICAgIGNhc2UgW18sIFtfXSwgIl8iLAogICAgICAgICAgICAgICAgX106CiAgICAgICAgICAgIHBhc3MKICAgICAgICBjYXNlIF8gaWYgKCJhIiBpZiBfIGVsc2Ugc2V0KCkpOiBwYXNzCiAgICAgICAgY2FzZSBfOgogZXN0X2Jhc2ljKHNlbGYpOgogICAgICAgIEF1dGhvci5vYmplY3RzLmNyZWF0ZShuYW1lPSJKb2huIiwgYWxpYXM9Inh5eiIpCiAgICAgICAgbm9uZV92YWx1ZSA9ICgKICAgICAgICAgICAgIiIgaWYgY29ubmVjdGlvbi5mZWF0dXJlcy5pbnRlcnByZXRzX2VtcHR5X3N0cmluZ3NfYXNfbnVsbHMgZWxzZSBOb25lCiAgICAgICAgKQogICAgICAgIHRlc3RzID0gKAogICAgICAgICAgICAoUmVwZWF0KCJuYW1lIiwgMCksICIiKSwKICAgICAgICAgICAgKFJlcGVhdCgibmFtZSIsIDIpLCAiSm9obkpvaG4iKSwKICAgICAgICAgICAgKFJlcGVhdCgibmFtZSIsIExlbmd0aCgiYWxpYXMiKSksICJKb2huSm9obkpvaG4iKSwKICAgICAgICAgICAgKFJlcGVhdChWYWx1ZSgieCIpLCAzKSwgInh4eCIpLAogICAgICAgICAgICAoUmVwZWF0KCJuYW1lIiwgTm9uZSksIG5vbmVfdmFsdWUpLAogICAgICAgICAgICAoUmVwZWF0KFZhbHVlKE5vbmUpLCA0KSwgbm9uZV92YWx1ZSksCiAgICAgICAgICAgIChSZXBlYXQoImdvZXNfYnkiLCAxKSwgbm9uZV92YWx1ZSksCiAgICAgICAgKQogICAgICAgIGZvciBmdW5jdGlvbiwgcmVwZWF0ZWRfdGV4dCBpbiB0ZXN0czoKICAgICAgICAgICAgd2l0aCBzZWxmLnN1YlRlc3QoZnVuY3Rpb249ZnVuY3Rpb24pOgogICAgICAgICAgICAgICAgYXV0aG9ycyA9IEF1dGhvci5vYmplY3RzLmFubm90YXRlKHJlcGVhdGVkX3RleHQ9ZnVuY3Rpb24pCiAgICAgICAgICAgICAgICBzZWxmLmFzc2VydFF1ZXJ5U2V0RXF1YWwoCiAgICAgICAgICAgICAgICAgICAgYXV0aG9ycywgW3JlcGVhdGVkX3RleHRdLCBsYW1iZGEgYTogYS5yZXBlYXRlZF90ZXh0LCBvcmRlcmVkPUZhbHNlCiAgICAgICAgICAgICAgICApCgogICAgZGVmIHRlc3RfbmVnYXRpdmVfbnVtYmVyKHNlbGYpOgogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXNNZXNzYWdlKAogICAgICAgICAgICBWYWx1ZUVycm9yLCAiJ251bWJlcicgbXVzdCBiZSBncmVhdGVyIG9yIGVxdWFsIHRvIDAuIgogICAgICAgICk6CiAgICAgICAgICAgIFJlcGVhdCgibmFtZSIsIC0xKQpmcm9tIGRqYW5nby5jb250cmliLmdpcy5nZW9zIGltcG9ydCBQb2ludApmcm9tIGRqYW5nby50ZXN0IGltcG9ydCBTaW1wbGVUZXN0Q2FzZSwgb3ZlcnJpZGVfc2V0dGluZ3MKCmZyb20gLm1vZGVscyBpbXBvcnQgQ2l0eSwgc2l0ZSwgc2l0ZV9naXMsIHNpdGVfZ2lzX2N1c3RvbQoKCkBvdmVycmlkZV9zZXR0aW5ncyhST09UX1VSTENPTkY9ImRqYW5nby5jb250cmliLmdpcy50ZXN0cy5nZW9hZG1pbi51cmxzIikKY2xhc3MgR2VvQWRtaW5UZXN0KFNpbXBsZVRlc3RDYXNlKToKICAgIGFkbWluX3NpdGUgPSBzaXRlICAjIE1vZGVsQWRtaW4KCiAgICBkZWYgdGVzdF93aWRnZXRfZW1wdHlfc3RyaW5nKHNlbGYpOgogICAgICAgIGdlb2FkbWluID0gc2VsZi5hZG1pbl9zaXRlLmdldF9tb2RlbF9hZG1pbihDaXR5KQogICAgICAgIGZvcm0gPSBnZW9hZG1pbi5nZXRfY2hhbmdlbGlzWyJteXZhciJdLCAiMiIpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChvdXRwdXQsICIiKQoKICAgIEBzZXR1cCh7ImZpcnN0b2YxNiI6ICJ7JSBmaXJzdG9mIGEgYiBjIGFzIG15dmFyICV9In0pCiAgICBkZWYgdGVzdF9hbGxfZmFsc2VfYXJndW1lbnRzX2FzdmFyKHNlbGYpOgogICAgICAgIGN0eCA9IHsiYSI6IDAsICJiIjogMCwgImMiOiAwfQogICAgICAgIG91dHB1dCA9IHNlbGYuZW5naW5lLnJlbmRlcl90b19zdHJpbmcoImZpcnN0b2YxNiIsIGN0eCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGN0eFsibXl2YXIiXSwgIiIpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChvdXRwdXQsICIiKQpmcm9tIHVuaXR0ZXN0IGltcG9ydCBtb2NrCgpmcm9tIGRqYW5nby5jb3JlLmNoZWNrcyBpbXBvcnQgRXJyb3IKZnJvbSBkamFuZ28uY29yZS5jaGVja3MgaW1wb3J0IFdhcm5pbmcgYXMgRGphbmdvV2FybmluZwpmcm9tIGRqYW5nby5kYiBpbXBvcnQgY29ubmVjdGlvbiwgbW9kZWxzCmZyb20gZGphbmdvLnRlc3QgaW1wb3J0IHNraXBVbmxlc3NEQkZlYXR1cmUKZnJvbSBkamFuZ28udGVzdC50ZXN0Y2FzZXMgaW1wb3J0IFNpbXBsZVRlc3RDYXNlLCBUZXN0Q2FzZQpmcm9tIGRqYW5nby50ZXN0LnV0aWxzIGltcG9ydCBpc29sYXRlX2FwcHMsIG1vZGlmeV9zZXR0aW5ncywgb3ZlcnJpZGVfc2V0dGluZ3MKCgpAaXNvbGF0ZV9hcHBzKCJpbnZhbGlkX21vZGVsc190ZXN0cyIpCmNsYXNzIFJlbGF0aXZlRmllbGRUZXN0cyhTaW1wbGVUZXN0Q2FzZSk6CiAgICBkZWYgdGVzdF92YWxpZF9mb3JlaWduX2tleV93aXRob3V0X2FjY2Vzc29yKHNlbGYpOgogICAgICAgIGNsYXNzIFRhcmdldChtb2RlbHMuTW9kZWwpOgogICAgICAgICAgICAjIFRoZXJlIHdvdWxkIGJlIGEgY2xhc2ggaWYgTW9kZWwuZmllbGQgaW5zdGFsbGVkIGFuIGFjY2Vzc29yLgogICAgICAgICAgICBtb2RlbCA9IG1vZGVscy5JbnRlZ2VyRmllbGQoKQoKICAgICAgICBjbGFzcyBNb2RlbChtb2RlbHMuTW9kZWwpOgogICAgICAgICAgICBmaWVsZCA9IG1vZGVscy5Gb3JlaWduS2V5KFRhcmdldCwgbW9kZWxzLkNBU0NBREUsIHJlbGF0ZWRfbmFtZT0iKyIpCgogICAgICAgIGZpZWxkID0gTW9kZWwuX21ldGEuZ2V0X2ZpZWxkKCJmaWVsZCIpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChmaWVsZC5jaGVjaygpLCBbXSkKCiAgICBkZWYgdGVzdF9mb3JlaWduX2tleV90b19taXNzaW5nX21vZGVsKHNlbGYpOgogICAgICAgICMgTW9kZWwgbmFtZXMgYXJlIHJlc29sdmVkIHdoZW4gYSBtb2RlbCBpcyBiZWluZyBjcmVhdGVkLCBzbyB3ZSBjYW5ub3QKICAgICAgICAjIHRlc3QgcmVsYXRpdmUgZmllbGRzIGluIGlzb2xhdGlvbiBhbmQgd2UgbmVlZCB0byBhdHRhY2ggdGhlbSB0byBhCiAgICAgICAgIyBtb2RlbC4KICAgICAgICBjbGFzcyBNb2RlbChtb2RlbHMuTW9kZWwpOgogICAgICAgICAgICBmb3JlaWduX2tleSA9IG1vZGVscy5Gb3JlaWduS2V5KCJSZWwxIiwgbW9kc3NlcnRDb250YWlucyhyZXNwb25zZSwgIkluZGV4IG9mIHN1YmRpci8iKQogICAgICAgICMgRmlsZSB3aXRoIGEgbGVhZGluZyBkb3QgKGUuZy4gLmhpZGRlbikgYXJlbid0IGRpc3BsYXllZC4KICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3BvbnNlLmNvbnRleHRbImZpbGVfbGlzdCJdLCBbInZpc2libGUiXSkKCiAgICBAb3ZlcnJpZGVfc2V0dGluZ3MoCiAgICAgICAgVEVNUExBVEVTPVsKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgIkJBQ0tFTkQiOiAiZGphbmdvLnRlbXBsYXRlLmJhY2tlbmRzLmRqYW5nby5EamFuZ29UZW1wbGF0ZXMiLAogICAgICAgICAgICAgICAgIk9QVElPTlMiOiB7CiAgICAgICAgICAgICAgICAgICAgImxvYWRlcnMiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkamFuZ28udGVtcGxhdGUubG9hZGVycy5sb2NtZW0uTG9hZGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdGljL2RpcmVjdG9yeV9pbmRleC5odG1sIjogIlRlc3QgaW5kZXgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIF0KICAgICkKICAgIGRlZiB0ZXN0X2luZGV4X2N1c3RvbV90ZW1wbGF0ZShzZWxmKToKICAgICAgICByZXNwb25zZSA9IHNlbGYuY2xpZW50LmdldCgiLyVzLyIgJSBzZWxmLnByZWZpeCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3BvbnNlLmNvbnRlbnQsIGIiVGVzdCBpbmRleCIpCgogICAgZGVmIHRlc3RfdGVtcGxhdGVfZW5jb2Rpbmcoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgVGhlIHRlbXBsYXRlIGlzIGxvYWRlZCBkaXJlY3RseSwgbm90IHZpYSBhIHRlbXBsYXRlIGxvYWRlciwgYW5kIHNob3VsZAogICAgICAgIGJlIG9wZW5lZCBhcyB1dGYtOCBjaGFyc2V0IGFzIGlzIHRoZSBkZWZhdWx0IHNwZWNpZmllZCBvbiB0ZW1wbGF0ZQogICAgICAgIGVuZ2luZXMuCiAgICAgICAgIiIiCiAgICAgICAgZnJvbSBkamFuZ28udmlld3Muc3RhdGljIGltcG9ydCBQYXRoCgogICAgICAgIHdpdGggbW9jay5wYXRjaC5vYmplY3QoUGF0aCwgIm9wZW4iKSBhcyBtOgogICAgICAgICAgICBkaXJlY3RvcnlfaW5kZXgobW9jay5NYWdpY01vY2soKSwgbW9jay5NYWdpY01vY2soKSkKICAgICAgICAgICAgbS5hc3NlcnRfY2FsbGVkX29uY2Vfd2l0aChlbmNvZGluZz0idXRmLTgiKQoKCmNsYXNzIFN0YXRpY0hlbHBlclRlc3QoU3RhdGljVGVzdHMpOgogICAgIiIiCiAgICBUZXN0IGNhc2UgdG8gbWFrZSBzdXJlIHRoZSBzdGF0aWMgVVJMIHBhdHRlcm4gaGVscGVyIHdvcmtzIGFzIGV4cGVjdGVkCiAgICAiIiIKCiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgc3VwZXIoKS5zZXRVcCgpPSB0ZW1wZmlsZS5UZW1wb3JhcnlEaXJlY3RvcnkoKQogICAgICAgIHNlbGYudGVtcGRpciA9IFBhdGgoX3RlbXBkaXIubmFtZSkucmVzb2x2ZShzdHJpY3Q9VHJ1ZSkuYWJzb2x1dGUoKQogICAgICAgIHNlbGYuZXhpc3RpbmdfZmlsZSA9IHNlbGYuZW5zdXJlX2ZpbGUoc2VsZi50ZW1wZGlyIC8gInRlc3QucHkiKQogICAgICAgIHNlbGYubm9uZXhpc3RlbnRfZmlsZSA9IChzZWxmLnRlbXBkaXIgLyAiZG9lc19ub3RfZXhpc3QucHkiKS5hYnNvbHV0ZSgpCiAgICAgICAgc2VsZi5yZWxvYWRlciA9IHNlbGYuUkVMT0FERVJfQ0xTKCkKICAgICAgICBzZWxmLmFkZENsZWFudXAoc2VsZi5yZWxvYWRlci5zdG9wKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChfdGVtcGRpci5jbGVhbnVwKQoKICAgIGRlZiBlbnN1cmVfZmlsZShzZWxmLCBwYXRoKToKICAgICAgICBwYXRoLnBhcmVudC5ta2RpcihleGlzdF9vaz1UcnVlLCBwYXJlbnRzPVRydWUpCiAgICAgICAgcGF0aC50b3VjaCgpCiAgICAgICAgIyBPbiBMaW51eCBhbmQgV2luZG93cyB1cGRhdGluZyB0aGUgbXRpbWUgb2YgYSBmaWxlIHVzaW5nIHRvdWNoKCkgd2lsbAogICAgICAgICMgc2V0IGEgdGltZXN0YW1wIHZhbHVlIHRoYXQgaXMgaW4gdGhlIHBhc3QsIGFzIHRoZSB0aW1lIHZhbHVlIGZvciB0aGUKICAgICAgICAjIGxhc3Qga2VybmVsIHRpY2sgaXMgdXNlZCByYXRoZXIgdGhhbiBnZXR0aW5nIHRoZSBjb3JyZWN0IGFic29sdXRlCiAgICAgICAgIyB0aW1lLgogICAgICAgICMgVG8gbWFrZSB0ZXN0aW5nIHNpbXBsZXIgc2V0IHRoZSBtdGltZSB0byBiZSB0aGUgb2JzZXJ2ZWQgdGltZSB3aGVuCiAgICAgICAgIyB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZC4KICAgICAgICBzZWxmLnNldF9tdGltZShwYXRoLCB0aW1lLnRpbWUoKSkKICAgICAgICByZXR1cm4gcGF0aC5hYnNvbHV0ZSgpCgogICAgZGVmIHNldF9tdGltZShzZWxmLCBmcCwgdmFsdWUpOgogICAgICAgIG9zLnV0aW1lKHN0cihmcCksICh2YWx1ZSwgdmFsdWUpKQoKICAgIGRlZiBpbmNyZW1lbnRfbXRpbWUoc2VsZiwgZnAsIGJ5PTEpOgogICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgc2VsZi5zZXRfbXRpbWUoZnAsIGN1cnJlbnRfdGltZSArIGJ5KQoKICAgIEBjb250ZXh0bGliLmNvbnRleHRtYW5hZ2VyCiAgICBkZWYgdGlja190d2ljZShzZWxmKToKICAgICAgICB0aWNrZXIgPSBzZWxmLnJlbG9hZGVyLnRpY2soKQogICAgICAgIG5leHQodGlja2VyKQogICAgICAgIHlpZWxkCiAgICAgICAgbmV4dCh0aWNrZXIpCgoKY2xhc3MgSW50ZWdyYXRpb25UZXN0czoKICAgIEBtb2NrLnBhdGNoKCJkamFuZ28udXRpbHMuYXV0b3JlbG9hZC5CYXNlUmVsb2FkZXIubm90aWZ5X2ZpbGVfY2hhbmdlZCIpCiAgICBAbW9jay5wYXRjaCgKICAgICAgICAiZGphbmdvLnV0aWxzLmF1dG9yZWxvYWQuaXRlcl9hbGxfcHl0aG9uX21vZHVsZV9maWxlcyIsIHJldHVybl92YWx1ZT1mcm96ZW5zZXQobWUgPSBuYW1lCiAgICBkZWYgX19nZXRhdHRyX18oc2VsZiwgbmFtZSk6CiAgICAgICAgcmV0dXJuIF9NZXRob2Qoc2VsZi5fX3NlbmQsICIlcy4lcyIgJSAoc2VsZi5fX25hbWUsIG5hbWUpKQogICAgZGVmIF9fY2FsbF9fKHNlbGYsICphcmdzKToKICAgICAgICByZXR1cm4gc2VsZi5fX3NlbmQoc2VsZi5fX25hbWUsIGFyZ3MpCgojIwojIFN0YW5kYXJkIHRyYW5zcG9ydCBjbGFzcyBmb3IgWE1MLVJQQyBvdmVyIEhUVFAuCiMgPHA+CiMgWW91IGNhbiBjcmVhdGUgY3VzdG9tIHRyYW5zcG9ydHMgYnkgc3ViY2xhc3NpbmcgdGhpcyBtZXRob2QsIGFuZAojIG92ZXJyaWRpbmcgc2VsZWN0ZWQgbWV0aG9kcy4KCmNsYXNzIFRyYW5zcG9ydDoKICAgICIiIkhhbmRsZXMgYW4gSFRUUCB0cmFuc2FjdGlvbiB0byBhbiBYTUwtUlBDIHNlcnZlci4iIiIKCiAgICAjIGNsaWVudCBpZGVudGlmaWVyIChtYXkgYmUgb3ZlcnJpZGRlbikKICAgIHVzZXJfYWdlbnQgPSAiUHl0aG9uLXhtbHJwYy8lcyIgJSBfX3ZlcnNpb25fXwoKICAgICNpZiB0cnVlLCB3ZSdsbCByZXF1ZXN0IGd6aXAgZW5jb2RpbmcKICAgIGFjY2VwdF9nemlwX2VuY29kaW5nID0gVHJ1ZQoKICAgICMgaWYgcG9zaXRpdmUsIGVuY29kZSByZXF1ZXN0IHVzaW5nIGd6aXAgaWYgaXQgZXhjZWVkcyB0aGlzIHRocmVzaG9sZAogICAgIyBub3RlIHRoYXQgbWFueSBzZXJ2ZXJzIHdpbGwgZ2V0IGNvbmZ1c2VkLCBzbyBvbmx5IHVzZSBpdCBpZiB5b3Uga25vdwogICAgIyB0aGF0IHRoZXkgY2FuIGRlY29kZSBzdWNoIGEgcmVxdWVzdAogICAgZW5jb2RlX3RocmVzaG9sZCA9IE5vbmUgI05vbmUgPSBkb24ndCBlbmNvZGUKCiAgICBkZWYgX19pbml0X18oc2VsZiwgdXNlX2RhdGV0aW1lPUZhbHNlLCB1c2VfYnVpbHRpbl90eXBlcz1GYWxzZSwKICAgICAgICAgICAgICAgICAqLCBoZWFkZXJzPSgpKToKICAgICAgICBzZWxmLl91c2VfZGF0ZXRpbWUgPSB1c2VfZGF0ZXRpbWUKICAgICAgICBzZWxmLl91c2VfYnVpbHRpbl90eXBlcyA9IHVzZV9idWlsdGluX3R5cGVzCiAgICAgICAgc2VsZi5fY29ubmVjdGlvbiA9IChOb25lLCBOb25lKQogICAgICAgIHNlbGYuX2hlYWRlcnMgPSBsaXN0KGhlYWRlcnMpCiAgICAgICAgc2VsZi5fZXh0cmFfaGVhZGVycyA9IFtdCgogICAgIyMKICAgICMgU2VuZCBhIGNvbXBsZXRlIHJlcXVlc3QsIGFuZCBwYXJzZSB0aGUgcmVzcG9uc2UuCiAgICAjIFJldHJ5IHJlcXVlc3QgaWYgYSBjYWNoZWQgY29ubmVjdGlvbiBoYXMgZGlzY29ubmVjdGVkLgogICAgIwogICAgIyBAcGFyYW0gaG9zdCBUYXJnZXQgaG9zdC4KICAgICMgQHBhcmFtIGhhbmRsZXIgVGFyZ2V0IFBSQyBoYW5kbGVyLgogICAgIyBAcGFyYW0gcmVxdWVzdF9ib2R5IFhNTC1SUEMgcmVxdWVzdCBib2R5LgogICAgIyBAcGFyYW0gdmVyYm9zZSBEZWJ1Z2dpbmcgZmxhZy4KICAgICMgQHJldHVybiBQYXJzZWQgcmVzcG9uc2UuCgogICAgZGVmIHJlcXVlc3Qoc2VsZiwgaG9zdCwgaGFuZGVyZSBhIHN1Y2Nlc3NmdWwgd2FpdCBoYXMgbm8KICAgICAgICAgICAgIyBlZmZlY3QuICBTbyBldmVudHMgb3IgcHJvY2Vzc2VzIGFyZSBhbGwgcmlnaHQsIGJ1dCBsb2NrcwogICAgICAgICAgICAjIG9yIHNlbWFwaG9yZXMgYXJlIG5vdC4gIEFsc28gbm90ZSBpZiB0aGUgaGFuZGxlIGlzCiAgICAgICAgICAgICMgc2lnbmFsbGVkIGFuZCB0aGVuIHF1aWNrbHkgcmVzZXQsIHRoZW4gd2UgbWF5IHJldHVybgogICAgICAgICAgICAjIEZhbHNlIGV2ZW4gdGhvdWdoIHdlIGhhdmUgbm90IHRpbWVkIG91dC4KICAgICAgICAgICAgcmV0dXJuIGYuX3BvbGwoKQoKICAgICAgICBzZWxmLl9jYWNoZVtvdi5hZGRyZXNzXSA9IChmLCBvdiwgMCwgZmluaXNoX3dhaXRfZm9yX2hhbmRsZSkKICAgICAgICByZXR1cm4gZgoKICAgIGRlZiBfcmVnaXN0ZXJfd2l0aF9pb2NwKHNlbGYsIG9iaik6CiAgICAgICAgIyBUbyBnZXQgbm90aWZpY2F0aW9ucyBvZiBmaW5pc2hlZCBvcHMgb24gdGhpcyBvYmplY3RzIHNlbnQgdG8gdGhlCiAgICAgICAgIyBjb21wbGV0aW9uIHBvcnQsIHdlcmUgbXVzdCByZWdpc3RlciB0aGUgaGFuZGxlLgogICAgICAgIGlmIG9iaiBub3QgaW4gc2VsZi5fcmVnaXN0ZXJlZDoKICAgICAgICAgICAgc2VsZi5fcmVnaXN0ZXJlZC5hZGQob2JqKQogICAgICAgICAgICBfb3ZlcmxhcHBlZC5DcmVhdGVJb0NvbXBsZXRpb25Qb3J0KG9iai5maWxlbm8oKSwgc2VsZi5faW9jcCwgMCwgMCkKICAgICAgICAgICAgIyBYWFggV2UgY291bGQgYWxzbyB1c2UgU2V0RmlsZUNvbXBsZXRpb25Ob3RpZmljYXRpb25Nb2RlcygpCiAgICAgICAgICAgICMgdG8gYXZvaWQgc2VuZGluZyBub3RpZmljYXRpb25zIHRvIGNvbXBsZXRpb24gcG9ydCBvZiBvcHMKICAgICAgICAgICAgIyB0aGF0IHN1Y2NlZWQgaW1tZWRpYXRlbHkuCgogICAgZGVmIF9yZWdpc3RlcihzZWxmLCBvdiwgb2JqLCBjYWxsYmFjayk6CiAgICAgICAgc2VsZi5fY2hlY2tfY2xvc2VkKCkKCiAgICAgICAgIyBSZXR1cm4gYSBmdXR1cmUgd2hpY2ggd2lsbCBiZSBzZXQgd2l0aCB0aGUgcmVzdWx0IG9mIHRoZQogICAgICAgICMgb3BlcmF0aW9uIHdoZW4gaXQgY29tcGxldGVzLiAgVGhlIGZ1dHVyZSdzIHZhbHVlIGlzIGFjdHVhbGx5CiAgICAgICAgIyB0aGUgdmFsdWUgcmV0dXJuZWQgYnkgY2FsbGJhY2soKS4KICAgICAgICBmID0gX092ZXJsYXBwZWRGdXR1cmUob3YsIGxvb3A9c2VsZi5fbG9vcCkKICAgICAgICBpZiBmLl9zb3VyY2VfdHJhY2ViYWNrOgogICAgICAgICAgICBkZWwgZi5fc291cmNlX3RyYWNlYmFja1stMV0KICAgICAgICBpZiBub3Qgb3YucGVuZGluZzoKICAgICAgICAgICAgIyBUaGUgb3BlcmF0aW9uIGhhcyBjb21wbGV0ZWQsIHNvIG5vIG5lZWQgdG8gcG9zdHBvbmUgdGhlCiAgICAgICAgICAgICMgd29yay4gIFdlIGNhbm5vdCB0YWtlIHRoaXMgc2hvcnQgY3V0IGlmIHdlIG5lZWQgdGhlCiAgICAgICAgICAgICMgTnVtYmVyT2ZCeXRlcywgQ29tcGV0LTAtdXNlciI6ICJmb28iLAogICAgICAgICAgICAidXNlcnNpdGVfc2V0LTAtREVMRVRFIjogIjEiLAogICAgICAgIH0KICAgICAgICBmb3Jtc2V0ID0gZm9ybXNldF9jbHMoZGF0YSwgaW5zdGFuY2U9dSkKICAgICAgICB1cy5kZWxldGUoKQogICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShmb3Jtc2V0LmlzX3ZhbGlkKCkpCiAgICAgICAgZm9ybXNldC5zYXZlKCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKFVzZXJTaXRlLm9iamVjdHMuY291bnQoKSwgMCkKaW1wb3J0IGN0eXBlcwppbXBvcnQgc3lzCmltcG9ydCB1bml0dGVzdApmcm9tIGN0eXBlcyBpbXBvcnQgKENETEwsIFN0cnVjdHVyZSwgQXJyYXksIENGVU5DVFlQRSwKICAgICAgICAgICAgICAgICAgICBieXJlZiwgUE9JTlRFUiwgcG9pbnRlciwgQXJndW1lbnRFcnJvciwgc2l6ZW9mLAogICAgICAgICAgICAgICAgICAgIGNfY2hhciwgY193Y2hhciwgY19ieXRlLCBjX2NoYXJfcCwgY193Y2hhcl9wLAogICAgICAgICAgICAgICAgICAgIGNfc2hvcnQsIGNfaW50LCBjX2xvbmcsIGNfbG9uZ2xvbmcsIGNfdm9pZF9wLAogICAgICAgICAgICAgICAgICAgIGNfZmxvYXQsIGNfZG91YmxlLCBjX2xvbmdkb3VibGUpCmZyb20gdGVzdC5zdXBwb3J0IGltcG9ydCBpbXBvcnRfaGVscGVyCl9jdHlwZXNfdGVzdCA9IGltcG9ydF9oZWxwZXIuaW1wb3J0X21vZHVsZSgiX2N0eXBlc190ZXN0IikKZnJvbSBfY3R5cGVzIGltcG9ydCBfUG9pbnRlciwgIF9TaW1wbGVDRGF0YQoKCnRyeToKICAgIFdJTkZVTkNUWVBFID0gY3R5cGVzLldJTkZVTkNUWVBFCmV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICMgZmFrZSB0byBlbmFibGUgdGhpcyB0ZXN0IG9uIExpbnV4CiAgICBXSU5GVU5DVFlQRSA9IENGVU5DVFlQRQoKZGxsID0gQ0RMTChfY3R5cGVzX3Rlc3QuX19maWxlX18pCmlmIHN5cy5wbGF0Zm9ybSA9PSAid2luMzIiOgogICAgd2luZGxsID0gY3R5cGVzLldpbkRMTChfY3R5cGVzX3Rlc3QuX19maWxlX18pCgoKY2xhc3MgUE9JTlQoU3RydWN0dXJlKToKICAgIF9maWVsZHNfID0gWygieCIsIGNfaW50KSwgKCJ5IiwgY19pbnQpXQoKCmNsYXNzIFJFQ1QoU3RydWN0dXJlKToKICAgIF9maWVsZHNfID0gWygibGVmdCIsIGNfaW50KSwgKCJ0b3AiLCBjX2ludCksCiAgICAgICAgICAgICAgICAoInJpZ2h0IiwgY19pbnQpLCAoImJvdHRvbSIsIGNfaW50KV0KCgpjbGFzcyBGdW5jdGlvblRlc3RDYXNlKHVuaXR0ZXN0LlRlc3RDYXNlKToKCiAgICBkZWYgdGVzdF9tcm8oc2VsZik6CiAgICAgICAgIyBpbiBQeXRob24gMi4zLCB0aGlzIHJhaXNlcyBUeXBlRXJyb3I6IE1STyBjb25mbGljdCBhbW9uZyBiYXNlcyBjbGFzc2VzLAogICAgICAgICMgaW4gUHl0aG9uIDIuMiBpdCB3b3Jrcy4KICAgICAgICAjCiAgICAgICAgIyBCdXQgaW4gZWFybHkgdmVyc2lvbnMgb2YgX2N0eXBlcy5jLCB0aGUgcmVzdWx0IG9mIHRwX25ldwogICAgICAgICMgd2Fzbid0IGNoZWNrZWQsIGFuZCBpdCBldmVsZi5lbmdpbmUuZ2V0X3RlbXBsYXRlKCJpbmRleC5odG1sIikKCiAgICBkZWYgdGVzdF9leHRlbmRzX25vdF9maXJzdF90YWdfaW5fZXh0ZW5kZWRfdGVtcGxhdGVfZnJvbV9zdHJpbmcoc2VsZik6CiAgICAgICAgdGVtcGxhdGVfc3RyaW5nID0gInslIGJsb2NrIGNvbnRlbnQgJX1CeyUgZW5kYmxvY2sgJX17JSBleHRlbmRzICdiYXNlLmh0bWwnICV9IgogICAgICAgIG1zZyA9ICJ7JSBleHRlbmRzICdiYXNlLmh0bWwnICV9IG11c3QgYmUgdGhlIGZpcnN0IHRhZyBpbiB0aGUgdGVtcGxhdGUuIgogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXNNZXNzYWdlKFRlbXBsYXRlU3ludGF4RXJyb3IsIG1zZyk6CiAgICAgICAgICAgIEVuZ2luZSgpLmZyb21fc3RyaW5nKHRlbXBsYXRlX3N0cmluZykKIiIiVXRpbGl0aWVzIGZvciB0ZXN0aW5nIHdpdGggVGtpbnRlciIiIgppbXBvcnQgZnVuY3Rvb2xzCgoKZGVmIHJ1bl9pbl90a19tYWlubG9vcChkZWxheT0xKToKICAgICIiIkRlY29yYXRvciBmb3IgcnVubmluZyBhIHRlc3QgbWV0aG9kIHdpdGggYSByZWFsIFRrIG1haW5sb29wLgoKICAgIFRoaXMgc3RhcnRzIGEgVGsgbWFpbmxvb3AgYmVmb3JlIHJ1bm5pbmcgdGhlIHRlc3QsIGFuZCBzdG9wcyBpdAogICAgYXQgdGhlIGVuZC4gVGhpcyBpcyBmYXN0ZXIgYW5kIG1vcmUgcm9idXN0IHRoYW4gdGhlIGNvbW1vbgogICAgYWx0ZXJuYXRpdmUgbWV0aG9kIG9mIGNhbGxpbmcgLnVwZGF0ZSgpIGFuZC9vciAudXBkYXRlX2lkbGV0YXNrcygpLgoKICAgIFRlc3QgbWV0aG9kcyB1c2luZyB0aGlzIG11c3QgYmUgd3JpdHRlbiBhcyBnZW5lcmF0b3IgZnVuY3Rpb25zLAogICAgdXNpbmcgInlpZWxkIiB0byBhbGxvdyB0aGUgbWFpbmxvb3AgdG8gcHJvY2VzcyBldmVudHMgYW5kICJhZnRlciIKICAgIGNhbGxiYWNrcywgYW5kIHRoZW4gY29udGludWUgdGhlIHRlc3QgZnJvbSB0aGF0IHBvaW50LgoKICAgIFRoZSBkZWxheSBhcmd1bWVudCBpcyBwYXNzZWQgaW50byByb290LmFmdGVyKC4uLikgY2FsbHMgYXMgdGhlIG51bWJlcgogICAgb2YgbXMgdG8gd2FpdCBiZWZvcmUgcGFzc2luZyBleGVjdXRpb24gYmFjayB0byB0aGUgZ2VuZXJhdG9yIGZ1bmN0aW9uLgoKICAgIFRoaXMgYWxzbyBhc3N1bWVzIHRoYXQgdGhlIHRlc3QgY2xhc3MgaGFzIGEgLnJvb3QgYXR0cmlidXRlLAogICAgd2hpY2ggaXMgYSB0a2ludGVyLlRrIG9iamVjdC4KCiAgICBGb3IgZXhhbXBsZSAoZnJvbSB0ZXN0X3NpZGViYXIucHkpOgoKICAgIEBydW5fdGVzdF93aXRoX3RrX21haW5sb29wKCkKICAgIGRlZiB0ZXN0X3NpbmdsZV9lbXB0eV9pbnB1dChzZWxmKToKICAgICAgICBzZWxmLmRvX2lucHV0KCdcbicpCiAgICAgICAgeWllbGQKICAgICAgICBzZWxmLmFzc2VydF9zaWRlYmFyX2xpbmVzX2VuZF93aXRoKFsnPj4+JywgJz4+PiddKQogICAgIiIiCiAgICBkZWYgZGVjb3JhdG9yKHRlc3RfbWV0aG9kKToKICAgICAgICBAZnVuY3Rvb2xzLndyYXBzKHRlc2hlIHJlYWwgVVJMIG9mIHRoZSBwYWdlLgoKICAgICAgICBJbiBzb21lIGNhc2VzLCB0aGUgSFRUUCBzZXJ2ZXIgcmVkaXJlY3RzIGEgY2xpZW50IHRvIGFub3RoZXIKICAgICAgICBVUkwuIFRoZSB1cmxvcGVuKCkgZnVuY3Rpb24gaGFuZGxlcyB0aGlzIHRyYW5zcGFyZW50bHksIGJ1dCBpbgogICAgICAgIHNvbWUgY2FzZXMgdGhlIGNhbGxlciBuZWVkcyB0byBrbm93IHdoaWNoIFVSTCB0aGUgY2xpZW50IHdhcwogICAgICAgIHJlZGlyZWN0ZWQgdG8uIFRoZSBnZXR1cmwoKSBtZXRob2QgY2FuIGJlIHVzZWQgdG8gZ2V0IGF0IHRoaXMKICAgICAgICByZWRpcmVjdGVkIFVSTC4KCiAgICAgICAgJycnCiAgICAgICAgcmV0dXJuIHNlbGYudXJsCgogICAgZGVmIGdldGNvZGUoc2VsZik6CiAgICAgICAgJycnUmV0dXJuIHRoZSBIVFRQIHN0YXR1cyBjb2RlIHRoYXQgd2FzIHNlbnQgd2l0aCB0aGUgcmVzcG9uc2UsCiAgICAgICAgb3IgTm9uZSBpZiB0aGUgVVJMIGlzIG5vdCBhbiBIVFRQIFVSTC4KCiAgICAgICAgJycnCiAgICAgICAgcmV0dXJuIHNlbGYuc3RhdHVzCgoKZGVmIF9jcmVhdGVfaHR0cHNfY29udGV4dChodHRwX3ZlcnNpb24pOgogICAgIyBGdW5jdGlvbiBhbHNvIHVzZWQgYnkgdXJsbGliLnJlcXVlc3QgdG8gYmUgYWJsZSB0byBzZXQgdGhlIGNoZWNrX2hvc3RuYW1lCiAgICAjIGF0dHJpYnV0ZSBvbiBhIGNvbnRleHQgb2JqZWN0LgogICAgY29udGV4dCA9IHNzbC5fY3JlYXRlX2RlZmF1bHRfaHR0cHNfY29udGV4dCgpCiAgICAjIHNlbmQgQUxQTiBleHRlbnNpb24gdG8gaW5kaWNhdGUgSFRUUC8xLjEgcHJvdG9jb2wKICAgIGlmIGh0dHBfdmVyc2lvbiA9PSAxMToKICAgICAgICBjb250ZXh0LnNldF9hbHBuX3Byb3RvY29scyhbJ2h0dHAvMS4xJ10pCiAgICAjIGVuYWJsZSBQSEEgZm9yIFRMUyAxLjMgY29ubmVjdGlvbnMgaWYgYXZhaWxhYmxlCiAgICBpZiBjb250ZXh0LnBvc3RfaGFuZHNoYWtlX2F1dGggaXMgbm90IE5vbmU6CiAgICAgICAgY29udGV4dC5wb3N0X2hhbmRzaGFrZV9hdXRoID0gVHJ1ZQogICAgcmV0dXJuIGNvbnRleHQKCgpjbGFzcyBIVFRQQ29ubmVjdGlvbjoKCiAgICBfaHR0cF92c24gPSAxMQogICAgX2h0dHBfdnNuX3N0ciA9ICdIVFRQLzEuMScKCiAgICByZXNwb25zZV9jbGFzcyA9IEhUVFBSZXNwb25zZQogICAgZGVmYXVsdF9wb3J0ID0gSFRUUF9QT1JUCiAgICBhdXRvX29wZW4gPSAxCiAgICBkZWJ1Z2xldmVsID0gMAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfaXNfdGV4dElPKHN0cmVhbSk6CiAgICAgICAgIiIiVGVzdCB3aGV0aGVyIGEgZmlsZS1saWtlIG9iamVjdCBpcyBhIHRleHQgb3IgYSBiaW5hcnkgc3RyZWFtLgogICAgICAgICIiIgogICAgICAgIHJldHVybiBpc2luc3RhbmNlKHN0cmVhbSwgaW8uVGV4dElPQmFzZSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX2dldF9jb250ZW50X2xlbmd0aChib2R5LCBtZXRob2QpOgogICAgICAgICIiIkdldCB0aGxvd2VkOgojICBfaXNfYWxsb3dlZF91cmxfcGNoYXJzX3JlID0gcmUuY29tcGlsZShyIl5bLyEkJicoKSorLDs9OkAlYS16QS1aMC05Ll9+LV0rJCIpCiMgV2UgYXJlIG1vcmUgbGVuaWVudCBmb3IgYXNzdW1lZCByZWFsIHdvcmxkIGNvbXBhdGliaWxpdHkgcHVycG9zZXMuCgojIFRoZXNlIGNoYXJhY3RlcnMgYXJlIG5vdCBhbGxvd2VkIHdpdGhpbiBIVFRQIG1ldGhvZCBuYW1lcwojIHRvIHByZXZlbnQgaHR0cCBoZWFkZXIgaW5qZWN0aW9uLgpfY29udGFpbnNfZGlzYWxsb3dlZF9tZXRob2RfcGNoYXJfcmUgPSByZS5jb21waWxlKCdbXHgwMC1ceDFmXScpCgojIFdlIGFsd2F5cyBzZXQgdGhlIENvbnRlbnQtTGVuZ3RoIGhlYWRlciBmb3IgdGhlc2UgbWV0aG9kcyBiZWNhdXNlIHNvbWUKIyBzZXJ2ZXJzIHdpbGwgb3RoZXJ3aXNlIHJlc3BvbmQgd2l0aCBhIDQxMQpfTUVUSE9EU19FWFBFQ1RJTkdfQk9EWSA9IHsnUEFUQ0gnLCAnUE9TVCcsICdQVVQnfQoKCmRlZiBfZW5jb2RlKGRhdGEsIG5hbWU9J2RhdGEnKToKICAgICIiIkNhbGwgZGF0YS5lbmNvZGUoImxhdGluLTEiKSBidXQgc2hvdyBhIGJldHRlciBlcnJvciBtZXNzYWdlLiIiIgogICAgdHJ5OgogICAgICAgIHJldHVybiBkYXRhLmVuY29kZSgibGF0aW4tMSIpCiAgICBleGNlcHQgVW5pY29kZUVuY29kZUVycm9yIGFzIGVycjoKICAgICAgICByYWlzZSBVbmljb2RlRW5jb2RlRXJyb3IoCiAgICAgICAgICAgIGVyci5lbmNvZGluZywKICAgICAgICAgICAgZXJyLm9iamVjdCwKICAgICAgICAgICAgZXJyLnN0YXJ0LAogICAgICAgICAgICBlcnIuZW5kLAogICAgICAgICAgICAiJXMgKCUuMjByKSBpcyBub3QgdmFsaWQgTGF0aW4tMS4gVXNlICVzLmVuY29kZSgndXRmLTgnKSAiCiAgICAgICAgICAgICJpZiB5b3Ugd2FudCB0byBzZW5kIGl0IGVuY29kZWQgaW4gVVRGLTguIiAlCiAgICAgICAgICAgIChuYW1lLnRpdGxlKCksIGRhdGFbZXJyLnN0YXJ0OmVyci5lbmRdLCBuYW1lKSkgZnJvbSBOb25lCgpkZWYgX3N0cmlwX2lwdjZfaWZhY2UoZW5jX25hbWU6IGJ5dGVzKSAtPiBieXRlczoKICAgICIiIlJlbW92ZSBpbnRlcmZhY2Ugc2NvcGUgZnJvbSBJUHY2IGFkZHJlc3MuIiIiCiAgICBlbmNfbmFtZSwgcGVyY2VudCwgXyA9IGVuY19uYW1lLnBhcnRpdGlvbihiIiUiKQogICAgaWYgcGVyY2VudDoKICAgICAgICBhc3NlcnQgZW5jX25hbWUuc3RhcnRzd2l0aChiJ1snKSwgZW5jX25hbWUKICAgICAgICBlbmNfbmFtZSArPSBiJ10nCiAgICByZXR1cm4gZW5jX25hbWUKCmNsYXNzIEhUVFBNZXNzYWdlKGVtYWlsLm1lc3NhZ2UuTWVzc2FnZSk6CgogICAgIyBUaGUgZ2V0YWxsbWF0Y2hpbmdoZWFkZXJzKCkgbWV0aG9kIHdhcyBvbmx5IHVzZWQgYnkgdGhlIENHSSBoYW5kbGVyCiAgICAjIHRoYXQgd2FzIHJlbW92ZWQgaW4gUHl0aG9uIDMuMTUuIEhvd2V2ZXIsIHNpbmNlIHRoZSBwdWJsaWMgQVBJIHdhcyBub3QKICAgICMgcHJvcGVybHkgZGVmaW5lZCwgaXQgd2lsR0RBTFJhc3RlciIsCiAgICAiR0RBTF9WRVJTSU9OIiwKICAgICJPR1JHZW9tZXRyeSIsCiAgICAiT0dSR2VvbVR5cGUiLAogICAgIlNwYXRpYWxSZWZlcmVuY2UiLAogICAgIlNSU0V4Y2VwdGlvbiIsCiAgICAiY2hlY2tfZXJyIiwKICAgICJnZGFsX3ZlcnNpb24iLAogICAgImdkYWxfZnVsbF92ZXJzaW9uIiwKKQojIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZCB1bmRlciB0aGUgc2FtZSBsaWNlbnNlIGFzIHRoZSBEamFuZ28gcGFja2FnZS4KIwojIFRoZSAqX0ZPUk1BVCBzdHJpbmdzIHVzZSB0aGUgRGphbmdvIGRhdGUgZm9ybWF0IHN5bnRheCwKIyBzZWUgaHR0cHM6Ly9kb2NzLmRqYW5nb3Byb2plY3QuY29tL2VuL2Rldi9yZWYvdGVtcGxhdGVzL2J1aWx0aW5zLyNkYXRlCkRBVEVfRk9STUFUID0gImogRSBZIgpUSU1FX0ZPUk1BVCA9ICJIOmkiCkRBVEVUSU1FX0ZPUk1BVCA9ICJqIEUgWSBIOmkiCllFQVJfTU9OVEhfRk9STUFUID0gIkYgWSIKTU9OVEhfREFZX0ZPUk1BVCA9ICJqIEUiClNIT1JUX0RBVEVfRk9STUFUID0gImQtbS1ZIgpTSE9SVF9EQVRFVElNRV9GT1JNQVQgPSAiZC1tLVkgIEg6aSIKRklSU1RfREFZX09GX1dFRUsgPSAxICAjIE1vbmRheQoKIyBUaGUgKl9JTlBVVF9GT1JNQVRTIHN0cmluZ3MgdXNlIHRoZSBQeXRob24gc3RyZnRpbWUgZm9ybWF0IHN5bnRheCwKIyBzZWUgaHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9kYXRldGltZS5odG1sI3N0cmZ0aW1lLXN0cnB0aW1lLWJlaGF2aW9yCkRBVEVfSU5QVVRfRk9STUFUUyA9IFsKICAgICIlZC4lbS4lWSIsICAjICcyNS4xMC4yMDA2JwogICAgIiVkLiVtLiV5IiwgICMgJzI1LjEwLjA2JwogICAgIiV5LSVtLSVkIiwgICMgJzA2LTEwLTI1JwogICAgIyAiJWQuICVCICVZIiwgICMgJzI1LiBwYcW6ZHppZXJuaWthIDIwMDYnCiAgICAjICIlZC4gJWIuICVZIiwgICMgJzI1LiBwYcW6LiAyMDA2JwpdCkRBVEVUSU1FX0lOUFVUX0ZPUk1BVFMgPSBbCiAgICAiJWQuJW0uJVkgJUg6JU06JVMiLCAgIyAnMjUuMTAuMjAwNiAxNDozMDo1OScKICAgICIlZC4lbS4lWSAlSDolTTolUy4lZiIsICAjICcyNS4xMC4yMDA2IDE0OjMwOjU5LjAwMDIwMCcKICAgICIlZC4lbS4lWSAlSDolTSIsICAjICcyNS4xMC4yMDA2IDE0OjMwJwpdCkRFQ0lNQUxfU0VQQVJBVE9SID0gIiwiClRIT1VTQU5EX1NFUEFSQVRPUiA9ICLCoCIKTlVNQkVSX0dST1VQSU5HID0gMwojIENvcHlyaWdodCAyMDA5IEJyaWFuIFF1aW5sYW4uIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiMgTGljZW5zZWQgdG8gUFNGIHVuZGVyIGEgQ29udHJpYnV0b3IgQWdyZWVtZW50LgoKIiIiRXhlY3V0ZSBjb21wdXRhdGlvbnMgYXN5bmNocm9ub3VzbHkgdXNpbmcgdGhyZWFkcyBvciBwcm9jZXNzZXMuIiIiCgpfX2F1dGhvcl9fID0gJ0JyaWFuIFF1aW5sYW4gKGJyaWFuQHN3ZWV0YXBwLmNvbSknCgpmcm9tIGNvbmN1cnJlbnQuZnV0dXJlcy5fYmFzZSBpbXBvcnQgKEZJUlNUX0NPTVBMRVRFRCwKICAgLWNvbXByZXNzZWQgZml4dHVyZXMgbXVzdCBjb250YWluIG9uZSBmaWxlLiIpCgogICAgZGVmIHJlYWQoc2VsZik6CiAgICAgICAgcmV0dXJuIHppcGZpbGUuWmlwRmlsZS5yZWFkKHNlbGYsIHNlbGYubmFtZWxpc3QoKVswXSkKCgpkZWYgaHVtYW5pemUoZGlybmFtZSk6CiAgICByZXR1cm4gIiclcyciICUgZGlybmFtZSBpZiBkaXJuYW1lIGVsc2UgImFic29sdXRlIHBhdGgiCiMKIyBNb2R1bGUgcHJvdmlkaW5nIHRoZSBgUG9vbGAgY2xhc3MgZm9yIG1hbmFnaW5nIGEgcHJvY2VzcyBwb29sCiMKIyBtdWx0aXByb2Nlc3NpbmcvcG9vbC5weQojCiMgQ29weXJpZ2h0IChjKSAyMDA2LTIwMDgsIFIgT3Vka2VyawojIExpY2Vuc2VkIHRvIFBTRiB1bmRlciBhIENvbnRyaWJ1dG9yIEFncmVlbWVudC4KIwoKX19hbGxfXyA9IFsnUG9vbCcsICdUaHJlYWRQb29sJ10KCiMKIyBJbXBvcnRzCiMKCmltcG9ydCBjb2xsZWN0aW9ucwppbXBvcnQgaXRlcnRvb2xzCmltcG9ydCBvcwppbXBvcnQgcXVldWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgdGltZQppbXBvcnQgdHJhY2ViYWNrCmltcG9ydCB0eXBlcwppbXBvcnQgd2FybmluZ3MKCiMgSWYgdGhyZWFkaW5nIGlzIGF2YWlsYWJsZSB0aGVuIFRocmVhZFBvb2wgc2hvdWxkIGJlIHByb3ZpZGVkLiAgVGhlcmVmb3JlCiMgd2UgYXZvaWQgdG9wLWxldmVsIGltcG9ydHMgd2hpY2ggYXJlIGxpYWJsZSB0byBmYWlsIG9uIHNvbWUgc3lzdGVtcy4KZnJvbSAuIGltcG9ydCB1dGlsCmZyb20gLiBpbXBvcnQgZ2V0X2NvbnRleHQsIFRpbWVvdXRFcnJvcgpmcm9tIC5jb25uZWN0aW9uIGltcG9ydCB3YWl0CgojCiMgQ29uc3RhbnRzIHJlcHJlc2VudGluZyB0aGUgc3RhdGUgb2YgYSBwb29sCiMKCklOSVQgPSAiSU5JVCIKUlVOID0gIlJVTiIKQ0xPU0UgPSAiQ0xPU0UiClRFUk1JTkFURSA9ICJURVJNSU5BVEUiCgojCiMgTWlzY2VsbGFuZW91cwojCgpqb2JfY291bnRlciA9IGl0ZXJ0b29scy5jb3VudCgpCgpkZWYgbWFwc3RhcihhcmdzKToKICAgIHJldHVybiBsaXN0KG1hcCgqYXJncykpCgpkZWYgc3Rhcm1hcHN0YXIoYXJncyk6CiAgICByZXR1cm4gbGlzdChpdGVydG9vbHMuc3Rhcm1hcChhcmdzWzBdLCBhcmdzWzFdKSkKCiMKIyBIYWNrIHRvIGVtYmVkIHN0cmluZ2lmaWNhdGlvbiBvZiByZW1vdGUgdHJhY2ViYWNrIGluIGxvY2FsIHRyYWNlYmFjawojCgpjbGFzcyBSZW1vdGVUcmFjZWJhY2soRXhjZXB0aW9uKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB0Yik6CiAgICAgICAgc2VsZi50YiA9IHRiCiAgICBkZWYgX19zdHJfXyhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi50YgoKY2xhc3MgRXhjZXB0aW9uV2l0aFRyYWNlYmFjazoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBleGMsIHRiKToKICAgICAgICB0YiA9IHRyYWNlYmFjay5mb3JtYXRfZXhjZXB0aW9uKHR5cGUoZXhjKSwgZXhjLCB0YikKICAgICAgICB0YiA9ICcnLmpvaW4odGIpCiAgICAgICAgc2VsZi5leGMgPSBleGMKICAgIiJQYXJlbk1hdGNoIC0tIGZvciBwYXJlbnRoZXNpcyBtYXRjaGluZy4KCldoZW4geW91IGhpdCBhIHJpZ2h0IHBhcmVuLCB0aGUgY3Vyc29yIHNob3VsZCBtb3ZlIGJyaWVmbHkgdG8gdGhlIGxlZnQKcGFyZW4uICBQYXJlbiBoZXJlIGlzIHVzZWQgZ2VuZXJpY2FsbHk7IHRoZSBtYXRjaGluZyBhcHBsaWVzIHRvCnBhcmVudGhlc2VzLCBzcXVhcmUgYnJhY2tldHMsIGFuZCBjdXJseSBicmFjZXMuCiIiIgpmcm9tIGlkbGVsaWIuaHlwZXJwYXJzZXIgaW1wb3J0IEh5cGVyUGFyc2VyCmZyb20gaWRsZWxpYi5jb25maWcgaW1wb3J0IGlkbGVDb25mCgpfb3BlbmVycyA9IHsnKSc6JygnLCddJzonWycsJ30nOid7J30KQ0hFQ0tfREVMQVkgPSAxMDAgIyBtaWxsaXNlY29uZHMKCmNsYXNzIFBhcmVuTWF0Y2g6CiAgICAiIiJIaWdobGlnaHQgbWF0Y2hpbmcgb3BlbmVycyBhbmQgY2xvc2VycywgKCksIFtdLCBhbmQge30uCgogICAgVGhlcmUgYXJlIHRocmVlIHN1cHBvcnRlZCBzdHlsZXMgb2YgcGFyZW4gbWF0Y2hpbmcuICBXaGVuIGEgcmlnaHQKICAgIHBhcmVuIChvcGVuZXIpIGlzIHR5cGVkOgoKICAgIG9wZW5lciAtLSBoaWdobGlnaHQgdGhlIG1hdGNoaW5nIGxlZnQgcGFyZW4gKGNsb3Nlcik7CiAgICBwYXJlbnMgLS0gaGlnaGxpZ2h0IHRoZSBsZWZ0IGFuZCByaWdodCBwYXJlbnMgKG9wZW5lciBhbmQgY2xvc2VyKTsKICAgIGV4cHJlc3Npb24gLS0gaGlnaGxpZ2h0IHRoZSBlbnRpcmUgZXhwcmVzc2lvbiBmcm9tIG9wZW5lciB0byBjbG9zZXIuCiAgICAoRm9yIGJhY2sgY29tcGF0aWJpbGl0eSwgJ2RlZmF1bHQnIGlzIGEgc3lub255bSBmb3IgJ29wZW5lcicpLgoKICAgIEZsYXNoLWRlbGF5IGlzIHRoZSBtYXhpbXVtIG1pbGxpc2Vjb25kcyB0aGUgaGlnaGxpZ2h0aW5nIHJlbWFpbnMuCiAgICBBbnkgY3Vyc29yIG1vdmVtZW50IChrZXkgcHJlc3Mgb3IgY2xpY2spIGJlZm9yZSB0aGF0IHJlbW92ZXMgdGhlCiAgICBoaWdobGlnaHQuICBJZiBmbGFzaC1kZWxheSBpcyAwLCB0aGVyZSBpcyBubyBtYXhpbXVtLgoKICAgIFRPRE86CiAgICAtIEF1Z21lbnQgYmVsbCgpIHdpdGggbWlzbWF0Y2ggd2FybmluZyBpbiBzdGF0dXMgd2luZG93LgogICAgLSBIaWdobGlnaHQgd2hlbiBjdXJzb3IgaXMgbW92ZWQgdG8gdGhlIHJpZ2h0IG9mIGEgY2xvc2VyLgogICAgICBUaGlzIG1pZ2h0IGJlIHRvbyBleHBlbnNpdmUgdG8gY2hlY2suCiAgICAiIiIKCiAgICBSRVNUT1JFX1ZJUlRVQUxfRVZFTlRfTkFNRSA9ICI8PHBhcmVubWF0Y2gtY2hlY2stcmVzdG9yZT4+IgogICAgIyBXZSB3YW50IHRoZSByZXN0b3JlIGV2ZW50IGJlIGNhbGxlZCBiZWZvcmUgdGhlIHVzdWFsIHJldHVybiBhbmQKICAgICMgYmFja3NwYWNlIGV2ZW50cy4KICAgIFJFU1RPUkVfU0VRVUVOQ0VTID0gKCI8S2V5UHJlc3M+IiwgIjxCdXR0b25QcmVzcz4iLAogICAgICAgICAgICAgICAgICAgICAgICAgIjxLZXktUmV0dXJuPiIsICI8S2V5LUJhY2tTcGFjZT4iKQoKdGVzdC9kYmFwaS5weTogdGVzdHMgZm9yIERCLUFQSSBjb21wbGlhbmNlCiMKIyBDb3B5cmlnaHQgKEMpIDIwMDQtMjAxMCBHZXJoYXJkIEjDpHJpbmcgPGdoQGdoYWVyaW5nLmRlPgojCiMgVGhpcyBmaWxlIGlzIHBhcnQgb2YgcHlzcWxpdGUuCiMKIyBUaGlzIHNvZnR3YXJlIGlzIHByb3ZpZGVkICdhcy1pcycsIHdpdGhvdXQgYW55IGV4cHJlc3Mgb3IgaW1wbGllZAojIHdhcnJhbnR5LiAgSW4gbm8gZXZlbnQgd2lsbCB0aGUgYXV0aG9ycyBiZSBoZWxkIGxpYWJsZSBmb3IgYW55IGRhbWFnZXMKIyBhcmlzaW5nIGZyb20gdGhlIHVzZSBvZiB0aGlzIHNvZnR3YXJlLgojCiMgUGVybWlzc2lvbiBpcyBncmFudGVkIHRvIGFueW9uZSB0byB1c2UgdGhpcyBzb2Z0d2FyZSBmb3IgYW55IHB1cnBvc2UsCiMgaW5jbHVkaW5nIGNvbW1lcmNpYWwgYXBwbGljYXRpb25zLCBhbmQgdG8gYWx0ZXIgaXQgYW5kIHJlZGlzdHJpYnV0ZSBpdAojIGZyZWVseSwgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIHJlc3RyaWN0aW9uczoKIwojIDEuIFRoZSBvcmlnaW4gb2YgdGhpcyBzb2Z0d2FyZSBtdXN0IG5vdCBiZSBtaXNyZXByZXNlbnRlZDsgeW91IG11c3Qgbm90CiMgICAgY2xhaW0gdGhhdCB5b3Ugd3JvdGUgdGhlIG9yaWdpbmFsIHNvZnR3YXJlLiBJZiB5b3UgdXNlIHRoaXMgc29mdHdhcmUKIyAgICBpbiBhIHByb2R1Y3QsIGFuIGFja25vd2xlZGdtZW50IGluIHRoZSBwcm9kdWN0IGRvY3VtZW50YXRpb24gd291bGQgYmUKIyAgICBhcHByZWNpYXRlZCBidXQgaXMgbm90IHJlcXVpcmVkLgojIDIuIEFsdGVyZWQgc291cmNlIHZlcnNpb25zIG11c3QgYmUgcGxhaW5seSBtYXJrZWQgYXMgc3VjaCwgYW5kIG11c3Qgbm90IGJlCiMgICAgbWlzcmVwcmVzZW50ZWQgYXMgYmVpbmcgdGhlIG9yaWdpbmFsIHNvZnR3YXJlLgojIDMuIFRoaXMgbm90aWNlIG1heSBub3QgYmUgcmVtb3ZlZCBvciBhbHRlcmVkIGZyb20gYW55IHNvdXJjZSBkaXN0cmlidXRpb24uCgppbXBvcnQgY29udGV4dGxpYgppbXBvcnQgZnVuY3Rvb2xzCmltcG9ydCBvcwppbXBvcnQgc3FsaXRlMyBhcyBzcWxpdGUKaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHN5cwppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCB1bml0dGVzdAppbXBvcnQgdXJsbGliLnBhcnNlCmltcG9ydCB3YXJuaW5ncwoKZnJvbSB0ZXN0LnN1cHBvcnQgaW1wb3J0ICgKICAgIFNIT1JUX1RJTUVPVVQsIGNoZWNrX2Rpc2FsbG93X2luc3RhbnRpYXRpb24sIHJlcXVpcmVzX3N1YnByb2Nlc3MKKQpmcm9tIHRlc3Quc3VwcG9ydCBpbXBvcnQgZ2NfY29sbGVjdApmcm9tIHRlc3Quc3VwcG9ydCBpbXBvcnQgdGhyZWFkaW5nX2hlbHBlciwgaW1wb3J0X2hlbHBlcgpmcm9tIG9zIGltcG9ydCBTRUVLX1NFVCwgU0VFS19DVVIsIFNFRUtfRU5ECmZyb20gdGVzdC5zdXBwb3J0Lm9zX2hlbHBlciBpbXBvcnQgVEVTVEZOLCBURVNURk5fVU5ERUNPREFCTEUsIHVubGluaywgdGVtcF9kaXIsIEZha2VQYXRoCgpmcm9tIC51dGlsLlRlc3RSZXN1bHQoKQogICAgICAgIHdyYXBwZXIgPSB1bml0dGVzdC5UZXN0U3VpdGUoKQogICAgICAgIHdyYXBwZXIuYWRkVGVzdChzdWl0ZSkKICAgICAgICB3cmFwcGVyKHJlc3VsdCkKICAgICAgICBzZWxmLmFzc2VydFRydWUoc3VpdGUuY2FsbGVkKQoKICAgICAgICAjIHJldXNpbmcgcmVzdWx0cyBzaG91bGQgYmUgcGVybWl0dGVkIGV2ZW4gaWYgYWJvbWluYWJsZQogICAgICAgIHNlbGYuYXNzZXJ0RmFsc2UocmVzdWx0Ll90ZXN0UnVuRW50ZXJlZCkKCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAgdW5pdHRlc3QubWFpbigpCiMhL3Vzci9iaW4vZW52IHB5dGhvbjMKIiIiCkdVSSBmcmFtZXdvcmsgYW5kIGFwcGxpY2F0aW9uIGZvciB1c2Ugd2l0aCBQeXRob24gdW5pdCB0ZXN0aW5nIGZyYW1ld29yay4KRXhlY3V0ZSB0ZXN0cyB3cml0dGVuIHVzaW5nIHRoZSBmcmFtZXdvcmsgcHJvdmlkZWQgYnkgdGhlICd1bml0dGVzdCcgbW9kdWxlLgoKVXBkYXRlZCBmb3IgdW5pdHRlc3QgdGVzdCBkaXNjb3ZlcnkgYnkgTWFyayBSb2RkeSBhbmQgUHl0aG9uIDMKc3VwcG9ydCBieSBCcmlhbiBDdXJ0aW4uCgpCYXNlZCBvbiB0aGUgb3JpZ2luYWwgYnkgU3RldmUgUHVyY2VsbCwgZnJvbToKCiAgaHR0cDovL3B5dW5pdC5zb3VyY2Vmb3JnZS5uZXQvCgpDb3B5cmlnaHQgKGMpIDE5OTksIDIwMDAsIDIwMDEgU3RldmUgUHVyY2VsbApUaGlzIG1vZHVsZSBpcyBmcmVlIHNvZnR3YXJlLCBhbmQgeW91IG1heSByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQppdCB1bmRlciB0aGUgc2FtZSB0ZXJtcyBhcyBQeXRob24gaXRzZWxmLCBzbyBsb25nIGFzIHRoaXMgY29weXJpZ2h0IG1lc3NhZ2UKYW5kIGRpc2NsYWltZXIgYXJlIHJldGFpbmVkIGluIHRoZWlyIG9yaWdpbmFsIGZvcm0uCgpJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SIEJFIExJQUJMRSBUTyBBTlkgUEFSVFkgRk9SIERJUkVDVCwgSU5ESVJFQ1QsClNQRUNJQUwsIElOQ0lERU5UQUwsIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyBBUklTSU5HIE9VVCBPRiBUSEUgVVNFIE9GClRISVMgQ09ERSwgRVZFTiBJRiBUSEUgQVVUSE9SIEhBUyBCRUVOIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0gKREFNQUdFLgoKVEhFIEFVVEhPUiBTUEVDSUZJQ0FMTFkgRElTQ0xBSU1TIEFOWSBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QKTElNSVRFRCBUTywgVEhFIElNUExJRUQgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEKUEFSVElDVUxBUiBQVVJQT1NFLiAgVEhFIENPREUgUFJPVklERUQgSEVSRVVOREVSIElTIE9OIEFOICJBUyBJUyIgQkFTSVMsCkFORCBUSEVSRSBJUyBOTyBPQkxJR0FUSU9OIFdIQVRTT0VWRVIgVE8gUFJPVklERSBNQUlOVEVOQU5DRSwKU1VQUE9SVCwgVVBEQVRFUywgRU5IQU5DRU1FTlRTLCBPUiBNT0RJRklDQVRJT05TLgoiIiIKCl9fYXV0aG9yX18gPSAiU3RldmUgUHVyY2VsbCAoeDE0IC0+IERFVklDRSBDT05UUk9MIEZPVVIKICAgICdceDE1JyAgICAgIyAgMHgxNSAtPiBORUdBVElWRSBBQ0tOT1dMRURHRQogICAgJ1x4MTYnICAgICAjICAweDE2IC0+IFNZTkNIUk9OT1VTIElETEUKICAgICdceDE3JyAgICAgIyAgMHgxNyAtPiBFTkQgT0YgVFJBTlNNSVNTSU9OIEJMT0NLCiAgICAnXHgxOCcgICAgICMgIDB4MTggLT4gQ0FOQ0VMCiAgICAnXHgxOScgICAgICMgIDB4MTkgLT4gRU5EIE9GIE1FRElVTQogICAgJ1x4MWEnICAgICAjICAweDFBIC0+IFNVQlNUSVRVVEUKICAgICdceDFiJyAgICAgIyAgMHgxQiAtPiBFU0NBUEUKICAgICdceDFjJyAgICAgIyAgMHgxQyAtPiBGSUxFIFNFUEFSQVRPUgogICAgJ1x4MWQnICAgICAjICAweDFEIC0+IEdST1VQIFNFUEFSQVRPUgogICAgJ1x4MWUnICAgICAjICAweDFFIC0+IFJFQ09SRCBTRVBBUkFUT1IKICAgICdceDFmJyAgICAgIyAgMHgxRiAtPiBVTklUIFNFUEFSQVRPUgogICAgJyAnICAgICAgICAjICAweDIwIC0+IFNQQUNFCiAgICAnIScgICAgICAgICMgIDB4MjEgLT4gRVhDTEFNQVRJT04gTUFSSwogICAgJyInICAgICAgICAjICAweDIyIC0+IFFVT1RBVElPTiBNQVJLCiAgICAnIycgICAgICAgICMgIDB4MjMgLT4gTlVNQkVSIFNJR04KICAgICckJyAgICAgICAgIyAgMHgyNCAtPiBET0xMQVIgU0lHTgogICAgJyUnICAgICAgICAjICAweDI1IC0+IFBFUkNFTlQgU0lHTgogICAgJyYnICAgICAgICAjICAweDI2IC0+IEFNUEVSU0FORAogICAgIiciICAgICAgICAjICAweDI3IC0+IEFQT1NUUk9QSEUKICAgICcoJyAgICAgICAgIyAgMHgyOCAtPiBMRUZUIFBBUkVOVEhFU0lTCiAgICAnKScgICAgICAgICMgIDB4MjkgLT4gUklHSFQgUEFSRU5USEVTSVMKICAgICcqJyAgICAgICAgIyAgMHgyQSAtPiBBU1RFUklTSwogICAgJysnICAgICAgICAjICAweDJCIC0+IFBMVVMgU0lHTgogICAgJywnICAgICAgICAjICAweDJDIC0+IENPTU1BCiAgICAnLScgICAgICAgICMgIDB4MkQgLT4gSFlQSEVOLU1JTlVTCiAgICAnLicgICAgICAgICMgIDB4MkUgLT4gRlVMTCBTVE9QCiAgICAnLycgICAgICAgICMgIDB4MkYgLT4gU09MSURVUwogICAgJzAnICAgICAgICAjICAweDMwIC0+IERJR0lUIFpFUk8KICAgICcxJyAgICAgICAgIyAgMHgzMSAtPiBESUdJVCBPTkUKICAgICcyJyAgICAgICAgIyAgMHgzMiAtPiBESUdJVCBUV08KICAgICczJyAgICAgICAgIyAgMHgzMyAtPiBESUdJVCBUSFJFRQogICAgJzQnICAgICAgICAjICAweDM0IC0+IERJR0lUIEZPVVIKICAgICc1JyAgICAgICAgIyAgMHgzNSAtPiBESUdJVCBGSVZFCiAgICAnNicgICAgICAgICMgIDB4MzYgLT4gRElHSVQgU0lYCiAgICAnNycgICAgICAgICMgIDB4MzcgLT4gRElHSVQgU0VWRU4KICAgICc4JyAgICAgICAgIyAgMHgzOCAtPiBESUdJVCBFSUdIVAogICAgJzknICAgICAgICAjICAweDM5IC0+IERJR0lUIE5JTkUKICAgICc6JyAgICAgICAgIyAgMHgzQSAtPiBDT0xPTgogICAgJzsnICAgICAgIHBvcyA9IHBhcmVudHBvcwogICAgICAgICAgICBjb250aW51ZQogICAgICAgIGJyZWFrCiAgICBoZWFwW3Bvc10gPSBuZXdpdGVtCgojIFRoZSBjaGlsZCBpbmRpY2VzIG9mIGhlYXAgaW5kZXggcG9zIGFyZSBhbHJlYWR5IGhlYXBzLCBhbmQgd2Ugd2FudCB0byBtYWtlCiMgYSBoZWFwIGF0IGluZGV4IHBvcyB0b28uICBXZSBkbyB0aGlzIGJ5IGJ1YmJsaW5nIHRoZSBzbWFsbGVyIGNoaWxkIG9mCiMgcG9zIHVwIChhbmQgc28gb24gd2l0aCB0aGF0IGNoaWxkJ3MgY2hpbGRyZW4sIGV0YykgdW50aWwgaGl0dGluZyBhIGxlYWYsCiMgdGhlbiB1c2luZyBfc2lmdGRvd24gdG8gbW92ZSB0aGUgb2RkYmFsbCBvcmlnaW5hbGx5IGF0IGluZGV4IHBvcyBpbnRvIHBsYWNlLgojCiMgV2UgKmNvdWxkKiBicmVhayBvdXQgb2YgdGhlIGxvb3AgYXMgc29vbiBhcyB3ZSBmaW5kIGEgcG9zIHdoZXJlIG5ld2l0ZW0gPD0KIyBib3RoIGl0cyBjaGlsZHJlbiwgYnV0IHR1cm5zIG91dCB0aGF0J3Mgbm90IGEgZ29vZCBpZGVhLCBhbmQgZGVzcGl0ZSB0aGF0CiMgbWFueSBib29rcyB3cml0ZSB0aGUgYWxnb3JpdGhtIHRoYXQgd2F5LiAgRHVyaW5nIGEgaGVhcCBwb3AsIHRoZSBsYXN0IGFycmF5CiMgZWxlbWVudCBpcyBzaWZ0ZWQgaW4sIGFuZCB0aGF0IHRlbmRzIHRvIGJlIGxhcmdlLCBzbyB0aGF0IGNvbXBhcmluZyBpdAojIGFnYWluc3QgdmFsdWVzIHN0YXJ0aW5nIGZyb20gdGhlIHJvb3QgdXN1YWxseSBkb2Vzbid0IHBheSAoPSB1c3VhbGx5IGRvZXNuJ3QKIyBnZXQgdXMgb3V0IG9mIHRoZSBsb29wIGVhcmx5KS4gIFNlZSBLbnV0aCwgVm9sdW1lIDMsIHdoZXJlIHRoaXMgaXMKIyBleHBsYWluZWQgYW5kIHF1YW50aWZpZWQgaW4gYW4gZXhlcmNpc2UuCiMKIyBDdXR0aW5nIHRoZSAjIG9mIGNvbXBhcmlzb25zIGlzIGltcG9ydGFudCwgc2luY2UgdGhlc2Ugcm91dGluZXMgaGF2ZSBubwojIHdheSB0byBleHRyYWN0ICJ0aGUgcHJpb3JpdHkiIGZyb20gYW4gYXJyYXkgZWxlbWVudCwgc28gdGhhdCBpbnRlbGxpZ2VuY2UKIyBpcyBsaWtlbHkgdG8gYmUgaGlkaW5nIGluIGN1c3RvbSBjb21wYXJpc29uIG1ldGhvZHMsIG9yIGluIGFycmF5IGVsZW1lbnRzCiMgc3RvcmluZyAocHJpb3JpdHksIHJlY29yZCkgdHVwbGVzLiAgQ29tcGFyaXNvbnMgYXJlIHRodXMgcG90ZW50aWFsbHkKIyBleHBlbnNpdmUuCiMKIyBPbiByYW5kb20gYXJyYXlzIG9mIGxlbmd0aCAxMDAwLCBtYWtpbmcgdGhpcyBjaGFuZ2UgY3V0IHRoZSBudW1iZXIgb2YKIyBjb21wYXJpc29ucyBtYWRlIGJ5IGhlYXBpZnkoKSBhIGxpdHRsZSwgYW5kIHRob3NlIG1hZGUgYnkgZXhoYXVzdGl2ZQojIGhlYXBwb3AoKSBhIGxvdCwgaW4gYWNjb3JkIHdpdGggdGhlb3J5LiAgSGVyZSBhcmUgdHlwaWNhbCByZXN1bHRzIGZyb20gMwojIHJ1bnMgKDMganVzdCB0byBkZW1vbnN0cmF0ZSBob3cgc21hbGwgdGhlIHZhcmlhbmNlIGlzKToKIwojIENvbXBhcmVzIG5lZWRlZCBieSBoICAgIGZlZWRnZW5lcmF0b3IuRW5jbG9zdXJlKCJodHRwOi8vZXhhbXBsZS5jb20vZ29vZGJ5ZS5wbmciLCAiMCIsICJpbWFnZS9wbmciKSwKICAgICAgICBdCiIiIkZhY2lsaXR5IHRvIHVzZSB0aGUgRXhwYXQgcGFyc2VyIHRvIGxvYWQgYSBtaW5pZG9tIGluc3RhbmNlCmZyb20gYSBzdHJpbmcgb3IgZmlsZS4KClRoaXMgYXZvaWRzIGFsbCB0aGUgb3ZlcmhlYWQgb2YgU0FYIGFuZCBwdWxsZG9tIHRvIGdhaW4gcGVyZm9ybWFuY2UuCiIiIgoKIyBXYXJuaW5nIQojCiMgVGhpcyBtb2R1bGUgaXMgdGlnaHRseSBib3VuZCB0byB0aGUgaW1wbGVtZW50YXRpb24gZGV0YWlscyBvZiB0aGUKIyBtaW5pZG9tIERPTSBhbmQgY2FuJ3QgYmUgdXNlZCB3aXRoIG90aGVyIERPTSBpbXBsZW1lbnRhdGlvbnMuICBUaGlzCiMgaXMgZHVlLCBpbiBwYXJ0LCB0byBhIGxhY2sgb2YgYXBwcm9wcmlhdGUgbWV0aG9kcyBpbiB0aGUgRE9NICh0aGVyZSBpcwojIG5vIHdheSB0byBjcmVhdGUgRW50aXR5IGFuZCBOb3RhdGlvbiBub2RlcyB2aWEgdGhlIERPTSBMZXZlbCAyCiMgaW50ZXJmYWNlKSwgYW5kIGZvciBwZXJmb3JtYW5jZS4gIFRoZSBsYXR0ZXIgaXMgdGhlIGNhdXNlIG9mIHNvbWUgZmFpcmx5CiMgY3J5cHRpYyBjb2RlLgojCiMgUGVyZm9ybWFuY2UgaGFja3M6CiMKIyAgIC0gIC5jaGFyYWN0ZXJfZGF0YV9oYW5kbGVyKCkgaGFzIGFuIGV4dHJhIGNhc2UgaW4gd2hpY2ggY29udGludWluZwojICAgICAgZGF0YSBpcyBhcHBlbmRlZCB0byBhbiBleGlzdGluZyBUZXh0IG5vZGU7IHRoaXMgY2FuIGJlIGEKIyAgICAgIHNwZWVkdXAgc2luY2UgcHlleHBhdCBjYW4gYnJlYWsgdXAgY2hhcmFjdGVyIGRhdGEgaW50byBtdWx0aXBsZQojICAgICAgY2FsbGJhY2tzIGV2ZW4gdGhvdWdoIHdlIHNldCB0aGUgYnVmZmVyX3RleHQgYXR0cmlidXRlIG9uIHRoZQojICAgICAgcGFyc2VyLiAgVGhpcyBhbHNvIGdpdmVzIHVzIHRoZSBhZHZhbnRhZ2UgdGhhdCB3ZSBkb24ndCBuZWVkIGEKIyAgICAgIHNlcGFyYXRlIG5vcm1hbGl6YXRpb24gcGFzcy4KIwojICAgLSAgRGV0ZXJtaW5pbmcgdGhhdCBhIG5vZGUgZXhpc3RzIGlzIGRvbmUgdXNpbmcgYW4gaWRlbnRpdHkgY29tcGFyaXNvbgojICAgICAgd2l0aCBOb25lIHJhdGhlciB0aGFuIGEgdHJ1dGggdGVzdDsgdGhpcyBhdm9pZHMgc2VhcmNoaW5nIGZvciBhbmQKIyAgICAgIGNhbGxpbmcgYW55IG1ldGhvZHMgb24gdGhlIG5vZGUgb2JqZWN0IGlmIGl0IGV4aXN0cy4gIChBIHJhdGhlcgojICAgICAgbmljZSBzcGVlZHVwIGlzIGFjaGlldmVkIHRoaXMgd2F5IGFzIHdlbGwhKQoKZnJvbSB4bWwuZG9tIGltcG9ydCB4bWxidWlsZGVyLCBtaW5pZG9tLCBOb2RlCmZyb20geG1sLmRvbSBpbXBvcnQgRU1QVFlfTkFNRVNQQUNFLCBFTVBUWV9QUkVGSVgsIFhNTE5TX05BTUVTUEFDRQpmcm9tIHhtbC5wYXJzZXJzIGltcG9ydCBleHBhdApmcm9tIHhtbC5kb20ubWluaWRvbSBpbXBvcnQgX2FwcGVuZF9jaGlsb3J0IGluc3BlY3QKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgc2lnbmFsCmZyb20gLiBpbXBvcnQgY29yb3V0aW5lcwpmcm9tIC4gaW1wb3J0IGV2ZW50cwpmcm9tIC4gaW1wb3J0IGV4Y2VwdGlvbnMKZnJvbSAuIGltcG9ydCB0YXNrcwpmcm9tIC4gaW1wb3J0IGNvbnN0YW50cwoKY2xhc3MgX1N0YXRlKGVudW0uRW51bSk6CiAgICBDUkVBVEVEID0gImNyZWF0ZWQiCiAgICBJTklUSUFMSVpFRCA9ICJpbml0aWFsaXplZCIKICAgIENMT1NFRCA9ICJjbG9zZWQiCgoKY2xhc3MgUnVubmVyOgogICAgIiIiQSBjb250ZXh0IG1hbmFnZXIgdGhhdCBjb250cm9scyBldmVudCBsb29wIGxpZmUgY3ljbGUuCgogICAgVGhlIGNvbnRleHQgbWFuYWdlciBhbHdheXMgY3JlYXRlcyBhIG5ldyBldmVudCBsb29wLAogICAgYWxsb3dzIHRvIHJ1biBhc3luYyBmdW5jdGlvbnMgaW5zaWRlIGl0LAogICAgYW5kIHByb3Blcmx5IGZpbmFsaXplcyB0aGUgbG9vcCBhdCB0aGUgY29udGV4dCBtYW5hZ2VyIGV4aXQuCgogICAgSWYgZGVidWcgaXMgVHJ1ZSwgdGhlIGV2ZW50IGxvb3Agd2lsbCBiZSBydW4gaW4gZGVidWcgbW9kZS4KICAgIElmIGxvb3BfZmFjdG9yeSBpcyBwYXNzZWQsIGl0IGlzIHVzZWQgZm9yIG5ldyBldmVudCBsb29wIGNyZWF0aW9uLgoKICAgIGFzeW5jaW8ucnVuKG1haW4oKSwgZGVidWc9VHJ1ZSkKCiAgICBpcyBhIHNob3J0Y3V0IGZvcgoKICAgIHdpdGggYXN5bmNpby5SdW5uZXIoZGVidWc9VHJ1ZSkgYXMgcnVubmVyOgogICAgICAgIHJ1bm5lci5ydW4obWFpbigpKQoKICAgIFRoZSBydW4oKSBtZXRob2QgY2FuIGJlIGNhbGxlZCBtdWx0aXBsZSB0aW1lcyB3aXRoaW4gdGhlIHJ1bm5lcidzIGNvbnRleHQuCgogICAgVGhpcyBjYW4gYmUgdXNlZnVsIGZvciBpbnRlcmFjdGl2ZSBjb25zb2xlIChlLmcuIElQeXRob24pLAogICAgdW5pdHRlc3QgcnVubmVycywgY29uc29sZSB0b29scywgLS0gZXZlcnl3aGVyZSB3aGVuIGFzeW5jIGNvZGUKICAgIGlzIGNhbGxlZCBmcm9tIGV4aXN0aW5nIHN5bmMgZnJhbWV3b3JrIGFuZCB3aGVyZSB0aGUgcHJlZmVycmVkIHNpbmdsZQogICAgYXN5bmNpby5ydW4oKSBjYWxsIGRvZXNuJ3Qgd29yay4KCiAgICAiIiIKCiAgICAjIE5vdGU6IHRoZSBjbGFzcyBpcyBmaW5hbCwgaXQgaXMgbm90IGludGVuZGVkIGZvciBpbmhlcml0YW5jZS4KCiAgICBkZWYgX19pbml0X18oc2VsZiwgKiwgZGVidWc9Tm9uZSwgbG9vcF9mYWN0b3J5PU5vbmUpOgogICAgICAgIHNlbGYuX3N0YXRlID0gX1N0YXRlLkNSRUFURUQKICAgICAgICBzZWxmLl9kZWJ1ZyA9IGRlYnVnCiAgICAgICAgc2VsZi5fbG9vcF9mYWN0b3J5ID0gbG9vcF9mYWN0b3J5CiAgICAgICAgc2VsZi5fbG9vcCA9IE5vbmUKICAgICAgICBzZWxmLl9jb250ZXh0ID0gTm9uZQogICAgICAgIHNlbGYuX2ludGVycnVwdF9jb3VudCA9IDAKICAgICAgICBzZWxmLl9zZXRfZXZlbnRfbG9vcCA9IEZhbHNlCgogICAgZGVmIF9fZW50ZXJfXyhzbnRpb24gImFzLWlzIiBmb3IgMzItYml0CiAgICBhcmNoaXZlIG1lbWJlcnMgYnV0IHVzZWQgYW4gImRpc3Rpbmd1aXNoaW5nIiBuYW1lIGZvciA2NC1iaXQgbWVtYmVycy4KICAgIFRoaXMgc2NoZW1lIGluc2VydGVkIGVpdGhlciA2NCBvciBfNjQgYmV0d2VlbiBsaWJGT08gYW5kIC5zbwogICAgLSBnZW5lcmFsbHkgbGliRk9PXzY0LnNvLCBidXQgb2NjYXNpb25hbGx5IGxpYkZPTzY0LnNvCiAgICAiIiIKICAgICMgdGhlIGV4cHJlc3Npb24gZW5kaW5nIGZvciB2ZXJzaW9ucyBtdXN0IHN0YXJ0IGFzCiAgICAjICcuc28uWzAtOV0nLCBpLmUuLCAqLnNvLlthdCBsZWFzdCBvbmUgZGlnaXRdCiAgICAjIHdoaWxlIG11bHRpcGxlLCBtb3JlIHNwZWNpZmljIGV4cHJlc3Npb25zIGNvdWxkIGJlIHNwZWNpZmllZAogICAgIyB0byBzZWFyY2ggZm9yIC5zby5YLCAuc28uWC5ZIGFuZCAuc28uWC5ZLloKICAgICMgYWZ0ZXIgdGhlIGZpcnN0IHJlcXVpcmVkICdkb3QnIGRpZ2l0CiAgICAjIGFueSBjb21iaW5hdGlvbiBvZiBhZGRpdGlvbmFsICdkb3QnIGRpZ2l0cyBwYWlycyBhcmUgYWNjZXB0ZWQKICAgICMgYW55dGhpbmcgbW9yZSB0aGFuIGxpYkZPTy5zby5kaWdpdHMuZGlnaXRzLmRpZ2l0cwogICAgIyBzaG91bGQgYmUgc2VlbiBhcyBhIG1lbWJlciBuYW1lIG91dHNpZGUgbm9ybWFsIGV4cGVjdGF0aW9ucwogICAgZXhwcnMgPSBbcmYnbGlie25hbWV9XC5zb1wuWzAtOV0rWzAtOS5dKicsCiAgICAgICAgcmYnbGlie25hbWV9Xz82NFwuc29cLlswLTldK1swLTkuXSonXQogICAgZm9yIGV4cHIgaW4gZXhwcnM6CiAgICAgICAgdmVyc2lvbnMgPSBbXQogICAgICAgIGZvciBsaW5lIGluIG1lbWJlcnM6CiAgICAgICAgICAgIG0gPSByZS5zZWFyY2goZXhwciwgbGluZSkKICAgICAgICAgICAgaWYgbToKICAgICAgICAgICAgICAgIHZlcnNpb25zLmFwcGVuZChtLmdyb3VwKDApKQogICAgICAgIGlmIHZlcnNpb25zOgogICAgICAgICAgICByZXR1cm4gX2xhc3RfdmVyc2lvbih2ZXJzaW9ucywgJy4nKQogICAgcmV0dXJuIE5vbmUKCmRlZiBnZXRfbWVtYmVyKG5hbWUsIG1lbWJlcnMpOgogICAgIiIiCiAgICBSZXR1cm4gYW4gYXJjaGl2ZSBtZW1iZXIgbWF0Y2hpbmcgdGhlIHJlcXVlc3QgaW4gbmFtZS4KICAgIE5hbWUgaXMgdGhlIGxpYnJhcnkgbmFtZSB3aXRob3V0IGFueSBwcmVmaXggbGlrZSBsaWIsIHN1ZmZpeCBsaWtlIC5zbywKICAgIG9yIHZlcnNpb24gbnVtYmVyLgogICAgR2l2ZW4gYSBsaXN0IG9mIG1lbWJlcnMgZmluZCBhbmQgcmV0dXJuIHRoZSBtb3N0IGFwcHJvcHJpYXRlIHJlc3VsdAogICAgUHJpb3JpdHkgaXMgZ2l2ZW4gdG8gZ2VuZXJpYyBsaWJYWFguc28sIHRoZW4gYSB2ZXJzaW9uZWQgbGliWFhYLnNvLmEuYi5jCiAgICBhbmQgZmluYWxseSwgbGVnYWN5IEFJWCBuYW1pbmcgc2NoZW1lLgogICAgIiIiCiAgICAjIGxvb2sgZmlyc3QgZm9yIGEgZ2VuZXJpYyBtYXRjaCAtIHByZXBlbmQgbGliIGFuZCBhcHBlZGVyIGltcG9ydCBNaWdyYXRpb25SZWNvcmRlcgoKZnJvbSAuZXhjZXB0aW9ucyBpbXBvcnQgKAogICAgQW1iaWd1aXR5RXJyb3IsCiAgICBCYWRNaWdyYXRpb25FcnJvciwKICAgIEluY29uc2lzdGVudE1pZ3JhdGlvbkhpc3RvcnksCiAgICBOb2RlTm90Rm91bmRFcnJvciwKKQoKTUlHUkFUSU9OU19NT0RVTEVfTkFNRSA9ICJtaWdyYXRpb25zIgoKCmNsYXNzIE1pZ3JhdGlvbkxvYWRlcjoKICAgICIiIgogICAgTG9hZCBtaWdyYXRpb24gZmlsZXMgZnJvbSBkaXNrIGFuZCB0aGVpciBzdGF0dXMgZnJvbSB0aGUgZGF0YWJhc2UuCgogICAgTWlncmF0aW9uIGZpbGVzIGFyZSBleHBlY3RlZCB0byBsaXZlIGluIHRoZSAibWlncmF0aW9ucyIgZGlyZWN0b3J5IG9mCiAgICBhbiBhcHAuIFRoZWlyIG5hbWVzIGFyZSBlbnRpcmVseSB1bmltcG9ydGFudCBmcm9tIGEgY29kZSBwZXJzcGVjdGl2ZSwKICAgIGJ1dCB3aWxsIHByb2JhYmx5IGZvbGxvdyB0aGUgMTIzNF9uYW1lLnB5IGNvbnZlbnRpb24uCgogICAgT24gaW5pdGlhbGl6YXRpb24sIHRoaXMgY2xhc3Mgd2lsbCBzY2FuIHRob3NlIGRpcmVjdG9yaWVzLCBhbmQgb3BlbiBhbmQKICAgIHJlYWQgdGhlIFB5dGhvbiBmaWxlcywgbG9va2luZyBmb3IgYSBjbGFzcyBjYWxsZWQgTWlncmF0aW9uLCB3aGljaCBzaG91bGQKICAgIGluaGVyaXQgZnJvbSBkamFuZ28uZGIubWlncmF0aW9ucy5NaWdyYXRpb24uIFNlZQogICAgZGphbmdvLmRiLm1pZ3JhdGlvbnMubWlncmF0aW9uIGZvciB3aGF0IHRoYXQgbG9va3MgbGlrZS4KCiAgICBTb21lIG1pZ3JhdGlvbnMgd2lsbCBiZSBtYXJrZWQgYXMgInJlcGxhY2luZyIgYW5vdGhlciBzZXQgb2YgbWlncmF0aW9ucy4KICAgIFRoZXNlIGFyZSBsb2FkZWQgaW50byBhIHNlcGFyYXRlIHNldCBvZiBtaWdyYXRpb25zIGF3YXkgZnJvbSB0aGUgbWFpbiBvbmVzLgogICAgSWYgYWxsIHRoZSBtaWdyYXRpb25zIHRoZXkgcmVwbGFjZSBhcmUgZWl0aGVyIHVuYXBwbGllZCBvciBtaXNzaW5nIGZyb20KICAgIGRpc2ssIHRoZW4gdGhleSBhcmUgaW5qZWN0ZWQgaW50byB0aGUgbWFpbiBzZXQsIHJlcGxhY2luZyB0aGUgbmFtZWQKICAgIG1pZ3JhdGlvbnMuIEFueSBkZXBlbmRlbmN5IHBvaW50ZXJzIHRvIHRoZSByZXBsYWNlZCBtaWdyYXRpb25zIGFyZQogICAgcmUtcG9pbnRlZCB0byB0aGUgbmV3IG1pZ3JhdGlvbi4KCiAgICBUaGlzIGRvZXMgbWVhbiB0aGF0IHRoaXMgY2xhc3MgTVVTVCBhbHNvIHRhbGsgdG8gdGhlIGRhdGFiYXNlIGFzIHdlbGwgYXMKICAgIHRvIGRpc2ssIGJ1dCB0aGlzIGlzIHByb2JhYmx5IGZpbmUuIFdlJ3JlIGFscmVhZHkgbm90IGp1c3Qgb3BlcmF0aW5nCiAgICBpbiBtZW1vcnkuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBjb25uZWN0aW9uLAogICAgICAgIGxvYWQ9VHJ1ZSwKICAgICAgICBpZ25vcmVfbm9fbWlncmF0aW9ucz1GYWxzZSwKICAgICAgICByZXBsYWNlX21pZ3JpZWxkIHNlbGYuX21hcHBpbmdba2V5XQoKY2xhc3MgX0xpbmsob2JqZWN0KToKICAgIF9fc2xvdHNfXyA9ICdwcmV2JywgJ25leHQnLCAna2V5JywgJ19fd2Vha3JlZl9fJwoKY2xhc3MgT3JkZXJlZERpY3QoZGljdCk6CiAgICAnRGljdGlvbmFyeSB0aGF0IHJlbWVtYmVycyBpbnNlcnRpb24gb3JkZXInCiAgICAjIEFuIGluaGVyaXRlZCBkaWN0IG1hcHMga2V5cyB0byB2YWx1ZXMuCiAgICAjIFRoZSBpbmhlcml0ZWQgZGljdCBwcm92aWRlcyBfX2dldGl0ZW1fXywgX19sZW5fXywgX19jb250YWluc19fLCBhbmQgZ2V0LgogICAgIyBUaGUgcmVtYWluaW5nIG1ldGhvZHMgYXJlIG9yZGVyLWF3YXJlLgogICAgIyBCaWctTyBydW5uaW5nIHRpbWVzIGZvciBhbGwgbWV0aG9kcyBhcmUgdGhlIHNhbWUgYXMgcmVndWxhciBkaWN0aW9uYXJpZXMuCgogICAgIyBUaGUgaW50ZXJuYWwgc2VsZi5fX21hcCBkaWN0IG1hcHMga2V5cyB0byBsaW5rcyBpbiBhIGRvdWJseSBsaW5rZWQgbGlzdC4KICAgICMgVGhlIGNpcmN1bGFyIGRvdWJseSBsaW5rZWQgbGlzdCBzdGFydHMgYW5kIGVuZHMgd2l0aCBhIHNlbnRpbmVsIGVsZW1lbnQuCiAgICAjIFRoZSBzZW50aW5lbCBlbGVtZW50IG5ldmVyIGdldHMgZGVsZXRlZCAodGhpcyBzaW1wbGlmaWVzIHRoZSBhbGdvcml0aG0pLgogICAgIyBUaGUgc2VudGluZWwgaXMgaW4gc2VsZi5fX2hhcmRyb290IHdpdGggYSB3ZWFrcmVmIHByb3h5IGluIHNlbGYuX19yb290LgogICAgIyBUaGUgcHJldiBsaW5rcyBhcmUgd2Vha3JlZiBwcm94aWVzICh0byBwcmV2ZW50IGNpcmN1bGFyIHJlZmVyZW5jZXMpLgogICAgIyBJbmRpdmlkdWFsIGxpbmtzIGFyZSBrZXB0IGFsaXZlIGJ5IHRoZSBoYXJkIHJlZmVyZW5jZSBpbiBzZWxmLl9fbWFwLgogICAgIyBUaG9zZSBoYXJkIHJlZmVyZW5jZXMgZGlzYXBwZWFyIHdoZW4gYSBrZXkgaXMgZGVsZXRlZCBmcm9tIGFuIE9yZGVyZWREaWN0LgoKICAgIGRlZiBfX25ld19fKGNscywgLywgKmFyZ3MsICoqa3dkcyk6CiAgICAgICAgIkNyZWF0ZSB0aGUgb3JkZXJlZCBkaWN0IG9iamVjdCBhbmQgc2V0IHVwIHRoZSB1bmRlcmx5aW5nIHN0cnVjdHVyZXMuIgogICAgICAgIHNlbGYgPSBkaWN0Ll9fbmV3X18oY2xzKQogICAgICAgIHNlbGYuX19oYXJkcm9vdCA9IF9MaW5rKCkKICAgICAgICBzZWxmLl9fcm9vdCA9IHJvb3QgPSBfcHJveHkoc2VsZi5fX2hhcmRyb290KQogICAgICAgIHJvb3QucHJldiA9IHJvb3QubmV4dCA9IHJvb3QKICAgICAgICBzZWxmLl9fbWFwID0ge30KICAgICAgICByZXR1cm4gc2VsZgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBvdGhlcj0oKSwgLywgKiprd2RzKToKICAgICAgICAnJydJbml0aWFsaXplIGFuIG9yZGVyZWQgZGljdGlvbmFyeS4gIFRoZSBzaWduYXR1cmUgaXMgdGhlIHNhbWUgYXMKICAgICAgICByZWd1bGFyIGRpY3Rpb25hcmllcy4gIEtleXdvcmQgYXJndW1lbnQgb3JkZXIgaXMgcHJlc2VydmVkLgogICAgICAgICcnJwogICBvcnQgdGhyZWFkaW5nCmltcG9ydCB1bml0dGVzdAoKZnJvbSB0ZXN0LnN1cHBvcnQgaW1wb3J0IHNvY2tldF9oZWxwZXIKZnJvbSB0ZXN0LnRlc3RfYXN5bmNpbyBpbXBvcnQgdXRpbHMgYXMgdGVzdF91dGlscwpmcm9tIHRlc3QudGVzdF9hc3luY2lvIGltcG9ydCBmdW5jdGlvbmFsIGFzIGZ1bmNfdGVzdHMKCgpkZWYgdGVhckRvd25Nb2R1bGUoKToKICAgIGFzeW5jaW8uZXZlbnRzLl9zZXRfZXZlbnRfbG9vcF9wb2xpY3koTm9uZSkKCgpjbGFzcyBCYXNlU3RhcnRTZXJ2ZXIoZnVuY190ZXN0cy5GdW5jdGlvbmFsVGVzdENhc2VNaXhpbik6CgogICAgZGVmIG5ld19sb29wKHNlbGYpOgogICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IKCiAgICBkZWYgdGVzdF9zdGFydF9zZXJ2ZXJfMShzZWxmKToKICAgICAgICBIRUxMT19NU0cgPSBiJzEnICogMTAyNCAqIDUgKyBiJ1xuJwoKICAgICAgICBkZWYgY2xpZW50KHNvY2ssIGFkZHIpOgogICAgICAgICAgICBmb3IgaSBpbiByYW5nZSgxMCk6CiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDAuMikKICAgICAgICAgICAgICAgIGlmIHNydi5pc19zZXJ2aW5nKCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcgoKICAgICAgICAgICAgc29jay5zZXR0aW1lb3V0KDIpCiAgICAgICAgICAgIHNvY2suY29ubmVjdChhZGRyKQogICAgICAgICAgICBzb2NrLnNlbmQoSEVMTE9fTVNHKQogICAgICAgICAgICBzb2NrLnJlY3ZfYWxsKDEpCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICBhc3luYyBkZWYgc2VydmUocmVhZGVyLCB3cml0ZXIpOgogICAgICAgICAgICBhd2FpdCByZWFkZXIucmVhZGxpbmUoKQogICAgICAgICAgICBtYWluX3Rhc2suY2FuY2VsKCkKICAgICAgICAgICAgd3JpdGVyLndyaXRlKGInMScpCiAgICAgICAgICAgIHdyaXRlci5jbG9zZSgpCiAgICAgICAgICAgIGF3YWl0IHdyaXRlci53YWl0X2Nsb3NlZCgpCgogICAgICAgIGFzeW5jIGRlZiBtYWluKHNydik6CiAgICAgICAgICAgIGFzeW5jIHdpdGggc3J2OgogICAgICAgICAgICAgICAgYXdhaXQgc3J2LnNlcnZlX2ZvcmV2ZXIoKQoKICAgICAgICBzcnYgPSBzZWxmLmxvb3AucnVuX3VudGlsX2NvbXBsZXRlKGFzeW5jaW8uc3RhcnRfc2VydmVyKAogICAgICAgICAgICBzZXJ2ZSwgc29ja2V0X2hlbHBlci5IT1NUdjQsIDAsIHN0YXJ0X3NlcnZpbmc9RmFsc2UpKQoKICAgICAgICBzZWxmLmFzc2VydEZhbHNlKHNydi5pc19zZXJ2aW5nKCkpCgogICAgICAgIG1haW5fdGFzayA9IHNlbGYubG9vcC5jcmVhdGVfdGFzayhtYWluKHNydikpCgogICAgICAgIGFkZHIgPSBzcnYuc29ja2V0c1swXS5nZXRzb2NrbmFtZSgpCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFJhaXNlcyhhc3luY2lvLkNhbmNlbGxlZEVycm9yKToKICAgICAgICAgICAgd2l0aCBzZWxmLnRjcF9jbGllbnQobGFtYmRhIHNvY2s6IGN3YXJncyA9IHN1cGVyKCkuZ2V0X2Zvcm1fa3dhcmdzKCkKICAgICAgICBrd2FyZ3NbInVzZXIiXSA9IHNlbGYucmVxdWVzdC51c2VyCiAgICAgICAgcmV0dXJuIGt3YXJncwoKICAgIGRlZiBmb3JtX3ZhbGlkKHNlbGYsIGZvcm0pOgogICAgICAgIGZvcm0uc2F2ZSgpCiAgICAgICAgIyBVcGRhdGluZyB0aGUgcGFzc3dvcmQgbG9ncyBvdXQgYWxsIG90aGVyIHNlc3Npb25zIGZvciB0aGUgdXNlcgogICAgICAgICMgZXhjZXB0IHRoZSBjdXJyZW50IG9uZS4KICAgICAgICB1cGRhdGVfc2Vzc2lvbl9hdXRoX2hhc2goc2VsZi5yZXF1ZXN0LCBmb3JtLnVzZXIpCiAgICAgICAgcmV0dXJuIHN1cGVyKCkuZm9ybV92YWxpZChmb3JtKQoKCkBtZXRob2RfZGVjb3JhdG9yKGxvZ2luX3JlcXVpcmVkLCBuYW1lPSJkaXNwYXRjaCIpCmNsYXNzIFBhc3N3b3JkQ2hhbmdlRG9uZVZpZXcoUGFzc3dvcmRDb250ZXh0TWl4aW4sIFRlbXBsYXRlVmlldyk6CiAgICB0ZW1wbGF0ZV9uYW1lID0gInJlZ2lzdHJhdGlvbi9wYXNzd29yZF9jaGFuZ2VfZG9uZS5odG1sIgogICAgdGl0bGUgPSBfKCJQYXNzd29yZCBjaGFuZ2Ugc3VjY2Vzc2Z1bCIpCmltcG9ydCBjb3B5CmltcG9ydCB1bml0dGVzdApmcm9tIHVuaXR0ZXN0IGltcG9ydCBtb2NrCgpmcm9tIGRqYW5nby5jb3JlLmV4Y2VwdGlvbnMgaW1wb3J0IEltcHJvcGVybHlDb25maWd1cmVkCmZyb20gZGphbmdvLmRiIGltcG9ydCBOb3RTdXBwb3J0ZWRFcnJvciwgUHJvZ3JhbW1pbmdFcnJvciwgY29ubmVjdGlvbgpmcm9tIGRqYW5nby5kYi5tb2RlbHMgaW1wb3J0IEJvb2xlYW5GaWVsZApmcm9tIGRqYW5nby50ZXN0IGltcG9ydCBUZXN0Q2FzZSwgVHJhbnNhY3Rpb25UZXN0Q2FzZQoKZnJvbSAuLm1vZGVscyBpbXBvcnQgVmVyeUxvbmdNb2RlbE5hbWVaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWloKCgpkZWYgbm9fcG9vbF9jb25uZWN0aW9uKGFsaWFzPU5vbmUpOgogICAgbmV3X2Nvbm5lY3Rpb24gPSBjb25uZWN0aW9uLmNvcHkoYWxpYXMpCiAgICBuZXdfY29ubmVjdGlvbi5zZXR0aW5nc19kaWN0ID0gY29weS5kZWVwY29weShjb25uZWN0aW9uLnNldHRpbmdzX2RpY3QpCiAgICAjIEVuc3VyZSB0aGF0IHRoZSBzZWNvbmQgY29ubmVjdGlvbiBjaXJjdW12ZW50cyB0aGUgcG9vbCwgdGhpcyBpcyBraW5kCiAgICAjIG9mIGEgaGFjaywgYnV0IHdlIGNhbm5vdCBlYXNpbHkgY2hhbmdlIHRoZSBwb29sIGNvbm5lY3Rpb25zLgogICAgbmV3X2Nvbm5lY3Rpb24uc2V0dGluZ3NfZGljdFsiT1BUSU9OUyJdWyJwb29sIl0gPSBGYWxzZQogICAgcmV0dXJuIG5ld19jb25uZWN0aW9uCgoKQHVuaXR0ZXN0LnNraXBVbmxlc3MoY29ubmVjdGlvbi52ZW5kb3IgPT0gIm9yYWNsZSIsICJPcmFjbGUgdGVzdHMiKQpjbGFzcyBUZXN0cyhUZXN0Q2FzZSk6CiAgICBkZWYgdGVzdF9xdW90ZV9uYW1lKHNlbGYpOgogICAgICAgICIiIiclJyBjaGFycyBhcmUgZXNjYXBlZCBmb3IgcXVlcnkgZXh0aW9uIHRha2VzIGEgc2luZ2xlIGFyZ3VtZW50IHRoYXQgY2FuIGJlIHBhc3NlZCB0byB0aGUKICAgICJleGVjIiBzdGF0ZW1lbnQsIGFuZCBhbiBvcHRpb25hbCBmaWxlIG5hbWUuICBJbiBhbGwgY2FzZXMgdGhpcwogICAgcm91dGluZSBhdHRlbXB0cyB0byAiZXhlYyIgaXRzIGZpcnN0IGFyZ3VtZW50IGFuZCBnYXRoZXIgcHJvZmlsaW5nCiAgICBzdGF0aXN0aWNzIGZyb20gdGhlIGV4ZWN1dGlvbi4gSWYgbm8gZmlsZSBuYW1lIGlzIHByZXNlbnQsIHRoZW4gdGhpcwogICAgZnVuY3Rpb24gYXV0b21hdGljYWxseSBwcmludHMgYSBzaW1wbGUgcHJvZmlsaW5nIHJlcG9ydCwgc29ydGVkIGJ5IHRoZQogICAgc3RhbmRhcmQgbmFtZSBzdHJpbmcgKGZpbGUvbGluZS9mdW5jdGlvbi1uYW1lKSB0aGF0IGlzIHByZXNlbnRlZCBpbgogICAgZWFjaCBsaW5lLgogICAgIiIiCiAgICByZXR1cm4gX1V0aWxzKFByb2ZpbGUpLnJ1bihzdGF0ZW1lbnQsIGZpbGVuYW1lLCBzb3J0KQoKZGVmIHJ1bmN0eChzdGF0ZW1lbnQsIGdsb2JhbHMsIGxvY2FscywgZmlsZW5hbWU9Tm9uZSwgc29ydD0tMSk6CiAgICAiIiJSdW4gc3RhdGVtZW50IHVuZGVyIHByb2ZpbGVyLCBzdXBwbHlpbmcgeW91ciBvd24gZ2xvYmFscyBhbmQgbG9jYWxzLAogICAgb3B0aW9uYWxseSBzYXZpbmcgcmVzdWx0cyBpbiBmaWxlbmFtZS4KCiAgICBzdGF0ZW1lbnQgYW5kIGZpbGVuYW1lIGhhdmUgdGhlIHNhbWUgc2VtYW50aWNzIGFzIHByb2ZpbGUucnVuCiAgICAiIiIKICAgIHJldHVybiBfVXRpbHMoUHJvZmlsZSkucnVuY3R4KHN0YXRlbWVudCwgZ2xvYmFscywgbG9jYWxzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlbmFtZSwgc29ydCkKCiMgX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCgpjbGFzcyBQcm9maWxlKF9sc3Byb2YuUHJvZmlsZXIpOgogICAgIiIiUHJvZmlsZSh0aW1lcj1Ob25lLCB0aW1ldW5pdD1Ob25lLCBzdWJjYWxscz1UcnVlLCBidWlsdGlucz1UcnVlKQoKICAgIEJ1aWxkcyBhIHByb2ZpbGVyIG9iamVjdCB1c2luZyB0aGUgc3BlY2lmaWVkIHRpbWVyIGZ1bmN0aW9uLgogICAgVGhlIGRlZmF1bHQgdGltZXIgaXMgYSBmYXN0IGJ1aWx0LWluIG9uZSBiYXNlZCBvbiByZWFsIHRpbWUuCiAgICBGb3IgY3VzdG9tIHRpbWVyIGZ1bmN0aW9ucyByZXR1cm5pbmcgaW50ZWdlcnMsIHRpbWV1bml0IGNhbgogICAgYmUgYSBmbG9hdCBzcGVjaWZ5aW5nIGEgc2NhbGUgKGkuZS4gaG93IGxvbmcgZWFjaCBpbnRlZ2VyIHVuaXQKICAgIGlzLCBpbiBzZWNvbmRzKS4KICAgICIiIgoKICAgICMgTW9zdCBvZiB0aGUgZnVuY3Rpb25hbGl0eSBpcyBpbiB0aGUgYmFzZSBjbGFzcy4KICAgICMgVGhpcyBzdWJjbGFzcyBvbmx5IGFkZHMgY29udmVuaWVudCBhbmQgYmFja3dhcmQtY29tcGF0aWJsZSBtZXRob2RzLgoKICAgIGRlZiBwcmludF9zdGF0cyhzZWxmaWRlZCB0aHJvdWdoIHN5c2NvbmZpZykKLSBWYXJpb3VzIG1ha2VzZXR1cCBmaWxlczoKICAtICQoc3JjZGlyKS9Nb2R1bGVzL1NldHVwCiAgLSBNb2R1bGVzL1NldHVwLltsb2NhbHxib290c3RyYXB8c3RkbGliXSBmaWxlcywgd2hpY2ggYXJlIGdlbmVyYXRlZAogICAgZnJvbSAkKHNyY2RpcikvTW9kdWxlcy9TZXR1cC4qLmluIGZpbGVzCgpTZWUgLS1oZWxwIGZvciBtb3JlIGluZm9ybWF0aW9uCiIiIgoKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCBhbm5vdGF0aW9ucwoKaW1wb3J0IF9pbXAKaW1wb3J0IGFyZ3BhcnNlCmltcG9ydCBlbnVtCmltcG9ydCBqc29uCmltcG9ydCBsb2dnaW5nCmltcG9ydCBvcwppbXBvcnQgcGF0aGxpYgppbXBvcnQgcHByaW50CmltcG9ydCByZQppbXBvcnQgc3lzCmltcG9ydCBzeXNjb25maWcKaW1wb3J0IHdhcm5pbmdzCmZyb20gY29sbGVjdGlvbnMuYWJjIGltcG9ydCBJdGVyYWJsZQpmcm9tIGltcG9ydGxpYi5fYm9vdHN0cmFwIGltcG9ydCAoICAjIHR5cGU6IGlnbm9yZVthdHRyLWRlZmluZWRdCiAgICBfbG9hZCBhcyBib290c3RyYXBfbG9hZCwKKQpmcm9tIGltcG9ydGxpYi5tYWNoaW5lcnkgaW1wb3J0ICgKICAgIEJ1aWx0aW5JbXBvcnRlciwKICAgIEV4dGVuc2lvbkZpbGVMb2FkZXIsCiAgICBNb2R1bGVTcGVjLAopCmZyb20gaW1wb3J0bGliLnV0aWwgaW1wb3J0IHNwZWNfZnJvbV9maWxlX2xvY2F0aW9uLCBzcGVjX2Zyb21fbG9hZGVyCmZyb20gdHlwaW5nIGltcG9ydCBOYW1lZFR1cGxlCgpTUkNfRElSID0gcGF0aGxpYi5QYXRoKF9fZmlsZV9fKS5wYXJlbnQucGFyZW50LnBhcmVudAoKIyBjb3JlIG1vZHVsZXMsIGhhcmQtY29kZWQgaW4gTW9kdWxlcy9jb25maWcuaC5pbgpDT1JFX01PRFVMRVMgPSB7CiAgICAiX2FzdCIsCiAgICAiX2ltcCIsCiAgICAiX3N0cmluZyIsCiAgICAiX3Rva2VuaXplIiwKICAgICJfd2FybmluZ3MiLAogICAgImJ1aWx0aW5zIiwKICAgICJnYyIsCiAgICAibWFyc2hhbCIsCiAgICAic3lzIiwKfQoKIyBXaW5kb3dzLW9ubHkgbW9kdWxlcwpXSU5ET1dTX01PRFVMRVMgPSB7CiAgICAiX292ZXJsYXBwZWQiLAogICAgIl90ZXN0Y29uc29sZSIsCiAgICAiX3dpbmFwaSIsCiAgICAiX3dtaSIsCiAgICAibXN2Y3J0IiwKICAgICJudCIsCiAgICAid2lucmVnIiwKICAgICJ3aW5zb3VuZCIsCn0KCgpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcihfX25hbWVfXykKCnBhcnNlciA9IGFyZ3BhcnNlLkFyZ3VtZW50UGFyc2VyKAogICAgcHJvZz0iY2hlY2tfZXh0ZW5zaW9uX21vZHVsZXMiLAogICAgZGVzY3JpcHRpb249X19kb2NfXywKICAgIGZvcm1hdHRlcl9jbGFzcz1hcmdwYXJzZS5SYXdEZXNjcmlwdGlvbkhlbHBGb3JtYXR0ZXIsCikKCnBhcnNlci5hZGRfYXJndW1lbnQoCiAgICAiLS12ZXJib3NlIiwKICAgIGFjdGlvbj0ic3RvcmVfdHJ1ZSIsCiAgICBoZWxwPSJWZXJib3NlLCByZXBvcnQgYnVpbHRpbiwgc2hhcmVkLCBhbmQgdW5hdmFpbGFibGUgbW9kb3BlX3N0cigpLmxvd2VyKCl9IHN5bWJvbCB7c3ltYm9sLmdldF9uYW1lKCkhcn06IHtmbGFnc30nKQogICAgICAgIHByaW50KCkKCiAgICAgICAgZm9yIHRhYmxlMiBpbiB0YWJsZS5nZXRfY2hpbGRyZW4oKToKICAgICAgICAgICAgcHJpbnRfc3ltYm9scyh0YWJsZTIsIGxldmVsICsgMSkKCiAgICBmb3IgZmlsZW5hbWUgaW4gYXJncyBvciBbJy0nXToKICAgICAgICBpZiBmaWxlbmFtZSA9PSAnLSc6CiAgICAgICAgICAgIHNyYyA9IHN5cy5zdGRpbi5yZWFkKCkKICAgICAgICAgICAgZmlsZW5hbWUgPSAnPHN0ZGluPicKICAgICAgICBlbHNlOgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZW5hbWUsICdyYicpIGFzIGY6CiAgICAgICAgICAgICAgICBzcmMgPSBmLnJlYWQoKQogICAgICAgIG1vZCA9IHN5bXRhYmxlKHNyYywgZmlsZW5hbWUsICdleGVjJykKICAgICAgICBwcmludF9zeW1ib2xzKG1vZCkKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgaW1wb3J0IHN5cwogICAgbWFpbihzeXMuYXJndlsxOl0pCmltcG9ydCBjb250ZXh0bGliCmltcG9ydCBmdW5jdG9vbHMKaW1wb3J0IGlvCmltcG9ydCByZQppbXBvcnQgc3FsaXRlMwppbXBvcnQgdGVzdC5zdXBwb3J0CmltcG9ydCB1bml0dGVzdAoKCiMgSGVscGVyIGZvciB0ZW1wb3JhcnkgbWVtb3J5IGRhdGFiYXNlcwpkZWYgbWVtb3J5X2RhdGFiYXNlKCphcmdzLCAqKmt3YXJncyk6CiAgICBjeCA9IHNxbGl0ZTMuY29ubmVjdCgiOm1lbW9yeToiLCAqYXJncywgKiprd2FyZ3MpCiAgICByZXR1cm4gY29udGV4dGxpYi5jbG9zaW5nKGN4KQoKCiMgVGVtcG9yYXJpbHkgbGltaXQgYSBkYXRhYmFzZSBjb25uZWN0aW9uIHBhcmFtZXRlcgpAY29udGV4dGxpYi5jb250ZXh0bWFuYWdlcgpkZWYgY3hfbGltaXQoY3gsIGNhdGVnb3J5PXNxbGl0ZTMuU1FMSVRFX0xJTUlUX1NRTF9MRU5HVEgsIGxpbWl0PTEyOCk6CiAgICB0cnk6CiAgICAgICAgX3ByZXYgPSBjeC5zZXRsaW1pdChjYXRlZ29yeSwgbGltaXQpCiAgICAgICAgeWllbGQgbGltaXQKICAgIGZpbmFsbHk6CiAgICAgICAgY3guc2V0bGltaXQoY2F0ZWdvcnksIF9wcmV2KQoKCmRlZiB3aXRoX3RyYWNlYmFja3MoZXhjLCByZWdleD0iIiwgbmFtZT0iIiwgbXNnX3JlZ2V4PSIiKToKICAgICIiIkNvbnZlbmllbmNlIGRlY29yYXRvciBmb3IgdGVzdGluZyBjYWxsYmFjayB0cmFjZWJhY2tzLiIiIgogICAgZGVmIGRlY29yYXRvcihmdW5jKToKICAgICAgICBleGNfcmVnZXggPSByZS5jb21waWxlKHJlZ2V4KSBpZiByZWdleCBlbHNlIE5vbmUKICAgICAgICBfbXNnX3JlZ2V4ID0gcmUuY29tcGlsZShtc2dfcmVnZXgpIGlmIG1zZ19yZWdleCBlbHNlIE5vbmUKICAgICAgICBAZnVuY3Rvb2xzLndyYXBzKGZ1bmMpCiAgICAgICAgZGVmIHdyYXBwZXIoc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICAgICAgd2l0aCB0ZXN0LnN1cHBvcnQuY2F0Y2hfdW5yYWlzYWJsZV9leGNlcHRpb24oKSBhcyBjbToKICAgcyBpcyBub3QgcmVnaXN0ZXJlZCB3aXRoIGNvZGUgJXMiICUKICAgICAgICAgICAgICAgICAgICAgICAgIChrZXksIGNvZGUpKQogICAgZGVsIF9leHRlbnNpb25fcmVnaXN0cnlba2V5XQogICAgZGVsIF9pbnZlcnRlZF9yZWdpc3RyeVtjb2RlXQogICAgaWYgY29kZSBpbiBfZXh0ZW5zaW9uX2NhY2hlOgogICAgICAgIGRlbCBfZXh0ZW5zaW9uX2NhY2hlW2NvZGVdCgpkZWYgY2xlYXJfZXh0ZW5zaW9uX2NhY2hlKCk6CiAgICBfZXh0ZW5zaW9uX2NhY2hlLmNsZWFyKCkKCiMgU3RhbmRhcmQgZXh0ZW5zaW9uIGNvZGUgYXNzaWdubWVudHMKCiMgUmVzZXJ2ZWQgcmFuZ2VzCgojIEZpcnN0ICBMYXN0IENvdW50ICBQdXJwb3NlCiMgICAgIDEgICAxMjcgICAxMjcgIFJlc2VydmVkIGZvciBQeXRob24gc3RhbmRhcmQgbGlicmFyeQojICAgMTI4ICAgMTkxICAgIDY0ICBSZXNlcnZlZCBmb3IgWm9wZQojICAgMTkyICAgMjM5ICAgIDQ4ICBSZXNlcnZlZCBmb3IgM3JkIHBhcnRpZXMKIyAgIDI0MCAgIDI1NSAgICAxNiAgUmVzZXJ2ZWQgZm9yIHByaXZhdGUgdXNlICh3aWxsIG5ldmVyIGJlIGFzc2lnbmVkKQojICAgMjU2ICAgSW5mICAgSW5mICBSZXNlcnZlZCBmb3IgZnV0dXJlIGFzc2lnbm1lbnQKCiMgRXh0ZW5zaW9uIGNvZGVzIGFyZSBhc3NpZ25lZCBieSB0aGUgUHl0aG9uIFNvZnR3YXJlIEZvdW5kYXRpb24uCiIiIgpHZW5lcmljIHJlbGF0aW9ucwoKR2VuZXJpYyByZWxhdGlvbnMgbGV0IGFuIG9iamVjdCBoYXZlIGEgZm9yZWlnbiBrZXkgdG8gYW55IG9iamVjdCB0aHJvdWdoIGEKY29udGVudC10eXBlL29iamVjdC1pZCBmaWVsZC4gQSBgYEdlbmVyaWNGb3JlaWduS2V5YGAgZmllbGQgY2FuIHBvaW50IHRvIGFueQpvYmplY3QsIGJlIGl0IGFuaW1hbCwgdmVnZXRhYmxlLCBvciBtaW5lcmFsLgoKVGhlIGNhbm9uaWNhbCBleGFtcGxlIGlzIHRhZ3MgKGFsdGhvdWdoIHRoaXMgZXhhbXBsZSBpbXBsZW1lbnRhdGlvbiBpcyAqZmFyKgpmcm9tIGNvbXBsZXRlKS4KIiIiCgpmcm9tIGRqYW5nby5jb250cmliLmNvbnRlbnR0eXBlcy5maWVsZHMgaW1wb3J0IEdlbmVyaWNGb3JlaWduS2V5LCBHZW5lcmljUmVsYXRpb24KZnJvbSBkamFuZ28uY29udHJpYi5jb250ZW50dHlwZXMubW9kZWxzIGltcG9ydCBDb250ZW50VHlwZQpmcm9tIGRqYW5nby5kYiBpbXBvcnQgbW9kZWxzCgoKY2xhc3MgVGFnZ2VkSXRlbShtb2RlbHMuTW9kZWwpOgogICAgIiIiQSB0YWcgb24gYW4gaXRlbS4iIiIKCiAgICB0YWcgPSBtb2RlbHMuU2x1Z0ZpZWxkKCkKICAgIGNvbnRlbnRfdHlwZSA9IG1vZGVscy5Gb3JlaWduS2V5KENvbnRlbnRUeXBlLCBtb2RlbHMuQ0FTQ0FERSkKICAgIG9iamVjdF9pZCA9IG1vZGVscy5Qb3NpdGl2ZUludGVnZXJGaWVsZCgpCgogICAgY29udGVudF9vYmplY3QgPSBHZW5lcmljRm9yZWlnbktleSgpCgogICAgY2xhc3MgTWV0YToKICAgICAgICBvcmRlcmluZyA9IFsidGFnIiwgImNvbnRlbnRfdHlwZV9fbW9kZWwiXQoKICAgX3doZWVsX3BhdGgubmFtZQogICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICMgRXh0cmFjdCAnMjEuMi40JyBmcm9tICdwaXAtMjEuMi40LXB5My1ub25lLWFueS53aGwnCiAgICAgICAgICAgIHdoZWVsX25hbWUuCiAgICAgICAgICAgIHJlbW92ZXByZWZpeCgncGlwLScpLgogICAgICAgICAgICBwYXJ0aXRpb24oJy0nKVswXQogICAgICAgICkKCgpkZWYgX3J1bl9waXAoYXJncywgYWRkaXRpb25hbF9wYXRocz1Ob25lKToKICAgICMgUnVuIHRoZSBib290c3RyYXBwaW5nIGluIGEgc3VicHJvY2VzcyB0byBhdm9pZCBsZWFraW5nIGFueSBzdGF0ZSB0aGF0IGhhcHBlbnMKICAgICMgYWZ0ZXIgcGlwIGhhcyBleGVjdXRlZC4gUGFydGljdWxhcmx5LCB0aGlzIGF2b2lkcyB0aGUgY2FzZSB3aGVuIHBpcCBob2xkcyBvbnRvCiAgICAjIHRoZSBmaWxlcyBpbiAqYWRkaXRpb25hbF9wYXRocyosIHByZXZlbnRpbmcgdXMgdG8gcmVtb3ZlIHRoZW0gYXQgdGhlIGVuZCBvZiB0aGUKICAgICMgaW52b2NhdGlvbi4KICAgIGNvZGUgPSBmIiIiCmltcG9ydCBydW5weQppbXBvcnQgc3lzCnN5cy5wYXRoID0ge2FkZGl0aW9uYWxfcGF0aHMgb3IgW119ICsgc3lzLnBhdGgKc3lzLmFyZ3ZbMTpdID0ge2FyZ3N9CnJ1bnB5LnJ1bl9tb2R1bGUoInBpcCIsIHJ1bl9uYW1lPSJfX21haW5fXyIsIGFsdGVyX3N5cz1UcnVlKQoiIiIKCiAgICBjbWQgPSBbCiAgICAgICAgc3lzLmV4ZWN1dGFibGUsCiAgICAgICAgJy1XJywKICAgICAgICAnaWdub3JlOjpEZXByZWNhdGlvbldhcm5pbmcnLAogICAgICAgICctYycsCiAgICAgICAgY29kZSwKICAgIF0KICAgIGlmIHN5cy5mbGFncy5pc29sYXRlZDoKICAgICAgICAjIHJ1biBjb2RlIGluIGlzb2xhdGVkIG1vZGUgaWYgY3VycmVudGx5IHJ1bm5pbmcgaXNvbGF0ZWQKICAgICAgICBjbWQuaW5zZXJ0KDEsICctSScpCiAgICByZXR1cm4gc3VicHJvY2Vzcy5ydW4oY21kLCBjaGVjaz1UcnVlKS5yZXR1cm5jb2RlCgoKZGVmIHZlcnNpb24oKToKICAgICIiIgogICAgUmV0dXJucyBhIHN0cmluZyBzcGVjaWZ5aW5nIHRoZSBidW5kbGVkIHZlcnNpb24gb2YgcGlwLgogICAgIiIiCiAgICByZXR1cm4gX2dldF9waXBfdmVyc2lvbigpCgoKZGVmIF9kaXNhYmxlX3BpcF9jb25maWd1cmF0aW9uX3NldHRpbmdzKCk6CiAgICAjIFdlIGRlbGliZXJhdGVseSBpZ25vcmUgYWxsIHBpcCBlbnZpcm9ubWVudCB2YXJpYWJsZXMKICAgICMgd2hlbiBpbnZva2luZyBwaXAKICAgICMgU2VlIGh0dHA6Ly9idWdzLnB5dGhvbi5vcmcvaXNzdWUxOTczNCBmb3IgZGV0YWlscwogICAga2V5c190b19yZW1vdmUgPSBbayBmb3IgayBpbiBvcy5lbnZpcm9uIGlmIGsuc3RhcnRzd2l0aCgiUElQXyIpXQogICAgZm9yIGsgaW4ga2V5c190b19yZW1vdmU6CiAgICAgICAgZGVsIG9zLmVudmlyb25ba10KICAgICMgV2UgYWxzbyBpZ25vcmUgdGhlIHNldHRpbmdzIGluIHRoZSBkZWZhdWx0IHBpcCBjb25maWd1cmF0aW9uIGZpbGUKICAgKQoKCihGcm96ZW5fUEVQMzE0N1Rlc3RzLAogU291cmNlX1BFUDMxNDdUZXN0cwogKSA9IHV0aWwudGVzdF9ib3RoKFBFUDMxNDdUZXN0cywgdXRpbD1pbXBvcnRsaWJfdXRpbCkKCgpjbGFzcyBNYWdpY051bWJlclRlc3RzKHVuaXR0ZXN0LlRlc3RDYXNlKToKICAgICIiIgogICAgVGVzdCByZWxlYXNlIGNvbXBhdGliaWxpdHkgaXNzdWVzIHJlbGF0aW5nIHRvIGltcG9ydGxpYgogICAgIiIiCiAgICBAdW5pdHRlc3Quc2tpcFVubGVzcygKICAgICAgICBzeXMudmVyc2lvbl9pbmZvLnJlbGVhc2VsZXZlbCBpbiAoJ2NhbmRpZGF0ZScsICdmaW5hbCcpLAogICAgICAgICdvbmx5IGFwcGxpZXMgdG8gY2FuZGlkYXRlIG9yIGZpbmFsIHB5dGhvbiByZWxlYXNlIGxldmVscycKICAgICkKICAgIGRlZiB0ZXN0X21hZ2ljX251bWJlcihzZWxmKToKICAgICAgICAjIEVhY2ggcHl0aG9uIG1pbm9yIHJlbGVhc2Ugc2hvdWxkIGdlbmVyYWxseSBoYXZlIGEgTUFHSUNfTlVNQkVSCiAgICAgICAgIyB0aGF0IGRvZXMgbm90IGNoYW5nZSBvbmNlIHRoZSByZWxlYXNlIHJlYWNoZXMgY2FuZGlkYXRlIHN0YXR1cy4KCiAgICAgICAgIyBPbmNlIGEgcmVsZWFzZSByZWFjaGVzIGNhbmRpZGF0ZSBzdGF0dXMsIHRoZSB2YWx1ZSBvZiB0aGUgY29uc3RhbnQKICAgICAgICAjIEVYUEVDVEVEX01BR0lDX05VTUJFUiBpbiB0aGlzIHRlc3Qgc2hvdWxkIGJlIGNoYW5nZWQuCiAgICAgICAgIyBUaGlzIHRlc3Qgd2lsbCB0aGVuIGNoZWNrIHRoYXQgdGhlIGFjdHVhbCBNQUdJQ19OVU1CRVIgbWF0Y2hlcwogICAgICAgICMgdGhlIGV4cGVjdGVkIHZhbHVlIGZvciB0aGUgcmVsZWFzZS4KCiAgICAgICAgIyBJbiBleGNlcHRpb25hbCBjYXNlcywgaXQgbWF5IGJlIHJlcXVpcmVkIHRvIGNoYW5nZSB0aGUgTUFHSUNfTlVNQkVSCiAgICAgICAgIyBmb3IgYSBtYWludGVuYW5jZSByZWxlYXNlLiBJbiB0aGlzIGNhc2UgdGhlIGNoYW5nZSBzaG91bGQgYmUKICAgICAgICAjIGRpc2N1c3NlZCBpbiBweXRob24tZGV2LiBJZiBhIGNoYW5nZSBpcyByZXF1aXJlZCwgY29tbXVuaXR5CiAgICAgICAgIyBzdGFrZWhvbGRlcnMgc3VjaCBhcyBPUyBwYWNrYWdlIG1haW50YWluZXJzIG11c3QgYmUgbm90aWZpZWQKICAgICAgICAjIGluIGFkdmFuY2UuIFN1Y2ggZXhjZXB0aW9uYWwgcmVsZWFzZXMgd2lsbCB0aGVuIHJlcXVpcmUgYW4KICAgICAgICAjIGFkanVzdG1lbnQgdG8gdGhpcyB0ZXN0IGNhc2UuCiAgICAgICAgRVhQRUNURURfTUFHSUNfTlVNQkVSID0gMzYyNQogICAgICAgIGFjdHVhbCA9IGludC5mcm9tX2J5dGVzKGltcG9ydGxpYi51dGlsLk1BR0lDX05VTUJFUls6Ml0sICdsaXR0bGUnKQoKICAgICAgICBtc2cgPSAoCiAgICAgICAgICAgICJUbyBhdm9pZCBicmVha2luZyBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIGNhY2hlZCBieXRlY29kZSAiCiAgICAgICAgICAgICJmaWxlcyB0aGF0IGNhbid0IGJlIGF1dG9tYXRpY2FsbHkgcmVnZW5lcmF0ZWQgICAgICBhY3RpdmF0ZShzZWxmLnRpbWV6b25lKQoKICAgIGRlZiBfX2V4aXRfXyhzZWxmLCBleGNfdHlwZSwgZXhjX3ZhbHVlLCB0cmFjZWJhY2spOgogICAgICAgIGlmIHNlbGYub2xkX3RpbWV6b25lIGlzIE5vbmU6CiAgICAgICAgICAgIGRlYWN0aXZhdGUoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIF9hY3RpdmUudmFsdWUgPSBzZWxmLm9sZF90aW1lem9uZQoKCiMgVGVtcGxhdGVzCgoKZGVmIHRlbXBsYXRlX2xvY2FsdGltZSh2YWx1ZSwgdXNlX3R6PU5vbmUpOgogICAgIiIiCiAgICBDaGVjayBpZiB2YWx1ZSBpcyBhIGRhdGV0aW1lIGFuZCBjb252ZXJ0cyBpdCB0byBsb2NhbCB0aW1lIGlmIG5lY2Vzc2FyeS4KCiAgICBJZiB1c2VfdHogaXMgcHJvdmlkZWQgYW5kIGlzIG5vdCBOb25lLCB0aGF0IHdpbGwgZm9yY2UgdGhlIHZhbHVlIHRvCiAgICBiZSBjb252ZXJ0ZWQgKG9yIG5vdCksIG92ZXJyaWRpbmcgdGhlIHZhbHVlIG9mIHNldHRpbmdzLlVTRV9UWi4KCiAgICBUaGlzIGZ1bmN0aW9uIGlzIGRlc2lnbmVkIGZvciB1c2UgYnkgdGhlIHRlbXBsYXRlIGVuZ2luZS4KICAgICIiIgogICAgc2hvdWxkX2NvbnZlcnQgPSAoCiAgICAgICAgaXNpbnN0YW5jZSh2YWx1ZSwgZGF0ZXRpbWUpCiAgICAgICAgYW5kIChzZXR0aW5ncy5VU0VfVFogaWYgdXNlX3R6IGlzIE5vbmUgZWxzZSB1c2VfdHopCiAgICAgICAgYW5kIG5vdCBpc19uYWl2ZSh2YWx1ZSkKICAgICAgICBhbmQgZ2V0YXR0cih2YWx1ZSwgImNvbnZlcnRfdG9fbG9jYWxfdGltZSIsIFRydWUpCiAgICApCiAgICByZXR1cm4gbG9jYWx0aW1lKHZhbHVlKSBpZiBzaG91bGRfY29udmVydCBlbHNlIHZhbHVlCgoKIyBVdGlsaXRpZXMKCgpkZWYgbG9jYWx0aW1lKHZhbHVlPU5vbmUsIHRpbWV6b25lPU5vbmUpOgogICAgIiIiCiAgICBDb252ZXJ0IGFuIGF3YXJlIGRhdGV0aW1lLmRhdGV0aW1lIHRvIGxvY2FsIHRpbWUuCgogICAgT25seSBhd2FyZSBkYXRldGltZXMgYXJlIGFsbG93ZWQuIFdoZW4gdmFsdWUgaXMgb21pdHRlZCwgaXQgZGVmYXVsdHMgdG8KICAgIG5vdygpLgoKICAgIExvY2FsIHRpbWUgaXMgZGVmaW5lZCBieSB0aGUgY3VycmVudCB0aW1lIHpvbmUsIHVubGVzcyBhbm90aGVyIHRpbWUgem9uZQogICAgaXMgc3BlY2lmaWVkLgogICAgIiIiCiAgICBpZiB2YWx1ZSBpcyBOb25lOgogICAgICAgIHZhbHVlID0gbm93KCkKICAgIGlmIHRpbWV6b25lIGlzIE5vbmU6CiAgICAgICAgdGltZXpvbmUgPSBnZXRfY3VycmVudF90aW1lem9uZSgpCiAgICAjIEVtdWxhdGUgdGhlIGJlaGF2aW9yIG9mIGFzdGltZXpvbmUoKSBvbiBQeXRob24gPCAzLjYuCiAgICBpZiBpc19uYWl2ZSh2YWx1ZSk6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigibG9jYWx0aW1lKCkgY2Fubm90IGJlIGFwcGxpZWQgdG8gYSBuYWl2ZSBkYXRldGltZSIpCiAgICByZXR1cm4gdmFsdWUuYXN0aW1lem9uZSh0aW1lem9uZSkKCgpkZWYgbG9jYWxkYXRlKHZhbCAgICBlbHNlOgogICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKCIiKQoKICAgICAgICAjIFJlbW92ZSB0cmFpbGluZyBlbXB0eSBsaW5lcwogICAgICAgIHdoaWxlIGxpbmVzIGFuZCBub3QgbGluZXNbLTFdOgogICAgICAgICAgICBsaW5lcy5wb3AoKQoKICAgICAgICByZXR1cm4gbGluZXMKCiAgICBkZWYgZmluZF90ZXh0KHNlbGYsIHBhdHRlcm4pOgogICAgICAgICIiIkZpbmQgdGV4dCBtYXRjaGluZyBwYXR0ZXJuIGluIGJ1ZmZlciAoZm9yIHRlc3RpbmcpLiBSZXR1cm5zIChsaW5lLCBjb2wpIG9yIE5vbmUuIiIiCiAgICAgICAgZm9yIChsaW5lLCBjb2wpLCAodGV4dCwgXykgaW4gc2VsZi5idWZmZXIuaXRlbXMoKToKICAgICAgICAgICAgaWYgcGF0dGVybiBpbiB0ZXh0OgogICAgICAgICAgICAgICAgcmV0dXJuIChsaW5lLCBjb2wpCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgY29udGFpbnNfdGV4dChzZWxmLCB0ZXh0KToKICAgICAgICAiIiJDaGVjayBpZiBkaXNwbGF5IGNvbnRhaW5zIHRoZSBnaXZlbiB0ZXh0IGFueXdoZXJlIChmb3IgdGVzdGluZykuIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuZmluZF90ZXh0KHRleHQpIGlzIG5vdCBOb25lCiMgVGVzdCB2YXJpb3VzIGZsYXZvcnMgb2YgbGVnYWwgYW5kIGlsbGVnYWwgZnV0dXJlIHN0YXRlbWVudHMKCmltcG9ydCBfX2Z1dHVyZV9fCmltcG9ydCBhc3QKaW1wb3J0IHVuaXR0ZXN0CmZyb20gdGVzdC5zdXBwb3J0IGltcG9ydCBpbXBvcnRfaGVscGVyCmZyb20gdGVzdC5zdXBwb3J0LnNjcmlwdF9oZWxwZXIgaW1wb3J0IHNwYXduX3B5dGhvbiwga2lsbF9weXRob24KZnJvbSB0ZXh0d3JhcCBpbXBvcnQgZGVkZW50CmltcG9ydCBvcwppbXBvcnQgcmUKaW1wb3J0IHN5cwoKVE9QX0xFVkVMX01TRyA9ICdmcm9tIF9fZnV0dXJlX18gaW1wb3J0cyBtdXN0IG9jY3VyIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGZpbGUnCgpyeCA9IHJlLmNvbXBpbGUocidcKChcUyspLnB5LCBsaW5lIChcZCspJykKCmRlZiBnZXRfZXJyb3JfbG9jYXRpb24obXNnKToKICAgIG1vID0gcnguc2VhcmNoKHN0cihtc2cpKQogICAgcmV0dXJuIG1vLmdyb3VwKDEsIDIpCgpjbGFzcyBGdXR1cmVUZXN0KHVuaXR0ZXN0LlRlc3RDYXNlKToKCiAgICBkZWYgY2hlY2tfc3ludGF4X2Vycm9yKHNlbGYsIGVyciwgYmFzZW5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICosCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVubywKICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZT1UT1BfTEVWRUxfTVNHLCBvZmZzZXQ9MSk6CiAgICAgICAgaWYgYmFzZW5hbWUgIT0gJzxzdHJpbmc+JzoKICAgICAgICAgICAgYmFzZW5hbWUgKz0gJy5weScKCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChmJ3ttZXNzYWdlfSAoe2Jhc2VuYW1lfSwgbGluZSB7bGluZW5vfSknLCBzdHIoZXJyKSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKG9zLnBhdGguYmFzZW5hbWUoZXJyLmZpbHRpbi0xXG51ID0gIsOHIlxuJy5lbmNvZGUoIkxhdGluLTEiKQogICAgICAgIHRyeToKICAgICAgICAgICAgY29kZSA9IGNvbXBpbGUoc291cmNlX2NvZGUsICc8ZHVtbXk+JywgJ2V4ZWMnKQogICAgICAgIGV4Y2VwdCBTeW50YXhFcnJvcjoKICAgICAgICAgICAgc2VsZi5mYWlsKCJjb21waWxlKCkgY2Fubm90IGhhbmRsZSBMYXRpbi0xIHNvdXJjZSIpCiAgICAgICAgbnMgPSB7fQogICAgICAgIGV4ZWMoY29kZSwgbnMpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgnw4cnLCBuc1sndSddKQoKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICB1bml0dGVzdC5tYWluKCkKIiIiUHl0aG9uIHBhcnQgb2YgdGhlIHdhcm5pbmdzIHN1YnN5c3RlbS4iIiIKCmltcG9ydCBzeXMKaW1wb3J0IF9jb250ZXh0dmFycwppbXBvcnQgX3RocmVhZAoKCl9fYWxsX18gPSBbIndhcm4iLCAid2Fybl9leHBsaWNpdCIsICJzaG93d2FybmluZyIsCiAgICAgICAgICAgImZvcm1hdHdhcm5pbmciLCAiZmlsdGVyd2FybmluZ3MiLCAic2ltcGxlZmlsdGVyIiwKICAgICAgICAgICAicmVzZXR3YXJuaW5ncyIsICJjYXRjaF93YXJuaW5ncyIsICJkZXByZWNhdGVkIl0KCgojIE5vcm1hbGx5ICdfd20nIGlzIHN5cy5tb2R1bGVzWyd3YXJuaW5ncyddIGJ1dCBmb3IgdW5pdCB0ZXN0cyBpdCBjYW4gYmUKIyBhIGRpZmZlcmVudCBtb2R1bGUuICBVc2VyIGNvZGUgaXMgYWxsb3dlZCB0byByZWFzc2lnbiBnbG9iYWwgYXR0cmlidXRlcwojIG9mIHRoZSAnd2FybmluZ3MnIG1vZHVsZSwgY29tbW9ubHkgJ2ZpbHRlcnMnIG9yICdzaG93d2FybmluZycuIFNvIHdlCiMgbmVlZCB0byBsb29rdXAgdGhlc2UgZ2xvYmFsIGF0dHJpYnV0ZXMgZHluYW1pY2FsbHkgb24gdGhlICdfd20nIG9iamVjdCwKIyByYXRoZXIgdGhhbiBiaW5kaW5nIHRoZW0gZWFybGllci4gIFRoZSBjb2RlIGluIHRoaXMgbW9kdWxlIGNvbnNpc3RlbnRseSB1c2VzCiMgJ193bS48c29tZXRoaW5nPicgcmF0aGVyIHRoYW4gdXNpbmcgdGhlIGdsb2JhbHMgb2YgdGhpcyBtb2R1bGUuICBJZiB0aGUKIyAnX3dhcm5pbmdzJyBDIGV4dGVuc2lvbiBpcyBpbiB1c2UsIHNvbWUgZ2xvYmFscyBhcmUgcmVwbGFjZWQgYnkgZnVuY3Rpb25zCiMgYW5kIHZhcmlhYmxlcyBkZWZpbmVkIGluIHRoYXQgZXh0ZW5zaW9uLgpfd20gPSBOb25lCgoKZGVmIF9zZXRfbW9kdWxlKG1vZHVsZSk6CiAgICBnbG9iYWwgX3dtCiAgICBfd20gPSBtb2R1bGUKCgojIGZpbHRlcnMgY29udGFpbnMgYSBzZXF1ZW5jZSBvZiBmaWx0ZXIgNS10dXBsZXMKIyBUaGUgY29tcG9uZW50cyBvZiB0aGUgNS10dXBsZSBhcmU6CiMgLSBhbiBhY3Rpb246IGVycm9yLCBpZ25vcmUsIGFsd2F5cywgYWxsLCBkZWZhdWx0LCBtb2R1bGUsIG9yIG9uY2UKIyAtIGEgY29tcGlsZWQgcmVnZXggdGhhdCBtdXN0IG1hdGNoIHRoZSB3YXJuaW5nIG1lc3NhZ2UKIyAtIGEgY2xhc3MgcmVwcmVzZW50aW5nIHRoZSB3YXJuaW5nIGNhdGVnb3J5CiMgLV9mdW5jdGlvbihjYXNlLmV2YWx1YXRlX2NvbnN0cmFpbnRzLCBhbm5vdGF0aW9ubGliLkZvcm1hdC5TVFJJTkcpLCAnKGludCwgc3RyKScpCgogICAgZGVmIHRlc3RfY29uc3RfZXZhbHVhdG9yKHNlbGYpOgogICAgICAgIFQgPSBUeXBlVmFyKCJUIiwgYm91bmQ9aW50KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVwcihULmV2YWx1YXRlX2JvdW5kKSwgIjxjb25zdGV2YWx1YXRvciA8Y2xhc3MgJ2ludCc+PiIpCgogICAgICAgIENvbnN0RXZhbHVhdG9yID0gdHlwZShULmV2YWx1YXRlX2JvdW5kKQoKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzUmVnZXgoVHlwZUVycm9yLCByImNhbm5vdCBjcmVhdGUgJ190eXBpbmdcLl9Db25zdEV2YWx1YXRvcicgaW5zdGFuY2VzIik6CiAgICAgICAgICAgIENvbnN0RXZhbHVhdG9yKCkgICMgVGhpcyB1c2VkIHRvIHNlZ2ZhdWx0LgogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXNSZWdleChUeXBlRXJyb3IsIHIiY2Fubm90IHNldCAnYXR0cmlidXRlJyBhdHRyaWJ1dGUgb2YgaW1tdXRhYmxlIHR5cGUgJ190eXBpbmdcLl9Db25zdEV2YWx1YXRvciciKToKICAgICAgICAgICAgQ29uc3RFdmFsdWF0b3IuYXR0cmlidXRlID0gMQpmcm9tIGRqYW5nby5jb3JlLmV4Y2VwdGlvbnMgaW1wb3J0IEZpZWxkRG9lc05vdEV4aXN0LCBGaWVsZEVycm9yLCBGaWVsZEZldGNoQmxvY2tlZApmcm9tIGRqYW5nby5kYi5tb2RlbHMgaW1wb3J0IEZFVENIX1BFRVJTLCBSQUlTRQpmcm9tIGRqYW5nby50ZXN0IGltcG9ydCBTaW1wbGVUZXN0Q2FzZSwgVGVzdENhc2UKCmZyb20gLm1vZGVscyBpbXBvcnQgKAogICAgQmlnQ2hpbGQsCiAgICBDaGlsZCwKICAgIENoaWxkUHJveHksCiAgICBQcmltYXJ5LAogICAgUHJpbWFyeU9uZVRvT25lLAogICAgUmVmcmVzaFByaW1hcnlQcm94eSwKICAgIFNlY29uZGFyeSwKICAgIFNoYWRvd0NoaWxkLAopCgoKY2xhc3MgQXNzZXJ0aW9uTWl4aW46CiAgICBkZWYgYXNzZXJ0X2RlbGF5ZWQoc2VsZiwgb2JqLCBudW0pOgogICAgICAgICIiIgogICAgICAgIEluc3RhbmNlcyB3aXRoIGRlZmVycmVkIGZpZWxkcyBsb29rIHRoZSBzYW1lIGFzIG5vcm1hbCBpbnN0YW5jZXMgd2hlbgogICAgICAgIHdlIGV4YW1pbmUgYXR0cmlidXRlIHZhbHVlcy4gVGhlcmVmb3JlLCB0aGlzIG1ldGhvZCByZXR1cm5zIHRoZSBudW1iZXIKICAgICAgICBvZiBkZWZlcnJlZCBmaWVsZHMgb24gcmV0dXJuZWQgaW5zdGFuY2VzLgogICAgICAgICIiIgogICAgICAgIGNvdW50ID0gbGVuKG9iai5nZXRfZGVmZXJyZWRfZmllbGRzKCkpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjb3VudCwgbnVtKQoKCmNsYXNzIERlZmVyVGVzdHMoQXNzZXJ0aW9uTWl4aW4sIFRlc3RDYXNlKToKICAgIEBjbGFzc21ldGhvZAogICAgZGVmIHNldFVwVGVzdERhdGEoY2xzKToKICAgICAgICBjbHMuczEgPSBTZWNvbmRhcnkub2JqZWN0cy5jcmVhdGUoZmlyc3Q9IngxIiwgc2Vjb25kPSJ5MSIpCiAgIGRba2V5XS5hcHBlbmQoYW5pdGVtKSB3b3JrcyBhcyBpbnRlbmRlZC4KCkhvd2V2ZXIsIHVzaW5nIGtleXdvcmQgYXJndW1lbnQgd3JpdGViYWNrPVRydWUgbWF5IGNvbnN1bWUgdmFzdCBhbW91bnQKb2YgbWVtb3J5IGZvciB0aGUgY2FjaGUsIGFuZCBpdCBtYXkgbWFrZSBkLmNsb3NlKCkgdmVyeSBzbG93LCBpZiB5b3UKYWNjZXNzIG1hbnkgb2YgZCdzIGVudHJpZXMgYWZ0ZXIgb3BlbmluZyBpdCBpbiB0aGlzIHdheTogZCBoYXMgbm8gd2F5IHRvCmNoZWNrIHdoaWNoIG9mIHRoZSBlbnRyaWVzIHlvdSBhY2Nlc3MgYXJlIG11dGFibGUgYW5kL29yIHdoaWNoIG9uZXMgeW91CmFjdHVhbGx5IG11dGF0ZSwgc28gaXQgbXVzdCBjYWNoZSwgYW5kIHdyaXRlIGJhY2sgYXQgY2xvc2UsIGFsbCBvZiB0aGUKZW50cmllcyB0aGF0IHlvdSBhY2Nlc3MuICBZb3UgY2FuIGNhbGwgZC5zeW5jKCkgdG8gd3JpdGUgYmFjayBhbGwgdGhlCmVudHJpZXMgaW4gdGhlIGNhY2hlLCBhbmQgZW1wdHkgdGhlIGNhY2hlIChkLnN5bmMoKSBhbHNvIHN5bmNocm9uaXplcwp0aGUgcGVyc2lzdGVudCBkaWN0aW9uYXJ5IG9uIGRpc2ssIGlmIGZlYXNpYmxlKS4KIiIiCgpmcm9tIHBpY2tsZSBpbXBvcnQgREVGQVVMVF9QUk9UT0NPTCwgZHVtcHMsIGxvYWRzCgppbXBvcnQgY29sbGVjdGlvbnMuYWJjCgpfX2FsbF9fID0gWyJTaGVsdmVFcnJvciIsICJTaGVsZiIsICJCc2REYlNoZWxmIiwgIkRiZmlsZW5hbWVTaGVsZiIsICJvcGVuIl0KCgpjbGFzcyBTaGVsdmVFcnJvcihFeGNlcHRpb24pOgogICAgcGFzcwoKCmNsYXNzIF9DbG9zZWREaWN0KGNvbGxlY3Rpb25zLmFiYy5NdXRhYmxlTWFwcGluZyk6CiAgICAnTWFya2VyIGZvciBhIGNsb3NlZCBkaWN0LiAgQWNjZXNzIGF0dGVtcHRzIHJhaXNlIGEgVmFsdWVFcnJvci4nCgogICAgZGVmIGNsb3NlZChzZWxmLCAqYXJncyk6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignaW52YWxpZCBvcGVyYXRpb24gb24gY2xvc2VkIHNoZWxmJykKICAgIF9faXRlcl9fID0gX19sZW5fXyA9IF9fZ2V0aXRlbV9fID0gX19zZXRpdGVtX18gPSBfX2RlbGl0ZW1fXyA9IGtleXMgPSBjbG9zZWQKCiAgICBkZWYgX19yZXByX18oc2VsZik6CiAgICAgICAgcmV0dXJuICc8Q2xvc2VkIERpY3Rpb25hcnk+JwoKCmNsYXNzIFNoZWxmKGNvbGxlY3Rpb25zLmFiYy5NdXRhYmxlTWFwcGluZyk6CiAgICAiIiJCYXNlIGNsYXNzIGZvciBzaGVsZiBpbXBsZW1lbnRhdGlvbnMuCgogICAgVGhpcyBpcyBpbml0aWFsaXplZCB3aXRoIGEgZGljdGlvbmFyeS1saWtlIG9iamVjdC4KICAgIFNlZSB0aGUgbW9kdWxlJ3MgX19kb2NfXyBzdHJpbmcgZm9yIGFuIG92ZXJ2aWV3IG9mIHRoZSBpbnRlcmZhY2UuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgZGljdCwgcHJvdG9jb2w9Tm9uZSwgd3JpdGViYWNrPUZhbHNlLAogICAgICAgICAgICAgICAgIGtleWVuY29kaW5nPSJ1dGYtOCIsICosIHNlcmlhbGl6ZXI9Tm9uZSwgZGVzZXJpYWdlLyogTUlNRSBkb2N1bWVudHMuIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIF9tc2csIF9zdWJ0eXBlPSdyZmM4MjInLCAqLCBwb2xpY3k9Tm9uZSk6CiAgICAgICAgIiIiQ3JlYXRlIGEgbWVzc2FnZS8qIHR5cGUgTUlNRSBkb2N1bWVudC4KCiAgICAgICAgX21zZyBpcyBhIG1lc3NhZ2Ugb2JqZWN0IGFuZCBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIE1lc3NhZ2UsIG9yIGEKICAgICAgICBkZXJpdmVkIGNsYXNzIG9mIE1lc3NhZ2UsIG90aGVyd2lzZSBhIFR5cGVFcnJvciBpcyByYWlzZWQuCgogICAgICAgIE9wdGlvbmFsIF9zdWJ0eXBlIGRlZmluZXMgdGhlIHN1YnR5cGUgb2YgdGhlIGNvbnRhaW5lZCBtZXNzYWdlLiAgVGhlCiAgICAgICAgZGVmYXVsdCBpcyAicmZjODIyIiAodGhpcyBpcyBkZWZpbmVkIGJ5IHRoZSBNSU1FIHN0YW5kYXJkLCBldmVuIHRob3VnaAogICAgICAgIHRoZSB0ZXJtICJyZmM4MjIiIGlzIHRlY2huaWNhbGx5IG91dGRhdGVkIGJ5IFJGQyAyODIyKS4KICAgICAgICAiIiIKICAgICAgICBNSU1FTm9uTXVsdGlwYXJ0Ll9faW5pdF9fKHNlbGYsICdtZXNzYWdlJywgX3N1YnR5cGUsIHBvbGljeT1wb2xpY3kpCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoX21zZywgbWVzc2FnZS5NZXNzYWdlKToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdBcmd1bWVudCBpcyBub3QgYW4gaW5zdGFuY2Ugb2YgTWVzc2FnZScpCiAgICAgICAgIyBJdCdzIGNvbnZlbmllbnQgdG8gdXNlIHRoaXMgYmFzZSBjbGFzcyBtZXRob2QuICBXZSBuZWVkIHRvIGRvIGl0CiAgICAgICAgIyB0aGlzIHdheSBvciB3ZSdsbCBnZXQgYW4gZXhjZXB0aW9uCiAgICAgICAgbWVzc2FnZS5NZXNzYWdlLmF0dGFjaChzZWxmLCBfbXNnKQogICAgICAgICMgQW5kIGJlIHN1cmUgb3VyIGRlZmF1bHQgdHlwZSBpcyBzZXQgY29ycmVjdGx5CiAgICAgICAgc2VsZi5zZXRfZGVmYXVsdF90eXBlKCdtZXNzYWdlL3JmYzgyMicpCmZyb20gdGVzdC50ZXN0X2ltcG9ydGxpYiBpbXBvcnQgYWJjLCB1dGlsCgptYWNoaW5lcnkgPSB1dGlsLmltcG9ydF9pbXBvcnRsaWIoJ2ltcG9ydGxpYi5tYWNoaW5lcnknKQoKaW1wb3J0IHN5cwppbXBvcnQgdHlwZXMKaW1wb3J0IHVuaXR0ZXN0CmltcG9ydCB3YXJuaW5ncwoKCkB1bml0dGVzdC5za2lwSWYodXRpbC5CVUlMVElOUy5nb29kX25hbWUgaXMgTm9uZSwgJ25vIHJlYXNvbmFibGUgYnVpbHRpbiBtb2R1bGUnKQpjbGFzcyBJbnNwZWN0TG9hZGVyVGVzdHM6CgogICAgIiIiVGVzdHMgZm9yIEluc3BlY3RMb2FkZXIgbWV0aG9kcyBmb3IgQnVpbHRpbkltcG9ydGVyLiIiIgoKICAgIGRlZiB0ZXN0X2dldF9jb2RlKHNlbGY=';

let cachedDictionary: Buffer | null = null;

export function getPythonDictionary(): Buffer {
  if (!cachedDictionary) {
    cachedDictionary = Buffer.from(DICTIONARY_BASE64, 'base64');
  }
  return cachedDictionary;
}

export const PYTHON_DICTIONARY_META: DictionaryMeta = {
  name: 'Python Dictionary',
  version: '2.0.0',
  description: 'Trained ZSTD dictionary optimized for Python code compression',
  frameworks: ["python","django","flask","fastapi"],
  sizeBytes: 524288,
  patternCount: 0, // Trained dictionary - patterns are internal
  trainedOn: ['sample python files'],
};
