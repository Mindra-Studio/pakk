/**
 * PAKK Trained ZSTD Dictionary for Java
 *
 * This is a REAL trained ZSTD dictionary (not just text patterns).
 * Trained using: zstd --train on sample Java files.
 *
 * Size: 70494 bytes
 * Generated: 2026-01-31T16:08:29.437Z
 */

import type { DictionaryMeta } from '../core/types.js';

// Base64-encoded trained ZSTD dictionary
const DICTIONARY_BASE64 = 'N6Qw7MkLCFo7ELDDzQEwDMMwDMMwDMPABg1T1E2KX1mLWMi20M7OpCK+XR9tGGTDL6TT3a+jjZjnxiou7cCWEIc1UAJDAAAABAUHRcMhkWhKq9wBBEAAgwSDIDQuHRsYE5BHY5FIJBKIA8JQMAqjIIoiQRKEizMCCQAAAIScKgMAAAAAAAAAAAAAAAAAAAEAAAAEAAAACAAAAAoJCXRyeSB7CgkJCXJldHVybiBzeW50aGVzaXplQW5ub3RhdGlvbkFycmF5KGFubm90bGFzcyl9IGluc3RlYWQuCgkgKiBAcGFyYW0gYW5ub3RhdGVkRWxlbWVudCB0aGUge0Bubm90YXRpb25zLmZyb20oYW5ub3RhdGlvbiwgbmV3IEFubm90YXRpb25bXSB7YW5ub2xhYmxlIEEgZ2V0QW5ub3RhdGlvbihBbm5vdGF0aW9uIGFubm90YXRpb24sIENsYXNzc2VsZiBvciBhIGRpcmVjdCBtZXRhLWFubm90YXRpb24KCSAqIHRoZXJlb2YuCgkgKiB0aW9uVHlwZXMpIHsKCQkJaWYgKGlzQ2FuZGlubm90YXRpb24+LCBNYXA8U3RyaW5nLCBEZWZhdWx0VmFsdWVIb2xkZXI+PiBkZWZhdWZsZWN0LkFubm90YXRlZEVsZW1lbnQjZ2V0QW5ub3RhdGlvbihDbGFzcykKICogQHNlY2xhc3Mgc3RvcCBzZWFyY2hpbmcgZm9yCiAqIGFuIGFubm90YXRpb24gb25jZSB0aGVvdGF0aW9uc30gQVBJIGRpcmVjdGx5IG9yIHRoZSBtb3JlIHNwZWNpZmljCiAqIG1ldHtAY29kZSBmaW5kKigpfSBtZXRob2RzIGFuZCBzb21lIHtAY29kZSBnZXQqKCl9IG1lZXJpdGFuY2UgaGllcmFyY2h5IG9mIHRoZSBnaXZlbgogKiBtZXRob2QgKHtAbGluayBwPkFzIGEgZ2VuZXJhbCBydWxlIGZvciBydW50aW1lLXJldGFpbmVkIGFwcGxpYykgYXMgd2VsbAogKiBhcyBzdXBlciBtZXRob2RzIChmb3Igb3B0aW9uYWwgPGVtPmFuTm9TdWNoRWxlbWVudEV4Y2VwdGlvbjsKaW1wb3J0IGphdmEudXRpbC5TZXQ7CgppbXAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKcGFja2FnZSBvcmcuc3RoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpaWRhdGVOYW1lLCAoVCkgYmVhbkluc3RhbmNlKTsKCQkJfQoJCQlpZiAoIW5vblVuaXFtZSwgZ2V0VHlwZShiZWFuTmFtZSkpOwoJCQkJfQoJCQl9CgkJCVN0cmluZyBjYW5kaQkJCWlmICghY29udGFpbnNCZWFuRGVmaW5pdGlvbihiZWFuTmFtZSkgfHwgZ2V0QmVhbGUgTmFtZWRCZWFuSG9sZGVyPFQ+IHJlc29sdmVOYW1lZEJlYW4oCgkJCVJlc29sdmFyZWRUeXBlLCAiUmVxdWlyZWQgdHlwZSBtdXN0IG5vdCBiZSBudWxsIik7CgkJTmFtZS0tLS0tLS0tLS0tLS0tLS0tLS0KCglAT3ZlcnJpZGUKCXB1YmxpYyA8VD4gTmFtZWRCbmtlZEhhc2hTZXQ8Pih0aGlzLm1hbnVhbFNpbmdsZXRvbk5hbWVzKTsKCQkJCQlhY3RmIG1hbnVhbCBzaW5nbGV0b24gbmFtZXMuCgkgKiBAcGFyYW0gYWN0aW9uIHRoZSBtbygpOwoJCXVwZGF0ZU1hbnVhbFNpbmdsZXRvbk5hbWVzKFNldDo6Y2xlYXIsIHNldCAtKSAmJiBzaW5nbGV0b25PYmplY3QuZ2V0Q2xhc3MoKSAhPSBOdWxsQmVhbi5jbGFzcylqZWN0KTsKCgkJUHJlZGljYXRlPENsYXNzPD8+PiBmaWx0ZXIgPSAoYmVhblR5cGUgLWlyY2xlKFN0cmluZyBuYW1lLCBTdHJpbmcgYWxpYXMpIHsKCQlzdXBlci5jaGVja0Zvb25jdXJyZW50IG1vZGlmaWNhdGlvbiBvZiBiZWFuRGVmaW5pdGlvbk1hcC4KCQkJCWlvckNhY2hlKCkubWVyZ2VkRGVmaW5pdGlvbikgewoJCQlwcm9jZXNzb3IucmVzZXRCZWlvbiBmb3IgdGhlIGdpdmVuIGJlYW4sIGlmIGFscmVhZHkgY3JlYXRlZC4KCQljbGVhZWFuRGVmaW5pdGlvbn0gb24gdGhlCgkgKiBnaXZlbiBiZWFuIGFuZCBvbiBhbGwgYmVuY2x1ZGluZyB0aGUgY2FjaGVzIG9mIGJlYW5zIHRoYXQgYXJlIGRlcml2ZWQgZnJvbW9uIGVsZW1lbnRzIGFueW1vcmUgKGZvciBzdGFibGUgaXRlcmF0aW9uKQoJCQlzeW5jYmVhbkRlZmluaXRpb24gKyAiXSIpOwoJCQl9CgkJCWlmIChsb2dnZXIuaXNEZWJ1Z0VzZSBpZiAoIWJlYW5EZWZpbml0aW9uLmVxdWFscyhleGlzdGluZ0RlZmluaXRpb24pKXIgdGhlIGdpdmVuIGJlYW4uCgkJaWYgKGJlYW5EZWZpbml0aW9uLmlzUHJpbWFyeSgpZmluaXRpb25OYW1lcy5zaXplKGFzICciICsgYmVhbk5hbWUgKyAiJyBmb3IgYmVuZm9FbmFibGVkKCkpIHsKCQkJCQkJbG9nZ2VyLmluZm8oIlJlbW92aW5nIGFsaWFzIG1lLCBiZWFuRGVmaW5pdGlvbik7CgkJfQoJCWVsc2UgewoJCQlpZiAoaXNBbGlhcyhiCX0KCQl9CgoJCUJlYW5EZWZpbml0aW9uIGV4aXN0aW5nRGVmaW5pdGlvbiA9IHRoaXNvbikKCQkJdGhyb3dzIEJlYW5EZWZpbml0aW9uU3RvcmVFeGNlcHRpb24gewoKCQlBc3JpdmF0ZSBPYmplY3QgcmVzb2x2ZUJlYW4oU3RyaW5nIGJlYW5OYW1lLCBSZXNvbHZhbnN0YW50aWF0ZSBzaW5nbGV0b24gYmVhbiAnIiArIGJlYW5OYW1lICsgIicgaW4gYmFhbWUpOwoJCX0KCQljYXRjaCAoUnVudGltZUV4Y2VwdGlvbiB8IEVycm9yIGV4KSB7CmFja2dyb3VuZCBpbml0aWFsaXphdGlvbiAiICsKCQkJCQkJIndpdGhvdXQgYm9vdHN0cik7CgkJCQlhZGRTaW5nbGV0b25GYWN0b3J5KGJlYW5OYW1lLCAoKSAtPiB7CgkJCQliZWFuTmFtZSIsIGJlYW5OYW1lKTsKCQkJCXNtYXJ0U2luZ2xldG9uLmFmdGVyU2luZ0NvbXBsZXRhYmxlRnV0dXJlLmFsbE9mKGZ1dHVyZXMudG9BcnJheShuZXcgQ29tcGxldG9uKCkpIHsKCQkJCQlDb21wbGV0YWJsZUZ1dHVyZTw/PiBmdXR1cmUgPSBwcmVJbnNsZWQoKSkgewoJCQlsb2dnZXIudHJhY2UoIlByZS1pbnN0YW50aWF0aW5nIHNpbmdsZWVybmFsKSB3aXRoIGxlbmllbnQgbG9ja2luZywKCQkJCQkvLyBhbmQgbm90IHBhcnQgbG9jayAobnVsbCksCgkJCQkvLyBCQUNLR1JPVU5EIGlzIG5ldmVyIGFsbG93ZWVTaW5nbGV0b25zIHBoYXNlLCB1c2luZwoJCQkvLyB0aGUgdm9sYXRpbGUgbWFpblRoCQkJCQkidGhyb3VnaCBkZXBlbmRzLW9uICciICsgYmVhbk5hbWUgKyAiJyBkZWNsYXJyb3VuZCAiICsKCQkJCQkJImluaXRpYWxpemF0aW9uIGJ1dCByZXF1ZXN0ZWQgaW4gbWV0dXJuIHN1cGVyLm9idGFpbkluc3RhbmNlRnJvbVN1cHBsaWVyKHN1cHBsaWVyLCBiCgkJcmV0dXJuICh0aGlzLmNvbmZpZ3VyYXRpb25Gcm96ZW4gfHwgc3VwZXIuaXNCZWFlYW5OYW1lKTsKCQl0aGlzLm1lcmdlZEJlYW5EZWZpbml0aW9uSG9sZGVycy5yZW1vdj0gbmV3IENvbXBvc2l0ZUl0ZXJhdG9yPD4oKTsKCQlpdGVyYXRvci5hZGQodGhpcy5ibk5hbWUpIHRocm93cyBOb1N1Y2hCZWFuRGVmaW5pdGlvbkV4Y2VwdGlvbiB7CgkJQmVkaWRhdGUoU3RyaW5nIGJlYW5OYW1lLCBSb290QmVhbkRlZmluaXRpb24gbWJkLAoJCWlkYXRlLAoJICogdG8gYmUgaW5qZWN0ZWQgaW50byBvdGhlciBiZWFucyB3aGljaCBkaW5zdGFuY2VvZiBDb25maWd1cmFibGVMaXN0YWJsZUJlYW5GYWN0b3J5IGNsYmYpIHtuc2lkZXJlZCBhcyBhdXRvd2llUmVzb2x2ZXIoKSk7Cgl9CgoJLyoqCgkgKiBEZXRlcm1pbmUgd2hldGhlciB0aGUgcyAoIShhdXRvd2lyZWRWYWx1ZSBpbnN0YW5jZW9mIE9iamVjdEZhY3RvcnkgfHwgZGVwbnRoZXNpemUoKSkpOwoJCQl9CgkJfQoJCXJldHVybiBhbm5vdGF0aW9uczsKCX0KCgoJCQkJCS5maWx0ZXIoTWVyZ2VkQW5ub3RhdGlvbjo6aXNQcmVzZW50KQoJCQkJCQkJLnBlKSB7CgkJCQkJTWVyZ2VkQW5ub3RhdGlvbnMuZnJvbShiZWFuQ2xhc3MsIE1lcmdlU2V0PEE+IGFubm90YXRpb25zID0gbmV3IExpbmtlZEhhc2hTZXQ8PigpOwoJCUNsYXNuVHlwZSk7CgkJCQkJaWYgKGFubm90YXRpb24uaXNQcmVzZW50KCkpIHsKCQkJCQkJciBiZCA9IGdldE1lcmdlZExvY2FsQmVhbkRlZmluaXRpb24oYmVhbk5hbWUpOwoJCQkvbiBmaW5kQW5ub3RhdGlvbk9uQmVhbihiZWFuTmFtZSwgYW5ub3RhdGlvblR5cGUsIHRuTmFtZSA6IGJlYW5OYW1lcykgewoJCQlPYmplY3QgYmVhbkluc3RhbmNlID0gZ2V0QmUgOiB0aGlzLm1hbnVhbFNpbmdsZXRvbk5hbWVzKSB7CgkJCWlmICghcmVzdWx0LmNvIHdoZW4gYXV0b3dpcmluZyBjb25zdHJ1Y3RvcnMuCgkJCQkJCS8vIFdlIHdhbnQgdG9JZ25vcmUgLSBwcm9iYWJseSBhIE51bGxCZWFuCgkJCX0KCQkJY2F0Y2ggKEJlYW5Dcm5OYW1lcykgewoJCQl0cnkgewoJCQkJT2JqZWN0IGJlYW5JbnN0YW5jZSA9ICh0eXBlTnVsbGFibGUgU3RyaW5nIGZhY3RvcnlCZWFuTmFtZSkgewoJCXJldHVybiAoZmFjdG8JCXJldHVybiAoZGJkICE9IG51bGwgPyBtYmQuaXNTaW5nbGV0b24oKSA6IGlzU2luZ2xhciByZWZlcmVuY2UgcmVzb2x1dGlvbi4uLgoJCQkJbG9nZ2VyLnRyYWNlKExvZ01lLy8gQ2hlY2sgbWFudWFsbHkgcmVnaXN0ZXJlZCBzaW5nbGV0b25zIHRvby4KCQlmb3IudHJhY2UobWVzc2FnZSwgZXgpOwoJCQkJCS8vIFJlZ2lzdGVyIGV4Y2VwdGlvbiwgaWFsbG93RWFnZXJJbml0KSB7CgkJCQkJCXRocm93IGV4OwoJCQkJCX0KCQkJCQkvLyBQLCB0eXBlLCBhbGxvd0ZhY3RvcnlCZWFuSW5pdCkgJiYKCQkJCQkJCQkJCWlzU2luZ2xib29sZWFuIGFsbG93RmFjdG9yeUJlYW5Jbml0ID0gKGFsbG93RWFnZXJJbml0IHx8IGYgdGhlIGJlYW4gbmFtZSBpcyBub3QgZGVmaW5lZCBhcyBhbGlhcyBmb3Igc29tZSBvZXNvbHZlZEJlYW5OYW1lczsKCQl9CgkJcmVzb2x2ZWRCZWFuTmFtZXMgPSBkb0dldEJzQ29uZmlndXJhdGlvbkZyb3plbigpIHx8IHR5cGUgPT0gbnVsbCB8fCAhYWxsb3dFYSkpIHsKCQkJcmV0dXJuIGdldEJlYW5OYW1lc0ZvclR5cGUocmVzb2x2ZWQsIGluY2x1bDsKCX0KCglwcml2YXRlIFN0cmluZ1tdIGJlYW5OYW1lc0ZvclN0cmVhbShSZXNvbHZ1bGwpIHsKCQkJCXJldHVybiBwYXJlbnRQcm92aWRlci5nZXRPYmplY3QoYXJncyk7CgkJaWYgKGN1c3RvbUZpbHRlci50ZXN0KGdldFR5cGUoYmVhbk5hbWUpKSkgeykKCQkJQE92ZXJyaWRlCgkJCXB1YmxpYyBTdHJlYW08VD4gb3JkZXJlZFN0cmVhbShQdG9ucywgYWxsb3dFYWdlckluaXQpKQoJCQkJCQkuZmlsdGVyKG5hbWUgLT4gY3VzdG9pZiAoIShiZWFuSW5zdGFuY2UgaW5zdGFuY2VvZiBOdWxsQmVhbikpIHsKCQkJCQkJbUJlYW4obmFtZSwgcmVxdWlyZWRUeXBlKSkKCQkJCQkJLmZpbHRlcihiZWFuIC0+ICEoYW5zRXhjZXB0aW9uIHsKCQkJCVQgZGVwZW5kZW5jeSA9IGdldElmVW5pcXVlKCk7CglnZXRJZkF2YWlsYWJsZSgpIHRockBPdmVycmlkZQoJCQlwdWJsaWMgVCBnZXRPYmplY3QoQE51bGxhYmxlIE9iamVjdC4uZXI8PigpIHsKCQkJQE92ZXJyaWRlCgkJCXB1YmxpYyBUIGdldE9iamVjdCgpIHRocm9OYW1lcyAhPSBudWxsKSB7CgkJCXJldHVybiBmcm96ZW5OYW1lcy5jbG9uZSgpOwoJCXJuIGdldEJlYW5Qcm92aWRlcihyZXF1aXJlZFR5cGUsIHRydWUpOwoJfQoKCXB1YmxpZmluaXRpb25FeGNlcHRpb24ocmVxdWlyZWRUeXBlKTsKCQl9CgkJcmV0dXJuIChUKSA+IHJlcXVpcmVkVHlwZSwgQE51bGxhYmxlIE9iamVjdCBATnVsbGFibGUgLi4uIGFyZ290aGVyTGlzdGFibGVGYWN0b3J5LmJvb3RzdHJhcEV4ZWN1dG9yOwoJCQl0aGlzLmRlb25Gcm9tKENvbmZpZ3VyYWJsZUJlYW5GYWN0b3J5IG90aGVyRmFjdG9yeSkgewoJCXMvCglwdWJsaWMgdm9pZCBzZXRBdXRvd2lyZUNhbmRpZGF0ZVJlc29sdmVyKEF1dG93aW9sdmVyIGZvciB0aGlzIEJlYW5GYWN0b3J5IHRvIHVzZQoJICogd2hlbiBkZWNpZGlucmsuY29yZS5hbm5vdGF0aW9uLkFubm90YXRpb25Bd2FyZU9yZGVyQ29tcGFyYXRvcgoqKgoJICogUmV0dXJuIHdoZXRoZXIgdGhlIGZhY3RvcnkgaXMgYWxsb3dlZCB0byBlYWx0IGlzICJ0cnVlIi4gVHVybiB0aGlzIGZsYWcgb2ZmIHRvIHN1cHByZXNzIGNsYXNzdmVycmlkaW5nKGJvb2xlYW4gYWxsb3dCZWFuRGVmaW5pdGlvbk92ZXJyaWRpbmcpIHsJcHVibGljIEBOdWxsYWJsZSBTdHJpbmcgZ2V0U2VyaWFsaXphdGlvbklkKCkgewoJCXIocGFyZW50QmVhbkZhY3RvcnkpOwoJfQoKCgkvKioKCSAqIFNwZWNpZnkgYW4gaWQgQmVhbkZhY3Rvcnkgd2l0aCB0aGUgZ2l2ZW4gcGFyZW50LgoJICogQHBhcmFtIHBhcmVuZXcgTGlua2VkSGFzaFNldDw+KDE2KTsKCgkvKiogQ2FjaGVkIGFycmF5IG9mIGJlYWwgTWFwPFN0cmluZywgQ2xhc3M8Pz4+IHByaW1hcnlCZWFuTmFtZXNXaXRoVHlwZSA9ZXMgd2l0aCBhIHByaW1hcnkgbWFya2VyIHBsdXMgY29ycmVzcG9uZGluZyB0eXBlLiBpZiBhIGJlYW4gZGVmaW5pdGlvbiBpcyBhbiBhdXRvd2lyZSBjYW5kaWRhdGUuICovClN0cmluZyBzZXJpYWxpemF0aW9uSWQ7CgoJLyoqIFdoZXRoZXIgdG8gYWxsb3cgcmUtZXRDbGFzc0xvYWRlcigpKTsKCQl9CgkJY2F0Y2ggKENsYXNzTm90Rm91bmRFeGNlcHRwIHRocmVhZHMgY2FsbGluZyBpbnRvIHRoZSBmYWN0b3J5KQoJICogYW5kIHRoZXJlZmxpemFibGUgewoKCS8qKgoJICogU3lzdGVtIHByb3BlcnR5IHRoYXQgaW5zdHJ1Y3RzQHNlZSAjYWRkQmVhblBvc3RQcm9jZXNzb3IKICogQHNlZSAjZ2V0QmVhbgogKiBAc2V0YWRhdGEgb2JqZWN0cy4KICoKICogPHA+Tm90ZSB0aGF0IHJlYWRlcnMgZm9yIHNwZWJlYW4gZGVmaW5pdGlvbiB0YWJsZSwKICogb3BlcmF0aW5nIG9uIHByZS1yZXNvbHZlZXA7CmltcG9ydCBvcmcuc3ByaW5nZnJhbWV3b3JrLmxhbmcuQ29udHJhY3Q7CmltcG9wb3J0IG9yZy5zcHJpbmdmcmFtZXdvcmsuY29yZS5SZXNvbHZhYmxlVHlwZTsKaW1wb25pdGlhbGl6aW5nU2luZ2xldG9uOwppbXA7CmltcG9ydCBvcmcuc3ByaW5nZnJhbWV3b3JrLmJlYW5zLmZhY3RvcnkuTm9TdWNoQnBvcnQgb3JnLnNwcmluZ2ZyYW1ld29yay5iZWFucy5mYWN0b3J5LkJlYW5DcmVuY3Rpb24uQ29uc3VtZXI7CmltcG9ydCBqYXZhLnV0aWwuZnVuY3Rpb24uUHJlZGljYXQgamF2YS51dGlsLkFycmF5czsKaW1wb3J0IGphdmEudXRpbC5Db2xsZWN0aW9uOwppaW8uSU9FeGNlcHRpb247CmltcG9ydCBqYXZhLmlvLk5vdFNlcmlhbGl6YWJsZUV4Y2UqCiAqICAgICAgaHR0cHM6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLU1hcHBpbmdzLmNsZWFyQ2FjaGUoKTsKCQlBbm5vdGF0aW9uc1NjYW5uZXIuY2xlYXJDIHNldHRpbmdzIGRpc2FsbG93IHJlZmxlY3RpdmUgYWNjZXNzIHRvIHRoZSBJbnZvY2EoaW50IGkgPSAwOyBpIDwgYW5ub3RhdGlvbnMubGVuZ3RoOyBpKyspIHsKCQkJc3ludHR1cm4gYSBuZXcgYXJyYXkgb2Ygc3ludGhlc2l6ZWQgYW5ub3RhdGlvbnMsIG9yIHtAbm5vdGF0ZWRFbGVtZW50LCBhbm5vdGF0aW9uVHlwZSwgYXR0cmlidXRlcykuc3ludGhBbm5vdGF0aW9uQXR0cmlidXRlc30gaXMgYSBzcGVjaWFsaXplZCB0eXBlIG9mCgkgKmRlIGFubm90YXRpb25UeXBlfSBhbmQgdHJhbnNwYXJlbnRseQoJICogZW5mb3JjIHRoZSBtYXAgaW4gYSBkeW5hbWljIHByb3h5IHRoYXQgaW1wbGVtZW50cyBhbgoJICpzaXplCgkgKiBAcmV0dXJuIHRoZSBzeW50aGVzaXplZCBhbm5vdGF0aW9uCgkgKiBAdHJvbShhbm5vdGF0ZWRFbGVtZW50LCBhbm5vdGF0aW9uKS5zeW50aGVzaXplKCk7Cgl9dGhlcndpc2UgdGhlIHN1cHBsaWVkIGFubm90YXRpb24gdW5tb2RpZmllZAoJICogQHRwbGllZCB7QGNvZGUgYW5ub3RhdGlvbn0KCSAqIGJ5IHdyYXBwaW5nIGl0IGluIGEgZGxpYyBzdGF0aWMgQE51bGxhYmxlIE9iamVjdCBnZXREZWZhdWx0VmFsdWUoQ2xhc3M8YWlsZWQgdG8gcmV0cmlldmUgdmFsdWUgZnJvbSAiICsgYW5ub3RhdGlvbiArICI6ICJ0aW9uICIgOiAiaW50cm9zcGVjdCBhbm5vdGF0aW9ucyBvbiAiKSArCgkJCQkJZWxlbSAqIEBwYXJhbSBlbGVtZW50IHRoZSBlbGVtZW50IHRoYXQgd2UgdHJpZWQgdG8gaW50YW5ub3RhdGlvbiBhdHRyaWJ1dGVzIGFuZAoJICogdGhlcmVieSBlZmZlY3RpdmVseSBpZ3VyYXRpb25FeGNlcHRpb24oVGhyb3dhYmxlIGV4KSB7CgkJaWYgKGV4IGluc3RhbmF0aW9uID09IG51bGwpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJCWlmIChQcm94eS5pYyBwcm94eSkuCgkgKiBJZiB0aGF0IGZhaWxzLCBhbiBhdHRlbXB0IHdpbGwgYmUgbWEgKi8KCXB1YmxpYyBzdGF0aWMgQE51bGxhYmxlIE9iamVjdCBnZXRWYWx1ZShATnVsbCB2YWx1ZSwgb3Ige0Bjb2RlIG51bGx9IGlmIG5vdCBmb3VuZCB1bmxlc3MgdGhlIGF0ZiBhCgkgKiBzaW5nbGVzaXplZCA9IChBbm5vdGF0aW9uW10pIEFycmF5Lm5ld0luc3RhbmNlKAoJCQkJCWFubmJqZWN0IGFkYXB0VmFsdWUoCgkJCUBOdWxsYWJsZSBPYmplY3QgYW5ucy5nZXQoYXR0cmlidXRlLmdldE5hbWUoKSk7CgkJcmV0dXJuIChyZXN1bHQgaW5zdGFvclNldC5nZXQoaik7CgkJCQkJCWlmIChtaXJyb3IgIT0gYXR0cmlidXRlKSB7CgkJcmlidXRlID0gbWFwcGluZy5nZXRBdHRyaWJ1dGVzKCkuZ2V0KHJlc29sdmVkKTsKCQllYW4gY2xhc3NWYWx1ZXNBc1N0cmluZykgewoKCQlpZiAoYXR0cmlidXRlcyA9PSBudWggYW4gYW5ub3RhdGlvbiBvcgoJICogYW5ub3RhdGlvbiBoaWVyYXJjaHkgZnJvbSB3bHQucHV0KGVsZW1lbnQuZ2V0S2V5KCksIG5ldyBEZWZhdWx0VmFsdWVIb2xkZXIoZWxkcy5nZXQoaSk7CgkJCQlPYmplY3QgZGVmYXVsdFZhbHVlID0gbWV0aG9kLmdldERlZiAoIW1ldGhvZHMuaGFzRGVmYXVsdFZhbHVlTWV0aG9kKCkpIHsKCQkJcmV0dXJuIENvU3RyaW5nLCBEZWZhdWx0VmFsdWVIb2xkZXI+IGdldERlZmF1bHRWYWx1ZXMoCgkJCUN0YXRpb24gYXR0cmlidXRlcyB0byBwcm9jZXNzCgkgKiBAc2luY2UgNC4zLjIKCSAqL2FzIHZhbHVlcyAobmV2ZXIge0Bjb2RlIG51bGx9KQoJICogQHNpbmNlIDQuMgoJICovYXRpb25BdHRyaWJ1dGVzKEFubm90YXRpb24sIGJvb2xlYW4sIGJvb2xlYW4pCgkgKiB2YWxpZGF0ZUFubm90YXRpb24oQW5ub3RhdGlvbiBhbm5vdGF0aW9uKSB7CgkJQXR0cikuCgkgKiA8cD5UaGlzIG1ldGhvZCBub3QgZmFpbGluZyBpbmRpY2F0ZXMgdGhhdCB7cGUgdGhlIG5hbWUgb2YgdGhlIGFubm90YXRpb24gdHlwZSB0byBjaGVjawoJICogQHIvKioKCSAqIERldGVybWluZSBpZiB0aGUge0BsaW5rIEFubm90YXRpb259IHdpdGggdG9uVHlwZSwKCQkJQE51bGxhYmxlIENsYXNzPD8gZXh0ZW5kcyBBbm5vdGF0aW9uPiBtaGVyaXRlZChDbGFzczxuIGluaGVyaXRhbmNlLgphbmRhcmQgbWV0YS1hbm5vdGF0aW9uCgkgKiBzZW1hbnRpY3MgaW4gSmF2YSwgdGhlIGx5UHJlc2VudCgpOwoJfQoKCS8qKgoJICogRGV0ZXJtaW5lIHdoZXRoZXIgYW4gYW5ucHBsaWVkCgkgKiB7QGNvZGUgY2xhenp9LgoJICogcm4gbnVsbDsKCQl9CgoJCU1lcmdlZEFubm90YXRpb248Pz4gbWVyZ2VkID0gTWVyZ2xhc3M8PyBleHRlbmRzIEFubm90YXRpb24+PiBhbm5vdGF0aW9uVHlwZXMsIEBOdWxsIEBwYXJhbSBhbm5vdGF0aW9uVHlwZXMgdGhlIGFubm90YXRpb24gdHlwZXMgdG8gbG9mIHRoZSBzcGVjaWZpZWQge0Bjb2RlIGFubm90YXRpb25UeXBlfSwKCSAqIG9yIHtAY2VkIGFzIEBJbmhlcml0ZWQ6IGZvciBleGFtcGxlLCBhIGZpbmRBbgkJLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBwZXJmb3JtIGEgc3VwZXJjTm90ZTogaW4gdGhpcyBjb250ZXg8bGk+UmVjdXJzaXZlbHkgc2VhcmNoIHRocm91Z2ggYWxsIGludGVyZmFjZXMgdGhhdHRlcmZhY2VzLCBhbm5vdGF0aW9ucywgYW5kCgkgKiBzdXBlcmNsYXNzZXMgaWYgdGhlZXJpdGVkIGJ5IGRlZmF1bHQsIHNvIHdlIG5lZWQgdG8gaGFuZGxlCgkgKiB0aGlzIGVyZWN0bHkgcHJlc2VudDwvZW0+IG9uIHRoZSBnaXZlbgoJICogbWV0aG9kIGl0c2VsZnRhdGVkRWxlbWVudCkpIHsKCQkJcmV0dXJuIGFubm90YXRlZEVsZW1lbnQuZ2V0RGVjY3Mgb2Yge0BsaW5rICNmaW5kQW5ub3RhdGlvbihDbGFzcywgQ2xhc3MpfQoJICogb3JJbiBvdGhlciB3b3JkcywgdGhpcyBtZXRob2QgZG9lcyBub3QgZXhlY3V0ZQoJICogc3RyZWFtKGFubm90YXRpb25UeXBlKQoJCQkJLm1hcChNZXJnZWRBbm5vdGF0aW9uOjp3CVJlcGVhdGFibGVDb250YWluZXJzLnN0YW5kYXJkUmVwZWF0YWJsZXMoKSk7CgoJCXJuIEBOdWxsYWJsZSBbXSBnZXRBbm5vdGF0aW9ucyhNZXRob2QgbWV0aG9kKSB7CgkJdGhhbmRsZUludHJvc3BlY3Rpb25GYWlsdXJlKGFubm90YXRlZEVsZW1lbnQsIGV4KTsKYXRlZEVsZW1lbnQuZ2V0QW5ub3RhdGlvbnMoKSwgYW5ub3RhdGVkRWxlbWVudCk7Cglhc3MpfSBpbnN0ZWFkLgoJICogQHBhcmFtIG1ldGhvZCB0aGUgbWV0aG9kIHRvIGxvb2UgdGhlIGFubm90YXRpb24gaXMgZWl0aGVyIDxlbT5wcmVzZW50PC9lbT4KCSAqIG9yZEVsZW1lbnQuZ2V0QW5ub3RhdGlvbihhbm5vdGF0aW9uVHlwZSk7CgkJfQoJCS8vIEVvcnQgZm9yIGFyYml0cmFyeSBsZXZlbHMgb2YgbWV0YS1hbm5vdGF0aW9ucywgdXNlCm50aGVzaXplQW5ub3RhdGlvbigoQSkgYW5ub3RhdGlvbiwgYW5ub3Rubm90YXRpb24gdGhlIEFubm90b25UeXBlfSBmcm9tIHRoZSBzdXBwbGllZAoJICogYW5ub3RhdGlvbjogZWl0aGVyIHRhc3MgdG8gaW50cm9zcGVjdAoJICogQHBhcmFtIGFubm90YXRpb25UeXBlIHRoZSBzZShDbGFzczw/IGV4dGVuZHMgQW5ub3RhdGlvbj4gYW5ub3RhdGlvblR5cGUgOiBhbm5vb3RhdGlvbkZpbHRlciBKQVZBX0xBTkdfQU5OT1RBVElPTl9GSUxURVIgPQoJCQlBbm5ub3RhdGlvbkF0dHJpYnV0ZXMKICogQHNlZSBNZXJnZWRBbm5vdGF0aW9ucwogKiBAc2FzIGJlZW4KICogZm91bmQuIEFzIGEgY29uc2VxdWVuY2UsIGFkZGl0aW9uYWwgYW5uICogPHA+QWxsIHB1YmxpYyBtZXRob2RzIGluIHRoaXMgY2xhc3MgdGhhdCByZXR1cm5pZGUgc3VwcG9ydCBmb3IgZmluZGluZyBhbm5vdGF0aW9ucyB1c2VkIGFzIG1ldGEtYWluZDwvZW0+IGxvb2t1cCBpbiB0aGUgZW50aXJlIGluaGVyemF0aW9uLCBvciBzZXJ2aWNlIGV4cG9zdXJlKSwgYWx3YXlzIHVzZSB0aGUKICogbG9Ob3RlIHRoYXQgbW9zdCBvZiB0aGUgZmVhdHVyZXMgb2YgdGhpcyBjbGFzcyBhcmUgbnN0OwppbXBvcnQgamF2YS51dGlsLk1hcDsKaW1wb3J0IGphdmEudXRpbC5Ob1N1Y2hFbmcucmVmbGVjdC5BcnJheTsKaW1wb3J0IGphdmEubGFuZy5yZWZsZWN0Lkludm9jYXRsZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cmVzdFByaW9yaXR5Q2FuZGlkYXRlKGNhbmRpZGF0ZXMsIHJlcXVlTmFtZSA9PSBudWxsKSB7CgkJCQljYW5kaWRhdGVOYW1lID0gZGV0ZXJtaW5lSGlnaG9uKGJlYW5OYW1lKS5pc0F1dG93aXJlQ2FuZGlkYXRlKCkpIHsKCQkJCQlhdXRvd2lydDxTdHJpbmc+IGF1dG93aXJlQ2FuZGlkYXRlcyA9IG5ldyBBcnJheUxpc3Q8PihjYW5hcmVudEJlYW5GYWN0b3J5KCk7CgkJaWYgKHBhcmVudCBpbnN0YW5jZW9mIEF1dG93aXMubWFudWFsU2luZ2xldG9uTmFtZXMpKSB7CgkJCQlhY3Rpb24uYWNjZXB0KHRoaXMub25OYW1lcykpIHsKCQkJCQlTZXQ8U3RyaW5nPiB1cGRhdGVkU2luZ2xldG9ucyA9IG5uZ2xldG9uTmFtZXMoQ29uc3VtZXI8U2V0PFN0cmluZz4+IGFjdGlvbiwgUHJlZGljYWV0b25zKCk7CgkJdXBkYXRlTWFudWFsU2luZ2xldG9uTmFtZXMoU2V0OjpjbGVhciwgYXNzPD8+IGJlYW5UeXBlID0gKHNpbmdsZXRvbk9iamVjdCBpbnN0YW5jZW9mIEZhY3RlICsgIic6IEFsaWFzIHdvdWxkIG92ZXJyaWRlIGJlYW4gZGVmaW5pdGlvbiAnIiArIC8qKgoJICogQWxzbyBjaGVja3MgZm9yIGFuIGFsaWFzIG92ZXJyaWRpbmcgYSBiZWFuCgkgKiBAc2VlICNzZXRBbGxvd0JlYW5EZWZpbml0aW9uT3ZlcnJpZGluZwoJICovCglvdGlmeSBhbGwgcG9zdC1wcm9jZXNzb3JzIHRoYXQgdGhlIHNwZm9yIGV4YW1wbGUsIHRoZSBkZWZhdWx0IFN0YXRpY01lc3NhZ2VTb3VyY2UgaW4gYSBlZCBmcm9tIGl0LgoJICogPHA+Q2FsbGVkIGFmdGVyIGFuIGV4aXN0CgkJdGhpcy5mcm96ZW5CZWFuRGVmaW5pdGlvbk5hbWVzID0gbnVsbDsKCgkJcmVzZXRuIG5hbWVkICciICsgYmVhbk5hbWUgKyAiJyBmb3VuZCBpbiAiICsgdGhpcyk7CgkJCXRpb24gZm9yIGJlYW4gJyIgKyBiZWFuTmFtZSArCgkJCQkJCSInIHdpdGggYSBkaWZmZmluaXRpb24uZ2V0Um9sZSgpIDwgYmVhbkRlZmluaXRpb24uZ2V0Um9sZSgpKSB7CgkpIHsKCQkJY2xlYXJCeVR5cGVDYWNoZSgpOwoJCX0KCgkJLy8gQ2FjaGUgYSBwcmltYWRhdGVkRGVmaW5pdGlvbnM7CgkJCQkJcmVtb3ZlTWFudWFsU2luZ2xldG9uTmFtZShiIGZvciBiZWFuICciICsgYmVhbk5hbWUgKyAiJzogWyIgKwoJCQkJCQkJCWJlYW5EZWZsaWFzIGZvciBiZWFuICciICsgYWxpYXNlZE5hbWUgKyAiJyBib3VuZC4iKTsKCQkJCU5hbWUpKSB7CgkJCQlTdHJpbmcgYWxpYXNlZE5hbWUgPSBjYW5vbmljYWxOYW1lKGJlCQl0cnkgewoJCQkJYWJkLnZhbGlkYXRlKCk7CgkJCX0KCQkJY2F0Y2ggKEJlYW5EZWYKCS8vIEltcGxlbWVudGF0aW9uIG9mIEJlYW5EZWZpbml0aW9uUmVnaXN0cnkgaW50ZXkgewoJCQkvLyBOZWVkIHRvIHByb3ZpZGUgcmVxdWlyZWQgdHlwZSBmb3IgU21hcnRGcmVhZCIsIGV4KTsKCQkJfQoJCQl0aHJvdyBleDsKCQl9CgkJZmluYWxseSB7CgkJCXR0KFByZUluc3RhbnRpYXRpb24uQkFDS0dST1VORCk7CgkJdHJ5IHsKCQkJaW5zdGFudGxhc3NDYXN0RXhjZXB0aW9uIGluIGNhc2Ugb2YgbWlzbWF0Y2gKCQkJCX0pOwoJCQkJZnV0dXJlID0gQ29tcGxldGFibGVGdXR1cmUucnVuQXN5bmMoCgkJCQkJCSgpIC0+IGluZy5iZWFucy5zbWFydC1pbml0aWFsaXplIikKCQkJCQkJLnRhZygiYmVhbk5hbWUiLHphdGlvbiBjYWxsYmFjayBmb3IgYWxsIGFwcGxpY2FibGUgYmVhbnMuLi4KCQlmb3IgCQl0cnkgewoJCQlMaXN0PENvbXBsZXRhYmxlRnV0dXJlPD8+PiBmdXR1cmVzID0gbmVvdCBiZSBwYXJ0IG9mIHRoZSByZWd1bGFyIGZhY3RvcnkgYm9vdHN0cmFwLCBpdCBkbwkJCQkvLyAoZXhjbHVkaW5nIHNjZW5hcmlvcyB3aGVyZSB3ZSBhcmUgaGl0IGJ5IG11bGxvd2VkIHRvIGxvY2sgKGZhbHNlKS4KCQkJCXJldHVybiBzd2l0Y2ggKHByZUluc3RudWxsKSB7CgkJCS8vIFdlIG9ubHkgZGlmZmVyZW50aWF0ZSBpbiB0aGUgcHJlSW5zdCBkZWNsYXJhdGlvbiBmb3IgZGVwZW5kZW50IGJhY2tncm91bmQgYmVhbnMiKTsKCQkJaW4gbWFpbmxpbmUgdGhyZWFkIC0gZGVjbGFyZSBPYmplY3RQcm92aWRlciAiICsKCQlpZiAoc3VwcGxpZXIgaW5zdGFuY2VvZiBJbnN0YW5jZVN1cHBsaWVyPD8+IGluc3RhbmlvbkZyb3plbjsKCX0KCgkvKioKCSAqIENvbnNpZGVycyBhbGwgYmVhbnMgYXMgZWxpYm9vbGVhbiBpc0NvbmZpZ3VyYXRpb25Gcm96ZW4oKSB7CgkJcmV0dXJuIHRoaXMuY29ycmlkZQoJcHVibGljIEl0ZXJhdG9yPFN0cmluZz4gZ2V0QmVhbk5hbWVzSXRlcmF0b3B0b3IpOwoJfQoKCUBPdmVycmlkZQoJcHVibGljIEJlYW5EZWZpbml0aW9uIGdldEJlKS5yZXNvbHZlRmFjdG9yeU1ldGhvZElmUG9zc2libGUobWJkKTsKCQl9CgkJQmVhbkQgZGVmaW5pdGlvbiB0byBjaGVjawoJICogQHBhcmFtIG1iZCB0aGUgbWVyZ2VkIGJlYXlwZShiZWFuTmFtZSkpLCBkZXNjcmlwdG9yLCByZXNvbHZlcik7CgkJfQoKCQlCZWFuYW4gaXNBdXRvd2lyZUNhbmRpZGF0ZSgKCQkJU3RyaW5nIGJlYW5OYW1lLCBEZXBlbmRlY2sKCSAqIEBwYXJhbSBkZXNjcmlwdG9yIHRoZSBkZXNjcmlwdG9yIG9mIHRoZSBkZWVzIG5vdCBpbXBsZW1lbnQgc3BlY2lmaWVkIGRlcGVuZGVuY3kgdHlwZSBbIiArIGRleXBlIG11c3Qgbm90IGJlIG51bGwiKTsKCQlpZiAoYXV0b3dpcmVkVmFsdWUgIT0gbnUgewoJCQkJTWVyZ2VkQW5ub3RhdGlvbnMuZnJvbShmYWN0b3J5TWV0aG9kLCBNZXJnZWluaXRpb24oYmVhbk5hbWUpKSB7CgkJCVJvb3RCZWFuRGVmaW5pdGlvbiBiZCA9IGdlCQkJdGhyb3dzIE5vU3VjaEJlYW5EZWZpbml0aW9uRXhjZXB0aW9uIHsKCgkJU2V0PEF0aW9uID0KCQkJCQkJTWVyZ2VkQW5ub3RhdGlvbnMuZnJvbShmYWN0b3J5TWV0aG9kLG4gPQoJCQkJCQkJTWVyZ2VkQW5ub3RhdGlvbnMuZnJvbShiZWFuQ2xhc3MsIFNlYXJjZWZpbml0aW9uRXhjZXB0aW9uIHsKCgkJcmF0aW9uKGFubm90YXRpb25UeXBlKTsKCQlNYXA8U3RyaW5nLCBPYmplY3Q+IHJlc3VsZGUKCXB1YmxpYyBNYXA8U3RyaW5nLCBPYmplY3Q+IGdldEJlYW5zV2l0aEFubm90YXR0TWVzc2FnZSgpKTsKCQkJCQkJfQoJCQkJCQlvbikpIHsKCQkJCQkJCWxvZ2dlci50cmFjZSgiSWdub3JpbmcgbWF0Y2ggdG8gY3VycmVubmNsdWRlTm9uU2luZ2xldG9ucywgYm9vbGVhbiBhbGxvd0VhZ2VySW5pdCkgdGhyb3dudWxsICYmIGlzRmFjdG9yeUJlYW4oZmFjdG9yeUJlYW5OYW1lKSAmJiAhY29udGFpbnkgaW5pdGlhbGl6ZWQKCSAqIGluIG9yZGVyIHRvIGRldGVybWluZSBpdHMgdHlwZS4KY3RvcnlCZWFuKS4KCQkJCWlmIChpc1R5cGVNYXRjaChiZWFuTmFtZSwgdHlwZSkpIHs7CgkJCQkJCS8vIE1hdGNoIGZvdW5kIGZvciB0aGlzIGJlYW46IGRvIG5vdCBtYXRjaGRlcjogbGV0J3MgaWdub3JlIGl0IGZvciB0eXBlIG1hdGNoaW5nIHB1cnBvc2VzLgoJfQoJCQkJY2F0Y2ggKENhbm5vdExvYWRCZWFuQ2xhc3NFeGNlcHRpb24gfCBCZWFuRGUKCQkJCQkJCWVsc2UgaWYgKGFsbG93RmFjdG9yeUJlYW5Jbml0KSB7CgkJCQkJCQkJL3RlZERlZmluaXRpb24oKTsKCQkJCQkJYm9vbGVhbiBtYXRjaEZvdW5kID0gZmFsc2U7d0VhZ2VySW5pdCB8fAoJCQkJCQkJKG1iZC5oYXNCZWFuQ2xhc3MoKSB8fCAhbWJkLmlucywgYm9vbGVhbiBhbGxvd0VhZ2VySW5pdCkgewoJCUxpc3Q8U3RyaW5nPiByZXN1bG5OYW1lc0J5VHlwZSk7CgkJU3RyaW5nW10gcmVzb2x2ZWRCZWFuTmFtZXMgPSBjYWNoZ1tdIGdldEJlYW5OYW1lc0ZvclR5cGUoQE51bGxhYmxlIENsYXNzPD8+IHR5cGUpIHtVbmlxdWVBc051bGwgPyBwYXJlbnRQcm92aWRlci5nZXRJZlVuPFQ+IHBhcmVudFByb3ZpZGVyID0gcGFyZW50LmdldEJlYW5Qcm92aWRlcihyZXF1aXJCZWFucykpOwoJCQl9CgkJfTsKCX0KCglwcml2YXRlIDxUPiBATnVsbGFibGUgVCByZT8+PiBjdXN0b21GaWx0ZXIsIGJvb2xlYW4gaW5jbHVkZU5vblNpbmdsZXRvbnMpIHsKdGFuY2UpOwoJCQkJCX0KCQkJCX0KCQkJCVN0cmVhbTxUPiBzdHJlYW0gPSBtYXRjaGkpCgkJCUBPdmVycmlkZQoJCQlwdWJsaWMgU3RyZWFtPFQ+IG9yZGVyZWRTdHJlYW0oKSwgdHJ1ZSwgYWxsb3dFYWdlckluaXQpKQoJCQkJCQkubWFwKG5hbWUgLT4gKFQpIHJlCX0KCQkJfQoJCQlAT3ZlcnJpZGUKCQkJcHVibGljIHZvaWQgaWZVbmlxdWUoQ29uc3VpZiAoZGVwZW5kZW5jeSAhPSBudWxsKSB7CgkJCQkJdHJ5IHsKCQkJCQkJZGVwZW5kZXsKCQkJCVQgcmVzb2x2ZWQgPSByZXNvbHZlQmVhbihyZXF1aXJlZFR5cGUsIG51bGwscGUuZm9yUmF3Q2xhc3MocmVxdWlyZWRUeXBlKSwgYWxsb3dFYWdlckluaXQpOwoJfQpPdmVycmlkZQoJcHVibGljIGludCBnZXRCZWFuRGVmaW5pdGlvbkNvdW50KCkgewoJCSBnZXRCZWFuUHJvdmlkZXIoUGFyYW1ldGVyaXplZFR5cGVSZWZlcmVuY2U8VD4gcmVxZVR5cGUuZm9yUmF3Q2xhc3MocmVxdWlyZWRUeXBlKSwgYXJncywgZmFsc2UpOwoJCWl0b3J5LnJlc29sdmFibGVEZXBlbmRlbmNpZXMpOwoJCWJsZUZhY3RvcnkuZGVwZW5kZW5jeUNvbXBhcmF0b3I7CgkJCS8vIEEgY2xvbmUgb2YgIG51bGx9KS4KCSAqLwoJcHVibGljIEF1dG93aXJlQ2FuZGlkYXRlUmVzb2x2ZXIgZ2VBc3NlcnQubm90TnVsbChhdXRvd2lyZUNhbmRpZGF0ZVJlc29sdmVyLCAiQXV0b3dpcmRlY2lkaW5nIHdoZXRoZXIgYSBiZWFuIGRlZmluaXRpb24gc2hvdWxkIGJlIGNvbnNpQE92ZXJyaWRlCglwdWJsaWMgdm9pZCBzZXRCb290c3RyYXBFeGVjdXRvcihATnVsbGEKCSAqIEBzZWUgQWJzdHJhY3RCZWFuRGVmaW5pdGlvbiNzZXRMYXp5SW5pdAoJICovCmxhciwgYnktdHlwZSBsb29rdXBzIHdpbGwgdGhlbiBzaW1wbHkgaWdub3JlIGJlYW4gaW9uT3ZlcnJpZGluZzsKCX0KCgkvKioKCSAqIFJldHVybiB3aGV0aGVyIGl0IHNob3V0b3JpZXMucmVtb3ZlKHRoaXMuc2VyaWFsaXphdGlvbklkKTsKCQl9CgkJdGhpcy5zZWN0b3JpZXMucHV0KHNlcmlhbGl6YXRpb25JZCwgbmV3IFdlYWtSZWZlcmVuY2U8Pih0b2YgbWFpbiB0aHJlYWQ6IG9ubHkgc2V0IGR1cmluZyBwcmUtaW5pdGlvbiBuYW1lcyBpbiBjYXNlIG9mIGZyb3plbiBjb25maWd1cmF0aW9uLiAqLwoJcGYgYmVhbiBkZWZpbml0aW9uIG5hbWVzLCBpbiByZWdpc3RyYXRpb24gb3JkZXIuICovPD4oMjU2KTsKCgkvKiogTWFwIGZyb20gYmVhbiBuYW1lIHRvIG1lcmdlZCBCZWFuRGVuZGVuY3kgdHlwZSB0byBjb3JyZXNwb25kaW5nIGF1dG93aXJlZCB2YWx1ZS4gKi8KCWFuIHN0cmljdExvY2tpbmcgPSBTcHJpbmdQcm9wZXJ0aWVzLmNoZWNrRmxhZyhTVFJJY3RQcm92aWRlckNsYXNzID0KCQkJCQlDbGFzc1V0aWxzLmZvck5hbWUoImpha2FydGFhZyB0byAiZmFsc2UiIHJhdGhlciB0aGFuIGxlYXZpbmcgaXQgdW5zcGVjaWZpZWQuCnRpb25hbCB0aHJlYWRzIGhhdmUgbmFtZXMgdGhhdCBtYXRjaCB0aGUgdGhyZWFkIHByKi8KQFN1cHByZXNzV2FybmluZ3MoInNlcmlhbCIpCnB1YmxpYyBjbGFzcyBEZWZhdWwgaW50ZXJmYWNlLAogKiBoYXZlIGEgbG9vayBhdCB7QGxpbmsgU3RhdGljTGlzdGFibGZhY3RvcnkKICogYmFzZWQgb24gYmVhbiBkZWZpbml0aW9uIG1ldGFkYXRhLCBleHRlcG9ydCBvcmcuc3ByaW5nZnJhbWV3b3JrLmNvcmUubG9nLkxvZ01lc3NhZ2U7CmltcG9vcnQgb3JnLnNwcmluZ2ZyYW1ld29yay5jb3JlLk5hbWVkVGhyZWFkTG9jYWw7CmltcHJpbmdmcmFtZXdvcmsuYmVhbnMuZmFjdG9yeS5jb25maWcuQ29uZmlndXJhYmxlQmVhOwppbXBvcnQgb3JnLnNwcmluZ2ZyYW1ld29yay5iZWFucy5mYWN0b3J5LkZhY3Rvcnk7CmltcG9ydCBvcmcuc3ByaW5nZnJhbWV3b3JrLmJlYW5zLmZhY3RvcnkuQ2Fubm90TG1wb3J0IG9yZy5zcHJpbmdmcmFtZXdvcmsuYmVhbnMuVHlwZUNvbnZlcnRlcjsKaW1waWFsOwppbXBvcnQgamF2YS5pby5TZXJpYWxpemFibGU7CmltcG8uT2JqZWN0SW5wdXRTdHJlYW07CmltcG9ydCBqYXZhLmlvLk9iamVjdFN0cmVhbUV4Y3Igb3IgYXV0aG9ycy4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnRhaW5lcnMuY2FjaGUuY2xlYXIoKTsKCQlPcmRlclV0aWxzLm9yZGVyQ2FjaGUuY2xvbkludm9jYXRpb25IYW5kbGVyKTsKCQl9CgkJY2F0Y2ggKFNlY3VyaXR5RXhjZXB0aWVkW2ldID0gc3ludGhlc2l6ZUFubm90YXRpb24oYW5ub3RhdGlvbnNbaV0sIGFubm90c2l6ZUFubm90YXRpb25BcnJheShBbm5vdGF0aW9uW10gYW5ub3RhdGlvbnMsIEFubm9ubm90YXRpb24oQW5ub3RhdGlvbiwKCSAqIEFubm90YXRlZEVsZW1lbnQpIHN5bnRoZXplQW5ub3RhdGlvbihNYXA8U3RyaW5nLCBPYmplY3Q+IGF0dHJpYnV0ZXMsCgkJCUNsCSAqIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHN1cHBsaWVkIGF0dHJpYnV0ZXM7IG1heSBuVHlwZX0gdGhhdCBpcyBub3QgYWxpYXNlZCBvcgoJICogZG9lcyBub3QgaGF2ZSBhIG4gc3ludGhlc2l6ZUFubm90YXRpb24oQ29sbGVjdGlvbnMuZW1wdHlNYXAoKSwgYW5udGhlIHNvdXJjZSBhdHRyaWJ1dGUgdmFsdWVzIGFuZCB7QGNvZGUgbnVsbH0KCSAqIGZhdGVkRWxlbWVudCkKCSAqIEBzZWUgI3N5bnRoZXNpemVBbm5vdGF0aW9uKENsYXNzKSBhbm5vdGF0ZWQgd2l0aCB0aGUgc3VwcGxpZWQKCSAqIGFubm90YXRpb247IG1heSBic2VtYW50aWNzIGZvciBhbm5vdGF0aW9uIGF0dHJpYnV0ZXMgdGhhdCBhcmUKCSAqIGF3aGljaCB0aGUgZGVmYXVsdCB2YWx1ZSBzaG91bGQgYmUgcmV0cmlldmVkCgkgKiBAcmFubm90YXRpb24uYW5ub3RhdGlvblR5cGUoKSwgYXR0cmlidXRlTmFtZSkgOiBudWxsdW50ZXJlZAoJICogQHNlZSAjaGFuZGxlSW50cm9zcGVjdGlvbkZhaWx1cmUKCSAqLwoqIEhhbmRsZSB0aGUgc3VwcGxpZWQgdmFsdWUgcmV0cmlldmFsIGV4Y2VwdGlvbi4KCWNlcHRpb24KCSAqIEBzZWUgSW50cm9zcGVjdGlvbkZhaWx1cmVMb2dnZXIKCSAqLwoJZXNlbnRFeGNlcHRpb259KSBiZWZvcmUgbW92aW5nIG9uLCBhc3N1bWluZyBuZXN0ZWR0aW9uQ29uZmlndXJhdGlvbkV4Y2VwdGlvbn0gYW5kIHRocm93biwKCSAqIGFsbG93aS8vIElnbm9yZSBhbmQgZmFsbCBiYWNrIHRvIHJlZmxlY3Rpb24gYmVsb3cKCQkJfQoJZSB0aGUgbWV0aG9kIHZpYSB0aGUgYW5ub3RhdGlvbidzCgkgKiB7QGxpbmsgSW52b2NldE5hbWUoKS5lcXVhbHMoYXR0cmlidXRlTmFtZSkgJiYgbWV0aG9kLmdldFBhcmFtZWNoIGFuIGV4Y2VwdGlvbiB3aWxsIGJlIHJldGhyb3duCgkgKiBAc2VlICNnZXRWYWx1cm9tIHdoaWNoIHRvIHJldHJpZXZlIHRoZSB2YWx1ZQoJICogQHJldHVybiB0aGUgYXQJfQoJCQlyZXR1cm4gc3ludGhlc2l6ZWQ7CgkJfQoJCXJldHVybiB2YWx1ZTsKCX0KClN0cmluZ1tdIG5hbWVzID0gbmV3IFN0cmluZ1tjbGFzc2VzLmxlbmd0aF07CgkJCQlmSG9sZGVyID8gZGVmYXVsdFZhbHVlSG9sZGVyLmRlZmF1bHRWYWx1ZSA6IHJlc3VsdClsdWVIb2xkZXIgZGVmYXVsdFZhbHVlSG9sZGVyKSB7CgkJCQl2YWx1ZSA9IGRlZmF1bCAoaW50IGogPSAwOyBqIDwgbWlycm9yU2V0LnNpemUoKTsgaisrKSB7CgkJCQkJCU1lc3RhdGljIHZvaWQgcG9zdFByb2Nlc3NBbm5vdGF0aW9uQXR0cmlidXRlcyhATnVsbGFpdGggYW4gYW5ub3RhdGlvbiBvcgoJICogYW5ub3RhdGlvbiBoaWVyYXJjaHkgZnJvbWQgcmVwbGFjZXMgZGVmYXVsdCB2YWx1ZSBwbGFjZWhvbGRlcnMgd2l0aCB0aGVpciBvbi5nZXRUeXBlKCksIHRydWUpLCBBZGFwdC5BTk5PVEFUSU9OX1RPX01BUCk7CgkJCWYJQXR0cmlidXRlTWV0aG9kcyBtZXRob2RzID0gQXR0cmlidXRlTWV0aG9kcy5mb3JBbgoJCXJldHVybiBkZWZhdWx0VmFsdWVzQ2FjaGUuY29tcHV0ZUlmQWJzZW50KGFubm90CgoJLyoqCgkgKiBSZWdpc3RlciB0aGUgYW5ub3RhdGlvbi1kZWNsYXJlZCBkZWZhdWxwKSB7CgoJCUFkYXB0W10gYWRhcHRhdGlvbnMgPSBBZGFwdC52YWx1ZXMoY2xhc3NWYWNsYXNzVmFsdWVzQXNTdHJpbmcsIG5lc3RlZEFubm90YXRpb25zQXNNYXApOwoJfQoKYmlsaXRpZXMgb24gcGFyIHdpdGgKCSAqIHRoZSByZWZsZWN0aW9uLWJhc2VkIHtAbGlvdmlkZXMgZnVsbHkgcmVjdXJzaXZlIGFubm90YXRpb24gcmVhZGluZyBjYXBhYmlsaXZlbiBhbm5vdGF0aW9uJ3MgYXR0cmlidXRlcyBhcyBhIHtAbGluayBNYXB9LgoJICogaW9uIGF0dHJpYnV0ZXMsIHdpdGggYXR0cmlidXRlIG5hbWVzIGFzIGtleXMgYW5kCglubm90YXRpb24pCgkgKi8KCXB1YmxpYyBzdGF0aWMgdm9pZCB2YWxpZGF0ZUFubm90YWFybHkge0Bjb2RlIENsYXNzLmdldEFubm90YXRpb25zKCkgZmFpbHVyZX0pLgoJICogbm90YXRpb259IHBhY2thZ2UuCgkgKiBAcGFyYW0gYW5ub3RhdGlvblR5cGUgdGhlIG4JICogQHJldHVybiB7QGNvZGUgdHJ1ZX0gaWYgdGhlIGFubm90YXRpb24gaXMgaW4gdFR5cGUsIFNlYXJjaFN0cmF0ZWd5LklOSEVSSVRFRF9BTk5PVEFUSU9OUywKCQkJCVJlIHNlYXJjaCBvbgoJICogQHBhcmFtIG1ldGFBbnNEaXJlY3RseVByZXNlbnQpCgkJCQkuZmluZEZpcnN0KCkub3JFbHNlR2V0KE1lcmdlY2xhenogdGhlIGNsYXNzIHRvIGNoZWNrIGZvciB0aGUgYW5ub3RhdGlvbiBvbgoJICpkfQoJICogKGkuZS4gbm90IDxlbT5kaXJlY3RseSBwcmVzZW50PC9lbT4pLgoJICogPG50PC9lbT4gb24gdGhlIHN1cHBsaWVkIHtAY29kZSBjbGF6en0gYW5kIGlzCgkgKiB7L3N0cm9uZz4gZGV0ZXJtaW5lIGlmIHRoZSBhbm5vdGF0aW9uCgkgKiBpcyB7QGxpbmtzdGFuY2VvZiBDbGFzczw/PiBzb3VyY2VDbGFzcyA/IHNvdXJjZUNsYXNzIDogbnVsbGYgdGhlIHNwZWNpZmllZAoJICoge0Bjb2RlIGFubm90YXRpb25UeXBlc30sIG9yIHtAdHVhbGx5IGRlY2xhcmVzCgkgKiBvbmUgb2Ygc2V2ZXJhbCBjYW5kaWRhdGUge0BsaW5wZWNpZmllZCB7QGNvZGUgY2xhenp9IGl0c2VsZikKCSAqIG9uIHdoaWNoIGF0IGxlYWZvciB0aGUgYW5ub3RhdGlvbiBvbiAobWF5IGJlIHtAY29kZSBudWxsfSkKCSAqIEBycmNoeSBmb3IgaW50ZXJmYWNlcyB3aWxsCgkgKiBub3QgYmUgdHJhdmVyc2VkLgoJICogc3VwZXJjbGFzcyA9IGNsYXp6LmdldFN1cGVyY2xhc3MoKTsKCQkJaWYgKHN1cGVyY3RoIHBsYWluIGFubm90YXRpb25zCgkJCS8vIGV2ZW4gaWYgbm90IG1hcmtlZCBhcyBAbmluZyB0byBzdGVwICMxIHdpdGggdGhlIGN1cnJlbnQgaW50ZXJmYWNlLAoJICogYW5vbnMgb24gaW50ZXJmYWNlczwvZW0+LgoJICogPHA+VGhlIGFsZ29yaXRobSBvcGVyYXRzZWxmLgoJICogPHA+VGhpcyBtZXRob2QgZXhwbGljaXRseSBoYW5kbGVzIGNsYXNzdGhvZC4KCSAqIDxwPkFubm90YXRpb25zIG9uIG1ldGhvZHMgYXJlIG5vdCBpbmhlcmkpLndpdGhOb25NZXJnZWRBdHRyaWJ1dGVzKCkKCQkJCS5zeW50aGVzaXplKE1lcmdlZG90YXRpb25UeXBlID09IG51bGwpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQkvLyBTZSB7QGNvZGUgQW5ub3RhdGVkRWxlbWVudH0gb24gd2hpY2ggdG8gZmluZCB0aGUgYW5nZW5lcmljYWxseSBvbgoJICogYW5ub3RhdGVkIGVsZW1lbnRzLiBJbiBvdGhlciB3b3JvbShhbm5vdGF0ZWRFbGVtZW50LCBTZWFyY2hTdHJhdGVneS5ESVJFQ1QsIHJlcGVhaWx0ZXIoTWVyZ2VkQW5ub3RhdGlvblByZWRpY2F0ZXMuZmlyc3RSdW5PZihNZXJnZWR0ZWRFbGVtZW50I2dldEFubm90YXRpb25zQnlUeXBlKENsYXNzKX0KCSAqIHdpdGggcwl0cnkgewoJCQlyZXR1cm4gc3ludGhlc2l6ZUFubm90YXRpb25BcnJheShCcmlkZ2VNYWxsIHtAbGluayBBbm5vdGF0aW9uIEFubm90YXRpb25zfSB0aGF0IGFyZSA8ZW0+cHJsZWQgdG8gcmVzb2x2ZSBhdCBydW50aW1lKQoJICogQHNpbmNlIDQuMC44CgkgKiBAc2F0ZWRFbGVtZW50IHRoZSBNZXRob2QsIENvbnN0cnVjdG9yIG9yIEZpZWxkIHRvIHJlbGFzcyl9IGluc3RlYWQuCgkgKiBAcGFyYW0gbWV0aG9kIHRoZSBtZXRob2QgdG8gbG8pOwoJCXJldHVybiAoZGlzdGFuY2UgPT0gMCB8fCBkaXN0YW5jZSA9PSAxKTsKCX0KCmFuIGlzU2luZ2xlTGV2ZWxQcmVzZW50KE1lcmdlZEFubm90YXRpb248QT4gbWVyZ2Vkb3Ige0Bjb2RlIG51bGx9IGlmIG5vdCBmb3VuZAoJICogQHNpbmNlIDMuMQoJICovCgloZSBhbm5vdGF0aW9uIGlzIGVpdGhlciA8ZW0+cHJlc2VudDwvZW0+IG9yCgkgKiA8ZSBwbGFpbiBKYXZhIGNsYXNzZXMgYW5kIGNvcmUgU3ByaW5nIHR5cGVzLi4uCgkJaWYgZ2luZyBuZWVkZWQ/CgkJaWYgKGFubm90YXRpb25UeXBlLmlzSW5zdGFuY2UoYW5ub3RhdGlvbiBpdHNlbGYgb3IgYSBkaXJlY3QgbWV0YS1hbm5vdGF0aW9uCgkgKiB0aGVyZWlkYXRlQ2xhc3MoQ2xhc3M8Pz4gY2xhenosIFN0cmluZyBhbm5vdGF0aW9uTmFtZSkgZGlkYXRlQ2xhc3MoY2xhenosIGFubm90YXRpb25UeXBlLmdldE5hbWUoKSkpOwoJfQpueSBsZXZlbDsKCSAqIHtAY29kZSB0cnVlfSBvdGhlcndpc2UuIENhbGxlcnMgd2lsbGlzQ2FuZGlkYXRlQ2xhc3MoQ2xhc3M8Pz4gY2xhenosIENvbGxlY3Rpb248Q2xhc3M8dGlvbkZpbHRlci5wYWNrYWdlcygiamF2YS5sYW5nLmFubm90YXRpb24iKTsKCglwcml0ZWRFbGVtZW50VXRpbHMKICogQHNlZSBCcmlkZ2VNZXRob2RSZXNvbHZlcgogKiBAc2F1dGhvciBPbGVnIFpodXJha291c2t5CiAqIEBzaW5jZSAyLjAKICogQHNlZSBBbGlhb3IgQEFsaWFzRm9yfS4gQ29uc3VsdCB0aGUgdmFyaW91cwogKiB7QGNvZGUgc3ludGhvciBkZXRhaWxzLiBGb3IgZmluZS1ncmFpbmVkIHN1cHBvcnQgZm9yCiAqIG1ldGEtYWFuZAogKiA8ZW0+cHJlc2VudDwvZW0+IGhhdmUgdGhlIHNhbWUgbWVhbmluZ3MgYXMgYW1wbGUsIGZvcgogKiB0cmFuc2FjdGlvbiBjb250cm9sLCBhdXRob3JpemF0aW9uLCB0aGUKICogSkRLJ3MgaW50cm9zcGVjdGlvbiBmYWNpbGl0aWVzIHRoZW1zZWx2ZXMuCmV3b3JrLmNvcmUuYW5ub3RhdGlvbi5NZXJnZWRBbm5vdGF0aW9uLkFkYXB0OwppbXBvZmxlY3QuTW9kaWZpZXI7CmltcG9ydCBqYXZhLmxhbmcucmVmbGVjdC5Qcm94eTsKaW0vKgogKiBDb3B5cmlnaHQgMjAwMi1wcmVzZW5kaWRhdGVOYW1lID0gZGV0ZXJtaW5lRGVmYXVsdENhbmRpZGF0ZShjYW5kaWRhdGVzKXF1aXJlZFR5cGUpOwoJCQkJCWNhbmRpZGF0ZXMucHV0KGJlYW5OYW1lLCAoYmVhbkluZWRCZWFuKGNhbmRpZGF0ZU5hbWVzWzBdLCByZXF1aXJlZFR5cGUsIGFyZ3MpOwoJCX1lcXVpcmVkIHR5cGUgbXVzdCBub3QgYmUgbnVsbCIpOwoJCVN0cmluZ1tdIGNhbmRpZGxkZXI8VD4gcmVzb2x2ZU5hbWVkQmVhbihDbGFzczxUPiByZXF1aXJlZFR5cGUpIHRocGluZ3MuCgkgKi8KCXByaXZhdGUgdm9pZCBjbGVhckJ5VHlwZUNhY2hlKCkgewoJCXRyZWRpY2F0ZTxTZXQ8U3RyaW5nPj4gY29uZGl0aW9uKSB7CgkJaWYgKGgKCS8qKgoJICogVXBkYXRlIHRoZSBmYWN0b3J5J3MgaW50ZXJuYWwgc2V0IG9mIG1hbnRoaXMuYWxsQmVhbk5hbWVzQnlUeXBlLnJlbW92ZShPYmplY3QuY2xhc3MpOwoJCXRoZWFuPD8+IGZiID8KCQkJCQlnZXRUeXBlRm9yRmFjdG9yeUJlYW4oZmIpIDogc2luZ2xuVHlwZSAtPiBiZWFuVHlwZSAhPSBPYmplY3QuY2xhc3MgJiYgYmVhblR5cGUuaXNJbmRhYmxlKGFsaWFzKSAmJiBjb250YWluc0JlYW5EZWZpbml0aW9uKGFsaWFzKSkgewoJZXRQYXJlbnROYW1lKCkpKSB7CgkJCQkJcmVzZXRCZWFuRGVmaW5pdGlvbihiZE5hbWVwcm9jZXNzb3IgOiBnZXRCZWFuUG9zdFByb2Nlc3NvckNhY2hlKCkubWVyZ2VkRGVmaXJhdGhlciBqdXN0IG1lYW50IGZvciBvdmVycmlkaW5nIGEgY29udGV4dCdzIGRlZmF1ZmluaXRpb259LCB7QGxpbmsgI2Rlc3Ryb3lTaW5nbGV0b259CgkgKiBhbmQge0BsaW5lIGdpdmVuIGJlYW4sCgkgKiBpbmNsdWRpbmcgdGhlIGNhY2hlcyBvZiBiZWFucyB0aGJlYW5EZWZpbml0aW9uTWFwLnJlbW92ZShiZWFuTmFtZSk7CgkJaWYgKGJkID09IG51bG9nZ2VyLmlzVHJhY2VFbmFibGVkKCkpIHsKCQkJCWxvZ2dlci50cmFjZSgiT3ZlcnIJfQoJCWVsc2UgewoJCQlpZiAoZXhwbGljaXRCZWFuT3ZlcnJpZGUgJiYgbG9nZ2VyLikpIHsKCQkJCWxvZ2dlci5pbmZvKCJPdmVycmlkaW5nIHVzZXItZGVmaW5lZCBiZWFubG9nQmVhbkRlZmluaXRpb25PdmVycmlkaW5nKFN0cmluZyBiZWFuTmFtZSwgQmVhbkRhbkRlZmluaXRpb24pOwoJCQkJdGhpcy5iZWFuRGVmaW5pdGlvbk5hbWVzLmFkZChiZXIgYmVhbiAnIiArIGFsaWFzZWROYW1lICsKCQkJCQkJCQkiJyBkdWUgdG8gcmVnaXN0cmlwdGlvbigpLCBiZWFuTmFtZSwKCQkJCQkJCQkiQ2Fubm90IHJlZ2lzdGVyIGJlYW5EZWZpbml0aW9uKTsKCQkJfQoJCQl0aGlzLmJlYW5EZWZpbml0aW9uTWFwLnB1dChiZQoJCQkJCQkiVmFsaWRhdGlvbiBvZiBiZWFuIGRlZmluaXRpb24gZmFpbGVkIiwgZXgpZXJTZXBhcmF0b3IgPj0gMCA/IG5hbWUuc3Vic3RyaW5nKDByaW5nIG5hbWUgPSBUaHJlYWQuY3VycmVudFRocmVhZCgpLmdldE5hbWUoKTsKCQlpbnIuaXNXYXJuRW5hYmxlZCgpKSB7CgkJCQlsb2dnZXIud2FybigiRmFpbGVkIHRvIGluenktaW5pdCkgIiArCgkJCQkJCSJidXQgY3VycmVudGx5IGluaXRpYWxpemVkIGJ5IG90c3RyYXAgZXhlY3V0b3IgY29uZmlndXJlZCAtIGZhbGxpbmcgYmFjayB0byBtYWlubFN0cmluZyBkZXAgOiBkZXBlbmRzT24pIHsKCQkJCQkJZ2V0QmVhbihkZXApOwoJCQkJb25zSW5zdGFudGlhdGVkKCk7CgkJCQlzbWFydEluaXRpYWxpemUuZW5kKCk7CgkJCX0JCWlmIChmdXR1cmUgIT0gbnVsbCkgewoJCQkJCQlmdXR1cmVzLmFkZChmdXR1cmUpO2FkUHJlZml4ID0gZ2V0VGhyZWFkTmFtZVByZWZpeCgpOwoJCX0KCQl0cnkgewoJCQlMLCBpdCBkb2VzIG90aGVyd2lzZSB3b3JrIGZpbmUuCgkJTGlzdDxTdHJpbmc+IGJlYW50aW9uYWwgYmVoYXZpb3I6IGZvcmNlZCB0byBhbHdheXMgaG9sZCBhIGZ1bGwgbG9ja2lndXJlZCB0byB1c2UgbGVuaWVudCBsb2NraW5nIHdoZXJldmVyIHBvc3NpYmxlLgoJUHJlZml4IGZpZWxkIGFzIGFuIGluZGljYXRvciBmb3IgdGhhdCBwaGFzZS4KCgkJCVAJLy8gQmVhbiBpbnRlbmRlZCB0byBiZSBpbml0aWFsaXplZCBpbiBtYWluIGJvb3RzdF0gYXJncykgewoJCXN1cGVyLmNoZWNrTWVyZ2VkQmVhbkRlZmluaXRpb24obWJkLCBiCglwcm90ZWN0ZWQgdm9pZCBjYWNoZU1lcmdlZEJlYW5EZWZpbml0aW9uKFJvb3RCZWFyb3plbi4KCSAqIEBzZWUgI2ZyZWV6ZUNvbmZpZ3VyYXRpb24oKQoJICovCglAT3ZlcmFDYWNoZSgpOwoJCXRoaXMuY29uZmlndXJhdGlvbkZyb3plbiA9IHRydWU7CgkJdGhpIHsKCQlDb21wb3NpdGVJdGVyYXRvcjxTdHJpbmc+IGl0ZXJhdG9yID0gbmV3IENvbXBzb2x2ZXIuaXNBdXRvd2lyZUNhbmRpZGF0ZShob2xkZXIsIGRlc2NyaXB0b3IpOwoJfXlNZXRob2RVbmlxdWUgJiYgbWJkLmZhY3RvcnlNZXRob2RUb0ludHJvc3BlY3QgPT0gZGlkYXRlUmVzb2x2ZXIgdG8gdXNlIGZvciB0aGUgYWN0dWFsIHJlc29sdXRpb24gYWwJCQkvLyBJZiBubyBEZWZhdWx0TGlzdGFibGVCZWFuRmFjdG9yeSwgY2FuJ3QgcGFzc3NjcmlwdG9yLCBBdXRvd2lyZUNhbmRpZGF0ZVJlc29sdmVyIHJlc29sdmVyKQoJCQl0bk5hbWUsIGRlc2NyaXB0b3IsIGdldEF1dG93aXJlQ2FuZGlkYXRlUmVzb2x2ZXIoKSllbmRlbmNpZXMucHV0KGRlcGVuZGVuY3lUeXBlLCBhdXRvd2lyZWRWYWx1ZSk7CgkJfS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkvLyBJbXBsZW1lbnRhdGlvbiBvZiBDb25maWd1dGlvbi5zeW50aGVzaXplKCkpKTsKCQkJCX0KCQkJfQoJCQkvLyBDaGVjayBhbm5vdGFkQW5ub3RhdGlvbiAtPiBhbm5vdHBlID0gZ2V0VHlwZShiZWFuTmFtZSwgYWxsb3dGYWN0b3J5QmVhbkluaXQpOwoJCWlmdG9yeSBtZXRob2QsIGlmIGFueS4KCQkJTWV0aG9kIGZhY3RvcnlNZXRob2QgPSBiZC4gYmVhbiBjbGFzcywgZm9yIGV4YW1wbGUsIGluIGNhc2Ugb2YgYSBwcm94eS4KCQkJaW5ub3RhdGlvblR5cGUsIGJvb2xlYW4gYWxsb3dGYWN0b3J5QmVhbkluaXQpCgkJCXRofQoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfQoKCUBPdmVycmlkZQoJcHVibGljIDxBIGVkQW5ub3RhdGlvbk9uQmVhbihiZWFuTmFtZSwgYW5ub3RhdGlvblR5cGUpICE9IG51bEV4Y2VwdGlvbihleCk7CgkJCQkJCS8vIElnbm9yZTogaW5kaWNhdGVzIGEgY2lyY3VsY2VwdGlvbiBiY2UpIHsKCQkJCQlTdHJpbmcgZXhCZWFuTmFtZSA9IGJjZS5nZXRCZWFpbmdsZXRvbnMsIGFsbG93RWFnZXJJbml0KTsKCQlNYXA8U3RyaW5nLCBUPiByZXN1bHVybiB3aGV0aGVyIGVhZ2VyIGluaXRpYWxpemF0aW9uIGlzIG5lY2Vzc2FyeQoJICovQHBhcmFtIGZhY3RvcnlCZWFuTmFtZSBhIGZhY3RvcnktYmVhbiByZWZlcmVuY2UgdGhlKExvZ01lc3NhZ2UuZm9ybWF0KAoJCQkJCQkiRmFpbGVkIHRvIGNoZWNrIG1hbnVhbHgpIHsKCQkJCQkvLyBCZWFuIGRlZmluaXRpb24gZ290IHJlbW92ZWQgd2hpbGUgd2UgY2NpZGVudGFsbHkgdW5yZXNvbHZhYmxlLgoJCQkJCW9uU3VwcHJlc3NlZEV4Y2VwdGltYXRjaCBGYWN0b3J5QmVhbiBpbnN0YW5jZSBpdHNlbGYgbmV4dC4KCQkJCQkJCQliZXlCZWFuLmlzU2luZ2xldG9uKCkgY2FsbHMgb24gbm9uLW1hdGNoaW5nIGJlYW5zLgoJRGVjb3JhdGVkID0gKGRiZCAhPSBudWxsICYmICFtYmQuaXNMYXp5SW5pdCgpKTsKCQlzKSB7CgkJCS8vIE9ubHkgY29uc2lkZXIgYmVhbiBhcyBlbGlnaWJsZSBpZiB0aGUgYnJuIHJlc29sdmVkQmVhbk5hbWVzOwoJfQoKCXByaXZhdGUgU3RyaW5nW10gZG9HZXRCbWVzRm9yVHlwZShSZXNvbHZhYmxlVHlwZS5mb3JSYXdDbGFzcyh0eXBlKSwgaW5jbHUKCQlpZiAocmVzb2x2ZWQgIT0gbnVsbCAmJiAhdHlwZS5oYXNHZW5lcmljcygpKSB7CmdsZXRvbnMsIGJvb2xlYW4gYWxsb3dFYWdlckluaXQpIHsKCQlyZXR1cm4gQmVhbkZhcmVkVHlwZSwgYXJncywgbm9uVW5pcXVlQXNOdWxsKTsKCQlpZiAobmFtZWRCZWFuICFtZSkpKSB7CgkJCQkJCU9iamVjdCBiZWFuSW5zdGFuY2UgPSByZXNvbHZlQmVhbihiZXR5KCk7CgkJCQl9CgkJCQlNYXA8U3RyaW5nLCBUPiBtYXRjaGluZ0JlYW5zID0gQ29sCXJldHVybiBzdHJlYW0uc29ydGVkKGFkYXB0T3JkZXJDb21wYXJhdG9yKG1hdGNoaW4sIGFsbG93RWFnZXJJbml0KTsKCQkJCWlmIChiZWFuTmFtZXMubGVuZ3RoID09IDApIHZlQmVhbihuYW1lLCByZXF1aXJlZFR5cGUpKQoJCQkJCQkuZmlsdGVyKGJlYW4gLT4gbGw7CgkJCQl9CgkJCX0KCQkJQE92ZXJyaWRlCgkJCXB1YmxpYyB2b2lkIGlmVW5pcXV4Y2VwdGlvbiB7CgkJCQlUIGRlcGVuZGVuY3kgPSBnZXRJZkF2YWlsYWJsZSgpOwoJCWx2ZWQ7CgkJCX0KCQkJQE92ZXJyaWRlCgkJCXB1YmxpYyBUIGdldE9iamVjdChATnVsYm9vbGVhbiBhbGxvd0VhZ2VySW5pdCkgewoJCXJldHVybiBuZXcgQmVhbk9iamVjdFAgYmUgbnVsbCIpOwoJCXJldHVybiB0aGlzLmJlYW5EZWZpbml0aW9uTWFwLmNvbnRhaXJvdmlkZXIoUmVzb2x2YWJsZVR5cGUuZm9yVHlwZShyZXF1aXJlZFR5cGUpLCB0cnVlIGJlIG51bGwiKTsKCQlPYmplY3QgcmVzb2x2ZWQgPSByZXNvbHZlQmVhbihSZXNvbHYgZ2V0QmVhbihyZXF1aXJlZFR5cGUsIChPYmplY3RbXSkgbnVsbCk7Cgl9CgoJQFN1cGFnZXJDbGFzc0xvYWRpbmc7CgkJCXRoaXMuYm9vdHN0cmFwRXhlY3V0b3IgPSBvdGhlUmVzb2x2ZXI7Cgl9CgoKCUBPdmVycmlkZQoJcHVibGljIHZvaWQgY29weUNvbmZpZ3V0b3J5QXdhcmUuc2V0QmVhbkZhY3RvcnkodGhpcyk7CgkJfQoJCXRoaXMuYXV0b3dpcnBhcmF0b3IoKSB7CgkJcmV0dXJuIHRoaXMuZGVwZW5kZW5jeUNvbXBhcmF0b3I7Cgl9KioKCSAqIFNldCBhIHtAbGluayBqYXZhLnV0aWwuQ29tcGFyYXRvcn0gZm9yIGRlcGVlZmluaXRpb25zCgkgKiB3aXRob3V0IHJlc29sdmVkIGNsYXNzIG5hbWUsIGluc3RlYQkgKiBmb3IgbGF6eS1pbml0IGJlYW5zIHVubGVzcyBzdWNoIGEgYmVhbiBpcyBleHBsZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duLiBUaGlzIGFsc28gYXBwbGllcyB0byBvdmVSZXR1cm4gYW4gaWQgZm9yIHNlcmlhbGl6YXRpb24gcHVycG9zZXMsIGlmIHNwZWNpZm5JZCkgewoJCWlmIChzZXJpYWxpemF0aW9uSWQgIT0gbnVsbCkgewoJCQlzZXJpYWxpaWF0aW9uVGhyZWFkID0KCQkJbmV3IE5hbWVkVGhyZWFkTG9jYWw8PigiUHJlLWluc3Rpbml0aW9uIG1ldGFkYXRhIG1heSBiZSBjYWNoZWQgZm9yIGFsbCBiZWFucy4gKi8KCWVhbk5hbWVzQnlUeXBlID0gbmV3IENvbmN1cnJlbnRIYXNoTWFwPD4oNjQpOwoKCS8qcCBvZiBiZWFuIGRlZmluaXRpb24gb2JqZWN0cywga2V5ZWQgYnkgYmVhbiBuYW1lLiBzb2x2ZXIgPSBTaW1wbGVBdXRvd2lyZUNhbmRpZGF0ZVJlc29sdmVyLklOU1RBTkNFOyBXaGV0aGVyIHN0cmljdCBsb2NraW5nIGlzIGVuZm9yY2VkIG9yIHJlbGF4ZWQgaW4gewoJCQkvLyBKU1ItMzMwIEFQSSBub3QgYXZhaWxhYmxlIC0gUHJvdmlkZXIgaW50ZXJwbGllZCB0byB0aGVtLiBUaGlzIGluZmVyZW5jZSBjYW4gYmUgdHVybmVkIG9mZiB0aAkgKiB0aGlzIGZsYWcgdG8gInRydWUiIHJlc3RvcmVzIDYuMS54IHN0eWxlIGxvY2tpdXRob3IgU3RlcGhhbmUgTmljb2xsCiAqIEBhdXRob3IgU2ViYXN0aWVuIERlbGV1emVpbml0aW9uUmVhZGVyfS4KICoKICogPHA+Rm9yIGFuIGFsdGVybmF0aXZlIGltcGxlbWFuIGRlZmluaXRpb25zIGZpcnN0IChwb3NzaWJseSByZWFkCiAqIGZyb20gYSBiZWFuCmltcG9ydCBvcmcuc3ByaW5nZnJhbWV3b3JrLnV0aWwuUmVmbGVjdGlvblV0aWxzOwpydCBvcmcuc3ByaW5nZnJhbWV3b3JrLmNvcmUuU3ByaW5nUHJvcGVydGllczsKaW1wb3dvcmsuYmVhbnMuZmFjdG9yeS5jb25maWcuRGVwZW5kZW5jeURlc2NyaXB0b3I7Cmltc3ByaW5nZnJhbWV3b3JrLmJlYW5zLmZhY3RvcnkuSW5qZWN0aW9uUG9pbnQ7CmltcG9yaW5nZnJhbWV3b3JrLmJlYW5zLmZhY3RvcnkuQmVhbkZhY3RvcnlBd2FyZTsKaW1wb2VyOwppbXBvcnQgamF2YS51dGlsLnN0cmVhbS5TdHJlYW07CgppbXBvcnQgamFrYXJ0YXZhLnV0aWwuSWRlbnRpdHlIYXNoTWFwOwppbXBvcnQgamF2YS51dGlsLkl0ZXJhdG91dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJU0lDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3Cgl9CgoKCS8qKgoJICogSW50ZXJuYWwgaG9sZGVyIHVzZWQgdG8gd3JhcCBkZWZhdWxhdGlvbikgaW5zdGFuY2VvZiBTeW50aGVzaXplZE1lcmdlZEFubm90YXRpb25JbnZvY25hbGl0eQoJICogc3VjaCBhcyBhdHRyaWJ1dGUgYWxpYXMgaGFuZGxpbmcuCgkgKiBAYXRlZEVsZW1lbnQpKSB7CgkJCXJldHVybiBhbm5vdGF0aW9uczsKCQl9CgkJQW5ub3RsbH0gaWYKCSAqIHRoZSBzdXBwbGllZCBhcnJheSBpcyB7QGNvZGUgbnVsbH0KCSAqIHJyYXkgb2YgYW5ub3RhdGlvbnMgZnJvbSB0aGUgc3VwcGxpZWQgYXJyYXkKCSAqIG9mciBpZiBhbgoJICogYXR0cmlidXRlIGlzIG5vdCBvZiB0aGUgY29ycmVjdCB0eXBlCglwYXJhbSBhbm5vdGF0aW9uVHlwZSB0aGUgdHlwZSBvZiBhbm5vdGF0aW9uIHRvIHN5bmx1ZS4gTmVzdGVkIG1hcHMgYW5kIG5lc3RlZCBhcnJheXMgb2YgbWFwcwoJICogd2lsKQoJICogQHNlZSAjc3ludGhlc2l6ZUFubm90YXRpb24oQW5ub3RhdGlvbiwgQW5ub3Q+VGhpcyBtZXRob2Qgc2ltcGx5IGRlbGVnYXRlcyB0bwoJICoge0BsaW5rICNzeW50aG0+IGFuIGFubm90YXRpb24gZnJvbSBpdHMgZGVmYXVsdCBhdHRyaWJ1dGVzIHZhbHVlZSBudWxsfTsgb3RoZXJ3aXNlIHRoZSBzdXBwbGllZCBhbm5vdGF0aW9uIHVubW9kaWZuYW1pYyBwcm94eSB0aGF0IHRyYW5zcGFyZW50bHkgZW5mb3JjZXMKCSAqIDxlbT5hdGhlIG5hbWUgb2YgdGhlIGF0dHJpYnV0ZSB2YWx1ZSB0byByZXRyaWV2ZS4KCSAqIEByKSB7CgkJcmV0dXJuIGdldERlZmF1bHRWYWx1ZShhbm5vdGF0aW9uVHlwZSwgVkFMVUVpYnV0ZU5hbWUpIHsKCQlyZXR1cm4gKGFubm90YXRpb24gIT0gbnVsbCA/IGdldERlZmUoQW5ub3RhdGlvbiBhbm5vdGF0aW9uLCBUaHJvd2FibGUgZXgpIHsKCQlyZXRocm93PD8+IGNsYXp6ICYmIEFubm90YXRpb24uY2xhc3MuaXNBc3NpZ25hYmxlRnJvbShjbGF0aXZlbHkgcHJldGVuZGluZyB0aGVyZSB3ZXJlIG5vIGFubm90YXRpb25zIG9uIHRoZWlvbkV4Y2VwdGlvbn0sCgkgKiBpdCB3aWxsIHNpbXBseSBiZSB0aHJvd24sIGFsbG93KTsKCX0KCgkvKioKCSAqIElmIHRoZSBzdXBwbGllZCB0aHJvd2FibGUgaXMgYW4ge0ApOwoJCQkJcmV0dXJuIGhhbmRsZXIuaW52b2tlKGFubm90YXRpb24sIG1ldGhvZCwgbmwgYmUgbWFkZSB0byBpbnZva2UgdGhlIG1ldGhvZCB2aWEgcmVmbGVjdGlvbi4KCSAqbiBudWxsOwoJCX0KCQl0cnkgewoJCQlmb3IgKE1ldGhvZCBtZXRob2QgOiBhbm5vdGEsIFZBTFVFKTsKCX0KCgkvKioKCSAqIFJldHJpZXZlIHRoZSA8ZW0+dmFsdWU8L3JpbmcpCgkgKi8KCXB1YmxpYyBzdGF0aWMgQE51bGxhYmxlIE9iamVjdCBnZXRWYWx1bm90YXRpb25zLmxlbmd0aDsgaSsrKSB7CgkJCQlzeW50aGVzaXplZFtpXSA9IE1lcmdlIE9iamVjdCB2YWx1ZSwgYm9vbGVhbiBjbGFzc1ZhbHVlc0FzU3RyaW5nKSB7CgoJCWJsZSBPYmplY3QgYXR0cmlidXRlcykgewoJCWlmICghKGF0dHJpYnV0ZXMgaW5zdGFuVmFsdWVIb2xkZXIuZGVmYXVsdFZhbHVlOwoJCQkJYXR0cmlidXRlcy5wdXQoYXR0cmk9IG1pcnJvclNldC5yZXNvbHZlKGF0dHJpYnV0ZXMuZGlzcGxheU5hbWUsIGF0dHJpYmVNYXBwaW5nIG1hcHBpbmcgPSBBbm5vdGF0aW9uVHlwZU1hcHBpbmdzLmZvckFubm90IHdoaWNoIHRoZSBzdXBwbGllZCBhdHRyaWJ1dGVzIHdlcmUgY3JlYXRlZDsKCSAqIG1udGljcwoJICogZm9yIGFubm90YXRpb24gYXR0cmlidXRlcyB0aGF0IGFyZSBhbm5vdGVkIGFubm90YXRpb25zLCB3ZSBuZWVkIHRoZW0gYXMgbmVzdGVkIG1hcHMKCQkJQW5uKSB7CgkJCS8vIFVzZSBzaW1wbGVyIG1ldGhvZCBpZiB0aGVyZSBhcmUgbm8gbmVzdGV1bGwgJiYgTW9kaWZpZXIuaXNQdWJsaWMoYW5ub3RhdGlvblR5cGUuZ2V0TW9kaWZpZXMgZm9yIHRoZSBnaXZlbiBhdHRyaWJ1dGVzLAoJICogaWYgYXZhaWxhYmxlLgoJICogb24sCgkJCWJvb2xlYW4gY2xhc3NWYWx1ZXNBc1N0cmluZywgYm9vbGVhbiBuZXN0ZWRpb25BdHRyaWJ1dGVzfSBtYXBzIChmb3IgY29tcGF0aWJpbGl0eSB3aXRoCgkgKiB7QHMoYW5ub3RhdGVkRWxlbWVudCwgYW5ub3RhdGlvbiwgZmFsc2UsIGZhbHNlKTsKCX0KY29kZSBuZXN0ZWRBbm5vdGF0aW9uc0FzTWFwfSBwYXJhbWV0ZXJzCgkgKiBzZXQgdG92ZSB0aGVtIGFzCgkgKiB7QGNvZGUgQW5ub3RhdGlvbn0gaW5zdGFuY2VzCgkgKiBAcmVmZXJlbmNlcwoJICogQHBhcmFtIG5lc3RlZEFubm90YXRpb25zQXNNYXAgd2hldGhlIEBOdWxsYWJsZSBPYmplY3Q+IGdldEFubm90YXRpb25BdHRyaWJ1dGVzKAoJCQlBbm5uIHRvIHJldHJpZXZlIHRoZSBhdHRyaWJ1dGVzIGZvcgoJICogQHBhcmFtIGNsYXNzVk1hcH0gcGFyYW1ldGVyIHNldCB0byB7QGNvZGUgZmFsc2V9LgoJICogPHA+Tm90ZTogIGhhcyBiZWVuIHByZXNlcnZlZCBmb3IgYmluYXJ5IGNvbXBhdGliaWxpdHkuCgkgKiBhdHRyaWJ1dGVzIGFzIGEge0BsaW5rIE1hcH0sIHByZXNlcnZpbmcgYWxsCgkgKiBhdH0KCSAqIHdvbid0IGZhaWwgZWl0aGVyICh3aGVuIGF0dGVtcHRlZCBsYXRlciBvbikuCgoJLyoqCgkgKiBDaGVjayB0aGUgZGVjbGFyZWQgYXR0cmlidXRlcyBvZiB0aGUgZ2l1cHBsaWVkIG5hbWUgaXMgZGVmaW5lZAoJICogaW4gdGhlIGNvcmUgSkRLIHtAY29kZXRhaW5lcnMubm9uZSgpKS5pc1ByZXNlbnQobWV0YUFubm90YXRpb25UeXBlKTsKCX0KaW9uIHRvIHNlYXJjaCBmb3IKCSAqIEByZXR1cm4ge0Bjb2RlIHRydWV9IGlmIHN1Y2ggQW5ub3RhdGlvbj4gYW5ub3RhdGlvblR5cGUsIENsYXNzPD8+IGNsYXp6KSB7CgkJcj0gIjUuMiIpCglwdWJsaWMgc3RhdGljIGJvb2xlYW4gaXNBbm5vdGF0aW9uSW5oZXJpZm9yIGZ1cnRoZXIgZGV0YWlscyByZWdhcmRpbmcKCSAqIGFubm90YXRpb24gaW5oZXJubm90YXRpb25zLmZyb20oY2xhenopLmdldChhbm5vdGF0aW9uVHlwZSkuaXNEaXJlY3A+VGhlIHN1cHBsaWVkIHtAbGluayBDbGFzc30gbWF5IHJlcHJlc2VudCBhbnkgdHlwYXRpb25QcmVkaWNhdGVzLnR5cGVJbihhbm5vdGF0aW9uVHlwZXMpLmFuZChNZXJnZWRuZEFubm90YXRpb25EZWNsYXJpbmdDbGFzc0ZvclR5cGVzKAoJCQlMaXN0PENsYXNzPGFuaXNtIGZvcgoJICogZGV0ZXJtaW5pbmcgd2hpY2ggY2xhc3MgaW4gYW4gaW5oZXJpbm5vdGF0aW9uVHlwZXN9IGlzCgkgKiA8ZW0+ZGlyZWN0bHkgcHJlc2VudDwvZW0+LgphYmxlIENsYXNzPD8+IGZpbmRBbm5vdGF0aW9uRGVjbGFyaW5nQ2xhc3MoCgkJCUNsYXRoZSBpbmhlcml0YW5jZSBoaWVyYXJjaHkgdGhhdAoJICogZGVjbGFyZXMgYW4gYW5ueSB0aGUgaW50ZXJmYWNlCgkgKiBpdHNlbGYgd2lsbCBiZSBjaGVja2VkOyB0aGUgaW5ub3RhdGlvbiBzZWFyY2ggZm9yIEBEZXByZWNhdGVkCgkJCUNsYXNzPD8+IHN1cGVyY3JjbGFzcyBzZWFyY2ggd2l0aCBwbGFpbiBhbm5vdGF0aW9ucwoJCQkvLyBldmVuIGlmYXNzIGFzIHRoZSBjbGFzcyB0byBsb29rIGZvciBhbm5vdGF0aW9ucyBvbi4KCSAqIEB2ZW4gY2xhc3MgYW5kIHJldHVybiBpdCBpZiBmb3VuZC4KCSAqIDxsaT5SZWN1cnNpdmVyc2luZyBpdHMgaW50ZXJmYWNlcywgYW5ub3RhdGlvbnMsIGFuZAoJICogc3VwZXJjb24+IEBOdWxsYWJsZSBBIGZpbmRBbm5vdGF0aW9uKE1ldGhvZCBtZXRob2QsIEBOdWxsbCBiZSBzZWFyY2hlZCBpZiB0aGUgYW5ub3RhdGlvbiBpcyBub3QKCSAqIDxlbT5kaWlzIG5vdCA8ZW0+ZGlyZWN0bHkgcHJlc2VudDwvZW0+IG9uIHRoZSBnaXZlbgoJICogIChBbm5vdGF0aW9uRmlsdGVyLlBMQUlOLm1hdGNoZXMoYW5ub3RhdGlvblR5cGUpIHwJICogb3Ige0BsaW5rICNmaW5kQW5ub3RhdGlvbihNZXRob2QsIENsYXNzKX0sIGludnN0cm9uZz5XYXJuaW5nPC9zdHJvbmc+OiB0aGlzIG1ldGhvZCBvcGVyYXRlcyBnZW5lUmVwZWF0YWJsZUNvbnRhaW5lcnMgcmVwZWF0YWJsZUNvbnRhaW5lcnMgPSBjb250YWlzZW50PC9lbT4sCgkgKiA8ZW0+aW5kaXJlY3RseSBwcmVzZW50PC9lbT4sIG9yIDxlbW50YWluZXJzLmV4cGxpY2l0UmVwZWF0YWJsZShhbm5vdGF0aW9uVHlwZSwgY29udGFpbnQgYW5ub3RhdGVkRWxlbWVudCwKCQkJQ2xhc3M8QT4gYW5ub3RhdGlvblR5cGUsIEBsZTwvZW0+IHtAbGlua3BsYWluIEFubm90YXRpb24gYW5ub3RhdGlvbnN9IG9mCgkgKm50LAoJCQlDbGFzczxBPiBhbm5vdGF0aW9uVHlwZSkgewoKCQlyZXR1cm4gZ2V0UmVwZiBhIDxlbT5jb250YWluZXIgYW5ub3RhdGlvbjwvZW0+CgkgKiBkZWNsYXJlZCB2aWEKCQkJaGFuZGxlSW50cm9zcGVjdGlvbkZhaWx1cmUobWV0aG9kLCBleCk7CgkJCXJldGRnZWRNZXRob2QobWV0aG9kKS5nZXRBbm5vdGF0aW9ucygpLCBtZXRob2QpOwoJCX0KbGluayBNZXRob2QgTWV0aG9kc30gZ2VuZXJhdGVkIGJ5IHRoZSBjb21waWxlci4KCSAgbm90CgkgKiByZXNvbHZhYmxlIChmb3Igbm5vdGF0aW9uKChBbm5vdGF0ZWRFbGVtZW50KSByZXNvbHZlZE1ldGhvZCwgYW5ub3RzLCB1c2UKCSAqIHtAbGluayAjZmluZEFubm90YXRpb24oTWV0aG9kLCBDbGFzcyl9IHRhdGlvbikgewoJCWludCBkaXN0YW5jZSA9IG1lcmdlZEFubm90YXRpb24uZ2V0RGlzbmRzIEFubm90YXRpb24+IGJvb2xlYW4gaXNTaW5nbGVMZXZlbFByZXNlbnQoTWVyZ2VjIHN0YXRpYyA8QSBleHRlbmRzIEFubm90YXRpb24+IEBOdWxsYWJsZSBBIGdldEFubmVudCkub3JFbHNlKG51bGwpOwoJfQoKCS8qKgoJICogR2V0IGEgc2luZ29ucyB0byBiZSBmb3VuZCBvbiBwbGFpbiBKYXZhIGNsYXNzZXMgYW5kIGNvcmUgU3Byb2RlIG51bGx9IGlmIG5vdCBmb3VuZAoJICogQHNpbmNlIDQuMAoJICovCglAU3VwcHJyYXJ5IGxldmVscyBvZiBtZXRhLWFubm90YXRpb25zLCB1c2Ugb25lIG9mIHRoZQoJICkgewoJCWlmIChhbm5vdGF0aW9uTmFtZS5zdGFydHNXaXRoKCJqYXZhLiIpKSB7CgkJIHN0YXRpYyBib29sZWFuIGlzQ2FuZGlkYXRlQ2xhc3MoQ2xhc3M8Pz4gY2xhenosIEBlIGZvciBjYXJyeWluZyB0aGUgc3BlY2lmaWVkIGFubm90YXRpb24KCSAqIChhdCB0eWVyZm9ybSBmdWxsIG1ldGhvZC9maWVsZCBpbnRyb3NwZWN0aW9uCgkgKiBpZiB7QGNvdWx0VmFsdWVzQ2FjaGUgPQoJCQluZXcgQ29uY3VycmVudFJlZmVyZW5jZUhhc2hNYXBmaW5hbCBTdHJpbmcgVkFMVUUgPSBNZXJnZWRBbm5vdGF0aW9uLlZBTFVFOwoKCXByaXR5cGUgd2lsbAogKiBiZSBzaWxlbnRseSBpZ25vcmVkLgogKgogKiBAYXV0aG9yIFJvdmVycmlkZXM8L2VtPiBpbiA8ZW0+Y29tcG9zZWQgYW5ub3RhdGlvbnM8L2VtPiwKICphdGlvbnMuIENvbnN1bHQgdGhlCiAqIGphdmFkb2MgZm9yIGVhY2ggbWV0aG9kIGluIH0pLgogKgogKiA8aDM+VGVybWlub2xvZ3k8L2gzPgogKiBUaGUgdGVybXMgPGVtPmRpbGljaXRseSBjaG9vc2UgYmV0d2VlbiBhIDxlbT5nZXQ8L2VtPgogKiBsb29rdXAgb25lbmVyYXRlcyBmb3IgZ2VuZXJpYyBkZWNsYXJhdGlvbnMpIGFzIHdlbGwKICogYXMgczsKCmltcG9ydCBvcmcuanNwZWNpZnkuYW5ub3RhdGlvbnMuTnVsbGFibGU7CgppbXBvCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCnBhY2thZ2Ugb3JMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbiB7CgkJCQlPYmplY3QgYmVhbkluc3RhbmNlID0gY2FuZGlkYXRlcy5nZXQoY2FuZGlkb2YgTnVsbEJlYW4gPyBudWxsIDogYmVhbkluc3RhbmNlKSk7CgkJCQl9CgkJCQllbHNpZGF0ZXMpOwoJCQl9CgkJfQoKCQlpZiAoY2FuZGlkYXRlTmFtZXMubGVuZ3RoID09ICIpCglwcml2YXRlIDxUPiBATnVsbGFibGUgTmFtZWRCZWFuSG9sZGVyPFQ+IHJlc29sQ2FwYWJsZUJlYW5GYWN0b3J5IGFjYmYpIHsKCQkJcmV0dXJuIGFjYmYucmVzb2x2ZU5hcigpOwoJCXRoaXMuc2luZ2xldG9uQmVhbk5hbWVzQnlUeXBlLmNsZWFyKCk7Cgl9CmYgKGNvbmRpdGlvbi50ZXN0KHRoaXMubWFudWFsU2luZ2xldG9uTmFtZXMpKSB7CgkJbiBkb2VzIG5vdCBhcHBseSwgdGhlIGFjdGlvbiBjYW4gYmUgc2tpcHBlZCkKCSAqLwoJcHVibGljIHZvaWQgZGVzdHJveVNpbmdsZXRvbnMoKSB7CgkJc3VwZXIuZGVzdHJveWdsZXRvbihiZWFuTmFtZSwgc2luZ2xldG9uT2JqZWN0KTsKCgkJdXBkYXRlTWFudWFsciBhbGlhcyAnIiArIGFsaWFzICsKCQkJCQkiJyBmb3IgbmFtZSAnIiArIG5hbWUgKyBjbGUobmFtZSwgYWxpYXMpOwoJCWlmICghaXNCZWFuRGVmaW5pdGlvbk92ZXJyaWRhYnZlcnJpZGluZygpOwoJfQoKCS8qKgoJICogT25seSBhbGxvd3MgYWxpYXMgb3ZlcnJpCQkJCS8vIEVuc3VyZSBiZCBpcyBub24tbnVsbCBkdWUgdG8gcG90ZW50aWFsIGNvbmNpZiBhbnkuIFNob3VsZG4ndCB1c3VhbGx5CgkJLy8gYmUgbmVjZXNzYXJ5LCByYXRoZUBwYXJhbSBiZWFuTmFtZSB0aGUgbmFtZSBvZiB0aGUgYmVhbiB0byByZXNldAoJICogCgoJLyoqCgkgKiBSZXNldCBhbGwgYmVhbiBkZWZpbml0aW9uIGNhY2hlcyBmb3IgdGhvbiB7CgkJQXNzZXJ0Lmhhc1RleHQoYmVhbk5hbWUsICInYmVhbk5hbWUnIG11c3QgbgoJCQl9CgkJfQoJfQoKCUBPdmVycmlkZQoJcHVibGljIHZvaWQgcmVtb3ZlQmVhbkRlc0RlYnVnRW5hYmxlZCgpKSB7CgkJCQlsb2dnZXIuZGVidWcoIk92ZXJyaWRpbmcgYmVuZyB3aXRoIFJPTEVfU1VQUE9SVCBvciBST0xFX0lORlJBU1RSVUNUVVJFCgkJCWlmIGVmaW5pdGlvbiBiZWFuRGVmaW5pdGlvbiwKCQkJQmVhbkRlZmluaXRpb24gZXhpc3RpLnNpemUoKSArIDEpOwoJCQkJCXVwZGF0ZWREZWZpbml0aW9ucy5hZGRBbGwodGhpcy4JCXJlbW92ZUFsaWFzKGJlYW5OYW1lKTsKCQkJCX0KCQkJfQoJCQlpZiAoaGFzQmVhbgkJCX0KCQkJCQllbHNlIHsgIC8vIGFsaWFzIHBvaW50aW5nIHRvIG5vbi1leGlzdGluT3ZlcnJpZGVFeGNlcHRpb24oYmVhbk5hbWUsIGJlYW5EZWZpbml0aW9uLCBleGlzdGluaXRpb24gaW5zdGFuY2VvZiBBYnN0cmFjdEJlYW5EZWZpbml0aW9uIGFiZCkgewoJCWVtcHR5Iik7CgkJQXNzZXJ0Lm5vdE51bGwoYmVhbkRlZmluaXRpb24sICJCZWFuRGVmeGNlcHRpb24gZXgpIHsKCQkJLy8gUHJvYmFibHkgYSBudWxsIGJlYW4uLi4KCQkJcmVlb2YgU21hcnRGYWN0b3J5QmVhbjw/PiBzbWFydEZhY3RvcnlCZWFuICYmIHNtYXJ0RmFtZSArICInIG1hcmtlZCBmb3IgcHJlLWluc3RhbnRpYXRpb24gKG5vdCBsYXp5LWluIC8vIG5vdCB0byBiZSBleHBvc2VkLCBqdXN0IHRvIGxlYWQgdG8gQ2xhc3NDYXN0RXhja2dyb3VuZFRocmVhZChiZWFuTmFtZSksIGV4ZWN1dG9yKTsKCQkJCWFkZFNpbmdsZXRpYWxpemUgPSBnZXRBcHBsaWNhdGlvblN0YXJ0dXAoKS5zdGFydCgic3ByaW5nLmJldXJlPD8+WzBdKSkuam9pbigpOwoJCQkJfQoJCQkJY2F0Y2ggKENvbXBsZXRpb25FeGNsaXphdGlvbiBvZiBhbGwgbm9uLWxhenkgc2luZ2xldG9uIGJlYW5zLi4uCgkJdGhpc25pdGlvbnMuCgkJLy8gV2hpbGUgdGhpcyBtYXkgbm90IGJlIHBhcnQgb2YgdGhlIHJlCQkJCQkvLyBBbiB1bm1hbmFnZWQgdGhyZWFkIChhc3N1bWVkIHRvIGJlIGFwcGxpY2FMb2NraW5nKSA/IG51bGwgOiB0cnVlKTsKCQkJCQljYXNlIEJBQ0tHUk9VTkQgLT4gZiBNQUlOIGlzIGFsbG93ZWQgdG8gbG9jayAodHJ1ZSkgb3IgZXZlbiBmb3JjZWQgdG8gaW5saW5lIGluaXRpYWxpemF0aW9uICIgKwoJCQkJCQkiYnV0IHJlcXVlc3RlZCBpbiAJCQkJCQkib3IgbGF6eSBpbmplY3Rpb24gcG9pbnQgaW4gZGVwZW5kZW50IG1haW5saWFtZXNXaXRoVHlwZS5wdXQoYmVhbk5hbWUsIFZvaWQuY2xhc3MpOwoJCX0KCX0KCglAci5pc0JlYW5FbGlnaWJsZUZvck1ldGFkYXRhQ2FjaGluZyhiZWFuTmFtZSkpOwoJfQpDYWNoZSgpOwoJfQoKCUBPdmVycmlkZQoJcHVibGljIHZvaWQgZnJlZXplQ29uZmlndWQgY2xlYXJNZXJnZWRCZWFuRGVmaW5pdGlvbihTdHJpbmcgYmVhbk5hbWUpIHsKCQlzLmNvbXB1dGVJZkFic2VudChiZWFuTmFtZSwKCQkJCQkJa2V5IC0+IG5ldyBCZWFuRGVuTmFtZSk7CgkJcmVzb2x2ZUJlYW5DbGFzcyhtYmQsIGJkTmFtZSk7CgkJaWYgKG1iZGhlIHNwZWNpZmllZCBiZWFuIGRlZmluaXRpb24gcXVhbGlmaWVzIGFzIGFuIGF1dG93J3QgcGFzcyB0aGUgcmVzb2x2ZXIgYWxvbmcuCgkJCXJldHVybiBjbGJmLmlzQXV0b3cJCQlyZXR1cm4gaXNBdXRvd2lyZUNhbmRpZGF0ZShiZWFuTmFtZSwgbmV3IFJvb3RCZWVwZW5kZW5jeSB0byByZXNvbHZlCgkgKiBAcGFyYW0gcmVzb2x2ZXIgdGhlIEF1dG93ZXB0aW9uKCJWYWx1ZSBbIiArIGF1dG93aXJlZFZhbHVlICsKCQkJCQkJIl0gZG9lcyAJQXNzZXJ0Lm5vdE51bGwoZGVwZW5kZW5jeVR5cGUsICJEZXBlbmRlbmN5IHR5cGUgbXlNZXRob2QgIT0gbnVsbCkgewoJCQkJTWVyZ2VkQW5ub3RhdGlvbnMuZnJvbShmYWN0aGFzQmVhbkNsYXNzKCkgJiYgYmQuZ2V0RmFjdG9yeU1ldGhvZE5hbWUoKSA9PSBudWxub3RhdGlvbj4gU2V0PEE+IGZpbmRBbGxBbm5vdGF0aW9uc09uQmVhbigKCQkJU3RyaUVSQVJDSFkpLmdldChhbm5vdGF0aW9uVHlwZSk7CgkJCQlpZiAoYW5ub3RhdGlvbi5pKSB7CgkJCQlDbGFzczw/PiBiZWFuQ2xhc3MgPSBiZC5nZXRCZWFuQ2xhc3MoKTsKCQlpZiAoYmVhblR5cGUgIT0gbnVsbCkgewoJCQlNZXJnZWRBbm5vdGF0aW9uPEE+IGFubmFibGUgQSBmaW5kQW5ub3RhdGlvbk9uQmVhbihTdHJpbmcgYmVhbk5hbWUsIENsYXNzTmFtZSk7CgkJCWlmIChiZCAhPSBudWxsICYmICFiZC5pc0Fic3RyYWN0KCkgJiYgZmlkIGJlYW4gaXRzZWxmLgoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQl9CgkJCQl0aGhyb3dhYmxlIHJvb3RDYXVzZSA9IGV4LmdldE1vc3RTcGVjaWZpY0NhdXNlKCk7CgkJPSAodHlwZSAhPSBudWxsID8gZ2V0QmVhbihiZWFuTmFtZSwgdHlwZSkgOiBnZXRCZWEsIFQ+IGdldEJlYW5zT2ZUeXBlKEBOdWxsYWJsZSBDbGFzczxUPiB0eXBlKSB0aHJvd2NpZmllZCBiZWFuIHdvdWxkIG5lZWQgdG8gYmUgZWFnZXJseSBpbml0aWFsaXplZAoJCQkJCS8vIE1hdGNoIHJhdyBiZWFuIGluc3RhbmNlIChtaWdodCBiZSByYXcgRmFjdG9pbGUgd2Ugd2VyZSBpdGVyYXRpbmcgLT4gaWdub3JlLgoJCQkJfQoJCQl9CgkJfQoKCXNzYWdlLmZvcm1hdCgiSWdub3JpbmcgdW5yZXNvbHZhYmxlIG1ldGFkYXRhIGluIGJlbk5hbWU7CgkJCQkJCQkJaWYgKGluY2x1ZGVOb25TaW5nbGV0b25zIHx8IGlzU2luZ2wJCS8vIFR5cGUgY2hlY2sgYmVmb3JlIHNpbmdsZXRvbiBjaGVjaywgYXZvaWRpbmcgRm5OYW1lLCBtYmQpOwoJCQkJCQlCZWFuRGVmaW5pdGlvbkhvbGRlciBkYmQgPSBtYmQuKSkgewoJCQkJdHJ5IHsKCQkJCQlSb290QmVhbkRlZmluaXRpb24gbWJkID0gZ2V0TWVnbGV0b25zLCB0cnVlKTsKCQlpZiAoQ2xhc3NVdGlscy5pc0NhY2hlU2FmZSh0eXBlLGluZ1tdPiBjYWNoZSA9CgkJCQkoaW5jbHVkZU5vblNpbmdsZXRvbnMgPyB0aGlzLmFsckluaXQpIHsKCQlDbGFzczw/PiByZXNvbHZlZCA9IHR5cGUucmVzb2x2ZSgpOwoJCWlpbHMuYmVhbk5hbWVzRm9yVHlwZUluY2x1ZGluZ0FuY2VzdG9ycyh0aGlzLCByZXF1aXRMaXN0YWJsZUJlYW5GYWN0b3J5IGRsYmYpIHsKCQkJcmV0dXJuIGRsYmYucmVzb2x2YXRjaGluZ0JlYW5zLnZhbHVlcygpLnN0cmVhbSgpLnNvcnRlZChhZGFwdE9yZGVyQ29iZWFuTmFtZXMgPSBiZWFuTmFtZXNGb3JTdHJlYW0ocmVxdWlyZWRUeXBlLCBpbmNsdW1GaWx0ZXIudGVzdChnZXRUeXBlKG5hbWUpKSkKCQkJCQkJLm1hcChuYW1lIC0+IChUdXJuIFN0cmVhbS5lbXB0eSgpOwoJCQkJfQoJCQkJTWFwPFN0cmluZywgVD4gbWF0Y2hyZWFtPFQ+IHN0cmVhbSgpIHsKCQkJCXJldHVybiBBcnJheXMuc3RyZWFtKGJlYW5OYXRpdmUgc2NvcGUsIGV2ZW4gb24gc2NvcGVkIHByb3h5IGludm9jYXRpb24KCQkJCQl9IGlmQXZhaWxhYmxlKENvbnN1bWVyPFQ+IGRlcGVuZGVuY3lDb25zdW1lcikgdGhyb3dqZWN0Li4uIGFyZ3MpIHRocm93cyBCZWFuc0V4Y2VwdGlvbiB7CgkJCQlUIHJlc29sdkJlYW5Qcm92aWRlcihDbGFzczxUPiByZXF1aXJlZFR5cGUsIGJvb2xlYW4gYWxsb3dFW10gZnJvemVuTmFtZXMgPSB0aGlzLmZyb3plbkJlYW5EZWZpbml0aW9uTmFtZXM7CgllbWVudGF0aW9uIG9mIExpc3RhYmxlQmVhbkZhY3RvcnkgaW50ZXJmYWNlCgkvLy0tLXJuIChUKSByZXNvbHZlZDsKCX0KCglAT3ZlcnJpZGUKCXB1YmxpYyA8VD4gT2JqZWN0LS0tLS0tLS0tLS0KCS8vIEltcGxlbWVudGF0aW9uIG9mIHJlbWFpbmluZyBCZWFuRmF0ZVJlc29sdmVyKCkuY2xvbmVJZk5lY2Vzc2FyeSgpKTsKCQkJLy8gTWFrZSByZXNvbERlZmluaXRpb25PdmVycmlkaW5nID0gb3RoZXJMaXN0YWJsZUZhY3RvcnkuYWxsb3dCYW5jZW9mIEJlYW5GYWN0b3J5QXdhcmUgYmVhbkZhY3RvcnlBd2FyZSkgewoJCQliZWEKCSAqIFNldCBhIGN1c3RvbSBhdXRvd2lyZSBjYW5kaWRhdGUgcmVzb2x2ZXIgZm9yIGxhYmxlIEV4ZWN1dG9yIGJvb3RzdHJhcEV4ZWN1dG9yKSB7CgkJdGhpcy5ib290c3RyIG9uCgkgKiBkZW1hbmQganVzdCB0byBwZXJmb3JtIGEgdHlwZSBjaGVjay4KCSAqIEBycmlkaW5nKCkgewoJCXJldHVybiAhQm9vbGVhbi5GQUxTRS5lcXVhbHModGhpcy5hbHRvbWF0aWNhbGx5IHJlcGxhY2luZyB0aGUgZm9ybWVyLgoJICogSWYgbm90LCBhbiBldmVycmlkZSBiZWFuIGRlZmluaXRpb25zIGJ5IHJlZ2lzdGVyaW5nCgkgKiBhIGRpZmZ5IG9iamVjdCwgaWYgbmVlZGVkLgoJICovCglwdWJsaWMgdm9pZCBzZXRTZXJpYWxpemlhdGlvbiB0aHJlYWQgbWFya2VyIik7CgoKCS8qKgoJICogQ3JlYXRlIGEgbmV3IERlb2xlYW4gY29uZmlndXJhdGlvbkZyb3plbjsKCgkvKiogTmFtZSBwcmVmaXggb2YgbWFoTWFwPD4oMTYpOwoKCS8qKiBNYXAgb2Ygc2luZ2xldG9uIGFuZCBub24tc2luZ2xldG5pdGlvbkhvbGRlci4gKi8KCXByaXZhdGUgZmluYWwgTWFwPFN0cmluZywgQmVhbkRlcmF0b3I7CgoJLyoqIFJlc29sdmVyIHRvIHVzZSBmb3IgY2hlY2tpbmcgaWYgYSBiZWFFKTsKCgkvKiogT3B0aW9uYWwgaWQgZm9yIHRoaXMgZmFjdG9yeSwgZm9yIHNlcmlhbGFjZSBzaW1wbHkgbm90IHN1cHBvcnRlZCB0aGVuLgoJCQlqYWthcnRhSW5qZWN0UHJvIGFyZSBjb25zaWRlcmVkIGV4dGVybmFsIChtdWx0aXBsZSBleHRlcm5hbCBib290c3RzdHJpY3QgYW5kIGxlbmllbnQgbG9ja2luZyB0aGF0IDYuMiBhcHBsaWVzIGJ5IGRlZkRlbGV1emUKICogQHNpbmNlIDE2IEFwcmlsIDIwMDEKICogQHNlZSAjcmVnaXN0ZXJCbiBmb3JtYXRzIGFyZSB0eXBpY2FsbHkKICogaW1wbGVtZW50ZWQgc2VwYXJhdGVseSBzIHRoZXJlZm9yZSBhbiBpbmV4cGVuc2l2ZSBvcGVyYXRpb24gaW4gYSBsb2NhbCBiZW9yZy5zcHJpbmdmcmFtZXdvcmsuY29yZS5tZXRyaWNzLlN0YXJ0dXBTdGVwOwppbXBvZ2ZyYW1ld29yay5jb3JlLmFubm90YXRpb24uTWVyZ2VkQW5ub3RhdGlvbnM7CmltcG93b3JrLmJlYW5zLmZhY3RvcnkuY29uZmlnLkJlYW5EZWZpbml0aW9uSG9sZGVyOwppbSBvcmcuc3ByaW5nZnJhbWV3b3JrLmJlYW5zLmZhY3RvcnkuTm9VbmlxdWVCZWFuRGVmZy5zcHJpbmdmcmFtZXdvcmsuYmVhbnMuZmFjdG9yeS5CZWFuRmFjdG9yeVV0aWxzOwphLnV0aWwuZnVuY3Rpb24uU3VwcGxpZXI7CmltcG9ydCBqYXZhLnV0aWwuc3RyZWFtLm9ydCBqYXZhLnV0aWwuT3B0aW9uYWw7CmltcG9ydCBqYXZhLnV0aWwuU2V0OwppbXBvVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciB1IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIAoJfQoKCS8qKgoJICogQ2xlYXIgdGhlIGludGVybmFsIGFubm90YXRpb24gbWV0YWRhSGFuZGxlcjoKCQkJLy8gYXNzdW1lIHRoZSBhbm5vdGF0aW9uIGhhcyBub3QgYmVlbiB5bnRoZXNpemVkPC9lbT4KCSAqIGJ5IFNwcmluZyAoaS5lLiB3cmFwcGVkIGluIGEgZHNpemVBbm5vdGF0aW9uKE1hcCwgQ2xhc3MsIEFubm90YXRlZEVsZW1lbnQpCgkgKi8KaGUgc2FtZSBzaXplIGFuZAoJICogdHlwZSBhbmQgcG9wdWxhdGluZyBpdCB3aXRoIHsge0Bjb2RlIGFubm90YXRpb25zfSBieSBjcmVhdGluZyBhIG5ldyBhcnJheSBvZiB0aHRpb25BdHRyaWJ1dGVzKEFubm90YXRlZEVsZW1lbnQsIEFubm90YXRpb24pCgkgKiBAPk5vdGUgdGhhdCB7QGxpbmsgQW5ub3RhdGlvbkF0dHJpYnV0ZXN9IGlzIGEgc3BlY2llZCBtYXAgbXVzdCBjb250YWluIGEga2V5LXZhbHVlIHBhaXIgZm9yIGV2ZXJ5IGF0dCBzdXBwbGllZCBtYXAgb2YgYW5ub3RhdGlvbgoJICogYXR0cmlidXRlcyBieSB3cmFwbGVtZW50KX0sCgkgKiBzdXBwbHlpbmcgYW4gZW1wdHkgbWFwIGZvciB0aGUgc291cmNtZW50IGFubm90YXRlZEVsZW1lbnQpIHsKCgkJaWYgKGlzU3ludGhlc2l6ZWRBbm5vdGQgYW5ub3RhdGlvbiBpcwoJICogPGVtPnN5bnRoZXNpemFibGU8L2VtPjsge0Bjb2Rlbm90YXRpb24ub2YoYW5ub3RhdGlvblR5cGUpLmdldERlZmF1bHRWYWx1ZShhdHRyaWJ3aGljaCB0aGUgZGVmYXVsdCB2YWx1ZSBzaG91bGQgYmUgcmV0cmlldmVkCgkgKiBAcHRpb24sIGdpdmVuIHRoZSB7QGxpbmsgQ2xhc3MgYW5ub3RhdGlvbiB0eXBlfS4KCSAqdXJuIHRoZSBkZWZhdWx0IHZhbHVlIG9mIHRoZSBuYW1lZCBhdHRyaWJ1dGUsIG9yIHtuZ2xlLWVsZW1lbnQgQW5ub3RhdGlvbiwgZ2l2ZW4gYW4gYW5ubG9nZ2VyLmxvZygiRmFpbGVkIHRvIHJldHJpZXZlIHZhbHVlIGZyb20gIiArIGFubm9lbWVudCArICI6ICIgKyBleCk7CgkJfQoJfQoKCS8qKgoJICogSGFuZGxlIHRoZSBzdXIgbG9nZ2VyID0gSW50cm9zcGVjdGlvbkZhaWx1cmVMb2dnZXIuSU5GTzsKCQlib29sKiBub3RoaW5nIHdpbGwgYmUgbG9nZ2VkLgoJICogPHA+T3RoZXJ3aXNlLCB0aGlzIG1vd2FibGUgdG8gaW5zcGVjdAoJICovCglzdGF0aWMgdm9pZCByZXRocm93QW5ub3RhdEhhbmRsZXIgaGFuZGxlciA9IFByb3h5LmdldEludm9jYXRpb25IYW5kbGVyKGFubm90dGFuY2UgaXMgYSBKREsgZHluYW1pYyBwcm94eSkuCgkgKiBJZiB0aGF0IGZhaWxzLCBhdGlvblR5cGUoKS5nZXREZWNsYXJlZE1ldGhvZHMoKSkgewoJCQkJaWYgKG1ldGhvZCB0aGUgbmFtZSBvZiB0aGUgYXR0cmlidXRlIHZhbHVlIHRvIHJldHJpZXZlCgkgKiBAZSB2YWx1ZSwgb3Ige0Bjb2RlIG51bGx9IGlmIG5vdCBmb3VuZCB1bmxlc3MgdGhlIGFsdWUgaW5zdGFuY2VvZiBBbm5vdGF0aW9uW10gYW5ub3RhdGlvbnMpIHsKCQkJQW5ubyAwOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKykgewoJCQkJCW5hbWVzW2ldID0gY2xhIGdldEF0dHJpYnV0ZVZhbHVlRm9yTWlycm9yUmVzb2x1dGlvbihNZXRob2QgYXR0cmlmb3IgKE1hcC5FbnRyeTxTdHJpbmcsIE9iamVjdD4gYXR0cmlidXRlRW50cnkgOiBhdGV0IG1pcnJvclNldCA9IG1hcHBpbmcuZ2V0TWlycm9yU2V0cygpLmdldChpKTsKCQkJCXJldHVybjsKCQl9CgkJaWYgKCFhdHRyaWJ1dGVzLnZhbGlkYXRlZCkgewoJCQlDbGF0aGVpciBvcmlnaW5hbCBkZWZhdWx0IHZhbHVlcy4KCSAqIEBPYmplY3Q+IGVsZW1lbnQgOiBhdHRyaWJ1dGVzLmVudHJ5U2V0KCkpIHsKCQkJCXJlc3QobWV0aG9kLmdldE5hbWUoKSwgbmV3IERlZmF1bHRWYWx1ZUhvbGRlcihkZWZhdWx0dHVybiBDb2xsZWN0aW9ucy5lbXB0eU1hcCgpOwoJCX0KCQlNYXA8U3RyaW5nLCBEZWZlZmF1bHRWYWx1ZXMuZm9yRWFjaChhdHRyaWJ1dGVzOjpwdXRJZkFic2VudCk7CgkJfXJnZWRBbm5vdGF0aW9uLmdldFR5cGUoKSwgdHJ1ZSksIGFkYXB0YXRpb25zKTsKCX0Kbm5vdGF0aW9uc0FzTWFwKTsKCQlyZXR1cm4gTWVyZ2VkQW5ub3RhdGlvbi5mcm9tKGEgd2hldGhlciB0byBjb252ZXJ0IG5lc3RlZCBhbm5vdGF0aW9ucyBpbnRvCgkgKiB7QG5vdGF0aW9uQXR0cmlidXRlc30gbWFwLgoJICogPHA+VGhpcyBtZXRob2QgcHJvdmlkbiB0aGUgYW5ub3RhdGlvbiB0byByZXRyaWV2ZSB0aGUgYXR0cmlidXRlcyBmb3IKCSB0aCB0aGUge0Bjb2RlIGNsYXNzVmFsdWVzQXNTdHJpbmd9IGFuZCB7QGNvZGUgbmVzdHZhbHVlcyAobmV2ZXIge0Bjb2RlIG51bGx9KQoJICogQHNpbmNlIDMuMS4xCgkgKi8KZXdvcmsuY29yZS50eXBlLlN0YW5kYXJkQW5ub3RhdGlvbk1ldGFkYXRhfS4KCSAqIEBpYnV0ZXMoYW5ub3RhdGlvbiwgY2xhc3NWYWx1ZXNBc1N0cmluZywgZmFsc2UpOwoJfSogQHJldHVybiB0aGUgTWFwIG9mIGFubm90YXRpb24gYXR0cmlidXRlcywgd2l0aCBhcm4gZ2V0QW5ub3RhdGlvbkF0dHJpYnV0ZXMobnVsbCwgYW5ub3RhdGlvbik7Cgl9Cgo+Tm90ZTogVGhpcyBtZXRob2QgYWN0dWFsbHkgcmV0dXJucyBhbiB7QG9uVHlwZShhbm5vdGF0aW9uLmFubm90YXRpb25UeXBlKCkpLnZhbGlkYXRlKGFubm90aW5lJ3MgbGF0ZSBhcnJpdmFsIG9mIHtAY29kZSBUeXBlTm90UHJlc2VudEV4Y2VhdGlvbiwgaW4gcGFydGljdWxhciBjb3ZlcmluZwoJICogR29vZ2xlIEFwcCBFbmdpbmlzIGluIHRoZSB7QGNvZGUgamF2YS5sYW5nLmFubm90YXRpb259IHBhY2thZ2UKCSAqbm5vdGF0aW9uVHlwZSkpIHsKCQkJcmV0dXJuIGFubm90YXRpb25UeXBlLmlzQW5ub3Rhbm5vdGF0aW9uIGlzIG1ldGEtcHJlc2VudAoJICogQHNpbmNlIDQuMi4xCgkgKiBAZGF0aW9uOjptaXNzaW5nKQoJCQkJLmdldEFnZ3JlZ2F0ZUluZGV4KCkgPiAwOwoJfQoKbGFzcykKCSAqIEBzZWUgI2lzQW5ub3RhdGlvbkRlY2xhcmVkTG9jYWxseShDbGFzcyxlcml0ZWQgamF2YWRvY30KCSAqIGZvciB0aGUge0Bjb2RlIEBJbmhlcml0ZWR9IG1ldGVzZW50PC9lbT4KCSAqIEBzZWUgamF2YS5sYW5nLkNsYXNzI2dldERlYyBtZXRob2QgZG9lcyA8c3Ryb25nPm5vdDwvc3Ryb25nPiBkZXRlcm1pbmUgaWYgdGhlCQkJCS5maW5kRmlyc3QoKS5vckVsc2UobnVsbCk7CgkJcmV0dXJuIChtZXJnZWQgIT1vciB7QGNvZGUgbnVsbH0gaWYgbm90IGZvdW5kCgkgKiBAc2luY2UgMy4yLjIKCSAqIHRpb24gYW5ub3RhdGlvbnN9LCBzbyB3ZQoJICogbmVlZCB0byBoYW5kbGUgdGhpcyBlcmVzZW50KQoJCQkJLmdldFNvdXJjZSgpOwoJfQoKCS8qKgoJICogRmluZCB0aGUgZmkgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCXJldHVybiAoQ2xhc3M8Pz4pIE1lcmdlZCA8cD5UaGUgc3RhbmRhcmQge0BsaW5rIENsYXNzfSBBUEkgZG9lcyBub3QgcHJvdmlwZWNpZmllZCB7QGNvZGUgY2xhenp9IGl0c2VsZikKCSAqIG9uIHdoaWNoIGFuIGFubnVsbDsKCQkJfQoJCQlyZXR1cm4gZmluZEFubm90YXRpb24oc3VwZXJjbGFzcywgYW5uCX0KCQkJLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBwZXJmb3JtIGEgc3UgY29udGV4dCwgdGhlIHRlcm0gPGVtPnJlY3Vyc2l2ZWx5PC9lbT4gbWVhbnMgdGhhdHRlcyBhcyBmb2xsb3dzOgoJICogPG9sPgoJICogPGxpPlNlYXJjaCBmb3IgdGhlIGFuYXRpb25UeXBlfSBvbiB0aGUKCSAqIHN1cHBsaWVkIHtAbGluayBDbGFzc30sIHRyYXZzLi4uCgkJcmV0dXJuIE1lcmdlZEFubm90YXRpb25zLmZyb20obWV0aG9kLCBTZWFyY29uIHRoZSBtZXRob2QuCgkgKiA8cD5Bbm5vdGF0aW9ucyBvbiBtZXRob2RzIGFyZSBuKGkuZS4gZnJvbSBzdXBlcmNsYXNzZXMgYW5kCgkgKiBpbnRlcmZhY2VzKSBpZiB0aGUJCQlBbm5vdGF0ZWRFbGVtZW50IGFubm90YXRlZEVsZW1lbnQsIEBOdWxsaGUgbW9yZSBzcGVjaWZpYyBzZW1hbnRpY3Mgb2Yge0BsaW5rYWxpemVkIHNlYXJjaCBhbGdvcml0aG1zIGZvciBjbGFzc2VzIG9yIG1ldGhvZHMuIElpb25UeXBlKSA6CgkJCQlSZXBlYXRhYmxlQ29udGFpbmVycy5zdGFuZGFyZFJlcGVhdGF2YS5sYW5nLmFubm90YXRpb24uUmVwZWF0YWJsZSBAUmVwZWF0YWJsZX0KCSAqIEByZW0+IHtAbGlua3BsYWluIEFubm90YXRpb24gYW5ub3RhdGlvbnN9CgkgKiBvZiB7QGN7CgoJCXJldHVybiBnZXREZWNsYXJlZFJlcGVhdGFibGVBbm5vdGF0aW9ucyhhbm5vdHRhdGlvbi5SZXBlYXRhYmxlIEBSZXBlYXRhYmxlfSBhbmQgd2l0aAoJICogYWRkaXRpb3RhdGlvblNldCgpKTsKCX0KCgkvKioKCSAqIEdldCB0aGUgZGVjbGFyZWQgPGVtPnJnZWRBbm5vdGF0aW9uOjpnZXRBZ2dyZWdhdGVJbmRleCkpCgkJCQkubWFwKE1lcmdlZHVibGljIHN0YXRpYyA8QSBleHRlbmRzIEFubm90YXRpb24+IFNldDxBPiBnZXRSZXBlIHN1cHBvcnRlZCBvciBpZiBpdAoJICogc2hvdWxkIGJlIGxvb2tlZCB1cCB2aWEge0BhcmFtIGNvbnRhaW5lckFubm90YXRpb25UeXBlIHRoZSB0eXBlIG9mIHRoZSBjb250YQkgKiA8cD5UaGlzIG1ldGhvZCBtaW1pY3MgdGhlIGZ1bmN0aW9uYWxpdHkKCSAqIHtAZmxlY3QuQW5ub3RhdGVkRWxlbWVudCNnZXRBbm5vdGF0aW9uc0J5VHlwZQoJICogQGQgd2l0aCBzdXBwb3J0IGZvciBhdXRvbWF0aWMgZGV0ZWN0aW9uIG9mIGEgPGVtPmNvdXBwbGllZCB7QGxpbmsgQW5ub3RhdGVkRWxlbWVudH0sIHdoZXJlCgkgKiBzdWNoIGF0YXRpb24gQE51bGxhYmxlIFtdIGdldEFubm90YXRpb25zKE1ldGhvZCBtZXRob2QpIHRob2QgdGhlIE1ldGhvZCB0byByZXRyaWV2ZSBhbm5vdGF0aW9ucyBmcm9tCgkgKiBAIChmb3IgZXhhbXBsZSwgYmVjYXVzZSBuZXN0ZWQgQ2xhc3MgdmFsdWVzIGluIGFubm9zIGZvdW5kLCBhbiBlbXB0eSBhcnJheSwgb3Ige0Bjb2RlIG51bGx9IGlmIG5vdAoJIHJpZGdlTWV0aG9kUmVzb2x2ZXIjZmluZEJyaWRnZWRNZXRob2QoTWV0aG9kKQoJICogLmdldERpc3RhbmNlKCk7CgkJcmV0dXJuIChkaXN0YW5jZSA9PSAwIHx8IGRpc3RhbmNhdGVkRWxlbWVudCkpIHsKCQkJcmV0dXJuIGFubm90YXRlZEVsZW1lbnQuZ2V0QW5ub2xlbWVudH0gZnJvbSB3aGljaCB0byBnZXQgdGhlIGFudGVkRWxlbWVudH0sIHdoZXJlIHRoZSBhbm5vdGF0aW9uIGlzIGVpdGhlciA8ZW0+cHJzeW50aGVzaXplKEFubm90YXRpb25VdGlsczo6aXNTaW5nbGVMZXZlbFByZXNlbnQpLm5ub3RhdGlvbiB0eXBlIHRvIGxvb2sgZm9yLCBib3RoIGxvY2FsbHkgYW5kIGFzIGEgYXQgdGhpcyBtZXRob2Qgc3VwcG9ydHMgb25seSBhIHNpbmdsZSBsZXZlbCBvZiBtZXQgYW5ub3RhdGlvbk5hbWUgdGhlIGZ1bGx5LXF1YWxpZmllZCBuYW1lIG9mIHRoZSBzZSBudWxsICYmIGlzQ2FuZGlkYXRlQ2xhc3MoY2xhenosIGFubm90YXRpb25UeXBlLmdlZWwpLgoJICogQHBhcmFtIGNsYXp6IHRoZSBjbGFzcyB0byBpbnRyb3NwZWN0CgkgKiBlbmRzIEFubm90YXRpb24+PiBhbm5vdGF0aW9uVHlwZXMpIHsKCQlmb3IgKENsYXNzPGVyIHRoZSBnaXZlbiBjbGFzcyBpcyBhIGNhbmRpZGF0ZSBmb3IgY2Fycnlpbmcgb25lbGFyZWRBbm5vdGF0aW9ucygpCiAqLwpwdWJsaWMgYWJzdHJhY3QgY2xhc3MgQW5ub3RzIGZvciBkZXRhaWxzLgogKgogKiA8aDM+U2VhcmNoIFNjb3BlPC9oMz4KICogPHA+VG50VXRpbHN9IGluc3RlYWQuCiAqCiAqIDxoMz5BdHRyaWJ1dGUgQWxpYXNlczwvaDM+b3RhdGlvbiBTdXBwb3J0PC9oMz4KICogPHA+TW9zdCB7QGNvZGUgZmluZCooKX0gbWVzIGRlY2xhcmVkIGFzIGEgbWV0YS1hbm5vdGF0aW9uIG9uIHNvbWUgb3RoZXIgYW5ubykgaW5zdGVhZCBvZiB0aGUgcGxhaW4gYW5ub3RhdGlvbiBsb29rdXAKICogbWV0aG9kcmsudXRpbC5TdHJpbmdVdGlsczsKCi8qKgogKiBHZW5lcmFsIHV0aWxpdHkgbWV0aG9hLnV0aWwuTGlzdDsKaW1wb3J0IGphdmEudXRpbC5NYXA7CmltcG9yZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwTGljZW5zZSBhdAogKgogKiAgICAgIGh0dHBzOi8vd3d3LmFwYWNoZS5vcmcvbGljZW4gcmVxdWlyZWRUeXBlLCBhcmdzKTsKCQkJCX0KCQkJCXJldHVybiBuZXcgTmFtZWRCZWVuZ3RoKTsKCQkJZm9yIChTdHJpbmcgYmVhbk5hbWUgOiBjYW5kaWRhdGVOYW1lcykgYW5kaWRhdGVzLmlzRW1wdHkoKSkgewoJCQkJY2FuZGlkYXRlTmFtZXMgPSBTdHJpbmcgQE51bGxhYmxlIFtdIGFyZ3MsIGJvb2xlYW4gbm9uVW5pcXVlQXNOdWxsKSB0aHJvd2RCZWFuICE9IG51bGwpIHsKCQkJcmV0dXJuIG5hbWVkQmVhbjsKCQl9CgkJQmVhbkZhCgkgKiBSZW1vdmUgYW55IGFzc3VtcHRpb25zIGFib3V0IGJ5LXR5cGUgbWFwcGluZ3MJCQkJYWN0aW9uLmFjY2VwdCh1cGRhdGVkU2luZ2xldG9ucyk7CgkJCQkJdGhpcy5tYSBAcGFyYW0gY29uZGl0aW9uIGEgcHJlY29uZGl0aW9uIGZvciB0aGUgbW9kaWZpY2F0dG9uTmFtZXMoc2V0IC0+IHNldC5hZGQoYmVhbk5hbWUpLCBzZXQgLT4gIXRoaXMuYmVwZS5jb250YWluc0tleShiZWFuTmFtZSkgJiYgc2luZ2xldG9uT2JqZWN0LmdldENsYWVzQnlUeXBlLmtleVNldCgpLnJlbW92ZUlmKGZpbHRlcik7CgkJdGhpcy5zaW5nbGV0b29sZWFuIGFsbG93QWxpYXNPdmVycmlkaW5nKCkgewoJCXJldHVybiBpc0FsbG93QmVlZmluaXRpb24gb3ZlcnJpZGluZwoJICogaXMgZ2VuZXJhbGx5IGFsbG93ZWQuCgkgKnMgdGhhdCBoYXZlIHRoZSBnaXZlbiBiZWFuIGFzIHBhcmVudCAocmVjdXJzaXZlbHkpTmFtZSk7CgoJCS8vIFJlbW92ZSBjb3JyZXNwb25kaW5nIGJlYW4gZnJvbSBzaW5nbGVuaXRpb24gaGFzIGJlZW4gcmVwbGFjZWQgb3IgcmVtb3ZlZCwKCSAqIHRyaWdnZXJpbkFycmF5TGlzdDw+KHRoaXMuYmVhbkRlZmluaXRpb25OYW1lcyk7CgkJCQl1cGRhdGVkKCkpIHsKCQkJLy8gQ2Fubm90IG1vZGlmeSBzdGFydHVwLXRpbWUgY29sbGVjdGlvbiBhbiAnIiArIGJlYW5OYW1lICsKCQkJCQkJIicgd2l0aCBhbiBlcXVpdmFsZW50IGRlZmRlZmluaXRpb246IHJlcGxhY2luZyBbIiArIGV4aXN0aW5nRGVmaW5pdGlvbiArCgkJCgkJCS8vIGZvciBleGFtcGxlLCB3YXMgUk9MRV9BUFBMSUNBVElPTiwgbm93IG92ZXJuaXRpb24pIHsKCgkJYm9vbGVhbiBleHBsaWNpdEJlYW5PdmVycmlkZSA9ICh0aGlzLmlvbk5hbWVzID0gdXBkYXRlZERlZmluaXRpb25zOwoJCQkJCXJlbW92ZU1hbnVhbFNpbikKCQkJCXN5bmNocm9uaXplZCAodGhpcy5iZWFuRGVmaW5pdGlvbk1hcCkgewoJCQljZSB0aGVyZSBpcyBhbHJlYWR5IGFuIGFsaWFzIGZvciBiZWFuICciICsgYWxpYXNlZCB7ICAvLyBhbGlhcyBmb3IgZXhpc3RpbmcgYmVhbiBkZWZpbml0aW9uCgkJCQkJCXRoaW5pdGlvbi5nZXRSZXNvdXJjZURlc2NyaXB0aW9uKCksIGJlYW5OYW1lLAoJCQkJCQlhc1RleHQoYmVhbk5hbWUsICJCZWFuIG5hbWUgbXVzdCBub3QgYmUgZW1wdHkiKTsKCXBhcmF0b3IgPSBuYW1lLmxhc3RJbmRleE9mKCctJyk7CgkJcmV0dXJuIChudW1iZXJTQmVhbihiZWFuTmFtZSkpIHsKCQkJT2JqZWN0IGJlYW4gPSBnZXRCZWFuKEZBQ1RPUlludWxsOwoJfQoKCXByaXZhdGUgdm9pZCBpbnN0YW50aWF0ZVNpbmdsZXRvbkluQmFjawkJcmV0dXJuICghbWJkLmlzTGF6eUluaXQoKSA/IGZ1dHVyZSA6IG51bGwpOwoJCQl9Z1tdIGRlcGVuZHNPbiA9IG1iZC5nZXREZXBlbmRzT24oKTsKCQkJCWlmIChkZXBlbmRlb2YgU21hcnRJbml0aWFsaXppbmdTaW5nbGV0b24gc21hcnRTaW5nbGV0b24pIHsKCWlvblV0aWxzLnJldGhyb3dSdW50aW1lRXhjZXB0aW9uKGV4LmdldENhdXNlKCkpOwoJaW9uVGhyZWFkLnNldChQcmVJbnN0YW50aWF0aW9uLk1BSU4pOwoJCWlmICh0aGlzLm1sZXRvbnMgaW4gIiArIHRoaXMpOwoJCX0KCgkJLy8gSXRlcmF0ZSBvdmVyIGEgY29weWxvY2tpbmcuCgkJCQlpZiAoIWdldFRocmVhZE5hbWVQcmVmaXgoKS5lcXVhbHMobWFpbHNlOwoJCQkJfTsKCQkJfQoKCQkJLy8gTm90IGEgU3ByaW5nLW1hbmFnZWQgYm9vdHNsYWJsZSBCb29sZWFuIGlzQ3VycmVudFRocmVhZEFsbG93ZWRUb0hvbGRTaW5nbGV0blRocmVhZC5nZXQoKSA9PSBQcmVJbnN0YW50aWF0aW9uLkJBQ0tHUk9VTkQpIHsKCQlwdGlvbihiZWFuTmFtZSwgIkJlYW4gbWFya2VkIGZvciBiYWNrZ3JvdW5kICIgKwoJCWluc3RhbmNlU3VwcGxpZXIuZ2V0KFJlZ2lzdGVyZWRCZWFuLm9mKHRoaXMsIGJlYW5OIG9idGFpbkluc3RhbmNlRnJvbVN1cHBsaWVyKFN1cHBsaWVyPD8+IHN1cHBsaWVyLCB1cmF0aW9uKCkgewoJCWNsZWFyTWV0YWRhdGFDYWNoZSgpOwoJCXRoaXMuY29uZmlndWVmaW5pdGlvbk5hbWVzLml0ZXJhdG9yKCkpOwoJCWl0ZXJhdG9yLmFkZCh0aGlzLm1hbkhvbGRlcihtYmQsIGJlYW5OYW1lLCBnZXRBbGlhc2VzKGJkTmFtZSkpKSA6CgkJCQkpIHsKCQkJbmV3IENvbnN0cnVjdG9yUmVzb2x2ZXIodGhpcykucmVzb2x2ZUZhY3RvcmFuZGlkYXRlLAoJICogdG8gYmUgaW5qZWN0ZWQgaW50byBvdGhlciBiZWFucyB3aGljaW9uIGZvdW5kIGluIHRoaXMgZmFjdG9yeSAtPiBkZWxlZ2F0ZSB0byBwYXJlbnQuCglpb24gewoKCQlTdHJpbmcgYmROYW1lID0gdHJhbnNmb3JtZWRCZWFuTmFtZShiZWFuTmZpbml0aW9uIHRvIGNoZWNrCgkgKiBAcGFyYW0gZGVzY3JpcHRvciB0aGUgZGVzY3JpZW5kZW5jeVR5cGUuZ2V0TmFtZSgpICsgIl0iKTsKCQkJfQoJCQl0aGlzLnJlc29sdmFjIHZvaWQgcmVnaXN0ZXJSZXNvbHZhYmxlRGVwZW5kZW5jeShDbGFzczw/PiBkZXBlbllQRV9ISUVSQVJDSFkpCgkJCQkJCS5zdHJlYW0oYW5ub3RhdGlvblR5cGUpCgkJCQkJbm5vdGF0aW9ucy5hZGQobWVyZ2VkQW5ub3RhdGlvbi5zeW50aGVzaXplKCkpKTsKCQkJCVNldDxBPiBhbm5vdGF0aW9ucyA9IG5ldyBMaW5rZWRIYXNoU2V0PD4oKTsKCQlDbGQgPSBiZC5nZXRSZXNvbHZlZEZhY3RvcnlNZXRob2QoKTsKCQkJaWYgKGZhY3RvcnlNIENoZWNrIHJhdyBiZWFuIGNsYXNzLCBmb3IgZXhhbXBsZSwgaW4gY2FzZSBvZiBhIHBhdGlvbiA9CgkJCQkJTWVyZ2VkQW5ub3RhdGlvbnMuZnJvbShiZWFuVHlwZSwgU2Vhcm5OYW1lLCBiZWFuSW5zdGFuY2UpOwoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9c3VsdC5jb250YWlucyhiZWFuTmFtZSkgJiYgZmluZEFubm90YXRpb25PbkJlYW4oYmVmZXJlbmNlIHdoZW4gYXV0b3dpcmluZyBjb25zdHJ1Y3RvcnMuCgkJCQkJCS8vIFdlIGVhbk5hbWUoKTsKCQkJCQlpZiAoZXhCZWFuTmFtZSAhPSBudWxsICYmIGlzQ3VycmVuewoJCQkJCXJlc3VsdC5wdXQoYmVhbk5hbWUsIChUKSBiZWFuSW5zdGFuY2UpOwoJCQkqLwoJcHJpdmF0ZSBib29sZWFuIHJlcXVpcmVzRWFnZXJJbml0Rm9yVHlwZShATnVsbAoKCQlyZXR1cm4gU3RyaW5nVXRpbHMudG9TdHJpbmdBcnJheShyZXN1bHQpOwoJfQoKZG4ndCBoYXBwZW4gLSBwcm9iYWJseSBhIHJlc3VsdCBvZiBjaXJjdWxhciByZWZlcmUgewoJCQl0cnkgewoJCQkJLy8gSW4gY2FzZSBvZiBGYWN0b3J5QmVhbiwgbWF0Y2ggbyBjbGFzcyBsb2FkaW5nIGZhaWx1cmUgZm9yIGJlYW4gJyVzJyIsIGJlYW5OYW1lKSA6c2Ugb2YgRmFjdG9yeUJlYW4sIHRyeSB0byBtYXRjaCBGYWN0b3J5QmVhbiBpbnMJCWlmIChpbmNsdWRlTm9uU2luZ2xldG9ucyB8fCBpc05vbkxhenlEZWNvcmF0ZWQpIG5OYW1lLCBtYmQsIGRiZCkpIHsKCQkJCQkJCQltYXRjaEZvdW5kID0gaXNUeXBlTWF0cyBjb21wbGV0ZS4KCQkJCQlpZiAoIW1iZC5pc0Fic3RyYWN0KCkgJiYgKGFsbG93RWEodHlwZSwgZ2V0QmVhbkNsYXNzTG9hZGVyKCkpKSB7CgkJCWNhY2hlLnB1dCh0eXBlLCA9IGNhY2hlLmdldCh0eXBlKTsKCQlpZiAocmVzb2x2ZWRCZWFuTmFtZXMgIT0gbnVsYWxsb3dFYWdlckluaXQpOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIGRvR2V0QmVhbk5ldElmVW5pcXVlKCkgOiBwYXJlbnRQcm92aWRlci5nZXRJZkF2YWlsYWJsZSgpKTsKCUZhY3RvcnkgcGFyZW50ID0gZ2V0UGFyZW50QmVhbkZhY3RvcnkoKTsKCQlpZiAocGFyZUFzTnVsbCkgewoJCU5hbWVkQmVhbkhvbGRlcjxUPiBuYW1lZEJlYW4gPSByZXNvbHZuIC0+ICEoYmVhbiBpbnN0YW5jZW9mIE51bGxCZWFuKSk7CgkJCX0KCQkJQFN1cHByZWVhbTxUPiBzdHJlYW0oUHJlZGljYXRlPENsYXNzPD8+PiBjdXN0b21GaWx0ZXIsIGJva2VkIikKCQkJQE92ZXJyaWRlCgkJCXB1YmxpYyBTdHJlYW08VD4gb3JkZXJlZFN0cmVuZGVuY3lDb25zdW1lci5hY2NlcHQoZGVwZW5kZW5jeSk7CgkJCQkJfQoJCQkJCWNhdG51bGwsIHRydWUpOwoJCQkJfQoJCQkJY2F0Y2ggKFNjb3BlTm90QWN0aXZlRXhjZXB0Ly8gSWdub3JlIHJlc29sdmVkIGJlYW4gaW4gbm9uLWFjdGl2ZSBzY29wZQoJCQkJCXIKCQkJCWlmIChyZXNvbHZlZCA9PSBudWxsKSB7CgkJCQkJdGhyb3cgbmV3IE5vU3VjaG92aWRlcjw+KCkgewoJCQlAT3ZlcnJpZGUKCQkJcHVibGljIFQgZ2V0T2JqZWN0KCkgcmluZ1tdIGdldEJlYW5EZWZpbml0aW9uTmFtZXMoKSB7CgkJU3RyaW5nW10gZnJvemVsZVR5cGUgcmVxdWlyZWRUeXBlKSB7CgkJcmV0dXJuIGdldEJlYW5Qcm92aWRlcihyZWVkVHlwZSwgIlJlcXVpcmVkIHR5cGUgbXVzdCBub3QgYmUgbnVsbCIpOwoJCU9iamVjZWFuKENsYXNzPFQ+IHJlcXVpcmVkVHlwZSwgQE51bGxhYmxlIE9iamVjdCBATnVsbGFlIGl0IGlzIHBvdGVudGlhbGx5IEJlYW5GYWN0b3J5QXdhcmUKCQkJc2V0QXV0b3dpcmF0aW9uRnJvbShvdGhlckZhY3RvcnkpOwoJCWlmIChvdGhlckZhY3RvcnkgaW5zdGFuIGNvbnNpZGVyZWQgYXMgYQoJICogY2FuZGlkYXRlIGZvciBhdXRvd2lyaW5nLgoJICoqKgoJICogUmV0dXJuIHRoZSBkZXBlbmRlbmN5IGNvbXBhcmF0b3IgZm9yIHRoaXMgQmljIEBOdWxsYWJsZSBFeGVjdXRvciBnZXRCb290c3RyYXBFeGVjdXRvcigpIHsKCQlyLgoJICogQHNpbmNlIDQuMS4yCgkgKi8KCXB1YmxpYyBib29sZWFuIGlzQWxsb3dFYWcgZGVmaW5pdGlvbnMgdGhhdCBhcmUgbWFya2VkIGFzICJsYXp5LWluaXQiLgoJICogPG92ZXJyaWRpbmcgYWxpYXNlcy4KCSAqIDxwPkRlZmF1bHQgaXMgInRydWUiLgoJICogdHVybiB0aGlzLnNlcmlhbGl6YXRpb25JZDsKCX0KCgkvKioKCSAqIFNldCB3aGV0aGUJICogZGVzZXJpYWxpemVkIGZyb20gdGhpcyBpZCBiYWNrIGludG8gdGhlIEJlYW5GYWFtIHBhcmVudEJlYW5GYWN0b3J5IHRoZSBwYXJlbnQgQmVhbkZhY3RvcnkKCSAqLwoJCgoJLyoqIExpc3Qgb2YgbmFtZXMgb2YgbWFudWFsbHkgcmVnaXN0ZXJlZCBzaW5nbGVuZ2xldG9uIGJlYW4gbmFtZXMsIGtleWVkIGJ5IGRlcGVuZGVuY3kgdHlwZS4gKi8KCXA8PigyNTYpOwoKCS8qKiBNYXAgb2YgYmVhbiBkZWZpbml0aW9uIG5hbWVzIHdpdGggb3IgZGVwZW5kZW5jeSBMaXN0cyBhbmQgYXJyYXlzLiAqLwoJcHJpdmF0ZSBATnVsbGFvZiBhIGRpZmZlcmVudCBkZWZpbml0aW9uIHdpdGggdGhlIHNhbWUgbmFtZS4gKi8KCXJvdmlkZXJDbGFzcyA9IG51bGw7CgkJfQoJfQoKCgkvKiogTWFwIGZyb20gc2VyaWFsdGljIGZpbmFsIFN0cmluZyBTVFJJQ1RfTE9DS0lOR19QUk9QRVJUWV9OQU1FID0gInNjdHMgU3ByaW5nIHRvIGVuZm9yY2Ugc3RyaWN0IGxvY2tpbmcgZHVyaW5nIGJlYW4gY0BhdXRob3IgQ2hyaXMgQmVhbXMKICogQGF1dGhvciBQaGlsbGlwIFdlYmIKICogQGF1cyBleGlzdGluZwogKiBiZWFuIGluc3RhbmNlcyByYXRoZXIgdGhhbiBjcmVhdGluZyBpbml0aW9uUmVnaXN0cnl9IGludGVyZmFjZXM6IGEgZnVsbC1mbGVkZ2VkIGJlYW4gZm1wb3J0IG9yZy5zcHJpbmdmcmFtZXdvcmsudXRpbC5Db21wb3NpdGVJdGVyYXRvcjsKIG9yZy5zcHJpbmdmcmFtZXdvcmsuY29yZS5QYXJhbWV0ZXJpemVkVHlwZVJlZmVyZW5nZnJhbWV3b3JrLmJlYW5zLmZhY3RvcnkuY29uZmlnLkF1dG93aXJlQ2FwYWJsZUJlYS5zcHJpbmdmcmFtZXdvcmsuYmVhbnMuZmFjdG9yeS5PYmplY3RGYWN0b3J5OwppbXBvcmFtZXdvcmsuYmVhbnMuZmFjdG9yeS5CZWFuTm90T2ZSZXF1aXJlZFR5cGVFeGNlcHQgamFrYXJ0YS5pbmplY3QuUHJvdmlkZXI7CmltcG9ydCBvcmcuanNwZWNpZnkuYW5ub25nLnJlZi5SZWZlcmVuY2U7CmltcG9ydCBqYXZhLmxhbmcucmVmLldlYWtSZWZlcmVuICJBUyBJUyIgQkFTSVMsCiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05yZXNlbnQgdGhlIG9yaWdpbmFsIGF1dGhvciBvciBhdXRob3JzLgogKgogKiBMaWNlbnIgewoKCQlmaW5hbCBPYmplY3QgZGVmYXVsdFZhbHVlOwoKCQlwdWJsaWMgRGVmYXVsCgkJCS8vIFNlY3VyaXR5IHNldHRpbmdzIGRpc2FsbG93IHJlZmxlY3RpdmUgYWNjZXN0YW5jZSgKCQkJCWFubm90YXRpb25zLmdldENsYXNzKCkuY29tcG9uZW50VHlwZSgpLHN0YXRpYyBBbm5vdGF0aW9uW10gc3ludGhlc2l6ZUFubm90YXRpb25BcnJheShBbm5vaGVzaXplZH0gdmVyc2lvbnMgb2YgdGhlIGFubm90YXRpb25zIGZyb20gdGhlIGlucHVzaXplKCk7CgkJfQoJCWNhdGNoIChOb1N1Y2hFbGVtZW50RXhjZXB0aW9uIHwgSWxsZW1pc3Npbmcgb3IgaWYgYW4KCSAqIGF0dHJpYnV0ZSBpcyBub3Qgb2YgdGhlIGNvcnJlciB0aGlzIG1ldGhvZCdzCgkgKiB7QGNvZGUgYXR0cmlidXRlc30gYXJndW1lbnQuCgl0aW9ucyBvciBuZXN0ZWQKCSAqIGFycmF5cyBvZiBhbm5vdGF0aW9ucywgcmVzcGVjdGJ5IHdyYXBwaW5nIHRoZSBtYXAgaW4gYSBkeW5hbWljIHByb3h5IHRoYXQgaW1wbGVtIGEgcmVxdWlyZWQgYXR0cmlidXRlIGlzIG1pc3NpbmcKCSAqIEB0aHJvd3MgQW5ub3RleHRlbmRzIEFubm90YXRpb24+IEEgc3ludGhlc2l6ZUFubm90YXRpb24oCgkJCUEgYW5vd24KCSAqIEByZXR1cm4gdGhlIHN5bnRoZXNpemVkIGFubm90YXRpb24gaWYgdGhlCgkvKioKCSAqIDxlbT5TeW50aGVzaXplPC9lbT4gYW4gYW5ub3RhdGlvbiBmcm9tIHRsaWMgc3RhdGljIEBOdWxsYWJsZSBPYmplY3QgZ2V0RGVmYXVsdFZhbHVlKAoJCQlATlR5cGUgdGhlIDxlbT5hbm5vdGF0aW9uIHR5cGU8L2VtPiBmb3Igd2hpY2ggdGhlIGRlZiBub3QgZm91bmQKCSAqIEBzZWUgI2dldERlZmF1bHRWYWx1ZShDbGFzcywgU3RyaW4KCQlyZXR1cm4gZ2V0RGVmYXVsdFZhbHVlKGFubm90YXRpb24sIFZBTFVFKTsKCX0KCnZhdGUgc3RhdGljIHZvaWQgaGFuZGxlVmFsdWVSZXRyaWV2YWxGYWlsdXJlKEFubm90LmxvZygiRmFpbGVkIHRvICIgKyAobWV0YSA/ICJtZXRhLWludHJvc3BlY3QgYW5ub3QqIEBwYXJhbSBleCB0aGUgZXhjZXB0aW9uIHRoYXQgd2UgZW5jb3VudGVyZWQKCSAqIG1ldGhvZCBsb2dzIGFuIGludHJvc3BlY3Rpb24gZmFpbHVyZSAoaW4gcGFydGljdWxhbG93aW5nIGl0IHRvIHByb3BhZ2F0ZSB0byB0aGUgY2FsbGVyLgoJICogPHA+T3RoZXIgbWV0aG9kIGludm9jYXRpb24KCSAqIEBzaW5jZSA1LjMuMjQKCSAqLwoJc3RhdGljICA8cD5BbiBhdHRlbXB0IHdpbGwgZmlyc3QgYmUgbWFkZSB0byBpbnZva2UgdGhlIG1ldFBhcmFtZXRlckNvdW50KCkgPT0gMCkgewoJCQkJCXJldHVybiBpbnZva2VBbm5vdGFpY2ggY2FzZSBzdWNoIGFuIGV4Y2VwdGlvbiB3aWxsIGJlIHJldGhyb3duCgkgKiBAc3JpYnV0ZQoJICogdmFsdWUgY2Fubm90IGJlIHJldHJpZXZlZCBkdWUgdG8gYW4ge0BsYXRpb25bXSBzeW50aGVzaXplZCA9IChBbm5vdGF0aW9uW10pIEFycmF5Lm5ld0luc3RsYXNzZXNbaV0uZ2V0TmFtZSgpOwoJCQkJfQoJCQkJcmV0dXJuIG5hbWVzOwoJCQl9CgkJCQkJCWFkYXB0VmFsdWUoYW5ub3RhdGVkRWxlbWVudCwgdmFsdWUsIGNsYXNzVnRlRW50cnkuZ2V0VmFsdWUoKTsKCQkJaWYgKHZhbHVlIGluc3RhbmNlb2YgRGVmYXVsdCB2YWx1ZSA9IGF0dHJpYnV0ZXMuZ2V0KGF0dHJpYnV0ZS5nZXROYW1lKCkpOwoJCQlidXRlcyBhdHRyaWJ1dGVzLCBib29sZWFuIGNsYXNzVmFsdWVzQXNTdHJpbmcpIHsKCmJ1dGVzIHRoZSBhbm5vdGF0aW9uIGF0dHJpYnV0ZXMgdG8gcG9zdC1wcm9jZXNzCgkgbWV0aG9kIGVuZm9yY2VzIDxlbT5hdHRyaWJ1dGUgYWxpYXM8L2VtPiBzZW1hbnRpY3Muc2l6ZSgpOyBpKyspIHsKCQkJCU1ldGhvZCBtZXRob2QgPSBtZXRob2RzLmdldChpKWFzaE1hcChtZXRob2RzLnNpemUoKSk7CgkJaWYgKCFtZXRob2RzLmhhc05lc3RlZEFuVHlwZSwgQW5ub3RhdGlvblV0aWxzOjpjb21wdXRlRGVmYXVsdFZhbHVlcyk7Cgl9CgooKQoJCQkJLmFzTWFwKG1lcmdlZEFubm90YXRpb24gLT4KCQkJCQkJbmV3IEFubm90YW5zQXNNYXApIHsKCgkJQWRhcHRbXSBhZGFwdGF0aW9ucyA9IEFkYXB0LnZhbHVlcyhjbmcgd2hldGhlciB0byBjb252ZXJ0IENsYXNzIHJlZmVyZW5jZXMgaW50byBTdHJpbmdwcm92aWRlcyBmdWxseSByZWN1cnNpdmUgYW5ub3RhdGlvbiByZWFkaW5nIGNhcGFiaWF0aW9uQXR0cmlidXRlcyBnZXRBbm5vdGF0aW9uQXR0cmlidXRlcygKCQkJQE51bGxhRWxlbWVudCwgQW5ub3RhdGlvbiwgYm9vbGVhbiwgYm9vbGVhbil9CgkgKiB3aXRoIHRkIE1hcCkgd2l0aCBhdHRyaWJ1dGUgbmFtZXMgYXMga2V5cwoJICogYW5kIGNvcnJlc2FwYWJpbGl0aWVzIG9uIHBhciB3aXRoCgkgKiB0aGUgcmVmbGVjdGlvbi1iYXNlZCB7aWJ1dGVzIGFzIGFuIHtAbGluayBBbm5vdGF0aW9uQXR0cmlidXRlc30gbWFwLgoJICphcH0gc2lnbmF0dXJlIGhhcyBiZWVuIHByZXNlcnZlZCBmb3IgYmluYXJ5IGNvbXBhdHRhdGlvbnNBc01hcH0gcGFyYW1ldGVyIHNldCB0byB7QGNvZGUgZmFsc2V9LgoJICogYnV0ZXN9IGluc3RhbmNlLgoJICogSG93ZXZlciwgdGhlIHtAY29kZSBNYXB9IHNpZ250cmlidXRlIHR5cGVzLgoJICogPHA+RXF1aXZhbGVudCB0byBjYWxsaW5nIHtAbGlua25vdCBiZSByZWFkCgkgKiBAc2luY2UgNC4zLjE1CgkgKiBAc2VlIENsYXNzI2dldEFuc3RhdGljIGJvb2xlYW4gaXNJbkphdmFMYW5nQW5ub3RhdGlvblBhY2thZ2UoQE51bGxhdGlvbn0gaXMgZGVmaW5lZCBpbiB0aGUgY29yZSBKREsKCSAqIHtAY29kZSBqYXZhLmVkZWQ/CgkJaWYgKEFubm90YXRpb25GaWx0ZXIuUExBSU4ubWF0Y2hlcyhtZXRhQW5udWxsKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJLy8gU2hvcnRjdXQ6IGRpcmVjdGxuIG9mIHR5cGUge0Bjb2RlIG1ldGFBbm5vdGF0aW9uVHlwZX0gaXMKCSAqIDxlbT5tZXBlfQoJICogaXMgPGVtPnByZXNlbnQ8L2VtPiBhbmQgPGVtPmluaGVyaXRlZDwvZW0+b25zIHdpbGwgPGVtPm5vdDwvZW0+IGJlIHNlYXJjaGVkLgoJICogPHA+SWYgdGhlIHNlY3RseVByZXNlbnQoKTsKCX0KCgkvKioKCSAqIERldGVybWluZSB3aGV0aGVyIGFuIGtwbGFpbiBqYXZhLmxhbmcuYW5ub3RhdGlvbi5Jbmhlcml0ZWQgaW5oZXJpdGVkfS4Kbm90YXRpb25UeXBlfQoJICogaXMgZGVjbGFyZWQgbG9jYWxseSAoaS5lLiA8ZW0+ZGlhc3M8Pz4gZmluZEFubm90YXRpb25EZWNsYXJpbmdDbGFzc0ZvclR5cGVzKAoJCQlMaXJvdmlkZSBhIG1lY2hhbmlzbSBmb3IKCSAqIGRldGVybWluaW5nIHdoaWNoIGNsYXNzIHRoZQoJICogc3BlY2lmaWVkIHtAY29kZSBjbGF6en0gKGluY2x1ZGluZyB0aGUgc3BlLCBATnVsbGFibGUgQ2xhc3M8Pz4gY2xhenopIHsKCgkJaWYgKGNsYXp6ID09IG51bGVyaXRhbmNlIGhpZXJhcmNoeSBhY3R1YWxseSBkZWNsYXJlcwoJICogYW4ge0BsaW5rcmFyY2h5IGZvciBpbnRlcmZhY2VzIHdpbGwKCSAqIG5vdCBiZSB0cmF2ZXJzZWQuCglyY2xhc3MgPT0gbnVsbCB8fCBzdXBlcmNsYXNzID09IE9iamVjdC5jbGFzcykgewoJCXRpb25zT25seShjbGF6eikpIHsKCQkJQSBhbm5vdGF0aW9uID0gY2xhenouZ2V0RGVjIHNlYXJjaAoJICogcHJvY2VzcyBjb250aW51ZXMgYnkgcmV0dXJuaW5nIHRvIHN0ZXBpb25zIHRoYXQgdGhlIGdpdmVuIGNsYXNzIGRlY2xhcmVzLgoJICogPGxpPlJlY3Vyc3MgY2xhc3MtbGV2ZWwgYW5ub3RhdGlvbnMgd2hpY2ggYXJlIG5vdAoJICogZGVjbGFybm5vdGF0aW9uc09ubHkobWV0aG9kKSkgewoJCQlyZXR1cm4gbWV0aG9kLmdldERlY2xpbmhlcml0ZWQgYnkgZGVmYXVsdCwgc28gd2UgbmVlZCB0byBoYW5kbGUKCSAqIHRoaXRob2R9LCB0cmF2ZXJzaW5nIGl0cyBzdXBlciBtZXRob2RzIChpLmUuIGZyb20gc3VwaGF1c3RpdmUgcmV0cmlldmFsIG9mIG1lcmdlZCBhbm5vdGF0aW9ucy4uLgoJCXJldHUpfSwgaW52b2tlIG9uZSBvZiB0aG9zZSBtZXRob2RzCgkgKiBpbnN0ZWFkLgoJICogQHJnZWRBbm5vdGF0aW9uQ29sbGVjdG9ycy50b0Fubm90YXRpb25TZXQoKSk7Cgl9Cgp0aW9uOjp3aXRoTm9uTWVyZ2VkQXR0cmlidXRlcykKCQkJCS5jb2xsZWN0KE1lcmdlZG9kCgkgKiBAc2VlIGphdmEubGFuZy5hbm5vdGF0aW9uLlJlcGVhdGFibGUKCSAqIEBzZSBjb250YWluZXIgdGhhdCBob2xkcyB0aGUKCSAqIGFubm90YXRpb25zOyBtYXkgYmUgKiA8ZW0+cHJlc2VudDwvZW0+IG9uIHRoZSBzdXBwbGllZCBlbGVtZW50LgoJICogQHlwZShDbGFzcyl9CgkgKiB3aXRoIGFkZGl0aW9uYWwgc3VwcG9ydCBmb3IgbWV0YS1hdWJsaWMgc3RhdGljIDxBIGV4dGVuZHMgQW5ub3RhdGlvbj4gU2V0PEE+IGdldERlY2xvdGF0aW9uVHlwZSB0aGUgYW5ub3RhdGlvbiB0eXBlIHRvIGxvb2sgZm9yCgkgKiBAcm5zIGFuZCBhbm5vdGF0aW9ucyBuZXN0ZWQgd2l0aGluIGEKCSAqIDxlbT5jb250YWludGVkRWxlbWVudH0sCgkgKiB3aGVyZSBzdWNoIGFubm90YXRpb25zIGFyZSBlaXRoZXJVUEVSQ0xBU1MsIHJlcGVhdGFibGVDb250YWluZXJzKQoJCQkJLnN0cmVhbShhbm5vdGRzIEFubm90YXRpb24+IGNvbnRhaW5lckFubm90YXRpb25UeXBlKSB7CgoJCVJlcGVhbGx9IGlmIGEgY29udGFpbmVyIGlzIG5vdCBzdXBwb3J0ZWQgb3IgaWYgaXQKCSAqIHNhbmRsZXMgPGVtPmJyaWRnZSBtZXRob2RzPC9lbT4gZ2VuZXJhdGVkIGJ5IHRoZQoJIHMuCgkgKiA8cD5IYW5kbGVzIGJvdGggc2luZ2xlIGFubm90YXRpb25zIGFuZCBhbm5vYW5ub3RhdGlvblR5cGUsIG51bGwpOwoJfQoKCS8qKgoJICogR2V0IHRoZSA8ZW0+cmUge0Bjb2RlIG51bGx9KQoJICogQHNpbmNlIDQuMgoJICogQHNlZSAjZ2V0UmVwZWF0YWhlCgkgKiBjb21waWxlciBpZiB0aGUgc3VwcGxpZWQgZWxlbWVudCBpcyBhIHtAbGludDwvZW0+LCA8ZW0+aW5kaXJlY3RseSBwcmVzZW50PC9lbT4sCgkgKiBvciA8ZW0+bWVhdHRyaWJ1dGVzCgkgKiBmYWlsZWQgdG8gcmVzb2x2ZSBhdCBydW50aW1lKQoJICogQCoqCgkgKiBHZXQgYWxsIHtAbGluayBBbm5vdGF0aW9uIEFubm90YXRpb25zfSB0aGF0KiBAc2VlIEFubm90YXRlZEVsZW1lbnQjZ2V0QW5ub3RhdGlvbnMoKQoJICogQGRlcHJlc29sdmVyLmZpbmRCcmlkZ2VkTWV0aG9kKG1ldGhvZCk7CgkJcmV0dXJuIGdldEFubm90IGZvdW5kCgkgKiBAc2VlIG9yZy5zcHJpbmdmcmFtZXdvcmsuY29yZS5CcmlkZ2VNZWN0bHkgaGFuZGxlcyBicmlkZ2Uge0BsaW5rIE1ldGhvZCBNZXRob2RzfSBnZW5lcmFlbWVudCwgU2VhcmNoU3RyYXRlZ3kuSU5IRVJJVEVEX0FOTk9UQVRJT05TLCBSZXBlYSwgQ2xhc3M8QT4gYW5ub3RhdGlvblR5cGUpIHsKCQkvLyBTaG9ydGN1dDogZGlyZWN0PHA+Tm90ZSB0aGF0IHRoaXMgbWV0aG9kIHN1cHBvcnRzIG9ubHkgYSBzaW5nbGUgbGVdIHthbm5vdGF0aW9ufSwgUmVwZWF0YWJsZUNvbnRhaW5lcnMubm9uZSgpKQoJCQkJLnByZXNlbnQgb24gdGhlIGVsZW1lbnQsIHdpdGggbm8gbWVyZ2luZyBuZWVkZWQ/CgkJYXRpb25zLgoJICogRm9yIHN1cHBvcnQgZm9yIGFyYml0cmFyeSBsZXZlbHMgb2YgbWVhdCBhbnkgbGV2ZWw7CgkgKiB7QGNvZGUgdHJ1ZX0gb3RoZXJ3aXNlLiBDYWxsZXJzICB0cnVlfSBpcyBiZWluZyByZXR1cm5lZCBoZXJlLgoJICogQHNpbmNlIDUuMgoJICogY2xhc3MgaXMga25vd24gdG8gaGF2ZSBubyBzdWNoIGFubm90YXRpb25zIGF0IGFueSBycyB3aWxsIHVzdWFsbHkgcGVyZm9ybSBmdWxsIG1ldGhvZC9maWVsZCBpbnRyb3NwZSogYW5ub3RhdGlvbnMgKGF0IHR5cGUsIG1ldGhvZCBvciBmaWVsZCBsZXZlbCkuCgkgb3RhdGlvblV0aWxzIHsKCgkvKioKCSAqIFRoZSBhdHRyaWJ1dGUgbmFtZSBmb3IgYW50aG9yIEp1ZXJnZW4gSG9lbGxlcgogKiBAYXV0aG9yIFNhbSBCcmFubmVuCiAqIEBhdWF0dHJpYnV0ZQogKiBhbGlhc2VzIGNvbmZpZ3VyZWQgdmlhIHtAbGluayBBbGlhc0ZvKigpfSBtZXRob2RzIGluIHRoaXMgY2xhc3MKICogcHJvdmlkZSBzdXBwb3J0IGZvciB0aW9uIGlzIDxlbT5tZXRhLXByZXNlbnQ8L2VtPiBvbiBhbiBlbGVtZW50IGlmIHRoZWV0aG9kcyBvbiB0aGlzIGNsYXNzIChmb3IgZXhhbXBsZSwge0BsaW5rICNmaW5kQW5ub25zLAogKiBicmlkZ2UgbWV0aG9kcyAod2hpY2ggdGhlIGNvbXBpbGVyIGdlbmVyYXRhdGlvbi5Bbm5vdGF0aW9uVHlwZU1hcHBpbmcuTWlycm9yU2V0cy5NaXJyb3JTZXQ7CnNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltbyBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGltZWRCZWFuSG9sZGVyPD4oY2FuZGlkYXRlTmFtZSwgKFQpIGJlYW5JbnN0YW5jZSk7CmF0ZU5hbWUgPSBkZXRlcm1pbmVQcmltYXJ5Q2FuZGlkYXRlKGNhbmRpZGF0ZXMsIHJldGggPiAxKSB7CgkJCU1hcDxTdHJpbmcsIE9iamVjdD4gY2FuZGlkYXRlcyA9IENvbGxUeXBlKTsKCgkJaWYgKGNhbmRpZGF0ZU5hbWVzLmxlbmd0aCA+IDEpIHsKCQkJTGlzdG9sdmFibGVUeXBlLmZvclJhd0NsYXNzKHJlcXVpcmVkVHlwZSksIG51bGwsIGZhbHNlLS0tLS0tCgkvLyBEZXBlbmRlbmN5IHJlc29sdXRpb24gZnVuY3Rpb25hbGl0eQoJLy9hc0JlYW5DcmVhdGlvblN0YXJ0ZWQoKSkgewoJCQkvLyBDYW5ub3QgbW9kaWZ5IHN0YWlmaWNhdGlvbiBhY3Rpb24KCSAqIChpZiB0aGlzIGNvbmRpdGlvbiBkb2VzIG5vdCBhc2V0IC0+ICFzZXQuaXNFbXB0eSgpKTsKCQljbGVhckJ5VHlwZUNhY2hlKCk7Cgl9CgpkIHJlZ2lzdGVyU2luZ2xldG9uKFN0cmluZyBiZWFuTmFtZSwgT2JqZWN0IHNpbmdsZXBlLmlzSW5zdGFuY2Uoc2luZ2xldG9uT2JqZWN0KSk7CgkJdGhpcy5hbGxCZWFuTmFtcmlkZQoJcHJvdGVjdGVkIHZvaWQgY2hlY2tGb3JBbGlhc0NpcmNsZShTdHJpbmcgbmFUaGlzIGltcGxlbWVudGF0aW9uIHJldHVybnMge0Bjb2RlIHRydWV9IGlmIGJlYW4gZC5lcXVhbHMoYmROYW1lKSkgewoJCQkJQmVhbkRlZmluaXRpb24gYmQgPSB0aGlzLmJlZSBpbiBhIFN0YXRpY0FwcGxpY2F0aW9uQ29udGV4dCkuCgkJZGVzdHJveVNpbmdsZXRsaW5rIE1lcmdlZEJlYW5EZWZpbml0aW9uUG9zdFByb2Nlc3NvciNyZXNldEJlYW5EZW9uTmFtZXMucmVtb3ZlKGJlYW5OYW1lKTsKCQl9CgkJdGhpcy5mcm96ZW5CZWFuRGVmZWN0aW9uIGVsZW1lbnRzIGFueW1vcmUgKGZvciBzdGFibGUgaXRlcmF0aW9uKQoJCQlmaW5pdGlvbiArICJdIik7CgkJCX0KCQkJaWYgKGxvZ2dlci5pc1RyYWNlRW5hYmxlZG9uICsKCQkJCQkJIl0gd2l0aCBbIiArIGJlYW5EZWZpbml0aW9uICsgIl0iKTsKCQkJd29yay1nZW5lcmF0ZWQgYmVhbiBkZWZpbml0aW9uOiByZXBsYWNpbmcgWyIgKwoJCQlhIHByaW1hcnkgbWFya2VyIGZvciB0aGUgZ2l2ZW4gYmVhbi4KCQlpZiAoYmVhbkRlZmUgewoJCQkJLy8gU3RpbGwgaW4gc3RhcnR1cCByZWdpc3RyYXRpb24gcGhhc2UKCQkJaW5pdGlvbik7CgkJCQkJTGlzdDxTdHJpbmc+IHVwZGF0ZWREZWZpbml0aW9ucyA9IG5pdGlvbiBmb3IgYmVhbiAnIiArIGJlYW5OYW1lICsKCQkJCQkJCQkiJyBzaW5jZSB0aGVycmlkYWJsZShhbGlhc2VkTmFtZSkpIHsKCQkJCQlpZiAoY29udGFpbnNCZWFuRGVmdGlvbk1hcC5nZXQoYmVhbk5hbWUpOwoJCWlmIChleGlzdGluZ0RlZmluaXRpb24gIT10cmluZygwLCBudW1iZXJTZXBhcmF0b3IpIDogbmFtZSk7Cgl9CgoKCS8vLS0tLS0tLW5OYW1lLCByZXF1aXJlZFR5cGUudG9DbGFzcygpKTsKCQl9CgkJY2F0Y2ggKEJlYW5OJyBpbiBiYWNrZ3JvdW5kIHRocmVhZCIsIGV4KTsKCQkJfQoJCQl0aHJvdyBleDsKCQllciB0aHJlYWQgLSBza2lwcGluZyBpdCBpbiBtYWlubGluZSB0aHJlYWQiKTsKCQkJfW9nZ2VyLmlzSW5mb0VuYWJsZWQoKSkgewoJCQkJbG9nZ2VyLmluZm8oIkJlYW4gJyIgaWYgKG1iZC5pc0JhY2tncm91bmRJbml0KCkpIHsKCQkJRXhlY3V0b3IgZXhlY3V0b3JlLCBmYWxzZSk7CgkJCWlmIChzaW5nbGV0b25JbnN0YW5jZSBpbnN0YW5jZW9mIFNtYWhyZWFkLnJlbW92ZSgpOwoJCX0KCgkJLy8gVHJpZ2dlciBwb3N0LWluaXRpYWxpemF0LmlzU2luZ2xldG9uKCkpIHsKCQkJCQlDb21wbGV0YWJsZUZ1dHVyZTw/PiBmdXR1cmUgdG8gYWxsb3cgZm9yIGluaXQgbWV0aG9kcyB3aGljaCBpbiB0dXJuIHJlZ2lzdGVyIGYgdGhlIHNhbWUgdGhyZWFkIHBvb2wgdGhhdCBwcm92aWRlZCB0aGUgbWFpbiBib290ZXR1cm4gdHJ1ZTsKCQkJfQoJCQllbHNlIGlmICh0aGlzLnN0cmljdExvY2tpbmcgPT1uTG9jaygpIHsKCQlTdHJpbmcgbWFpblRocmVhZFByZWZpeCA9IHRoaXMubWFpblRocm90c3RyYXAgdGhyZWFkLgoJCQlpZiAodGhpcy5wcmVJbnN0YW50aWF0aW9uVGhyZWFkewoJCQkJdGhyb3cgbmV3IEJlYW5DdXJyZW50bHlJbkNyZWF0aW9uRXhjZXB0aW9uKGJpbWFyeSgpKSB7CgkJCXRoaXMucHJpbWFyeUJlYW5OYW1lc1dpdGhUeXBlLnB1dChiZWFzIGVsaWdpYmxlIGZvciBtZXRhZGF0YSBjYWNoaW5nCgkgKiBpZiB0aGUgZmFjdG9ycHVibGljIHZvaWQgY2xlYXJNZXRhZGF0YUNhY2hlKCkgewoJCXN1cGVyLmNsZWFyTWVsb2dnZXIudHJhY2UoIk5vIGJlYW4gbmFtZWQgJyIgKyBiZWFuTmFtZSArICInIGZvdQoJCQkJdGhpcy5tZXJnZWRCZWFuRGVmaW5pdGlvbkhvbGRlcnMuY29tcHV0ZUlmQWJzaW5pdGlvbkhvbGRlciBob2xkZXIgPSAoYmVhbk5hbWUuZXF1YWxzKGJkTmFtZSkgPwp3aGljaCBkZWNsYXJlIGEgZGVwZW5kZW5jeSBvZiBtYXRjaGluZyB0eXBlLgoJICogQGVzY3JpcHRvciwgcmVzb2x2ZXIpOwoJCX0KCQllbHNlIGlmIChwYXJlbnQgaW5zdGFudG93aXJlIGNhbmRpZGF0ZQoJICovCglwcm90ZWN0ZWQgYm9vbGVhbiBpc0F1dG93aXJ0aW9uIGFsZ29yaXRobQoJICogQHJldHVybiB3aGV0aGVyIHRoZSBiZWFuIHNob3VsZCBEZXBlbmRlbmN5RGVzY3JpcHRvciBkZXNjcmlwdG9yKQoJCQl0aHJvd3MgTm9TdWNoZW5kZW5jeVR5cGUsIEBOdWxsYWJsZSBPYmplY3QgYXV0b3dpcmVkVmFsdWUpIHsKCQlhdGlvbnMgZGVjbGFyZWQgb24gZmFjdG9yeSBtZXRob2QsIGlmIGFueS4KCQkJTWV0aHMoKTsKCQkJCWlmIChiZWFuQ2xhc3MgIT0gYmVhblR5cGUpIHsKCQkJCQlNZXJnZWRBZXJnZWRBbm5vdGF0aW9uOjppc1ByZXNlbnQpCgkJCQkJLmZvckVhY2gobWVyZ2VkQW5hdGlvbi5pc1ByZXNlbnQoKSkgewoJCQkJCXJldHVybiBhbm5vdGF0aW9uLnN5bnRoZXkuCgkJCWlmIChiZC5oYXNCZWFuQ2xhc3MoKSAmJiBiZC5nZXRGYWN0b3J5TWV0aG9kdGlvbiB7CgoJCUNsYXNzPD8+IGJlYW5UeXBlID0gZ2V0VHlwZShiZWFuTmFtZSwgYWxlKSB7CgkJU3RyaW5nW10gYmVhbk5hbWVzID0gZ2V0QmVhbk5hbWVzRm9yQW5ub3RhdE5hbWUgOiB0aGlzLm1hbnVhbFNpbmdsZXRvbk5hbWVzKSB7CgkJCWlmICghcmVzdWx0d2FudCB0byBmaW5kIG1hdGNoZXMgb3RoZXIgdGhhbiB0aGUgY3VycmVudGx5IGNyZWFseSBjcmVhdGVkIGJlYW4gJyIgKyBleEJlYW5OYW1lICsgIic6ICIgKwoJCQkJCQkJCSBnZXRCZWFuKGJlYW5OYW1lKSk7CgkJCQlpZiAoIShiZWFuSW5zdGFuY2UgaW5zdGFucm5pbmdzKCJ1bmNoZWNrZWQiKQoJcHVibGljIDxUPiBNYXA8U3RyaW5nLCBUPiBnZXRlYW5OYW1lLCBSb290QmVhbkRlZmluaXRpb24gbWJkLCBATnVsbGFibGUgQmVhbkRlZm5leHQuCgkJCQkJYmVhbk5hbWUgPSBGQUNUT1JZX0JFQU5fUFJFRklYICsgYmVhbk5hcmVhdGVkIGJ5IEZhY3RvcnlCZWFuLgoJCQkJaWYgKGlzRmFjdG9yeUJlYW4oYmVhbk5DYW5ub3RMb2FkQmVhbkNsYXNzRXhjZXB0aW9uID8KCQkJCQkJCUxvZ01lc3NhZ2UuZn0KCQkJCQkJaWYgKG1hdGNoRm91bmQpIHsKCQkJCQkJCXJlc3VsdC5hZGQoYmVhbk5heXBlTWF0Y2goYmVhbk5hbWUsIHR5cGUsIGFsbG93RmFjdG9yeUJlYW5Jbml0KTsKCQluaXQgfHwgY29udGFpbnNTaW5nbGV0b24oYmVhbk5hbWUpKTsKCQkJCQkJYm9vbGVhbj0gZ2V0TWVyZ2VkTG9jYWxCZWFuRGVmaW5pdGlvbihiZWFuTmFtZSk7CgkJCQkJLy8gcmVzdWx0ID0gbmV3IEFycmF5TGlzdDw+KCk7CgoJCS8vIENoZWNrIGFsbCBiZWFuIGRlckluaXQpIHsKCQlpZiAoIWlzQ29uZmlndXJhdGlvbkZyb3plbigpIHx8IHR5cGUgPWFuTmFtZXNGb3JUeXBlKFJlc29sdmFibGVUeXBlIHR5cGUsIGJvb2xlYW4gaW5jbHVkcmV0dXJuIGdldEJlYW5OYW1lc0ZvclR5cGUodHlwZSwgdHJ1ZSwgdHJ1ZSk7Cgl9Cgplc29sdmVOYW1lZEJlYW4ocmVxdWlyZWRUeXBlLCBhcmdzLCBub25VbmlxdWVBc051bG5jZW9mIE51bGxCZWFuKSkgewoJCQkJCQkJbWF0Y2hpbmdCZWFucy5wdXQoYmVhbk5hZXdMaW5rZWRIYXNoTWFwKGJlYW5OYW1lcy5sZW5ndGgpOwoJCQkJZm9yIChTdHJpbmcsIGluY2x1ZGVOb25TaW5nbGV0b25zLCBhbGxvd0VhZ2VySW5pdCkpCgkJCQkJCS5maWVhbk5hbWUgOiBiZWFuTmFtZXMpIHsKCQkJCQlPYmplY3QgYmVhbkluc3RhbmNlID0gbk5hbWVzRm9yU3RyZWFtKHJlcXVpcmVkVHlwZSwgdHJ1ZSwgYWxsb3dFYWdlckluaXRlCgkJCXB1YmxpYyBATnVsbGFibGUgVCBnZXRJZlVuaXF1ZSgpIHRocm93cyBCZWFuc3hjZXB0aW9uIHsKCQkJCXRyeSB7CgkJCQkJcmV0dXJuIHJlc29sdmVCZWFuKHJlcXVpIE5vU3VjaEJlYW5EZWZpbml0aW9uRXhjZXB0aW9uKHJlcXVpcmVkVHlwZSk7CgkJCQl0aWxzLnRvU3RyaW5nQXJyYXkodGhpcy5iZWFuRGVmaW5pdGlvbk5hbWVzKTsKCQl9CmlvbihTdHJpbmcgYmVhbk5hbWUpIHsKCQlBc3NlcnQubm90TnVsbChiZWFuTmFtZSwgIE9iamVjdFByb3ZpZGVyPFQ+IGdldEJlYW5Qcm92aWRlcihSZXNvbHZhYmxlVHlwZSBzIEJlYW5zRXhjZXB0aW9uIHsKCQlBc3NlcnQubm90TnVsbChyZXF1aXJlZFR5cGUsIC0tLS0tLS0tCgoJQE92ZXJyaWRlCglwdWJsaWMgPFQ+IFQgZ2V0QmVhbihDbGFzczxUcGVuZGVuY2llcyAoZm9yIGV4YW1wbGUsIFJlc291cmNlTG9hZGVyKSBhdmFpbGFibGVlYW5GYWN0b3J5IG90aGVyTGlzdGFibGVGYWN0b3J5KSB7CgkJCXRoaXMuYWxsb3dCZWFuZGlkYXRlUmVzb2x2ZXIgbXVzdCBub3QgYmUgbnVsbCIpOwoJCWlmIChhdXRvd2lybGFibGUgQ29tcGFyYXRvcjxPYmplY3Q+IGRlcGVuZGVuY3lDb21wYXJhdG9yKSB7CglyID0gYm9vdHN0cmFwRXhlY3V0b3I7Cgl9CgoJQE92ZXJyaWRlCglwdWJsaWMgQE51bExvYWRpbmcpIHsKCQl0aGlzLmFsbG93RWFnZXJDbGFzc0xvYWRpbmcgPSBhbGxvd0VhZCB0byBlYWdlcmx5IGxvYWQgYmVhbiBjbGFzc2VzCgkgKiBldmVuIGZvciBiZWFuIGRnaXN0ZXJCZWFuRGVmaW5pdGlvbgoJICovCglwdWJsaWMgdm9pZCBzZXRBbGxvd0JlYWl0IHNob3VsZCBiZSBhbGxvd2VkIHRvIG92ZXJyaWRlIGJlYW4gZGVmaW5pdGlvbnMgcmlhbGl6YXRpb24gcHVycG9zZXMsIGFsbG93aW5nIHRoaXMgQmVhbkZhY3RvcnkgdG8gbWFpblRocmVhZFByZWZpeDsKCglwcml2YXRlIGZpbmFsIE5hbWVkVGhyZWFkTG9jYWl2YXRlIHZvbGF0aWxlIFNldDxTdHJpbmc+IG1hbnVhbFNpbmdsZXRvbk5hbWVzID0gbCBNYXA8Q2xhc3M8Pz4sIFN0cmluZ1tdPiBzaW5nbGV0b25CZWFuTmFtZXNCeVR5cGUgYmVhbkRlZmluaXRpb25NYXAgPSBuZXcgQ29uY3VycmVudEhhc2hNYXA8PigyNTYpO3RlLiAqLwoJcHJpdmF0ZSBBdXRvd2lyZUNhbmRpZGF0ZVJlc29sdmVyIGF1dG93aXJlb29sZWFuIGFsbG93QmVhbkRlZmluaXRpb25PdmVycmlkaW5nOwoKCS8qKiBXaGV0aGVEZWZhdWx0TGlzdGFibGVCZWFuRmFjdG9yeT4+IHNlcmlhbGl6YWJsZUZhY3Rvcmllc3ByZUluc3RhbnRpYXRlU2luZ2xldG9ucygpCgkgKi8KCXB1YmxpYyBzdGF0aWMgZmluZSBsb2NraW5nIGluIHRoZSBlbnRpcmUgcHJlLWluc3RhbnRpYXRpb24gcGhhc2UuCgkKICogQHNlZSAjcmVzb2x2ZURlcGVuZGVuY3kKICovCkBTdXBwcmVzc1dhcm5pbmdzKGFzIGJlYW4gZmFjdG9yeSBzdWJjbGFzc2VzOiBzZWUgZm9yIGV4YW1wbGUKICoge0BsIGEgYmVhbiBkZWZpbml0aW9uIGZpbGUpLCBiZWZvcmUgYWNjZXNzaW5nIGJlYW5zLiBsYXNzVXRpbHM7CmltcG9ydCBvcmcuc3ByaW5nZnJhbWV3b3JrLnV0aWwuQ29sbGVjdHJ0IG9yZy5zcHJpbmdmcmFtZXdvcmsuY29yZS5PcmRlckNvbXBhcmF0b3I7CmltcG9yYWN0b3J5LmNvbmZpZy5Db25maWd1cmFibGVMaXN0YWJsZUJlYW5GYWN0b3J5OwppbXByaW5nZnJhbWV3b3JrLmJlYW5zLmZhY3RvcnkuU21hcnRGYWN0b3J5QmVhbjsKaW1wb2dmcmFtZXdvcmsuYmVhbnMuZmFjdG9yeS5CZWFuRGVmaW5pdGlvblN0b3JlRXhjZXB0cHRpb247CmltcG9ydCBqYXZhLnV0aWwuY29uY3VycmVudC5Db25jdXJyZW50SGFzaE0ucmVmbGVjdC5NZXRob2Q7CmltcG9ydCBqYXZhLnV0aWwuQXJyYXlMaXN0OwppbXBvcm1ld29yay5iZWFucy5mYWN0b3J5LnN1cHBvcnQ7CgppbXBvcnQgamF2YS5pby5JT0V4CgkJfQoKCQlAT3ZlcnJpZGUKCQlwdWJsaWMgU3RyaW5nIHRvU3RyaW5nKCkgewoJCQljbGVhckNhY2hlKCk7CgkJQXR0cmlidXRlTWV0aG9kcy5jYWNoZS5jbGVhcigpOwoJCVByb3h5LmlzUHJveHlDbGFzcyhhbm5vdGF0aW9uLmdldENsYXNzKCkpICYmCgkJCQkJVHlwZSgpLCBhbm5vdGF0aW9ucy5sZW5ndGgpOwoJCWZvciAoaW50IGkgPSAwOyBpIDwgQW5ub3RhdGVkRWxlbWVudCBhbm5vdGF0ZWRFbGVtZW50KSB7CgkJaWYgKEFubm90YXRpb25zIHRoZSBhcnJheSBvZiBhbm5vdGF0aW9ucyB0byBzeW50aGVzaXplCgkgKiBAIHwgSWxsZWdhbFN0YXRlRXhjZXB0aW9uIGV4KSB7CgkJCXRocm93IG5ldyBJbGxlZ2F1cmF0aW9uIG9mCgkgKiB7QGNvZGUgQEFsaWFzRm9yfSBpcyBkZXRlY3RlZAoJICogQEBsaW5rIE1hcH0gdGhhdCBpcyBhbiBpZGVhbCBjYW5kaWRhdGUgZm9yIHRoaXMgbWV0KiB3aWxsIGJlIHJlY3Vyc2l2ZWx5IHN5bnRoZXNpemVkIGludG8gbmVzdGVkIGFubm9vbihNYXAsIENsYXNzLCBBbm5vdGF0ZWRFbGVtZW50KQoJICogQHNlZSAjc3ludGhlc0lsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbiBpZiBhIHJlcXVpcmVkIGF0dHJpYnV0ZSBpdGF0aW9uKGFubm90YXRpb24pIHx8IEFubm90YXRpb25GaWx0ZXIuUExBSU4ubWF0Y2h0aW9uIGlmIGludmFsaWQgY29uZmlndXJhdGlvbiBvZgoJICoge0Bjb2RlIEBBbGlhcyBudWxsIHx8ICFTdHJpbmdVdGlscy5oYXNUZXh0KGF0dHJpYnV0ZU5hbWUpKSB7CgkJIHZhbHVlPC9lbT4gb2YgYSBuYW1lZCBhdHRyaWJ1dGUsIGdpdmVuIHRoZQoJICoge0BkZSB2YWx1ZX0gYXR0cmlidXRlCgkgKiBvZiBhIHNpbmdsZS1lbGVtZW50IEFubm90YWluc3RhbmNlIGZyb20gd2hpY2ggdG8gcmV0cmlldmUgdGhlIGRlZmF1bHQgdmFsdWUKICogQHNlZSAjZ2V0RGVmYXVsdFZhbHVlKEFubm90YXRpb24sIFN0cmluZykKCSAqLwp2ZSB0aGUgPGVtPmRlZmF1bHQgdmFsdWU8L2VtPiBvZiB0aGUge0Bjb2RlIHZhbHVlfT0gdHJ1ZTsKCQl9CgkJaWYgKGxvZ2dlci5pc0VuYWJsZWQoKSkgewoJCQlsb2dnZXIuY2VwdGlvbihleCk7CgkJSW50cm9zcGVjdGlvbkZhaWx1cmVMb2dnZXIgbG9nZ2VyID17QGNvZGUgQ2xhc3N9IHZhbHVlcyB3ZXJlIG5vdCByZXNvbHZhYmxlIHdpdGhpbiBhbmVwdGlvbiBleGNlcHRpb24pIHsKCQkJdGhyb3cgZXhjZXB0aW9uOwoJCX0KCX0KCgkvCQl9CgkJCWNhdGNoIChUaHJvd2FibGUgZXgpIHsKCQkJCS8vIElnbm9yZSBhbmQgZmFrIEludm9jYXRpb25IYW5kbGVyfSAoaWYgdGhlIGFubm90YXRpb24gaW5zdGFuY2UgaW5vdGF0aW9uLCBATnVsbGFibGUgU3RyaW5nIGF0dHJpYnV0ZU5hbWUpIHsKCQlpZiAoIHRoZSB2YWx1ZQoJICogQHBhcmFtIGF0dHJpYnV0ZU5hbWUgdGhlIG5hbWUgb2YgdGhvdGF0aW9uQ29uZmlndXJhdGlvbkV4Y2VwdGlvbn0sCgkgKiBpbiB3aGljaCBjYXNlIGVtZW50LCBhbm5vdGF0aW9uKS5zeW50aGVzaXplKCk7CgkJfQoJCWlmICh2YWx1ZSBpczw/PltdIGNsYXNzZXMpIHsKCQkJCVN0cmluZ1tdIG5hbWVzID0gbmV3IFN0cmluZ1spKTsKCQkJfQoJCX0KCX0KCglwcml2YXRlIHN0YXRpYyBATnVsbGFibGUgT2JqZWN0IHNTdHJpbmcpKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCQlmb3IgKE1hclJlc29sdXRpb24pOwoJCQkJaWYgKHJlc29sdmVkICE9IC0xKSB7CgkJCQkJTWV0aG90YXRpb25UeXBlID0gYXR0cmlidXRlcy5hbm5vdGF0aW9uVHlwZSgpOwoJCQlpZiAoYXRhdGlvbk1ldGFkYXRhfSkKCSAqIG9yIHRvIHByZXNlcnZlIHRoZW0gYXMgQ2xhc3MgbGlhc0ZvciBAQWxpYXNGb3J9CgkgKiBhbmQgcmVwbGFjZXMgZGVmYXVsdCB2YWx1ZSBsdFZhbHVlKSk7CgkJCQl9CgkJCX0KCQl9CgkJZWxzZSB7CgkJCS8vIElmIHdlIGhhdm9sZGVyPiByZXN1bHQgPSBDb2xsZWN0aW9uVXRpbHMubmV3TGlua2VkSGFzaE1hcChtbmcsIERlZmF1bHRWYWx1ZUhvbGRlcj4gZGVmYXVsdFZhbHVlcyA9IGdldERlZmF1bHQuMgoJICovCglwdWJsaWMgc3RhdGljIHZvaWQgcmVnaXN0ZXJEZWZhdWx0VmFsdWVzKG90YXRpb24gYXR0cmlidXRlcyAoYSBzcGVjaWFsaXplZCBNYXApIHdpdGggYXR0cmlic3MgcmVmZXJlbmNlcwoJICogQHBhcmFtIG5lc3RlZEFubm90YXRpb25zQXNNYXAgd2hvdGF0aW9uOwoJICogbWF5IGJlIHtAY29kZSBudWxsfSBpZiB1bmtub3duCgkgKiBAcGF0aW9uIHRoZSBhbm5vdGF0aW9uIHRvIHJldHJpZXZlIHRoZSBhdHRyaWJ1dGVzIGZvZWxlbWVudCB0aGF0IGlzIGFubm90YXRlZCB3aXRoIHRoZSBzdXBwbGllZCBhbm5vdGFrLmNvcmUudHlwZS5Bbm5vdGF0aW9uTWV0YWRhdGF9KSBvciB0byBwcmVzZXJ2ZSB0aCBTdHJpbmdzIChmb3IKCSAqIGNvbXBhdGliaWxpdHkgd2l0aCB7QGxpbmsgb3JnLnNwdGlvbkF0dHJpYnV0ZXMoQW5ub3RhdGlvbiwgYm9vbGVhbiwgYm9vbGVhbikKCSAqLwogY2xhc3NWYWx1ZXNBc1N0cmluZyB3aGV0aGVyIHRvIGNvbnZlcnQgQ2xhc3MgcmVmZXVibGljIHN0YXRpYyBNYXA8U3RyaW5nLCBATnVsbGFibGUgT2JqZWN0PiBnZXRBbm5vcyBhbmQKCSAqIGNvcnJlc3BvbmRpbmcgYXR0cmlidXRlIHZhbHVlcyBhcyB2YWx1ZXMqKgoJICogUmV0cmlldmUgdGhlIGdpdmVuIGFubm90YXRpb24ncyBhdHRyaWJ1dGVzIGUKCSAqIEB0aHJvd3MgSWxsZWdhbFN0YXRlRXhjZXB0aW9uIGlmIGEgZGVjbGFyZWQgbnVsbCAmJiBKQVZBX0xBTkdfQU5OT1RBVElPTl9GSUxURVIubWF0Y2hlcyhhbm5vdGFlKEBOdWxsYWJsZSBBbm5vdGF0aW9uIGFubm90YXRpb24pIHsKCQlyZXR1cm4gKGFublR5cGUpIHx8CgkJCQlBbm5vdGF0aW9uc1NjYW5uZXIuaGFzUGxhaW5KYXZhQW5ub3RhbWV0YUFubm90YXRpb25UeXBlIHRoZSB0eXBlIG9mIG1ldGEtYW5ub3RhdGlvbiB0byBvblR5cGUpCgkJCQkuZmlsdGVyKE1lcmdlZEFubm90YXRpb246OmlzRGlyZWN0bHlQcmVkPC9lbT4KCSAqIEBzZWUgQ2xhc3MjaXNBbm5vdGF0aW9uUHJlc2VudChDbGFzcykKdGVyZmFjZQoJICogaXRzZWxmIHdpbGwgYmUgY2hlY2tlZC4gSW4gYWNjb3JkYW5jZSBzcykKCSAqLwoJcHVibGljIHN0YXRpYyBib29sZWFuIGlzQW5ub3RhdGlvbkRlY2xhcntAY29kZSB0cnVlfSBpZiBhbiBhbm5vdGF0aW9uIG9mIHRoZSBzcGVjaWZpZWQge0BjZWQgIT0gbnVsbCAmJiBtZXJnZWQuZ2V0U291cmNlKCkgaW5zdGFuY2VvZiBDbGFzczx0YXRpb24gb2YgYXQgbGVhc3Qgb25lIG9mIHRoZSBzcGVjaWZpZWQKCSAqIHtAY29kZTxlbT5ub3Q8L2VtPiBiZSBzZWFyY2hlZC4KCSAqIDxwPlRoZSBzdGFuZGFyZCB7QGxpbGllZCB7QGNvZGUgY2xhenp9IGlzIGFuIGludGVyZmFjZSwgb25seSB0aGUgaW50ZXJyYXRlZ3kuU1VQRVJDTEFTUykKCQkJCS5nZXQoYW5ub3RhdGlvblR5cGUsIE1lcmdlZGsgZm9yCgkgKiBAcGFyYW0gY2xhenogdGhlIGNsYXNzIHRvIGNoZWNrIGZvciB0aGUgIHRoZSBmaXJzdCB7QGxpbmsgQ2xhc3N9IGluIHRoZSBpbmhlcml0YW5jZSBoaWVyYXJzLmZyb20oY2xhenosIFNlYXJjaFN0cmF0ZWd5LlRZUEVfSElFUkFSQ0hZLCBSZXBlYXRhdGlvbiAhPSBudWxsKSB7CgkJCQlyZXR1cm4gYW5ub3RhdGlvbjsKCQkJfQoJCQkvYXRpb24+IEBOdWxsYWJsZSBBIGZpbmRBbm5vdGF0aW9uKENsYXNzPD8+IGNsYXp6LCB2ZWx5IHNlYXJjaCB0aHJvdWdoIHRoZSBzdXBlcmNsYXNzIGhpZXJhcmNoeSBvZiB0aCBwcmVzZW50PC9lbT4gb24KCSAqIHRoZSBnaXZlbiBjbGFzcyBpdHNlbGYuCgkgKiA8b25UeXBlKTsKCQl9CgoJCS8vIEV4aGF1c3RpdmUgcmV0cmlldmFsIG9mIG1lcmdlZCAgdGhpcyBleHBsaWNpdGx5LgoJICogQHBhcmFtIG1ldGhvZCB0aGUgbWV0aG9kIHRvIG9uVHlwZSkud2l0aE5vbk1lcmdlZEF0dHJpYnV0ZXMoKQoJCQkJLnN5bnRoZXNpemUodGF0aW9uVHlwZSkgewoKCQlpZiAoYW5ub3RhdGlvblR5cGUgPT0gbnVsbCkgewoJCQlhLWFubm90YXRpb24KCSAqIEByZXR1cm4gdGhlIGZpcnN0IG1hdGNoaW5nIGFubm90YQkvKioKCSAqIEZpbmQgYSBzaW5nbGUge0BsaW5rIEFubm90YXRpb259IG9mIHtAY29kYXRhYmxlcygpOwoKCQlyZXR1cm4gTWVyZ2VkQW5ub3RhdGlvbnMuZnJvbShhbm5vdGEgQHNlZSBBbm5vdGF0ZWRFbGVtZW50VXRpbHMjZ2V0TWVyZ2VkUmVwZWFlbXB0eSBzZXQgKG5ldmVyIHtAY29kZSBudWxsfSkKCSAqIEBzaW5jZSA0LjIKCSAqIGluayBNZXRob2R9LgoJICogPHA+TWV0YS1hbm5vdGF0aW9ucyB3aWxsIGJlIHNlYXJjRWxlbWVudCNnZXREZWNsYXJlZEFubm90YXRpb25zQnlUeXBlKENsYXNzKX0KCSAqIHdlbWVudCwKCQkJQ2xhc3M8QT4gYW5ub3RhdGlvblR5cGUpIHsKCgkJcmV0dXJuIGdldGVtZW50IHRoZSBlbGVtZW50IHRvIGxvb2sgZm9yIGFubm90YXRpb25zIG9uCgkgKiBAY29udGFpbmVyIGFubm90YXRpb248L2VtPi4KCSAqIDxwPkNvcnJlY3RseSBoYW5kbGVkIDxlbT5yZXBlYXRhYmxlPC9lbT4ge0BsaW5rcGxhaW4gQW5ub3RhdGlvbiBhbm5vdG9uVHlwZSAhPSBudWxsID8KCQkJCVJlcGVhdGFibGVDb250YWluZXJzLmV4cGxpY2l0Z2VNZXRob2RSZXNvbHZlciNmaW5kQnJpZGdlZE1ldGhvZAoJICogQHNlZSBqYXZhLmxyZXR1cm4gdGhlIGFubm90YXRpb25zIGZvdW5kIG9yIGFuIGVtcHR5IHNldCAobmV2ZSBzZWFyY2hlZCBpZiB0aGUgYW5ub3RhdGlvbiBpcyBub3QKCSAqIDxlbT5wcmVzZW50b24gdGhlIGVsZW1lbnQuCgkgKiA8cD5UaGlzIG1ldGhvZCBtaW1pY3MgdGhlIGZ1bmN0YXRpb25zfSBBUEkKCSAqLwoJQERlcHJlY2F0ZWQoc2luY2UgPSAiNS4yIikKCXB1YgoJICogQHNlZSAjZ2V0RGVjbGFyZWRSZXBlYXRhYmxlQW5ub3RhdGlvbnMoQW5ub3RhYS5sYW5nLmFubm90YXRpb24uUmVwZWF0YWJsZSBAUmVwZWF0YWJsZX0gYW5kIHdpdGhjdGlvbmFsaXR5IG9mCgkgKiB7QGxpbmsgamF2YS5sYW5nLnJlZmxlY3QuQW5ub3RhdCogQGRlcHJlY2F0ZWQgc2luY2UgaXQgaXMgc3VwZXJzZWRlZCBieSB0aGUge0BsaW5rZSBleCkgewoJCQloYW5kbGVJbnRyb3NwZWN0aW9uRmFpbHVyZShhbm5vdGF0ZWF0ZWRFbGVtZW50KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHN5bnRoZXNpemVBbm5vdGF0aW9uVHlwZSkgewoJCU1ldGhvZCByZXNvbHZlZE1ldGhvZCA9IEJyaWRnZU1ldGhvZFJkKQoJICogQHNlZSAjZ2V0QW5ub3RhdGlvbihBbm5vdGF0ZWRFbGVtZW50LCBDbGFzcyBmcm9tIHRoZQoJICogc3VwcGxpZWQge0BsaW5rIE1ldGhvZH0sIHdoZXJlIHRoZSBhZXNlbnQpLm9yRWxzZShudWxsKTsKCX0KCglwcml2YXRlIHN0YXRpYyA8QSBleHRlbmRpb25UeXBlIHRoZSBhbm5vdGF0aW9uIHR5cGUgdG8gbG9vayBmb3IsIGJvdGggbG9jYTwvZW0+IG9uIHRoZSB7QGNvZGUgQW5ub3RhdGVkRWxlbWVudH0uCgkgKiA8cD5Ob3RldGF0aW9uc09ubHkoYW5ub3RhdGlvbikpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJCS9vdGF0aW9uLCBvciB7QGNvZGUgbnVsbH0gaWYgbm90IGZvdW5kCgkgKiBAc2luY2UgNHtAY29kZSBhbm5vdGF0aW9uVHlwZX0gZnJvbSB0aGUgc3VwcGxpZWQKCSAqIGFubm90dGF0aW9uIHR5cGUKCSAqIEByZXR1cm4ge0Bjb2RlIGZhbHNlfSBpZiB0aGUgY2xhc3NsYXp6LCBATnVsbGFibGUgQ2xhc3M8PyBleHRlbmRzIEFubm90YXRpb24+IGFubm90YTsKCQkJfQoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9CgoJLyoqCgkgKiBEZXRlcm1pbmUgLjIKCSAqIEBzZWUgI2lzQ2FuZGlkYXRlQ2xhc3MoQ2xhc3MsIENsYXNzKQoJICogQHN0CgkgKiBAcGFyYW0gYW5ub3RhdGlvblR5cGVzIHRoZSBzZWFyY2hhYmxlIGFubm90YXRhdGlvbnMgd2l0aCBhIHNpbmdsZSBlbGVtZW50LgoJICovCglwdWJsaWMgc3RhdGljIHRoZSBmaXJzdCBhbm5vdGF0aW9uIG9mIHRoZSBzcGVjaWZpZWQgdHlwZSBoYXMgYmVub3RhdGlvbkF0dHJpYnV0ZXN9IHRyYW5zcGFyZW50bHkgc3VwcG9ydCBhdHRyaWJ1dGlmIHtAY29kZSBBfSBpcyBlaXRoZXIgPGVtPmRpcmVjdGx5IHByZXNlbnQ8L2VtPiBve0BsaW5rIEFubm90YXRlZEVsZW1lbnR9LgogKgogKiA8cD5BbiBhbm5vdGF0aW9uIGkKICoge0BsaW5rICNnZXRBbm5vdGF0aW9uKE1ldGhvZCwgQ2xhc3MpfSkgaW5zdGVhZG9yIHdvcmtpbmcgd2l0aCBhbm5vdGF0aW9ucywgaGFuZGxpbmcgbWV0YS1hbm5vdGF0b24uTWVyZ2VkQW5ub3RhdGlvbnMuU2VhcmNoU3RyYXRlZ3k7CmltcG9ydCBvcmcuc3Agb3JnLnNwcmluZ2ZyYW1ld29yay5jb3JlLmFubm90YXRpb247CgppbXBvcnQgamF2YXdpdGggdGhlIExpY2Vuc2UuCiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUg';

let cachedDictionary: Buffer | null = null;

export function getJavaDictionary(): Buffer {
  if (!cachedDictionary) {
    cachedDictionary = Buffer.from(DICTIONARY_BASE64, 'base64');
  }
  return cachedDictionary;
}

export const JAVA_DICTIONARY_META: DictionaryMeta = {
  name: 'Java Dictionary',
  version: '2.0.0',
  description: 'Trained ZSTD dictionary optimized for Java code compression',
  frameworks: ["java","spring","maven"],
  sizeBytes: 70494,
  patternCount: 0, // Trained dictionary - patterns are internal
  trainedOn: ['sample java files'],
};
